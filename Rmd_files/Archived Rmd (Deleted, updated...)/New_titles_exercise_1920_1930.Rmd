---
title: "New titles exercise 1920-1930"
output: html_document
---
# Delete Workspace and load packages
## Function to load necessary packages
```{r}
f_load_pk <- function() {
  
  # Pacman: packages manager. It does different things, here I use it to load multiple packages at the same time
  library (pacman)
  p_load(readxl,foreign,readstata13,data.table,plyr,dplyr,stringr,openxlsx,stringdist,reshape2,qdap,fst,ipumsr,tm,textreg,tmap,tmaptools,sf,leaflet,ipumsr)
  p_load(tictoc)
  
  # Statistical packages
  p_load(fastDummies,sandwich,lmtest,estimatr)
  #graphs
  p_load(ggplot2,maps,ggthemes,sjPlot,sjmisc,sjlabelled,jtools,ggstance,broom.mixed)
  p_load(ggpubr)   # Contains ggarrange, used to plot more than one grpah in the same figure
  p_load(scales)   # Used in histogram to show percent format
}
```

## Using function
```{r}
rm(list=setdiff(ls(all.names = TRUE), "f_load_pk"))
f_load_pk()
```

# Part 0. Data processing
In this part we create a set of data structures with information at the level of a geographic unit (e.g. countynhg)

# 1. Functions that change individual level variables and that create other variables

## Functions to transform some individual level variables
In this sections we simplify some of the individual level variables

The next functions  simplify the categories of some variables. This simplified categories will be used both as individual level variables and to construct shares for geography level variables

```{r}
### Literacy
# Replace literacy categories
# Note: If literacy appears as 0 (the IPUMS label for it is N/A), we assign it an NA value. When creating the shares variables we will drop values that are NA. That means that the shares are created among people that gave a non 0 answer

f_lit <- function(X,lit_v){
  setnames( X,c(deparse(substitute(lit_v))),c("literacy"))
  X[,literacy:=na_if(literacy,0)]
  X <- X[literacy>= 1 & literacy<=3,literacy:=0] # Can't read or write
  X <- X[literacy== 4,literacy:=1] # Can read or write
  setnames( X,c("literacy"),c(deparse(substitute(lit_v))))
  return(X)
}


### Race
#Replace race categories categories
f_race <- function(X,race_v){
  setnames( X,c(deparse(substitute(race_v))),c("race_c"))
  X <- X[race_c >=3,race_c:=3] # Other race
  setnames( X,c("race_c"),c(deparse(substitute(race_v))))
  return(X)
}


### Martial status
# Replace literacy categories
f_mar <- function(X,mar_v){
  setnames( X,c(deparse(substitute(mar_v))),c("m"))
  X <- X[m >= 2 & m<=5,m:=2] # Different that "married, spouse present" (category 1) and never married/single (category 3)
  X <- X[m == 6,m:=3] # Never married/single
  setnames( X,c("m"),c(deparse(substitute(mar_v))))
  return(X)
}


# NOTE: The next functions construct simplified categories for some variables. The user can specify if he wants to keep the original variable or not. For geographic level share variables it is advisable to work with the simplified categories

### Birthplace
# Here we simplify categories by looking at group of countries.
# Additionally we construct binary migration variables.

# Note: The state_v variable has to be of the FIP code type, since bpl is in fip code
f_bpl <- function(X,state_v,birth_v,flag=0,name){
  # name is a size 2 character vector
  if (!missing(name) & length(name)!=2 & typeof(name)!="character") stop("The name vector has to be a character vector of size 2") 
  setnames( X,c(deparse(substitute(state_v)),deparse(substitute(birth_v))),c("st_v","bp_v") )
  
  # If state is different from birth of origin, consider as a migrant
  X <- X[,m_us:=0][bp_v!=st_v,m_us:=1]
  X <- X[,m_abr:=0][bp_v>=100,m_abr:=1]
  
  setnames( X,  c("st_v"),  c(deparse(substitute(state_v))) )
  if (flag==1) {
    # Simplify birthplace inside US
    X <- X[bp_v %in% c(9,23,25,33,44,50),temp:=1] # New England
    X <- X[bp_v %in% c(34,36,42),temp:=2] # Middle Atlantic
    X <- X[bp_v %in% c(17,18,26,39,55),temp:=3] # East North Central
    X <- X[bp_v %in% c(19,20,27,29,31,38,46),temp:=4] # West North Central
    X <- X[bp_v %in% c(10,11,12,13,24,37,45,51,54),temp:=5] # South Atlantic
    X <- X[bp_v %in% c(1,21,28,47),temp:=6] # East South Central
    X <- X[bp_v %in% c(5,22,40,48),temp:=7] # West South Central
    X <- X[bp_v %in% c(4,8,16,35,30,49,32,56),temp:=8] # Mountain
    X <- X[bp_v %in% c(2,6,15,41,53),temp:=9] # Pacific
    X <- X[bp_v<100,bp_v:=temp]
    X <- X[,temp:=NULL]
    
    # Simplify birth place abroad
    X <- X[bp_v %in% 100:199,bp_v:=150]  #U.S Outlying Areas + other North America
    X <- X[bp_v %in% 200:300,bp_v:=200]  # Central America + SA
    X <- X[bp_v %in% 500:599 | bp_v %in% 700:800,bp_v:=500] # Asia + Oceania
    X <- X[bp_v %in% 600:699,bp_v:=600] # Africa
    X <- X[bp_v %in% 400:405 | bp_v==419 ,bp_v:=400] #Northern Europe exc. Ireland and UK
    X <- X[bp_v %in% 410:413,bp_v:=410] # UK excl. Ireland
    X <- X[bp_v %in% 420:429,bp_v:=420] # Western Europe 
    X <- X[bp_v %in% 430:440 & bp_v!=434,bp_v:=430] # Southern Europe exc. Italy 
    X <- X[bp_v %in% 450:459 & bp_v!=453,bp_v:=450] # Central Europe exc. Germany
    X <- X[bp_v %in% 460:499,bp_v:=460] # Russian Empire
    X <- X[bp_v < 900] # drop if bp_v>=900
    # Other bp values: 414 Ireland, 434 Italy, Germany 450
    
    setnames( X,c("bp_v"),c(deparse(substitute(birth_v))) )
  } else {
    X <- X[,bp_v:=NULL]
  }
  
  if (missing(name)) {
    setnames( X,c("m_us","m_abr"),c("migrant","migrant_abroud") )
  } else {
    setnames( X,c("m_us","m_abr"), name)
  }
  
  return(X)
}

### Main sector using ind1950
# NOTE: you need to provide the ind1950 variable
f_ind1950 <- function(X,sec_v,flag=0) {
  setnames( X,c(deparse(substitute(sec_v))),c("industry"))
  
  X <- X[industry %in% 100:199,ind1950_main:=1] # Agriculture
  X <- X[industry %in% 200:299,ind1950_main:=2] # Mining and Construction
  X <- X[industry %in% 300:499,ind1950_main:=3] # Manufacturing
  X <- X[industry %in% 500:599,ind1950_main:=4] # Transportation, Communication, and Other Utilities
  X <- X[industry %in% 600:699,ind1950_main:=5] # Trade
  X <- X[industry %in% 700:899,ind1950_main:=6] # Services
  X <- X[industry %in% 900:949,ind1950_main:=7] # Public Administration
  X <- X[industry == 0 | industry>=950,ind1950_main:=0] # Non-specified, missing
  
  if (flag==0) {
    setnames(X,c("industry"),c(deparse(substitute(sec_v))))
  } else {
    # Drop the individual industry number
    X <- X[,industry:=NULL]
  }
  return(X)
}


### Main occupation using occ1950
# We use the occ1950 because it is available in every sample. We have to think carefully what might be the issue if you use occ for other parts of the work.
# NOTE: you need to provide the ind1950 variable
f_occ1950 <- function(X,occ_v,flag=0) {
  setnames( X,c(deparse(substitute(occ_v))),c("occupation"))
  
  X <- X[occupation >= 0 & occupation<= 99 ,occ1950_main:= 0] #           "Professional, Technical"
  X <- X[occupation >= 100 & occupation<= 199, occ1950_main:= 100 ] #     "Farmers"
  X <- X[occupation >= 200 & occupation<= 299, occ1950_main:= 200] #      "Managers, Officials, and Proprietors"',
  X <- X[occupation >= 300 & occupation<= 399, occ1950_main:= 300] #      "Clerical and Kindred"
  X <- X[occupation >= 400 & occupation<= 499, occ1950_main:= 400] #      "Sales workers"
  X <- X[occupation >= 500 & occupation<= 599 , occ1950_main:= 500] #     "Craftsmen"
  X <- X[occupation >= 600 & occupation<= 699, occ1950_main:= 600] #      "Operatives"
  X <- X[occupation >= 700 & occupation<= 729, occ1950_main:= 700] #      "Service Workers (private household)"
  X <- X[occupation >= 730 & occupation<= 799, occ1950_main:= 730] #      "Service Workers (not household)"
  X <- X[occupation >= 800 & occupation<= 899, occ1950_main:= 800] #      "Farm laborers"
  X <- X[occupation >= 900 & occupation<= 970, occ1950_main:= 900] #      "Laborers"
  X <- X[occupation >= 979 & occupation<= 999, occ1950_main:= 979] #      "Missing, not classified"
  
  if (flag==0) {
    setnames(X,c("occupation"),c(deparse(substitute(occ_v))))
  } else {
    # Drop the individual industry number
    X <- X[,occupation:=NULL]
  }
  return(X)
}

### Main age groups
f_age <- function(X,age_v,flag=0) {
  setnames( X,c(deparse(substitute(age_v))),c("age_a"))
  X <- X[age_a %in% 0:9,age_main:=0] # 0-9
  X <- X[age_a %in% 10:15,age_main:=1] # 10-15
  X <- X[age_a %in% 16:23,age_main:=2] # 16:23
  X <- X[age_a %in% 24:29,age_main:=3] # 24:29
  X <- X[age_a %in% 30:39,age_main:=4] # 30:39
  X <- X[age_a %in% 40:49,age_main:=5] # 40:49
  X <- X[age_a %in% 50:64,age_main:=6] # 50:64
  X <- X[age_a >= 65,age_main:=7] # >=65
  
  if (flag==0) {
    setnames(X,c("age_a"),c(deparse(substitute(age_v))))
  } else {
    # Drop the individual age 
    X <- X[,age_a:=NULL]
  }
  return(X)
}

```

# 2. Functions to construct variables at a geographic level
Here I construct a set of variables at the county level

## Function to create shares
```{r}
f_shares <- function(X,geof,weight,var,flag=0,binary=0) {
  # flag determines if the NA values are eliminated
  # binary specifies if var is a binary (1,0) variable
  X <- copy(X)
  setnames( X,c(deparse(substitute(weight)),deparse(substitute(var)),deparse(substitute(geof))),c("w","v","g"))
  var_ch <- deparse(substitute(var))
  # flag=1 drop observations with NA values
  if (flag==1) {  X <- X[!is.na(w) & w>0 & !is.na(v) & !is.na(g)]
  } else {  X <- X[!is.na(w) & w>0 & !is.na(g)] }
  
  if (binary==0) {
    X <- X[,lapply(.SD,sum,na.rm=TRUE),by=c("g","v"),.SDcols=c("w")]
    X <- X[,sh_v:=sum(w,na.rm=TRUE),by=c("g")][,sh_v:=w/sh_v][,w:=NULL]
      
    #setnames(X, c("sh_v"), c( deparse(substitute(var))) ) 
    X <- X[,v:=paste0("sh_",var_ch,"_",v)]    # We do this to avoid the variable being named as the values of v
    X <- data.table::dcast(X, g ~ v, value.var = "sh_v")  
    setnames(X,c("g"),c(deparse(substitute(geof))))
  } else if (binary==1) {
    X[,v:=v*w]
    X <- X[,lapply(.SD,sum,na.rm=TRUE),by=c("g"),.SDcols=c("w","v")]
    X <- X[,`:=`(v=v/w)][,w:=NULL]
    setnames(X,c("g","v"),c(deparse(substitute(geof)),paste0("sh_",deparse(substitute(var)))))
  }
  
  return(X)
}

```


## Function to create Hirschman-Herfindahl index
```{r}
f_HHI <- function(X,geof,weight,arg_ind) {
  X <- copy(X)
  setnames( X,c(deparse(substitute(weight)),deparse(substitute(arg_ind)),deparse(substitute(geof))),c("w","v","g"))
  # flag=1 drop observations with NA values
  X <- X[!is.na(w) & w>0 & !is.na(g) & (!is.na(v) & v!=0 & v<950)]
  
  X <- X[,lapply(.SD,sum,na.rm=TRUE),by=c("g","v"),.SDcols=c("w")][,N:=.N,by=c("g")]
  X <- X[,si:=sum(w),by=c("g")][,si:=w/si][,si2:=si*si]
  X <- X[,H:=sum(si2),by=c("g")][,H:=-(H-1/N)/(1-1/N)]   # Last formula scales the index between -1 and 0. Values closer to zero imply more variety
  X <- X[,.SD[1],by=c("g"),.SDcols=c("H")]
  setnames(X,c("g"),c(deparse(substitute(geof))))
  return(X)
}


```

## Function to create variables related to work status
1930 work related variables
**Labforce** has three different answers: 0 (N/A), 1 (Not in the labor force) and 2 (in the labor force). We assume that everyone answering 0, is not in the labor force. When we look at the ages of people coded with an answer of 0 we find out that they were all less than 16 years old. 
**empstat ** has 4 answers: 0 (N/A), 1 (Employed), 2 (Unemployed), 3 (Not in the labor force). We assume that everyone answering 0, is not in the labor force. For 1930 there were no observations with a value of empstat equal to 0.

```{r}
f_work <- function(X,geof,weight,arg_labforce,arg_empstat,arg_classwkr) {
  X <- copy(X)
  setnames( X,c(deparse(substitute(weight)),deparse(substitute(geof)),deparse(substitute(arg_labforce))),c("w","g","v_lf"))
  # We treat N/A answers as the same as not in the labor force
  X[,v_lf:=ifelse(v_lf==2,1,0)]
  X[,`:=`(v_lf=v_lf*w)]
  if (!missing(arg_empstat) & !missing(arg_classwkr)) { 
    setnames(X,c(deparse(substitute(arg_empstat)),deparse(substitute(arg_classwkr))),c("v_emp","v_cl") )
    X[,`:=`(temp=ifelse(v_emp==1|v_emp==2,1,0),v_unemp=ifelse(v_emp==2,1,0),        v_emp=ifelse(v_emp==1,1,0),v_wage=ifelse(v_cl==2,1,0),v_cl=ifelse(v_cl==1 | v_cl==2,1,0))]
    X[,`:=`(temp=temp*w,v_unemp=v_unemp*w,v_emp=v_emp*w,v_wage=v_wage*w,v_cl=v_cl*w)]
    X <- X[,lapply(.SD,sum,na.rm=TRUE),by=c("g"),.SDcols=c("w","v_lf","v_emp","temp","v_unemp","v_cl","v_wage")]
    X <- X[,`:=`(sh_labforce=v_lf/w,sh_labforce_emp=v_emp/w,sh_unemp=v_unemp/temp,sh_labforce_cl=v_cl/w,sh_wrkwage=v_wage/v_cl)]
    X[,c("v_emp","v_unemp","temp","v_cl","v_wage"):=NULL]
  } else if (!missing(arg_empstat)) {
    setnames(X,c(deparse(substitute(arg_empstat))),c("v_emp") )
    X[,`:=`(temp=ifelse(v_emp==1|v_emp==2,1,0),v_unemp=ifelse(v_emp==2,1,0),v_emp=ifelse(v_emp==1,1,0))]
    X[,`:=`(temp=temp*w,v_unemp=v_unemp*w,v_emp=v_emp*w)]
    X <- X[,lapply(.SD,sum,na.rm=TRUE),by=c("g"),.SDcols=c("w","v_lf","v_emp","temp","v_unemp")]
    X <- X[,`:=`(sh_labforce=v_lf/w,sh_labforce_emp=v_emp/w,sh_unemp=v_unemp/temp)]
    X[,c("v_emp","v_unemp","temp"):=NULL]
  } else if (!missing(arg_classwkr)) {
    setnames(X,c(deparse(substitute(arg_classwkr))),c("v_cl") )
    X[,`:=`(v_wage=ifelse(v_cl==2,1,0),v_cl=ifelse(v_cl==1 | v_cl==2,1,0))]
    X[,`:=`(v_wage=v_wage*w,v_cl=v_cl*w)]
    X <- X[,lapply(.SD,sum,na.rm=TRUE),by=c("g"),.SDcols=c("w","v_lf","v_cl","v_wage")]
    X <- X[,`:=`(sh_labforce=v_lf/w,sh_labforce_cl=v_cl/w,sh_wrkwage=v_wage/v_cl)]
    X[,c("v_cl","v_wage"):=NULL]
  } else {
    X <- X[,lapply(.SD,sum,na.rm=TRUE),by=c("g"),.SDcols=c("w","v_lf")]
    X <- X[,`:=`(sh_labforce=v_lf/w)]
  }
  X[,c("w","v_lf"):=NULL]
  setnames( X,c("g"),c(deparse(substitute(geof))))
  
  return(X)
}


```
The function creates the following variables
- sh_labforce: (population in the labor force)/(all the population of interest), we use code 2 in labforce to characterize people in the labor force
- sh_labforce_emp: (population in the labor force)/(all the population of interest), we use code 1 and 2 in empstat to characterize in the labor force
- sh_unemp: (pop unemployed)/(pop employed) use codes 1 (emp) and 2 (unemp) of variable empstat
- sh_labforce_cl: (population in the labor force)/(all the population of interest), we use code 1 and 2 in classwkr to characterize in the labor force
- sh_wrkwage: (works for wage)/(self-employed or works for wage), we use variable classwkr




# 3. Constructing databases with information at a geographic level
We want to construct a set of variables that characterize geographic locations. For that we use the information at the individual level and create share or level variables. 

## 3.1. Functions
### Functions to organize data
Takes individual level information, simplifies/changes it and create new variables of interest
```{r}
f_census_simplify <- function(X) {
# NOTE: For this function to work we require all the variables used to be part of the X dataset 
  if (is.null(X$statefip)) stop("You need to provide variable statefip")
  
  # Migrant status
  if (!is.null(X$bpl))    X <- f_bpl(X,statefip,birth_v=bpl,flag=0,name=c("mig_us","mig_ab")) else warning("No variable bpl was provided")
  if (!is.null(X$mbpl))   X <- f_bpl(X,statefip,birth_v=mbpl,flag=0,name=c("m_mig_us","m_mig_ab")) else warning("No variable mbpl was provided")
  if (!is.null(X$fbpl))   X <- f_bpl(X,statefip,birth_v=fbpl,flag=0,name=c("f_mig_us","f_mig_ab")) else warning("No variable fbpl was provided")
  
  # Literacy, Age (age groups), industry (industry groups), marital status, race, urban,ownership
  if (!is.null(X$lit))      X <- f_lit(X,lit)         else warning("No variable lit was provided")
  if (!is.null(X$age))      X <- f_age(X,age,flag=0)  else warning("No variable age was provided")
  if (!is.null(X$occ1950))  X <- f_occ1950(X,occ1950,flag=1) else warning("No variable occ1950 was provided")
  if (!is.null(X$mars))     X <- f_mar(X,marst)              else warning("No variable marst was provided")
  if (!is.null(X$race))     X <- f_race(X,race)              else warning("No variable race was provided")
  if (!is.null(X$school))   X[,school:=ifelse(school==2,1,0)]    else warning("No variable school was provided")
  if (!is.null(X$sex))      X[,male:=ifelse(sex==1,1,0)][,sex:=NULL]     else warning("No variable sex was provided")
  if (!is.null(X$urban))    X[,urban:=ifelse(urban==2,1,0)]              else warning("No variable urban was provided")
  if (!is.null(X$farm))     X[,farm:=ifelse(farm==2,1,0)]                else warning("No variable farm was provided")
  if (!is.null(X$ownershp)) X[,ownershp:=na_if(ownershp,0)][!is.na(ownershp),ownershp:=ifelse(ownershp==1,1,0)] else warning("No variable ownershp was provided")
  
  # Industry variables
  if (!is.null(X$ind1950))      X[,new_sector_ind1950:=ifelse(ind1950 %in% c(376,377,466,856,556,606,667,668,816),ind1950,0)]  # Keep only sectors identified as new
  if (!is.null(X$ind1950))      X <- f_ind1950(X,ind1950,flag=0) else warning("No variable ind1950 was provided")   # I need ind1950 to compute HHI
  
  return(X)
}

```

### Function to create final dataset
NOTE: This function only works if all the variables used (e.g. male, age_main...) are provided. If that is not the case consider either changing the function by erasing the variables that are not present or doing the operations outside of the function.
```{r}
# NOTE: This function only works if all the variables exist
f_geof_vars <- function(X,arg_geof,arg_p) {
  setnames(X,deparse(substitute(arg_geof)),c("arg_geof"))
  if (!missing(arg_p)) {setnames(X,deparse(substitute(arg_p)),c("perwt"))
  } else {warning("No arg_p argument. Make sure your data contains a variable named perwt")}
  
  Y <- Reduce(
    function(x, y, ...) merge(x, y,by="arg_geof", all = TRUE, ...),
    list(
      f_shares(X[,c("arg_geof","perwt","male")],arg_geof,perwt,male,flag=1,binary=1),
      f_shares(X[occ1950_main<979,c("arg_geof","perwt","occ1950_main")],arg_geof,perwt,occ1950_main,flag=1),
      f_shares(X[,c("arg_geof","perwt","age_main")],arg_geof,perwt,age_main,flag=1),
      f_shares(X[,c("arg_geof","perwt","race")],arg_geof,perwt,race,flag=1),
      f_shares(X[,c("arg_geof","perwt","lit")],arg_geof,perwt,lit,flag=1,binary=1),
      f_shares(X[,c("arg_geof","perwt","school")],arg_geof,perwt,school,flag=1,binary=1),
      f_shares(X[,c("arg_geof","perwt","urban")],arg_geof,perwt,urban,flag=1,binary=1),
      f_shares(X[,c("arg_geof","perwt","farm")],arg_geof,perwt,farm,flag=1,binary=1),
      f_shares(X[,c("arg_geof","perwt","ownershp")],arg_geof,perwt,ownershp,flag=1,binary=1),
      f_shares(X[,c("arg_geof","perwt","marst")],arg_geof,perwt,marst,flag=1),
      f_shares(X[,c("arg_geof","perwt","mig_us")],arg_geof,perwt,mig_us,flag=1,binary=1),
      f_shares(X[,c("arg_geof","perwt","mig_ab")],arg_geof,perwt,mig_ab,flag=1,binary=1),
      f_shares(X[,c("arg_geof","perwt","m_mig_ab")],arg_geof,perwt,m_mig_ab,flag=1,binary=1),
      f_shares(X[,c("arg_geof","perwt","m_mig_us")],arg_geof,perwt,m_mig_us,flag=1,binary=1),
      f_shares(X[,c("arg_geof","perwt","f_mig_ab")],arg_geof,perwt,f_mig_ab,flag=1,binary=1),
      f_shares(X[,c("arg_geof","perwt","f_mig_us")],arg_geof,perwt,f_mig_us,flag=1,binary=1),
      
      #Industry
      f_shares(X[ind1950_main != 0, c("arg_geof","perwt","ind1950_main")],arg_geof,perwt,ind1950_main,flag=1),
      f_shares(X[ind1950_main != 0, c("arg_geof","perwt","ind1950_main","new_sector_ind1950")][,c("ind1950_main"):=NULL],arg_geof,perwt,new_sector_ind1950,flag=1),
      f_HHI(X[,c("arg_geof","perwt","ind1950")],arg_geof,perwt,ind1950),
      
      X[,c("arg_geof","perwt")][,lapply(.SD,sum,na.rm=TRUE),by=c("arg_geof"),.SDcols=c("perwt")],
      
      X[,c("arg_geof","perwt","statefip")][,lapply(.SD,sum,na.rm=TRUE),by=c("arg_geof","statefip"),.SDcols=c("perwt")][order(arg_geof,-perwt)][,.SD[1],by=c("arg_geof"),.SDcols="statefip"]
      )
  )
  
  if (length(X$empstat)>0 & length(X$classwkr)>0) {
    X <- merge(Y,f_work(X[age>=16,c("arg_geof","perwt","labforce","empstat","classwkr","age")][,c("arg_geof","perwt","labforce","empstat","classwkr")],arg_geof,perwt,labforce,empstat,classwkr),by="arg_geof", all = TRUE)
  } else if (length(X$empstat)>0 & length(X$classwkr)<=0) {
    X <- merge(Y,f_work(X[age>=16,c("arg_geof","perwt","labforce","empstat","age")][,c("arg_geof","perwt","labforce","empstat")],arg_geof,perwt,arg_labforce=labforce,arg_empstat=empstat),by="arg_geof", all = TRUE)
  } else if (length(X$empstat)<=0 & length(X$classwkr)>0) {
    X <- merge(Y,f_work(X[age>=16,c("arg_geof","perwt","labforce","classwkr","age")][,c("arg_geof","perwt","labforce","classwkr")],arg_geof,perwt,arg_labforce=labforce,arg_classwkr=classwkr),by="arg_geof", all = TRUE)
  } else if (length(X$empstat)<=0 & length(X$classwkr)<=0) {
    X <- merge(Y,f_work(X[age>=16,c("arg_geof","perwt","labforce","age")][,c("arg_geof","perwt","labforce")],arg_geof,perwt,arg_labforce=labforce),by="arg_geof", all = TRUE)
  }
  
  setnames(X,c("arg_geof"),deparse(substitute(arg_geof)))
  if (!missing(arg_p)) setnames(X,c("perwt"),deparse(substitute(arg_p)))
  return(X)
}



```

## 3.2. Construction of variable with information about share of workers in new titles

### 3.2.1. Import the database with information about new titles
```{r}
occ1930.codes <- as.data.table( read_excel("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/input/1930 - Cleaned.xlsx", sheet = "1930 main groups",guess_max=10000) )[,!c("occ_ini_1930","occ1930","occ_name")]

new_titles.occind1930 <- list(
                                read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/new_titles_1930_by_occind.fst",as.data.table=TRUE),
                                read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/new_titles_1930_by_occind.all.fst",as.data.table=TRUE)
)

new_titles.occind1930[[1]] <- merge(new_titles.occind1930[[1]],occ1930.codes[,c("occind1930","occind1930_name","occ","ind","occind","flag")],by="occind1930",all=TRUE)
new_titles.occind1930[[2]] <- merge(new_titles.occind1930[[2]],occ1930.codes[,c("occind1930","occind1930_name","occ","ind","occind","flag")],by="occind1930",all=TRUE)

write.xlsx(new_titles.occind1930[[1]],"/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Tables/new_titles.occind1930_within.xlsx",row.names = TRUE)

```

### 3.3.2. Aggregate the Census data and merge with the new titles vector
#### Import and aggregate Census data
```{r}
new_titles_agg <-read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/input/census_sample/census_sample_1930.fst",as.data.table=TRUE,columns=c("countynhg","countynhg_1910","metarea_1940","occind","perwt"))[!is.na(countynhg)]

new_titles_agg <- new_titles_agg[,.(perwt=sum(perwt)),by=c("countynhg","countynhg_1910","metarea_1940","occind")]
```

#### Merge with new titles information
We can merge with either the new_titles vector that uses all titles (second element in the list) or the one using titles within occ (first element in the list)
```{r}
# We only keep rows that have an occind code. The share of new titles will be computed using only persons that have a valid occind code
new_titles_agg <- merge(new_titles_agg,new_titles.occind1930[[1]][,c("sh_base","sh_base_tit","sh_base_titind","sh_red","sh_red_tit","sh_red_titind","occind")],by=c("occind"),all.x=TRUE,all.y=FALSE)[!is.na(occind)]

write_fst(new_titles_agg, "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/new_titles_agg.fst")
```


## 3.3. Constructing databases with general geographical variables
### 1920
NOTE: NO empstat in 1920
#### countynhg
```{r}
census_sample_1920_agg_countynhg <-read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/input/census_sample/census_sample_1920.fst",as.data.table=TRUE,columns=c("statefip","countynhg","urban","farm","ownershp","perwt","famsize","sex","school","lit","age","marst","race","bpl","mbpl","fbpl","school","labforce","classwkr","occ1950","ind1950","occscore"))[!is.na(countynhg)]

# Simplify
census_sample_1920_agg_countynhg <- f_census_simplify(census_sample_1920_agg_countynhg)

# Compute geof level shares and work variables
# NOTE : if not all the variables are present, do the final construction manually
census_sample_1920_agg_countynhg <- f_geof_vars(census_sample_1920_agg_countynhg,countynhg)
census_sample_1920_agg_countynhg <- census_sample_1920_agg_countynhg[!is.na(countynhg)]

# Convert all cells with NA values to 0
census_sample_1920_agg_countynhg <- census_sample_1920_agg_countynhg[,lapply(.SD,function(x) {x[is.na(x)] <- 0; x}),.SDcols=names(census_sample_1920_agg_countynhg)]

write_fst(census_sample_1920_agg_countynhg, "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1920_agg_countynhg.fst")
rm(census_sample_1920_agg_countynhg)
```


#### countynhg_1910
```{r}
census_sample_1920_agg_countynhg_1910 <-read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/input/census_sample/census_sample_1920.fst",as.data.table=TRUE,columns=c("statefip","countynhg_1910","urban","farm","ownershp","perwt","famsize","sex","school","lit","age","marst","race","bpl","mbpl","fbpl","school","labforce","classwkr","occ1950","ind1950","occscore"))[!is.na(countynhg_1910)]

census_sample_1920_agg_countynhg_1910 <- f_census_simplify(census_sample_1920_agg_countynhg_1910)

#- NOTE : if not all the variables are present, do the final construction manually
census_sample_1920_agg_countynhg_1910 <- f_geof_vars(census_sample_1920_agg_countynhg_1910,countynhg_1910)
census_sample_1920_agg_countynhg_1910 <- census_sample_1920_agg_countynhg_1910[!is.na(countynhg_1910)]

# Convert all cells with NA values to 0
census_sample_1920_agg_countynhg_1910 <- census_sample_1920_agg_countynhg_1910[,lapply(.SD,function(x) {x[is.na(x)] <- 0; x}),.SDcols=names(census_sample_1920_agg_countynhg_1910)]

write_fst(census_sample_1920_agg_countynhg_1910, "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1920_agg_countynhg_1910.fst")
rm(census_sample_1920_agg_countynhg_1910)
```

#### metarea_1940
```{r}
census_sample_1920_agg_metarea_1940 <-read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/input/census_sample/census_sample_1920.fst",as.data.table=TRUE,columns=c("statefip","metarea_1940","urban","farm","ownershp","perwt","famsize","sex","school","lit","age","marst","race","bpl","mbpl","fbpl","school","labforce","classwkr","occ1950","ind1950","occscore"))[!is.na(metarea_1940)]

# Simplify some variables
census_sample_1920_agg_metarea_1940 <- f_census_simplify(census_sample_1920_agg_metarea_1940)

# NOTE : if not all the variables are present, do the final construction manually
census_sample_1920_agg_metarea_1940 <- f_geof_vars(census_sample_1920_agg_metarea_1940,metarea_1940)
census_sample_1920_agg_metarea_1940 <- census_sample_1920_agg_metarea_1940[!is.na(metarea_1940)]

# Adding share of workers with new titles
census_sample_1920_agg_metarea_1940 <- merge(census_sample_1920_agg_metarea_1940,new_titles_agg[!is.na(metarea_1940)][,lapply(.SD,weighted.mean,w=perwt),by=c("metarea_1940"),.SDcols=c("sh_base","sh_base_tit","sh_base_titind","sh_red","sh_red_tit","sh_red_titind")],by="metarea_1940",all.x=TRUE,all.y=FALSE)

# Convert all cells with NA values to 0
census_sample_1920_agg_metarea_1940 <- census_sample_1920_agg_metarea_1940[,lapply(.SD,function(x) {x[is.na(x)] <- 0; x}),.SDcols=names(census_sample_1920_agg_metarea_1940)]

write_fst(census_sample_1920_agg_metarea_1940, "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1920_agg_metarea_1940.fst")
rm(census_sample_1920_agg_metarea_1940)
```


### 1930
#### countynhg
```{r}
census_sample_1930_agg_countynhg <-read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/input/census_sample/census_sample_1930.fst",as.data.table=TRUE,columns=c("statefip","countynhg","urban","farm","ownershp","perwt","famsize","sex","school","lit","age","marst","race","bpl","mbpl","fbpl","school","empstat","labforce","classwkr","occ1950","ind1950","occscore"))[!is.na(countynhg)]

# Simplify
census_sample_1930_agg_countynhg <- f_census_simplify(census_sample_1930_agg_countynhg)

# Compute geof level shares and work variables
# NOTE : if not all the variables are present, do the final construction manually
census_sample_1930_agg_countynhg <- f_geof_vars(census_sample_1930_agg_countynhg,countynhg)
census_sample_1930_agg_countynhg <- census_sample_1930_agg_countynhg[!is.na(countynhg)]

# Adding share of workers with new titles
census_sample_1930_agg_countynhg <- merge(census_sample_1930_agg_countynhg,new_titles_agg[!is.na(countynhg)][,lapply(.SD,weighted.mean,w=perwt),by=c("countynhg"),.SDcols=c("sh_base","sh_base_tit","sh_base_titind","sh_red","sh_red_tit","sh_red_titind")],by="countynhg",all.x=TRUE,all.y=FALSE)

# Convert all cells with NA values to 0
census_sample_1930_agg_countynhg <- census_sample_1930_agg_countynhg[,lapply(.SD,function(x) {x[is.na(x)] <- 0; x}),.SDcols=names(census_sample_1930_agg_countynhg)]

write_fst(census_sample_1930_agg_countynhg, "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1930_agg_countynhg.fst")
rm(census_sample_1930_agg_countynhg)
```


#### countynhg_1910
```{r}
census_sample_1930_agg_countynhg_1910 <-read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/input/census_sample/census_sample_1930.fst",as.data.table=TRUE,columns=c("statefip","countynhg_1910","urban","farm","ownershp","perwt","famsize","sex","school","lit","age","marst","race","bpl","mbpl","fbpl","school","empstat","labforce","classwkr","occ1950","ind1950","occscore"))[!is.na(countynhg_1910)]

census_sample_1930_agg_countynhg_1910 <- f_census_simplify(census_sample_1930_agg_countynhg_1910)

#- NOTE : if not all the variables are present, do the final construction manually
census_sample_1930_agg_countynhg_1910 <- f_geof_vars(census_sample_1930_agg_countynhg_1910,countynhg_1910)
census_sample_1930_agg_countynhg_1910 <- census_sample_1930_agg_countynhg_1910[!is.na(countynhg_1910)]

# Adding share of workers with new titles
census_sample_1930_agg_countynhg_1910 <- merge(census_sample_1930_agg_countynhg_1910,new_titles_agg[!is.na(countynhg_1910)][,lapply(.SD,weighted.mean,w=perwt),by=c("countynhg_1910"),.SDcols=c("sh_base","sh_base_tit","sh_base_titind","sh_red","sh_red_tit","sh_red_titind")],by="countynhg_1910",all.x=TRUE,all.y=FALSE)

# Convert all cells with NA values to 0
census_sample_1930_agg_countynhg_1910 <- census_sample_1930_agg_countynhg_1910[,lapply(.SD,function(x) {x[is.na(x)] <- 0; x}),.SDcols=names(census_sample_1930_agg_countynhg_1910)]

write_fst(census_sample_1930_agg_countynhg_1910, "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1930_agg_countynhg_1910.fst")
rm(census_sample_1930_agg_countynhg_1910)
```

#### metarea_1940
```{r}
census_sample_1930_agg_metarea_1940 <-read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/input/census_sample/census_sample_1930.fst",as.data.table=TRUE,columns=c("statefip","metarea_1940","urban","farm","ownershp","perwt","famsize","sex","school","lit","age","marst","race","bpl","mbpl","fbpl","school","empstat","labforce","classwkr","occ1950","ind1950","occscore"))[!is.na(metarea_1940)]

# Simplify some variables
census_sample_1930_agg_metarea_1940 <- f_census_simplify(census_sample_1930_agg_metarea_1940)

# NOTE : if not all the variables are present, do the final construction manually
census_sample_1930_agg_metarea_1940 <- f_geof_vars(census_sample_1930_agg_metarea_1940,metarea_1940)
census_sample_1930_agg_metarea_1940 <- census_sample_1930_agg_metarea_1940[!is.na(metarea_1940)]

# Adding share of workers with new titles
census_sample_1930_agg_metarea_1940 <- merge(census_sample_1930_agg_metarea_1940,new_titles_agg[!is.na(metarea_1940)][,lapply(.SD,weighted.mean,w=perwt),by=c("metarea_1940"),.SDcols=c("sh_base","sh_base_tit","sh_base_titind","sh_red","sh_red_tit","sh_red_titind")],by="metarea_1940",all.x=TRUE,all.y=FALSE)

# Convert all cells with NA values to 0
census_sample_1930_agg_metarea_1940 <- census_sample_1930_agg_metarea_1940[,lapply(.SD,function(x) {x[is.na(x)] <- 0; x}),.SDcols=names(census_sample_1930_agg_metarea_1940)]

write_fst(census_sample_1930_agg_metarea_1940, "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1930_agg_metarea_1940.fst")
rm(census_sample_1930_agg_metarea_1940)
```


# Part 1. Data Analysis at the geographic level
Here we look at correlations between the share of new titles and different geographic level variables

## 1. County 1910
### Histogram and correlation graphs
```{r}
# Note: We work with counties with more than 10000 inhabitants
census_sample_1930_agg_countynhg_1910 <- read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1930_agg_countynhg_1910.fst",as.data.table=TRUE)[perwt>=10000][,statefip:=as.factor(statefip)]

# Histogram
ggplot(census_sample_1930_agg_countynhg_1910, aes(x=sh_red_tit)) +
  geom_histogram(color="black",bins=25,fill="white") +
  labs(title="",x="Share of New Work", y = "Count")  + 
  theme_tufte() + theme(legend.position = "none")

ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/histogram_share_red_tit.jpeg",plot=last_plot())


# Some Scatterplots
# Population
ggplot(census_sample_1930_agg_countynhg_1910, aes(y=sh_red_tit, x=log(perwt))) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and population",x="Population (log)", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/corr_pop_x_sh_red_tit.jpeg",plot=last_plot())

# Gender
ggplot(census_sample_1930_agg_countynhg_1910, aes(y=sh_red_tit, x=sh_male)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and male population",x="Share of Males", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/corr_sh_male_x_sh_red_tit.jpeg",plot=last_plot())

# Black population
ggplot(census_sample_1930_agg_countynhg_1910, aes(y=sh_red_tit, x=sh_race_2)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and black population",x="Share of Black population", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/corr_sh_race_2_x_sh_red_tit.jpeg",plot=last_plot())


# Literate
ggplot(census_sample_1930_agg_countynhg_1910, aes(y=sh_red_tit, x=sh_lit)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of literate population",x="Share of literate population", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/corr_sh_lit_x_sh_red_tit.jpeg",plot=last_plot())

# Labor force
ggplot(census_sample_1930_agg_countynhg_1910, aes(y=sh_red_tit, x=sh_labforce_emp)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of labor force",x="Share of labor force", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/corr_sh_labforce_emp_x_sh_red_tit.jpeg",plot=last_plot())

# Working for wages
ggplot(census_sample_1930_agg_countynhg_1910, aes(y=sh_red_tit, x=sh_wrkwage)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of population working for wages",x="Share of population working for wages", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/corr_sh_wrkwage_x_sh_red_tit.jpeg",plot=last_plot())

# Urban
ggplot(census_sample_1930_agg_countynhg_1910, aes(y=sh_red_tit, x=sh_urban)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of urban population",x="Share of urban population", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/corr_sh_urban_x_sh_red_tit.jpeg",plot=last_plot())

# Farm
ggplot(census_sample_1930_agg_countynhg_1910, aes(y=sh_red_tit, x=sh_farm)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of farm population",x="Share of farm population", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/corr_sh_farm_x_sh_red_tit.jpeg",plot=last_plot())

# Migration within the US
ggplot(census_sample_1930_agg_countynhg_1910, aes(y=sh_red_tit, x=sh_mig_us)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of internal migrants",x="Share of internal migrants", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/corr_sh_mig_us_x_sh_red_tit.jpeg",plot=last_plot())

# Goreign migrants
ggplot(census_sample_1930_agg_countynhg_1910, aes(y=sh_red_tit, x=sh_mig_ab)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of foreign migrants",x="Share of foreign migrants", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/corr_sh_mig_ab_x_sh_red_tit.jpeg",plot=last_plot())


# Industry
x <- c("sh_ind1950_main_1","sh_ind1950_main_2","sh_ind1950_main_3","sh_ind1950_main_4","sh_ind1950_main_5","sh_ind1950_main_6","sh_ind1950_main_7")
p <- vector(mode = "list", length = length(x))
for (i in 1:7) {
  p[[i]] <- ggplot(census_sample_1930_agg_countynhg_1910, aes_string(y="sh_red_tit", x= x[i])) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="",x="Share of workers", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"), legend.position = "top")
}
ggarrange(p[[1]],p[[2]],p[[3]],p[[4]],labels=c("Agriculture","Mining-Construction","Manufacturing","Tr-Comm-Util"),
          ncol=2,nrow=2)
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/corr_sh_ind1950_main_x_sh_red_tit_1.jpeg",plot=last_plot())
ggarrange(p[[5]],p[[6]],p[[7]],labels=c("Trade","Services","Public Admin."),
          ncol=2,nrow=2)
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/corr_sh_ind1950_main_x_sh_red_tit_2.jpeg",plot=last_plot())


# Occupation
x <- c("sh_occ1950_main_0","sh_occ1950_main_100","sh_occ1950_main_200","sh_occ1950_main_300","sh_occ1950_main_400","sh_occ1950_main_500","sh_occ1950_main_600","sh_occ1950_main_700","sh_occ1950_main_730","sh_occ1950_main_800","sh_occ1950_main_900")
p <- vector(mode = "list", length = length(x))
for (i in 1:length(x)) {
  p[[i]] <- ggplot(census_sample_1930_agg_countynhg_1910, aes_string(y="sh_red_tit", x= x[i])) +
            geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) +
            labs(title="",x="Share of workers", y = "Share of New Work") + theme(axis.line=element_line(color="black"), legend.position = "top") + theme_tufte() 
}
ggarrange(p[[1]],p[[2]],p[[3]],p[[4]],labels=c("Professional, Technical","Farmers","Managers, Officials and Proprietors","Clerical and Kindred"),font.label = list(size = 10),
          ncol = 2, nrow =2)
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/corr_sh_occ1950_main_x_sh_red_tit_1.jpeg",plot=last_plot())
ggarrange(p[[5]],p[[6]],p[[7]],p[[8]],labels=c("Sales workers","Craftsmen","Operatives","Service Workers (private household)"),font.label = list(size = 10), ncol = 2, nrow =2)
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/corr_sh_occ1950_main_x_sh_red_tit_2.jpeg",plot=last_plot())
ggarrange(p[[9]],p[[10]],p[[11]],labels=c("Service Workers (not household)","Farm laborers","Laborers"),font.label = list(size = 10),
          ncol = 2, nrow =2)
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/corr_sh_occ1950_main_x_sh_red_tit_3.jpeg",plot=last_plot())
```

### Basic regressions
```{r}
# Basic
m1 <- lm(sh_red_tit ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab, data=census_sample_1930_agg_countynhg_1910)
m2 <- lm(sh_red_tit ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab + statefip , data=census_sample_1930_agg_countynhg_1910)
m3 <- plm(sh_red_tit ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab, 
                    data = census_sample_1930_agg_countynhg_1910,
                    index = c("statefip"), 
                    model = "within")

tab_model(m1,m2,m3,show.ci=FALSE,show.se=TRUE,use.viewer=FALSE)
plot_summs(m1,m3, scale = FALSE,legend.title = "") + theme_tufte()
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/reg_basic.jpeg",plot=last_plot())

# Industry variables
(indvar <- grep("^sh_ind1950_main_[^1]",names(census_sample_1930_agg_countynhg_1910),value=TRUE))

form <- as.formula(paste("sh_red_tit ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab +",paste0(indvar,collapse=" + ")))
form1 <- as.formula(paste("sh_red_tit ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab + statefip +",paste0(indvar,collapse=" + ")))

m4 <- lm(form,data=census_sample_1930_agg_countynhg_1910)
m5 <- lm(form1, data=census_sample_1930_agg_countynhg_1910)
m6 <- plm(form1, 
                    data = census_sample_1930_agg_countynhg_1910,
                    index = c("statefip"), 
                    model = "within")

tab_model(m4,m5,m6,show.ci=FALSE,show.se=TRUE,use.viewer=FALSE)
plot_summs(m4,m6, scale = FALSE,legend.title = "") + theme_tufte()
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/reg_industry.jpeg",plot=last_plot())


# Occupation variables
(occvar <- grep("^sh_occ1950_main_[^0]",names(census_sample_1930_agg_countynhg_1910),value=TRUE))

form <- as.formula(paste("sh_red_tit ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab +",paste0(occvar,collapse=" + ")))
form1 <- as.formula(paste("sh_red_tit ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab + statefip +",paste0(occvar,collapse=" + ")))

m7 <- lm(form,data=census_sample_1930_agg_countynhg_1910)
m8 <- lm(form1, data=census_sample_1930_agg_countynhg_1910)
m9 <- plm(form1, 
                    data = census_sample_1930_agg_countynhg_1910,
                    index = c("statefip"), 
                    model = "within")

tab_model(m7,m8,m9,show.ci=FALSE,show.se=TRUE,use.viewer=FALSE)
plot_summs(m7,m9, scale = FALSE,legend.title = "") + theme_tufte()
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/reg_occupation.jpeg",plot=last_plot())


# Industry and occupation variables
form <- as.formula(paste("sh_red_tit ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab +",paste0(indvar,collapse=" + ")," + ",paste0(occvar,collapse=" + ")))
form1 <- as.formula(paste("sh_red_tit ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab + statefip +",paste0(indvar,collapse=" + ")," + ",paste0(occvar,collapse=" + ")))

m10 <- lm(form,data=census_sample_1930_agg_countynhg_1910)
m11 <- lm(form1, data=census_sample_1930_agg_countynhg_1910)
m12 <- plm(form1, 
                    data = census_sample_1930_agg_countynhg_1910,
                    index = c("statefip"), 
                    model = "within")

tab_model(m10,m11,m12,show.ci=FALSE,show.se=TRUE,use.viewer=FALSE)
plot_summs(m10,m12, scale = FALSE,legend.title = "") + theme_tufte()
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/reg_industry_occupation.jpeg",plot=last_plot())



plot_summs(m1,m4,m7,m10, scale = FALSE,legend.title = "") + theme_tufte()
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/reg_all_no_statefip.jpeg",plot=last_plot())

plot_summs(m3,m6,m9,m12, scale = FALSE,legend.title = "") + theme_tufte()
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/reg_all_statefip.jpeg",plot=last_plot())


rm(list=paste0("m",1:12))
rm(form,form1)
```
Notes:
-"scale=TRUE" standardizes the beta coefficients. This helps to display all the coefficients in the graph

## 2. Metarea_1940

### Histogram and correlation grpahs
```{r}
census_sample_1930_agg_metarea_1940 <- read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1930_agg_metarea_1940.fst",as.data.table=TRUE)[,MSA:=factor(ifelse(metarea_1940<1000,1,0), levels = c(0,1),labels = c("Non MSAs","MSAs"))]

# Histogram
ggplot(census_sample_1930_agg_metarea_1940, aes(x=sh_red_tit)) +
  geom_histogram(color="black",bins=25,fill="white") +
  facet_grid(MSA ~ .) +
  labs(title="",x="Share of New Work", y = "Count") +
  geom_vline(data=census_sample_1930_agg_metarea_1940[,.(sh_red_tit=mean(sh_red_tit)),by="MSA"],aes(xintercept=sh_red_tit, color=MSA),
           linetype="dashed") + 
  theme_tufte() + theme(legend.position = "none")

ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/histogram_share_red_tit.jpeg",plot=last_plot())


# Some Scatterplots
# Population
ggplot(census_sample_1930_agg_metarea_1940, aes(y=sh_red_tit, x=log(perwt),color=MSA)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and population",x="Population (log)", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/corr_pop_x_sh_red_tit.jpeg",plot=last_plot())

# Gender
ggplot(census_sample_1930_agg_metarea_1940, aes(y=sh_red_tit, x=sh_male,color=MSA)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and male population",x="Share of Males", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/corr_sh_male_x_sh_red_tit.jpeg",plot=last_plot())

# Black population
ggplot(census_sample_1930_agg_metarea_1940, aes(y=sh_red_tit, x=sh_race_2,color=MSA)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and black population",x="Share of Black population", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/corr_sh_race_2_x_sh_red_tit.jpeg",plot=last_plot())


# Literate
ggplot(census_sample_1930_agg_metarea_1940, aes(y=sh_red_tit, x=sh_lit,color=MSA)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of literate population",x="Share of literate population", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/corr_sh_lit_x_sh_red_tit.jpeg",plot=last_plot())

# Labor force
ggplot(census_sample_1930_agg_metarea_1940, aes(y=sh_red_tit, x=sh_labforce_emp,color=MSA)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of labor force",x="Share of labor force", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/corr_sh_labforce_emp_x_sh_red_tit.jpeg",plot=last_plot())

# Working for wages
ggplot(census_sample_1930_agg_metarea_1940, aes(y=sh_red_tit, x=sh_wrkwage,color=MSA)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of population working for wages",x="Share of population working for wages", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/corr_sh_wrkwage_x_sh_red_tit.jpeg",plot=last_plot())

# Urban
ggplot(census_sample_1930_agg_metarea_1940, aes(y=sh_red_tit, x=sh_urban,color=MSA)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of urban population",x="Share of urban population", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/corr_sh_urban_x_sh_red_tit.jpeg",plot=last_plot())

# Farm
ggplot(census_sample_1930_agg_metarea_1940, aes(y=sh_red_tit, x=sh_farm,color=MSA)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of farm population",x="Share of farm population", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/corr_sh_farm_x_sh_red_tit.jpeg",plot=last_plot())

# Migration within the US
ggplot(census_sample_1930_agg_metarea_1940, aes(y=sh_red_tit, x=sh_mig_us,color=MSA)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of internal migrants",x="Share of internal migrants", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/corr_sh_mig_us_x_sh_red_tit.jpeg",plot=last_plot())

# Goreign migrants
ggplot(census_sample_1930_agg_metarea_1940, aes(y=sh_red_tit, x=sh_mig_ab,color=MSA)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of foreign migrants",x="Share of foreign migrants", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/corr_sh_mig_ab_x_sh_red_tit.jpeg",plot=last_plot())


# Industry
x <- c("sh_ind1950_main_1","sh_ind1950_main_2","sh_ind1950_main_3","sh_ind1950_main_4","sh_ind1950_main_5","sh_ind1950_main_6","sh_ind1950_main_7")
p <- vector(mode = "list", length = length(x))
for (i in 1:7) {
  p[[i]] <- ggplot(census_sample_1930_agg_metarea_1940, aes_string(y="sh_red_tit", x= x[i]),color=MSA) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="",x="Share of workers", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"), legend.position = "top")
}
ggarrange(p[[1]],p[[2]],p[[3]],p[[4]],labels=c("Agriculture","Mining-Construction","Manufacturing","Tr-Comm-Util"),
          ncol=2,nrow=2)
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/corr_sh_ind1950_main_x_sh_red_tit_1.jpeg",plot=last_plot())
ggarrange(p[[5]],p[[6]],p[[7]],labels=c("Trade","Services","Public Admin."),
          ncol=2,nrow=2)
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/corr_sh_ind1950_main_x_sh_red_tit_2.jpeg",plot=last_plot())


# Occupation
x <- c("sh_occ1950_main_0","sh_occ1950_main_100","sh_occ1950_main_200","sh_occ1950_main_300","sh_occ1950_main_400","sh_occ1950_main_500","sh_occ1950_main_600","sh_occ1950_main_700","sh_occ1950_main_730","sh_occ1950_main_800","sh_occ1950_main_900")
p <- vector(mode = "list", length = length(x))
for (i in 1:length(x)) {
  p[[i]] <- ggplot(census_sample_1930_agg_metarea_1940, aes_string(y="sh_red_tit", x= x[i]),color=MSA) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="",x="Share of workers", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"), legend.position = "top")
}
ggarrange(p[[1]],p[[2]],p[[3]],p[[4]],labels=c("Farmers","Managers, Officials/n and Proprietors","Clerical and Kindred","Sales workers"),
          ncol = 2, nrow =2)
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/corr_sh_occ1950_main_x_sh_red_tit_1.jpeg",plot=last_plot())
ggarrange(p[[5]],p[[6]],p[[7]],p[[8]],labels=c("Craftsmen","Operatives","Public Admin.","Service Workers (priv. hs.)"),
          ncol = 2, nrow =2)
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/corr_sh_occ1950_main_x_sh_red_tit_2.jpeg",plot=last_plot())
ggarrange(p[[9]],p[[10]],p[[11]],labels=c("Service Workers","Farm laborers","Laborers"),
          ncol = 2, nrow =2)
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/corr_sh_occ1950_main_x_sh_red_tit_3.jpeg",plot=last_plot())
```

### Basic regressions
```{r}
# Basic
m1 <- lm(sh_red_tit ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab, data=census_sample_1930_agg_metarea_1940)
m2 <- lm(sh_red_tit ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab, data=census_sample_1930_agg_metarea_1940[MSA=="Non MSAs"])
m3 <- lm(sh_red_tit ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab, data=census_sample_1930_agg_metarea_1940[MSA=="MSAs"])

tab_model(m1,m2,m3,show.ci=FALSE,show.se=TRUE,use.viewer=FALSE)
plot_summs(m1,m2,m3, scale = TRUE) + theme_tufte()
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/reg_basic.jpeg",plot=last_plot())

# Industry variables
(indvar <- grep("^sh_ind1950_main_[^1]",names(census_sample_1930_agg_metarea_1940),value=TRUE))
#form <- reformulate(c("perwt","sh_race_1","sh_race_2","sh_lit","sh_urban","sh_farm","sh_mig_us","sh_mig_ab",indvar),response="sh_red_tit")

form <- as.formula(paste("sh_red_tit ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab +",paste0(indvar,collapse=" + ")))

m4 <- lm(form,data=census_sample_1930_agg_metarea_1940)
m5 <- lm(form, data=census_sample_1930_agg_metarea_1940[MSA=="Non MSAs"])
m6 <- lm(form, data=census_sample_1930_agg_metarea_1940[MSA=="MSAs"])

tab_model(m4,m5,m6,show.ci=FALSE,show.se=TRUE,use.viewer=FALSE)
plot_summs(m4, m5,m6, scale = FALSE) + theme_tufte()
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/reg_industry.jpeg",plot=last_plot())


# Occupation variables
(occvar <- grep("^sh_occ1950_main_[^0]",names(census_sample_1930_agg_metarea_1940),value=TRUE))

form <- as.formula(paste("sh_red_tit ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab +",paste0(occvar,collapse=" + ")))

m7 <- lm(form,data=census_sample_1930_agg_metarea_1940)
m8 <- lm(form, data=census_sample_1930_agg_metarea_1940[MSA=="Non MSAs"])
m9 <- lm(form, data=census_sample_1930_agg_metarea_1940[MSA=="MSAs"])

tab_model(m7,m8,m9,show.ci=FALSE,show.se=TRUE,use.viewer=FALSE)
plot_summs(m7, m8,m9, scale = FALSE) + theme_tufte()
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/reg_occupation.jpeg",plot=last_plot())


# Industry + Occupation variables
form <- as.formula(paste("sh_red_tit ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab +",paste0(occvar,collapse=" + ")," + ",paste0(indvar,collapse=" + ")))

m10 <- lm(form,data=census_sample_1930_agg_metarea_1940)
m11 <- lm(form, data=census_sample_1930_agg_metarea_1940[MSA=="Non MSAs"])
m12 <- lm(form, data=census_sample_1930_agg_metarea_1940[MSA=="MSAs"])

tab_model(m10,m11,m12,show.ci=FALSE,show.se=TRUE,use.viewer=FALSE)
plot_summs(m10,m12, scale = FALSE,legend.title = "") + theme_tufte()
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/reg_industry_occupation.jpeg",plot=last_plot())



plot_summs(m1,m4,m7,m10, scale = FALSE,legend.title = "") + theme_tufte()
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/reg_all.jpeg",plot=last_plot())

plot_summs(m2,m5,m8,m11, scale = FALSE,legend.title = "") + theme_tufte()
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/reg_all_non_MSAs.jpeg",plot=last_plot())

plot_summs(m3,m6,m9,m12, scale = FALSE,legend.title = "") + theme_tufte()
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/reg_all_MSAs.jpeg",plot=last_plot())

rm(list=paste0("m",1:12))
```



# Part 2. Data Analysis focused on the new titles
Here we look more in depth at the share of "new titles" in different industries and occupations 

# 1. Industries/Occupations and new titles

## 1.1. Functions
### Function to create industry variable
```{r}
# Function to construct the data.table with information at the industry level
# This code works by using a given (unchanged) name for some variables inside the code and by changing the name of argument var (and "var"_name)
# to those inside variables and then reverting to the original variables
# Note: Here we are using non-standard evaluation
f_ind_new_titles <- function(X,id_N,var=ind,sh_v,w_v=perwt,occind_v=occind,names=NULL) {
  y <- copy(X)

  # Through the code we will simply use varp as the variable
  setnames(y, c(deparse(substitute(var)),deparse(substitute(sh_v)),deparse(substitute(w_v)),deparse(substitute(occind_v))), c("varp","sh_new","perwt","occind")) 
  
  
  # Computing the different things
      y <- y[,`:=`(sh_new=perwt*sh_new)][,lapply(.SD,sum),by=c("varp","occind"),.SDcols=c("perwt","sh_new")][,c("sum_new","emp"):=lapply(.SD,sum),by="varp",.SDcols=c("sh_new","perwt")][,`:=`(sh_occ=perwt/emp,sh_new_occ=sh_new/sum_new)]
  
  setorderv(y,   c("varp" ,"sh_new_occ"),c(1,-1) )
  y <- y[,id:=1:.N,by="varp"][id<=id_N][,sh_new:=sh_new/emp][,sh_new:=sum_new/emp][,c("perwt","sum_new"):=NULL]
    
  y <- data.table::dcast(y, varp + sh_new + emp  ~ id, value.var = c("occind","sh_new_occ","sh_occ") )
    
  
  if (!is.null(names)) {
    # It seems that the names argument doesn't get changed by reference, so we don't need    "names <- copy(names)"
    setnames(names, c(deparse(substitute(var)), paste0(substitute(var),"_name")  ), c("varp","varp_name")  )
  
    y <- merge(y,names,by="varp",all.x=TRUE,all.y=FALSE)
    
    # Reorder columns so that we have the industry code and name  
    if(!is.null(names$varp_name)) {
       idcols <- c("varp","varp_name"); cols <- c(idcols, names(y)[-which(names(y) %in% idcols)])
       setcolorder(y, cols)
    }
    setnames(y, c("varp_name"), c( paste0(substitute(var),"_name")   )) 
  }
  setorderv(y,c("sh_new",  "varp")  ,  c(-1,1)  )
  setnames(y, c("varp","sh_new"),
           c(deparse(substitute(var)),deparse(substitute(sh_v)))
           ) 
  
}
```
In the IPUMS sample the ind variable is missing for many workers. This is not the case for ind1950. It might be better to use the ind1950 variable instead of the ind one.

### Function to create occupations and new titles
```{r}
# Function to construct the data.table with information at the occupation level
 # NOte: FOr now we don't use different occ codes as the new titles are only created using occind
  
f_occ_new_titles <- function(X,id_N,ind_v=ind,sh_v,w_v=perwt,occind_v=occind,names=NULL,occind_n,occind_name_n) {
  # Avoids confusion with variable ind
  y <- copy(X)
  #print(y)
  # Through the code we will simply use varp as the variable
  setnames(y, c(deparse(substitute(ind_v)),deparse(substitute(sh_v)),deparse(substitute(w_v)),deparse(substitute(occind_v))), c("v_ind","sh_new","perwt","occind")) 

  # Computing the different things
  y <- y[,lapply(.SD,sum),by=c("occind","sh_new","v_ind"),.SDcols=c("perwt")][,c("emp_occ"):=lapply(.SD,sum),by=c("occind","sh_new"),.SDcols=c("perwt")][,`:=`(sh_ind=perwt/emp_occ)]
  setorder(y,occind,-sh_ind)
  y <- y[,id:=1:.N,by="occind"][id<=id_N][,c("perwt"):=NULL]
  
  setnames(y, c("v_ind"), c(deparse(substitute(ind_v))) ) 
  # Since the variables in value.var are given as characters I can easily use var_ch. That way I have the correct name for the wide variable
  y <- data.table::dcast(y, occind + sh_new + emp_occ  ~ id, value.var = c(deparse(substitute(ind_v)),"sh_ind") )
  
  if (!is.null(names)) {
    
    setnames(names, c( deparse(substitute(occind_n) ), deparse(substitute(occind_name_n))  ), c("occind","occind_name")  )
    
    y <- merge(y,names,by="occind",all.x=TRUE,all.y=FALSE)
    
    idcols <- c("occind","occind_name"); cols <- c(idcols, names(y)[-which(names(y) %in% idcols)])  
    setcolorder(y, cols)
    
  }
  setorder(y,-sh_new,occind)
  
  setnames(y, c("occind","sh_new","occind_name"),
           c(deparse(substitute(occind_v)),deparse(substitute(sh_v)),deparse(substitute(occind_name_n)))
           ) 
}

```

## 1.2. Creating sample of interest
```{r}
census_sample_1930_ind_occ_table <- read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/input/census_sample/census_sample_1930.fst",as.data.table=TRUE,columns=c("perwt","occ1950","occ","occind","ind","ind1950"))[!(occ %in% c(998,999)) & (ind1950 >=1 & ind1950<=990)]

census_sample_1930_ind_occ_table <-  merge(census_sample_1930_ind_occ_table,new_titles.occind1930[[1]][,c("occind","sh_base","sh_base_tit","sh_base_titind","sh_red","sh_red_tit","sh_red_titind")],by="occind",all=FALSE)[,perwt_sum:=sum(perwt),by=c("occ1950","occ","occind","ind","ind1950")][,lapply(.SD,weighted.mean,w=perwt),by=c("occ1950","occ","occind","ind","ind1950"),.SDcols=c("perwt_sum","sh_base","sh_base_tit","sh_base_titind","sh_red","sh_red_tit","sh_red_titind")]
setnames(census_sample_1930_ind_occ_table,"perwt_sum","perwt")
```

## 1.3 Creating tables of interest

### Calling names of industries and occupations
```{r}
ind1950.codes <- as.data.table( read_excel("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/input/1930 - Cleaned.xlsx", sheet = "ind1950",guess_max=10000) )

occ1930.codes <- as.data.table( read_excel("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/input/1930 - Cleaned.xlsx", sheet = "1930 main groups",guess_max=10000) )[,!c("occ_ini_1930","occ1930","occ_name")]

occ1950.codes <- as.data.table( read_excel("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/input/1930 - Cleaned.xlsx", sheet = "occ1950",guess_max=10000) )
```


### Creating and exporting tables
```{r}
census_sample_1930_ind1950_table <- f_ind_new_titles(census_sample_1930_ind_occ_table,id_N=5,var=ind1950,sh_v=sh_base_tit,occind_v=occind,names=ind1950.codes[,c("ind1950","ind1950_name")])    
census_sample_1930_occ_table <- f_occ_new_titles(census_sample_1930_ind_occ_table,id_N=5,ind_v=ind1950,sh_v=sh_base_tit,w_v=perwt,occind_v=occind,names=occ1930.codes[,c("occind","occind1930_name")],occind_n = occind,occind_name_n = occind1930_name)


```


# 2. Locations and new titles
## 2.1. Functions

```{r}
f_location_new_titles <- function(X,sh_v,w_v=perwt,geof1_v,geof2_v,merge_geof,geof_m,geof_final1_m,geof_final2_m,share_m) {
  # Avoids confusion with variable ind
  y <- copy(X)
  #print(y)
  # Through the code we will simply use varp as the variable
  setnames(y, c(deparse(substitute(sh_v)),deparse(substitute(w_v)),deparse(substitute(geof1_v))), c("sh_new","perwt","geof1"))
  
  if (!missing(merge_geof)) {
    m_geof <- copy(merge_geof)
    setnames(m_geof, c( deparse(substitute(geof_m) ), deparse(substitute(geof_final1_m)),deparse(substitute(share_m))  ), c("geof1","geof_final1","sh_m")  )
    
    y <- merge(y,m_geof,by="geof1",all.x=TRUE,all.y=FALSE,allow.cartesian=TRUE)
    y <- y[,perwt:=perwt*sh_m][,sh_new:=perwt*sh_new][,sh_m:=NULL]
    
    if (!missing(geof_final2_m)) {
      setnames(y, c( deparse(substitute(geof_final2_m)) ), c("geof_final2")  )
       
      y <- y[,lapply(.SD,sum),by=c("geof_final1","geof_final2"),.SDcols=c("perwt","sh_new")][,sh_new:=sh_new/perwt]
       
       y <- y[,c("geof_final1","geof_final2","perwt","sh_new")]
       setnames(y, c("geof_final1","geof_final2","perwt","sh_new"), c(deparse(substitute(geof_final1_m)),deparse(substitute(geof_final2_m)),deparse(substitute(w_v)),deparse(substitute(sh_v))))
    } else {
       y <- y[,lapply(.SD,sum),by=c("geof_final1"),.SDcols=c("perwt","sh_new")][,sh_new:=sh_new/perwt]
       y <- y[,c("geof_final1","perwt","sh_new")]
       setnames(y, c("geof_final1","perwt","sh_new"), c(deparse(substitute(geof_final1_m)),deparse(substitute(w_v)),deparse(substitute(sh_v))))
    }
    
    
    
  } else {
    y <- y[,sh_new:=perwt*sh_new]
    
    if (!missing(geof2_v)) {
      setnames(y, deparse(substitute(geof2_v)), c("geof2"))
      y <- y[,lapply(.SD,sum),by=c("geof1","geof2"),.SDcols=c("perwt","sh_new")][,sh_new:=sh_new/perwt] 
      y <- y[,c("geof1","geof2","perwt","sh_new")]
      setnames(y, c("geof1","geof2","perwt","sh_new"), c(deparse(substitute(geof1_v)),deparse(substitute(geof2_v)),deparse(substitute(w_v)),deparse(substitute(sh_v))))
    } else {
      y <- y[,lapply(.SD,sum),by=c("geof1"),.SDcols=c("perwt","sh_new")][,sh_new:=sh_new/perwt] 
      y <- y[,c("geof1","perwt","sh_new")]
      setnames(y, c("geof1","perwt","sh_new"), c(deparse(substitute(geof1_v)),deparse(substitute(w_v)),deparse(substitute(sh_v))))
    }
  }
  y <- na.omit(y)
} 
```

## 2.2. Preparing the data
# Data at the county level (county 1910)
We can simply use the aggregated county level data created in Part 1.
```{r}
new_title_location.countynhg_1910_more1000 <- read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1930_agg_countynhg_1910.fst",as.data.table=TRUE,columns=c("countynhg_1910","perwt","sh_base","sh_base_tit","sh_base_titind","sh_red","sh_red_tit","sh_red_titind"))[perwt>=1000 & !is.na(countynhg_1910)]

new_title_location.countynhg_1910_more10000 <- read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1930_agg_countynhg_1910.fst",as.data.table=TRUE,columns=c("countynhg_1910","perwt","sh_base","sh_base_tit","sh_base_titind","sh_red","sh_red_tit","sh_red_titind"))[perwt>=10000 & !is.na(countynhg_1910)]

```

# Data at the metarea level
For the mapping we aggregate MSAs and those non-dentified MSAs we aggregate by state.
We use a dataset previously created that contains the share of new titles by occind, countynhg, countynhg_1910, metarea_1940. 
** We could use the data aggregated at the MSA level once we know how to combine counties in the map function
```{r}
new_titles_agg <- read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/new_titles_agg.fst",as.data.table=TRUE)

new_title_location.metarea_1940 <- new_titles_agg[!is.na(metarea_1940) & !is.na(countynhg_1910),!c("occind")][,perwt_sum:=sum(perwt),by=c("countynhg_1910","metarea_1940")][,lapply(.SD,weighted.mean,w=perwt),by=c("countynhg_1910","metarea_1940"),.SDcols=c("perwt_sum","sh_base","sh_base_tit","sh_base_titind","sh_red","sh_red_tit","sh_red_titind")]

# If a county is repeated ( e.g. because one part belongs to an MSA and another to another), keep the county with the largest population
setorderv(new_title_location.metarea_1940,c("countynhg_1910","perwt_sum"),c(1,-1))
new_title_location.metarea_1940 <- new_title_location.metarea_1940[,.SD[1],by=c("countynhg_1910"),.SDcols=c("metarea_1940","perwt_sum","sh_base","sh_base_tit","sh_base_titind","sh_red","sh_red_tit","sh_red_titind")]

# Counties within the same MSA have the same value for the variables
new_title_location.metarea_1940 <- new_title_location.metarea_1940[,perwt:=sum(perwt_sum),by=c("metarea_1940")][,c("perwt","sh_base","sh_base_tit","sh_base_titind","sh_red","sh_red_tit","sh_red_titind"):=lapply(.SD,weighted.mean,w=perwt_sum),by=c("metarea_1940"),.SDcols=c("perwt_sum","sh_base","sh_base_tit","sh_base_titind","sh_red","sh_red_tit","sh_red_titind")]

```


## 2.3. Mapping
### 2.3.1. Import and subset shape files
```{r}
# Importing shp file 
# 1 Option
map.cty <- st_read("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/input/shapefiles/shapefile_us_county_1910", quiet = TRUE)


map.state <- st_read("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/input/shapefiles/shapefile_us_state_1910", quiet = TRUE)

if (FALSE) {
# 2 option
map.cty <- read_sf(dsn="/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/input/shapefiles/shapefile_us_county_1910")

# 3 option
# NOTE requires the data_file
map.state <- read_nhgis_sf(
  data_file = "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/input/shapefiles/nhgis0006_csv",
  shape_file = "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/input/shapefiles/nhgis0006_shape.zip"
)
}
#subsetting it and dropping Alaska and Hawaii
map.cty <- subset(map.cty,select=c(GISJOIN2,STATENAM,geometry))
map.cty <- subset(map.cty, STATENAM !="Alaska Territory" & STATENAM != "Hawaii Territory")
map.cty$GISJOIN2 <- as.numeric(map.cty$GISJOIN2)
map.state <- subset(map.state,select=c(GISJOIN2,STATENAM,geometry))
map.state <- subset(map.state, STATENAM !="Alaska Territory" & STATENAM != "Hawaii Territory")

```


### 2.3.2. Join with info for population and share of new work

#### countynhg_1910
```{r}
setnames(new_title_location.countynhg_1910_more10000,c("countynhg_1910"),c("GISJOIN2"))
map.countynhg_1910_more10000 <- merge(map.cty,new_title_location.countynhg_1910_more10000,by="GISJOIN2",all.x=TRUE,all.y=FALSE)
county <- tm_shape(subset(map.countynhg_1910_more10000)) + tm_polygons("sh_base_tit",style = "pretty", n=10,lwd=0) +
  tm_shape(map.state) + tm_borders(alpha=0.1,lwd=0.5)
tmap_save(county, "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Maps/sh_new_occupations_countynhg_1910_more10000.jpeg")
rm(county)

setnames(new_title_location.countynhg_1910_more1000,c("countynhg_1910"),c("GISJOIN2"))
map.countynhg_1910_more1000 <- merge(map.cty,new_title_location.countynhg_1910_more1000,by="GISJOIN2",all.x=TRUE,all.y=FALSE)
county <- tm_shape(subset(map.countynhg_1910_more1000)) + tm_polygons("sh_base_tit",style = "pretty", n=10,lwd=0) +
  tm_shape(map.state) + tm_borders(alpha=0.1,lwd=0.5)
tmap_save(county, "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Maps/sh_new_occupations_countynhg_1910_more1000.jpeg")
rm(county)

```

#### metarea_1940
```{r}
setnames(new_title_location.metarea_1940,c("countynhg_1910"),c("GISJOIN2"))
map.metarea <- merge(map.cty,new_title_location.metarea_1940,by="GISJOIN2",all.x=TRUE,all.y=FALSE)
metarea <- tm_shape(subset(map.metarea)) + tm_polygons("sh_base_tit",style = "pretty", n=10,lwd=0) +
  tm_shape(map.state) + tm_borders(alpha=0.1,lwd=0.5)
tmap_save(metarea, "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Maps/sh_new_occupations_metarea_1940.jpeg")
rm(metarea)
```


# Part 3. Data Analysis using individual level observations
Here we study the main characteristics of persons employed in new work

# 1. Creating the main dataset
## 1.1. Importing, selecting the appropriate data
```{r}
census_sample_1930_individual_data <-read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/input/census_sample/census_sample_1930.fst",as.data.table=TRUE,columns=c("ID","perwt_ID","sh_area","statefip","countynhg_1910","metarea_1940","urban","farm","ownershp","famsize","sex","lit","age","marst","race","bpl","mbpl","fbpl","empstat","labforce","classwkr","occ1950","ind1950","occind","occscore"))[!is.na(countynhg_1910)]

# Keep only workers that are working (we use any of the three variables to determine if a worker is working)
census_sample_1930_individual_data <- census_sample_1930_individual_data[labforce==2 | empstat==1 | empstat==2 | classwkr!=0]

# Associate each ID with the location that has a highest sh_area
setorderv(census_sample_1930_individual_data,c("ID","sh_area"),c(1,-1))
census_sample_1930_individual_data <- census_sample_1930_individual_data[,.SD[1],by="ID",.SDcols=names(census_sample_1930_individual_data)[-which(names(census_sample_1930_individual_data)=="ID")]][,sh_area:=NULL]

# Observations without occind
print(paste0((sum(census_sample_1930_individual_data[is.na(occind)]$perwt)/sum(census_sample_1930_individual_data$perwt))*100,"% of the working population has not a valid occupation code and will be dropped"))
census_sample_1930_individual_data <- census_sample_1930_individual_data[!is.na(occind)]

```

## 1.2. Simplify some variables
```{r}
census_sample_1930_individual_data <- f_bpl(census_sample_1930_individual_data,statefip,birth_v=bpl,flag=0,name=c("mig_us","mig_ab")) 
census_sample_1930_individual_data <- f_bpl(census_sample_1930_individual_data,statefip,birth_v=mbpl,flag=0,name=c("m_mig_us","m_mig_ab"))
census_sample_1930_individual_data <- f_bpl(census_sample_1930_individual_data,statefip,birth_v=fbpl,flag=0,name=c("f_mig_us","f_mig_ab")) 
  
census_sample_1930_individual_data <- f_lit(census_sample_1930_individual_data,lit)    
census_sample_1930_individual_data <- f_age(census_sample_1930_individual_data,age,flag=0)
census_sample_1930_individual_data <- f_ind1950(census_sample_1930_individual_data,ind1950,flag=0) 
census_sample_1930_individual_data <- f_occ1950(census_sample_1930_individual_data,occ1950,flag=0)
census_sample_1930_individual_data <- f_mar(census_sample_1930_individual_data,marst) 
census_sample_1930_individual_data <- f_race(census_sample_1930_individual_data,race)
census_sample_1930_individual_data[,male:=ifelse(sex==1,1,0)][,sex:=NULL]
census_sample_1930_individual_data[,urban:=ifelse(urban==2,1,0)] 
census_sample_1930_individual_data[,farm:=ifelse(farm==2,1,0)]  
census_sample_1930_individual_data[,ownershp:=na_if(ownershp,0)][!is.na(ownershp),ownershp:=ifelse(ownershp==1,1,0)] 
census_sample_1930_individual_data[,wwages:=ifelse(classwkr==2,1,0)]   # Works for wages

```

## 1.3. Adding the new work variable
```{r}
# Variable
if (!exists("new_titles.occind1930")) {
  occ1930.codes <- as.data.table( read_excel("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/input/1930 - Cleaned.xlsx", sheet = "1930 main groups",guess_max=10000) )[,!c("occ_ini_1930","occ1930","occ_name")]
  
  new_titles.occind1930 <- list(
                                  read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/new_titles_1930_by_occind.fst",as.data.table=TRUE),
                                  read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/new_titles_1930_by_occind.all.fst",as.data.table=TRUE)
  )
  
  new_titles.occind1930[[1]] <- merge(new_titles.occind1930[[1]],occ1930.codes[,c("occind1930","occind1930_name","occ","ind","occind","flag")],by="occind1930",all=TRUE)
  new_titles.occind1930[[2]] <- merge(new_titles.occind1930[[2]],occ1930.codes[,c("occind1930","occind1930_name","occ","ind","occind","flag")],by="occind1930",all=TRUE)
  new_titles.occind1930[[1]]
}

census_sample_1930_individual_data <- merge(census_sample_1930_individual_data,new_titles.occind1930[[1]][,c("occind","sh_base_tit","sh_red_tit")],by="occind",all.x=TRUE,all.y=FALSE)

```

## 1.4. Saving individual data (without aggregate variables at the geographical level)

```{r}
write_fst(census_sample_1930_individual_data, "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1930_individual_data.fst")
```


# 2. Basic Plots of the different variables
## 2.1. Scatter (binned) plots
```{r}
y <- c("urban","farm","ownershp","famsize","male","lit","marst","age","mig_us","mig_ab","m_mig_us","m_mig_ab","f_mig_us","f_mig_ab")
for (i in 1:length(y)) {
  setnames(census_sample_1930_individual_data,y[i],c("v_plot"))
  p <- ggplot(census_sample_1930_individual_data[,c("sh_base_tit","v_plot")], aes_string(x="sh_base_tit",y="v_plot")) +
    geom_point(size=0.5) +
    stat_summary_bin(fun='mean', bins=10,
                     color='orange', size=4, geom='point') + labs(title=paste0(y[i]," x Share of New Work (sh_base_tit)"),x="Share of New Work", y = y[i]) + theme_tufte() 
  ggsave(paste0("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/individual_basic_plots/corr_sh_base_tit_x_",y[i],".jpeg"),plot=p)
  setnames(census_sample_1930_individual_data,c("v_plot"),y[i])
}

```

# 3. General Regressions

- Individual level regression with:
  - Individual level variables
    - binary variables: "urban","farm","classwkr" (--> create new variable; cat 1 is self-employed and 2 wk for wages) "ownershp","male","lit","mig_us","mig_ab","m_mig_us","m_mig_ab","f_mig_us","f_mig_ab" (exclude and include father/mother variables)
    - Non-binary variables: famsize, age 
    - Dummies from categorical variables: marst, race
    - industry: main and specific ---> Create dummy variables
    - occ: main and specific(??this doesn't make much sense) ---> Create dummy variables
  
  - Location variables: used as fixed effects...



creating dummies: results <- fastDummies::dummy_cols(fastDummies_example, remove_first_dummy = TRUE)

## 3.1. Creating dummy variables
```{r}
# Change categorical variables to factors
# Note: - using factors allows R to easily create dummies
#       - We don't change binary variables, as they are already interpreted as Dummy variables  
cols <- c("race","marst","age_main","ind1950_main","occ1950_main")
census_sample_1930_individual_data[,(cols):=lapply(.SD,as.factor),.SDcols=cols]

```

## 3.2. Linking with county level variables for 1930
```{r}
census_sample_1930_agg_countynhg_1910 <- read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1930_agg_countynhg_1910.fst",as.data.table=TRUE)[,!c("sh_base","sh_base_tit","sh_base_titind","sh_red","sh_red_tit","sh_red_titind","statefip")]

census_sample_1930_individual_data <- merge(census_sample_1930_individual_data,census_sample_1930_agg_countynhg_1910,by="countynhg_1910",all.x=TRUE,all.y=FALSE)
```



## 3.3. Regressions
- Variables always to be included: 
  - Individual ones: all except labforce, age_main, ind1950_main, occ1950_main, Mother and Father migration variables
```{r}
# Creating some vectors to be used as part of the regression
occsh_var <- grep("^sh_occ1950_main_[^0]",names(census_sample_1930_individual_data),value=TRUE)
indsh_var <- grep("^sh_ind1950_main_[^0]",names(census_sample_1930_individual_data),value=TRUE)
agesh_var <- grep("^sh_age_main_[^0]",names(census_sample_1930_individual_data),value=TRUE)
racesh_var <- grep("^sh_race_[^1]",names(census_sample_1930_individual_data),value=TRUE)
marstsh_var <- grep("^sh_marst_[^1]",names(census_sample_1930_individual_data),value=TRUE)

base <- paste0(c("male","urban","farm","ownershp","lit","marst","race","classwkr","mig_us","mig_ab"),collapse=" + ")
parents_mig <- paste0(c("m_mig_us","m_mig_ab","f_mig_us","f_mig_ab"),collapse=" + ")
sh_base <- paste0(c("sh_lit","sh_urban","sh_farm","sh_ownershp","sh_unemp","sh_wrkwage","sh_mig_us","sh_mig_ab"),collapse=" + ")
sh_parents_mig <- paste0(c("sh_m_mig_us","sh_m_mig_ab","sh_f_mig_us","sh_f_mig_ab"),collapse=" + ")


# Creating RHS of the regression
form1_1 <- paste("age_main + ",paste0(base,collapse=" + "))
form1_2 <- paste("age_main + ind1950_main + ",paste0(base,collapse=" + "))
form1_3 <- paste("age_main + occ1950_main + ",paste0(base,collapse=" + "))
form1_4 <- paste("age_main + ind1950_main + occ1950_main + ",paste0(base,collapse=" + "))
form1_5 <- paste("age_main + ",paste0(base,collapse=" + ")," + ",paste0(parents_mig,collapse=" + "))
form1_6 <- paste("age_main + ind1950_main + ",paste0(base,collapse=" + ")," + ",paste0(parents_mig,collapse=" + "))
form1_7 <- paste("age_main + occ1950_main + ",paste0(base,collapse=" + ")," + ",paste0(parents_mig,collapse=" + "))
form1_8 <- paste("age_main + ind1950_main + occ1950_main +",paste0(base,collapse=" + ")," + ",paste0(parents_mig,collapse=" + "))

form2_1 <- paste("log(perwt) + ",form1_4," + ",paste0(indsh_var,collapse=" + ")," + ",paste0(occsh_var,collapse=" + "))
form2_2 <- paste("log(perwt) + ",form1_4," + ",paste0(sh_base,collapse=" + ")," + ",paste0(indsh_var,collapse=" + ")," + ",paste0(occsh_var,collapse=" + "))
form2_3 <- paste("log(perwt) + ",form1_4," + ",paste0(sh_base,collapse=" + ")," + ",paste0(indsh_var,collapse=" + ")," + ",paste0(occsh_var,collapse=" + ")," + ",paste0(agesh_var,collapse=" + ")," + ",paste0(racesh_var,collapse=" + ")," + ",paste0(marstsh_var,collapse=" + "))
form2_4 <- paste("log(perwt) + ",form1_4," + ",paste0(sh_base,collapse=" + ")," + ",paste0(indsh_var,collapse=" + ")," + ",paste0(occsh_var,collapse=" + ")," + ",paste0(agesh_var,collapse=" + ")," + ",paste0(racesh_var,collapse=" + ")," + ",paste0(marstsh_var,collapse=" + ")," + ",paste0(sh_parents_mig,collapse=" + "))
form2_5 <- paste("log(perwt) + ",form1_8," + ",paste0(indsh_var,collapse=" + ")," + ",paste0(occsh_var,collapse=" + "))
form2_6 <- paste("log(perwt) + ",form1_8," + ",paste0(sh_base,collapse=" + ")," + ",paste0(indsh_var,collapse=" + ")," + ",paste0(occsh_var,collapse=" + "))
form2_7 <- paste("log(perwt) + ",form1_8," + ",paste0(sh_base,collapse=" + ")," + ",paste0(indsh_var,collapse=" + ")," + ",paste0(occsh_var,collapse=" + ")," + ",paste0(agesh_var,collapse=" + ")," + ",paste0(racesh_var,collapse=" + ")," + ",paste0(marstsh_var,collapse=" + "))
form2_8 <- paste("log(perwt) + ",form1_8," + ",paste0(sh_base,collapse=" + ")," + ",paste0(indsh_var,collapse=" + ")," + ",paste0(occsh_var,collapse=" + ")," + ",paste0(agesh_var,collapse=" + ")," + ",paste0(racesh_var,collapse=" + ")," + ",paste0(marstsh_var,collapse=" + ")," + ",paste0(sh_parents_mig,collapse=" + "))


# Creating and storing all the different models
model <- vector(mode = "list", length = 2)
model[[1]] <- vector(mode = "list", length = 8)
model[[2]] <- vector(mode = "list", length = 8)
model_fe_statefip <- model
for (i in 1:2) {
  for (j in 1:8) {
    f <- eval(parse(text=paste0("form",i,"_",j)))
    a <- as.formula(paste0("sh_red_tit ~ ",f))
    #model[[i]][[j]] <- lm(a,data=census_sample_1930_individual_data,weights=perwt_ID)
    A <- summary(lm(a,data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0],weights=perwt_ID,model=FALSE))
    A$weights <- A$residuals <- A$na.action <- NULL
    model[[i]][[j]] <- A
    rm(A)
    
    A <- summary(plm(a,data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0],weights=perwt_ID,
                     index = c("statefip"), 
                    model = "within")
                 
                 )
    A$weights <- A$residuals <- A$na.action <- A$model <- NULL
    model_fe_statefip[[i]][[j]] <- A
    rm(A)
  }
}
 
plot_coefs(model[[2]][[8]], scale = FALSE,legend.title = "") + theme_tufte()
# plot_coefs can't work with class= summary.plm


```


# 4. Regressions following Lin (2011) - At the countynhg_1910 level
## 4.0 Erase workspace and call packages
```{r}
rm(list=setdiff(ls(all.names = TRUE), "f_load_pk"))
f_load_pk()
```


## 4.1. Call individual level data
```{r}
census_sample_1930_individual_data <-read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1930_individual_data.fst",as.data.table=TRUE)
```

## 4.2. Creating dummy variables
```{r}
# Change categorical variables to factors
# Note: - using factors allows R to easily create dummies
#       - We don't change binary variables, as they are already interpreted as Dummy variables  
cols <- c("race","marst","age_main","ind1950_main","occ1950_main")
census_sample_1930_individual_data[,(cols):=lapply(.SD,as.factor),.SDcols=cols]

```

## 4.3. Linking with county level variables
### 1920
```{r}
temp <- read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1920_agg_countynhg_1910.fst",as.data.table=TRUE)[,!c("statefip","sh_age_main_0","sh_age_main_1","sh_age_main_2","sh_age_main_3","sh_age_main_4","sh_age_main_5","sh_age_main_6","sh_age_main_7","sh_m_mig_us","sh_m_mig_ab","sh_f_mig_us","sh_f_mig_ab","sh_marst_1","sh_marst_2","sh_marst_3","sh_ownershp","sh_labforce_cl")][,new_sec_all:=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_606+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816]
setorder(temp,-new_sec_all)
temp[,rank_new_sec:=1:.N][,new_sec_all:=NULL]

col <- names(temp[,!c("countynhg_1910")])
setnames(temp,col,paste0(col,"_1920"))

census_sample_1930_individual_data <- merge(census_sample_1930_individual_data,temp,by="countynhg_1910",all.x=TRUE,all.y=FALSE)
rm(temp)
```


###1930
```{r}
temp <- read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1930_agg_countynhg_1910.fst",as.data.table=TRUE)[,!c("sh_base","sh_base_tit","sh_base_titind","sh_red","sh_red_tit","sh_red_titind","statefip","sh_age_main_0","sh_age_main_1","sh_age_main_2","sh_age_main_3","sh_age_main_4","sh_age_main_5","sh_age_main_6","sh_age_main_7","sh_m_mig_us","sh_m_mig_ab","sh_f_mig_us","sh_f_mig_ab","sh_marst_1","sh_marst_2","sh_marst_3","sh_ownershp","sh_labforce_cl","sh_labforce")][,new_sec_all:=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_606+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816]
setorder(temp,-new_sec_all)
temp[,rank_new_sec:=1:.N][,new_sec_all:=NULL]

col <- names(temp[,!c("countynhg_1910")])
setnames(temp,col,paste0(col,"_1930"))

census_sample_1930_individual_data <- merge(census_sample_1930_individual_data,temp,by="countynhg_1910",all.x=TRUE,all.y=FALSE)
rm(temp)
```


## 4.4 Creating some variables for regressions
```{r}
# Base
base_individual <- paste0(c("male","lit","marst","race","wwages","mig_us","mig_ab"),collapse=" + ")

# Industry
indsh_var_1920 <- grep("^sh_ind1950_main_[^1]_1920",names(census_sample_1930_individual_data),value=TRUE)
indsh_var_1930 <- grep("^sh_ind1950_main_[^1]_1930",names(census_sample_1930_individual_data),value=TRUE)

# Occupations
occsh_var_1920 <- grep("^sh_occ1950_main_[^0].+_1920",names(census_sample_1930_individual_data),value=TRUE)
occsh_var_1930 <- grep("^sh_occ1950_main_[^0].+_1930",names(census_sample_1930_individual_data),value=TRUE)

```

## 4.5 Create (grouping) share variables
NOTE: Sector ind1950=856 (Radio Broadcasting) didn't exist in 1920
```{r}
census_sample_1930_individual_data <- census_sample_1930_individual_data[,`:=`(new_sec_all_1920=sh_new_sector_ind1950_376_1920+sh_new_sector_ind1950_377_1920+sh_new_sector_ind1950_606_1920+sh_new_sector_ind1950_668_1920+sh_new_sector_ind1950_816_1920,new_sec_all_1930=sh_new_sector_ind1950_376_1930+sh_new_sector_ind1950_377_1930+sh_new_sector_ind1950_606_1930+sh_new_sector_ind1950_668_1930+sh_new_sector_ind1950_816_1930+sh_new_sector_ind1950_856_1930)][,`:=`(new_sec_main_1920=sh_new_sector_ind1950_376_1920+sh_new_sector_ind1950_377_1920,new_sec_main_1930=sh_new_sector_ind1950_376_1930+sh_new_sector_ind1950_377_1930+sh_new_sector_ind1950_856_1930)][,`:=`(new_sec_serv_1920=sh_new_sector_ind1950_606_1920+sh_new_sector_ind1950_668_1920+sh_new_sector_ind1950_816_1920,new_sec_serv_1930=sh_new_sector_ind1950_606_1930+sh_new_sector_ind1950_668_1930+sh_new_sector_ind1950_816_1930)]

```


## 4.5. First stage regression (following Lin (2011))
```{r}
#???????
```

## 4.6. Basic histogram and map
```{r}
new_sectors_countynhg_1910 <- census_sample_1930_individual_data[,.SD[1],by=c("countynhg_1910"),.SDcols=c("perwt_1920","new_sec_all_1920","new_sec_main_1920","new_sec_serv_1920","perwt_1930","new_sec_all_1930","new_sec_main_1930","new_sec_serv_1930","rank_new_sec_1920","rank_new_sec_1930")]
```

### Histogram
```{r}
p <- vector(mode = "list")
# 1920
p[[1]] <- ggplot(new_sectors_countynhg_1910[perwt_1920>=10000], aes(x=new_sec_all_1920)) +
  geom_histogram(color="black",bins=40,  aes(y = stat(width*density)),  fill="white") +
  scale_y_continuous(labels = percent_format()) +
  labs(title="",x="Share of New Sector", y = "")  + 
  theme_tufte() + theme(legend.position = "none")
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/histogram_share_new_sec_1920.jpeg",plot=last_plot())

p[[2]] <- ggplot(new_sectors_countynhg_1910[perwt_1930>=10000], aes(x=new_sec_all_1930)) +
  geom_histogram(color="black",bins=40,  aes(y = stat(width*density)),fill="white") +
  scale_y_continuous(labels = percent_format()) +
  labs(title="",x="Share of New Sector", y = "")  + 
  theme_tufte() + theme(legend.position = "none")

ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/histogram_share_new_sec_1930.jpeg",plot=last_plot())

# Excluding counties with the highest share of new sectors
j <- 3
for (i in c(3,5,10,20,50,100,200)) {
  p[[j]] <- ggplot(new_sectors_countynhg_1910[perwt_1920>=10000 & rank_new_sec_1920>=i], aes(x=new_sec_all_1920)) +
    geom_histogram(color="black",bins=40,  aes(y = stat(width*density)),  fill="white") +
    scale_y_continuous(labels = percent_format()) +
    labs(title="",x="Share of New Sector", y = "")  + 
    theme_tufte() + theme(legend.position = "none")
  p[[j+1]] <- ggplot(new_sectors_countynhg_1910[perwt_1930>=10000 & rank_new_sec_1930>=i], aes(x=new_sec_all_1930)) +
    geom_histogram(color="black",bins=40,  aes(y = stat(width*density)),  fill="white") +
    scale_y_continuous(labels = percent_format()) +
    labs(title="",x="Share of New Sector", y = "")  + 
    theme_tufte() + theme(legend.position = "none")
  j <- j+2 
}

ggarrange(p[[1]], p[[3]], p[[5]], p[[7]],
          labels = c("All", "Excl. 2", "Excl. 4", "Excl. 9"),
          ncol = 2, nrow = 2)
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/histogram_share_new_sec_1920_excluding_regions_1.jpeg",plot=last_plot())
ggarrange(p[[9]], p[[11]], p[[13]], p[[15]],
          labels = c("Excl. 19", "Excl. 49", "Excl. 99", "Excl. 199"),
          ncol = 2, nrow = 2)
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/histogram_share_new_sec_1920_excluding_regions_2.jpeg",plot=last_plot())

ggarrange(p[[2]], p[[4]], p[[6]], p[[8]],
          labels = c("All", "Excl. 2", "Excl. 4", "Excl. 9"),
          ncol = 2, nrow = 2)
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/histogram_share_new_sec_1930_excluding_regions_1.jpeg",plot=last_plot())
ggarrange(p[[10]], p[[12]], p[[14]], p[[16]],
          labels = c("Excl. 19", "Excl. 49", "Excl. 99", "Excl. 199"),
          ncol = 2, nrow = 2)
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/histogram_share_new_sec_1930_excluding_regions_2.jpeg",plot=last_plot())


# DELETE LATER - Graphs for presentation
ggarrange(p[[1]], p[[3]], p[[11]], p[[13]],
          labels = c("All", "Excl. 4", "Excl. 49", "Excl. 99"),
          ncol = 2, nrow = 2)
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/histogram_share_new_sec_1920_excluding_regions_3-DELETE.jpeg",plot=last_plot())
ggarrange(p[[2]], p[[4]], p[[12]], p[[14]],
          labels = c("All", "Excl. 4", "Excl. 49", "Excl. 99"),
          ncol = 2, nrow = 2)
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/histogram_share_new_sec_1930_excluding_regions_3-DELETE.jpeg",plot=last_plot())

rm(p)
```
### Map

#### Import and subset shape files
```{r}
# Importing shp file 
# 1 Option
map.cty <- st_read("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/input/shapefiles/shapefile_us_county_1910", quiet = TRUE)


map.state <- st_read("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/input/shapefiles/shapefile_us_state_1910", quiet = TRUE)

if (FALSE) {
# 2 option
map.cty <- read_sf(dsn="/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/input/shapefiles/shapefile_us_county_1910")

# 3 option
# NOTE requires the data_file
map.state <- read_nhgis_sf(
  data_file = "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/input/shapefiles/nhgis0006_csv",
  shape_file = "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/input/shapefiles/nhgis0006_shape.zip"
)
}
#subsetting it and dropping Alaska and Hawaii
map.cty <- subset(map.cty,select=c(GISJOIN2,STATENAM,geometry))
map.cty <- subset(map.cty, STATENAM !="Alaska Territory" & STATENAM != "Hawaii Territory")
map.cty$GISJOIN2 <- as.numeric(map.cty$GISJOIN2)
map.state <- subset(map.state,select=c(GISJOIN2,STATENAM,geometry))
map.state <- subset(map.state, STATENAM !="Alaska Territory" & STATENAM != "Hawaii Territory")

```

#### Join with info for share of new sector

##### countynhg_1910
```{r}
#1920
setnames(new_sectors_countynhg_1910,c("countynhg_1910"),c("GISJOIN2"))
map.countynhg_1910 <- merge(map.cty,new_sectors_countynhg_1910,by="GISJOIN2",all.x=TRUE,all.y=FALSE)
county <- tm_shape(subset(map.countynhg_1910)) + tm_polygons("new_sec_all_1920",style = "pretty", n=10,lwd=0) +
  tm_shape(map.state) + tm_borders(alpha=0.1,lwd=0.5)
tmap_save(county, "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Maps/sh_new_sector_all_countynhg_1910.jpeg")
rm(county)

#1930
county <- tm_shape(subset(map.countynhg_1910)) + tm_polygons("new_sec_all_1930",style = "pretty", n=10,lwd=0) +
  tm_shape(map.state) + tm_borders(alpha=0.1,lwd=0.5)
tmap_save(county, "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Maps/sh_new_sector_1930_all_countynhg_1910.jpeg")
rm(county)
```



## 4.7. Regressions
1. base_individual + ind1950_main + sh_lit + log(perwt) + sh_new sectors (3 different cases)
2. base_individual + ind1950_main + sh_lit + log(perwt) + sh_new sectors (3 different cases) + sh_ind1950_main
3. base_individual + ind1950_main + sh_lit + log(perwt) + sh_new sectors (3 different cases) + sh_ind1950_main + sh_occ1950_main


### 4.7.1. Creating the different formulas for the regressions
```{r}
a <- vector(mode = "list", length = 45)

# 1. base_individual + ind1950_main + sh_lit + log(perwt) + sh_new sectors (consider different new_sectors)
## Geof variables Previous year (coef_1 - coef_3)
a[[1]] <- as.formula(paste("sh_red_tit ~ new_sec_all_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main"))
a[[2]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main"))
a[[3]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1920 + new_sec_serv_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main"))

## Geof variables Current year (coef_4 - coef_6)
a[[4]] <- as.formula(paste("sh_red_tit ~ new_sec_all_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main"))
a[[5]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main"))
a[[6]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main"))

## Mix (coef_7 - coef_9)
a[[7]] <- as.formula(paste("sh_red_tit ~ new_sec_all_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main"))
a[[8]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," +age_main + ind1950_main"))
a[[9]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," +age_main + ind1950_main"))
  
# 2. base_individual + ind1950_main + sh_lit + log(perwt) + sh_new sectors (3 different cases) + sh_ind1950_main
## Geof variables Previous year (coef_10 - coef_12)
a[[10]] <- as.formula(paste("sh_red_tit ~ new_sec_all_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main  +",paste0(indsh_var_1920,collapse=" + ")))
a[[11]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main +",paste0(indsh_var_1920,collapse=" + ")))
a[[12]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1920 + new_sec_serv_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main+",paste0(indsh_var_1920,collapse=" + ")))

## Current year (coef_13 - coef_15)
a[[13]] <- as.formula(paste("sh_red_tit ~ new_sec_all_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main+",paste0(indsh_var_1930,collapse=" + ")))
a[[14]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + ",paste0(indsh_var_1930,collapse=" + ")))
a[[15]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + ",paste0(indsh_var_1930,collapse=" + ")))
  
## Mix (coef_16 - coef_18)
a[[16]] <- as.formula(paste("sh_red_tit ~ new_sec_all_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + ",paste0(indsh_var_1920,collapse=" + ")))
a[[17]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," +age_main + ind1950_main + ",paste0(indsh_var_1920,collapse=" + ")))
a[[18]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," +age_main + ind1950_main + ",paste0(indsh_var_1920,collapse=" + ")))


# 3. base_individual + ind1950_main + sh_lit + log(perwt) + sh_new sectors (3 different cases) + sh_ind1950_main + sh_occ1950_main
## Geof variables Previous year (coef_19 - coef_21)
a[[19]] <- as.formula( paste("sh_red_tit ~ new_sec_all_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main  +",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + "))   )
a[[20]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main +",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + ")))
a[[21]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1920 + new_sec_serv_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main+",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + ")))

## Current year (coef_22 - coef_24)
a[[22]] <- as.formula(paste("sh_red_tit ~ new_sec_all_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main+",paste0(indsh_var_1930,collapse=" + ")," + ",paste0(occsh_var_1930,collapse=" + ")))
a[[23]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + ",paste0(indsh_var_1930,collapse=" + ")," + ",paste0(occsh_var_1930,collapse=" + ")))
a[[24]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + ",paste0(indsh_var_1930,collapse=" + ")," + ",paste0(occsh_var_1930,collapse=" + ")))
  
## Mix (coef_25 - coef_27)
a[[25]] <- as.formula(paste("sh_red_tit ~ new_sec_all_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + ",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + ")))
a[[26]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," +age_main + ind1950_main + ",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + ")))
a[[27]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," +age_main + ind1950_main + ",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + ")))

## Regressions with occ1950_main
### 1920 regressors
a[[28]] <- as.formula(paste("sh_red_tit ~ new_sec_all_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main"))
a[[29]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1920 + new_sec_serv_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main"))
a[[30]] <- as.formula(paste("sh_red_tit ~ new_sec_all_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1920,collapse=" + ")))
a[[31]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1920 + new_sec_serv_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1920,collapse=" + ")))
a[[32]] <- as.formula( paste("sh_red_tit ~ new_sec_all_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + "))   )
a[[33]] <- as.formula( paste("sh_red_tit ~ new_sec_main_1920 + new_sec_serv_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + "))   )

### 1930 regressors
a[[34]] <- as.formula(paste("sh_red_tit ~ new_sec_all_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main"))
a[[35]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main"))
a[[36]] <- as.formula(paste("sh_red_tit ~ new_sec_all_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1930,collapse=" + ")))
a[[37]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1930,collapse=" + ")))
a[[38]] <- as.formula( paste("sh_red_tit ~ new_sec_all_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1930,collapse=" + ")," + ",paste0(occsh_var_1930,collapse=" + "))   )
a[[39]] <- as.formula( paste("sh_red_tit ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1930,collapse=" + ")," + ",paste0(occsh_var_1930,collapse=" + "))   )

### 1930 new sector, 1920 region variables
a[[40]] <- as.formula(paste("sh_red_tit ~ new_sec_all_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main"))
a[[41]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main"))
a[[42]] <- as.formula(paste("sh_red_tit ~ new_sec_all_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1920,collapse=" + ")))
a[[43]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1920,collapse=" + ")))
a[[44]] <- as.formula( paste("sh_red_tit ~ new_sec_all_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + "))   )
a[[45]] <- as.formula( paste("sh_red_tit ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + "))   )


```

### 4.7.3. Functions related to regressions
##### Function to export results
```{r}
f_reg_results <- function(Regresults,arg_round=4) {
  # NOTES:
  # Regresults: data.table with 5 columns. (1) Name of variables, (2) Regression coefficient, (3) Standard value, (4) T-Value, (5) P_value
  # Arg_round: number of significance digits. 4 bu default
  
  #sig_10 <- qt(p=.1/2,df=arg_df,lower.tail=FALSE)
  #sig_5  <- qt(p=.05/2,df=arg_df,lower.tail=FALSE)
  #sig_1  <- qt(p=.01/2,df=arg_df,lower.tail=FALSE)
  X <- copy(Regresults)
  setnames(X,c(2,3,4,5),c("coef","std","t_value","p_value"))
  X[,coef_star:=ifelse(p_value>0.1,format(round(coef,arg_round),nsmall=2),ifelse(p_value>0.05,paste0(format(round(coef,arg_round),nsmall=2),"*"),ifelse(p_value>0.01,paste0(format(round(coef,arg_round),nsmall=2),"**"),paste0(format(round(coef,arg_round),nsmall=2),"***"))))]
  #coef.J[,coef_star:=ifelse(x==1,paste0(format(round(coef,arg_round),nsmall=2),"***"),ifelse(x==5,paste0(format(round(coef,arg_round),nsmall=2),"**"),ifelse(x==10,paste0(format(round(coef,arg_round),nsmall=2),"*"),format(round(coef,arg_round),nsmall=2))))]
  X[,std_par:=paste0("(",format(round(std,arg_round),nsmall=2),")")]
  return(X)
}
```

##### Function to perform a set of regressions
This function works with methods lm and lm_robust
TO-DO
- Allow the possibility of not specifying weights
- For lm_robust need to specify the possibility of not using clusters
```{r}
f_regressions <- function(arg_formula,arg_data,arg_weights,method,arg_clusters) {
  
  # Note1: There is a conflict if arg_formula is not a list. E.g. if you create a list (LS) but in arg_formula you introduce LS[[i]], the function will try to subset it and that will give an error
  
  # Note2: Instead of copying arg_data I decided to change the names back to their original names at the end of the function.
  
  setnames(arg_data,c(deparse(substitute(arg_weights))),c("arg_w"))
  tic(paste0("Iteration ",1))
  if (method=="lm") {
    A <- summary(lm(arg_formula[[1]],data=arg_data,weights=arg_w,model=FALSE))
    other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(length(A$residuals),A$adj.r.squared),unname(A$fstatistic)))
  } else if (method=="lm_robust") {
    setnames(arg_data,c(deparse(substitute(arg_clusters))),c("arg_cl"))
    A <- summary(lm_robust(arg_formula[[1]],weights=arg_w,clusters=arg_cl,se_type='stata',data=arg_data))
    other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(A$nobs,A$adj.r.squared),unname(A$fstatistic)))
  }
  coef <- f_reg_results( data.table(A$coefficients[,1:4],keep.rownames=TRUE), arg_round=4 )
  coef <- melt(coef,id.vars = c("rn"), measure.vars = c("coef","std","t_value","p_value","coef_star","std_par"),value.name=c(paste0("model_",1)))
  coef <- rbind(coef,other)
  toc()
  rm(A,other)
  
  if (length(arg_formula)>1) {
    for (i in 2:length(arg_formula)) {
      tic(paste0("Iteration ",i))
      if (method=="lm") {
        A <- summary(lm(arg_formula[[i]],data=arg_data,weights=arg_w,model=FALSE))
        other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(length(A$residuals),A$adj.r.squared),unname(A$fstatistic)))
        setnames(other,c(3),c(paste0("model_",i)))
      } else if (method=="lm_robust") {
        A <- summary(lm_robust(arg_formula[[i]],weights=arg_w,clusters=arg_cl,se_type='stata',data=arg_data))
        other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(A$nobs,A$adj.r.squared),unname(A$fstatistic)))
        setnames(other,c(3),c(paste0("model_",i)))
      }
      
      t <- f_reg_results( data.table(A$coefficients[,1:4],keep.rownames=TRUE), arg_round=4)
      t <- melt(t,id.vars = c("rn"), measure.vars = c("coef","std","t_value","p_value","coef_star","std_par"),value.name=c(paste0("model_",i)))
      t <- rbind(t,other)
      coef <- merge(coef,t,by=c("rn","variable"),all=TRUE)
      rm(A,other,t)
      toc()
    }
  
  }
  coef <- as.data.table(coef)
  coef[,order:=ifelse(variable=="zother",1,0)]
  setorder(coef,order,rn)
  coef[,order:=NULL]
  
  setnames(arg_data, c("arg_w"), c(deparse(substitute(arg_weights))) )
  if (method=="lm_robust") {
    setnames(arg_data,c("arg_cl"),c(deparse(substitute(arg_clusters))))
  }
  return(coef)
}

```

### 4.7.4. Regressions

#### 4.7.4.1. Main Regressions
```{r}
#### No cluster, no drop
coef.J <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930 > 10000],arg_weights=perwt_ID,method="lm",arg_clusters=occind)

#### No cluster, drop
coef.J.drop <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,606,668,816,856))],arg_weights=perwt_ID,method="lm",arg_clusters=occind)

#### Cluster, no drop
coef.J.cluster <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930 > 10000],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

#### Cluster, drop
coef.J.cluster.drop <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,606,668,816,856))],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)
```


#### Saving results
```{r}
wrapper_Excel <- function(list_table,list_name,output) {
  t <- createWorkbook()
  for (i in 1:length(list_table)) {
    addWorksheet(t, list_name[[i]])
    writeData(t, list_name[[i]],list_table[[i]])
  }
  saveWorkbook(t, output,overwrite=TRUE)
}

# All the coefficients
list_name <- list("No_cluster_No_drop","No_cluster_Drop","Cluster_No_drop","Cluster_Drop")
list_table <- list(coef.J[variable=="coef_star" | variable =="std_par" | variable=="zother"],coef.J.drop[variable=="coef_star" | variable =="std_par" | variable=="zother"],coef.J.cluster[variable=="coef_star" | variable =="std_par" |variable=="zother"],coef.J.cluster.drop[variable=="coef_star" | variable =="std_par" | variable=="zother"])

wrapper_Excel(list_table,list_name,"/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Tables/individual_regression_1930_countynhg_1910.xlsx")

# 1920 Regressors
## Region coefficients, New sector Main
wrapper_Excel(list(coef.J.cluster[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))],coef.J.cluster.drop[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))]),
              list("Cluster_No_drop","Cluster_Drop"),
              "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Tables/ind_reg_1930_ctynhg_1910_New_Sector_reg_1920.xlsx")

## Region coefficients, New sector Serv and Main
wrapper_Excel(list(coef.J.cluster[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))],coef.J.cluster.drop[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))]),
              list("Cluster_No_drop","Cluster_Drop"),
              "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Tables/ind_reg_1930_ctynhg_1910_New_Main_Serv_reg_1920.xlsx")

# 1930 Regressors
## Region coefficients, New sector Main
wrapper_Excel(list(coef.J.cluster[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))],coef.J.cluster.drop[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))]),
              list("Cluster_No_drop","Cluster_Drop"),
              "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Tables/ind_reg_1930_ctynhg_1910_New_Sector_reg_1930.xlsx")

## Region coefficients, New sector Serv and Main
wrapper_Excel(list(coef.J.cluster[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))],coef.J.cluster.drop[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))]),
              list("Cluster_No_drop","Cluster_Drop"),
              "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Tables/ind_reg_1930_ctynhg_1910_New_Main_Serv_reg_1930.xlsx")

# 1930 New Sec, 1920 rest
## Region coefficients, New sector Main
wrapper_Excel(list(coef.J.cluster[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))],coef.J.cluster.drop[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))]),
              list("Cluster_No_drop","Cluster_Drop"),
              "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Tables/ind_reg_1930_ctynhg_1910_New_Sector_reg_mix.xlsx")

## Region coefficients, New sector Serv and Main
wrapper_Excel(list(coef.J.cluster[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))],coef.J.cluster.drop[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))]),
              list("Cluster_No_drop","Cluster_Drop"),
              "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Tables/ind_reg_1930_ctynhg_1910_New_Main_Serv_reg_mix.xlsx")


```

#### 4.7.4.2 Robustness Regressions
```{r}
# Excluding regions with the highest shares of New Sectors
## 2
coef.J.cluster.drop.excluding_2 <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0  & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,606,668,816,856))   &   rank_new_sec_1920>=3],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

## 4
coef.J.cluster.drop.excluding_4 <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,606,668,816,856))   &   rank_new_sec_1920>=5],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

## 9
coef.J.cluster.drop.excluding_9 <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,606,668,816,856))   &   rank_new_sec_1920>=10],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

## 19
coef.J.cluster.drop.excluding_19 <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,606,668,816,856))   &   rank_new_sec_1920>=20],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

## 49
coef.J.cluster.drop.excluding_49 <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,606,668,816,856))   &   rank_new_sec_1920>=50],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

## 99
coef.J.cluster.drop.excluding_99 <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,606,668,816,856))   &   rank_new_sec_1920>=100],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

## 199
coef.J.cluster.drop.excluding_199 <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,606,668,816,856))   &   rank_new_sec_1920>=200],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

```

##### Saving results
```{r}
if (!exists("wrapper_Excel")) {
wrapper_Excel <- function(list_table,list_name,output) {
  t <- createWorkbook()
  for (i in 1:length(list_table)) {
    addWorksheet(t, list_name[[i]])
    writeData(t, list_name[[i]],list_table[[i]])
  }
  saveWorkbook(t, output,overwrite=TRUE)
}
}
# 1920 Regressors
## Region coefficients, New sector Main
wrapper_Excel(list(
                    coef.J.cluster.drop.excluding_2[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))],
                    coef.J.cluster.drop.excluding_4[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))],
                    coef.J.cluster.drop.excluding_9[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_9$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_9$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))],
                    coef.J.cluster.drop.excluding_19[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_19$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_19$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))],
                    coef.J.cluster.drop.excluding_49[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))],
                    coef.J.cluster.drop.excluding_99[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))],
                    coef.J.cluster.drop.excluding_199[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))]),
              list("Cluster_Drop_Ex_2","Cluster_Drop_Ex_4","Cluster_Drop_Ex_9","Cluster_Drop_Ex_19","Cluster_Drop_Ex_49","Cluster_Drop_Ex_99","Cluster_Drop_Ex_199"),
              "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Tables/ind_reg_1930_ctynhg_1910_New_Sector_reg_1920_exclus.xlsx")

## Region coefficients, New sector Serv and Main
wrapper_Excel(list(
                  coef.J.cluster.drop.excluding_2[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))],
                  coef.J.cluster.drop.excluding_4[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))],
                  coef.J.cluster.drop.excluding_9[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_9$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_9$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))],
                  coef.J.cluster.drop.excluding_19[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_19$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_19$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))],
                  coef.J.cluster.drop.excluding_49[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))],
                  coef.J.cluster.drop.excluding_99[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))],
                  coef.J.cluster.drop.excluding_199[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))]),
              list("Cluster_Drop_Ex_2","Cluster_Drop_Ex_4","Cluster_Drop_Ex_9","Cluster_Drop_Ex_19","Cluster_Drop_Ex_49","Cluster_Drop_Ex_99","Cluster_Drop_Ex_199"),
              "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Tables/ind_reg_1930_ctynhg_1910_New_Main_Serv_reg_1920_exclus.xlsx")

# 1930 Regressors
## Region coefficients, New sector Main
wrapper_Excel(list(
                  coef.J.cluster.drop.excluding_2[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))],
                  coef.J.cluster.drop.excluding_4[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))],
                  coef.J.cluster.drop.excluding_9[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_9$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_9$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))],
                  coef.J.cluster.drop.excluding_19[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_19$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_19$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))],
                  coef.J.cluster.drop.excluding_49[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))],
                  coef.J.cluster.drop.excluding_99[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))],
                  coef.J.cluster.drop.excluding_199[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))]),
              list("Cluster_Drop_Ex_2","Cluster_Drop_Ex_4","Cluster_Drop_Ex_9","Cluster_Drop_Ex_19","Cluster_Drop_Ex_49","Cluster_Drop_Ex_99","Cluster_Drop_Ex_199"),
              "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Tables/ind_reg_1930_ctynhg_1910_New_Sector_reg_1930_exclus.xlsx")

## Region coefficients, New sector Serv and Main
wrapper_Excel(list(
                  coef.J.cluster.drop.excluding_2[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))],
                  coef.J.cluster.drop.excluding_4[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))],
                  coef.J.cluster.drop.excluding_9[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))],
                  coef.J.cluster.drop.excluding_19[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))],
                  coef.J.cluster.drop.excluding_49[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))],
                  coef.J.cluster.drop.excluding_99[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))],
                  coef.J.cluster.drop.excluding_199[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))]),
              list("Cluster_Drop_Ex_2","Cluster_Drop_Ex_4","Cluster_Drop_Ex_9","Cluster_Drop_Ex_19","Cluster_Drop_Ex_49","Cluster_Drop_Ex_99","Cluster_Drop_Ex_199"),
              "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Tables/ind_reg_1930_ctynhg_1910_New_Main_Serv_reg_1930_exclus.xlsx")

# 1930 New Sec, 1920 rest
## Region coefficients, New sector Main
wrapper_Excel(list(
                  coef.J.cluster.drop.excluding_2[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))],
                  coef.J.cluster.drop.excluding_4[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))],
                  coef.J.cluster.drop.excluding_9[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))],
                  coef.J.cluster.drop.excluding_19[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))],
                  coef.J.cluster.drop.excluding_49[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))],
                  coef.J.cluster.drop.excluding_99[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))],
                  coef.J.cluster.drop.excluding_199[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))]),
              list("Cluster_Drop_Ex_2","Cluster_Drop_Ex_4","Cluster_Drop_Ex_9","Cluster_Drop_Ex_19","Cluster_Drop_Ex_49","Cluster_Drop_Ex_99","Cluster_Drop_Ex_199"),
              "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Tables/ind_reg_1930_ctynhg_1910_New_Sector_reg_mix_exclus.xlsx")

## Region coefficients, New sector Serv and Main
wrapper_Excel(list(
                  coef.J.cluster.drop.excluding_2[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))],
                  coef.J.cluster.drop.excluding_4[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))],
                  coef.J.cluster.drop.excluding_9[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))],
                  coef.J.cluster.drop.excluding_19[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))],
                  coef.J.cluster.drop.excluding_49[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))],
                  coef.J.cluster.drop.excluding_99[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))],
                  coef.J.cluster.drop.excluding_199[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))]),
              list("Cluster_Drop_Ex_2","Cluster_Drop_Ex_4","Cluster_Drop_Ex_9","Cluster_Drop_Ex_19","Cluster_Drop_Ex_49","Cluster_Drop_Ex_99","Cluster_Drop_Ex_199"),
              "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Tables/ind_reg_1930_ctynhg_1910_New_Main_Serv_reg_mix_exclus.xlsx")
```


#### 4.7.4.3. TOOOO ANALYZE and IMPROVE Regression excluding additional sectors
```{r}
#### No cluster, no drop
coef.J.cluster.drop <- f_regressions (arg_formula=a[c(1,10,19,3,12,21)],arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,606,556,667,668,816,856))],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

#### Excluding 4
coef.J.cluster.drop_excl_4 <- f_regressions (arg_formula=a[c(1,10,19,3,12,21)],arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,606,556,667,668,816,856))   &   rank_new_sec_1920>=5],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

#### Excluding 49
coef.J.cluster.drop_excl_49 <- f_regressions (arg_formula=a[c(1,10,19,3,12,21)],arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,606,556,667,668,816,856))   &   rank_new_sec_1920>=50],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

#### Excluding 99
coef.J.cluster.drop_excl_99 <- f_regressions (arg_formula=a[c(1,10,19,3,12,21)],arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,606,556,667,668,816,856))   &   rank_new_sec_1920>=100],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)


#### No cluster, no drop
coef.J.cluster.drop_initial <- f_regressions (arg_formula=a[c(1,10,19,3,12,21)],arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,606,668,816,856))],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

#### Excluding 4
coef.J.cluster.drop_intial_excl_4 <- f_regressions (arg_formula=a[c(1,10,19,3,12,21)],arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,606,668,816,856))   &   rank_new_sec_1920>=5],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)


```


# 5. Regressions following Lin (2011) - At the metarea_1940 level

## 5.0 Erase workspace and call packages
```{r}
rm(list=setdiff(ls(all.names = TRUE), "f_load_pk"))
f_load_pk()
```


## 5.1. Call individual level data
```{r}
census_sample_1930_individual_data <-read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1930_individual_data.fst",as.data.table=TRUE)
```

## 5.2. Creating dummy variables
```{r}
# Change categorical variables to factors
# Note: - using factors allows R to easily create dummies
#       - We don't change binary variables, as they are already interpreted as Dummy variables  
cols <- c("race","marst","age_main","ind1950_main","occ1950_main")
census_sample_1930_individual_data[,(cols):=lapply(.SD,as.factor),.SDcols=cols]

```

## 5.3. Linking with metarea level variables
### 1920
```{r}
temp <- read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1920_agg_metarea_1940.fst",as.data.table=TRUE)[,!c("statefip","sh_age_main_0","sh_age_main_1","sh_age_main_2","sh_age_main_3","sh_age_main_4","sh_age_main_5","sh_age_main_6","sh_age_main_7","sh_m_mig_us","sh_m_mig_ab","sh_f_mig_us","sh_f_mig_ab","sh_marst_1","sh_marst_2","sh_marst_3","sh_ownershp","sh_labforce_cl","sh_base","sh_base_tit","sh_base_titind","sh_red","sh_red_tit","sh_red_titind")][,new_sec_all:=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_606+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816]
setorder(temp,-new_sec_all)
temp[,rank_new_sec:=1:.N][,new_sec_all:=NULL]

col <- names(temp[,!c("metarea_1940")])
setnames(temp,col,paste0(col,"_1920"))

census_sample_1930_individual_data <- merge(census_sample_1930_individual_data,temp,by="metarea_1940",all.x=TRUE,all.y=FALSE)

rm(temp)
```


###1930
```{r}
temp <- read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1930_agg_metarea_1940.fst",as.data.table=TRUE)[,!c("sh_base","sh_base_tit","sh_base_titind","sh_red","sh_red_tit","sh_red_titind","statefip","sh_age_main_0","sh_age_main_1","sh_age_main_2","sh_age_main_3","sh_age_main_4","sh_age_main_5","sh_age_main_6","sh_age_main_7","sh_m_mig_us","sh_m_mig_ab","sh_f_mig_us","sh_f_mig_ab","sh_marst_1","sh_marst_2","sh_marst_3","sh_ownershp","sh_labforce_cl","sh_labforce")][,new_sec_all:=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_606+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816]
setorder(temp,-new_sec_all)
temp[,rank_new_sec:=1:.N][,new_sec_all:=NULL]

col <- names(temp[,!c("metarea_1940")])
setnames(temp,col,paste0(col,"_1930"))

census_sample_1930_individual_data <- merge(census_sample_1930_individual_data,temp,by="metarea_1940",all.x=TRUE,all.y=FALSE)

rm(temp)

```

## 5.4 Creating some variables for regressions
```{r}
# Base
base_individual <- paste0(c("male","lit","marst","race","wwages","mig_us","mig_ab"),collapse=" + ")

# Industry
indsh_var_1920 <- grep("^sh_ind1950_main_[^1]_1920",names(census_sample_1930_individual_data),value=TRUE)
indsh_var_1930 <- grep("^sh_ind1950_main_[^1]_1930",names(census_sample_1930_individual_data),value=TRUE)

# Occupations
occsh_var_1920 <- grep("^sh_occ1950_main_[^0].+_1920",names(census_sample_1930_individual_data),value=TRUE)
occsh_var_1930 <- grep("^sh_occ1950_main_[^0].+_1930",names(census_sample_1930_individual_data),value=TRUE)

```

## 5.5 Create (grouping) share variables
NOTE: Sector ind1950=856 (Radio Broadcasting) didn't exist in 1920
```{r}
census_sample_1930_individual_data <- census_sample_1930_individual_data[,`:=`(new_sec_all_1920=sh_new_sector_ind1950_376_1920+sh_new_sector_ind1950_377_1920+sh_new_sector_ind1950_606_1920+sh_new_sector_ind1950_668_1920+sh_new_sector_ind1950_816_1920,new_sec_all_1930=sh_new_sector_ind1950_376_1930+sh_new_sector_ind1950_377_1930+sh_new_sector_ind1950_606_1930+sh_new_sector_ind1950_668_1930+sh_new_sector_ind1950_816_1930+sh_new_sector_ind1950_856_1930)][,`:=`(new_sec_main_1920=sh_new_sector_ind1950_376_1920+sh_new_sector_ind1950_377_1920,new_sec_main_1930=sh_new_sector_ind1950_376_1930+sh_new_sector_ind1950_377_1930+sh_new_sector_ind1950_856_1930)][,`:=`(new_sec_serv_1920=sh_new_sector_ind1950_606_1920+sh_new_sector_ind1950_668_1920+sh_new_sector_ind1950_816_1920,new_sec_serv_1930=sh_new_sector_ind1950_606_1930+sh_new_sector_ind1950_668_1930+sh_new_sector_ind1950_816_1930)]
```

## 5.6. First stage regression (following Lin (2011))
```{r}
# lists to store regressions
coef.FS <- vector(mode = "list", length = 1)
coef.FS.cluster <- vector(mode = "list", length = 1)
other.FS <- vector(mode = "list", length = 8)
other.FS.cluster <- vector(mode = "list", length = 8)

# 1. Basic + No industry dummies
base_individual <- paste0(c("male","lit","marst","race","wwages","mig_us","mig_ab"),collapse=" + ")
a <- as.formula(paste("sh_red_tit ~ age_main +",paste0(base_individual,collapse=" + ")," + factor(metarea_1940)"))

## Not cluster
A <- summary(lm(a,data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000,c("occ1950_main","ind1950_main","occind","sh_red_tit","age_main","metarea_1940","male","lit","marst","race","wwages","mig_us","mig_ab")],model=FALSE))
coef.FS[[1]] <- data.table(A$coefficients[,1:3],keep.rownames=TRUE)
setnames(coef.FS[[1]],c(2,3,4),c("coef_1","std_1","t-value_1"))
other.FS[[1]] <- list(observations = A$nobs,adj.r.squared = A$adj.r.squared,fstatistic = A$fstatistic)
rm(A)

## Cluster
# ***NOTE: We still need to perform the hypothesis testing of the metarea dummies. One possible way is using linear_hypothesis. lh_robust is a wrapper for this one
A <- summary(lm_robust(a,clusters = occind, se_type = 'stata',data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000,c("occ1950_main","ind1950_main","occind","sh_red_tit","age_main","metarea_1940","male","lit","marst","race","wwages","mig_us","mig_ab")]))
coef.FS.cluster[[1]] <- data.table(A$coefficients[,1:3],keep.rownames=TRUE)
setnames(coef.FS.cluster[[1]],c(2,3,4),c("coef_1","std_1","t-value_1"))
(other.FS.cluster[[1]] <- list(observations = A$nobs, adj.r.squared = A$adj.r.squared, fstatistic = A$fstatistic))
rm(A)

# 2. Basic + Industry dummies
a <- as.formula(paste("sh_red_tit ~ age_main +",paste0(base_individual,collapse=" + "),"+ ind1950_main + factor(metarea_1940)"))

## Not cluster
A <- summary(lm(a,data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000,c("occ1950_main","ind1950_main","occind","sh_red_tit","age_main","metarea_1940","male","lit","marst","race","wwages","mig_us","mig_ab")],model=FALSE))
#(coef.FS[[2]] <- A$coefficients)
#(other.FS[[2]] <- list(observations = A$nobs,adj.r.squared = A$adj.r.squared,fstatistic = A$fstatistic))
t <- data.table(A$coefficients[,1:3],keep.rownames=TRUE)
setnames(t,c(2,3,4),c("coef_2","std_2","t-value_2"))
coef.FS[[1]] <- merge(coef.FS[[1]],t,by="rn",all=TRUE)
other.FS[[1]] <- list(observations = A$nobs,adj.r.squared = A$adj.r.squared,fstatistic = A$fstatistic)
rm(A,t)

## Cluster
# ***NOTE: We still need to perform the hypothesis testing of the metarea dummies. One possible way is using linear_hypothesis. lh_robust is a wrapper for this one
A <- summary(lm_robust(a,clusters = occind, se_type = 'stata',data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000,c("occ1950_main","ind1950_main","occind","sh_red_tit","age_main","metarea_1940","male","lit","marst","race","wwages","mig_us","mig_ab")]))
t <- data.table(A$coefficients[,1:3],keep.rownames=TRUE)
setnames(t,c(2,3,4),c("coef_2","std_2","t-value_2"))
coef.FS.cluster[[1]] <- merge(coef.FS.cluster[[1]],t,by="rn",all=TRUE)
(other.FS.cluster[[2]] <- list(observations = A$nobs, adj.r.squared = A$adj.r.squared, fstatistic = A$fstatistic))
rm(A,t)

# 3. Basic + Industry dummies + additional individual level variable
other_individual <- paste0(c("urban","famsize","ownershp"),collapse=" + ")
a <- as.formula(paste("sh_red_tit ~ age_main +",paste0(base_individual,collapse=" + ")," + ",paste0(other_individual,collapse=" + "),"+ ind1950_main + factor(metarea_1940)"))

## Not cluster
A <- summary(lm(a,data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000,c("occ1950_main","ind1950_main","occind","sh_red_tit","age_main","metarea_1940","male","lit","marst","race","wwages","mig_us","mig_ab","urban","famsize","ownershp")],model=FALSE))
t <- data.table(A$coefficients[,1:3],keep.rownames=TRUE)
setnames(t,c(2,3,4),c("coef_3","std_3","t-value_3"))
coef.FS[[1]] <- merge(coef.FS[[1]],t,by="rn",all=TRUE)
(other.FS[[3]] <- list(observations = A$nobs,adj.r.squared = A$adj.r.squared,fstatistic = A$fstatistic))

## Cluster
# ***NOTE: We still need to perform the hypothesis testing of the metarea dummies. One possible way is using linear_hypothesis. lh_robust is a wrapper for this one
A <- summary(lm_robust(a,clusters = occind, se_type = 'stata',data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000,c("occ1950_main","ind1950_main","occind","sh_red_tit","age_main","metarea_1940","male","lit","marst","race","wwages","mig_us","mig_ab","urban","famsize","ownershp")]))
t <- data.table(A$coefficients[,1:3],keep.rownames=TRUE)
setnames(t,c(2,3,4),c("coef_3","std_3","t-value_3"))
coef.FS.cluster[[1]] <- merge(coef.FS.cluster[[1]],t,by="rn",all=TRUE)
other.FS.cluster[[3]] <- list(observations = A$nobs, adj.r.squared = A$adj.r.squared, fstatistic = A$fstatistic)

# 4. Basic + Industry dummies + additional individual level variable + father/mother migration
migration_individual <- paste0(c("m_mig_us","m_mig_ab","f_mig_us","f_mig_ab"),collapse=" + ")
a <- as.formula(paste("sh_red_tit ~ age_main +",paste0(base_individual,collapse=" + ")," + ",paste0(other_individual,collapse=" + ")," + ",paste0(migration_individual,collapse=" + "),"+ ind1950_main + factor(metarea_1940)"))

## Not cluster
A <- summary(lm(a,data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000,c("occ1950_main","ind1950_main","occind","sh_red_tit","age_main","metarea_1940","male","lit","marst","race","wwages","mig_us","mig_ab","urban","famsize","ownershp","m_mig_us","m_mig_ab","f_mig_us","f_mig_ab")],model=FALSE))
t <- data.table(A$coefficients[,1:3],keep.rownames=TRUE)
setnames(t,c(2,3,4),c("coef_4","std_4","t-value_4"))
coef.FS[[1]] <- merge(coef.FS[[1]],t,by="rn",all=TRUE)
(other.FS[[4]] <- list(observations = A$nobs,adj.r.squared = A$adj.r.squared,fstatistic = A$fstatistic))

## Cluster
# ***NOTE: We still need to perform the hypothesis testing of the metarea dummies. One possible way is using linear_hypothesis. lh_robust is a wrapper for this one
A <- summary(lm_robust(a,clusters = occind, se_type = 'stata',data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000,c("occ1950_main","ind1950_main","occind","sh_red_tit","age_main","metarea_1940","male","lit","marst","race","wwages","mig_us","mig_ab","urban","famsize","ownershp","m_mig_us","m_mig_ab","f_mig_us","f_mig_ab")]))
t <- data.table(A$coefficients[,1:3],keep.rownames=TRUE)
setnames(t,c(2,3,4),c("coef_4","std_4","t-value_4"))
coef.FS.cluster[[1]] <- merge(coef.FS.cluster[[1]],t,by="rn",all=TRUE)
(other.FS.cluster[[4]] <- list(observations = A$nobs, adj.r.squared = A$adj.r.squared, fstatistic = A$fstatistic))

```


### 5.7. Basic histogram and map with information about new sectors
```{r}
new_sectors_metarea_1940 <- census_sample_1930_individual_data[,.SD[1],by=c("metarea_1940"),.SDcols=c("perwt_1920","new_sec_all_1920","new_sec_main_1920","new_sec_serv_1920","perwt_1930","new_sec_all_1930","new_sec_main_1930","new_sec_serv_1930","rank_new_sec_1920","rank_new_sec_1930")]
```

#### Histogram
```{r}
p <- vector(mode = "list")
# 1920
p[[1]] <- ggplot(new_sectors_metarea_1940[perwt_1920>=10000], aes(x=new_sec_all_1920)) +
  geom_histogram(color="black",bins=40,  aes(y = stat(width*density)),  fill="white") +
  scale_y_continuous(labels = percent_format()) +
  labs(title="",x="Share of New Sector", y = "")  + 
  theme_tufte() + theme(legend.position = "none")
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/histogram_share_new_sec_1920.jpeg",plot=last_plot())

p[[2]] <- ggplot(new_sectors_metarea_1940[perwt_1930>=10000], aes(x=new_sec_all_1930)) +
  geom_histogram(color="black",bins=40,  aes(y = stat(width*density)),fill="white") +
  scale_y_continuous(labels = percent_format()) +
  labs(title="",x="Share of New Sector", y = "")  + 
  theme_tufte() + theme(legend.position = "none")

ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/histogram_share_new_sec_1930.jpeg",plot=last_plot())

# Excluding counties with the highest share of new sectors
j <- 3
for (i in c(3,5,10)) {
  p[[j]] <- ggplot(new_sectors_metarea_1940[perwt_1920>=10000 & rank_new_sec_1920>=i], aes(x=new_sec_all_1920)) +
    geom_histogram(color="black",bins=40,  aes(y = stat(width*density)),  fill="white") +
    scale_y_continuous(labels = percent_format()) +
    labs(title="",x="Share of New Sector", y = "")  + 
    theme_tufte() + theme(legend.position = "none")
  p[[j+1]] <- ggplot(new_sectors_metarea_1940[perwt_1930>=10000 & rank_new_sec_1930>=i], aes(x=new_sec_all_1930)) +
    geom_histogram(color="black",bins=40,  aes(y = stat(width*density)),  fill="white") +
    scale_y_continuous(labels = percent_format()) +
    labs(title="",x="Share of New Sector", y = "")  + 
    theme_tufte() + theme(legend.position = "none")
  j <- j+2 
}

ggarrange(p[[1]], p[[3]], p[[5]], p[[7]],
          labels = c("All", "Excl. 2", "Excl. 4", "Excl. 9"),
          ncol = 2, nrow = 2)
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/histogram_share_new_sec_1920_excluding_regions_1.jpeg",plot=last_plot())

ggarrange(p[[2]], p[[4]], p[[6]], p[[8]],
          labels = c("All", "Excl. 2", "Excl. 4", "Excl. 9"),
          ncol = 2, nrow = 2)
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/histogram_share_new_sec_1930_excluding_regions_2.jpeg",plot=last_plot())

rm(p)
```

#### Map

##### Import and subset shape files
```{r}
# Importing shp file 
# 1 Option
map.cty <- st_read("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/input/shapefiles/shapefile_us_county_1910", quiet = TRUE)


map.state <- st_read("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/input/shapefiles/shapefile_us_state_1910", quiet = TRUE)

if (FALSE) {
# 2 option
map.cty <- read_sf(dsn="/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/input/shapefiles/shapefile_us_county_1910")

# 3 option
# NOTE requires the data_file
map.state <- read_nhgis_sf(
  data_file = "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/input/shapefiles/nhgis0006_csv",
  shape_file = "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/input/shapefiles/nhgis0006_shape.zip"
)
}
#subsetting it and dropping Alaska and Hawaii
map.cty <- subset(map.cty,select=c(GISJOIN2,STATENAM,geometry))
map.cty <- subset(map.cty, STATENAM !="Alaska Territory" & STATENAM != "Hawaii Territory")
map.cty$GISJOIN2 <- as.numeric(map.cty$GISJOIN2)
map.state <- subset(map.state,select=c(GISJOIN2,STATENAM,geometry))
map.state <- subset(map.state, STATENAM !="Alaska Territory" & STATENAM != "Hawaii Territory")

```

##### Join with info for share of new sector
#### metarea_1940
```{r}
setnames(new_sectors_metarea_1940,c("metarea_1940"),c("GISJOIN2"))
map.metarea_1940 <- merge(map.cty,new_sectors_metarea_1940,by="GISJOIN2",all.x=TRUE,all.y=FALSE)

county <- tm_shape(subset(map.metarea_1940)) + tm_polygons("new_sec_all_1920",style = "pretty", n=10,lwd=0) +
  tm_shape(map.state) + tm_borders(alpha=0.1,lwd=0.5)
tmap_save(county, "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Maps/sh_new_sector_1920_all_metarea_1940.jpeg")
rm(county)

county <- tm_shape(subset(map.metarea_1940)) + tm_polygons("new_sec_all_1930",style = "pretty", n=10,lwd=0) +
  tm_shape(map.state) + tm_borders(alpha=0.1,lwd=0.5)
tmap_save(county, "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Maps/sh_new_sector_1930_all_metarea_1940.jpeg")
rm(county)
```



## 5.8. Regressions
1. base_individual + ind1950_main + sh_lit + log(perwt) + sh_new sectors (3 different cases)
2. base_individual + ind1950_main + sh_lit + log(perwt) + sh_new sectors (3 different cases) + sh_ind1950_main
3. base_individual + ind1950_main + sh_lit + log(perwt) + sh_new sectors (3 different cases) + sh_ind1950_main + sh_occ1950_main


### 5.8.1. Creating the different formulas for the regressions
```{r}
a <- vector(mode = "list", length = 45)

# 1. base_individual + ind1950_main + sh_lit + log(perwt) + sh_new sectors (consider different new_sectors)
## Geof variables Previous year (coef_1 - coef_3)
a[[1]] <- as.formula(paste("sh_red_tit ~ new_sec_all_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main"))
a[[2]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main"))
a[[3]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1920 + new_sec_serv_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main"))

## Geof variables Current year (coef_4 - coef_6)
a[[4]] <- as.formula(paste("sh_red_tit ~ new_sec_all_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main"))
a[[5]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main"))
a[[6]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main"))

## Mix (coef_7 - coef_9)
a[[7]] <- as.formula(paste("sh_red_tit ~ new_sec_all_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main"))
a[[8]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," +age_main + ind1950_main"))
a[[9]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," +age_main + ind1950_main"))
  
# 2. base_individual + ind1950_main + sh_lit + log(perwt) + sh_new sectors (3 different cases) + sh_ind1950_main
## Geof variables Previous year (coef_10 - coef_12)
a[[10]] <- as.formula(paste("sh_red_tit ~ new_sec_all_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main  +",paste0(indsh_var_1920,collapse=" + ")))
a[[11]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main +",paste0(indsh_var_1920,collapse=" + ")))
a[[12]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1920 + new_sec_serv_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main+",paste0(indsh_var_1920,collapse=" + ")))

## Current year (coef_13 - coef_15)
a[[13]] <- as.formula(paste("sh_red_tit ~ new_sec_all_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main+",paste0(indsh_var_1930,collapse=" + ")))
a[[14]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + ",paste0(indsh_var_1930,collapse=" + ")))
a[[15]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + ",paste0(indsh_var_1930,collapse=" + ")))
  
## Mix (coef_16 - coef_18)
a[[16]] <- as.formula(paste("sh_red_tit ~ new_sec_all_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + ",paste0(indsh_var_1920,collapse=" + ")))
a[[17]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," +age_main + ind1950_main + ",paste0(indsh_var_1920,collapse=" + ")))
a[[18]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," +age_main + ind1950_main + ",paste0(indsh_var_1920,collapse=" + ")))


# 3. base_individual + ind1950_main + sh_lit + log(perwt) + sh_new sectors (3 different cases) + sh_ind1950_main + sh_occ1950_main
## Geof variables Previous year (coef_19 - coef_21)
a[[19]] <- as.formula( paste("sh_red_tit ~ new_sec_all_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main  +",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + "))   )
a[[20]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main +",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + ")))
a[[21]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1920 + new_sec_serv_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main+",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + ")))

## Current year (coef_22 - coef_24)
a[[22]] <- as.formula(paste("sh_red_tit ~ new_sec_all_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main+",paste0(indsh_var_1930,collapse=" + ")," + ",paste0(occsh_var_1930,collapse=" + ")))
a[[23]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + ",paste0(indsh_var_1930,collapse=" + ")," + ",paste0(occsh_var_1930,collapse=" + ")))
a[[24]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + ",paste0(indsh_var_1930,collapse=" + ")," + ",paste0(occsh_var_1930,collapse=" + ")))
  
## Mix (coef_25 - coef_27)
a[[25]] <- as.formula(paste("sh_red_tit ~ new_sec_all_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + ",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + ")))
a[[26]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," +age_main + ind1950_main + ",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + ")))
a[[27]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," +age_main + ind1950_main + ",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + ")))

## Regressions with occ1950_main
### 1920 regressors
a[[28]] <- as.formula(paste("sh_red_tit ~ new_sec_all_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main"))
a[[29]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1920 + new_sec_serv_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main"))
a[[30]] <- as.formula(paste("sh_red_tit ~ new_sec_all_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1920,collapse=" + ")))
a[[31]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1920 + new_sec_serv_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1920,collapse=" + ")))
a[[32]] <- as.formula( paste("sh_red_tit ~ new_sec_all_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + "))   )
a[[33]] <- as.formula( paste("sh_red_tit ~ new_sec_main_1920 + new_sec_serv_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + "))   )

### 1930 regressors
a[[34]] <- as.formula(paste("sh_red_tit ~ new_sec_all_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main"))
a[[35]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main"))
a[[36]] <- as.formula(paste("sh_red_tit ~ new_sec_all_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1930,collapse=" + ")))
a[[37]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1930,collapse=" + ")))
a[[38]] <- as.formula( paste("sh_red_tit ~ new_sec_all_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1930,collapse=" + ")," + ",paste0(occsh_var_1930,collapse=" + "))   )
a[[39]] <- as.formula( paste("sh_red_tit ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1930,collapse=" + ")," + ",paste0(occsh_var_1930,collapse=" + "))   )

### 1930 new sector, 1920 region variables
a[[40]] <- as.formula(paste("sh_red_tit ~ new_sec_all_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main"))
a[[41]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main"))
a[[42]] <- as.formula(paste("sh_red_tit ~ new_sec_all_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1920,collapse=" + ")))
a[[43]] <- as.formula(paste("sh_red_tit ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1920,collapse=" + ")))
a[[44]] <- as.formula( paste("sh_red_tit ~ new_sec_all_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + "))   )
a[[45]] <- as.formula( paste("sh_red_tit ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + "))   )


```

### 5.8.2. Functions related to regressions
##### Function to export results
```{r}
if (!exists("f_reg_results")) {
f_reg_results <- function(Regresults,arg_round=4) {
  # NOTES:
  # Regresults: data.table with 5 columns. (1) Name of variables, (2) Regression coefficient, (3) Standard value, (4) T-Value, (5) P_value
  # Arg_round: number of significance digits. 4 bu default
  
  #sig_10 <- qt(p=.1/2,df=arg_df,lower.tail=FALSE)
  #sig_5  <- qt(p=.05/2,df=arg_df,lower.tail=FALSE)
  #sig_1  <- qt(p=.01/2,df=arg_df,lower.tail=FALSE)
  X <- copy(Regresults)
  setnames(X,c(2,3,4,5),c("coef","std","t_value","p_value"))
  X[,coef_star:=ifelse(p_value>0.1,format(round(coef,arg_round),nsmall=2),ifelse(p_value>0.05,paste0(format(round(coef,arg_round),nsmall=2),"*"),ifelse(p_value>0.01,paste0(format(round(coef,arg_round),nsmall=2),"**"),paste0(format(round(coef,arg_round),nsmall=2),"***"))))]
  #coef.J[,coef_star:=ifelse(x==1,paste0(format(round(coef,arg_round),nsmall=2),"***"),ifelse(x==5,paste0(format(round(coef,arg_round),nsmall=2),"**"),ifelse(x==10,paste0(format(round(coef,arg_round),nsmall=2),"*"),format(round(coef,arg_round),nsmall=2))))]
  X[,std_par:=paste0("(",format(round(std,arg_round),nsmall=2),")")]
  return(X)
}
}
```

##### Function to perform a set of regressions
This function works with methods lm and lm_robust
For lm_robust need to specify the possibility of not using clusters
```{r}
if (!exists("f_regressions")) {
f_regressions <- function(arg_formula,arg_data,arg_weights,method,arg_clusters) {
  
  # Note1: There is a conflict if arg_formula is not a list. E.g. if you create a list (LS) but in arg_formula you introduce LS[[i]], the function will try to subset it and that will give an error
  
  # Note2: Instead of copying arg_data I decided to change the names back to their original names at the end of the function.
  
  setnames(arg_data,c(deparse(substitute(arg_weights))),c("arg_w"))
  tic(paste0("Iteration ",1))
  if (method=="lm") {
    A <- summary(lm(arg_formula[[1]],data=arg_data,weights=arg_w,model=FALSE))
    other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(length(A$residuals),A$adj.r.squared),unname(A$fstatistic)))
  } else if (method=="lm_robust") {
    setnames(arg_data,c(deparse(substitute(arg_clusters))),c("arg_cl"))
    A <- summary(lm_robust(arg_formula[[1]],weights=arg_w,clusters=arg_cl,se_type='stata',data=arg_data))
    other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(A$nobs,A$adj.r.squared),unname(A$fstatistic)))
  }
  coef <- f_reg_results( data.table(A$coefficients[,1:4],keep.rownames=TRUE), arg_round=4 )
  coef <- melt(coef,id.vars = c("rn"), measure.vars = c("coef","std","t_value","p_value","coef_star","std_par"),value.name=c(paste0("model_",1)))
  coef <- rbind(coef,other)
  toc()
  rm(A,other)
  
  if (length(arg_formula)>1) {
    for (i in 2:length(arg_formula)) {
      tic(paste0("Iteration ",i))
      if (method=="lm") {
        A <- summary(lm(arg_formula[[i]],data=arg_data,weights=arg_w,model=FALSE))
        other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(length(A$residuals),A$adj.r.squared),unname(A$fstatistic)))
        setnames(other,c(3),c(paste0("model_",i)))
      } else if (method=="lm_robust") {
        A <- summary(lm_robust(arg_formula[[i]],weights=arg_w,clusters=arg_cl,se_type='stata',data=arg_data))
        other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(A$nobs,A$adj.r.squared),unname(A$fstatistic)))
        setnames(other,c(3),c(paste0("model_",i)))
      }
      
      t <- f_reg_results( data.table(A$coefficients[,1:4],keep.rownames=TRUE), arg_round=4)
      t <- melt(t,id.vars = c("rn"), measure.vars = c("coef","std","t_value","p_value","coef_star","std_par"),value.name=c(paste0("model_",i)))
      t <- rbind(t,other)
      coef <- merge(coef,t,by=c("rn","variable"),all=TRUE)
      rm(A,other,t)
      toc()
    }
  
  }
  coef <- as.data.table(coef)
  coef[,order:=ifelse(variable=="zother",1,0)]
  setorder(coef,order,rn)
  coef[,order:=NULL]
  
  setnames(arg_data, c("arg_w"), c(deparse(substitute(arg_weights))) )
  if (method=="lm_robust") {
    setnames(arg_data,c("arg_cl"),c(deparse(substitute(arg_clusters))))
  }
  return(coef)
}

}
```


### 5.8.3. Regressions
####5.8.3.1. Main Regressions
```{r}
#### No cluster, no drop

coef.J <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000 & perwt_1930 > 10000],arg_weights=perwt_ID,method="lm",arg_clusters=occind)

#### No cluster, drop
coef.J.drop <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,606,668,816,856))],arg_weights=perwt_ID,method="lm",arg_clusters=occind)

#### Cluster, no drop
coef.J.cluster <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000 & perwt_1930 > 10000],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

#### Cluster, drop
coef.J.cluster.drop <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,606,668,816,856))],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

```


##### Saving results
```{r}
if (!exists("wrapper_Excel")) {
wrapper_Excel <- function(list_table,list_name,output) {
  t <- createWorkbook()
  for (i in 1:length(list_table)) {
    addWorksheet(t, list_name[[i]])
    writeData(t, list_name[[i]],list_table[[i]])
  }
  saveWorkbook(t, output,overwrite=TRUE)
}
}

# All the coefficients
list_name <- list("No_cluster_No_drop","No_cluster_Drop","Cluster_No_drop","Cluster_Drop")
list_table <- list(coef.J[variable=="coef_star" | variable =="std_par" | variable=="zother"],coef.J.drop[variable=="coef_star" | variable =="std_par" | variable=="zother"],coef.J.cluster[variable=="coef_star" | variable =="std_par" |variable=="zother"],coef.J.cluster.drop[variable=="coef_star" | variable =="std_par" | variable=="zother"])

wrapper_Excel(list_table,list_name,"/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Tables/individual_regression_1930_metarea_1940.xlsx")

# 1920 Regressors
## Region coefficients, New sector Main
wrapper_Excel(list(coef.J.cluster[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))],coef.J.cluster.drop[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))]),
              list("Cluster_No_drop","Cluster_Drop"),
              "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Tables/ind_reg_1930_met_1940_New_Sector_reg_1920.xlsx")

## Region coefficients, New sector Serv and Main
wrapper_Excel(list(coef.J.cluster[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))],coef.J.cluster.drop[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))]),
              list("Cluster_No_drop","Cluster_Drop"),
              "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Tables/ind_reg_1930_met_1940_New_Main_Serv_reg_1920.xlsx")

# 1930 Regressors
## Region coefficients, New sector Main
wrapper_Excel(list(coef.J.cluster[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))],coef.J.cluster.drop[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))]),
              list("Cluster_No_drop","Cluster_Drop"),
              "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Tables/ind_reg_1930_met_1940_New_Sector_reg_1930.xlsx")

## Region coefficients, New sector Serv and Main
wrapper_Excel(list(coef.J.cluster[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))],coef.J.cluster.drop[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))]),
              list("Cluster_No_drop","Cluster_Drop"),
              "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Tables/ind_reg_1930_met_1940_New_Main_Serv_reg_1930.xlsx")

# 1930 New Sec, 1920 rest
## Region coefficients, New sector Main
wrapper_Excel(list(coef.J.cluster[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))],coef.J.cluster.drop[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))]),
              list("Cluster_No_drop","Cluster_Drop"),
              "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Tables/ind_reg_1930_met_1940_New_Sector_reg_mix.xlsx")

## Region coefficients, New sector Serv and Main
wrapper_Excel(list(coef.J.cluster[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))],coef.J.cluster.drop[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))]),
              list("Cluster_No_drop","Cluster_Drop"),
              "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Tables/ind_reg_1930_met_1940_New_Main_Serv_reg_mix.xlsx")



```

#### 5.8.3.2 Robustness Regressions
```{r}
#Excluding regions with the highest shares of New Sectors
## 2 
coef.J.cluster.drop.excluding_2 <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,606,668,816,856))   &   rank_new_sec_1920>=3],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

## 4
coef.J.cluster.drop.excluding_4 <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,606,668,816,856))   &   rank_new_sec_1920>=5],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

## 9
coef.J.cluster.drop.excluding_9 <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,606,668,816,856))   &   rank_new_sec_1920>=10],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

## 14
coef.J.cluster.drop.excluding_14 <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,606,668,816,856))   &   rank_new_sec_1920>=15],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

## 19
coef.J.cluster.drop.excluding_19 <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,606,668,816,856))   &   rank_new_sec_1920>=20],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

## 29
coef.J.cluster.drop.excluding_29 <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,606,668,816,856))   &   rank_new_sec_1920>=30],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

## 49
coef.J.cluster.drop.excluding_49 <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,606,668,816,856))   &   rank_new_sec_1920>=50],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)
```

##### Saving results
```{r}
if (!exists("wrapper_Excel")) {
wrapper_Excel <- function(list_table,list_name,output) {
  t <- createWorkbook()
  for (i in 1:length(list_table)) {
    addWorksheet(t, list_name[[i]])
    writeData(t, list_name[[i]],list_table[[i]])
  }
  saveWorkbook(t, output,overwrite=TRUE)
}
}

# 1920 Regressors
## Region coefficients, New sector Main
wrapper_Excel(list(
                    coef.J.cluster.drop.excluding_2[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))],
                    coef.J.cluster.drop.excluding_4[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))],
                    coef.J.cluster.drop.excluding_9[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_9$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_9$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))],
                    coef.J.cluster.drop.excluding_14[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))],
                    coef.J.cluster.drop.excluding_19[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))],
                    coef.J.cluster.drop.excluding_29[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))],
                    coef.J.cluster.drop.excluding_49[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))]),
              list("Cluster_Drop_Ex_2","Cluster_Drop_Ex_4","Cluster_Drop_Ex_9","Cluster_Drop_Ex_15","Cluster_Drop_Ex_19","Cluster_Drop_Ex_29","Cluster_Drop_Ex_49"),
              "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Tables/ind_reg_1930_met_1940_New_Sector_reg_1920_exclus.xlsx")

## Region coefficients, New sector Serv and Main
wrapper_Excel(list(
                  coef.J.cluster.drop.excluding_2[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))],
                  coef.J.cluster.drop.excluding_4[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))],
                  coef.J.cluster.drop.excluding_9[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_9$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_9$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))],
                  coef.J.cluster.drop.excluding_14[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))],
                  coef.J.cluster.drop.excluding_19[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))],
                  coef.J.cluster.drop.excluding_29[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))],
                  coef.J.cluster.drop.excluding_49[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))]),
              list("Cluster_Drop_Ex_2","Cluster_Drop_Ex_4","Cluster_Drop_Ex_9","Cluster_Drop_Ex_15","Cluster_Drop_Ex_19","Cluster_Drop_Ex_29","Cluster_Drop_Ex_49"),
              "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Tables/ind_reg_1930_met_1940_New_Main_Serv_reg_1920_exclus.xlsx")

# 1930 Regressors
## Region coefficients, New sector Main
wrapper_Excel(list(
                  coef.J.cluster.drop.excluding_2[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))],
                  coef.J.cluster.drop.excluding_4[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))],
                  coef.J.cluster.drop.excluding_9[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_9$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_9$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))],
                  coef.J.cluster.drop.excluding_14[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))],
                  coef.J.cluster.drop.excluding_19[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))],
                  coef.J.cluster.drop.excluding_29[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))],
                  coef.J.cluster.drop.excluding_49[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))]),
              list("Cluster_Drop_Ex_2","Cluster_Drop_Ex_4","Cluster_Drop_Ex_9","Cluster_Drop_Ex_15","Cluster_Drop_Ex_19","Cluster_Drop_Ex_29","Cluster_Drop_Ex_49"),
              "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Tables/ind_reg_1930_met_1940_New_Sector_reg_1930_exclus.xlsx")

## Region coefficients, New sector Serv and Main
wrapper_Excel(list(
                  coef.J.cluster.drop.excluding_2[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))],
                  coef.J.cluster.drop.excluding_4[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))],
                  coef.J.cluster.drop.excluding_9[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))],
                  coef.J.cluster.drop.excluding_14[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))],
                  coef.J.cluster.drop.excluding_19[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))],
                  coef.J.cluster.drop.excluding_29[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))],
                  coef.J.cluster.drop.excluding_49[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))]),
              list("Cluster_Drop_Ex_2","Cluster_Drop_Ex_4","Cluster_Drop_Ex_9","Cluster_Drop_Ex_15","Cluster_Drop_Ex_19","Cluster_Drop_Ex_29","Cluster_Drop_Ex_49"),
              "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Tables/ind_reg_1930_met_1940_New_Main_Serv_reg_1930_exclus.xlsx")

# 1930 New Sec, 1920 rest
## Region coefficients, New sector Main
wrapper_Excel(list(
                  coef.J.cluster.drop.excluding_2[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))],
                  coef.J.cluster.drop.excluding_4[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))],
                  coef.J.cluster.drop.excluding_9[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))],
                  coef.J.cluster.drop.excluding_14[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))],
                  coef.J.cluster.drop.excluding_19[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))],
                  coef.J.cluster.drop.excluding_29[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))],
                  coef.J.cluster.drop.excluding_49[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))]),
              list("Cluster_Drop_Ex_2","Cluster_Drop_Ex_4","Cluster_Drop_Ex_9","Cluster_Drop_Ex_15","Cluster_Drop_Ex_19","Cluster_Drop_Ex_29","Cluster_Drop_Ex_49"),
              "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Tables/ind_reg_1930_met_1940_New_Sector_reg_mix_exclus.xlsx")

## Region coefficients, New sector Serv and Main
wrapper_Excel(list(
                  coef.J.cluster.drop.excluding_2[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))],
                  coef.J.cluster.drop.excluding_4[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))],
                  coef.J.cluster.drop.excluding_9[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))],
                  coef.J.cluster.drop.excluding_14[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))],
                  coef.J.cluster.drop.excluding_19[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))],
                  coef.J.cluster.drop.excluding_29[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))],
                  coef.J.cluster.drop.excluding_49[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))]),
              list("Cluster_Drop_Ex_2","Cluster_Drop_Ex_4","Cluster_Drop_Ex_9","Cluster_Drop_Ex_15","Cluster_Drop_Ex_19","Cluster_Drop_Ex_29","Cluster_Drop_Ex_49"),
              "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Tables/ind_reg_1930_met_1940_New_Main_Serv_reg_mix_exclus.xlsx")
```


# 6. Exercises to better understand some of the regression results

## 6.1. Looking at correlation between occ_1950 dummies and share of new work
## 6.1.1. Call individual level data
```{r}
census_sample_1930_individual_data <-read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1930_individual_data.fst",as.data.table=TRUE)[occ1950_main!=979 & ind1950_main!=0,c("perwt_ID","ind1950_main","occ1950","occ1950_main","sh_base_tit","sh_red_tit")]

cols <- c("occ1950_main","occ1950")
census_sample_1930_individual_data[,(cols):=lapply(.SD,as.factor),.SDcols=cols]

```

## 6.1.2. Box plot and histogram
```{r}
# Not grouping by occ1950
census_sample_1930_individual_data[,perwt_occ1950_main:=sum(perwt_ID),by=c("occ1950_main")][,occ1950_main_with_sample_size:=paste0(occ1950_main, "\n", "n=", perwt_occ1950_main)]

## Box plots
ggplot(census_sample_1930_individual_data, aes(x=occ1950_main, y=sh_red_tit)) +
  geom_boxplot(width=0.6, outlier.size=0.5) + geom_violin(width=3) + scale_fill_viridis(discrete = TRUE) +
  theme_tufte() +
  xlab("Main Occupational Groups") + ylab("Share of new work") +
  ggtitle("Share of New Work by New Occupation")

ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/boxplot_sh_red_tit_by_occ1950_main.jpeg",plot=last_plot())

## Histograms (y-axis displayed in percentages)
ggplot(data=census_sample_1930_individual_data, aes(x=sh_red_tit)) +
  geom_histogram(bins = 15,
                 aes(y = stat(width*density))) + 
  facet_wrap(~occ1950_main_with_sample_size) +
  scale_y_continuous(labels = percent_format()) +
  xlab("Share of New Work") + ylab("") +
  theme_tufte()

ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/histogram_sh_red_tit_by_occ1950_main.jpeg",plot=last_plot())

# Grouping by occ1950
## Aggregating the Data
census_sample_1930_individual_data <- census_sample_1930_individual_data[,perwt_occ1950:=sum(perwt_ID),by=c("occ1950")]
census_sample_1930_individual_data <- census_sample_1930_individual_data[,lapply(.SD, weighted.mean,w=perwt_ID),by=c("occ1950","occ1950_main"),.SDcols=c("perwt_occ1950","sh_base_tit","sh_red_tit")]

## Box Plot
ggplot(census_sample_1930_individual_data, aes(x=occ1950_main, y=sh_red_tit)) + geom_boxplot() +
  theme_tufte() +
  xlab("Main Occupational Groups") + ylab("Share of new work") +
  ggtitle("Share of New Work by New Occupation")

ggplot(census_sample_1930_individual_data, aes(x=occ1950_main, y=sh_red_tit)) +
    geom_violin(width=2,alpha=0.2) + geom_boxplot(width=0.6, outlier.size=0.5,alpha=0.2) +
 scale_fill_viridis(discrete = TRUE) +
  theme_tufte() +
  xlab("Main Occupational Groups") + ylab("Share of new work") +
  ggtitle("Share of New Work by New Occupation")

ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/boxplot_sh_red_tit_by_occ1950_main_groupedinfo.jpeg",plot=last_plot())


```
From the different graphs we notice a couple of things:
- In the boxplot using all the individual points we observe a lot of outliers. Additionally, many of them appear to have the same exact value across main occupational groups. Leaving aside the fortuitous cases where the share of new variable is effectively the same for different occind detailed occupations, this might be because IPUMS assigns a different occ1950 to individuals having the same occind.
- If we look at the coefficients for the occ1950_main dummies in the different regressions run, they more or less reflects what we can see in the boxplot (e.g. occ1950_main=0 has a more individuals with a higher sh_red_tit than occ1950_main=100, but slightly less than occ1950_main=400)


## 6.1.3. Table with shares at the occ1950_main level
```{r}
census_sample_1930_individual_data <- census_sample_1930_individual_data[,perwt_occ1950_main:=sum(perwt_occ1950),by=c("occ1950_main")]
census_sample_1930_individual_data <- census_sample_1930_individual_data[,lapply(.SD, weighted.mean,w=perwt_occ1950),by=c("occ1950_main"),.SDcols=c("perwt_occ1950_main","sh_base_tit","sh_red_tit")]

write.xlsx(new_titles.occind1930[[1]],"/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Tables/Table_sh_red_tit_by_occ1950_main.xlsx",row.names = TRUE)

```


## 6.1.4. Regression of likelihood of new work only with occupation dummies
```{r}
census_sample_1930_individual_data <-read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1930_individual_data.fst",as.data.table=TRUE)[,c("perwt_ID","ind1950_main","occind","occ1950_main","sh_base_tit","sh_red_tit")]
census_sample_1930_individual_data[,occ1950_main:=as.factor(occ1950_main)]

a <- list(as.formula(paste0("sh_red_tit ~ occ1950_main")))
coef <- f_regressions(arg_formula=a,arg_data=census_sample_1930_individual_data,arg_weights=perwt_ID,method="lm",arg_clusters=occind)

write.xlsx(coef[(variable=="coef_star" | variable =="std_par" | variable=="zother"),c("rn",c(paste0("model_",c(1))))],
           "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Tables/ind_reg_1930_sh_red_tit_by_occ1950_main.xlsx",row.names = TRUE)

```
Note that the explanatory value of the occupational dummies is very high (adj R^2=0.23). In the regressions without occ1950_main, the explanatory value is of the order of 0.16.

## 6.2. Looking at correlation between sh_occ_1950_main and share of new work
Graphs showing the correlation between the share of employment in each main occupational group and the share of new work were created in section Part 1., 1/2. The sign and strength of the correlation graphs are more or less in agreement with the sign of the coefficients associated with the sh_occ1950_main variables (e.g. negative and significant coefficient for sh_occ1950_main_600).

### 6.2.1. Regressions using only the sh_occ_1950_main variables
### countynhg_1910
```{r}
# Constructing database of interest
census_sample_1930_individual_data <-read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1930_individual_data.fst",as.data.table=TRUE)[occ1950_main!=979 & ind1950_main!=0]

## Linking with county level data
### 1920
census_sample_1920_agg_countynhg_1910 <- read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1920_agg_countynhg_1910.fst",as.data.table=TRUE)[,!c("statefip","sh_age_main_0","sh_age_main_1","sh_age_main_2","sh_age_main_3","sh_age_main_4","sh_age_main_5","sh_age_main_6","sh_age_main_7","sh_m_mig_us","sh_m_mig_ab","sh_f_mig_us","sh_f_mig_ab","sh_marst_1","sh_marst_2","sh_marst_3","sh_ownershp","sh_labforce_cl","sh_base","sh_base_tit","sh_base_titind","sh_red","sh_red_tit","sh_red_titind")]
col <- names(census_sample_1920_agg_countynhg_1910[,!c("countynhg_1910")])
setnames(census_sample_1920_agg_countynhg_1910,col,paste0(col,"_1920"))

census_sample_1930_individual_data <- merge(census_sample_1930_individual_data,census_sample_1920_agg_countynhg_1910,by="countynhg_1910",all.x=TRUE,all.y=FALSE)
rm(census_sample_1920_agg_countynhg_1910)

## Creating grouped New Sector variables
census_sample_1930_individual_data <- census_sample_1930_individual_data[,`:=`(new_sec_all_1920=sh_new_sector_ind1950_376_1920+sh_new_sector_ind1950_377_1920+sh_new_sector_ind1950_606_1920+sh_new_sector_ind1950_668_1920+sh_new_sector_ind1950_816_1920,new_sec_main_1920=sh_new_sector_ind1950_376_1920+sh_new_sector_ind1950_377_1920,new_sec_serv_1920=sh_new_sector_ind1950_606_1920+sh_new_sector_ind1950_668_1920+sh_new_sector_ind1950_816_1920)]


# Creating Categorical variables
cols <- c("race","marst","age_main","ind1950_main","occ1950_main")
census_sample_1930_individual_data[,(cols):=lapply(.SD,as.factor),.SDcols=cols]


# Regressions
## Formulas for the regressions
base_individual <- paste0(c("male","lit","marst","race","wwages","mig_us","mig_ab"),collapse=" + ")
occsh_var_1920 <- grep("^sh_occ1950_main_[^0].+_1920",names(census_sample_1930_individual_data),value=TRUE)

a <- vector(mode = "list")
a[[1]] <- as.formula(paste("sh_red_tit ~ ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main"))
a[[2]] <- as.formula( paste("sh_red_tit ~ ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main +", paste0(occsh_var_1920,collapse=" + ")))
a[[3]] <- as.formula(paste("sh_red_tit ~ sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main"," + ",paste0(occsh_var_1920,collapse=" + ")))
a[[4]] <- as.formula(paste("sh_red_tit ~ new_sec_all_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main"," + ",paste0(occsh_var_1920,collapse=" + ")))

## Regressions
coef <- f_regressions(arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000 & !(ind1950 %in% c(376,377,606,668,816,856))],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)
coef[(variable=="coef_star" | variable =="std_par" | variable=="zother"),]

## Exporting Regressions
write.xlsx(coef[(variable=="coef_star" | variable =="std_par" | variable=="zother"),c("rn",c(paste0("model_",c(1:4))))],
           "/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Tables/ind_reg_1930_sh_red_tit_by_sh_occ1950_main_countynhg_1910.xlsx",row.names = FALSE)
```
The results don't give any further information about why the New Sector's variable looses significance when we introduce the share of the main occupations


## 6.3. Correlation between Share of New Work and Share of New Sectors
### countynhg_1910
```{r}
# Calling the data
census_sample_new_work_x_new_sectors <- read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1920_agg_countynhg_1910.fst",as.data.table=TRUE)
census_sample_new_work_x_new_sectors <- census_sample_new_work_x_new_sectors[,grep("^countynhg_1910|^sh_red|^sh_base|^sh_occ1950_main|^sh_new_sector|^sh_ind1950|perwt",names(census_sample_new_work_x_new_sectors),value=TRUE),with=FALSE]
col <- names(census_sample_new_work_x_new_sectors[,!c("countynhg_1910")])
setnames(census_sample_new_work_x_new_sectors,col,paste0(col,"_1920"))

temp <- read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1930_agg_countynhg_1910.fst",as.data.table=TRUE)
temp <- temp[, grep("^countynhg_1910|^sh_red|^sh_base|^sh_occ1950_main|^sh_new_sector|^sh_ind1950|^perwt",names(temp),value=TRUE),with=FALSE]
col <- names(temp[,!c("countynhg_1910")])
setnames(temp,col,paste0(col,"_1930"))
census_sample_new_work_x_new_sectors <- merge(census_sample_new_work_x_new_sectors,temp,by="countynhg_1910",all=FALSE)
rm(temp)

census_sample_new_work_x_new_sectors <- census_sample_new_work_x_new_sectors[,`:=`(new_sec_all_1920=sh_new_sector_ind1950_376_1920+sh_new_sector_ind1950_377_1920+sh_new_sector_ind1950_606_1920+sh_new_sector_ind1950_668_1920+sh_new_sector_ind1950_816_1920,new_sec_all_1930=sh_new_sector_ind1950_376_1930+sh_new_sector_ind1950_377_1930+sh_new_sector_ind1950_606_1930+sh_new_sector_ind1950_668_1930+sh_new_sector_ind1950_816_1930+sh_new_sector_ind1950_856_1930)][,`:=`(new_sec_main_1920=sh_new_sector_ind1950_376_1920+sh_new_sector_ind1950_377_1920,new_sec_main_1930=sh_new_sector_ind1950_376_1930+sh_new_sector_ind1950_377_1930+sh_new_sector_ind1950_856_1930)][,`:=`(new_sec_serv_1920=sh_new_sector_ind1950_606_1920+sh_new_sector_ind1950_668_1920+sh_new_sector_ind1950_816_1920,new_sec_serv_1930=sh_new_sector_ind1950_606_1930+sh_new_sector_ind1950_668_1930+sh_new_sector_ind1950_816_1930)]

# Crating rank variables
setorder(census_sample_new_work_x_new_sectors,-new_sec_all_1920)
census_sample_new_work_x_new_sectors[,rank_new_sec_1920:=1:.N]
setorder(census_sample_new_work_x_new_sectors,-new_sec_all_1930)
census_sample_new_work_x_new_sectors[,rank_new_sec_1930:=1:.N]

# Correlations
## New Work, New Sectors
p <- vector(mode = "list")
p[[1]] <- ggplot(census_sample_new_work_x_new_sectors[perwt_1930>=10000], aes(y=sh_red_tit_1930, x=new_sec_all_1920)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="",x="Share of New Sector", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/corr_sh_new_sectors_1930_x_sh_red_tit_1920.jpeg",plot=last_plot())


### Excluding counties with the highest share of new sectors
for (i in c(3,5,10,20,50)) {
      if (i==3) {j <- 2}
      p[[j]] <- ggplot(census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=i], aes(y=sh_red_tit_1930, x=new_sec_all_1920)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="",x="Share of New Sector", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))
      j <- j+1
}
ggarrange(p[[1]],p[[2]],p[[3]],p[[4]],
          labels = c("All", "Excl. 2", "Excl. 4", "Excl. 9"),
          ncol = 2, nrow = 2)
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/corr_sh_new_sectors_1930_x_sh_red_tit_1920_excl_reg_1.jpeg",plot=last_plot())
ggarrange(p[[5]],p[[6]],
          labels = c("Excl. 19", "Excl. 49"),
          ncol = 2, nrow = 2)
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/corr_sh_new_sectors_1930_x_sh_red_tit_1920_excl_reg_2.jpeg",plot=last_plot())  
rm(p)

## New Sectors, Share of occupations
x <- c("sh_occ1950_main_0_1920","sh_occ1950_main_100_1920","sh_occ1950_main_200_1920","sh_occ1950_main_300_1920","sh_occ1950_main_400_1920","sh_occ1950_main_500_1920","sh_occ1950_main_600_1920","sh_occ1950_main_700_1920","sh_occ1950_main_730_1920","sh_occ1950_main_800_1920","sh_occ1950_main_900_1920")
p <- vector(mode = "list", length = length(x))
for (i in 1:length(x)) {
  p[[i]] <- ggplot(census_sample_new_work_x_new_sectors, aes_string(y="new_sec_all_1920", x= x[i])) +
            geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) +
            labs(title="",x="Share of workers", y = "Share of New Sectors") + theme(axis.line=element_line(color="black"), legend.position = "top") + theme_tufte() 
}
ggarrange(p[[1]],p[[2]],p[[3]],p[[4]],labels=c("Professional, Technical","Farmers","Managers, Officials and Proprietors","Clerical and Kindred"),font.label = list(size = 10),
          ncol = 2, nrow =2)
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/corr_sh_occ1950_main_x_sh_new_sectors_1.jpeg",plot=last_plot())
ggarrange(p[[5]],p[[6]],p[[7]],p[[8]],labels=c("Sales workers","Craftsmen","Operatives","Service Workers (private household)"),font.label = list(size = 10), ncol = 2, nrow =2)
#ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/corr_sh_occ1950_main_x_sh_new_sectors_2.jpeg",plot=last_plot())
ggarrange(p[[9]],p[[10]],p[[11]],labels=c("Service Workers (not household)","Farm laborers","Laborers"),font.label = list(size = 10),
          ncol = 2, nrow =2)
#ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/corr_sh_occ1950_main_x_sh_new_sectors_3.jpeg",plot=last_plot())
rm(p)
```

### metarea_1940
```{r}
# Calling the data
census_sample_new_work_x_new_sectors <- read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1920_agg_metarea_1940.fst",as.data.table=TRUE)
census_sample_new_work_x_new_sectors <- census_sample_new_work_x_new_sectors[,grep("^metarea_1940|^sh_red|^sh_base|^sh_occ1950_main|^sh_new_sector|^sh_ind1950|perwt",names(census_sample_new_work_x_new_sectors),value=TRUE),with=FALSE]
col <- names(census_sample_new_work_x_new_sectors[,!c("metarea_1940")])
setnames(census_sample_new_work_x_new_sectors,col,paste0(col,"_1920"))

temp <- read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1930_agg_metarea_1940.fst",as.data.table=TRUE)
temp <- temp[, grep("^metarea_1940|^sh_red|^sh_base|^sh_occ1950_main|^sh_new_sector|^sh_ind1950|^perwt",names(temp),value=TRUE),with=FALSE]
col <- names(temp[,!c("metarea_1940")])
setnames(temp,col,paste0(col,"_1930"))
census_sample_new_work_x_new_sectors <- merge(census_sample_new_work_x_new_sectors,temp,by="metarea_1940",all=FALSE)
rm(temp)

census_sample_new_work_x_new_sectors <- census_sample_new_work_x_new_sectors[,`:=`(new_sec_all_1920=sh_new_sector_ind1950_376_1920+sh_new_sector_ind1950_377_1920+sh_new_sector_ind1950_606_1920+sh_new_sector_ind1950_668_1920+sh_new_sector_ind1950_816_1920,new_sec_all_1930=sh_new_sector_ind1950_376_1930+sh_new_sector_ind1950_377_1930+sh_new_sector_ind1950_606_1930+sh_new_sector_ind1950_668_1930+sh_new_sector_ind1950_816_1930+sh_new_sector_ind1950_856_1930)][,`:=`(new_sec_main_1920=sh_new_sector_ind1950_376_1920+sh_new_sector_ind1950_377_1920,new_sec_main_1930=sh_new_sector_ind1950_376_1930+sh_new_sector_ind1950_377_1930+sh_new_sector_ind1950_856_1930)][,`:=`(new_sec_serv_1920=sh_new_sector_ind1950_606_1920+sh_new_sector_ind1950_668_1920+sh_new_sector_ind1950_816_1920,new_sec_serv_1930=sh_new_sector_ind1950_606_1930+sh_new_sector_ind1950_668_1930+sh_new_sector_ind1950_816_1930)]

# Crating rank variables
setorder(census_sample_new_work_x_new_sectors,-new_sec_all_1920)
census_sample_new_work_x_new_sectors[,rank_new_sec_1920:=1:.N]
setorder(census_sample_new_work_x_new_sectors,-new_sec_all_1930)
census_sample_new_work_x_new_sectors[,rank_new_sec_1930:=1:.N]


# Correlations
## New Work, New Sectors
p <- vector(mode = "list")
p[[1]] <- ggplot(census_sample_new_work_x_new_sectors[perwt_1930>=10000], aes(y=sh_red_tit_1930, x=new_sec_all_1920)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="",x="Share of New Sector", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/corr_sh_new_sectors_1930_x_sh_red_tit_1920.jpeg",plot=last_plot())


### Excluding counties with the highest share of new sectors
for (i in c(3,5,10,15,20)) {
      if (i==3) {j <- 2}
      p[[j]] <- ggplot(census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=i], aes(y=sh_red_tit_1930, x=new_sec_all_1920)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="",x="Share of New Sector", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))
      j <- j+1
}
ggarrange(p[[1]],p[[2]],p[[3]],p[[4]],
          labels = c("All", "Excl. 2", "Excl. 4", "Excl. 9"),
          ncol = 2, nrow = 2)
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/corr_sh_new_sectors_1930_x_sh_red_tit_1920_excl_reg_1.jpeg",plot=last_plot())
ggarrange(p[[5]],p[[6]],
          labels = c("Excl. 14", "Excl. 19"),
          ncol = 2, nrow = 2)
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/corr_sh_new_sectors_1930_x_sh_red_tit_1920_excl_reg_2.jpeg",plot=last_plot())

rm(p)
## New Sectors, Share of occupations
x <- c("sh_occ1950_main_0_1920","sh_occ1950_main_100_1920","sh_occ1950_main_200_1920","sh_occ1950_main_300_1920","sh_occ1950_main_400_1920","sh_occ1950_main_500_1920","sh_occ1950_main_600_1920","sh_occ1950_main_700_1920","sh_occ1950_main_730_1920","sh_occ1950_main_800_1920","sh_occ1950_main_900_1920")
p <- vector(mode = "list", length = length(x))
for (i in 1:length(x)) {
  p[[i]] <- ggplot(census_sample_new_work_x_new_sectors, aes_string(y="new_sec_all_1920", x= x[i])) +
            geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) +
            labs(title="",x="Share of workers", y = "Share of New Sectors") + theme(axis.line=element_line(color="black"), legend.position = "top") + theme_tufte() 
}
ggarrange(p[[1]],p[[2]],p[[3]],p[[4]],labels=c("Professional, Technical","Farmers","Managers, Officials and Proprietors","Clerical and Kindred"),font.label = list(size = 10),
          ncol = 2, nrow =2)
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/corr_sh_occ1950_main_x_sh_new_sectors_1.jpeg",plot=last_plot())
ggarrange(p[[5]],p[[6]],p[[7]],p[[8]],labels=c("Sales workers","Craftsmen","Operatives","Service Workers (private household)"),font.label = list(size = 10), ncol = 2, nrow =2)
#ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/corr_sh_occ1950_main_x_sh_new_sectors_2.jpeg",plot=last_plot())
ggarrange(p[[9]],p[[10]],p[[11]],labels=c("Service Workers (not household)","Farm laborers","Laborers"),font.label = list(size = 10),
          ncol = 2, nrow =2)
#ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/corr_sh_occ1950_main_x_sh_new_sectors_3.jpeg",plot=last_plot())

rm(p, mp)
```


## 6.4. Some correlation graphs leaving out workers in New Sectors

### countynhg_1910
```{r}
# Creating the info 
## Calling the regional level information
census_sample_new_work_x_new_sectors <- read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1920_agg_countynhg_1910.fst",as.data.table=TRUE)
census_sample_new_work_x_new_sectors <- census_sample_new_work_x_new_sectors[,grep("^countynhg_1910|^sh_red|^sh_base|^sh_occ1950_main|^sh_new_sector|^sh_ind1950|perwt",names(census_sample_new_work_x_new_sectors),value=TRUE),with=FALSE]

col <- names(census_sample_new_work_x_new_sectors[,!c("countynhg_1910")])
setnames(census_sample_new_work_x_new_sectors,col,paste0(col,"_1920"))

temp <- read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1930_agg_countynhg_1910.fst",as.data.table=TRUE)
temp <- temp[, grep("^countynhg_1910|^sh_red|^sh_base|^sh_occ1950_main|^sh_new_sector|^sh_ind1950|^perwt",names(temp),value=TRUE),with=FALSE]
col <- names(temp[,!c("countynhg_1910")])
setnames(temp,col,paste0(col,"_1930"))
census_sample_new_work_x_new_sectors <- merge(census_sample_new_work_x_new_sectors,temp,by="countynhg_1910",all=FALSE)
rm(temp)

census_sample_new_work_x_new_sectors <- census_sample_new_work_x_new_sectors[,`:=`(new_sec_all_1920=sh_new_sector_ind1950_376_1920+sh_new_sector_ind1950_377_1920+sh_new_sector_ind1950_606_1920+sh_new_sector_ind1950_668_1920+sh_new_sector_ind1950_816_1920,new_sec_all_1930=sh_new_sector_ind1950_376_1930+sh_new_sector_ind1950_377_1930+sh_new_sector_ind1950_606_1930+sh_new_sector_ind1950_668_1930+sh_new_sector_ind1950_816_1930+sh_new_sector_ind1950_856_1930)][,`:=`(new_sec_main_1920=sh_new_sector_ind1950_376_1920+sh_new_sector_ind1950_377_1920,new_sec_main_1930=sh_new_sector_ind1950_376_1930+sh_new_sector_ind1950_377_1930+sh_new_sector_ind1950_856_1930)][,`:=`(new_sec_serv_1920=sh_new_sector_ind1950_606_1920+sh_new_sector_ind1950_668_1920+sh_new_sector_ind1950_816_1920,new_sec_serv_1930=sh_new_sector_ind1950_606_1930+sh_new_sector_ind1950_668_1930+sh_new_sector_ind1950_816_1930)]

# Crating rank variables
setorder(census_sample_new_work_x_new_sectors,-new_sec_all_1920)
census_sample_new_work_x_new_sectors[,rank_new_sec_1920:=1:.N]
setorder(census_sample_new_work_x_new_sectors,-new_sec_all_1930)
census_sample_new_work_x_new_sectors[,rank_new_sec_1930:=1:.N]

## Calling the aggregate data to constructs information without workers in new sectors
temp <- read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1930_individual_data.fst",as.data.table=TRUE)[occ1950_main!=979 & ind1950_main!=0 & !(ind1950 %in% c(376,377,606,668,816,856)),c("countynhg_1910","perwt_ID","ind1950","ind1950_main","occ1950_main","sh_red_tit","sh_base_tit")]

### Aggregating by countynhg_1910 keeping info on share of new work
temp <- temp[,lapply(.SD, weighted.mean,w=perwt_ID),by="countynhg_1910",.SDcols=c("sh_red_tit","sh_base_tit")] 
setnames(temp,c("sh_red_tit","sh_base_tit"),c("sh_red_tit_1930_no_new_sec","sh_base_tit_no_new_sec"))

### Combining with census_sample_new_work_x_new_sectors
census_sample_new_work_x_new_sectors <- merge(census_sample_new_work_x_new_sectors,temp,by="countynhg_1910",all=FALSE)
rm(temp)

# Correlations
## New Work, New Sectors
p <- vector(mode = "list")
p[[1]] <- 
  ggplot(census_sample_new_work_x_new_sectors[perwt_1930>=10000], aes(x=new_sec_all_1920)) +
  geom_point(aes(y=sh_red_tit_1930, colour="All Sec"), size=0.1) + geom_point(aes(y=sh_red_tit_1930_no_new_sec, colour="No New Sec"), size=0.1 ) +
  stat_smooth(aes(y=sh_red_tit_1930, colour="All Sec"), method="lm", se=TRUE) +  stat_smooth(aes(y=sh_red_tit_1930_no_new_sec, colour="No New Sec"), method="lm", se=TRUE) +
  geom_rangeframe()  +  
  labs(title="",x="Share of New Sector", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))


### Excluding counties with the highest share of new sectors
for (i in c(3,5,10,20,50,100,200)) {
      if (i==3) {j <- 2}
      p[[j]] <- ggplot(census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=i], aes(x=new_sec_all_1920)) +
                  geom_point(aes(y=sh_red_tit_1930, colour="All Sec"), size=0.1) + geom_point(aes(y=sh_red_tit_1930_no_new_sec, colour="No New Sec"), size=0.1 ) +
                  stat_smooth(aes(y=sh_red_tit_1930, colour="All Sec"), method="lm", se=TRUE) +  stat_smooth(aes(y=sh_red_tit_1930_no_new_sec, colour="No New Sec"), method="lm", se=TRUE) +
                  geom_rangeframe()  +  
                  labs(title="",x="Share of New Sector", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))
      j <- j+1
}
ggarrange(p[[1]],p[[2]],p[[3]],p[[4]],
          labels = c("All Regions", "Excl. 2 Reg.", "Excl. 4 Reg.", "Excl. 9 Reg."),
          ncol = 2, nrow = 2,common.legend = TRUE)
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/corr_sh_new_sectors_1930_x_sh_red_tit_1920_no_new_sec_1.jpeg",plot=last_plot())
ggarrange(p[[5]],p[[6]],p[[7]],p[[8]],
          labels = c("Excl. 19 Reg", "Excl. 49 Reg.","Excl. 99 Reg", "Excl. 199 Reg."),
          ncol = 2, nrow = 2)
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/corr_sh_new_sectors_1930_x_sh_red_tit_1920_no_new_sec_2.jpeg",plot=last_plot())
rm(p)

### Graph excluding regions in the Same plot
p <- vector(mode = "list")
p[[1]] <- ggplot() +
  geom_point(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000],aes(x=new_sec_all_1920,y=sh_red_tit_1930), size=0.2) +
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000],aes(x=new_sec_all_1920,y=sh_red_tit_1930, colour="All"), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=3],aes(x=new_sec_all_1920,y=sh_red_tit_1930, colour="Excl. 3 Reg."), method="lm", se=TRUE) +  
                  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000& rank_new_sec_1920>=5],aes(x=new_sec_all_1920,y=sh_red_tit_1930, colour="Excl. 5 Reg."), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=10],aes(x=new_sec_all_1920,y=sh_red_tit_1930, colour="Excl. 9 Reg."), method="lm", se=TRUE) +  
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=20],aes(x=new_sec_all_1920,y=sh_red_tit_1930, colour="Excl. 19 Reg."), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=50],aes(x=new_sec_all_1920,y=sh_red_tit_1930, colour="Excl. 49 Reg."), method="lm", se=TRUE) +
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=100],aes(x=new_sec_all_1920,y=sh_red_tit_1930, colour="Excl. 99 Reg."), method="lm", se=TRUE) +
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=200],aes(x=new_sec_all_1920,y=sh_red_tit_1930, colour="Excl. 199 Reg."), method="lm", se=TRUE) +
  geom_rangeframe()  +  
  ylim(min(census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_red_tit_1930,census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_red_tit_1930_no_new_sec), max(census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_red_tit_1930,census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_red_tit_1930_no_new_sec)) +
  labs(title="",x="Share of New Sector", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

p[[2]] <- ggplot() +
  geom_point(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000],aes(x=new_sec_all_1920,y=sh_red_tit_1930_no_new_sec), size=0.2) +
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000],aes(x=new_sec_all_1920,y=sh_red_tit_1930_no_new_sec, colour="All"), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=3],aes(x=new_sec_all_1920,y=sh_red_tit_1930_no_new_sec, colour="Excl. 3 Reg."), method="lm", se=TRUE) +  
                  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000& rank_new_sec_1920>=5],aes(x=new_sec_all_1920,y=sh_red_tit_1930_no_new_sec, colour="Excl. 5 Reg."), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=10],aes(x=new_sec_all_1920,y=sh_red_tit_1930_no_new_sec, colour="Excl. 9 Reg."), method="lm", se=TRUE) +  
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=20],aes(x=new_sec_all_1920,y=sh_red_tit_1930_no_new_sec, colour="Excl. 19 Reg."), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=50],aes(x=new_sec_all_1920,y=sh_red_tit_1930_no_new_sec, colour="Excl. 49 Reg."), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=100],aes(x=new_sec_all_1920,y=sh_red_tit_1930_no_new_sec, colour="Excl. 99 Reg."), method="lm", se=TRUE) +
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=200],aes(x=new_sec_all_1920,y=sh_red_tit_1930_no_new_sec, colour="Excl. 199 Reg."), method="lm", se=TRUE) + 
  geom_rangeframe()  +  
  ylim(min(census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_red_tit_1930,census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_red_tit_1930_no_new_sec), max(census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_red_tit_1930,census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_red_tit_1930_no_new_sec)) +
  labs(title="",x="Share of New Sector", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggarrange(p[[1]],p[[2]],
          labels = c("All Sectors","No New Sectors"),
          ncol = 2, nrow = 1,common.legend = TRUE)
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/corr_sh_new_sectors_1930_x_sh_red_tit_1920_different_reg_secs.jpeg",plot=last_plot())



# Correlations
## New Work, New Sectors
p <- vector(mode = "list")
p[[1]] <- 
  ggplot(census_sample_new_work_x_new_sectors[perwt_1930>=10000], aes(x=new_sec_all_1920)) +
  geom_point(aes(y=sh_red_tit_1930, colour="All Sec"), size=0.1) + geom_point(aes(y=sh_red_tit_1930_no_new_sec, colour="No New Sec"), size=0.1 ) +
  stat_smooth(aes(y=sh_red_tit_1930, colour="All Sec"), method="lm", se=TRUE) +  stat_smooth(aes(y=sh_red_tit_1930_no_new_sec, colour="No New Sec"), method="lm", se=TRUE) +
  geom_rangeframe()  +  
  labs(title="",x="Share of New Sector", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))


### Excluding counties with the highest share of new sectors
for (i in c(3,5,10,20,50,100,200)) {
      if (i==3) {j <- 2}
      p[[j]] <- ggplot(census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=i], aes(x=new_sec_all_1920)) +
                  geom_point(aes(y=sh_red_tit_1930, colour="All Sec"), size=0.1) + geom_point(aes(y=sh_red_tit_1930_no_new_sec, colour="No New Sec"), size=0.1 ) +
                  stat_smooth(aes(y=sh_red_tit_1930, colour="All Sec"), method="lm", se=TRUE) +  stat_smooth(aes(y=sh_red_tit_1930_no_new_sec, colour="No New Sec"), method="lm", se=TRUE) +
                  geom_rangeframe()  +  
                  labs(title="",x="Share of New Sector", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))
      j <- j+1
}

ggarrange(p[[1]],p[[3]],p[[7]],p[[8]],
          labels = c("All Regions", "Excl. 4 Reg.", "Excl. 49 Reg.", "Excl. 99 Reg."),
          ncol = 2, nrow = 2,common.legend = TRUE)
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/corr_sh_new_sectors_1930_x_sh_red_tit_1920_no_new_sec_FOR_PRESENTATION_DELEEEETE.jpeg",plot=last_plot())
rm(p)






# DELETE LATER - FOR PRESENTATION


### Graph excluding regions in the Same plot
p <- vector(mode = "list")
p[[1]] <- ggplot() +
  geom_point(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000],aes(x=new_sec_all_1920,y=sh_red_tit_1930), size=0.2) +
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000],aes(x=new_sec_all_1920,y=sh_red_tit_1930, colour="All"), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000& rank_new_sec_1920>=5],aes(x=new_sec_all_1920,y=sh_red_tit_1930, colour="Excl. 4 Reg."), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000& rank_new_sec_1920>=19],aes(x=new_sec_all_1920,y=sh_red_tit_1930, colour="Excl. 19 Reg."), method="lm", se=TRUE) +
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=50],aes(x=new_sec_all_1920,y=sh_red_tit_1930, colour="Excl. 49 Reg."), method="lm", se=TRUE) +
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=100],aes(x=new_sec_all_1920,y=sh_red_tit_1930, colour="Excl. 99 Reg."), method="lm", se=TRUE) +
  geom_rangeframe()  +  
  ylim(min(census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_red_tit_1930,census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_red_tit_1930_no_new_sec), max(census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_red_tit_1930,census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_red_tit_1930_no_new_sec)) +
  labs(title="",x="Share of New Sector", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

p[[2]] <- ggplot() +
  geom_point(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000],aes(x=new_sec_all_1920,y=sh_red_tit_1930_no_new_sec), size=0.2) +
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000],aes(x=new_sec_all_1920,y=sh_red_tit_1930_no_new_sec, colour="All"), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000& rank_new_sec_1920>=5],aes(x=new_sec_all_1920,y=sh_red_tit_1930_no_new_sec, colour="Excl. 4 Reg."), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000& rank_new_sec_1920>=20],aes(x=new_sec_all_1920,y=sh_red_tit_1930_no_new_sec, colour="Excl. 19 Reg."), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=50],aes(x=new_sec_all_1920,y=sh_red_tit_1930_no_new_sec, colour="Excl. 49 Reg."), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=100],aes(x=new_sec_all_1920,y=sh_red_tit_1930_no_new_sec, colour="Excl. 99 Reg."), method="lm", se=TRUE) +
  geom_rangeframe()  +  
  ylim(min(census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_red_tit_1930,census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_red_tit_1930_no_new_sec), max(census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_red_tit_1930,census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_red_tit_1930_no_new_sec)) +
  labs(title="",x="Share of New Sector", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggarrange(p[[1]],p[[2]],
          labels = c("All Sectors","No New Sectors"),
          ncol = 2, nrow = 1,common.legend = TRUE)
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/countynhg_1910/corr_sh_new_sectors_1930_x_sh_red_tit_1920_different_reg_secs_FOR_PRESENTATION.jpeg",plot=last_plot())



rm(p)
```

### metarea_1940
```{r}
# Creating the info 
## Calling the regional level information
census_sample_new_work_x_new_sectors <- read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1920_agg_metarea_1940.fst",as.data.table=TRUE)
census_sample_new_work_x_new_sectors <- census_sample_new_work_x_new_sectors[,grep("^metarea_1940|^sh_red|^sh_base|^sh_occ1950_main|^sh_new_sector|^sh_ind1950|perwt",names(census_sample_new_work_x_new_sectors),value=TRUE),with=FALSE]

col <- names(census_sample_new_work_x_new_sectors[,!c("metarea_1940")])
setnames(census_sample_new_work_x_new_sectors,col,paste0(col,"_1920"))

temp <- read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1930_agg_metarea_1940.fst",as.data.table=TRUE)
temp <- temp[, grep("^metarea_1940|^sh_red|^sh_base|^sh_occ1950_main|^sh_new_sector|^sh_ind1950|^perwt",names(temp),value=TRUE),with=FALSE]
col <- names(temp[,!c("metarea_1940")])
setnames(temp,col,paste0(col,"_1930"))
census_sample_new_work_x_new_sectors <- merge(census_sample_new_work_x_new_sectors,temp,by="metarea_1940",all=FALSE)
rm(temp)

census_sample_new_work_x_new_sectors <- census_sample_new_work_x_new_sectors[,`:=`(new_sec_all_1920=sh_new_sector_ind1950_376_1920+sh_new_sector_ind1950_377_1920+sh_new_sector_ind1950_606_1920+sh_new_sector_ind1950_668_1920+sh_new_sector_ind1950_816_1920,new_sec_all_1930=sh_new_sector_ind1950_376_1930+sh_new_sector_ind1950_377_1930+sh_new_sector_ind1950_606_1930+sh_new_sector_ind1950_668_1930+sh_new_sector_ind1950_816_1930+sh_new_sector_ind1950_856_1930)][,`:=`(new_sec_main_1920=sh_new_sector_ind1950_376_1920+sh_new_sector_ind1950_377_1920,new_sec_main_1930=sh_new_sector_ind1950_376_1930+sh_new_sector_ind1950_377_1930+sh_new_sector_ind1950_856_1930)][,`:=`(new_sec_serv_1920=sh_new_sector_ind1950_606_1920+sh_new_sector_ind1950_668_1920+sh_new_sector_ind1950_816_1920,new_sec_serv_1930=sh_new_sector_ind1950_606_1930+sh_new_sector_ind1950_668_1930+sh_new_sector_ind1950_816_1930)]

# Crating rank variables
setorder(census_sample_new_work_x_new_sectors,-new_sec_all_1920)
census_sample_new_work_x_new_sectors[,rank_new_sec_1920:=1:.N]
setorder(census_sample_new_work_x_new_sectors,-new_sec_all_1930)
census_sample_new_work_x_new_sectors[,rank_new_sec_1930:=1:.N]

## Calling the aggregate data to constructs information without workers in new sectors
temp <- read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1930_individual_data.fst",as.data.table=TRUE)[occ1950_main!=979 & ind1950_main!=0 & !(ind1950 %in% c(376,377,606,668,816,856)),c("metarea_1940","perwt_ID","ind1950","ind1950_main","occ1950_main","sh_red_tit","sh_base_tit")]

### Aggregating by metarea_1940 keeping info on share of new work
temp <- temp[,lapply(.SD, weighted.mean,w=perwt_ID),by="metarea_1940",.SDcols=c("sh_red_tit","sh_base_tit")] 
setnames(temp,c("sh_red_tit","sh_base_tit"),c("sh_red_tit_1930_no_new_sec","sh_base_tit_no_new_sec"))

### Combining with census_sample_new_work_x_new_sectors
census_sample_new_work_x_new_sectors <- merge(census_sample_new_work_x_new_sectors,temp,by="metarea_1940",all=FALSE)
rm(temp)

# Correlations
## New Work, New Sectors
p <- vector(mode = "list")
p[[1]] <- 
  ggplot(census_sample_new_work_x_new_sectors[perwt_1930>=10000], aes(x=new_sec_all_1920)) +
  geom_point(aes(y=sh_red_tit_1930, colour="All Sec"), size=0.3) + geom_point(aes(y=sh_red_tit_1930_no_new_sec, colour="No New Sec"), size=0.3 ) +
  stat_smooth(aes(y=sh_red_tit_1930, colour="All Sec"), method="lm", se=TRUE) +  stat_smooth(aes(y=sh_red_tit_1930_no_new_sec, colour="No New Sec"), method="lm", se=TRUE) +
  geom_rangeframe()  +  
  labs(title="",x="Share of New Sector", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))


### Excluding counties with the highest share of new sectors
for (i in c(3,5,10,15,20,30,50)) {
      if (i==3) {j <- 2}
      p[[j]] <- ggplot(census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1930>=i], aes(x=new_sec_all_1920)) +
                  geom_point(aes(y=sh_red_tit_1930, colour="All Sec"), size=0.3) + geom_point(aes(y=sh_red_tit_1930_no_new_sec, colour="No New Sec"), size=0.3 ) +
                  stat_smooth(aes(y=sh_red_tit_1930, colour="All Sec"), method="lm", se=TRUE) +  stat_smooth(aes(y=sh_red_tit_1930_no_new_sec, colour="No New Sec"), method="lm", se=TRUE) +
                  geom_rangeframe()  +  
                  labs(title="",x="Share of New Sector", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))
      j <- j+1
}
ggarrange(p[[1]],p[[2]],p[[3]],p[[4]],
          labels = c("All Regions", "Excl. 2 Reg.", "Excl. 4 Reg.", "Excl. 9 Reg."),
          ncol = 2, nrow = 2,common.legend = TRUE)
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/corr_sh_new_sectors_1930_x_sh_red_tit_1920_no_new_sec_1.jpeg",plot=last_plot())
ggarrange(p[[5]],p[[6]],p[[7]],p[[8]],
          labels = c("Excl. 15 Reg", "Excl. 19 Reg.","Excl. 29 Reg", "Excl. 49 Reg."),
          ncol = 2, nrow = 2)
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/corr_sh_new_sectors_1930_x_sh_red_tit_1920_no_new_sec_2.jpeg",plot=last_plot())

rm(p,i,j)

### Graph excluding regions in the Same plot
p <- vector(mode = "list")
p[[1]] <- ggplot() +
  geom_point(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000],aes(x=new_sec_all_1920,y=sh_red_tit_1930), size=0.5) +
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000],aes(x=new_sec_all_1920,y=sh_red_tit_1930, colour="All"), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=3],aes(x=new_sec_all_1920,y=sh_red_tit_1930, colour="Excl. 3 Reg."), method="lm", se=TRUE) +  
                  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000& rank_new_sec_1920>=5],aes(x=new_sec_all_1920,y=sh_red_tit_1930, colour="Excl. 5 Reg."), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=10],aes(x=new_sec_all_1920,y=sh_red_tit_1930, colour="Excl. 9 Reg."), method="lm", se=TRUE) +  
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=15],aes(x=new_sec_all_1920,y=sh_red_tit_1930, colour="Excl. 14 Reg."), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=20],aes(x=new_sec_all_1920,y=sh_red_tit_1930, colour="Excl. 19 Reg."), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=30],aes(x=new_sec_all_1920,y=sh_red_tit_1930, colour="Excl. 29 Reg."), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=50],aes(x=new_sec_all_1920,y=sh_red_tit_1930, colour="Excl. 49 Reg."), method="lm", se=TRUE) + 
  geom_rangeframe()  +  
  ylim(min(census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_red_tit_1930,census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_red_tit_1930_no_new_sec), max(census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_red_tit_1930,census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_red_tit_1930_no_new_sec)) +
  labs(title="",x="Share of New Sector", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

p[[2]] <- ggplot() +
  geom_point(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000],aes(x=new_sec_all_1920,y=sh_red_tit_1930_no_new_sec), size=0.5) +
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000],aes(x=new_sec_all_1920,y=sh_red_tit_1930_no_new_sec, colour="All"), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=3],aes(x=new_sec_all_1920,y=sh_red_tit_1930_no_new_sec, colour="Excl. 3 Reg."), method="lm", se=TRUE) +  
                  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000& rank_new_sec_1920>=5],aes(x=new_sec_all_1920,y=sh_red_tit_1930_no_new_sec, colour="Excl. 5 Reg."), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=10],aes(x=new_sec_all_1920,y=sh_red_tit_1930_no_new_sec, colour="Excl. 9 Reg."), method="lm", se=TRUE) +  
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=15],aes(x=new_sec_all_1920,y=sh_red_tit_1930_no_new_sec, colour="Excl. 14 Reg."), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=20],aes(x=new_sec_all_1920,y=sh_red_tit_1930_no_new_sec, colour="Excl. 19 Reg."), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=30],aes(x=new_sec_all_1920,y=sh_red_tit_1930_no_new_sec, colour="Excl. 29 Reg."), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=50],aes(x=new_sec_all_1920,y=sh_red_tit_1930_no_new_sec, colour="Excl. 49 Reg."), method="lm", se=TRUE) + 
  geom_rangeframe()  +  
  ylim(min(census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_red_tit_1930,census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_red_tit_1930_no_new_sec), max(census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_red_tit_1930,census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_red_tit_1930_no_new_sec)) +
  labs(title="",x="Share of New Sector", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggarrange(p[[1]],p[[2]],
          labels = c("All Sectors","No New Sectors"),
          ncol = 2, nrow = 1,common.legend = TRUE)
ggsave("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Graphs/metarea_1940/corr_sh_new_sectors_1930_x_sh_red_tit_1920_different_reg_secs.jpeg",plot=last_plot())

rm(p)

```
## 6.5. Looking at most important occind by sector, paying particular attention to the occupations with the highest shares of new work

### 6.5.1. Constructing main databse
```{r}
rm(list=setdiff(ls(all.names = TRUE), "f_load_pk"))
f_load_pk()

# Calling the data
census_sample_1930_individual_data <-read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1930_individual_data.fst",as.data.table=TRUE)[occ1950_main!=979 & ind1950_main!=0,c("perwt_ID","ind1950","ind1950_main","occind","occ1950","occ1950_main","sh_base_tit","sh_red_tit")]

# Combining New Sectors


# Aggregating
census_sample_1930_individual_data <- census_sample_1930_individual_data[,perwt_occind_x_ind1950:=sum(perwt_ID),by=c("occind","ind1950")][,perwt_occ1950_x_ind1950:=sum(perwt_ID),by=c("occ1950","perwt_ID")][,perwt_occind:=sum(perwt_ID),by=c("occind")][,perwt_occ1950:=sum(perwt_ID),by=c("occind")][,perwt_ind1950:=sum(perwt_ID),by=c("ind1950")]
census_sample_1930_individual_data[,sh_red_tit_x_occ1950:=lapply(.SD,weighted.mean,w=perwt_ID),by=c("occ1950"),.SDcols=c("sh_red_tit")][,sh_red_tit_x_ind1950:=lapply(.SD,weighted.mean,w=perwt_ID),by=c("ind1950"),.SDcols=c("sh_red_tit")]

census_sample_1930_individual_data <- census_sample_1930_individual_data[,.SD[1],by=c("occind","occ1950","ind1950"),,.SDcols=c("perwt_occind_x_ind1950","perwt_occ1950_x_ind1950","perwt_occind","perwt_occ1950","perwt_ind1950","sh_red_tit","sh_red_tit_x_occ1950","sh_red_tit_x_ind1950")]
```

### 6.5.2. Analyzing the data
#### 6.5.2.1. occind
```{r}
# Selecting the set of interest
census_sample_1930_occind_x_ind1950 <- census_sample_1930_individual_data[,.SD[1],by=c("occind","ind1950"),.SDcols=c("perwt_ind1950","perwt_occind","perwt_occind_x_ind1950","sh_red_tit","sh_red_tit_x_ind1950")]

# Creating shares
setorder(census_sample_1930_occind_x_ind1950,ind1950,-sh_red_tit)
census_sample_1930_occind_x_ind1950[,sh_occind_in_ind1950:=perwt_occind_x_ind1950/perwt_ind1950][,w_x_sh_new:=sh_occind_in_ind1950*sh_red_tit][,cumsum_sh_occind_in_ind1950:=cumsum(sh_occind_in_ind1950),by=c("ind1950")]

# Creating vector with the number of all the ind1950
ind_1950 <- unique(census_sample_1930_occind_x_ind1950$ind1950)

# Reorganizing data
census_sample_1930_occind_x_ind1950 <- data.table::dcast(census_sample_1930_occind_x_ind1950, occind + sh_red_tit + perwt_occind  ~ ind1950, value.var = c("sh_occind_in_ind1950","cumsum_sh_occind_in_ind1950","w_x_sh_new") )

# Convert all cells with NA values to 0
census_sample_1930_occind_x_ind1950 <- census_sample_1930_occind_x_ind1950[,lapply(.SD,function(x) {x[is.na(x)] <- 0; x}),.SDcols=names(census_sample_1930_occind_x_ind1950)]

# Merging with occind name
## Import names
occ1930.codes <- as.data.table( read_excel("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/input/1930 - Cleaned.xlsx", sheet = "1930 main groups",guess_max=10000) )[,c("occind","occ","occind1930_name")]

## Merge
census_sample_1930_occind_x_ind1950 <- merge(census_sample_1930_occind_x_ind1950,occ1930.codes,by=c("occind"),all.x=TRUE,all.y=FALSE)

# Reorganize information
organize <- c("occind","occ","occind1930_name","sh_red_tit")
for (i in c(c(376,377,606,668,816,856),ind_1950[!ind_1950 %in% c(376,377,606,668,816,856)])) {
  organize <- c(organize,
                grep(paste0(i,"$"),names(census_sample_1930_occind_x_ind1950),value=TRUE))
}
setcolorder(census_sample_1930_occind_x_ind1950, organize) 

# Export information
write.xlsx(census_sample_1930_occind_x_ind1950,"/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Tables/census_sample_1930_occind_x_ind1950.xlsx",row.names = FALSE)

```



### FOR PRESENTATION
```{r}
temp_a <- read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1930_agg_metarea_1940.fst",as.data.table=TRUE)
length((unique(temp_a$metarea_1940)))
temp_a <- temp_a[metarea_1940<1000]
length((unique(temp_a$metarea_1940)))
temp_a <- temp_a[perwt>=10000]
length((unique(temp_a$metarea_1940)))


temp_a <- read_fst("/Users/mauribev/Google Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/R - Processing data/output/Rdata/census_sample_1930_agg_countynhg_1910.fst",as.data.table=TRUE)
length((unique(temp_a$countynhg_1910)))
temp_a <- temp_a[perwt>=10000]
length((unique(temp_a$countynhg_1910)))

```



## Appendix

# Initial code chunks that were changed (I keep the original in case there are mistakes. Usually the original is a longer code, but that appears to be more robust)


## Industries and new titles
This function admits only two values for argument ind, and works by having different cases
```{r}
# Function to construct the data.table with information at the industry level
f_ind_new_titles <- function(x,flag,id_N,ind="ind",names=NULL) {
  y <- copy(x)
  # Selecting the new_titles variable
  if (flag==1)        {y[,c("sh_new_reordered","sh_new_stemmed"):=NULL]}
  else if (flag==2)    
  {
    y[,c("sh_new","sh_new_stemmed"):=NULL]
    setnames(y, "sh_new_reordered", "sh_new")
  }
  else if (flag==3)    
  {
    y[,c("sh_new","sh_new_reordered"):=NULL]
    setnames(y, "sh_new_stemmed", "sh_new")
  }
  
  # Computing the different things
  if (ind=="ind") {
      y <- y[,`:=`(sh_new=perwt*sh_new)][,lapply(.SD,sum),by=c("ind","occind"),.SDcols=c("perwt","sh_new")][,c("sum_new","emp"):=lapply(.SD,sum),by="ind",.SDcols=c("sh_new","perwt")][,`:=`(sh_occ=perwt/emp,sh_new_occ=sh_new/sum_new)]
    setorder(y,ind,-sh_new_occ)
    y <- y[,id:=1:.N,by="ind"][id<=id_N][,sh_new:=sh_new/emp][,sh_new:=sum_new/emp][,c("perwt","sum_new"):=NULL]
    y <- data.table::dcast(y, ind + sh_new + emp  ~ id, value.var = c("occind","sh_new_occ","sh_occ") )
    if (!is.null(names)) {
      y <- merge(y,names,by="ind",all.x=TRUE,all.y=FALSE)
      if(!is.null(names$ind_name)) {
        idcols <- c("ind","ind_name"); cols <- c(idcols, names(y)[-which(names(y) %in% idcols)])  
        setcolorder(y, cols)
        }
    }  
    setorder(y,-sh_new,ind)
    
    
  } else if (ind=="ind1950"){
    y <- y[,`:=`(sh_new=perwt*sh_new)][,lapply(.SD,sum),by=c("ind1950","occind"),.SDcols=c("perwt","sh_new")][,c("sum_new","emp"):=lapply(.SD,sum),by="ind1950",.SDcols=c("sh_new","perwt")][,`:=`(sh_occ=perwt/emp,sh_new_occ=sh_new/sum_new)]
    setorder(y,ind1950,-sh_new_occ)
    y <- y[,id:=1:.N,by="ind1950"][id<=id_N][,sh_new:=sh_new/emp][,sh_new:=sum_new/emp][,c("perwt","sum_new"):=NULL]
    y <- data.table::dcast(y, ind1950 + sh_new + emp  ~ id, value.var = c("occind","sh_new_occ","sh_occ") )
    if (!is.null(names)) {
      y <- merge(y,names,by="ind1950",all.x=TRUE,all.y=FALSE)
      if(!is.null(names$ind1950_name)) {
        idcols <- c("ind1950","ind1950_name"); cols <- c(idcols, names(y)[-which(names(y) %in% idcols)])  
        setcolorder(y, cols)
        }
      } 
    setorder(y,-sh_new,ind1950)
  }
}

census_sample_1930.countynhg.ind <- f_ind_new_titles(census_sample_1930.countynhg[!(occ %in% c(998,999)) & (ind1950 >=1 & ind1950<=990)],1,5,ind="ind1950",names=ind1950.codes[,c("ind1950","ind1950_name")])

```

## function to compute shares of varx against var y
```{r}
f_varx_x_vary <- function(X,id_N,varx,vary,weight_v,names=NULL,varx_n,varx_name_n) {
  y <- copy(X)
  setnames(y, c(deparse(substitute(varx)),deparse(substitute(vary))), c("v_x","v_y"))
  if (missing(weight_v)) y <- y[,v_w:=1]
  else setnames(y, c(deparse(substitute(weight_v))), c("v_w"))
  
  # Computing the different things
  
      y <- y[,lapply(.SD,sum),by=c("v_x","v_y"),.SDcols=c("v_w")][,c("sum_varx"):=lapply(.SD,sum),by="v_x",.SDcols=c("v_w")][,`:=`(sh_vary=v_w/sum_varx)]
  
  setorderv(y,   c("v_x" ,"sh_vary"),c(1,-1) )
  y <- y[,id:=1:.N,by="v_x"][id<=id_N]
   
  setnames(y, c("v_y","sh_vary"), c(deparse(substitute(vary)),paste0("sh_",deparse(substitute(vary))) ) )  
  y <- data.table::dcast(y, v_x + sum_varx  ~ id, value.var = c(paste0( "sh_",deparse(substitute(vary))),deparse(substitute(vary))))
    
  
  if (!is.null(names)) {
    # It seems that the names argument doesn't get changed by reference, so we don't need    "names <- copy(names)"
    setnames(names, c( deparse(substitute(varx_n))  ), c("v_x")  )

    y <- merge(y,names,by="v_x",all.x=TRUE,all.y=FALSE)
    
    idcols <- c("v_x", deparse(substitute(varx_name_n)) ); cols <- c(idcols, names(y)[-which(names(y) %in% idcols)])  
    setcolorder(y, cols)
  }
  setorderv(y,c("v_x"),  c(1))
  setnames(y, c("v_x","sum_varx"),
           c(deparse(substitute(varx)),
             c(paste0("total_",deparse(substitute(varx))))  
             )
           ) 
  
}
a <- f_varx_x_vary(census_sample_1930.countynhg,10,varx=occind.x,vary=occ1950,weight_v=perwt,names=occ1930.codes[,c("occind","occind1930_name")],varx_n = occind,varx_name_n = occind1930_name)
b <- f_varx_x_vary(census_sample_1930.countynhg,10,varx=occ1950,vary=occind.x,weight_v=perwt,names=occ1950.codes[,c("occ1950","occ1950_name")],varx_n = occ1950,varx_name_n = occ1950_name)
c <- f_varx_x_vary(census_sample_1930.countynhg,10,varx=ind,vary=ind1950,weight_v=perwt,names=ind1930.codes[,c("ind","ind_name")],varx_n = ind,varx_name_n = ind_name)
d <- f_varx_x_vary(census_sample_1930.countynhg,10,varx=ind1950,vary=ind,weight_v=perwt,names=ind1950.codes[,c("ind1950","ind1950_name")],varx_n = ind1950,varx_name_n = ind1950_name)

```



## Using textreg to export regression results
```{r}
if (FALSE) {
model <- vector(mode = "list", length = 6)
j <- 1
for (i in c(1,3,10,12,19,21) ) {
  tic()
  model[[j]] <- lm_robust(a[[i]],weights=perwt_ID,clusters=occind,se_type='stata',data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,606,668,816,856))])
  j <- j+1
  toc()
}

texreg(model[1:2],stars = c(0.01, 0.05, 0.1),custom.coef.map=list("new_sec_main_1920" = "New Sector","new_sec_main_1920"="Main New Sector","new_sec_serv_1920"="Service related New Sector","H_1920"="H-H Index","log(perwt_1920)"="Population (logs)","sh_lit_1920"="Share of Literate"))
}
```

