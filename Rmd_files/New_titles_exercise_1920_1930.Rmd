---
title: "New titles exercise 1920-1930"
output: html_document
---
# Delete Workspace and load packages
## Function to load necessary packages
```{r}
f_load_pk <- function() {
  
  # Pacman: packages manager. It does different things, here I use it to load multiple packages at the same time
  library (pacman)
  p_load(readxl,foreign,readstata13,data.table,plyr,dplyr,stringr,openxlsx,stringdist,reshape2,qdap,fst,ipumsr,tm,textreg,tmap,tmaptools,sf,leaflet,ipumsr)
  p_load(tictoc)
  
  # Statistical packages
  p_load(fastDummies,sandwich,lmtest,estimatr)
  p_load(weights)  # To perform weighted correlations
  p_load(here)
  
  #graphs
  p_load(ggplot2,maps,ggthemes,sjPlot,sjmisc,sjlabelled,jtools,ggstance,broom.mixed)
  p_load(ggpubr)   # Contains ggarrange, used to plot more than one grpah in the same figure
  p_load(scales)   # Used in histogram to show percent format
}
```

## Using function
```{r}
rm(list=setdiff(ls(all.names = TRUE), "f_load_pk"))
f_load_pk()
```

# Part 1. Data Analysis at the geographic level
Here we look at correlations between the share of new titles and different geographic level variables

## 1. County 1910
### Histogram and correlation graphs
```{r}
# Note: We work with counties with more than 10000 inhabitants
census_sample_1930_agg_countynhg_1910 <- read_fst(here(paste0("output/Rdata/census_sample_1930_agg_countynhg_1910.fst")),as.data.table=TRUE)[perwt>=10000][,statefip:=as.factor(statefip)]

# Histogram
ggplot(census_sample_1930_agg_countynhg_1910, aes(x=sh_new_method1)) +
  geom_histogram(color="black",bins=25,fill="white") +
  labs(title="",x="Share of New Work", y = "Count")  + 
  theme_tufte() + theme(legend.position = "none")

ggsave(here(paste0("output/Graphs/countynhg_1910/histogram_sh_new_method1.jpeg")),plot=last_plot())


# Some Scatterplots
# Population
ggplot(census_sample_1930_agg_countynhg_1910, aes(y=sh_new_method1, x=log(perwt))) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and population",x="Population (log)", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave(here(paste0("output/Graphs/countynhg_1910/corr_pop_x_sh_new_method1.jpeg")),plot=last_plot())

# Gender
ggplot(census_sample_1930_agg_countynhg_1910, aes(y=sh_new_method1, x=sh_male)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and male population",x="Share of Males", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave(here(paste0("output/Graphs/countynhg_1910/corr_sh_male_x_sh_new_method1.jpeg")),plot=last_plot())

# Black population
ggplot(census_sample_1930_agg_countynhg_1910, aes(y=sh_new_method1, x=sh_race_2)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and black population",x="Share of Black population", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave(here(paste0("output/Graphs/countynhg_1910/corr_sh_race_2_x_sh_new_method1.jpeg")),plot=last_plot())


# Literate
ggplot(census_sample_1930_agg_countynhg_1910, aes(y=sh_new_method1, x=sh_lit)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of literate population",x="Share of literate population", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave(here(paste0("output/Graphs/countynhg_1910/corr_sh_lit_x_sh_new_method1.jpeg")),plot=last_plot())

# Labor force
ggplot(census_sample_1930_agg_countynhg_1910, aes(y=sh_new_method1, x=sh_labforce_emp)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of labor force",x="Share of labor force", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave(here(paste0("output/Graphs/countynhg_1910/corr_sh_labforce_emp_x_sh_new_method1.jpeg")),plot=last_plot())

# Working for wages
ggplot(census_sample_1930_agg_countynhg_1910, aes(y=sh_new_method1, x=sh_wrkwage)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of population working for wages",x="Share of population working for wages", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave(here(paste0("output/Graphs/countynhg_1910/corr_sh_wrkwage_x_sh_new_method1.jpeg")),plot=last_plot())

# Urban
ggplot(census_sample_1930_agg_countynhg_1910, aes(y=sh_new_method1, x=sh_urban)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of urban population",x="Share of urban population", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave(here(paste0("output/Graphs/countynhg_1910/corr_sh_urban_x_sh_new_method1.jpeg")),plot=last_plot())

# Farm
ggplot(census_sample_1930_agg_countynhg_1910, aes(y=sh_new_method1, x=sh_farm)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of farm population",x="Share of farm population", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave(here(paste0("output/Graphs/countynhg_1910/corr_sh_farm_x_sh_new_method1.jpeg")),plot=last_plot())

# Migration within the US
ggplot(census_sample_1930_agg_countynhg_1910, aes(y=sh_new_method1, x=sh_mig_us)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of internal migrants",x="Share of internal migrants", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave(here(paste0("output/Graphs/countynhg_1910/corr_sh_mig_us_x_sh_new_method1.jpeg")),plot=last_plot())

# Goreign migrants
ggplot(census_sample_1930_agg_countynhg_1910, aes(y=sh_new_method1, x=sh_mig_ab)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of foreign migrants",x="Share of foreign migrants", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave(here(paste0("output/Graphs/countynhg_1910/corr_sh_mig_ab_x_sh_new_method1.jpeg")),plot=last_plot())


# Industry
x <- c("sh_ind1950_main_1","sh_ind1950_main_2","sh_ind1950_main_3","sh_ind1950_main_4","sh_ind1950_main_5","sh_ind1950_main_6","sh_ind1950_main_7")
p <- vector(mode = "list", length = length(x))
for (i in 1:7) {
  p[[i]] <- ggplot(census_sample_1930_agg_countynhg_1910, aes_string(y="sh_new_method1", x= x[i])) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="",x="Share of workers", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"), legend.position = "top")
}
ggarrange(p[[1]],p[[2]],p[[3]],p[[4]],labels=c("Agriculture","Mining-Construction","Manufacturing","Tr-Comm-Util"),
          ncol=2,nrow=2)
ggsave(here(paste0("output/Graphs/countynhg_1910/corr_sh_ind1950_main_x_sh_new_method1_1.jpeg")),plot=last_plot())
ggarrange(p[[5]],p[[6]],p[[7]],labels=c("Trade","Services","Public Admin."),
          ncol=2,nrow=2)
ggsave(here(paste0("output/Graphs/countynhg_1910/corr_sh_ind1950_main_x_sh_new_method1_2.jpeg")),plot=last_plot())


# Occupation
x <- c("sh_occ1950_main_0","sh_occ1950_main_100","sh_occ1950_main_200","sh_occ1950_main_300","sh_occ1950_main_400","sh_occ1950_main_500","sh_occ1950_main_600","sh_occ1950_main_700","sh_occ1950_main_730","sh_occ1950_main_800","sh_occ1950_main_900")
p <- vector(mode = "list", length = length(x))
for (i in 1:length(x)) {
  p[[i]] <- ggplot(census_sample_1930_agg_countynhg_1910, aes_string(y="sh_new_method1", x= x[i])) +
            geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) +
            labs(title="",x="Share of workers", y = "Share of New Work") + theme(axis.line=element_line(color="black"), legend.position = "top") + theme_tufte() 
}
ggarrange(p[[1]],p[[2]],p[[3]],p[[4]],labels=c("Professional, Technical","Farmers","Managers, Officials and Proprietors","Clerical and Kindred"),font.label = list(size = 10),
          ncol = 2, nrow =2)
ggsave(here(paste0("output/Graphs/countynhg_1910/corr_sh_occ1950_main_x_sh_new_method1_1.jpeg")),plot=last_plot())
ggarrange(p[[5]],p[[6]],p[[7]],p[[8]],labels=c("Sales workers","Craftsmen","Operatives","Service Workers (private household)"),font.label = list(size = 10), ncol = 2, nrow =2)
ggsave(here(paste0("output/Graphs/countynhg_1910/corr_sh_occ1950_main_x_sh_new_method1_2.jpeg")),plot=last_plot())
ggarrange(p[[9]],p[[10]],p[[11]],labels=c("Service Workers (not household)","Farm laborers","Laborers"),font.label = list(size = 10),
          ncol = 2, nrow =2)
ggsave(here(paste0("output/Graphs/countynhg_1910/corr_sh_occ1950_main_x_sh_new_method1_3.jpeg")),plot=last_plot())
```

### Basic regressions
```{r}
# Basic
m1 <- lm(sh_new_method1 ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab, data=census_sample_1930_agg_countynhg_1910)
m2 <- lm(sh_new_method1 ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab + statefip , data=census_sample_1930_agg_countynhg_1910)
m3 <- plm(sh_new_method1 ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab, 
                    data = census_sample_1930_agg_countynhg_1910,
                    index = c("statefip"), 
                    model = "within")

tab_model(m1,m2,m3,show.ci=FALSE,show.se=TRUE,use.viewer=FALSE)
plot_summs(m1,m3, scale = FALSE,legend.title = "") + theme_tufte()
ggsave(here(paste0("output/Graphs/countynhg_1910/reg_basic.jpeg")),plot=last_plot())

# Industry variables
(indvar <- grep("^sh_ind1950_main_[^1]",names(census_sample_1930_agg_countynhg_1910),value=TRUE))

form <- as.formula(paste("sh_new_method1 ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab +",paste0(indvar,collapse=" + ")))
form1 <- as.formula(paste("sh_new_method1 ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab + statefip +",paste0(indvar,collapse=" + ")))

m4 <- lm(form,data=census_sample_1930_agg_countynhg_1910)
m5 <- lm(form1, data=census_sample_1930_agg_countynhg_1910)
m6 <- plm(form1, 
                    data = census_sample_1930_agg_countynhg_1910,
                    index = c("statefip"), 
                    model = "within")

tab_model(m4,m5,m6,show.ci=FALSE,show.se=TRUE,use.viewer=FALSE)
plot_summs(m4,m6, scale = FALSE,legend.title = "") + theme_tufte()
ggsave(here(paste0("output/Graphs/countynhg_1910/reg_industry.jpeg")),plot=last_plot())


# Occupation variables
(occvar <- grep("^sh_occ1950_main_[^0]",names(census_sample_1930_agg_countynhg_1910),value=TRUE))

form <- as.formula(paste("sh_new_method1 ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab +",paste0(occvar,collapse=" + ")))
form1 <- as.formula(paste("sh_new_method1 ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab + statefip +",paste0(occvar,collapse=" + ")))

m7 <- lm(form,data=census_sample_1930_agg_countynhg_1910)
m8 <- lm(form1, data=census_sample_1930_agg_countynhg_1910)
m9 <- plm(form1, 
                    data = census_sample_1930_agg_countynhg_1910,
                    index = c("statefip"), 
                    model = "within")

tab_model(m7,m8,m9,show.ci=FALSE,show.se=TRUE,use.viewer=FALSE)
plot_summs(m7,m9, scale = FALSE,legend.title = "") + theme_tufte()
ggsave(here(paste0("output/Graphs/countynhg_1910/reg_occupation.jpeg")),plot=last_plot())


# Industry and occupation variables
form <- as.formula(paste("sh_new_method1 ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab +",paste0(indvar,collapse=" + ")," + ",paste0(occvar,collapse=" + ")))
form1 <- as.formula(paste("sh_new_method1 ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab + statefip +",paste0(indvar,collapse=" + ")," + ",paste0(occvar,collapse=" + ")))

m10 <- lm(form,data=census_sample_1930_agg_countynhg_1910)
m11 <- lm(form1, data=census_sample_1930_agg_countynhg_1910)
m12 <- plm(form1, 
                    data = census_sample_1930_agg_countynhg_1910,
                    index = c("statefip"), 
                    model = "within")

tab_model(m10,m11,m12,show.ci=FALSE,show.se=TRUE,use.viewer=FALSE)
plot_summs(m10,m12, scale = FALSE,legend.title = "") + theme_tufte()
ggsave(here(paste0("output/Graphs/countynhg_1910/reg_industry_occupation.jpeg")),plot=last_plot())



plot_summs(m1,m4,m7,m10, scale = FALSE,legend.title = "") + theme_tufte()
ggsave(here(paste0("output/Graphs/countynhg_1910/reg_all_no_statefip.jpeg")),plot=last_plot())

plot_summs(m3,m6,m9,m12, scale = FALSE,legend.title = "") + theme_tufte()
ggsave(here(paste0("output/Graphs/countynhg_1910/reg_all_statefip.jpeg")),plot=last_plot())


rm(list=paste0("m",1:12))
rm(form,form1)
```
Notes:
-"scale=TRUE" standardizes the beta coefficients. This helps to display all the coefficients in the graph

## 2. Metarea_1940

### Histogram and correlation grpahs
```{r}
census_sample_1930_agg_metarea_1940 <- read_fst(here(paste0("output/Rdata/census_sample_1930_agg_metarea_1940.fst")),as.data.table=TRUE)[,MSA:=factor(ifelse(metarea_1940<1000,1,0), levels = c(0,1),labels = c("Non MSAs","MSAs"))]

# Histogram
ggplot(census_sample_1930_agg_metarea_1940, aes(x=sh_new_method1)) +
  geom_histogram(color="black",bins=25,fill="white") +
  facet_grid(MSA ~ .) +
  labs(title="",x="Share of New Work", y = "Count") +
  geom_vline(data=census_sample_1930_agg_metarea_1940[,.(sh_new_method1=mean(sh_new_method1)),by="MSA"],aes(xintercept=sh_new_method1, color=MSA),
           linetype="dashed") + 
  theme_tufte() + theme(legend.position = "none")

ggsave(here(paste0("output/Graphs/metarea_1940/histogram_share_red_tit.jpeg")),plot=last_plot())


# Some Scatterplots
# Population
ggplot(census_sample_1930_agg_metarea_1940, aes(y=sh_new_method1, x=log(perwt),color=MSA)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and population",x="Population (log)", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave(here(paste0("output/Graphs/metarea_1940/corr_pop_x_sh_new_method1.jpeg")),plot=last_plot())

# Gender
ggplot(census_sample_1930_agg_metarea_1940, aes(y=sh_new_method1, x=sh_male,color=MSA)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and male population",x="Share of Males", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave(here(paste0("output/Graphs/metarea_1940/corr_sh_male_x_sh_new_method1.jpeg")),plot=last_plot())

# Black population
ggplot(census_sample_1930_agg_metarea_1940, aes(y=sh_new_method1, x=sh_race_2,color=MSA)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and black population",x="Share of Black population", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave(here(paste0("output/Graphs/metarea_1940/corr_sh_race_2_x_sh_new_method1.jpeg")),plot=last_plot())


# Literate
ggplot(census_sample_1930_agg_metarea_1940, aes(y=sh_new_method1, x=sh_lit,color=MSA)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of literate population",x="Share of literate population", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave(here(paste0("output/Graphs/metarea_1940/corr_sh_lit_x_sh_new_method1.jpeg")),plot=last_plot())

# Labor force
ggplot(census_sample_1930_agg_metarea_1940, aes(y=sh_new_method1, x=sh_labforce_emp,color=MSA)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of labor force",x="Share of labor force", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave(here(paste0("output/Graphs/metarea_1940/corr_sh_labforce_emp_x_sh_new_method1.jpeg")),plot=last_plot())

# Working for wages
ggplot(census_sample_1930_agg_metarea_1940, aes(y=sh_new_method1, x=sh_wrkwage,color=MSA)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of population working for wages",x="Share of population working for wages", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave(here(paste0("output/Graphs/metarea_1940/corr_sh_wrkwage_x_sh_new_method1.jpeg")),plot=last_plot())

# Urban
ggplot(census_sample_1930_agg_metarea_1940, aes(y=sh_new_method1, x=sh_urban,color=MSA)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of urban population",x="Share of urban population", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave(here(paste0("output/Graphs/metarea_1940/corr_sh_urban_x_sh_new_method1.jpeg")),plot=last_plot())

# Farm
ggplot(census_sample_1930_agg_metarea_1940, aes(y=sh_new_method1, x=sh_farm,color=MSA)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of farm population",x="Share of farm population", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave(here(paste0("output/Graphs/metarea_1940/corr_sh_farm_x_sh_new_method1.jpeg")),plot=last_plot())

# Migration within the US
ggplot(census_sample_1930_agg_metarea_1940, aes(y=sh_new_method1, x=sh_mig_us,color=MSA)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of internal migrants",x="Share of internal migrants", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave(here(paste0("output/Graphs/metarea_1940/corr_sh_mig_us_x_sh_new_method1.jpeg")),plot=last_plot())

# Goreign migrants
ggplot(census_sample_1930_agg_metarea_1940, aes(y=sh_new_method1, x=sh_mig_ab,color=MSA)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of foreign migrants",x="Share of foreign migrants", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggsave(here(paste0("output/Graphs/metarea_1940/corr_sh_mig_ab_x_sh_new_method1.jpeg")),plot=last_plot())


# Industry
x <- c("sh_ind1950_main_1","sh_ind1950_main_2","sh_ind1950_main_3","sh_ind1950_main_4","sh_ind1950_main_5","sh_ind1950_main_6","sh_ind1950_main_7")
p <- vector(mode = "list", length = length(x))
for (i in 1:7) {
  p[[i]] <- ggplot(census_sample_1930_agg_metarea_1940, aes_string(y="sh_new_method1", x= x[i]),color=MSA) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="",x="Share of workers", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"), legend.position = "top")
}
ggarrange(p[[1]],p[[2]],p[[3]],p[[4]],labels=c("Agriculture","Mining-Construction","Manufacturing","Tr-Comm-Util"),
          ncol=2,nrow=2)
ggsave(here(paste0("output/Graphs/metarea_1940/corr_sh_ind1950_main_x_sh_new_method1_1.jpeg")),plot=last_plot())
ggarrange(p[[5]],p[[6]],p[[7]],labels=c("Trade","Services","Public Admin."),
          ncol=2,nrow=2)
ggsave(here(paste0("output/Graphs/metarea_1940/corr_sh_ind1950_main_x_sh_new_method1_2.jpeg")),plot=last_plot())


# Occupation
x <- c("sh_occ1950_main_0","sh_occ1950_main_100","sh_occ1950_main_200","sh_occ1950_main_300","sh_occ1950_main_400","sh_occ1950_main_500","sh_occ1950_main_600","sh_occ1950_main_700","sh_occ1950_main_730","sh_occ1950_main_800","sh_occ1950_main_900")
p <- vector(mode = "list", length = length(x))
for (i in 1:length(x)) {
  p[[i]] <- ggplot(census_sample_1930_agg_metarea_1940, aes_string(y="sh_new_method1", x= x[i]),color=MSA) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="",x="Share of workers", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"), legend.position = "top")
}
ggarrange(p[[1]],p[[2]],p[[3]],p[[4]],labels=c("Farmers","Managers, Officials/n and Proprietors","Clerical and Kindred","Sales workers"),
          ncol = 2, nrow =2)
ggsave(here(paste0("output/Graphs/metarea_1940/corr_sh_occ1950_main_x_sh_new_method1_1.jpeg")),plot=last_plot())
ggarrange(p[[5]],p[[6]],p[[7]],p[[8]],labels=c("Craftsmen","Operatives","Public Admin.","Service Workers (priv. hs.)"),
          ncol = 2, nrow =2)
ggsave(here(paste0("output/Graphs/metarea_1940/corr_sh_occ1950_main_x_sh_new_method1_2.jpeg")),plot=last_plot())
ggarrange(p[[9]],p[[10]],p[[11]],labels=c("Service Workers","Farm laborers","Laborers"),
          ncol = 2, nrow =2)
ggsave(here(paste0("output/Graphs/metarea_1940/corr_sh_occ1950_main_x_sh_new_method1_3.jpeg")),plot=last_plot())
```

### Basic regressions
```{r}
# Basic
m1 <- lm(sh_new_method1 ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab, data=census_sample_1930_agg_metarea_1940)
m2 <- lm(sh_new_method1 ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab, data=census_sample_1930_agg_metarea_1940[MSA=="Non MSAs"])
m3 <- lm(sh_new_method1 ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab, data=census_sample_1930_agg_metarea_1940[MSA=="MSAs"])

tab_model(m1,m2,m3,show.ci=FALSE,show.se=TRUE,use.viewer=FALSE)
plot_summs(m1,m2,m3, scale = TRUE) + theme_tufte()
ggsave(here(paste0("output/Graphs/metarea_1940/reg_basic.jpeg")),plot=last_plot())

# Industry variables
(indvar <- grep("^sh_ind1950_main_[^1]",names(census_sample_1930_agg_metarea_1940),value=TRUE))
#form <- reformulate(c("perwt","sh_race_1","sh_race_2","sh_lit","sh_urban","sh_farm","sh_mig_us","sh_mig_ab",indvar),response="sh_new_method1")

form <- as.formula(paste("sh_new_method1 ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab +",paste0(indvar,collapse=" + ")))

m4 <- lm(form,data=census_sample_1930_agg_metarea_1940)
m5 <- lm(form, data=census_sample_1930_agg_metarea_1940[MSA=="Non MSAs"])
m6 <- lm(form, data=census_sample_1930_agg_metarea_1940[MSA=="MSAs"])

tab_model(m4,m5,m6,show.ci=FALSE,show.se=TRUE,use.viewer=FALSE)
plot_summs(m4, m5,m6, scale = FALSE) + theme_tufte()
ggsave(here(paste0("output/Graphs/metarea_1940/reg_industry.jpeg")),plot=last_plot())


# Occupation variables
(occvar <- grep("^sh_occ1950_main_[^0]",names(census_sample_1930_agg_metarea_1940),value=TRUE))

form <- as.formula(paste("sh_new_method1 ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab +",paste0(occvar,collapse=" + ")))

m7 <- lm(form,data=census_sample_1930_agg_metarea_1940)
m8 <- lm(form, data=census_sample_1930_agg_metarea_1940[MSA=="Non MSAs"])
m9 <- lm(form, data=census_sample_1930_agg_metarea_1940[MSA=="MSAs"])

tab_model(m7,m8,m9,show.ci=FALSE,show.se=TRUE,use.viewer=FALSE)
plot_summs(m7, m8,m9, scale = FALSE) + theme_tufte()
ggsave(here(paste0("output/Graphs/metarea_1940/reg_occupation.jpeg")),plot=last_plot())


# Industry + Occupation variables
form <- as.formula(paste("sh_new_method1 ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab +",paste0(occvar,collapse=" + ")," + ",paste0(indvar,collapse=" + ")))

m10 <- lm(form,data=census_sample_1930_agg_metarea_1940)
m11 <- lm(form, data=census_sample_1930_agg_metarea_1940[MSA=="Non MSAs"])
m12 <- lm(form, data=census_sample_1930_agg_metarea_1940[MSA=="MSAs"])

tab_model(m10,m11,m12,show.ci=FALSE,show.se=TRUE,use.viewer=FALSE)
plot_summs(m10,m12, scale = FALSE,legend.title = "") + theme_tufte()
ggsave(here(paste0("output/Graphs/metarea_1940/reg_industry_occupation.jpeg")),plot=last_plot())



plot_summs(m1,m4,m7,m10, scale = FALSE,legend.title = "") + theme_tufte()
ggsave(here(paste0("output/Graphs/metarea_1940/reg_all.jpeg")),plot=last_plot())

plot_summs(m2,m5,m8,m11, scale = FALSE,legend.title = "") + theme_tufte()
ggsave(here(paste0("output/Graphs/metarea_1940/reg_all_non_MSAs.jpeg")),plot=last_plot())

plot_summs(m3,m6,m9,m12, scale = FALSE,legend.title = "") + theme_tufte()
ggsave(here(paste0("output/Graphs/metarea_1940/reg_all_MSAs.jpeg")),plot=last_plot())

rm(list=paste0("m",1:12))
```



# Part 2. Data Analysis focused on the new titles
Here we look more in depth at the share of "new titles" in different industries and occupations 

## 1. Industries/Occupations and new titles

### 1.1. Functions
#### Function to create industry variable
```{r}
# Function to construct the data.table with information at the industry level
# This code works by using a given (unchanged) name for some variables inside the code and by changing the name of argument var (and "var"_name)
# to those inside variables and then reverting to the original variables
# Note: Here we are using non-standard evaluation
f_ind_new_titles <- function(X,id_N,var=ind,sh_v,w_v=perwt,occind_v=occind,names=NULL) {
  y <- copy(X)

  # Through the code we will simply use varp as the variable
  setnames(y, c(deparse(substitute(var)),deparse(substitute(sh_v)),deparse(substitute(w_v)),deparse(substitute(occind_v))), c("varp","sh_new","perwt","occind")) 
  
  
  # Computing the different things
      y <- y[,`:=`(sh_new=perwt*sh_new)][,lapply(.SD,sum),by=c("varp","occind"),.SDcols=c("perwt","sh_new")][,c("sum_new","emp"):=lapply(.SD,sum),by="varp",.SDcols=c("sh_new","perwt")][,`:=`(sh_occ=perwt/emp,sh_new_occ=sh_new/sum_new)]
  
  setorderv(y,   c("varp" ,"sh_new_occ"),c(1,-1) )
  y <- y[,id:=1:.N,by="varp"][id<=id_N][,sh_new:=sh_new/emp][,sh_new:=sum_new/emp][,c("perwt","sum_new"):=NULL]
    
  y <- data.table::dcast(y, varp + sh_new + emp  ~ id, value.var = c("occind","sh_new_occ","sh_occ") )
    
  
  if (!is.null(names)) {
    # It seems that the names argument doesn't get changed by reference, so we don't need    "names <- copy(names)"
    setnames(names, c(deparse(substitute(var)), paste0(substitute(var),"_name")  ), c("varp","varp_name")  )
  
    y <- merge(y,names,by="varp",all.x=TRUE,all.y=FALSE)
    
    # Reorder columns so that we have the industry code and name  
    if(!is.null(names$varp_name)) {
       idcols <- c("varp","varp_name"); cols <- c(idcols, names(y)[-which(names(y) %in% idcols)])
       setcolorder(y, cols)
    }
    setnames(y, c("varp_name"), c( paste0(substitute(var),"_name")   )) 
  }
  setorderv(y,c("sh_new",  "varp")  ,  c(-1,1)  )
  setnames(y, c("varp","sh_new"),
           c(deparse(substitute(var)),deparse(substitute(sh_v)))
           ) 
  
}
```
In the IPUMS sample the ind variable is missing for many workers. This is not the case for ind1950. It might be better to use the ind1950 variable instead of the ind one.

#### Function to create occupations and new titles
```{r}
# Function to construct the data.table with information at the occupation level
 # NOte: FOr now we don't use different occ codes as the new titles are only created using occind
  
f_occ_new_titles <- function(X,id_N,ind_v=ind,sh_v,w_v=perwt,occind_v=occind,names=NULL,occind_n,occind_name_n) {
  # Avoids confusion with variable ind
  y <- copy(X)
  #print(y)
  # Through the code we will simply use varp as the variable
  setnames(y, c(deparse(substitute(ind_v)),deparse(substitute(sh_v)),deparse(substitute(w_v)),deparse(substitute(occind_v))), c("v_ind","sh_new","perwt","occind")) 

  # Computing the different things
  y <- y[,lapply(.SD,sum),by=c("occind","sh_new","v_ind"),.SDcols=c("perwt")][,c("emp_occ"):=lapply(.SD,sum),by=c("occind","sh_new"),.SDcols=c("perwt")][,`:=`(sh_ind=perwt/emp_occ)]
  setorder(y,occind,-sh_ind)
  y <- y[,id:=1:.N,by="occind"][id<=id_N][,c("perwt"):=NULL]
  
  setnames(y, c("v_ind"), c(deparse(substitute(ind_v))) ) 
  # Since the variables in value.var are given as characters I can easily use var_ch. That way I have the correct name for the wide variable
  y <- data.table::dcast(y, occind + sh_new + emp_occ  ~ id, value.var = c(deparse(substitute(ind_v)),"sh_ind") )
  
  if (!is.null(names)) {
    
    setnames(names, c( deparse(substitute(occind_n) ), deparse(substitute(occind_name_n))  ), c("occind","occind_name")  )
    
    y <- merge(y,names,by="occind",all.x=TRUE,all.y=FALSE)
    
    idcols <- c("occind","occind_name"); cols <- c(idcols, names(y)[-which(names(y) %in% idcols)])  
    setcolorder(y, cols)
    
  }
  setorder(y,-sh_new,occind)
  
  setnames(y, c("occind","sh_new","occind_name"),
           c(deparse(substitute(occind_v)),deparse(substitute(sh_v)),deparse(substitute(occind_name_n)))
           ) 
}

```

### 1.2. Creating sample of interest
#### New occuaption variables
```{r}
occ1930.codes <- as.data.table( read_excel(here(paste0("input/1930 - Cleaned.xlsx")), sheet = "1930 main groups",guess_max=10000) )[,!c("occ_ini_1930","occ1930","occ_name")]

new_titles.occind1930 <- list(
                                read_fst(here(paste0("output/Rdata/new_titles_1930_by_occind.fst")),as.data.table=TRUE),
                                read_fst(here(paste0("output/Rdata/new_titles_1930_by_occind.all.fst")),as.data.table=TRUE)
)

new_titles.occind1930[[1]] <- merge(new_titles.occind1930[[1]],occ1930.codes[,c("occind1930","occind1930_name","occ","ind","occind","flag")],by="occind1930",all=TRUE)
new_titles.occind1930[[2]] <- merge(new_titles.occind1930[[2]],occ1930.codes[,c("occind1930","occind1930_name","occ","ind","occind","flag")],by="occind1930",all=TRUE)
```


```{r}
census_sample_1930_ind_occ_table <- read_fst(here(paste0("input/census_sample/census_sample_1930.fst")),as.data.table=TRUE,columns=c("perwt","occ1950","occ","occind","ind","ind1950"))[!(occ %in% c(998,999)) & (ind1950 >=1 & ind1950<=990)]

census_sample_1930_ind_occ_table <-  merge(census_sample_1930_ind_occ_table,new_titles.occind1930[[1]][,c("occind","sh_base","sh_base_tit","sh_base_titind","sh_red","sh_new_method1","sh_new_method1ind")],by="occind",all=FALSE)[,perwt_sum:=sum(perwt),by=c("occ1950","occ","occind","ind","ind1950")][,lapply(.SD,weighted.mean,w=perwt),by=c("occ1950","occ","occind","ind","ind1950"),.SDcols=c("perwt_sum","sh_base","sh_base_tit","sh_base_titind","sh_red","sh_new_method1","sh_new_method1ind")]
setnames(census_sample_1930_ind_occ_table,"perwt_sum","perwt")
```

### 1.3 Creating tables of interest

### Calling names of industries and occupations
```{r}
ind1950.codes <- as.data.table( read_excel(here(paste0("input/1930 - Cleaned.xlsx")), sheet = "ind1950",guess_max=10000) )

occ1930.codes <- as.data.table( read_excel(here(paste0("input/1930 - Cleaned.xlsx")), sheet = "1930 main groups",guess_max=10000) )[,!c("occ_ini_1930","occ1930","occ_name")]

occ1950.codes <- as.data.table( read_excel(here(paste0("input/1930 - Cleaned.xlsx")), sheet = "occ1950",guess_max=10000) )
```


### Creating and exporting tables
```{r}
census_sample_1930_ind1950_table <- f_ind_new_titles(census_sample_1930_ind_occ_table,id_N=5,var=ind1950,sh_v=sh_base_tit,occind_v=occind,names=ind1950.codes[,c("ind1950","ind1950_name")])    
census_sample_1930_occ_table <- f_occ_new_titles(census_sample_1930_ind_occ_table,id_N=5,ind_v=ind1950,sh_v=sh_base_tit,w_v=perwt,occind_v=occind,names=occ1930.codes[,c("occind","occind1930_name")],occind_n = occind,occind_name_n = occind1930_name)


```


## 2. Locations and new titles
### 2.1. Functions
```{r}
f_location_new_titles <- function(X,sh_v,w_v=perwt,geof1_v,geof2_v,merge_geof,geof_m,geof_final1_m,geof_final2_m,share_m) {
  # Avoids confusion with variable ind
  y <- copy(X)
  #print(y)
  # Through the code we will simply use varp as the variable
  setnames(y, c(deparse(substitute(sh_v)),deparse(substitute(w_v)),deparse(substitute(geof1_v))), c("sh_new","perwt","geof1"))
  
  if (!missing(merge_geof)) {
    m_geof <- copy(merge_geof)
    setnames(m_geof, c( deparse(substitute(geof_m) ), deparse(substitute(geof_final1_m)),deparse(substitute(share_m))  ), c("geof1","geof_final1","sh_m")  )
    
    y <- merge(y,m_geof,by="geof1",all.x=TRUE,all.y=FALSE,allow.cartesian=TRUE)
    y <- y[,perwt:=perwt*sh_m][,sh_new:=perwt*sh_new][,sh_m:=NULL]
    
    if (!missing(geof_final2_m)) {
      setnames(y, c( deparse(substitute(geof_final2_m)) ), c("geof_final2")  )
       
      y <- y[,lapply(.SD,sum),by=c("geof_final1","geof_final2"),.SDcols=c("perwt","sh_new")][,sh_new:=sh_new/perwt]
       
       y <- y[,c("geof_final1","geof_final2","perwt","sh_new")]
       setnames(y, c("geof_final1","geof_final2","perwt","sh_new"), c(deparse(substitute(geof_final1_m)),deparse(substitute(geof_final2_m)),deparse(substitute(w_v)),deparse(substitute(sh_v))))
    } else {
       y <- y[,lapply(.SD,sum),by=c("geof_final1"),.SDcols=c("perwt","sh_new")][,sh_new:=sh_new/perwt]
       y <- y[,c("geof_final1","perwt","sh_new")]
       setnames(y, c("geof_final1","perwt","sh_new"), c(deparse(substitute(geof_final1_m)),deparse(substitute(w_v)),deparse(substitute(sh_v))))
    }
    
    
    
  } else {
    y <- y[,sh_new:=perwt*sh_new]
    
    if (!missing(geof2_v)) {
      setnames(y, deparse(substitute(geof2_v)), c("geof2"))
      y <- y[,lapply(.SD,sum),by=c("geof1","geof2"),.SDcols=c("perwt","sh_new")][,sh_new:=sh_new/perwt] 
      y <- y[,c("geof1","geof2","perwt","sh_new")]
      setnames(y, c("geof1","geof2","perwt","sh_new"), c(deparse(substitute(geof1_v)),deparse(substitute(geof2_v)),deparse(substitute(w_v)),deparse(substitute(sh_v))))
    } else {
      y <- y[,lapply(.SD,sum),by=c("geof1"),.SDcols=c("perwt","sh_new")][,sh_new:=sh_new/perwt] 
      y <- y[,c("geof1","perwt","sh_new")]
      setnames(y, c("geof1","perwt","sh_new"), c(deparse(substitute(geof1_v)),deparse(substitute(w_v)),deparse(substitute(sh_v))))
    }
  }
  y <- na.omit(y)
} 
```

### 2.2. Preparing the data
#### Data at the county level (county 1910)
We can simply use the aggregated county level data created in Part 1.
```{r}
new_title_location.countynhg_1910_more1000 <- read_fst(here(paste0("output/Rdata/census_sample_1930_agg_countynhg_1910.fst")),as.data.table=TRUE,columns=c("countynhg_1910","perwt","sh_base","sh_base_tit","sh_base_titind","sh_red","sh_new_method1","sh_new_method1ind"))[perwt>=1000 & !is.na(countynhg_1910)]

new_title_location.countynhg_1910_more10000 <- read_fst(here(paste0("output/Rdata/census_sample_1930_agg_countynhg_1910.fst")),as.data.table=TRUE,columns=c("countynhg_1910","perwt","sh_base","sh_base_tit","sh_base_titind","sh_red","sh_new_method1","sh_new_method1ind"))[perwt>=10000 & !is.na(countynhg_1910)]

```

#### Data at the metarea level
For the mapping we aggregate MSAs and those non-dentified MSAs we aggregate by state.
We use a dataset previously created that contains the share of new titles by occind, countynhg, countynhg_1910, metarea_1940. 
** We could use the data aggregated at the MSA level once we know how to combine counties in the map function
```{r}
new_titles_agg <- read_fst(here(paste0("output/Rdata/new_titles_agg.fst")),as.data.table=TRUE)

new_title_location.metarea_1940 <- new_titles_agg[!is.na(metarea_1940) & !is.na(countynhg_1910),!c("occind")][,perwt_sum:=sum(perwt),by=c("countynhg_1910","metarea_1940")][,lapply(.SD,weighted.mean,w=perwt),by=c("countynhg_1910","metarea_1940"),.SDcols=c("perwt_sum","sh_base","sh_base_tit","sh_base_titind","sh_red","sh_new_method1","sh_new_method1ind")]

# If a county is repeated ( e.g. because one part belongs to an MSA and another to another), keep the county with the largest population
setorderv(new_title_location.metarea_1940,c("countynhg_1910","perwt_sum"),c(1,-1))
new_title_location.metarea_1940 <- new_title_location.metarea_1940[,.SD[1],by=c("countynhg_1910"),.SDcols=c("metarea_1940","perwt_sum","sh_base","sh_base_tit","sh_base_titind","sh_red","sh_new_method1","sh_new_method1ind")]

# Counties within the same MSA have the same value for the variables
new_title_location.metarea_1940 <- new_title_location.metarea_1940[,perwt:=sum(perwt_sum),by=c("metarea_1940")][,c("perwt","sh_base","sh_base_tit","sh_base_titind","sh_red","sh_new_method1","sh_new_method1ind"):=lapply(.SD,weighted.mean,w=perwt_sum),by=c("metarea_1940"),.SDcols=c("perwt_sum","sh_base","sh_base_tit","sh_base_titind","sh_red","sh_new_method1","sh_new_method1ind")]

```



### 2.4. Mapping
#### 2.4.1. Import and subset shape files
```{r}
# Importing shp file 
# 1 Option
map.cty <- st_read(here(paste0("input/shapefiles/shapefile_us_county_1910")), quiet = TRUE)


map.state <- st_read(here(paste0("input/shapefiles/shapefile_us_state_1910")), quiet = TRUE)

if (FALSE) {
# 2 option
map.cty <- read_sf(dsn=here(paste0("input/shapefiles/shapefile_us_county_1910")))

# 3 option
# NOTE requires the data_file
map.state <- read_nhgis_sf(
  data_file = here(paste0("input/shapefiles/nhgis0006_csv")),
  shape_file = here(paste0("input/shapefiles/nhgis0006_shape.zip"))
)
}
#subsetting it and dropping Alaska and Hawaii
map.cty <- subset(map.cty,select=c(GISJOIN2,STATENAM,geometry))
map.cty <- subset(map.cty, STATENAM !="Alaska Territory" & STATENAM != "Hawaii Territory")
map.cty$GISJOIN2 <- as.numeric(map.cty$GISJOIN2)
map.state <- subset(map.state,select=c(GISJOIN2,STATENAM,geometry))
map.state <- subset(map.state, STATENAM !="Alaska Territory" & STATENAM != "Hawaii Territory")


map.state_1 <- st_read(here(paste0("input/shapefiles/shapefile_us_state_1910")), quiet = TRUE)
map.state_1 <- subset(map.state_1, STATENAM !="Alaska Territory" & STATENAM != "Hawaii Territory")

```


#### 2.4.2. Join with info for population and share of new work

##### countynhg_1910
```{r}
# More than 10000 inhabitants
setnames(new_title_location.countynhg_1910_more10000,c("countynhg_1910"),c("GISJOIN2"))

map.countynhg_1910_more10000 <-
  merge(map.cty,new_title_location.countynhg_1910_more10000,by="GISJOIN2",all.x=TRUE,all.y=FALSE)

png(here("output/Maps/1930/sh_new_method1_1930_countynhg_1910_p10000.png"),900,900*2/3)  
tm_shape(map.countynhg_1910_more10000) + tm_fill("sh_new_method1",title="Share of New Work",palette="viridis",n=7,style="quantile",colorNA=NULL) +
tm_shape(map.state) + tm_borders(alpha=0.1,lwd=0.5) 
dev.off()  

png(here("output/Maps/1930/sh_new_method1_1930_countynhg_1910_p1000.png"),900,900*2/3)  
tm_shape(map.countynhg_1910_more1000) + tm_fill("sh_new_method1",title="Share of New Work",palette="viridis",n=7,style="quantile",colorNA=NULL) +
tm_shape(map.state) + tm_borders(alpha=0.1,lwd=0.5) 
dev.off()  

t <- tm_shape(map.countynhg_1910_more10000) + tm_fill("sh_new_method1",title="Share of New Work",palette="viridis",n=7,style="quantile",colorNA=NULL)
tmap_save(t,filename=here("output/Maps/paper.png"),height=4,width=6,units="in",dpi=100)

#*** NOTE *** The more straightforward way to export a map created with tm is to use tmap_save(). Nonetheless with this option it takes a very long time to create the map (e.g. the county map without the state lines took 848 secs vs. less than 100 using png()). For now I use a faster way, eventhough the maps don't look as good as with tmap_save
```

##### metarea_1940
```{r}
setnames(new_title_location.metarea_1940,c("countynhg_1910"),c("GISJOIN2"))
map.metarea <- merge(map.cty,new_title_location.metarea_1940,by="GISJOIN2",all.x=TRUE,all.y=FALSE)
metarea <- tm_shape(subset(map.metarea)) + tm_polygons("sh_base_tit",style = "pretty", n=10,lwd=0) +
  tm_shape(map.state) + tm_borders(alpha=0.1,lwd=0.5)
tmap_save(metarea, here(paste0("output/Maps/sh_new_occupations_metarea_1940.jpeg")))
rm(metarea)
```


# Part 3. Data Analysis using individual level observations
Here we study the main characteristics of persons employed in new work. 
We construct scatterplots to see the relationship between different individual level characteristics and the likelihood of being employed in a new occupaiton
*** TO-DO: Include here the individual level regressions.

```{r}
census_sample_1930_individual_data <- read_fst(here(paste0("output/Rdata/census_sample_1930_individual_data.fst")),as.data.table=TRUE)
```


## 1.  Basic Plots of the different variables
### 1.1. Scatter (binned) plots
```{r}
y <- c("urban","farm","ownershp","famsize","male","lit","marst","age","mig_us","mig_ab","m_mig_us","m_mig_ab","f_mig_us","f_mig_ab")
for (i in 1:length(y)) {
  setnames(census_sample_1930_individual_data,y[i],c("v_plot"))
  p <- ggplot(census_sample_1930_individual_data[,c("sh_base_tit","v_plot")], aes_string(x="sh_base_tit",y="v_plot")) +
    geom_point(size=0.5) +
    stat_summary_bin(fun='mean', bins=10,
                     color='orange', size=4, geom='point') + labs(title=paste0(y[i]," x Share of New Work (sh_base_tit)"),x="Share of New Work", y = y[i]) + theme_tufte() 
  ggsave(paste0(here(paste0("output/Graphs/individual_basic_plots/corr_sh_base_tit_x_",y[i],".jpeg"))),plot=p)
  setnames(census_sample_1930_individual_data,c("v_plot"),y[i])
}

```


# Part 4. Map with share of new sector + Histograms with shares of new sectors
## 1. countynhg_1910
### 1.1. Call individual level data
```{r}
census_sample_1930_individual_data <-read_fst(here(paste0("output/Rdata/census_sample_1930_individual_data_x_countynhg_1910.fst")),as.data.table=TRUE)
```

### 1.2. Database for histogram and map
```{r}
new_sectors_countynhg_1910 <- census_sample_1930_individual_data[,.SD[1],by=c("countynhg_1910"),.SDcols=c("perwt_1920","new_sec_all_1920","new_sec_main_1920","new_sec_serv_1920","perwt_1930","new_sec_all_1930","new_sec_main_1930","new_sec_serv_1930","rank_new_sec_1920","rank_new_sec_1930")]
```

### 1.3. Histogram
- Share of New Sector in 1920 and 1930 (excluding counties with highest shares of new sectors)
```{r}
p <- vector(mode = "list")
# 1920
p[[1]] <- ggplot(new_sectors_countynhg_1910[perwt_1920>=10000], aes(x=new_sec_all_1920)) +
  geom_histogram(color="black",bins=40,  aes(y = stat(width*density)),  fill="white") +
  scale_y_continuous(labels = percent_format()) +
  labs(title="",x="Share of New Sector", y = "")  + 
  theme_tufte() + theme(legend.position = "none")
ggsave(here(paste0("output/Graphs/countynhg_1910/histogram_share_new_sec_1920.jpeg")),plot=last_plot())

p[[2]] <- ggplot(new_sectors_countynhg_1910[perwt_1930>=10000], aes(x=new_sec_all_1930)) +
  geom_histogram(color="black",bins=40,  aes(y = stat(width*density)),fill="white") +
  scale_y_continuous(labels = percent_format()) +
  labs(title="",x="Share of New Sector", y = "")  + 
  theme_tufte() + theme(legend.position = "none")

ggsave(here(paste0("output/Graphs/countynhg_1910/histogram_share_new_sec_1930.jpeg")),plot=last_plot())

# Excluding counties with the highest share of new sectors
j <- 3
for (i in c(3,5,10,20,50,100,200)) {
  p[[j]] <- ggplot(new_sectors_countynhg_1910[perwt_1920>=10000 & rank_new_sec_1920>=i], aes(x=new_sec_all_1920)) +
    geom_histogram(color="black",bins=40,  aes(y = stat(width*density)),  fill="white") +
    scale_y_continuous(labels = percent_format()) +
    labs(title="",x="Share of New Sector", y = "")  + 
    theme_tufte() + theme(legend.position = "none")
  p[[j+1]] <- ggplot(new_sectors_countynhg_1910[perwt_1930>=10000 & rank_new_sec_1930>=i], aes(x=new_sec_all_1930)) +
    geom_histogram(color="black",bins=40,  aes(y = stat(width*density)),  fill="white") +
    scale_y_continuous(labels = percent_format()) +
    labs(title="",x="Share of New Sector", y = "")  + 
    theme_tufte() + theme(legend.position = "none")
  j <- j+2 
}

ggarrange(p[[1]], p[[3]], p[[5]], p[[7]],
          labels = c("All", "Excl. 2", "Excl. 4", "Excl. 9"),
          ncol = 2, nrow = 2)
ggsave(here(paste0("output/Graphs/countynhg_1910/histogram_share_new_sec_1920_excluding_regions_1.jpeg")),plot=last_plot())
ggarrange(p[[9]], p[[11]], p[[13]], p[[15]],
          labels = c("Excl. 19", "Excl. 49", "Excl. 99", "Excl. 199"),
          ncol = 2, nrow = 2)
ggsave(here(paste0("output/Graphs/countynhg_1910/histogram_share_new_sec_1920_excluding_regions_2.jpeg")),plot=last_plot())

ggarrange(p[[2]], p[[4]], p[[6]], p[[8]],
          labels = c("All", "Excl. 2", "Excl. 4", "Excl. 9"),
          ncol = 2, nrow = 2)
ggsave(here(paste0("output/Graphs/countynhg_1910/histogram_share_new_sec_1930_excluding_regions_1.jpeg")),plot=last_plot())
ggarrange(p[[10]], p[[12]], p[[14]], p[[16]],
          labels = c("Excl. 19", "Excl. 49", "Excl. 99", "Excl. 199"),
          ncol = 2, nrow = 2)
ggsave(here(paste0("output/Graphs/countynhg_1910/histogram_share_new_sec_1930_excluding_regions_2.jpeg")),plot=last_plot())


# DELETE LATER - Graphs for presentation
ggarrange(p[[1]], p[[3]], p[[11]], p[[13]],
          labels = c("All", "Excl. 4", "Excl. 49", "Excl. 99"),
          ncol = 2, nrow = 2)
ggsave(here(paste0("output/Graphs/countynhg_1910/histogram_share_new_sec_1920_excluding_regions_3-DELETE.jpeg")),plot=last_plot())
ggarrange(p[[2]], p[[4]], p[[12]], p[[14]],
          labels = c("All", "Excl. 4", "Excl. 49", "Excl. 99"),
          ncol = 2, nrow = 2)
ggsave(here(paste0("output/Graphs/countynhg_1910/histogram_share_new_sec_1930_excluding_regions_3-DELETE.jpeg")),plot=last_plot())

rm(p)
```

### 1.4. Map
- Share of New Sector

#### Import and subset shape files
```{r}
# Importing shp file 
# 1 Option
map.cty <- st_read(here(paste0("input/shapefiles/shapefile_us_county_1910")), quiet = TRUE)


map.state <- st_read(here(paste0("input/shapefiles/shapefile_us_state_1910")), quiet = TRUE)

if (FALSE) {
# 2 option
map.cty <- read_sf(dsn=here(paste0("input/shapefiles/shapefile_us_county_1910")))

# 3 option
# NOTE requires the data_file
map.state <- read_nhgis_sf(
  data_file = here(paste0("input/shapefiles/nhgis0006_csv")),
  shape_file = here(paste0("input/shapefiles/nhgis0006_shape.zip"))
)
}
#subsetting it and dropping Alaska and Hawaii
map.cty <- subset(map.cty,select=c(GISJOIN2,STATENAM,geometry))
map.cty <- subset(map.cty, STATENAM !="Alaska Territory" & STATENAM != "Hawaii Territory")
map.cty$GISJOIN2 <- as.numeric(map.cty$GISJOIN2)
map.state <- subset(map.state,select=c(GISJOIN2,STATENAM,geometry))
map.state <- subset(map.state, STATENAM !="Alaska Territory" & STATENAM != "Hawaii Territory")

```

#### Join with info for share of new sector

##### countynhg_1910
```{r}
#1920
setnames(new_sectors_countynhg_1910,c("countynhg_1910"),c("GISJOIN2"))
map.countynhg_1910 <- merge(map.cty,new_sectors_countynhg_1910,by="GISJOIN2",all.x=TRUE,all.y=FALSE)
county <- tm_shape(subset(map.countynhg_1910)) + tm_polygons("new_sec_all_1920",style = "pretty", n=10,lwd=0) +
  tm_shape(map.state) + tm_borders(alpha=0.1,lwd=0.5)
tmap_save(county, here(paste0("output/Maps/sh_new_sector_all_countynhg_1910.jpeg")))
rm(county)

#1930
county <- tm_shape(subset(map.countynhg_1910)) + tm_polygons("new_sec_all_1930",style = "pretty", n=10,lwd=0) +
  tm_shape(map.state) + tm_borders(alpha=0.1,lwd=0.5)
tmap_save(county, here(paste0("output/Maps/sh_new_sector_1930_all_countynhg_1910.jpeg")))
rm(county)
```

## 2. metarea_1940
### 2.1. Call individual level data
```{r}
census_sample_1930_individual_data <-read_fst(here(paste0("output/Rdata/census_sample_1930_individual_data_x_metarea_1940.fst")),as.data.table=TRUE)
```

### 2.2. Database for histogram and map
```{r}
new_sectors_metarea_1940 <- census_sample_1930_individual_data[,.SD[1],by=c("metarea_1940"),.SDcols=c("perwt_1920","new_sec_all_1920","new_sec_main_1920","new_sec_serv_1920","perwt_1930","new_sec_all_1930","new_sec_main_1930","new_sec_serv_1930","rank_new_sec_1920","rank_new_sec_1930")]
```

### 2.3. Histogram
- Share of New Sector in 1920 and 1930 (excluding counties with highest shares of new sectors)
```{r}
p <- vector(mode = "list")
# 1920
p[[1]] <- ggplot(new_sectors_metarea_1940[perwt_1920>=10000], aes(x=new_sec_all_1920)) +
  geom_histogram(color="black",bins=40,  aes(y = stat(width*density)),  fill="white") +
  scale_y_continuous(labels = percent_format()) +
  labs(title="",x="Share of New Sector", y = "")  + 
  theme_tufte() + theme(legend.position = "none")
ggsave(here(paste0("output/Graphs/metarea_1940/histogram_share_new_sec_1920.jpeg")),plot=last_plot())

p[[2]] <- ggplot(new_sectors_metarea_1940[perwt_1930>=10000], aes(x=new_sec_all_1930)) +
  geom_histogram(color="black",bins=40,  aes(y = stat(width*density)),fill="white") +
  scale_y_continuous(labels = percent_format()) +
  labs(title="",x="Share of New Sector", y = "")  + 
  theme_tufte() + theme(legend.position = "none")

ggsave(here(paste0("output/Graphs/metarea_1940/histogram_share_new_sec_1930.jpeg")),plot=last_plot())

# Excluding counties with the highest share of new sectors
j <- 3
for (i in c(3,5,10)) {
  p[[j]] <- ggplot(new_sectors_metarea_1940[perwt_1920>=10000 & rank_new_sec_1920>=i], aes(x=new_sec_all_1920)) +
    geom_histogram(color="black",bins=40,  aes(y = stat(width*density)),  fill="white") +
    scale_y_continuous(labels = percent_format()) +
    labs(title="",x="Share of New Sector", y = "")  + 
    theme_tufte() + theme(legend.position = "none")
  p[[j+1]] <- ggplot(new_sectors_metarea_1940[perwt_1930>=10000 & rank_new_sec_1930>=i], aes(x=new_sec_all_1930)) +
    geom_histogram(color="black",bins=40,  aes(y = stat(width*density)),  fill="white") +
    scale_y_continuous(labels = percent_format()) +
    labs(title="",x="Share of New Sector", y = "")  + 
    theme_tufte() + theme(legend.position = "none")
  j <- j+2 
}

ggarrange(p[[1]], p[[3]], p[[5]], p[[7]],
          labels = c("All", "Excl. 2", "Excl. 4", "Excl. 9"),
          ncol = 2, nrow = 2)
ggsave(here(paste0("output/Graphs/metarea_1940/histogram_share_new_sec_1920_excluding_regions_1.jpeg")),plot=last_plot())

ggarrange(p[[2]], p[[4]], p[[6]], p[[8]],
          labels = c("All", "Excl. 2", "Excl. 4", "Excl. 9"),
          ncol = 2, nrow = 2)
ggsave(here(paste0("output/Graphs/metarea_1940/histogram_share_new_sec_1930_excluding_regions_2.jpeg")),plot=last_plot())

rm(p)
```

### 1.4. Map
- Share of New Sector

#### Import and subset shape files
```{r}
# Importing shp file 
# 1 Option
map.cty <- st_read(here(paste0("input/shapefiles/shapefile_us_county_1910")), quiet = TRUE)

map.state <- st_read(here(paste0("input/shapefiles/shapefile_us_state_1910")), quiet = TRUE)

if (FALSE) {
# 2 option
map.cty <- read_sf(dsn=here(paste0("input/shapefiles/shapefile_us_county_1910")))

# 3 option
# NOTE requires the data_file
map.state <- read_nhgis_sf(
  data_file = here(paste0("input/shapefiles/nhgis0006_csv")),
  shape_file = here(paste0("input/shapefiles/nhgis0006_shape.zip"))
)
}
#subsetting it and dropping Alaska and Hawaii
map.cty <- subset(map.cty,select=c(GISJOIN2,STATENAM,geometry))
map.cty <- subset(map.cty, STATENAM !="Alaska Territory" & STATENAM != "Hawaii Territory")
map.cty$GISJOIN2 <- as.numeric(map.cty$GISJOIN2)
map.state <- subset(map.state,select=c(GISJOIN2,STATENAM,geometry))
map.state <- subset(map.state, STATENAM !="Alaska Territory" & STATENAM != "Hawaii Territory")

```

#### Join with info for share of new sector
##### metarea_1940
```{r}
setnames(new_sectors_metarea_1940,c("metarea_1940"),c("GISJOIN2"))
map.metarea_1940 <- merge(map.cty,new_sectors_metarea_1940,by="GISJOIN2",all.x=TRUE,all.y=FALSE)

county <- tm_shape(subset(map.metarea_1940)) + tm_polygons("new_sec_all_1920",style = "pretty", n=10,lwd=0) +
  tm_shape(map.state) + tm_borders(alpha=0.1,lwd=0.5)
tmap_save(county, here(paste0("output/Maps/sh_new_sector_1920_all_metarea_1940.jpeg")))
rm(county)

county <- tm_shape(subset(map.metarea_1940)) + tm_polygons("new_sec_all_1930",style = "pretty", n=10,lwd=0) +
  tm_shape(map.state) + tm_borders(alpha=0.1,lwd=0.5)
tmap_save(county, here(paste0("output/Maps/sh_new_sector_1930_all_metarea_1940.jpeg")))
rm(county)
```



# Part 5. Regressions following Lin (2011)

## 0. Functions used in this section
### 0.1. Functions related to regressions
#### Function to export results
```{r}
f_reg_results <- function(Regresults,arg_round=4) {
  # NOTES:
  # Regresults: data.table with 5 columns. (1) Name of variables, (2) Regression coefficient, (3) Standard value, (4) T-Value, (5) P_value
  # Arg_round: number of significance digits. 4 bu default
  
  #sig_10 <- qt(p=.1/2,df=arg_df,lower.tail=FALSE)
  #sig_5  <- qt(p=.05/2,df=arg_df,lower.tail=FALSE)
  #sig_1  <- qt(p=.01/2,df=arg_df,lower.tail=FALSE)
  X <- copy(Regresults)
  setnames(X,c(2,3,4,5),c("coef","std","t_value","p_value"))
  X[,coef_star:=ifelse(p_value>0.1,format(round(coef,arg_round),nsmall=2),ifelse(p_value>0.05,paste0(format(round(coef,arg_round),nsmall=2),"*"),ifelse(p_value>0.01,paste0(format(round(coef,arg_round),nsmall=2),"**"),paste0(format(round(coef,arg_round),nsmall=2),"***"))))]
  #coef.J[,coef_star:=ifelse(x==1,paste0(format(round(coef,arg_round),nsmall=2),"***"),ifelse(x==5,paste0(format(round(coef,arg_round),nsmall=2),"**"),ifelse(x==10,paste0(format(round(coef,arg_round),nsmall=2),"*"),format(round(coef,arg_round),nsmall=2))))]
  X[,std_par:=paste0("(",format(round(std,arg_round),nsmall=2),")")]
  return(X)
}
```

#### Function to perform a set of regressions
This function works with methods lm and lm_robust
TO-DO
- Allow the possibility of not specifying weights
- For lm_robust need to specify the possibility of not using clusters
```{r}
f_regressions <- function(arg_formula,arg_data,arg_weights,method,arg_clusters,to_iter = 1000, by_iter = 10) {
  # Arguments:
  #           - arg_formula: list with the set of regressions formulas
  #           - arg_data: dataset with the variables in arg_formula
  #           - arg_weights: variable contianing the weights used in the regression
  #           - method: either "lm" or "lm_robust"
  #           - arg_clusters: Variable used to cluster standard errors
  #           - iter_vec: vector containing the numbers of the iteration that you want to be displayed
  
  # Note1: There is a conflict if arg_formula is not a list. E.g. if you create a list (LS) but in arg_formula you introduce LS[[i]], the function will try to subset it and that will give an error. If that is the case introduce it as a list, e.g. list(LS[[i]])
  
  # Note2: Instead of copying arg_data I decided to change the names back to their original names at the end of the function.
  iter_vec <- seq(from =0, to = to_iter, by = by_iter)
  i <- 1
  ## IF argument ARG_WEIGHTS is specified
  if (!missing(arg_weights)) {
    setnames(arg_data,c(deparse(substitute(arg_weights))),c("arg_w"))
    if (i %in% iter_vec) {
      tic(paste0("Iteration ",i," to ",min(i+by_iter-1,length(arg_formula))))
      i0 <- i + by_iter -1
    }
    if (method=="lm") {
      A <- summary(lm(arg_formula[[1]],data=arg_data,weights=arg_w,model=FALSE))
      other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(length(A$residuals),format(round(A$adj.r.squared,4),nsmall=2)),unname(A$fstatistic)))
    } else if (method=="lm_robust") {
      setnames(arg_data,c(deparse(substitute(arg_clusters))),c("arg_cl"))
      A <- summary(lm_robust(arg_formula[[1]],weights=arg_w,clusters=arg_cl,se_type='stata',data=arg_data))
      other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(A$nobs,format(round(A$adj.r.squared,4),nsmall=2)),unname(A$fstatistic)))
    }
    coef <- f_reg_results( data.table(A$coefficients[,1:4],keep.rownames=TRUE), arg_round=4 )
    coef <- melt(coef,id.vars = c("rn"), measure.vars = c("coef","std","t_value","p_value","coef_star","std_par"),value.name=c(paste0("model_",1)))
    coef <- rbind(coef,other)
    if (i == i0) toc()
    rm(A,other)
    
    if (length(arg_formula)>1) {
      for (i in 2:length(arg_formula)) {
        if (i %in% iter_vec) {
          tic(paste0("Iteration ",i," to ",min(i+by_iter-1,length(arg_formula))))
          i0 <- i+by_iter -1
        }
        if (method=="lm") {
          A <- summary(lm(arg_formula[[i]],data=arg_data,weights=arg_w,model=FALSE))
          other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(length(A$residuals),format(round(A$adj.r.squared,4),nsmall=2)),unname(A$fstatistic)))
          setnames(other,c(3),c(paste0("model_",i)))
        } else if (method=="lm_robust") {
          A <- summary(lm_robust(arg_formula[[i]],weights=arg_w,clusters=arg_cl,se_type='stata',data=arg_data))
          other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(A$nobs,format(round(A$adj.r.squared,4),nsmall=2)),unname(A$fstatistic)))
          setnames(other,c(3),c(paste0("model_",i)))
        }
        
        t <- f_reg_results( data.table(A$coefficients[,1:4],keep.rownames=TRUE), arg_round=4)
        t <- melt(t,id.vars = c("rn"), measure.vars = c("coef","std","t_value","p_value","coef_star","std_par"),value.name=c(paste0("model_",i)))
        t <- rbind(t,other)
        coef <- merge(coef,t,by=c("rn","variable"),all=TRUE)
        rm(A,other,t)
        if (i0==i) toc()
      }
    
    }
    
    
  ## NOOO argument ARG_WEIGHTS 
  } else {
    if (i %in% iter_vec) {
      tic(paste0("Iteration ",i," to ",min(i+by_iter-1,length(arg_formula))))
      i0 <- i + by_iter -1
    }
    if (method=="lm") {
      A <- summary(lm(arg_formula[[1]],data=arg_data,model=FALSE))
      other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(length(A$residuals),format(round(A$adj.r.squared,4),nsmall=2)),unname(A$fstatistic)))
    } else if (method=="lm_robust") {
      setnames(arg_data,c(deparse(substitute(arg_clusters))),c("arg_cl"))
      A <- summary(lm_robust(arg_formula[[1]],clusters=arg_cl,se_type='stata',data=arg_data))
      other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(A$nobs,format(round(A$adj.r.squared,4),nsmall=2)),unname(A$fstatistic)))
    }
    coef <- f_reg_results( data.table(A$coefficients[,1:4],keep.rownames=TRUE), arg_round=4 )
    coef <- melt(coef,id.vars = c("rn"), measure.vars = c("coef","std","t_value","p_value","coef_star","std_par"),value.name=c(paste0("model_",1)))
    coef <- rbind(coef,other)
    if (i == i0) toc()
    rm(A,other)
    
    if (length(arg_formula)>1) {
      for (i in 2:length(arg_formula)) {
        if (i %in% iter_vec) {
          tic(paste0("Iteration ",i," to ",min(i+by_iter-1,length(arg_formula))))
          i0 <- i + by_iter -1
        }
        if (method=="lm") {
          A <- summary(lm(arg_formula[[i]],data=arg_data,model=FALSE))
          other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(length(A$residuals),format(round(A$adj.r.squared,4),nsmall=2)),unname(A$fstatistic)))
          setnames(other,c(3),c(paste0("model_",i)))
        } else if (method=="lm_robust") {
          A <- summary(lm_robust(arg_formula[[i]],clusters=arg_cl,se_type='stata',data=arg_data))
          other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(A$nobs,format(round(A$adj.r.squared,4),nsmall=2)),unname(A$fstatistic)))
          setnames(other,c(3),c(paste0("model_",i)))
        }
        
        t <- f_reg_results( data.table(A$coefficients[,1:4],keep.rownames=TRUE), arg_round=4)
        t <- melt(t,id.vars = c("rn"), measure.vars = c("coef","std","t_value","p_value","coef_star","std_par"),value.name=c(paste0("model_",i)))
        t <- rbind(t,other)
        coef <- merge(coef,t,by=c("rn","variable"),all=TRUE)
        rm(A,other,t)
        if (i == i0) toc()
      }
    
    }
    
    
  }
  
  coef <- as.data.table(coef)
  coef[,order:=ifelse(variable=="zother",1,0)]
  setorder(coef,order,rn)
  coef[,order:=NULL]
  
  if (!missing(arg_weights)) { setnames(arg_data, c("arg_w"), c(deparse(substitute(arg_weights))) )   }
  
  if (method=="lm_robust") {
    setnames(arg_data,c("arg_cl"),c(deparse(substitute(arg_clusters))))
  }
  if (i==length(arg_formula)) toc()
  return(coef)
}

```

### 0.2. Functions to export tables to Excel
```{r}
wrapper_Excel <- function(list_table,list_name,output) {
  t <- createWorkbook()
  for (i in 1:length(list_table)) {
    addWorksheet(t, list_name[[i]])
    writeData(t, list_name[[i]],list_table[[i]])
  }
  saveWorkbook(t, output,overwrite=TRUE)
}
```


## 1. Regressions following Lin (2011) - At the countynhg_1910 level
### 1.1. Call individual level data
```{r}
census_sample_1930_individual_data <-read_fst(here(paste0("output/Rdata/census_sample_1930_individual_data_x_countynhg_1910.fst")),as.data.table=TRUE)
```
***!!! NOTE: 

### 1.2. Creating dummy variables
```{r}
# Change categorical variables to factors
# Note: - using factors allows R to easily create dummies
#       - We don't change binary variables, as they are already interpreted as Dummy variables  
cols <- c("race","marst","age_main","ind1950_main","occ1950_main")
census_sample_1930_individual_data[,(cols):=lapply(.SD,as.factor),.SDcols=cols]

```

### 1.3 Creating some variables for regressions
```{r}
# Base
base_individual <- paste0(c("male","lit","marst","race","wwages","mig_us","mig_ab"),collapse=" + ")

# Industry
indsh_var_1920 <- grep("^sh_ind1950_main_[^1]_1920",names(census_sample_1930_individual_data),value=TRUE)
indsh_var_1930 <- grep("^sh_ind1950_main_[^1]_1930",names(census_sample_1930_individual_data),value=TRUE)

# Occupations
occsh_var_1920 <- grep("^sh_occ1950_main_[^0].+_1920",names(census_sample_1930_individual_data),value=TRUE)
occsh_var_1930 <- grep("^sh_occ1950_main_[^0].+_1930",names(census_sample_1930_individual_data),value=TRUE)

```

### 1.4. First stage regression (following Lin (2011))
*** TO-DO: Construct regressions for this part. The main problem is that the algorithm collapses when we include countynhg_1910 dummies
```{r}
#???????
```


### 1.5. Regressions
1. base_individual + ind1950_main + sh_lit + log(perwt) + sh_new sectors (3 different cases)
2. base_individual + ind1950_main + sh_lit + log(perwt) + sh_new sectors (3 different cases) + sh_ind1950_main
3. base_individual + ind1950_main + sh_lit + log(perwt) + sh_new sectors (3 different cases) + sh_ind1950_main + sh_occ1950_main


#### 1.5.1. Creating the different formulas for the regressions
```{r}
a <- vector(mode = "list", length = 45)

# 1. base_individual + ind1950_main + sh_lit + log(perwt) + sh_new sectors (consider different new_sectors)
## Geof variables Previous year (coef_1 - coef_3)
a[[1]] <- as.formula(paste("sh_new_method1 ~ new_sec_all_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main"))
a[[2]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main"))
a[[3]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1920 + new_sec_serv_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main"))

## Geof variables Current year (coef_4 - coef_6)
a[[4]] <- as.formula(paste("sh_new_method1 ~ new_sec_all_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main"))
a[[5]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main"))
a[[6]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main"))

## Mix (coef_7 - coef_9)
a[[7]] <- as.formula(paste("sh_new_method1 ~ new_sec_all_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main"))
a[[8]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," +age_main + ind1950_main"))
a[[9]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," +age_main + ind1950_main"))
  
# 2. base_individual + ind1950_main + sh_lit + log(perwt) + sh_new sectors (3 different cases) + sh_ind1950_main
## Geof variables Previous year (coef_10 - coef_12)
a[[10]] <- as.formula(paste("sh_new_method1 ~ new_sec_all_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main  +",paste0(indsh_var_1920,collapse=" + ")))
a[[11]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main +",paste0(indsh_var_1920,collapse=" + ")))
a[[12]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1920 + new_sec_serv_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main+",paste0(indsh_var_1920,collapse=" + ")))

## Current year (coef_13 - coef_15)
a[[13]] <- as.formula(paste("sh_new_method1 ~ new_sec_all_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main+",paste0(indsh_var_1930,collapse=" + ")))
a[[14]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + ",paste0(indsh_var_1930,collapse=" + ")))
a[[15]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + ",paste0(indsh_var_1930,collapse=" + ")))
  
## Mix (coef_16 - coef_18)
a[[16]] <- as.formula(paste("sh_new_method1 ~ new_sec_all_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + ",paste0(indsh_var_1920,collapse=" + ")))
a[[17]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," +age_main + ind1950_main + ",paste0(indsh_var_1920,collapse=" + ")))
a[[18]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," +age_main + ind1950_main + ",paste0(indsh_var_1920,collapse=" + ")))


# 3. base_individual + ind1950_main + sh_lit + log(perwt) + sh_new sectors (3 different cases) + sh_ind1950_main + sh_occ1950_main
## Geof variables Previous year (coef_19 - coef_21)
a[[19]] <- as.formula( paste("sh_new_method1 ~ new_sec_all_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main  +",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + "))   )
a[[20]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main +",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + ")))
a[[21]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1920 + new_sec_serv_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main+",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + ")))

## Current year (coef_22 - coef_24)
a[[22]] <- as.formula(paste("sh_new_method1 ~ new_sec_all_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main+",paste0(indsh_var_1930,collapse=" + ")," + ",paste0(occsh_var_1930,collapse=" + ")))
a[[23]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + ",paste0(indsh_var_1930,collapse=" + ")," + ",paste0(occsh_var_1930,collapse=" + ")))
a[[24]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + ",paste0(indsh_var_1930,collapse=" + ")," + ",paste0(occsh_var_1930,collapse=" + ")))
  
## Mix (coef_25 - coef_27)
a[[25]] <- as.formula(paste("sh_new_method1 ~ new_sec_all_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + ",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + ")))
a[[26]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," +age_main + ind1950_main + ",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + ")))
a[[27]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," +age_main + ind1950_main + ",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + ")))

## Regressions with occ1950_main
### 1920 regressors
a[[28]] <- as.formula(paste("sh_new_method1 ~ new_sec_all_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main"))
a[[29]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1920 + new_sec_serv_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main"))
a[[30]] <- as.formula(paste("sh_new_method1 ~ new_sec_all_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1920,collapse=" + ")))
a[[31]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1920 + new_sec_serv_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1920,collapse=" + ")))
a[[32]] <- as.formula( paste("sh_new_method1 ~ new_sec_all_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + "))   )
a[[33]] <- as.formula( paste("sh_new_method1 ~ new_sec_main_1920 + new_sec_serv_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + "))   )

### 1930 regressors
a[[34]] <- as.formula(paste("sh_new_method1 ~ new_sec_all_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main"))
a[[35]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main"))
a[[36]] <- as.formula(paste("sh_new_method1 ~ new_sec_all_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1930,collapse=" + ")))
a[[37]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1930,collapse=" + ")))
a[[38]] <- as.formula( paste("sh_new_method1 ~ new_sec_all_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1930,collapse=" + ")," + ",paste0(occsh_var_1930,collapse=" + "))   )
a[[39]] <- as.formula( paste("sh_new_method1 ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1930,collapse=" + ")," + ",paste0(occsh_var_1930,collapse=" + "))   )

### 1930 new sector, 1920 region variables
a[[40]] <- as.formula(paste("sh_new_method1 ~ new_sec_all_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main"))
a[[41]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main"))
a[[42]] <- as.formula(paste("sh_new_method1 ~ new_sec_all_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1920,collapse=" + ")))
a[[43]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1920,collapse=" + ")))
a[[44]] <- as.formula( paste("sh_new_method1 ~ new_sec_all_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + "))   )
a[[45]] <- as.formula( paste("sh_new_method1 ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + "))   )


```


### 1.5.2. Regressions

#### 1.5.2.1. Main Regressions
```{r}
#### No cluster, no drop
coef.J <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930 > 10000],arg_weights=perwt_ID,method="lm",arg_clusters=occind)

#### No cluster, drop
coef.J.drop <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,466,556,606,667,668,816,856))],arg_weights=perwt_ID,method="lm",arg_clusters=occind)

#### Cluster, no drop
coef.J.cluster <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930 > 10000],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

#### Cluster, drop
coef.J.cluster.drop <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,466,556,606,667,668,816,856))],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)
```


##### Saving results
```{r}
# All the coefficients
list_name <- list("No_cluster_No_drop","No_cluster_Drop","Cluster_No_drop","Cluster_Drop")
list_table <- list(coef.J[variable=="coef_star" | variable =="std_par" | variable=="zother"],coef.J.drop[variable=="coef_star" | variable =="std_par" | variable=="zother"],coef.J.cluster[variable=="coef_star" | variable =="std_par" |variable=="zother"],coef.J.cluster.drop[variable=="coef_star" | variable =="std_par" | variable=="zother"])

wrapper_Excel(list_table,list_name,here(paste0("output/Tables/individual_regression_1930_countynhg_1910.xlsx")))

# 1920 Regressors
## Region coefficients, New sector Main
wrapper_Excel(list(coef.J.cluster[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))],coef.J.cluster.drop[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))]),
              list("Cluster_No_drop","Cluster_Drop"),
              here(paste0("output/Tables/ind_reg_1930_ctynhg_1910_New_Sector_reg_1920.xlsx")))

## Region coefficients, New sector Serv and Main
wrapper_Excel(list(coef.J.cluster[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))],coef.J.cluster.drop[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))]),
              list("Cluster_No_drop","Cluster_Drop"),
              here(paste0("output/Tables/ind_reg_1930_ctynhg_1910_New_Main_Serv_reg_1920.xlsx")))

# 1930 Regressors
## Region coefficients, New sector Main
wrapper_Excel(list(coef.J.cluster[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))],coef.J.cluster.drop[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))]),
              list("Cluster_No_drop","Cluster_Drop"),
              here(paste0("output/Tables/ind_reg_1930_ctynhg_1910_New_Sector_reg_1930.xlsx")))

## Region coefficients, New sector Serv and Main
wrapper_Excel(list(coef.J.cluster[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))],coef.J.cluster.drop[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))]),
              list("Cluster_No_drop","Cluster_Drop"),
              here(paste0("output/Tables/ind_reg_1930_ctynhg_1910_New_Main_Serv_reg_1930.xlsx")))

# 1930 New Sec, 1920 rest
## Region coefficients, New sector Main
wrapper_Excel(list(coef.J.cluster[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))],coef.J.cluster.drop[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))]),
              list("Cluster_No_drop","Cluster_Drop"),
              here(paste0("output/Tables/ind_reg_1930_ctynhg_1910_New_Sector_reg_mix.xlsx")))

## Region coefficients, New sector Serv and Main
wrapper_Excel(list(coef.J.cluster[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))],coef.J.cluster.drop[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))]),
              list("Cluster_No_drop","Cluster_Drop"),
              here(paste0("output/Tables/ind_reg_1930_ctynhg_1910_New_Main_Serv_reg_mix.xlsx")))


```

#### 1.5.2.2 Robustness Regressions
```{r}
# Excluding regions with the highest shares of New Sectors
## 2
coef.J.cluster.drop.excluding_2 <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0  & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,466,556,606,667,668,816,856))   &   rank_new_sec_1920>=3],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

## 4
coef.J.cluster.drop.excluding_4 <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,466,556,606,667,668,816,856))   &   rank_new_sec_1920>=5],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

## 9
coef.J.cluster.drop.excluding_9 <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,466,556,606,667,668,816,856))   &   rank_new_sec_1920>=10],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

## 19
coef.J.cluster.drop.excluding_19 <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,466,556,606,667,668,816,856))   &   rank_new_sec_1920>=20],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

## 49
coef.J.cluster.drop.excluding_49 <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,466,556,606,667,668,816,856))   &   rank_new_sec_1920>=50],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

## 99
coef.J.cluster.drop.excluding_99 <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,466,556,606,667,668,816,856))   &   rank_new_sec_1920>=100],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

## 199
coef.J.cluster.drop.excluding_199 <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,466,556,606,667,668,816,856))   &   rank_new_sec_1920>=200],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

```

###### Saving results
```{r}
# 1920 Regressors
## Region coefficients, New sector Main
wrapper_Excel(list(
                    coef.J.cluster.drop.excluding_2[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))],
                    coef.J.cluster.drop.excluding_4[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))],
                    coef.J.cluster.drop.excluding_9[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_9$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_9$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))],
                    coef.J.cluster.drop.excluding_19[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_19$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_19$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))],
                    coef.J.cluster.drop.excluding_49[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))],
                    coef.J.cluster.drop.excluding_99[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))],
                    coef.J.cluster.drop.excluding_199[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))]),
              list("Cluster_Drop_Ex_2","Cluster_Drop_Ex_4","Cluster_Drop_Ex_9","Cluster_Drop_Ex_19","Cluster_Drop_Ex_49","Cluster_Drop_Ex_99","Cluster_Drop_Ex_199"),
              here(paste0("output/Tables/ind_reg_1930_ctynhg_1910_New_Sector_reg_1920_exclus.xlsx")))

## Region coefficients, New sector Serv and Main
wrapper_Excel(list(
                  coef.J.cluster.drop.excluding_2[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))],
                  coef.J.cluster.drop.excluding_4[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))],
                  coef.J.cluster.drop.excluding_9[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_9$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_9$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))],
                  coef.J.cluster.drop.excluding_19[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_19$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_19$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))],
                  coef.J.cluster.drop.excluding_49[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))],
                  coef.J.cluster.drop.excluding_99[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))],
                  coef.J.cluster.drop.excluding_199[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))]),
              list("Cluster_Drop_Ex_2","Cluster_Drop_Ex_4","Cluster_Drop_Ex_9","Cluster_Drop_Ex_19","Cluster_Drop_Ex_49","Cluster_Drop_Ex_99","Cluster_Drop_Ex_199"),
              here(paste0("output/Tables/ind_reg_1930_ctynhg_1910_New_Main_Serv_reg_1920_exclus.xlsx")))

# 1930 Regressors
## Region coefficients, New sector Main
wrapper_Excel(list(
                  coef.J.cluster.drop.excluding_2[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))],
                  coef.J.cluster.drop.excluding_4[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))],
                  coef.J.cluster.drop.excluding_9[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_9$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_9$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))],
                  coef.J.cluster.drop.excluding_19[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_19$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_19$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))],
                  coef.J.cluster.drop.excluding_49[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))],
                  coef.J.cluster.drop.excluding_99[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))],
                  coef.J.cluster.drop.excluding_199[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_49$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))]),
              list("Cluster_Drop_Ex_2","Cluster_Drop_Ex_4","Cluster_Drop_Ex_9","Cluster_Drop_Ex_19","Cluster_Drop_Ex_49","Cluster_Drop_Ex_99","Cluster_Drop_Ex_199"),
              here(paste0("output/Tables/ind_reg_1930_ctynhg_1910_New_Sector_reg_1930_exclus.xlsx")))

## Region coefficients, New sector Serv and Main
wrapper_Excel(list(
                  coef.J.cluster.drop.excluding_2[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))],
                  coef.J.cluster.drop.excluding_4[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))],
                  coef.J.cluster.drop.excluding_9[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))],
                  coef.J.cluster.drop.excluding_19[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))],
                  coef.J.cluster.drop.excluding_49[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))],
                  coef.J.cluster.drop.excluding_99[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))],
                  coef.J.cluster.drop.excluding_199[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))]),
              list("Cluster_Drop_Ex_2","Cluster_Drop_Ex_4","Cluster_Drop_Ex_9","Cluster_Drop_Ex_19","Cluster_Drop_Ex_49","Cluster_Drop_Ex_99","Cluster_Drop_Ex_199"),
              here(paste0("output/Tables/ind_reg_1930_ctynhg_1910_New_Main_Serv_reg_1930_exclus.xlsx")))

# 1930 New Sec, 1920 rest
## Region coefficients, New sector Main
wrapper_Excel(list(
                  coef.J.cluster.drop.excluding_2[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))],
                  coef.J.cluster.drop.excluding_4[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))],
                  coef.J.cluster.drop.excluding_9[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))],
                  coef.J.cluster.drop.excluding_19[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))],
                  coef.J.cluster.drop.excluding_49[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))],
                  coef.J.cluster.drop.excluding_99[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))],
                  coef.J.cluster.drop.excluding_199[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))]),
              list("Cluster_Drop_Ex_2","Cluster_Drop_Ex_4","Cluster_Drop_Ex_9","Cluster_Drop_Ex_19","Cluster_Drop_Ex_49","Cluster_Drop_Ex_99","Cluster_Drop_Ex_199"),
              here(paste0("output/Tables/ind_reg_1930_ctynhg_1910_New_Sector_reg_mix_exclus.xlsx")))

## Region coefficients, New sector Serv and Main
wrapper_Excel(list(
                  coef.J.cluster.drop.excluding_2[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))],
                  coef.J.cluster.drop.excluding_4[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))],
                  coef.J.cluster.drop.excluding_9[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))],
                  coef.J.cluster.drop.excluding_19[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))],
                  coef.J.cluster.drop.excluding_49[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))],
                  coef.J.cluster.drop.excluding_99[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))],
                  coef.J.cluster.drop.excluding_199[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))]),
              list("Cluster_Drop_Ex_2","Cluster_Drop_Ex_4","Cluster_Drop_Ex_9","Cluster_Drop_Ex_19","Cluster_Drop_Ex_49","Cluster_Drop_Ex_99","Cluster_Drop_Ex_199"),
              here(paste0("output/Tables/ind_reg_1930_ctynhg_1910_New_Main_Serv_reg_mix_exclus.xlsx")))
```


## 2. Regressions following Lin (2011) - At the metarea_1940 level
### 2.1. Call individual level data
```{r}
census_sample_1930_individual_data <-read_fst(here(paste0("output/Rdata/census_sample_1930_individual_data_x_metarea_1940.fst")),as.data.table=TRUE)
```

### 2.2. Creating dummy variables
```{r}
# Change categorical variables to factors
# Note: - using factors allows R to easily create dummies
#       - We don't change binary variables, as they are already interpreted as Dummy variables  
cols <- c("race","marst","age_main","ind1950_main","occ1950_main")
census_sample_1930_individual_data[,(cols):=lapply(.SD,as.factor),.SDcols=cols]

```


### 2.3. First stage regression (following Lin (2011))
```{r}
# lists to store regressions
coef.FS <- vector(mode = "list", length = 1)
coef.FS.cluster <- vector(mode = "list", length = 1)
other.FS <- vector(mode = "list", length = 8)
other.FS.cluster <- vector(mode = "list", length = 8)

# 1. Basic + No industry dummies
base_individual <- paste0(c("male","lit","marst","race","wwages","mig_us","mig_ab"),collapse=" + ")
a <- as.formula(paste("sh_new_method1 ~ age_main +",paste0(base_individual,collapse=" + ")," + factor(metarea_1940)"))

## Not cluster
A <- summary(lm(a,data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000,c("occ1950_main","ind1950_main","occind","sh_new_method1","age_main","metarea_1940","male","lit","marst","race","wwages","mig_us","mig_ab")],model=FALSE))
coef.FS[[1]] <- data.table(A$coefficients[,1:3],keep.rownames=TRUE)
setnames(coef.FS[[1]],c(2,3,4),c("coef_1","std_1","t-value_1"))
other.FS[[1]] <- list(observations = A$nobs,adj.r.squared = A$adj.r.squared,fstatistic = A$fstatistic)
rm(A)

## Cluster
# ***NOTE: We still need to perform the hypothesis testing of the metarea dummies. One possible way is using linear_hypothesis. lh_robust is a wrapper for this one
A <- summary(lm_robust(a,clusters = occind, se_type = 'stata',data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000,c("occ1950_main","ind1950_main","occind","sh_new_method1","age_main","metarea_1940","male","lit","marst","race","wwages","mig_us","mig_ab")]))
coef.FS.cluster[[1]] <- data.table(A$coefficients[,1:3],keep.rownames=TRUE)
setnames(coef.FS.cluster[[1]],c(2,3,4),c("coef_1","std_1","t-value_1"))
(other.FS.cluster[[1]] <- list(observations = A$nobs, adj.r.squared = A$adj.r.squared, fstatistic = A$fstatistic))
rm(A)

# 2. Basic + Industry dummies
a <- as.formula(paste("sh_new_method1 ~ age_main +",paste0(base_individual,collapse=" + "),"+ ind1950_main + factor(metarea_1940)"))

## Not cluster
A <- summary(lm(a,data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000,c("occ1950_main","ind1950_main","occind","sh_new_method1","age_main","metarea_1940","male","lit","marst","race","wwages","mig_us","mig_ab")],model=FALSE))
#(coef.FS[[2]] <- A$coefficients)
#(other.FS[[2]] <- list(observations = A$nobs,adj.r.squared = A$adj.r.squared,fstatistic = A$fstatistic))
t <- data.table(A$coefficients[,1:3],keep.rownames=TRUE)
setnames(t,c(2,3,4),c("coef_2","std_2","t-value_2"))
coef.FS[[1]] <- merge(coef.FS[[1]],t,by="rn",all=TRUE)
other.FS[[1]] <- list(observations = A$nobs,adj.r.squared = A$adj.r.squared,fstatistic = A$fstatistic)
rm(A,t)

## Cluster
# ***NOTE: We still need to perform the hypothesis testing of the metarea dummies. One possible way is using linear_hypothesis. lh_robust is a wrapper for this one
A <- summary(lm_robust(a,clusters = occind, se_type = 'stata',data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000,c("occ1950_main","ind1950_main","occind","sh_new_method1","age_main","metarea_1940","male","lit","marst","race","wwages","mig_us","mig_ab")]))
t <- data.table(A$coefficients[,1:3],keep.rownames=TRUE)
setnames(t,c(2,3,4),c("coef_2","std_2","t-value_2"))
coef.FS.cluster[[1]] <- merge(coef.FS.cluster[[1]],t,by="rn",all=TRUE)
(other.FS.cluster[[2]] <- list(observations = A$nobs, adj.r.squared = A$adj.r.squared, fstatistic = A$fstatistic))
rm(A,t)

# 3. Basic + Industry dummies + additional individual level variable
other_individual <- paste0(c("urban","famsize","ownershp"),collapse=" + ")
a <- as.formula(paste("sh_new_method1 ~ age_main +",paste0(base_individual,collapse=" + ")," + ",paste0(other_individual,collapse=" + "),"+ ind1950_main + factor(metarea_1940)"))

## Not cluster
A <- summary(lm(a,data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000,c("occ1950_main","ind1950_main","occind","sh_new_method1","age_main","metarea_1940","male","lit","marst","race","wwages","mig_us","mig_ab","urban","famsize","ownershp")],model=FALSE))
t <- data.table(A$coefficients[,1:3],keep.rownames=TRUE)
setnames(t,c(2,3,4),c("coef_3","std_3","t-value_3"))
coef.FS[[1]] <- merge(coef.FS[[1]],t,by="rn",all=TRUE)
(other.FS[[3]] <- list(observations = A$nobs,adj.r.squared = A$adj.r.squared,fstatistic = A$fstatistic))

## Cluster
# ***NOTE: We still need to perform the hypothesis testing of the metarea dummies. One possible way is using linear_hypothesis. lh_robust is a wrapper for this one
A <- summary(lm_robust(a,clusters = occind, se_type = 'stata',data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000,c("occ1950_main","ind1950_main","occind","sh_new_method1","age_main","metarea_1940","male","lit","marst","race","wwages","mig_us","mig_ab","urban","famsize","ownershp")]))
t <- data.table(A$coefficients[,1:3],keep.rownames=TRUE)
setnames(t,c(2,3,4),c("coef_3","std_3","t-value_3"))
coef.FS.cluster[[1]] <- merge(coef.FS.cluster[[1]],t,by="rn",all=TRUE)
other.FS.cluster[[3]] <- list(observations = A$nobs, adj.r.squared = A$adj.r.squared, fstatistic = A$fstatistic)

# 4. Basic + Industry dummies + additional individual level variable + father/mother migration
migration_individual <- paste0(c("m_mig_us","m_mig_ab","f_mig_us","f_mig_ab"),collapse=" + ")
a <- as.formula(paste("sh_new_method1 ~ age_main +",paste0(base_individual,collapse=" + ")," + ",paste0(other_individual,collapse=" + ")," + ",paste0(migration_individual,collapse=" + "),"+ ind1950_main + factor(metarea_1940)"))

## Not cluster
A <- summary(lm(a,data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000,c("occ1950_main","ind1950_main","occind","sh_new_method1","age_main","metarea_1940","male","lit","marst","race","wwages","mig_us","mig_ab","urban","famsize","ownershp","m_mig_us","m_mig_ab","f_mig_us","f_mig_ab")],model=FALSE))
t <- data.table(A$coefficients[,1:3],keep.rownames=TRUE)
setnames(t,c(2,3,4),c("coef_4","std_4","t-value_4"))
coef.FS[[1]] <- merge(coef.FS[[1]],t,by="rn",all=TRUE)
(other.FS[[4]] <- list(observations = A$nobs,adj.r.squared = A$adj.r.squared,fstatistic = A$fstatistic))

## Cluster
# ***NOTE: We still need to perform the hypothesis testing of the metarea dummies. One possible way is using linear_hypothesis. lh_robust is a wrapper for this one
A <- summary(lm_robust(a,clusters = occind, se_type = 'stata',data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000,c("occ1950_main","ind1950_main","occind","sh_new_method1","age_main","metarea_1940","male","lit","marst","race","wwages","mig_us","mig_ab","urban","famsize","ownershp","m_mig_us","m_mig_ab","f_mig_us","f_mig_ab")]))
t <- data.table(A$coefficients[,1:3],keep.rownames=TRUE)
setnames(t,c(2,3,4),c("coef_4","std_4","t-value_4"))
coef.FS.cluster[[1]] <- merge(coef.FS.cluster[[1]],t,by="rn",all=TRUE)
(other.FS.cluster[[4]] <- list(observations = A$nobs, adj.r.squared = A$adj.r.squared, fstatistic = A$fstatistic))

```




### 2.4. Regressions
1. base_individual + ind1950_main + sh_lit + log(perwt) + sh_new sectors (3 different cases)
2. base_individual + ind1950_main + sh_lit + log(perwt) + sh_new sectors (3 different cases) + sh_ind1950_main
3. base_individual + ind1950_main + sh_lit + log(perwt) + sh_new sectors (3 different cases) + sh_ind1950_main + sh_occ1950_main


#### 2.4.1. Creating the different formulas for the regressions
```{r}
a <- vector(mode = "list", length = 45)

# 1. base_individual + ind1950_main + sh_lit + log(perwt) + sh_new sectors (consider different new_sectors)
## Geof variables Previous year (coef_1 - coef_3)
a[[1]] <- as.formula(paste("sh_new_method1 ~ new_sec_all_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main"))
a[[2]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main"))
a[[3]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1920 + new_sec_serv_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main"))

## Geof variables Current year (coef_4 - coef_6)
a[[4]] <- as.formula(paste("sh_new_method1 ~ new_sec_all_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main"))
a[[5]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main"))
a[[6]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main"))

## Mix (coef_7 - coef_9)
a[[7]] <- as.formula(paste("sh_new_method1 ~ new_sec_all_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main"))
a[[8]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," +age_main + ind1950_main"))
a[[9]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," +age_main + ind1950_main"))
  
# 2. base_individual + ind1950_main + sh_lit + log(perwt) + sh_new sectors (3 different cases) + sh_ind1950_main
## Geof variables Previous year (coef_10 - coef_12)
a[[10]] <- as.formula(paste("sh_new_method1 ~ new_sec_all_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main  +",paste0(indsh_var_1920,collapse=" + ")))
a[[11]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main +",paste0(indsh_var_1920,collapse=" + ")))
a[[12]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1920 + new_sec_serv_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main+",paste0(indsh_var_1920,collapse=" + ")))

## Current year (coef_13 - coef_15)
a[[13]] <- as.formula(paste("sh_new_method1 ~ new_sec_all_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main+",paste0(indsh_var_1930,collapse=" + ")))
a[[14]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + ",paste0(indsh_var_1930,collapse=" + ")))
a[[15]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + ",paste0(indsh_var_1930,collapse=" + ")))
  
## Mix (coef_16 - coef_18)
a[[16]] <- as.formula(paste("sh_new_method1 ~ new_sec_all_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + ",paste0(indsh_var_1920,collapse=" + ")))
a[[17]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," +age_main + ind1950_main + ",paste0(indsh_var_1920,collapse=" + ")))
a[[18]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," +age_main + ind1950_main + ",paste0(indsh_var_1920,collapse=" + ")))


# 3. base_individual + ind1950_main + sh_lit + log(perwt) + sh_new sectors (3 different cases) + sh_ind1950_main + sh_occ1950_main
## Geof variables Previous year (coef_19 - coef_21)
a[[19]] <- as.formula( paste("sh_new_method1 ~ new_sec_all_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main  +",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + "))   )
a[[20]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main +",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + ")))
a[[21]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1920 + new_sec_serv_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main+",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + ")))

## Current year (coef_22 - coef_24)
a[[22]] <- as.formula(paste("sh_new_method1 ~ new_sec_all_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main+",paste0(indsh_var_1930,collapse=" + ")," + ",paste0(occsh_var_1930,collapse=" + ")))
a[[23]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + ",paste0(indsh_var_1930,collapse=" + ")," + ",paste0(occsh_var_1930,collapse=" + ")))
a[[24]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + ",paste0(indsh_var_1930,collapse=" + ")," + ",paste0(occsh_var_1930,collapse=" + ")))
  
## Mix (coef_25 - coef_27)
a[[25]] <- as.formula(paste("sh_new_method1 ~ new_sec_all_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + ",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + ")))
a[[26]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," +age_main + ind1950_main + ",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + ")))
a[[27]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," +age_main + ind1950_main + ",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + ")))

## Regressions with occ1950_main
### 1920 regressors
a[[28]] <- as.formula(paste("sh_new_method1 ~ new_sec_all_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main"))
a[[29]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1920 + new_sec_serv_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main"))
a[[30]] <- as.formula(paste("sh_new_method1 ~ new_sec_all_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1920,collapse=" + ")))
a[[31]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1920 + new_sec_serv_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1920,collapse=" + ")))
a[[32]] <- as.formula( paste("sh_new_method1 ~ new_sec_all_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + "))   )
a[[33]] <- as.formula( paste("sh_new_method1 ~ new_sec_main_1920 + new_sec_serv_1920 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + "))   )

### 1930 regressors
a[[34]] <- as.formula(paste("sh_new_method1 ~ new_sec_all_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main"))
a[[35]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main"))
a[[36]] <- as.formula(paste("sh_new_method1 ~ new_sec_all_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1930,collapse=" + ")))
a[[37]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1930,collapse=" + ")))
a[[38]] <- as.formula( paste("sh_new_method1 ~ new_sec_all_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1930,collapse=" + ")," + ",paste0(occsh_var_1930,collapse=" + "))   )
a[[39]] <- as.formula( paste("sh_new_method1 ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1930 + log(perwt_1930) + H_1930 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1930,collapse=" + ")," + ",paste0(occsh_var_1930,collapse=" + "))   )

### 1930 new sector, 1920 region variables
a[[40]] <- as.formula(paste("sh_new_method1 ~ new_sec_all_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main"))
a[[41]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main"))
a[[42]] <- as.formula(paste("sh_new_method1 ~ new_sec_all_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1920,collapse=" + ")))
a[[43]] <- as.formula(paste("sh_new_method1 ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1920,collapse=" + ")))
a[[44]] <- as.formula( paste("sh_new_method1 ~ new_sec_all_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + "))   )
a[[45]] <- as.formula( paste("sh_new_method1 ~ new_sec_main_1930 + new_sec_serv_1930 + sh_lit_1920 + log(perwt_1920) + H_1920 + ",paste0(base_individual,collapse=" + ")," + age_main + ind1950_main + occ1950_main +",paste0(indsh_var_1920,collapse=" + ")," + ",paste0(occsh_var_1920,collapse=" + "))   )


```


#### 2.4.3. Regressions
##### 2.4.3.1. Main Regressions
```{r}
#### No cluster, no drop

coef.J <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000 & perwt_1930 > 10000],arg_weights=perwt_ID,method="lm",arg_clusters=occind)

#### No cluster, drop
coef.J.drop <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,466,556,606,667,668,816,856))],arg_weights=perwt_ID,method="lm",arg_clusters=occind)

#### Cluster, no drop
coef.J.cluster <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000 & perwt_1930 > 10000],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

#### Cluster, drop
coef.J.cluster.drop <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,466,556,606,667,668,816,856))],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

```


###### Saving results
```{r}
# All the coefficients
list_name <- list("No_cluster_No_drop","No_cluster_Drop","Cluster_No_drop","Cluster_Drop")
list_table <- list(coef.J[variable=="coef_star" | variable =="std_par" | variable=="zother"],coef.J.drop[variable=="coef_star" | variable =="std_par" | variable=="zother"],coef.J.cluster[variable=="coef_star" | variable =="std_par" |variable=="zother"],coef.J.cluster.drop[variable=="coef_star" | variable =="std_par" | variable=="zother"])

wrapper_Excel(list_table,list_name,here(paste0("output/Tables/individual_regression_1930_metarea_1940.xlsx")))

# 1920 Regressors
## Region coefficients, New sector Main
wrapper_Excel(list(coef.J.cluster[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))],coef.J.cluster.drop[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))]),
              list("Cluster_No_drop","Cluster_Drop"),
              here(paste0("output/Tables/ind_reg_1930_met_1940_New_Sector_reg_1920.xlsx")))

## Region coefficients, New sector Serv and Main
wrapper_Excel(list(coef.J.cluster[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))],coef.J.cluster.drop[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))]),
              list("Cluster_No_drop","Cluster_Drop"),
              here(paste0("output/Tables/ind_reg_1930_met_1940_New_Main_Serv_reg_1920.xlsx")))

# 1930 Regressors
## Region coefficients, New sector Main
wrapper_Excel(list(coef.J.cluster[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))],coef.J.cluster.drop[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))]),
              list("Cluster_No_drop","Cluster_Drop"),
              here(paste0("output/Tables/ind_reg_1930_met_1940_New_Sector_reg_1930.xlsx")))

## Region coefficients, New sector Serv and Main
wrapper_Excel(list(coef.J.cluster[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))],coef.J.cluster.drop[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))]),
              list("Cluster_No_drop","Cluster_Drop"),
              here(paste0("output/Tables/ind_reg_1930_met_1940_New_Main_Serv_reg_1930.xlsx")))

# 1930 New Sec, 1920 rest
## Region coefficients, New sector Main
wrapper_Excel(list(coef.J.cluster[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))],coef.J.cluster.drop[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))]),
              list("Cluster_No_drop","Cluster_Drop"),
              here(paste0("output/Tables/ind_reg_1930_met_1940_New_Sector_reg_mix.xlsx")))

## Region coefficients, New sector Serv and Main
wrapper_Excel(list(coef.J.cluster[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))],coef.J.cluster.drop[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))]),
              list("Cluster_No_drop","Cluster_Drop"),
              here(paste0("output/Tables/ind_reg_1930_met_1940_New_Main_Serv_reg_mix.xlsx")))



```

##### 2.4.3.2 Robustness Regressions
```{r}
#Excluding regions with the highest shares of New Sectors
## 2 
coef.J.cluster.drop.excluding_2 <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,466,556,606,667,668,816,856))   &   rank_new_sec_1920>=3],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

## 4
coef.J.cluster.drop.excluding_4 <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,466,556,606,667,668,816,856))   &   rank_new_sec_1920>=5],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

## 9
coef.J.cluster.drop.excluding_9 <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,466,556,606,667,668,816,856))   &   rank_new_sec_1920>=10],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

## 14
coef.J.cluster.drop.excluding_14 <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,466,556,606,667,668,816,856))   &   rank_new_sec_1920>=15],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

## 19
coef.J.cluster.drop.excluding_19 <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,466,556,606,667,668,816,856))   &   rank_new_sec_1920>=20],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

## 29
coef.J.cluster.drop.excluding_29 <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,466,556,606,667,668,816,856))   &   rank_new_sec_1920>=30],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)

## 49
coef.J.cluster.drop.excluding_49 <- f_regressions (arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & metarea_1940<1000 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,466,556,606,667,668,816,856))   &   rank_new_sec_1920>=50],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)
```

###### Saving results
```{r}
# 1920 Regressors
## Region coefficients, New sector Main
wrapper_Excel(list(
                    coef.J.cluster.drop.excluding_2[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))],
                    coef.J.cluster.drop.excluding_4[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))],
                    coef.J.cluster.drop.excluding_9[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_9$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_9$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))],
                    coef.J.cluster.drop.excluding_14[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))],
                    coef.J.cluster.drop.excluding_19[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))],
                    coef.J.cluster.drop.excluding_29[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))],
                    coef.J.cluster.drop.excluding_49[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(1,28,10,30,19,32))))]),
              list("Cluster_Drop_Ex_2","Cluster_Drop_Ex_4","Cluster_Drop_Ex_9","Cluster_Drop_Ex_15","Cluster_Drop_Ex_19","Cluster_Drop_Ex_29","Cluster_Drop_Ex_49"),
              here(paste0("output/Tables/ind_reg_1930_met_1940_New_Sector_reg_1920_exclus.xlsx")))

## Region coefficients, New sector Serv and Main
wrapper_Excel(list(
                  coef.J.cluster.drop.excluding_2[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))],
                  coef.J.cluster.drop.excluding_4[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))],
                  coef.J.cluster.drop.excluding_9[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_9$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_9$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))],
                  coef.J.cluster.drop.excluding_14[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))],
                  coef.J.cluster.drop.excluding_19[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))],
                  coef.J.cluster.drop.excluding_29[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))],
                  coef.J.cluster.drop.excluding_49[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(3,29,12,31,21,33))))]),
              list("Cluster_Drop_Ex_2","Cluster_Drop_Ex_4","Cluster_Drop_Ex_9","Cluster_Drop_Ex_15","Cluster_Drop_Ex_19","Cluster_Drop_Ex_29","Cluster_Drop_Ex_49"),
              here(paste0("output/Tables/ind_reg_1930_met_1940_New_Main_Serv_reg_1920_exclus.xlsx")))

# 1930 Regressors
## Region coefficients, New sector Main
wrapper_Excel(list(
                  coef.J.cluster.drop.excluding_2[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))],
                  coef.J.cluster.drop.excluding_4[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))],
                  coef.J.cluster.drop.excluding_9[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_9$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_9$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))],
                  coef.J.cluster.drop.excluding_14[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))],
                  coef.J.cluster.drop.excluding_19[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))],
                  coef.J.cluster.drop.excluding_29[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))],
                  coef.J.cluster.drop.excluding_49[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(4,34,13,36,22,38))))]),
              list("Cluster_Drop_Ex_2","Cluster_Drop_Ex_4","Cluster_Drop_Ex_9","Cluster_Drop_Ex_15","Cluster_Drop_Ex_19","Cluster_Drop_Ex_29","Cluster_Drop_Ex_49"),
              here(paste0("output/Tables/ind_reg_1930_met_1940_New_Sector_reg_1930_exclus.xlsx")))

## Region coefficients, New sector Serv and Main
wrapper_Excel(list(
                  coef.J.cluster.drop.excluding_2[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))],
                  coef.J.cluster.drop.excluding_4[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))],
                  coef.J.cluster.drop.excluding_9[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))],
                  coef.J.cluster.drop.excluding_14[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))],
                  coef.J.cluster.drop.excluding_19[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))],
                  coef.J.cluster.drop.excluding_29[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))],
                  coef.J.cluster.drop.excluding_49[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1930)","H_1930","sh_lit_1930","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1930",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(6,25,15,37,24,39))))]),
              list("Cluster_Drop_Ex_2","Cluster_Drop_Ex_4","Cluster_Drop_Ex_9","Cluster_Drop_Ex_15","Cluster_Drop_Ex_19","Cluster_Drop_Ex_29","Cluster_Drop_Ex_49"),
              here(paste0("output/Tables/ind_reg_1930_met_1940_New_Main_Serv_reg_1930_exclus.xlsx")))

# 1930 New Sec, 1920 rest
## Region coefficients, New sector Main
wrapper_Excel(list(
                  coef.J.cluster.drop.excluding_2[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))],
                  coef.J.cluster.drop.excluding_4[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))],
                  coef.J.cluster.drop.excluding_9[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))],
                  coef.J.cluster.drop.excluding_14[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))],
                  coef.J.cluster.drop.excluding_19[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))],
                  coef.J.cluster.drop.excluding_29[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))],
                  coef.J.cluster.drop.excluding_49[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_all_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(7,40,16,42,25,44))))]),
              list("Cluster_Drop_Ex_2","Cluster_Drop_Ex_4","Cluster_Drop_Ex_9","Cluster_Drop_Ex_15","Cluster_Drop_Ex_19","Cluster_Drop_Ex_29","Cluster_Drop_Ex_49"),
              here(paste0("output/Tables/ind_reg_1930_met_1940_New_Sector_reg_mix_exclus.xlsx")))

## Region coefficients, New sector Serv and Main
wrapper_Excel(list(
                  coef.J.cluster.drop.excluding_2[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_2$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))],
                  coef.J.cluster.drop.excluding_4[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))],
                  coef.J.cluster.drop.excluding_9[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))],
                  coef.J.cluster.drop.excluding_14[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))],
                  coef.J.cluster.drop.excluding_19[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))],
                  coef.J.cluster.drop.excluding_29[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))],
                  coef.J.cluster.drop.excluding_49[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% c("new_sec_main_1930","new_sec_serv_1930","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs",c(grep("^sh_ind1950_main_[^1]_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE),grep("^sh_occ1950_main_[^0].+_1920",unique(coef.J.cluster.drop.excluding_4$rn),value=TRUE))),c("rn",c(paste0("model_",c(9,41,18,43,27,45))))]),
              list("Cluster_Drop_Ex_2","Cluster_Drop_Ex_4","Cluster_Drop_Ex_9","Cluster_Drop_Ex_15","Cluster_Drop_Ex_19","Cluster_Drop_Ex_29","Cluster_Drop_Ex_49"),
              here(paste0("output/Tables/ind_reg_1930_met_1940_New_Main_Serv_reg_mix_exclus.xlsx")))
```


## 3. Exercises to better understand some of the regression results

### 3.1. Looking at correlation between occ_1950 dummies and share of new work
#### 3.1.1. Call individual level data
```{r}
census_sample_1930_individual_data <-read_fst(here(paste0("output/Rdata/census_sample_1930_individual_data.fst")),as.data.table=TRUE)[occ1950_main!=979 & ind1950_main!=0,c("perwt_ID","ind1950_main","occ1950","occ1950_main","sh_base_tit","sh_new_method1")]

cols <- c("occ1950_main","occ1950")
census_sample_1930_individual_data[,(cols):=lapply(.SD,as.factor),.SDcols=cols]

```

#### 3.1.2. Box plot and histogram
```{r}
# Not grouping by occ1950
census_sample_1930_individual_data[,perwt_occ1950_main:=sum(perwt_ID),by=c("occ1950_main")][,occ1950_main_with_sample_size:=paste0(occ1950_main, "\n", "n=", perwt_occ1950_main)]

## Box plots
ggplot(census_sample_1930_individual_data, aes(x=occ1950_main, y=sh_new_method1)) +
  geom_boxplot(width=0.6, outlier.size=0.5) + geom_violin(width=3) + scale_fill_viridis(discrete = TRUE) +
  theme_tufte() +
  xlab("Main Occupational Groups") + ylab("Share of new work") +
  ggtitle("Share of New Work by New Occupation")

ggsave(here(paste0("output/Graphs/boxplot_sh_new_method1_by_occ1950_main.jpeg")),plot=last_plot())

## Histograms (y-axis displayed in percentages)
ggplot(data=census_sample_1930_individual_data, aes(x=sh_new_method1)) +
  geom_histogram(bins = 15,
                 aes(y = stat(width*density))) + 
  facet_wrap(~occ1950_main_with_sample_size) +
  scale_y_continuous(labels = percent_format()) +
  xlab("Share of New Work") + ylab("") +
  theme_tufte()

ggsave(here(paste0("output/Graphs/histogram_sh_new_method1_by_occ1950_main.jpeg")),plot=last_plot())

# Grouping by occ1950
## Aggregating the Data
census_sample_1930_individual_data <- census_sample_1930_individual_data[,perwt_occ1950:=sum(perwt_ID),by=c("occ1950")]
census_sample_1930_individual_data <- census_sample_1930_individual_data[,lapply(.SD, weighted.mean,w=perwt_ID),by=c("occ1950","occ1950_main"),.SDcols=c("perwt_occ1950","sh_base_tit","sh_new_method1")]

## Box Plot
ggplot(census_sample_1930_individual_data, aes(x=occ1950_main, y=sh_new_method1)) + geom_boxplot() +
  theme_tufte() +
  xlab("Main Occupational Groups") + ylab("Share of new work") +
  ggtitle("Share of New Work by New Occupation")

ggplot(census_sample_1930_individual_data, aes(x=occ1950_main, y=sh_new_method1)) +
    geom_violin(width=2,alpha=0.2) + geom_boxplot(width=0.6, outlier.size=0.5,alpha=0.2) +
 scale_fill_viridis(discrete = TRUE) +
  theme_tufte() +
  xlab("Main Occupational Groups") + ylab("Share of new work") +
  ggtitle("Share of New Work by New Occupation")

ggsave(here(paste0("output/Graphs/boxplot_sh_new_method1_by_occ1950_main_groupedinfo.jpeg")),plot=last_plot())


```
From the different graphs we notice a couple of things:
- In the boxplot using all the individual points we observe a lot of outliers. Additionally, many of them appear to have the same exact value across main occupational groups. Leaving aside the fortuitous cases where the share of new variable is effectively the same for different occind detailed occupations, this might be because IPUMS assigns a different occ1950 to individuals having the same occind.
- If we look at the coefficients for the occ1950_main dummies in the different regressions run, they more or less reflects what we can see in the boxplot (e.g. occ1950_main=0 has a more individuals with a higher sh_new_method1 than occ1950_main=100, but slightly less than occ1950_main=400)


#### 3.1.3. Table with shares at the occ1950_main level
```{r}
census_sample_1930_individual_data <- census_sample_1930_individual_data[,perwt_occ1950_main:=sum(perwt_occ1950),by=c("occ1950_main")]
census_sample_1930_individual_data <- census_sample_1930_individual_data[,lapply(.SD, weighted.mean,w=perwt_occ1950),by=c("occ1950_main"),.SDcols=c("perwt_occ1950_main","sh_base_tit","sh_new_method1")]

write.xlsx(new_titles.occind1930[[1]],here(paste0("output/Tables/Table_sh_new_method1_by_occ1950_main.xlsx")),row.names = TRUE)

```

#### 3.1.4. Regression of likelihood of new work only with occupation dummies
```{r}
census_sample_1930_individual_data <-read_fst(here(paste0("output/Rdata/census_sample_1930_individual_data.fst")),as.data.table=TRUE)[,c("perwt_ID","ind1950_main","occind","occ1950_main","sh_base_tit","sh_new_method1")]
census_sample_1930_individual_data[,occ1950_main:=as.factor(occ1950_main)]

a <- list(as.formula(paste0("sh_new_method1 ~ occ1950_main")))
coef <- f_regressions(arg_formula=a,arg_data=census_sample_1930_individual_data,arg_weights=perwt_ID,method="lm",arg_clusters=occind)

write.xlsx(coef[(variable=="coef_star" | variable =="std_par" | variable=="zother"),c("rn",c(paste0("model_",c(1))))],
           here(paste0("output/Tables/ind_reg_1930_sh_new_method1_by_occ1950_main.xlsx")),row.names = TRUE)

```
Note that the explanatory value of the occupational dummies is very high (adj R^2=0.23). In the regressions without occ1950_main, the explanatory value is of the order of 0.16.

### 3.2. Looking at correlation between sh_occ_1950_main and share of new work
Graphs showing the correlation between the share of employment in each main occupational group and the share of new work were created in section Part 1., 1/2. The sign and strength of the correlation graphs are more or less in agreement with the sign of the coefficients associated with the sh_occ1950_main variables (e.g. negative and significant coefficient for sh_occ1950_main_600).

#### 3.2.0. Functions to simplify ind1950 and occ1950
```{r}
f_ind1950 <- function(X,sec_v,flag=0) {
  setnames( X,c(deparse(substitute(sec_v))),c("industry"))
  
  X <- X[industry %in% 100:199,ind1950_main:=1] # Agriculture
  X <- X[industry %in% 200:299,ind1950_main:=2] # Mining and Construction
  X <- X[industry %in% 300:499,ind1950_main:=3] # Manufacturing
  X <- X[industry %in% 500:599,ind1950_main:=4] # Transportation, Communication, and Other Utilities
  X <- X[industry %in% 600:699,ind1950_main:=5] # Trade
  X <- X[industry %in% 700:899,ind1950_main:=6] # Services
  X <- X[industry %in% 900:949,ind1950_main:=7] # Public Administration
  X <- X[industry == 0 | industry>=950,ind1950_main:=0] # Non-specified, missing
  
  if (flag==0) {
    setnames(X,c("industry"),c(deparse(substitute(sec_v))))
  } else {
    # Drop the individual industry number
    X <- X[,industry:=NULL]
  }
  return(X)
}


### Main occupation using occ1950
# We use the occ1950 because it is available in every sample. We have to think carefully what might be the issue if you use occ for other parts of the work.
# NOTE: you need to provide the ind1950 variable
f_occ1950 <- function(X,occ_v,flag=0) {
  setnames( X,c(deparse(substitute(occ_v))),c("occupation"))
  
  X <- X[occupation >= 0 & occupation<= 99 ,occ1950_main:= 0] #           "Professional, Technical"
  X <- X[occupation >= 100 & occupation<= 199, occ1950_main:= 100 ] #     "Farmers"
  X <- X[occupation >= 200 & occupation<= 299, occ1950_main:= 200] #      "Managers, Officials, and Proprietors"',
  X <- X[occupation >= 300 & occupation<= 399, occ1950_main:= 300] #      "Clerical and Kindred"
  X <- X[occupation >= 400 & occupation<= 499, occ1950_main:= 400] #      "Sales workers"
  X <- X[occupation >= 500 & occupation<= 599 , occ1950_main:= 500] #     "Craftsmen"
  X <- X[occupation >= 600 & occupation<= 699, occ1950_main:= 600] #      "Operatives"
  X <- X[occupation >= 700 & occupation<= 729, occ1950_main:= 700] #      "Service Workers (private household)"
  X <- X[occupation >= 730 & occupation<= 799, occ1950_main:= 730] #      "Service Workers (not household)"
  X <- X[occupation >= 800 & occupation<= 899, occ1950_main:= 800] #      "Farm laborers"
  X <- X[occupation >= 900 & occupation<= 970, occ1950_main:= 900] #      "Laborers"
  X <- X[occupation >= 979 & occupation<= 999, occ1950_main:= 979] #      "Missing, not classified"
  
  if (flag==0) {
    setnames(X,c("occupation"),c(deparse(substitute(occ_v))))
  } else {
    # Drop the individual industry number
    X <- X[,occupation:=NULL]
  }
  return(X)
}
```


#### 3.2.1. Different regressions focusing on sh_occ_1950_main variables
##### countynhg_1910
```{r}
# Calling database of interest
census_sample_1930_individual_data <-read_fst(here(paste0("output/Rdata/census_sample_1930_individual_data_x_countynhg_1910.fst")),as.data.table=TRUE)

# Creating Categorical variables
cols <- c("race","marst","age_main","ind1950_main","occ1950_main")
census_sample_1930_individual_data[,(cols):=lapply(.SD,as.factor),.SDcols=cols]


# Regressions
## Formulas for the regressions
base_individual <- paste0(c("male","lit","marst","race","wwages","mig_us","mig_ab"),collapse=" + ")
occsh_var_1920 <- grep("^sh_occ1950_main_[^0].+_1920",names(census_sample_1930_individual_data),value=TRUE)
indsh_var_1920 <- grep("^sh_ind1950_main_[^1]_1920",names(census_sample_1930_individual_data),value=TRUE)

a <- vector(mode = "list")
j <- 1
for (i1 in c(" + "," + ind1950_main +")) {
# With/without ind1950_main
  for (i2 in c(" ~ "," ~ new_sec_all_1920 +", " ~ new_sec_main_1920 + new_sec_serv_1920 + "," ~ new_sec_main_1920 +")) {
  # Different new sector variable
    for (i3 in c(
        "",
        paste0(" + ",paste0(indsh_var_1920,collapse=" + ")),
        paste0(" + ",paste0(occsh_var_1920,collapse=" + ")),
        " + sh_occ1950_main_100_1920 + sh_occ1950_main_200_1920 + sh_occ1950_main_300_1920 + sh_occ1950_main_400_1920 + sh_occ1950_main_700_1920 + sh_occ1950_main_730_1920 + sh_occ1950_main_800_1920 + sh_occ1950_main_900_1920",
        " + sh_occ1950_main_100_1920 + sh_occ1950_main_200_1920 + sh_occ1950_main_300_1920 + sh_occ1950_main_400_1920 + sh_occ1950_main_500_1920 +sh_occ1950_main_700_1920 + sh_occ1950_main_730_1920 + sh_occ1950_main_800_1920 + sh_occ1950_main_900_1920",
        " + sh_occ1950_main_100_1920 + sh_occ1950_main_200_1920 + sh_occ1950_main_300_1920 + sh_occ1950_main_400_1920 + sh_occ1950_main_600_1920 +sh_occ1950_main_700_1920 + sh_occ1950_main_730_1920 + sh_occ1950_main_800_1920 + sh_occ1950_main_900_1920",
        paste0(" + ",paste0(occsh_var_1920,collapse=" + ")," + ",paste0(indsh_var_1920,collapse=" + ")), 
        paste0(" + sh_occ1950_main_100_1920 + sh_occ1950_main_200_1920 + sh_occ1950_main_300_1920 + sh_occ1950_main_400_1920 + sh_occ1950_main_700_1920 + sh_occ1950_main_730_1920 + sh_occ1950_main_800_1920 + sh_occ1950_main_900_1920 "," + ",paste0(indsh_var_1920,collapse=" + ")), 
        paste0(" + sh_occ1950_main_100_1920 + sh_occ1950_main_200_1920 + sh_occ1950_main_300_1920 + sh_occ1950_main_400_1920 + sh_occ1950_main_500_1920+ sh_occ1950_main_700_1920 + sh_occ1950_main_730_1920 + sh_occ1950_main_800_1920 + sh_occ1950_main_900_1920 "," + ",paste0(indsh_var_1920,collapse=" + ")), 
        paste0(" + sh_occ1950_main_100_1920 + sh_occ1950_main_200_1920 + sh_occ1950_main_300_1920 + sh_occ1950_main_400_1920 + sh_occ1950_main_600_1920+ sh_occ1950_main_700_1920 + sh_occ1950_main_730_1920 + sh_occ1950_main_800_1920 + sh_occ1950_main_900_1920 "," + ",paste0(indsh_var_1920,collapse=" + "))
        )
      ) {
    # Different industry variable
      a[[j]] <- as.formula(paste("sh_new_method1 ",i2,paste0(base_individual,collapse=" + "),i1," sh_lit_1920 + log(perwt_1920) + H_1920",i3))
      j <- j + 1
    }
  }
}

b <- vector(mode = "list")
j <- 1
for (i1 in c(" + "," + ind1950_main +")) {
# With/without ind1950_main
  for (i2 in c(" ~ "," ~ new_sec_all_1920 +")) {
  # Different new sector variable
    for (i3 in c("",paste(" + ",paste0(indsh_var_1920,collapse=" + ")))  ) {
    # With/without industry variable
      for (i4 in c(0,100,200,300,400,500,600,700,730,800,900) ) {
      # different occ share variables
        b[[j]] <- as.formula(paste("sh_new_method1 ",i2,paste0(base_individual,collapse=" + "),i1," sh_lit_1920 + log(perwt_1920) + H_1920 ",i3,paste0(" + sh_occ1950_main_",i4,"_1920")))
        j <- j + 1
      }
      b[[j]] <- as.formula(paste("sh_new_method1 ",i2,paste0(base_individual,collapse=" + "),i1," sh_lit_1920 + log(perwt_1920) + H_1920 ",i3,paste0(" + sh_occ1950_main_500_1920 + sh_occ1950_main_600_1920")))
      j <- j + 1
    }
  }
}

c <- vector(mode = "list")
j <- 1
for (i in c(0,100,200,300,400,500,600,700,730,800,900) ) {
  c[[j]] <- as.formula(paste("new_sec_all_1920 ~ ",paste0("sh_occ1950_main_",i,"_1920"))) 
  j <- j+1 }
for (i in c(0,100,200,300,400,500,600,700,730,800,900) ) {
  c[[j]] <- as.formula(paste("new_sec_all_1920 ~ ",paste0("sh_occ1950_main_",i,"_1920")," + ",paste0(base_individual,collapse=" + ")))
  j <- j+1 }
for (i in c(0,100,200,300,400,500,600,700,730,800,900) ) {
  c[[j]] <- as.formula(paste("new_sec_all_1920 ~ ",paste0("sh_occ1950_main_",i,"_1920")," + ",paste0(base_individual,collapse=" + "),"+ sh_lit_1920 + log(perwt_1920) + H_1920"))
  j <- j+1}
for (i in c(0,100,200,300,400,500,600,700,730,800,900) ) {
  c[[j]] <- as.formula(paste("new_sec_all_1920 ~ ",paste0("sh_occ1950_main_",i,"_1920")," + ",paste0(base_individual,collapse=" + "),"+ sh_lit_1920 + log(perwt_1920) + H_1920"," + ",paste0(indsh_var_1920,collapse=" + "))) 
  j <- j+1 }



## Regressions
### Without dropping workers
coef.all <- f_regressions(arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930>10000],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)[  (variable=="coef_star" | variable =="std_par" | variable=="zother") & (rn %in% c("new_sec_all_1920","new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs","ind1950_main2",occsh_var_1920,indsh_var_1920 ) )  ]

### Dropping workers in all new sectors
coef.no_new_all <- f_regressions(arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930>10000 & !(ind1950 %in% c(376,377,466,556,606,667,668,816,856))],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)[  (variable=="coef_star" | variable =="std_par" | variable=="zother") & (rn %in% c("new_sec_all_1920","new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs","ind1950_main2",occsh_var_1920,indsh_var_1920 ) )  ]

coef.no_new_all_different_occsh <- f_regressions(arg_formula=b,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930>10000 & !(ind1950 %in% c(376,377,466,556,606,667,668,816,856))],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)[  (variable=="coef_star" | variable =="std_par" | variable=="zother") & (rn %in% c("new_sec_all_1920","new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs","ind1950_main2","sh_occ1950_main_0_1920",occsh_var_1920,indsh_var_1920 ) )  ]

### Dropping workers in main new sectors
coef.no_new_serv <- f_regressions(arg_formula=a[c(1:6,19:24,25:30,43:48)],arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930>10000 & !(ind1950 %in% c(376,377,466,856))],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)[  (variable=="coef_star" | variable =="std_par" | variable=="zother") & (rn %in% c("new_sec_all_1920","new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs","ind1950_main2",occsh_var_1920,indsh_var_1920 ) )  ]

### New sector on sh_occ
coef.new_sector_x_sh_occ <- f_regressions(arg_formula=c,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930>10000],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)[  (variable=="coef_star" | variable =="std_par" | variable=="zother") & (rn %in% c(occsh_var_1920,indsh_var_1920,"log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs","ind1950_main2","sh_occ1950_main_0_1920",occsh_var_1920,"sh_ind1950_main_1_1920",indsh_var_1920) )   ]

coef.positive_sh_new_sec_1920 <- f_regressions(arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930>10000 & new_sec_all_1920>0 & !(ind1950 %in% c(376,377,466,556,606,667,668,816,856))],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)[  (variable=="coef_star" | variable =="std_par" | variable=="zother") & (rn %in% c("new_sec_all_1920","new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs","ind1950_main2",occsh_var_1920,indsh_var_1920 ) )  ]

coef.positive_sh_new_sec_1930 <- f_regressions(arg_formula=a,arg_data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930>10000 & new_sec_all_1930>0 & !(ind1950 %in% c(376,377,466,556,606,667,668,816,856))],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occind)[  (variable=="coef_star" | variable =="std_par" | variable=="zother") & (rn %in% c("new_sec_all_1920","new_sec_main_1920","new_sec_serv_1920","log(perwt_1920)","H_1920","sh_lit_1920","adj.r2","nobs","ind1950_main2",occsh_var_1920,indsh_var_1920 ) )  ]



## Exporting Regressions
#write.xlsx(coef[(variable=="coef_star" | variable =="std_par" | variable=="zother"),c("rn",c(paste0("model_",c(1:4))))],here(paste0("output/Tables/ind_reg_1930_sh_new_method1_by_sh_occ1950_main_countynhg_1910.xlsx")),row.names = FALSE)
wrapper_Excel(list( coef.all, coef.no_new_all,coef.no_new_serv,coef.no_new_all_different_occsh,coef.new_sector_x_sh_occ,coef.positive_sh_new_sec_1920,coef.positive_sh_new_sec_1930
                  ),
              list("Cluster_No_Drop","Cluster_Drop_All_New","Cluster_Drop_New_Main","Cl_drop_All_Different_occsh","New_sec_x_sh_occ","Original_pos_all_new_1920","Original_pos_all_new_1930"),
              here(paste0("output/Tables/ind_reg_1930_countynhg_1910_robustness_occsh_problem.xlsx")))

```
The results don't give any further information about why the New Sector's variable looses significance when we introduce the share of the main occupations

#### 3.2.2. Ranking of sectors according to the share of different occupations
```{r}
# Call the regional dataset
census_sample_new_sectors_occsh_1920 <- read_fst(here(paste0("input/census_sample/census_sample_1920.fst")),as.data.table=TRUE)[,c("perwt","ind1950","occ1950")]

census_sample_new_sectors_occsh_1920 <- f_ind1950(census_sample_new_sectors_occsh_1920,ind1950,flag=0)[!(ind1950_main == 0 | is.na(ind1950))]
census_sample_new_sectors_occsh_1920 <- f_occ1950(census_sample_new_sectors_occsh_1920,occ1950,flag=0)[!(occ1950_main == 979 | is.na(occ1950))]
census_sample_new_sectors_occsh_1920 <- census_sample_new_sectors_occsh_1920[,lapply(.SD,sum),by=c("ind1950","ind1950_main","occ1950_main"),.SDcols=c("perwt")]
census_sample_new_sectors_occsh_1920 <- census_sample_new_sectors_occsh_1920[,perwt_ind1950:=sum(perwt),by=c("ind1950")][,sh_occ1950_main_x_ind1950:=perwt/perwt_ind1950]

setorder(census_sample_new_sectors_occsh_1920,occ1950_main,-sh_occ1950_main_x_ind1950)

```

### 3.3. Correlation between share of new sectors and share of occupations
##### 3.3.1. Creating the info
```{r}
 
## Calling the regional level information
census_sample_new_work_x_new_sectors <- read_fst(here(paste0("output/Rdata/census_sample_1920_agg_countynhg_1910.fst")),as.data.table=TRUE)
census_sample_new_work_x_new_sectors <- census_sample_new_work_x_new_sectors[,grep("^countynhg_1910|^sh_red|^sh_base|^sh_occ1950_main|^sh_new_sector|^sh_ind1950|perwt",names(census_sample_new_work_x_new_sectors),value=TRUE),with=FALSE]

col <- names(census_sample_new_work_x_new_sectors[,!c("countynhg_1910")])
setnames(census_sample_new_work_x_new_sectors,col,paste0(col,"_1920"))

temp <- read_fst(here(paste0("output/Rdata/census_sample_1930_agg_countynhg_1910.fst")),as.data.table=TRUE)
temp <- temp[, grep("^countynhg_1910|^sh_red|^sh_base|^sh_occ1950_main|^sh_new_sector|^sh_ind1950|^perwt",names(temp),value=TRUE),with=FALSE]
col <- names(temp[,!c("countynhg_1910")])
setnames(temp,col,paste0(col,"_1930"))
census_sample_new_work_x_new_sectors <- merge(census_sample_new_work_x_new_sectors,temp,by="countynhg_1910",all=FALSE)
rm(temp)

census_sample_new_work_x_new_sectors <- census_sample_new_work_x_new_sectors[,                                                                                                        
                                      `:=`(new_sec_all_1920 = sh_new_sector_ind1950_376_1920 + sh_new_sector_ind1950_377_1920 + sh_new_sector_ind1950_556_1920 +sh_new_sector_ind1950_606_1920 + sh_new_sector_ind1950_667_1920 + sh_new_sector_ind1950_668_1920 + sh_new_sector_ind1950_816_1920 + sh_new_sector_ind1950_466_1920,                                                                                                               new_sec_all_1930 = sh_new_sector_ind1950_376_1930 +sh_new_sector_ind1950_377_1930 + sh_new_sector_ind1950_556_1930 + sh_new_sector_ind1950_606_1930  + sh_new_sector_ind1950_667_1930 + sh_new_sector_ind1950_668_1930 +sh_new_sector_ind1950_816_1930 + sh_new_sector_ind1950_856_1930 + sh_new_sector_ind1950_466_1930)][,
                    `:=`(new_sec_main_1920 =sh_new_sector_ind1950_376_1920 + sh_new_sector_ind1950_377_1920 + sh_new_sector_ind1950_466_1920,
                         new_sec_main_1930 = sh_new_sector_ind1950_376_1930 +sh_new_sector_ind1950_377_1930 + sh_new_sector_ind1950_466_1930 + sh_new_sector_ind1950_856_1930)][,
                    `:=`(new_sec_serv_1920 = sh_new_sector_ind1950_556_1920 + sh_new_sector_ind1950_606_1920 + sh_new_sector_ind1950_667_1920 + sh_new_sector_ind1950_668_1920+sh_new_sector_ind1950_816_1920,
                         new_sec_serv_1930 = sh_new_sector_ind1950_556_1930 + sh_new_sector_ind1950_606_1930 + sh_new_sector_ind1950_667_1930 + sh_new_sector_ind1950_668_1930+sh_new_sector_ind1950_816_1930)]

```

#### 3.3.2. Simple correlations
```{r}
corr_1 <- corr_2 <- corr_3 <- corr_4 <- corr_p1 <- corr_p2 <- vector()
j <- 1
for (i in grep("^sh_occ1950_.+_1920",names(census_sample_new_work_x_new_sectors),value=TRUE) ) {
  #temp1 <- census_sample_new_work_x_new_sectors[,c(eval(parse(text=paste0(i))))]
  #temp2 <- census_sample_1930_individual_data[,c(eval(parse(text=paste0(i))))]
  corr_1[j] <- cor(census_sample_new_work_x_new_sectors$new_sec_all_1920, 
                   census_sample_new_work_x_new_sectors[,c(eval(parse(text=paste0(i))))], 
                   use="complete.obs", method = c("pearson"))
  corr_2[j] <- cor(census_sample_1930_individual_data$new_sec_all_1920,
                  census_sample_1930_individual_data[,c(eval(parse(text=paste0(i))))],
                  use="complete.obs", method = c("pearson"))
  corr_3[j] <- cor(census_sample_new_work_x_new_sectors$sh_new_method1_1930, 
                   census_sample_new_work_x_new_sectors[,c(eval(parse(text=paste0(i))))], 
                   use="complete.obs", method = c("pearson"))
  corr_4[j] <- cor(census_sample_1930_individual_data$sh_new_method1,
                  census_sample_1930_individual_data[,c(eval(parse(text=paste0(i))))],
                  use="complete.obs", method = c("pearson"))
  corr_p1[j] <- wtd.cors(census_sample_new_work_x_new_sectors$new_sec_all_1920, 
                   census_sample_new_work_x_new_sectors[,c(eval(parse(text=paste0(i))))],
                   weight=census_sample_new_work_x_new_sectors$perwt_1930)
  corr_p2[j] <- wtd.cors(census_sample_new_work_x_new_sectors$sh_new_method1_1930, 
                   census_sample_new_work_x_new_sectors[,c(eval(parse(text=paste0(i))))],
                   weight=census_sample_new_work_x_new_sectors$perwt_1930)
  j <- j+1
}
Corr <- data.table(variable=grep("^sh_occ1950_.+_1920",names(census_sample_new_work_x_new_sectors),value=TRUE),
                   new_sec_agg=corr_1,
                   new_sec_agg_wt=corr_p1,
                   new_sec_ind=corr_2,
                   new_work_agg=corr_3,
                   new_work_agg_wt=corr_p2,
                   new_work_ind=corr_4)
rm(list = ls(pattern="^corr_") )

```


#### 3.3.3. Regressions
##### 3.3.3.1. countynhg_1910
```{r}
# Creating vector of regressions
a <- b <- c <- vector(mode = "list")
for (i in c(0,100,200,300,400,500,600,700,730,800,900)) {
  if (i==0) {j <- 1}
  a[[j]] <- as.formula(paste0("new_sec_all_1920 ~ sh_occ1950_main_",i,"_1920"))
  b[[j]] <- as.formula(paste0("new_sec_main_1920 ~ sh_occ1950_main_",i,"_1920"))
  c[[j]] <- as.formula(paste0("new_sec_serv_1920 ~ sh_occ1950_main_",i,"_1920"))
  j <- j+1
}
occsh_var_1920 <- grep("^sh_occ1950_main_[^0].+_1920",names(census_sample_new_work_x_new_sectors),value=TRUE)
a[[j]] <- as.formula(paste("new_sec_all_1920 ~ ",paste0(occsh_var_1920,collapse=" + ")))
b[[j]] <- as.formula(paste("new_sec_main_1920 ~ ",paste0(occsh_var_1920,collapse=" + ")))
c[[j]] <- as.formula(paste("new_sec_serv_1920 ~ ",paste0(occsh_var_1920,collapse=" + ")))



# Regressions
reg.all <- f_regressions(arg_formula=a,arg_data=census_sample_new_work_x_new_sectors[perwt_1930 > 10000],method="lm")[(variable=="coef_star" | variable =="std_par" | variable=="zother")]
reg.all_weights_1920 <- f_regressions(arg_formula=a,arg_data=census_sample_new_work_x_new_sectors[perwt_1930 > 10000],method="lm",arg_weights=perwt_1920)[(variable=="coef_star" | variable =="std_par" | variable=="zother")]
reg.all_weights_1930 <- f_regressions(arg_formula=a,arg_data=census_sample_new_work_x_new_sectors[perwt_1930 > 10000],method="lm",arg_weights=perwt_1930)[(variable=="coef_star" | variable =="std_par" | variable=="zother")]
reg.main <- f_regressions(arg_formula=b,arg_data=census_sample_new_work_x_new_sectors[perwt_1930 > 10000],method="lm")[(variable=="coef_star" | variable =="std_par" | variable=="zother")]
reg.main_weights_1920 <- f_regressions(arg_formula=b,arg_data=census_sample_new_work_x_new_sectors[perwt_1930 > 10000],method="lm",arg_weights=perwt_1920)[(variable=="coef_star" | variable =="std_par" | variable=="zother")]
reg.main_weights_1930 <- f_regressions(arg_formula=b,arg_data=census_sample_new_work_x_new_sectors[perwt_1930 > 10000],method="lm",arg_weights=perwt_1930)[(variable=="coef_star" | variable =="std_par" | variable=="zother")]
reg.serv <- f_regressions(arg_formula=c,arg_data=census_sample_new_work_x_new_sectors[perwt_1930 > 10000],method="lm")[(variable=="coef_star" | variable =="std_par" | variable=="zother")]
reg.serv_weights_1920 <- f_regressions(arg_formula=c,arg_data=census_sample_new_work_x_new_sectors[perwt_1930 > 10000],method="lm",arg_weights=perwt_1920)[(variable=="coef_star" | variable =="std_par" | variable=="zother")]
reg.serv_weights_1930 <- f_regressions(arg_formula=c,arg_data=census_sample_new_work_x_new_sectors[perwt_1930 > 10000],method="lm",arg_weights=perwt_1930)[(variable=="coef_star" | variable =="std_par" | variable=="zother")]


wrapper_Excel(list( reg.all, reg.all_weights_1920, reg.all_weights_1930,reg.main, reg.main_weights_1920, reg.main_weights_1930,reg.serv, reg.serv_weights_1920, reg.serv_weights_1930
                  ),
              list("All","Main","Serv","All_wt1920","Main_wt1920","Serv_wt1920","All_wt1930","Main_wt1930","Serv_wt1930"),
              here(paste0("output/Tables/ind_reg_1930_countynhg_1910_robustness_new_sec_x_occsh.xlsx")))


```

### 3.4. Correlation between Share of New Work and Share of New Sectors
#### countynhg_1910
```{r}
# Calling the data
census_sample_new_work_x_new_sectors <- read_fst(here(paste0("output/Rdata/census_sample_1920_agg_countynhg_1910.fst")),as.data.table=TRUE)
census_sample_new_work_x_new_sectors <- census_sample_new_work_x_new_sectors[,grep("^countynhg_1910|^sh_red|^sh_base|^sh_occ1950_main|^sh_new_sector|^sh_ind1950|perwt",names(census_sample_new_work_x_new_sectors),value=TRUE),with=FALSE]
col <- names(census_sample_new_work_x_new_sectors[,!c("countynhg_1910")])
setnames(census_sample_new_work_x_new_sectors,col,paste0(col,"_1920"))

temp <- read_fst(here(paste0("output/Rdata/census_sample_1930_agg_countynhg_1910.fst")),as.data.table=TRUE)
temp <- temp[, grep("^countynhg_1910|^sh_red|^sh_base|^sh_occ1950_main|^sh_new_sector|^sh_ind1950|^perwt",names(temp),value=TRUE),with=FALSE]
col <- names(temp[,!c("countynhg_1910")])
setnames(temp,col,paste0(col,"_1930"))
census_sample_new_work_x_new_sectors <- merge(census_sample_new_work_x_new_sectors,temp,by="countynhg_1910",all=FALSE)
rm(temp)

census_sample_new_work_x_new_sectors <- census_sample_new_work_x_new_sectors[,`:=`(new_sec_all_1920=sh_new_sector_ind1950_376_1920+sh_new_sector_ind1950_377_1920+sh_new_sector_ind1950_606_1920+sh_new_sector_ind1950_668_1920+sh_new_sector_ind1950_816_1920,new_sec_all_1930=sh_new_sector_ind1950_376_1930+sh_new_sector_ind1950_377_1930+sh_new_sector_ind1950_606_1930+sh_new_sector_ind1950_668_1930+sh_new_sector_ind1950_816_1930+sh_new_sector_ind1950_856_1930)][,`:=`(new_sec_main_1920=sh_new_sector_ind1950_376_1920+sh_new_sector_ind1950_377_1920,new_sec_main_1930=sh_new_sector_ind1950_376_1930+sh_new_sector_ind1950_377_1930+sh_new_sector_ind1950_856_1930)][,`:=`(new_sec_serv_1920=sh_new_sector_ind1950_606_1920+sh_new_sector_ind1950_668_1920+sh_new_sector_ind1950_816_1920,new_sec_serv_1930=sh_new_sector_ind1950_606_1930+sh_new_sector_ind1950_668_1930+sh_new_sector_ind1950_816_1930)]

# Crating rank variables
setorder(census_sample_new_work_x_new_sectors,-new_sec_all_1920)
census_sample_new_work_x_new_sectors[,rank_new_sec_1920:=1:.N]
setorder(census_sample_new_work_x_new_sectors,-new_sec_all_1930)
census_sample_new_work_x_new_sectors[,rank_new_sec_1930:=1:.N]

# Correlations
## New Work, New Sectors
p <- vector(mode = "list")
p[[1]] <- ggplot(census_sample_new_work_x_new_sectors[perwt_1930>=10000], aes(y=sh_new_method1_1930, x=new_sec_all_1920)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="",x="Share of New Sector", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))
ggsave(here(paste0("output/Graphs/countynhg_1910/corr_sh_new_sectors_1930_x_sh_new_method1_1920.jpeg")),plot=last_plot())


### Excluding counties with the highest share of new sectors
for (i in c(3,5,10,20,50)) {
      if (i==3) {j <- 2}
      p[[j]] <- ggplot(census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=i], aes(y=sh_new_method1_1930, x=new_sec_all_1920)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="",x="Share of New Sector", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))
      j <- j+1
}
ggarrange(p[[1]],p[[2]],p[[3]],p[[4]],
          labels = c("All", "Excl. 2", "Excl. 4", "Excl. 9"),
          ncol = 2, nrow = 2)
ggsave(here(paste0("output/Graphs/countynhg_1910/corr_sh_new_sectors_1930_x_sh_new_method1_1920_excl_reg_1.jpeg")),plot=last_plot())
ggarrange(p[[5]],p[[6]],
          labels = c("Excl. 19", "Excl. 49"),
          ncol = 2, nrow = 2)
ggsave(here(paste0("output/Graphs/countynhg_1910/corr_sh_new_sectors_1930_x_sh_new_method1_1920_excl_reg_2.jpeg")),plot=last_plot())  
rm(p)

## New Sectors, Share of occupations
x <- c("sh_occ1950_main_0_1920","sh_occ1950_main_100_1920","sh_occ1950_main_200_1920","sh_occ1950_main_300_1920","sh_occ1950_main_400_1920","sh_occ1950_main_500_1920","sh_occ1950_main_600_1920","sh_occ1950_main_700_1920","sh_occ1950_main_730_1920","sh_occ1950_main_800_1920","sh_occ1950_main_900_1920")
p <- vector(mode = "list", length = length(x))
for (i in 1:length(x)) {
  p[[i]] <- ggplot(census_sample_new_work_x_new_sectors, aes_string(y="new_sec_all_1920", x= x[i])) +
            geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) +
            labs(title="",x="Share of workers", y = "Share of New Sectors") + theme(axis.line=element_line(color="black"), legend.position = "top") + theme_tufte() 
}
ggarrange(p[[1]],p[[2]],p[[3]],p[[4]],labels=c("Professional, Technical","Farmers","Managers, Officials and Proprietors","Clerical and Kindred"),font.label = list(size = 10),
          ncol = 2, nrow =2)
ggsave(here(paste0("output/Graphs/countynhg_1910/corr_sh_occ1950_main_x_sh_new_sectors_1.jpeg")),plot=last_plot())
ggarrange(p[[5]],p[[6]],p[[7]],p[[8]],labels=c("Sales workers","Craftsmen","Operatives","Service Workers (private household)"),font.label = list(size = 10), ncol = 2, nrow =2)
#ggsave(here(paste0("output/Graphs/countynhg_1910/corr_sh_occ1950_main_x_sh_new_sectors_2.jpeg")),plot=last_plot())
ggarrange(p[[9]],p[[10]],p[[11]],labels=c("Service Workers (not household)","Farm laborers","Laborers"),font.label = list(size = 10),
          ncol = 2, nrow =2)
#ggsave(here(paste0("output/Graphs/countynhg_1910/corr_sh_occ1950_main_x_sh_new_sectors_3.jpeg")),plot=last_plot())
rm(p)
```

#### metarea_1940
```{r}
# Calling the data
census_sample_new_work_x_new_sectors <- read_fst(here(paste0("output/Rdata/census_sample_1920_agg_metarea_1940.fst")),as.data.table=TRUE)
census_sample_new_work_x_new_sectors <- census_sample_new_work_x_new_sectors[,grep("^metarea_1940|^sh_red|^sh_base|^sh_occ1950_main|^sh_new_sector|^sh_ind1950|perwt",names(census_sample_new_work_x_new_sectors),value=TRUE),with=FALSE]
col <- names(census_sample_new_work_x_new_sectors[,!c("metarea_1940")])
setnames(census_sample_new_work_x_new_sectors,col,paste0(col,"_1920"))

temp <- read_fst(here(paste0("output/Rdata/census_sample_1930_agg_metarea_1940.fst")),as.data.table=TRUE)
temp <- temp[, grep("^metarea_1940|^sh_red|^sh_base|^sh_occ1950_main|^sh_new_sector|^sh_ind1950|^perwt",names(temp),value=TRUE),with=FALSE]
col <- names(temp[,!c("metarea_1940")])
setnames(temp,col,paste0(col,"_1930"))
census_sample_new_work_x_new_sectors <- merge(census_sample_new_work_x_new_sectors,temp,by="metarea_1940",all=FALSE)
rm(temp)

census_sample_new_work_x_new_sectors <- census_sample_new_work_x_new_sectors[,`:=`(new_sec_all_1920=sh_new_sector_ind1950_376_1920+sh_new_sector_ind1950_377_1920+sh_new_sector_ind1950_606_1920+sh_new_sector_ind1950_668_1920+sh_new_sector_ind1950_816_1920,new_sec_all_1930=sh_new_sector_ind1950_376_1930+sh_new_sector_ind1950_377_1930+sh_new_sector_ind1950_606_1930+sh_new_sector_ind1950_668_1930+sh_new_sector_ind1950_816_1930+sh_new_sector_ind1950_856_1930)][,`:=`(new_sec_main_1920=sh_new_sector_ind1950_376_1920+sh_new_sector_ind1950_377_1920,new_sec_main_1930=sh_new_sector_ind1950_376_1930+sh_new_sector_ind1950_377_1930+sh_new_sector_ind1950_856_1930)][,`:=`(new_sec_serv_1920=sh_new_sector_ind1950_606_1920+sh_new_sector_ind1950_668_1920+sh_new_sector_ind1950_816_1920,new_sec_serv_1930=sh_new_sector_ind1950_606_1930+sh_new_sector_ind1950_668_1930+sh_new_sector_ind1950_816_1930)]

# Crating rank variables
setorder(census_sample_new_work_x_new_sectors,-new_sec_all_1920)
census_sample_new_work_x_new_sectors[,rank_new_sec_1920:=1:.N]
setorder(census_sample_new_work_x_new_sectors,-new_sec_all_1930)
census_sample_new_work_x_new_sectors[,rank_new_sec_1930:=1:.N]


# Correlations
## New Work, New Sectors
p <- vector(mode = "list")
p[[1]] <- ggplot(census_sample_new_work_x_new_sectors[perwt_1930>=10000], aes(y=sh_new_method1_1930, x=new_sec_all_1920)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="",x="Share of New Sector", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))
ggsave(here(paste0("output/Graphs/metarea_1940/corr_sh_new_sectors_1930_x_sh_new_method1_1920.jpeg")),plot=last_plot())


### Excluding counties with the highest share of new sectors
for (i in c(3,5,10,15,20)) {
      if (i==3) {j <- 2}
      p[[j]] <- ggplot(census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=i], aes(y=sh_new_method1_1930, x=new_sec_all_1920)) + geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="",x="Share of New Sector", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))
      j <- j+1
}
ggarrange(p[[1]],p[[2]],p[[3]],p[[4]],
          labels = c("All", "Excl. 2", "Excl. 4", "Excl. 9"),
          ncol = 2, nrow = 2)
ggsave(here(paste0("output/Graphs/metarea_1940/corr_sh_new_sectors_1930_x_sh_new_method1_1920_excl_reg_1.jpeg")),plot=last_plot())
ggarrange(p[[5]],p[[6]],
          labels = c("Excl. 14", "Excl. 19"),
          ncol = 2, nrow = 2)
ggsave(here(paste0("output/Graphs/metarea_1940/corr_sh_new_sectors_1930_x_sh_new_method1_1920_excl_reg_2.jpeg")),plot=last_plot())

rm(p)
## New Sectors, Share of occupations
x <- c("sh_occ1950_main_0_1920","sh_occ1950_main_100_1920","sh_occ1950_main_200_1920","sh_occ1950_main_300_1920","sh_occ1950_main_400_1920","sh_occ1950_main_500_1920","sh_occ1950_main_600_1920","sh_occ1950_main_700_1920","sh_occ1950_main_730_1920","sh_occ1950_main_800_1920","sh_occ1950_main_900_1920")
p <- vector(mode = "list", length = length(x))
for (i in 1:length(x)) {
  p[[i]] <- ggplot(census_sample_new_work_x_new_sectors, aes_string(y="new_sec_all_1920", x= x[i])) +
            geom_point() + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) +
            labs(title="",x="Share of workers", y = "Share of New Sectors") + theme(axis.line=element_line(color="black"), legend.position = "top") + theme_tufte() 
}
ggarrange(p[[1]],p[[2]],p[[3]],p[[4]],labels=c("Professional, Technical","Farmers","Managers, Officials and Proprietors","Clerical and Kindred"),font.label = list(size = 10),
          ncol = 2, nrow =2)
ggsave(here(paste0("output/Graphs/metarea_1940/corr_sh_occ1950_main_x_sh_new_sectors_1.jpeg")),plot=last_plot())
ggarrange(p[[5]],p[[6]],p[[7]],p[[8]],labels=c("Sales workers","Craftsmen","Operatives","Service Workers (private household)"),font.label = list(size = 10), ncol = 2, nrow =2)
#ggsave(here(paste0("output/Graphs/metarea_1940/corr_sh_occ1950_main_x_sh_new_sectors_2.jpeg")),plot=last_plot())
ggarrange(p[[9]],p[[10]],p[[11]],labels=c("Service Workers (not household)","Farm laborers","Laborers"),font.label = list(size = 10),
          ncol = 2, nrow =2)
#ggsave(here(paste0("output/Graphs/metarea_1940/corr_sh_occ1950_main_x_sh_new_sectors_3.jpeg")),plot=last_plot())

rm(p, mp)
```


### 3.5. Some correlation graphs leaving out workers in New Sectors

#### countynhg_1910
```{r}
# Creating the info 
## Calling the regional level information
census_sample_new_work_x_new_sectors <- read_fst(here(paste0("output/Rdata/census_sample_1920_agg_countynhg_1910.fst")),as.data.table=TRUE)
census_sample_new_work_x_new_sectors <- census_sample_new_work_x_new_sectors[,grep("^countynhg_1910|^sh_red|^sh_base|^sh_occ1950_main|^sh_new_sector|^sh_ind1950|perwt",names(census_sample_new_work_x_new_sectors),value=TRUE),with=FALSE]

col <- names(census_sample_new_work_x_new_sectors[,!c("countynhg_1910")])
setnames(census_sample_new_work_x_new_sectors,col,paste0(col,"_1920"))

temp <- read_fst(here(paste0("output/Rdata/census_sample_1930_agg_countynhg_1910.fst")),as.data.table=TRUE)
temp <- temp[, grep("^countynhg_1910|^sh_red|^sh_base|^sh_occ1950_main|^sh_new_sector|^sh_ind1950|^perwt",names(temp),value=TRUE),with=FALSE]
col <- names(temp[,!c("countynhg_1910")])
setnames(temp,col,paste0(col,"_1930"))
census_sample_new_work_x_new_sectors <- merge(census_sample_new_work_x_new_sectors,temp,by="countynhg_1910",all=FALSE)
rm(temp)

census_sample_new_work_x_new_sectors <- census_sample_new_work_x_new_sectors[,`:=`(new_sec_all_1920=sh_new_sector_ind1950_376_1920+sh_new_sector_ind1950_377_1920+sh_new_sector_ind1950_606_1920+sh_new_sector_ind1950_668_1920+sh_new_sector_ind1950_816_1920,new_sec_all_1930=sh_new_sector_ind1950_376_1930+sh_new_sector_ind1950_377_1930+sh_new_sector_ind1950_606_1930+sh_new_sector_ind1950_668_1930+sh_new_sector_ind1950_816_1930+sh_new_sector_ind1950_856_1930)][,`:=`(new_sec_main_1920=sh_new_sector_ind1950_376_1920+sh_new_sector_ind1950_377_1920,new_sec_main_1930=sh_new_sector_ind1950_376_1930+sh_new_sector_ind1950_377_1930+sh_new_sector_ind1950_856_1930)][,`:=`(new_sec_serv_1920=sh_new_sector_ind1950_606_1920+sh_new_sector_ind1950_668_1920+sh_new_sector_ind1950_816_1920,new_sec_serv_1930=sh_new_sector_ind1950_606_1930+sh_new_sector_ind1950_668_1930+sh_new_sector_ind1950_816_1930)]

# Crating rank variables
setorder(census_sample_new_work_x_new_sectors,-new_sec_all_1920)
census_sample_new_work_x_new_sectors[,rank_new_sec_1920:=1:.N]
setorder(census_sample_new_work_x_new_sectors,-new_sec_all_1930)
census_sample_new_work_x_new_sectors[,rank_new_sec_1930:=1:.N]

## Calling the aggregate data to constructs information without workers in new sectors
temp <- read_fst(here(paste0("output/Rdata/census_sample_1930_individual_data.fst")),as.data.table=TRUE)[occ1950_main!=979 & ind1950_main!=0 & !(ind1950 %in% c(376,377,466,556,606,667,668,816,856)),c("countynhg_1910","perwt_ID","ind1950","ind1950_main","occ1950_main","sh_new_method1","sh_base_tit")]

### Aggregating by countynhg_1910 keeping info on share of new work
temp <- temp[,lapply(.SD, weighted.mean,w=perwt_ID),by="countynhg_1910",.SDcols=c("sh_new_method1","sh_base_tit")] 
setnames(temp,c("sh_new_method1","sh_base_tit"),c("sh_new_method1_1930_no_new_sec","sh_base_tit_no_new_sec"))

### Combining with census_sample_new_work_x_new_sectors
census_sample_new_work_x_new_sectors <- merge(census_sample_new_work_x_new_sectors,temp,by="countynhg_1910",all=FALSE)
rm(temp)

# Correlations
## New Work, New Sectors
p <- vector(mode = "list")
p[[1]] <- 
  ggplot(census_sample_new_work_x_new_sectors[perwt_1930>=10000], aes(x=new_sec_all_1920)) +
  geom_point(aes(y=sh_new_method1_1930, colour="All Sec"), size=0.1) + geom_point(aes(y=sh_new_method1_1930_no_new_sec, colour="No New Sec"), size=0.1 ) +
  stat_smooth(aes(y=sh_new_method1_1930, colour="All Sec"), method="lm", se=TRUE) +  stat_smooth(aes(y=sh_new_method1_1930_no_new_sec, colour="No New Sec"), method="lm", se=TRUE) +
  geom_rangeframe()  +  
  labs(title="",x="Share of New Sector", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))


### Excluding counties with the highest share of new sectors
for (i in c(3,5,10,20,50,100,200)) {
      if (i==3) {j <- 2}
      p[[j]] <- ggplot(census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=i], aes(x=new_sec_all_1920)) +
                  geom_point(aes(y=sh_new_method1_1930, colour="All Sec"), size=0.1) + geom_point(aes(y=sh_new_method1_1930_no_new_sec, colour="No New Sec"), size=0.1 ) +
                  stat_smooth(aes(y=sh_new_method1_1930, colour="All Sec"), method="lm", se=TRUE) +  stat_smooth(aes(y=sh_new_method1_1930_no_new_sec, colour="No New Sec"), method="lm", se=TRUE) +
                  geom_rangeframe()  +  
                  labs(title="",x="Share of New Sector", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))
      j <- j+1
}
ggarrange(p[[1]],p[[2]],p[[3]],p[[4]],
          labels = c("All Regions", "Excl. 2 Reg.", "Excl. 4 Reg.", "Excl. 9 Reg."),
          ncol = 2, nrow = 2,common.legend = TRUE)
ggsave(here(paste0("output/Graphs/countynhg_1910/corr_sh_new_sectors_1930_x_sh_new_method1_1920_no_new_sec_1.jpeg")),plot=last_plot())
ggarrange(p[[5]],p[[6]],p[[7]],p[[8]],
          labels = c("Excl. 19 Reg", "Excl. 49 Reg.","Excl. 99 Reg", "Excl. 199 Reg."),
          ncol = 2, nrow = 2)
ggsave(here(paste0("output/Graphs/countynhg_1910/corr_sh_new_sectors_1930_x_sh_new_method1_1920_no_new_sec_2.jpeg")),plot=last_plot())
rm(p)

### Graph excluding regions in the Same plot
p <- vector(mode = "list")
p[[1]] <- ggplot() +
  geom_point(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000],aes(x=new_sec_all_1920,y=sh_new_method1_1930), size=0.2) +
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000],aes(x=new_sec_all_1920,y=sh_new_method1_1930, colour="All"), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=3],aes(x=new_sec_all_1920,y=sh_new_method1_1930, colour="Excl. 3 Reg."), method="lm", se=TRUE) +  
                  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000& rank_new_sec_1920>=5],aes(x=new_sec_all_1920,y=sh_new_method1_1930, colour="Excl. 5 Reg."), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=10],aes(x=new_sec_all_1920,y=sh_new_method1_1930, colour="Excl. 9 Reg."), method="lm", se=TRUE) +  
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=20],aes(x=new_sec_all_1920,y=sh_new_method1_1930, colour="Excl. 19 Reg."), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=50],aes(x=new_sec_all_1920,y=sh_new_method1_1930, colour="Excl. 49 Reg."), method="lm", se=TRUE) +
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=100],aes(x=new_sec_all_1920,y=sh_new_method1_1930, colour="Excl. 99 Reg."), method="lm", se=TRUE) +
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=200],aes(x=new_sec_all_1920,y=sh_new_method1_1930, colour="Excl. 199 Reg."), method="lm", se=TRUE) +
  geom_rangeframe()  +  
  ylim(min(census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_new_method1_1930,census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_new_method1_1930_no_new_sec), max(census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_new_method1_1930,census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_new_method1_1930_no_new_sec)) +
  labs(title="",x="Share of New Sector", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

p[[2]] <- ggplot() +
  geom_point(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000],aes(x=new_sec_all_1920,y=sh_new_method1_1930_no_new_sec), size=0.2) +
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000],aes(x=new_sec_all_1920,y=sh_new_method1_1930_no_new_sec, colour="All"), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=3],aes(x=new_sec_all_1920,y=sh_new_method1_1930_no_new_sec, colour="Excl. 3 Reg."), method="lm", se=TRUE) +  
                  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000& rank_new_sec_1920>=5],aes(x=new_sec_all_1920,y=sh_new_method1_1930_no_new_sec, colour="Excl. 5 Reg."), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=10],aes(x=new_sec_all_1920,y=sh_new_method1_1930_no_new_sec, colour="Excl. 9 Reg."), method="lm", se=TRUE) +  
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=20],aes(x=new_sec_all_1920,y=sh_new_method1_1930_no_new_sec, colour="Excl. 19 Reg."), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=50],aes(x=new_sec_all_1920,y=sh_new_method1_1930_no_new_sec, colour="Excl. 49 Reg."), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=100],aes(x=new_sec_all_1920,y=sh_new_method1_1930_no_new_sec, colour="Excl. 99 Reg."), method="lm", se=TRUE) +
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=200],aes(x=new_sec_all_1920,y=sh_new_method1_1930_no_new_sec, colour="Excl. 199 Reg."), method="lm", se=TRUE) + 
  geom_rangeframe()  +  
  ylim(min(census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_new_method1_1930,census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_new_method1_1930_no_new_sec), max(census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_new_method1_1930,census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_new_method1_1930_no_new_sec)) +
  labs(title="",x="Share of New Sector", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggarrange(p[[1]],p[[2]],
          labels = c("All Sectors","No New Sectors"),
          ncol = 2, nrow = 1,common.legend = TRUE)
ggsave(here(paste0("output/Graphs/countynhg_1910/corr_sh_new_sectors_1930_x_sh_new_method1_1920_different_reg_secs.jpeg")),plot=last_plot())



# Correlations
## New Work, New Sectors
p <- vector(mode = "list")
p[[1]] <- 
  ggplot(census_sample_new_work_x_new_sectors[perwt_1930>=10000], aes(x=new_sec_all_1920)) +
  geom_point(aes(y=sh_new_method1_1930, colour="All Sec"), size=0.1) + geom_point(aes(y=sh_new_method1_1930_no_new_sec, colour="No New Sec"), size=0.1 ) +
  stat_smooth(aes(y=sh_new_method1_1930, colour="All Sec"), method="lm", se=TRUE) +  stat_smooth(aes(y=sh_new_method1_1930_no_new_sec, colour="No New Sec"), method="lm", se=TRUE) +
  geom_rangeframe()  +  
  labs(title="",x="Share of New Sector", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))


### Excluding counties with the highest share of new sectors
for (i in c(3,5,10,20,50,100,200)) {
      if (i==3) {j <- 2}
      p[[j]] <- ggplot(census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=i], aes(x=new_sec_all_1920)) +
                  geom_point(aes(y=sh_new_method1_1930, colour="All Sec"), size=0.1) + geom_point(aes(y=sh_new_method1_1930_no_new_sec, colour="No New Sec"), size=0.1 ) +
                  stat_smooth(aes(y=sh_new_method1_1930, colour="All Sec"), method="lm", se=TRUE) +  stat_smooth(aes(y=sh_new_method1_1930_no_new_sec, colour="No New Sec"), method="lm", se=TRUE) +
                  geom_rangeframe()  +  
                  labs(title="",x="Share of New Sector", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))
      j <- j+1
}

ggarrange(p[[1]],p[[3]],p[[7]],p[[8]],
          labels = c("All Regions", "Excl. 4 Reg.", "Excl. 49 Reg.", "Excl. 99 Reg."),
          ncol = 2, nrow = 2,common.legend = TRUE)
ggsave(here(paste0("output/Graphs/countynhg_1910/corr_sh_new_sectors_1930_x_sh_new_method1_1920_no_new_sec_FOR_PRESENTATION_DELEEEETE.jpeg")),plot=last_plot())
rm(p)


# DELETE LATER - FOR PRESENTATION
### Graph excluding regions in the Same plot
p <- vector(mode = "list")
p[[1]] <- ggplot() +
  geom_point(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000],aes(x=new_sec_all_1920,y=sh_new_method1_1930), size=0.2) +
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000],aes(x=new_sec_all_1920,y=sh_new_method1_1930, colour="All"), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000& rank_new_sec_1920>=5],aes(x=new_sec_all_1920,y=sh_new_method1_1930, colour="Excl. 4 Reg."), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000& rank_new_sec_1920>=19],aes(x=new_sec_all_1920,y=sh_new_method1_1930, colour="Excl. 19 Reg."), method="lm", se=TRUE) +
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=50],aes(x=new_sec_all_1920,y=sh_new_method1_1930, colour="Excl. 49 Reg."), method="lm", se=TRUE) +
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=100],aes(x=new_sec_all_1920,y=sh_new_method1_1930, colour="Excl. 99 Reg."), method="lm", se=TRUE) +
  geom_rangeframe()  +  
  ylim(min(census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_new_method1_1930,census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_new_method1_1930_no_new_sec), max(census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_new_method1_1930,census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_new_method1_1930_no_new_sec)) +
  labs(title="",x="Share of New Sector", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

p[[2]] <- ggplot() +
  geom_point(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000],aes(x=new_sec_all_1920,y=sh_new_method1_1930_no_new_sec), size=0.2) +
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000],aes(x=new_sec_all_1920,y=sh_new_method1_1930_no_new_sec, colour="All"), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000& rank_new_sec_1920>=5],aes(x=new_sec_all_1920,y=sh_new_method1_1930_no_new_sec, colour="Excl. 4 Reg."), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000& rank_new_sec_1920>=20],aes(x=new_sec_all_1920,y=sh_new_method1_1930_no_new_sec, colour="Excl. 19 Reg."), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=50],aes(x=new_sec_all_1920,y=sh_new_method1_1930_no_new_sec, colour="Excl. 49 Reg."), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=100],aes(x=new_sec_all_1920,y=sh_new_method1_1930_no_new_sec, colour="Excl. 99 Reg."), method="lm", se=TRUE) +
  geom_rangeframe()  +  
  ylim(min(census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_new_method1_1930,census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_new_method1_1930_no_new_sec), max(census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_new_method1_1930,census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_new_method1_1930_no_new_sec)) +
  labs(title="",x="Share of New Sector", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggarrange(p[[1]],p[[2]],
          labels = c("All Sectors","No New Sectors"),
          ncol = 2, nrow = 1,common.legend = TRUE)
ggsave(here(paste0("output/Graphs/countynhg_1910/corr_sh_new_sectors_1930_x_sh_new_method1_1920_different_reg_secs_FOR_PRESENTATION.jpeg")),plot=last_plot())



rm(p)
```

#### metarea_1940
```{r}
# Creating the info 
## Calling the regional level information
census_sample_new_work_x_new_sectors <- read_fst(here(paste0("output/Rdata/census_sample_1920_agg_metarea_1940.fst")),as.data.table=TRUE)
census_sample_new_work_x_new_sectors <- census_sample_new_work_x_new_sectors[,grep("^metarea_1940|^sh_red|^sh_base|^sh_occ1950_main|^sh_new_sector|^sh_ind1950|perwt",names(census_sample_new_work_x_new_sectors),value=TRUE),with=FALSE]

col <- names(census_sample_new_work_x_new_sectors[,!c("metarea_1940")])
setnames(census_sample_new_work_x_new_sectors,col,paste0(col,"_1920"))

temp <- read_fst(here(paste0("output/Rdata/census_sample_1930_agg_metarea_1940.fst")),as.data.table=TRUE)
temp <- temp[, grep("^metarea_1940|^sh_red|^sh_base|^sh_occ1950_main|^sh_new_sector|^sh_ind1950|^perwt",names(temp),value=TRUE),with=FALSE]
col <- names(temp[,!c("metarea_1940")])
setnames(temp,col,paste0(col,"_1930"))
census_sample_new_work_x_new_sectors <- merge(census_sample_new_work_x_new_sectors,temp,by="metarea_1940",all=FALSE)
rm(temp)

census_sample_new_work_x_new_sectors <- census_sample_new_work_x_new_sectors[,`:=`(new_sec_all_1920=sh_new_sector_ind1950_376_1920+sh_new_sector_ind1950_377_1920+sh_new_sector_ind1950_606_1920+sh_new_sector_ind1950_668_1920+sh_new_sector_ind1950_816_1920,new_sec_all_1930=sh_new_sector_ind1950_376_1930+sh_new_sector_ind1950_377_1930+sh_new_sector_ind1950_606_1930+sh_new_sector_ind1950_668_1930+sh_new_sector_ind1950_816_1930+sh_new_sector_ind1950_856_1930)][,`:=`(new_sec_main_1920=sh_new_sector_ind1950_376_1920+sh_new_sector_ind1950_377_1920,new_sec_main_1930=sh_new_sector_ind1950_376_1930+sh_new_sector_ind1950_377_1930+sh_new_sector_ind1950_856_1930)][,`:=`(new_sec_serv_1920=sh_new_sector_ind1950_606_1920+sh_new_sector_ind1950_668_1920+sh_new_sector_ind1950_816_1920,new_sec_serv_1930=sh_new_sector_ind1950_606_1930+sh_new_sector_ind1950_668_1930+sh_new_sector_ind1950_816_1930)]

# Crating rank variables
setorder(census_sample_new_work_x_new_sectors,-new_sec_all_1920)
census_sample_new_work_x_new_sectors[,rank_new_sec_1920:=1:.N]
setorder(census_sample_new_work_x_new_sectors,-new_sec_all_1930)
census_sample_new_work_x_new_sectors[,rank_new_sec_1930:=1:.N]

## Calling the aggregate data to constructs information without workers in new sectors
temp <- read_fst(here(paste0("output/Rdata/census_sample_1930_individual_data.fst")),as.data.table=TRUE)[occ1950_main!=979 & ind1950_main!=0 & !(ind1950 %in% c(376,377,466,556,606,667,668,816,856)),c("metarea_1940","perwt_ID","ind1950","ind1950_main","occ1950_main","sh_new_method1","sh_base_tit")]

### Aggregating by metarea_1940 keeping info on share of new work
temp <- temp[,lapply(.SD, weighted.mean,w=perwt_ID),by="metarea_1940",.SDcols=c("sh_new_method1","sh_base_tit")] 
setnames(temp,c("sh_new_method1","sh_base_tit"),c("sh_new_method1_1930_no_new_sec","sh_base_tit_no_new_sec"))

### Combining with census_sample_new_work_x_new_sectors
census_sample_new_work_x_new_sectors <- merge(census_sample_new_work_x_new_sectors,temp,by="metarea_1940",all=FALSE)
rm(temp)

# Correlations
## New Work, New Sectors
p <- vector(mode = "list")
p[[1]] <- 
  ggplot(census_sample_new_work_x_new_sectors[perwt_1930>=10000], aes(x=new_sec_all_1920)) +
  geom_point(aes(y=sh_new_method1_1930, colour="All Sec"), size=0.3) + geom_point(aes(y=sh_new_method1_1930_no_new_sec, colour="No New Sec"), size=0.3 ) +
  stat_smooth(aes(y=sh_new_method1_1930, colour="All Sec"), method="lm", se=TRUE) +  stat_smooth(aes(y=sh_new_method1_1930_no_new_sec, colour="No New Sec"), method="lm", se=TRUE) +
  geom_rangeframe()  +  
  labs(title="",x="Share of New Sector", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))


### Excluding counties with the highest share of new sectors
for (i in c(3,5,10,15,20,30,50)) {
      if (i==3) {j <- 2}
      p[[j]] <- ggplot(census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1930>=i], aes(x=new_sec_all_1920)) +
                  geom_point(aes(y=sh_new_method1_1930, colour="All Sec"), size=0.3) + geom_point(aes(y=sh_new_method1_1930_no_new_sec, colour="No New Sec"), size=0.3 ) +
                  stat_smooth(aes(y=sh_new_method1_1930, colour="All Sec"), method="lm", se=TRUE) +  stat_smooth(aes(y=sh_new_method1_1930_no_new_sec, colour="No New Sec"), method="lm", se=TRUE) +
                  geom_rangeframe()  +  
                  labs(title="",x="Share of New Sector", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))
      j <- j+1
}
ggarrange(p[[1]],p[[2]],p[[3]],p[[4]],
          labels = c("All Regions", "Excl. 2 Reg.", "Excl. 4 Reg.", "Excl. 9 Reg."),
          ncol = 2, nrow = 2,common.legend = TRUE)
ggsave(here(paste0("output/Graphs/metarea_1940/corr_sh_new_sectors_1930_x_sh_new_method1_1920_no_new_sec_1.jpeg")),plot=last_plot())
ggarrange(p[[5]],p[[6]],p[[7]],p[[8]],
          labels = c("Excl. 15 Reg", "Excl. 19 Reg.","Excl. 29 Reg", "Excl. 49 Reg."),
          ncol = 2, nrow = 2)
ggsave(here(paste0("output/Graphs/metarea_1940/corr_sh_new_sectors_1930_x_sh_new_method1_1920_no_new_sec_2.jpeg")),plot=last_plot())

rm(p,i,j)

### Graph excluding regions in the Same plot
p <- vector(mode = "list")
p[[1]] <- ggplot() +
  geom_point(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000],aes(x=new_sec_all_1920,y=sh_new_method1_1930), size=0.5) +
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000],aes(x=new_sec_all_1920,y=sh_new_method1_1930, colour="All"), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=3],aes(x=new_sec_all_1920,y=sh_new_method1_1930, colour="Excl. 3 Reg."), method="lm", se=TRUE) +  
                  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000& rank_new_sec_1920>=5],aes(x=new_sec_all_1920,y=sh_new_method1_1930, colour="Excl. 5 Reg."), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=10],aes(x=new_sec_all_1920,y=sh_new_method1_1930, colour="Excl. 9 Reg."), method="lm", se=TRUE) +  
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=15],aes(x=new_sec_all_1920,y=sh_new_method1_1930, colour="Excl. 14 Reg."), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=20],aes(x=new_sec_all_1920,y=sh_new_method1_1930, colour="Excl. 19 Reg."), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=30],aes(x=new_sec_all_1920,y=sh_new_method1_1930, colour="Excl. 29 Reg."), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=50],aes(x=new_sec_all_1920,y=sh_new_method1_1930, colour="Excl. 49 Reg."), method="lm", se=TRUE) + 
  geom_rangeframe()  +  
  ylim(min(census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_new_method1_1930,census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_new_method1_1930_no_new_sec), max(census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_new_method1_1930,census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_new_method1_1930_no_new_sec)) +
  labs(title="",x="Share of New Sector", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

p[[2]] <- ggplot() +
  geom_point(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000],aes(x=new_sec_all_1920,y=sh_new_method1_1930_no_new_sec), size=0.5) +
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000],aes(x=new_sec_all_1920,y=sh_new_method1_1930_no_new_sec, colour="All"), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=3],aes(x=new_sec_all_1920,y=sh_new_method1_1930_no_new_sec, colour="Excl. 3 Reg."), method="lm", se=TRUE) +  
                  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000& rank_new_sec_1920>=5],aes(x=new_sec_all_1920,y=sh_new_method1_1930_no_new_sec, colour="Excl. 5 Reg."), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=10],aes(x=new_sec_all_1920,y=sh_new_method1_1930_no_new_sec, colour="Excl. 9 Reg."), method="lm", se=TRUE) +  
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=15],aes(x=new_sec_all_1920,y=sh_new_method1_1930_no_new_sec, colour="Excl. 14 Reg."), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=20],aes(x=new_sec_all_1920,y=sh_new_method1_1930_no_new_sec, colour="Excl. 19 Reg."), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=30],aes(x=new_sec_all_1920,y=sh_new_method1_1930_no_new_sec, colour="Excl. 29 Reg."), method="lm", se=TRUE) + 
  stat_smooth(data=census_sample_new_work_x_new_sectors[perwt_1930>=10000 & rank_new_sec_1920>=50],aes(x=new_sec_all_1920,y=sh_new_method1_1930_no_new_sec, colour="Excl. 49 Reg."), method="lm", se=TRUE) + 
  geom_rangeframe()  +  
  ylim(min(census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_new_method1_1930,census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_new_method1_1930_no_new_sec), max(census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_new_method1_1930,census_sample_new_work_x_new_sectors[perwt_1930>=10000]$sh_new_method1_1930_no_new_sec)) +
  labs(title="",x="Share of New Sector", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))

ggarrange(p[[1]],p[[2]],
          labels = c("All Sectors","No New Sectors"),
          ncol = 2, nrow = 1,common.legend = TRUE)
ggsave(here(paste0("output/Graphs/metarea_1940/corr_sh_new_sectors_1930_x_sh_new_method1_1920_different_reg_secs.jpeg")),plot=last_plot())

rm(p)

```

### 3.6. Looking at most important occind by sector, paying particular attention to the occupations with the highest shares of new work

#### 3.6.1. Constructing main databse
```{r}
rm(list=setdiff(ls(all.names = TRUE), "f_load_pk"))
f_load_pk()

# Calling the data
census_sample_1930_individual_data <-read_fst(here(paste0("output/Rdata/census_sample_1930_individual_data.fst")),as.data.table=TRUE)[occ1950_main!=979 & ind1950_main!=0,c("perwt_ID","ind1950","ind1950_main","occind","occ1950","occ1950_main","sh_base_tit","sh_new_method1")]

# Combining New Sectors


# Aggregating
census_sample_1930_individual_data <- census_sample_1930_individual_data[,perwt_occind_x_ind1950:=sum(perwt_ID),by=c("occind","ind1950")][,perwt_occ1950_x_ind1950:=sum(perwt_ID),by=c("occ1950","perwt_ID")][,perwt_occind:=sum(perwt_ID),by=c("occind")][,perwt_occ1950:=sum(perwt_ID),by=c("occind")][,perwt_ind1950:=sum(perwt_ID),by=c("ind1950")]
census_sample_1930_individual_data[,sh_new_method1_x_occ1950:=lapply(.SD,weighted.mean,w=perwt_ID),by=c("occ1950"),.SDcols=c("sh_new_method1")][,sh_new_method1_x_ind1950:=lapply(.SD,weighted.mean,w=perwt_ID),by=c("ind1950"),.SDcols=c("sh_new_method1")]

census_sample_1930_individual_data <- census_sample_1930_individual_data[,.SD[1],by=c("occind","occ1950","ind1950"),,.SDcols=c("perwt_occind_x_ind1950","perwt_occ1950_x_ind1950","perwt_occind","perwt_occ1950","perwt_ind1950","sh_new_method1","sh_new_method1_x_occ1950","sh_new_method1_x_ind1950")]
```

#### 3.6.2. Analyzing the data
##### 3.6.2.1. occind
```{r}
# Selecting the set of interest
census_sample_1930_occind_x_ind1950 <- census_sample_1930_individual_data[,.SD[1],by=c("occind","ind1950"),.SDcols=c("perwt_ind1950","perwt_occind","perwt_occind_x_ind1950","sh_new_method1","sh_new_method1_x_ind1950")]

# Creating shares
setorder(census_sample_1930_occind_x_ind1950,ind1950,-sh_new_method1)
census_sample_1930_occind_x_ind1950[,sh_occind_in_ind1950:=perwt_occind_x_ind1950/perwt_ind1950][,w_x_sh_new:=sh_occind_in_ind1950*sh_new_method1][,cumsum_sh_occind_in_ind1950:=cumsum(sh_occind_in_ind1950),by=c("ind1950")]

# Creating vector with the number of all the ind1950
ind_1950 <- unique(census_sample_1930_occind_x_ind1950$ind1950)

# Reorganizing data
census_sample_1930_occind_x_ind1950 <- data.table::dcast(census_sample_1930_occind_x_ind1950, occind + sh_new_method1 + perwt_occind  ~ ind1950, value.var = c("sh_occind_in_ind1950","cumsum_sh_occind_in_ind1950","w_x_sh_new") )

# Convert all cells with NA values to 0
census_sample_1930_occind_x_ind1950 <- census_sample_1930_occind_x_ind1950[,lapply(.SD,function(x) {x[is.na(x)] <- 0; x}),.SDcols=names(census_sample_1930_occind_x_ind1950)]

# Merging with occind name
## Import names
occ1930.codes <- as.data.table( read_excel(here(paste0("input/1930 - Cleaned.xlsx")), sheet = "1930 main groups",guess_max=10000) )[,c("occind","occ","occind1930_name")]

## Merge
census_sample_1930_occind_x_ind1950 <- merge(census_sample_1930_occind_x_ind1950,occ1930.codes,by=c("occind"),all.x=TRUE,all.y=FALSE)

# Reorganize information
organize <- c("occind","occ","occind1930_name","sh_new_method1")
for (i in c(c(376,377,606,668,816,856),ind_1950[!ind_1950 %in% c(376,377,606,668,816,856)])) {
  organize <- c(organize,
                grep(paste0(i,"$"),names(census_sample_1930_occind_x_ind1950),value=TRUE))
}
setcolorder(census_sample_1930_occind_x_ind1950, organize) 

# Export information
write.xlsx(census_sample_1930_occind_x_ind1950,here(paste0("output/Tables/census_sample_1930_occind_x_ind1950.xlsx")),row.names = FALSE)

```









#### FOR PRESENTATION
```{r}
temp_a <- read_fst(here(paste0("output/Rdata/census_sample_1930_agg_metarea_1940.fst")),as.data.table=TRUE)
length((unique(temp_a$metarea_1940)))
temp_a <- temp_a[metarea_1940<1000]
length((unique(temp_a$metarea_1940)))
temp_a <- temp_a[perwt>=10000]
length((unique(temp_a$metarea_1940)))


temp_a <- read_fst(here(paste0("output/Rdata/census_sample_1930_agg_countynhg_1910.fst")),as.data.table=TRUE)
length((unique(temp_a$countynhg_1910)))
temp_a <- temp_a[perwt>=10000]
length((unique(temp_a$countynhg_1910)))

```

# Part 6. Regressions working directly with the regional level variables

## 0. Functions used in this section
### 0.1. Functions related to regressions
#### Function to export results
```{r}
f_reg_results <- function(Regresults,arg_round=4) {
  # NOTES:
  # Regresults: data.table with 5 columns. (1) Name of variables, (2) Regression coefficient, (3) Standard value, (4) T-Value, (5) P_value
  # Arg_round: number of significance digits. 4 bu default
  
  #sig_10 <- qt(p=.1/2,df=arg_df,lower.tail=FALSE)
  #sig_5  <- qt(p=.05/2,df=arg_df,lower.tail=FALSE)
  #sig_1  <- qt(p=.01/2,df=arg_df,lower.tail=FALSE)
  X <- copy(Regresults)
  setnames(X,c(2,3,4,5),c("coef","std","t_value","p_value"))
  X[,coef_star:=ifelse(p_value>0.1,format(round(coef,arg_round),nsmall=2),ifelse(p_value>0.05,paste0(format(round(coef,arg_round),nsmall=2),"*"),ifelse(p_value>0.01,paste0(format(round(coef,arg_round),nsmall=2),"**"),paste0(format(round(coef,arg_round),nsmall=2),"***"))))]
  #coef.J[,coef_star:=ifelse(x==1,paste0(format(round(coef,arg_round),nsmall=2),"***"),ifelse(x==5,paste0(format(round(coef,arg_round),nsmall=2),"**"),ifelse(x==10,paste0(format(round(coef,arg_round),nsmall=2),"*"),format(round(coef,arg_round),nsmall=2))))]
  X[,std_par:=paste0("(",format(round(std,arg_round),nsmall=2),")")]
  return(X)
}
```

#### Function to perform a set of regressions
This function works with methods lm and lm_robust
TO-DO
- Allow the possibility of not specifying weights
- For lm_robust need to specify the possibility of not using clusters
```{r}
f_regressions <- function(arg_formula,arg_data,arg_weights,method,arg_clusters,to_iter = 1000, by_iter = 10) {
  # Arguments:
  #           - arg_formula: list with the set of regressions formulas
  #           - arg_data: dataset with the variables in arg_formula
  #           - arg_weights: variable contianing the weights used in the regression
  #           - method: either "lm" or "lm_robust"
  #           - arg_clusters: Variable used to cluster standard errors
  #           - iter_vec: vector containing the numbers of the iteration that you want to be displayed
  
  # Note1: There is a conflict if arg_formula is not a list. E.g. if you create a list (LS) but in arg_formula you introduce LS[[i]], the function will try to subset it and that will give an error. If that is the case introduce it as a list, e.g. list(LS[[i]])
  
  # Note2: Instead of copying arg_data I decided to change the names back to their original names at the end of the function.
  iter_vec <- seq(from =0, to = to_iter, by = by_iter)
  i <- 1
  ## IF argument ARG_WEIGHTS is specified
  if (!missing(arg_weights)) {
    setnames(arg_data,c(deparse(substitute(arg_weights))),c("arg_w"))
    if (i %in% iter_vec) {
      tic(paste0("Iteration ",i," to ",min(i+by_iter-1,length(arg_formula))))
      i0 <- i + by_iter -1
    }
    if (method=="lm") {
      A <- summary(lm(arg_formula[[1]],data=arg_data,weights=arg_w,model=FALSE))
      other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(length(A$residuals),format(round(A$adj.r.squared,4),nsmall=2)),unname(A$fstatistic)))
    } else if (method=="lm_robust") {
      setnames(arg_data,c(deparse(substitute(arg_clusters))),c("arg_cl"))
      A <- summary(lm_robust(arg_formula[[1]],weights=arg_w,clusters=arg_cl,se_type='stata',data=arg_data))
      other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(A$nobs,format(round(A$adj.r.squared,4),nsmall=2)),unname(A$fstatistic)))
    }
    coef <- f_reg_results( data.table(A$coefficients[,1:4],keep.rownames=TRUE), arg_round=4 )
    coef <- melt(coef,id.vars = c("rn"), measure.vars = c("coef","std","t_value","p_value","coef_star","std_par"),value.name=c(paste0("model_",1)))
    coef <- rbind(coef,other)
    if (i == i0) toc()
    rm(A,other)
    
    if (length(arg_formula)>1) {
      for (i in 2:length(arg_formula)) {
        if (i %in% iter_vec) {
          tic(paste0("Iteration ",i," to ",min(i+by_iter-1,length(arg_formula))))
          i0 <- i+by_iter -1
        }
        if (method=="lm") {
          A <- summary(lm(arg_formula[[i]],data=arg_data,weights=arg_w,model=FALSE))
          other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(length(A$residuals),format(round(A$adj.r.squared,4),nsmall=2)),unname(A$fstatistic)))
          setnames(other,c(3),c(paste0("model_",i)))
        } else if (method=="lm_robust") {
          A <- summary(lm_robust(arg_formula[[i]],weights=arg_w,clusters=arg_cl,se_type='stata',data=arg_data))
          other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(A$nobs,format(round(A$adj.r.squared,4),nsmall=2)),unname(A$fstatistic)))
          setnames(other,c(3),c(paste0("model_",i)))
        }
        
        t <- f_reg_results( data.table(A$coefficients[,1:4],keep.rownames=TRUE), arg_round=4)
        t <- melt(t,id.vars = c("rn"), measure.vars = c("coef","std","t_value","p_value","coef_star","std_par"),value.name=c(paste0("model_",i)))
        t <- rbind(t,other)
        coef <- merge(coef,t,by=c("rn","variable"),all=TRUE)
        rm(A,other,t)
        if (i0==i) toc()
      }
    
    }
    
    
  ## NOOO argument ARG_WEIGHTS 
  } else {
    if (i %in% iter_vec) {
      tic(paste0("Iteration ",i," to ",min(i+by_iter-1,length(arg_formula))))
      i0 <- i + by_iter -1
    }
    if (method=="lm") {
      A <- summary(lm(arg_formula[[1]],data=arg_data,model=FALSE))
      other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(length(A$residuals),format(round(A$adj.r.squared,4),nsmall=2)),unname(A$fstatistic)))
    } else if (method=="lm_robust") {
      setnames(arg_data,c(deparse(substitute(arg_clusters))),c("arg_cl"))
      A <- summary(lm_robust(arg_formula[[1]],clusters=arg_cl,se_type='stata',data=arg_data))
      other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(A$nobs,format(round(A$adj.r.squared,4),nsmall=2)),unname(A$fstatistic)))
    }
    coef <- f_reg_results( data.table(A$coefficients[,1:4],keep.rownames=TRUE), arg_round=4 )
    coef <- melt(coef,id.vars = c("rn"), measure.vars = c("coef","std","t_value","p_value","coef_star","std_par"),value.name=c(paste0("model_",1)))
    coef <- rbind(coef,other)
    if (i == i0) toc()
    rm(A,other)
    
    if (length(arg_formula)>1) {
      for (i in 2:length(arg_formula)) {
        if (i %in% iter_vec) {
          tic(paste0("Iteration ",i," to ",min(i+by_iter-1,length(arg_formula))))
          i0 <- i + by_iter -1
        }
        if (method=="lm") {
          A <- summary(lm(arg_formula[[i]],data=arg_data,model=FALSE))
          other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(length(A$residuals),format(round(A$adj.r.squared,4),nsmall=2)),unname(A$fstatistic)))
          setnames(other,c(3),c(paste0("model_",i)))
        } else if (method=="lm_robust") {
          A <- summary(lm_robust(arg_formula[[i]],clusters=arg_cl,se_type='stata',data=arg_data))
          other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(A$nobs,format(round(A$adj.r.squared,4),nsmall=2)),unname(A$fstatistic)))
          setnames(other,c(3),c(paste0("model_",i)))
        }
        
        t <- f_reg_results( data.table(A$coefficients[,1:4],keep.rownames=TRUE), arg_round=4)
        t <- melt(t,id.vars = c("rn"), measure.vars = c("coef","std","t_value","p_value","coef_star","std_par"),value.name=c(paste0("model_",i)))
        t <- rbind(t,other)
        coef <- merge(coef,t,by=c("rn","variable"),all=TRUE)
        rm(A,other,t)
        if (i == i0) toc()
      }
    
    }
    
    
  }
  
  coef <- as.data.table(coef)
  coef[,order:=ifelse(variable=="zother",1,0)]
  setorder(coef,order,rn)
  coef[,order:=NULL]
  
  if (!missing(arg_weights)) { setnames(arg_data, c("arg_w"), c(deparse(substitute(arg_weights))) )   }
  
  if (method=="lm_robust") {
    setnames(arg_data,c("arg_cl"),c(deparse(substitute(arg_clusters))))
  }
  if (i==length(arg_formula)) toc()
  return(coef)
}

```

#### Function to order (regressions)
Given a dataset (X) a variable in the data_set (order_var) and a vector of names of the variables, this function orders the dataset X according to the order provided in the vector Order
```{r}
f_order_reg <- function(X,Order,order_var) {
  Y <- copy(X)[,vec_order:=Inf]
  setnames(Y,c(deparse(substitute(order_var))),c("arg_order_var"))
  for (i in 1:length(Order)) {
    Y <- Y[arg_order_var %in% Order[[i]],vec_order:=i]
  }
  Y <- Y[order(vec_order,arg_order_var)][,vec_order:=NULL]
  setnames(Y,c("arg_order_var"),c(deparse(substitute(order_var))))
  return (Y)
}
```


## 0.2. Functions to export tables to Excel
```{r}
wrapper_Excel <- function(list_table,list_name,output) {
  t <- createWorkbook()
  for (i in 1:length(list_table)) {
    addWorksheet(t, list_name[[i]])
    writeData(t, list_name[[i]],list_table[[i]])
  }
  saveWorkbook(t, output,overwrite=TRUE)
}
```


## 1. Regressions at the countynhg_1910 level
### 1.1. Construct regional level database
```{r}
# 1930
census_sample_1930_countynhg_1910 <-read_fst(here(paste0("output/Rdata/census_sample_1930_agg_countynhg_1910.fst")),as.data.table=TRUE)
census_sample_1930_countynhg_1910 <- census_sample_1930_countynhg_1910[,`:=`(sh_age_less16 = sh_age_main_0+sh_age_main_1,sh_age_16_49 = sh_age_main_2+sh_age_main_3+sh_age_main_4+sh_age_main_5,sh_age_more50 = sh_age_main_6+sh_age_main_7)][,`:=`(new_sec_all=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466 +sh_new_sector_ind1950_556+sh_new_sector_ind1950_606+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816 + sh_new_sector_ind1950_856,
                              new_sec_main=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466+ sh_new_sector_ind1950_856,
                              new_sec_serv=sh_new_sector_ind1950_556+sh_new_sector_ind1950_606+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816)]
cols <- grep("^(?!.*sh_new_sector)(?!.*sh_age_main)",names(census_sample_1930_countynhg_1910),value=TRUE,perl=TRUE)
census_sample_1930_countynhg_1910 <- census_sample_1930_countynhg_1910[,cols,with=FALSE]
cols <- names(census_sample_1930_countynhg_1910[,!c("countynhg_1910")])
setnames(census_sample_1930_countynhg_1910,cols,paste0(cols,"_1930"))

temp <- read_fst(here(paste0("output/Rdata/census_sample_1930_agg_countynhg_1910_no_new_sec_all.fst")),as.data.table=TRUE)
cols <- grep("^countynhg_1910|^sh_ind1950|^sh_occ|^sh_base|^sh_red|^sh_race|^sh_male|^sh_lit|^H|^perwt",names(temp),value=TRUE)
temp <- temp[,cols,with=FALSE]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_1930_no_new_sec_all"))

census_sample_1930_countynhg_1910 <- merge(census_sample_1930_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)

temp <- read_fst(here(paste0("output/Rdata/census_sample_1930_agg_countynhg_1910_no_new_sec_main.fst")),as.data.table=TRUE)
cols <- grep("^countynhg_1910|^sh_ind1950|^sh_occ|^sh_base|^sh_red|^sh_race|^sh_male|^sh_lit|^H|^perwt",names(temp),value=TRUE)
temp <- temp[,cols,with=FALSE]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_1930_no_new_sec_main"))

census_sample_1930_countynhg_1910 <- merge(census_sample_1930_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)

# 1920
temp <-read_fst(here(paste0("output/Rdata/census_sample_1920_agg_countynhg_1910.fst")),as.data.table=TRUE)
temp <- temp[,`:=`(sh_age_less16 = sh_age_main_0+sh_age_main_1,sh_age_16_49 = sh_age_main_2+sh_age_main_3+sh_age_main_4+sh_age_main_5,sh_age_more50 = sh_age_main_6+sh_age_main_7)][,`:=`(new_sec_all=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466 +sh_new_sector_ind1950_556+sh_new_sector_ind1950_606+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816,
                              new_sec_main=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466,
                              new_sec_serv=sh_new_sector_ind1950_556+sh_new_sector_ind1950_606+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816)]
cols <- grep("^(?!.*sh_new_sector)(?!.*sh_age_main)",names(temp),value=TRUE,perl=TRUE)
temp <- temp[,cols,with=FALSE]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_1920"))

census_sample_1930_countynhg_1910 <- merge(census_sample_1930_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)

temp <- read_fst(here(paste0("output/Rdata/census_sample_1920_agg_countynhg_1910_no_new_sec_all.fst")),as.data.table=TRUE)
cols <- grep("^countynhg_1910|^sh_ind1950|^sh_occ|^sh_base|^sh_red|^sh_race|^sh_male|^sh_lit|^H|^perwt",names(temp),value=TRUE)
temp <- temp[,cols,with=FALSE]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_1920_no_new_sec_all"))

census_sample_1930_countynhg_1910 <- merge(census_sample_1930_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)

temp <- read_fst(here(paste0("output/Rdata/census_sample_1920_agg_countynhg_1910_no_new_sec_main.fst")),as.data.table=TRUE)
cols <- grep("^countynhg_1910|^sh_ind1950|^sh_occ|^sh_base|^sh_red|^sh_race|^sh_male|^sh_lit|^H|^perwt",names(temp),value=TRUE)
temp <- temp[,cols,with=FALSE]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_1920_no_new_sec_main"))

census_sample_1930_countynhg_1910 <- merge(census_sample_1930_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)

```


### 1.2 Creating some variables for regressions
```{r}
# Converting state to a factor variable
census_sample_1930_countynhg_1910 <- census_sample_1930_countynhg_1910[,statefip_1930:=as.factor(statefip_1930)]  

# Base
base_1 <- paste0(c("sh_age_16_49_1930","sh_age_more50_1930","sh_male_1930","sh_race_2_1930","sh_race_3_1930","sh_urban_1930","sh_mig_us_1930","sh_mig_ab_1930"),collapse=" + ")
base_2 <- paste0(c("sh_labforce_1930","sh_unemp_1930","sh_wrkwage_1930"),collapse=" + ")
base_3 <- paste0(c("sh_m_mig_us_1930","sh_m_mig_ab_1930","sh_f_mig_us_1930","sh_f_mig_ab_1930","sh_marst_2_1930","sh_marst_3_1930"),collapse=" + ")

# Regional
j <- 1; regional_1_1920 <- indsh_var_1920 <- occsh_var_1920 <- regional_1_1930 <- indsh_var_1930 <- occsh_var_1930 <- vector(mode = "list")
for (i in c("","_no_new_sec_all","_no_new_sec_main")) {
  regional_1_1920[[j]] <- paste0(paste0(paste0(c("sh_lit_1920","H_1920"),i),collapse=" + ")," + log(perwt_1920",i,")" )
  indsh_var_1920[[j]] <- paste0(paste0(grep("^sh_ind1950_main_[^1]_1920$",names(census_sample_1930_countynhg_1910),value=TRUE),i),collapse=" + ")
  occsh_var_1920[[j]] <- paste0(paste0(grep("^sh_occ1950_main_[^0].+_1920$",names(census_sample_1930_countynhg_1910),value=TRUE),i),collapse=" + ")
  regional_1_1930[[j]] <- paste0(paste0(paste0(c("sh_lit_1930","H_1930$"),i),collapse=" + ")," + log(perwt_1930",i,")" )
  indsh_var_1930[[j]] <- paste0(paste0(grep("^sh_ind1950_main_[^1]_1930$",names(census_sample_1930_countynhg_1910),value=TRUE),i),collapse=" + ")
  occsh_var_1930[[j]] <- paste0(paste0(grep("^sh_occ1950_main_[^0].+_1930$",names(census_sample_1930_countynhg_1910),value=TRUE),i),collapse=" + ")
  j <- j+1
}

# New Sector
# ???

```

### 1.3. Regressions
1. base_individual + ind1950_main + sh_lit + log(perwt) + sh_new sectors (3 different cases)
2. base_individual + ind1950_main + sh_lit + log(perwt) + sh_new sectors (3 different cases) + sh_ind1950_main
3. base_individual + ind1950_main + sh_lit + log(perwt) + sh_new sectors (3 different cases) + sh_ind1950_main + sh_occ1950_main

Where base:   - (1) sh_age (three different groups), sh_male, sh_race, sh_urban, sh_mig_us, sh_mig_ab,   (maybe) sh_farm
              - (2) sh_labforce, sh_unenemp, sh_wrkwage
              - (3) sh_m_mig_us, sh_m_mig_ab, sh_f_mig_us, sh_f_mig_ab, sh_marst
Fixed effects:- statefip    
            
"Regional":   - (1) sh_lit, H, log(perwt)
              - (2) sh_occ1950_main, sh_ind1950_main

New Sector:   - new_sec_all, new_sec_main, new_sec_serv

New Work:     - sh_new_method1, sh_base_tit

It is not very clear what year should we use for the different variables. For the new sector variables the year should be 1920 and probably also for the regional variables. For the base variables I'm not entirely sure.
Regarding the variables excluding workers in new sectors, for sure we should do that for the New Work variables. We could also try to do that for the regional variables.

#### 1.3.1 Main Regressions
#### 1.3.1.1 Creating the different formulas for the regressions
```{r}
a1 <- a2 <- b1 <- b2 <- b1_no_new_sec_all <- b2_no_new_sec_all <- c <- c_no_new_sec_main <- vector(mode = "list")

j <- 1
for (i1 in c("sh_new_method1_1930")) {
  for (i2 in c(
    paste0(""),
    paste0(" + statefip_1930"),
    paste0(" + statefip_1930 + ",base_1),
    paste0(" + statefip_1930 + ",base_1," + ",base_2),
    paste0(" + statefip_1930 + ",base_1," + ",base_2," + ",base_3),
    paste0(" + ",base_1),
    paste0(" + ",base_1," + ",base_2),
    paste0(" + ",base_1," + ",base_2," + ",base_3)
    )  ) { 
    for (i3 in c(
      paste0(""),
      paste0(" + ",regional_1_1920[[1]]),
      paste0(" + ",regional_1_1920[[1]]," + ",indsh_var_1920[[1]]),
      paste0(" + ",regional_1_1920[[1]]," + ",occsh_var_1920[[1]]),
      paste0(" + ",regional_1_1920[[1]]," + ",indsh_var_1920[[1]]," + ",occsh_var_1920[[1]]),
      paste0(" + ",indsh_var_1920[[1]]),
      paste0(" + ",occsh_var_1920[[1]]),
      paste0(" + ",indsh_var_1920[[1]]," + ",occsh_var_1920[[1]])
      )  ) {
      
      a1[[j]] <- as.formula(paste(i1," ~ new_sec_all_1920",i2,i3))
      a2[[j]] <- as.formula(paste(i1," ~ new_sec_main_1920 + new_sec_serv_1920",i2,i3))
      j <- j + 1
    }
  }
}


for (i1 in c("sh_new_method1_1930_no_new_sec_all","sh_new_method1_1930_no_new_sec_main")) {
  for (i2 in c(1,2,3)) {
    j <- 1
    for (i3 in c(
      paste0(""),
      paste0(" + statefip_1930"),
      paste0(" + statefip_1930 + ",base_1),
      paste0(" + statefip_1930 + ",base_1," + ",base_2),
      paste0(" + statefip_1930 + ",base_1," + ",base_2," + ",base_3),
      paste0(" + ",base_1),
      paste0(" + ",base_1," + ",base_2),
      paste0(" + ",base_1," + ",base_2," + ",base_3)
      )  ) { 
      for (i4 in c(
        paste0(""),
        paste0(" + ",regional_1_1920[[i2]]),
        paste0(" + ",regional_1_1920[[i2]]," + ",indsh_var_1920[[i2]]),
        paste0(" + ",regional_1_1920[[i2]]," + ",occsh_var_1920[[i2]]),
        paste0(" + ",regional_1_1920[[i2]]," + ",indsh_var_1920[[i2]]," + ",occsh_var_1920[[i2]]),
        paste0(" + ",indsh_var_1920[[i2]]),
        paste0(" + ",occsh_var_1920[[i2]]),
        paste0(" + ",indsh_var_1920[[i2]]," + ",occsh_var_1920[[i2]])
        )  ) {
        if (i1=="sh_new_method1_1930_no_new_sec_all" & (i2==1)) {
          b1[[j]] <- as.formula(paste(i1," ~ new_sec_all_1920",i3,i4))
          b2[[j]] <- as.formula(paste(i1," ~ new_sec_main_1920 + new_sec_serv_1920",i3,i4))
        } else if (i1=="sh_new_method1_1930_no_new_sec_all" & (i2==2)) {
          b1_no_new_sec_all[[j]] <- as.formula(paste(i1," ~ new_sec_all_1920",i3,i4))
          b2_no_new_sec_all[[j]] <- as.formula(paste(i1," ~ new_sec_main_1920 + new_sec_serv_1920",i3,i4))
        } else if (i1=="sh_new_method1_1930_no_new_sec_main" & (i2==1)) {
          c[[j]] <- as.formula(paste(i1," ~ new_sec_main_1920",i3,i4))
        } else if (i1=="sh_new_method1_1930_no_new_sec_main" & (i2==3)) {
          c_no_new_sec_main[[j]] <- as.formula(paste(i1," ~ new_sec_main_1920",i3,i4)) 
        }
        j <- j + 1
      }
    }
  }
}

```

#### 1.3.1.2. Main Regressions
```{r}
# sh_new_method1 using all workers
coef.all <- f_regressions (arg_formula=a1,arg_data=census_sample_1930_countynhg_1910[perwt_1930 > 10000],method="lm")
coef.all_main_serv <- f_regressions (arg_formula=a2,arg_data=census_sample_1930_countynhg_1910[perwt_1930 > 10000],method="lm")

# sh_new_method1 using only no new sector workers
coef.excl_new_sec <- f_regressions (arg_formula=b1,arg_data=census_sample_1930_countynhg_1910[perwt_1930 > 10000],method="lm")
coef.excl_new_sec.main_serv <- f_regressions (arg_formula=b2,arg_data=census_sample_1930_countynhg_1910[perwt_1930 > 10000],method="lm")
coef.excl_new_sec._no_new_sec_all <- f_regressions (arg_formula=b1_no_new_sec_all,arg_data=census_sample_1930_countynhg_1910[perwt_1930 > 10000],method="lm")
coef.excl_new_sec.main_serv_no_new_sec_all <- f_regressions (arg_formula=b2_no_new_sec_all,arg_data=census_sample_1930_countynhg_1910[perwt_1930 > 10000],method="lm")

# sh_new_method1 using only no new sector main workers
coef.excl_new_sec_main <- f_regressions (arg_formula=c,arg_data=census_sample_1930_countynhg_1910[perwt_1930 > 10000],method="lm")
coef.excl_new_sec_main._no_new_sec_main <- f_regressions (arg_formula=c_no_new_sec_main,arg_data=census_sample_1930_countynhg_1910[perwt_1930 > 10000],method="lm")

# sh_new_method1 using only no new sector workers + WEIGHTS
coef.excl_new_sec.wt <- f_regressions (arg_formula=b1,arg_weights=perwt_1930,arg_data=census_sample_1930_countynhg_1910[perwt_1930 > 10000],method="lm")
coef.excl_new_sec._no_new_sec_all.wt <- f_regressions (arg_formula=b1_no_new_sec_all,arg_weights=perwt_1930,arg_data=census_sample_1930_countynhg_1910[perwt_1930 > 10000],method="lm")


```

##### Saving results
```{r}
# Variables to be exported
names_vector <- unique(c(coef.all$rn,coef.all_main_serv$rn,coef.excl_new_sec$rn,coef.excl_new_sec.main_serv$rn,coef.excl_new_sec._no_new_sec_all$rn,coef.excl_new_sec.main_serv_no_new_sec_all$rn,coef.excl_new_sec_main$rn,coef.excl_new_sec_main._no_new_sec_main$rn ))
names_vector <- c(c(grep("^new_sec_all_1920",names_vector,value=TRUE)),c(grep("^new_sec_main_1920",names_vector,value=TRUE)),c(grep("^new_sec_serv_1920",names_vector,value=TRUE)),c(grep("perwt_1920",names_vector,value=TRUE)),c(grep("^H_",names_vector,value=TRUE)),c(grep("^sh_lit",names_vector,value=TRUE)),c(grep("^sh_ind1950_main",names_vector,value=TRUE)),c(grep("^sh_occ1950_main",names_vector,value=TRUE)),c(grep("^statefip_193010",names_vector,value=TRUE)),c(grep("^sh_age_16_49",names_vector,value=TRUE)),c(grep("^sh_labforce_",names_vector,value=TRUE)),c(grep("^sh_m_mig_us_",names_vector,value=TRUE)),"adj.r2","nobs")

# Ordering variables
Order <- list(
            c(grep("^new_sec_all_1920",names_vector,value=TRUE)),
            c(grep("^new_sec_main_1920",names_vector,value=TRUE)),
            c(grep("^new_sec_serv_1920",names_vector,value=TRUE)),
            c(grep("^H_",names_vector,value=TRUE)),
            c(grep("perwt_1920",names_vector,value=TRUE)),
            c(grep("^sh_lit",names_vector,value=TRUE)),
            c(grep("^sh_occ1950_main",names_vector,value=TRUE)),
            c("adj.r2"),c("nobs"),
            c(grep("^sh_ind1950_main_2_",names_vector,value=TRUE)),
            c(grep("^sh_age_16_49",names_vector,value=TRUE)),
            c(grep("^sh_labforce_",names_vector,value=TRUE)),
            c(grep("^sh_m_mig_us_",names_vector,value=TRUE)),
            c(grep("^statefip_193010",names_vector,value=TRUE))
            )

# Exporting results
wrapper_Excel(list(
                f_order_reg(coef.all[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn),
                f_order_reg(coef.excl_new_sec[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn),
                f_order_reg(coef.excl_new_sec._no_new_sec_all[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn),
                f_order_reg(coef.excl_new_sec_main[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn),
                f_order_reg(coef.excl_new_sec_main._no_new_sec_main[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn),
                f_order_reg(coef.all_main_serv[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn),
                f_order_reg(coef.excl_new_sec.main_serv[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn),
                f_order_reg(coef.excl_new_sec.main_serv_no_new_sec_all[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn),
                f_order_reg(coef.excl_new_sec.wt[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn),
                f_order_reg(coef.excl_new_sec._no_new_sec_all.wt[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn)
),
            list("All","No_new_sec","No_new_sec_reg_exl_new","No_new_sec_main","No_new_sec_main_reg_exl_new","All_main_serv","No_new_sec_main_serv","No_new_sec_main_serv_excl_new","No_new_sec_weighted","No_new_sec_reg_exl_new+weighted"),
            here(paste0("output/Tables/regional_reg_1930_ctynhg_1910.xlsx")))

```



#### 1.3.2 Robustness Regressions - Exploring the importance of different occupations
##### 1.3.2.1 Creating the different formulas for the regressions
```{r}
# Regional
j <- 1; all_occsh_var_1920 <- occsh_except_2_var_1920 <- occsh_except_3_var_1920 <- vector(mode = "list")
t1920 <- grep("^sh_occ1950_main_.+_1920$",names(census_sample_1930_countynhg_1910),value=TRUE)
for (i in c("","_no_new_sec_all","_no_new_sec_main")) {
  all_occsh_var_1920[[j]] <- paste0(grep("^sh_occ1950_main_.+_1920$",names(census_sample_1930_countynhg_1910),value=TRUE),i)
  
  occsh_except_2_var_1920[[j]] <- paste0(  paste0(t1920[-grep("_0_|_500_",t1920)],i) ,collapse=" + ")
  occsh_except_3_var_1920[[j]] <- paste0(  paste0(t1920[-grep("_0_|_500_",t1920)],i) ,collapse=" + ")
  
  for (i1 in c(100,200,300,400,600,700,730,800,900)) {
        occsh_except_2_var_1920[[j]] <- c(occsh_except_2_var_1920[[j]],
                                          paste0(  paste0(t1920[-grep(paste0("_500_|_",i1,"_"),t1920)],i) ,collapse=" + ") 
                                          )
        occsh_except_3_var_1920[[j]] <- c(occsh_except_3_var_1920[[j]],
                                          paste0(  paste0(t1920[-grep(paste0("_0_|_500_|_",i1,"_"),t1920)],i) ,collapse=" + ") 
                                          )
  }
  
  j <- j+1
}


library(magrittr)
t %>% setdiff(., grep(paste0("_500_|_",i,"_"),t,value=TRUE) )


b1 <- b2 <- b1_no_new_sec_all <- b2_no_new_sec_all <- c <- c_no_new_sec_main <- vector(mode = "list")
for (i1 in c("sh_new_method1_1930_no_new_sec_all","sh_new_method1_1930_no_new_sec_main")) {
  for (i2 in c(1,2,3)) {
    j <- 1
    for (i3 in c(
      paste0(" + statefip_1930 + ",base_1," + ",base_2," + ",base_3),
      paste0(" + ",base_1," + ",base_2," + ",base_3)
      )  ) { 
      for (i4 in c(
                  paste0(""),
                  paste0(" + ",regional_1_1920[[i2]]),
                  paste0(" + ",regional_1_1920[[i2]]," + ",indsh_var_1920[[i2]])
                  )  ) {
        for (i5 in c(
                     all_occsh_var_1920[[i2]],
                     occsh_except_2_var_1920[[i2]],
                     occsh_except_3_var_1920[[i2]]
                     )  ) {
          if (i1=="sh_new_method1_1930_no_new_sec_all" & (i2==1)) {
            b1[[j]] <- as.formula(paste(i1," ~ new_sec_all_1920",i3,i4," + ",i5))
            b2[[j]] <- as.formula(paste(i1," ~ new_sec_main_1920 + new_sec_serv_1920",i3,i4," + ",i5))
          } else if (i1=="sh_new_method1_1930_no_new_sec_all" & (i2==2)) {
            b1_no_new_sec_all[[j]] <- as.formula(paste(i1," ~ new_sec_all_1920",i3,i4," + ",i5))
            b2_no_new_sec_all[[j]] <- as.formula(paste(i1," ~ new_sec_main_1920 + new_sec_serv_1920",i3,i4," + ",i5))
          } else if (i1=="sh_new_method1_1930_no_new_sec_main" & (i2==1)) {
            c[[j]] <- as.formula(paste(i1," ~ new_sec_main_1920",i3,i4," + ",i5))
          } else if (i1=="sh_new_method1_1930_no_new_sec_main" & (i2==3)) {
            c_no_new_sec_main[[j]] <- as.formula(paste(i1," ~ new_sec_main_1920",i3,i4," + ",i5)) 
          }
          j <- j + 1
        }
      }
    }
  }
}

```

#### 1.3.2.2. Regressions
```{r}
# sh_new_method1 using only no new sector workers
coef.excl_new_sec <- f_regressions (arg_formula=b1,arg_data=census_sample_1930_countynhg_1910[perwt_1930 > 10000],method="lm")
coef.excl_new_sec.main_serv <- f_regressions (arg_formula=b2,arg_data=census_sample_1930_countynhg_1910[perwt_1930 > 10000],method="lm")
coef.excl_new_sec._no_new_sec_all <- f_regressions (arg_formula=b1_no_new_sec_all,arg_data=census_sample_1930_countynhg_1910[perwt_1930 > 10000],method="lm")
coef.excl_new_sec.main_serv_no_new_sec_all <- f_regressions (arg_formula=b2_no_new_sec_all,arg_data=census_sample_1930_countynhg_1910[perwt_1930 > 10000],method="lm")

# sh_new_method1 using only no new sector main workers
coef.excl_new_sec_main <- f_regressions (arg_formula=c,arg_data=census_sample_1930_countynhg_1910[perwt_1930 > 10000],method="lm")
coef.excl_new_sec_main._no_new_sec_main <- f_regressions (arg_formula=c_no_new_sec_main,arg_data=census_sample_1930_countynhg_1910[perwt_1930 > 10000],method="lm")
```

##### Saving results
```{r}
# Variables to be exported
names_vector <- unique(c(coef.excl_new_sec$rn,coef.excl_new_sec.main_serv$rn,coef.excl_new_sec._no_new_sec_all$rn,coef.excl_new_sec.main_serv_no_new_sec_all$rn,coef.excl_new_sec_main$rn,coef.excl_new_sec_main._no_new_sec_main$rn ))
names_vector <- c(c(grep("^new_sec_all_1920",names_vector,value=TRUE)),c(grep("^new_sec_main_1920",names_vector,value=TRUE)),c(grep("^new_sec_serv_1920",names_vector,value=TRUE)),c(grep("perwt_1920",names_vector,value=TRUE)),c(grep("^H_",names_vector,value=TRUE)),c(grep("^sh_lit",names_vector,value=TRUE)),c(grep("^sh_ind1950_main_2_",names_vector,value=TRUE)),c(grep("^sh_occ1950_main",names_vector,value=TRUE)),c(grep("^statefip_193010",names_vector,value=TRUE)),c(grep("^sh_age_16_49",names_vector,value=TRUE)),c(grep("^sh_labforce_",names_vector,value=TRUE)),c(grep("^sh_m_mig_us_",names_vector,value=TRUE)),"adj.r2","nobs")

# Ordering variables
Order <- list(
            c(grep("^new_sec_all_1920",names_vector,value=TRUE)),
            c(grep("^new_sec_main_1920",names_vector,value=TRUE)),
            c(grep("^new_sec_serv_1920",names_vector,value=TRUE)),
            c(grep("^H_",names_vector,value=TRUE)),
            c(grep("perwt_1920",names_vector,value=TRUE)),
            c(grep("^sh_lit",names_vector,value=TRUE)),
            c(grep("^sh_occ1950_main",names_vector,value=TRUE)),
            c("adj.r2"),c("nobs"),
            c(grep("^sh_ind1950_main_2_",names_vector,value=TRUE)),
            c(grep("^sh_age_16_49",names_vector,value=TRUE)),
            c(grep("^sh_labforce_",names_vector,value=TRUE)),
            c(grep("^sh_m_mig_us_",names_vector,value=TRUE)),
            c(grep("^statefip_193010",names_vector,value=TRUE))
            )


# Exporting results
wrapper_Excel(list(
                f_order_reg(coef.excl_new_sec[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn),
                f_order_reg(coef.excl_new_sec._no_new_sec_all[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn),
                f_order_reg(coef.excl_new_sec_main[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn),
                f_order_reg(coef.excl_new_sec_main._no_new_sec_main[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn),
                f_order_reg(coef.excl_new_sec.main_serv[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn),
                f_order_reg(coef.excl_new_sec.main_serv_no_new_sec_all[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn)
            ),
            list("No_new_sec","No_new_sec_reg_exl_new","No_new_sec_main","No_new_sec_main_reg_exl_new","No_new_sec_main_serv","No_new_sec_main_serv_excl_new"),
            here(paste0("output/Tables/regional_reg_1930_ctynhg_1910_occsh_exercise.xlsx")))




```


# Part 7. Regressions following Lin (2011) - Obtaining residual for the county or city fixed effects and then performing the regional regression on these coefficients.
Loading packages and erasing the workspace (make sure to have loaded f_load_pk)
```{r}
rm(list=setdiff(ls(all.names = TRUE), "f_load_pk"))
f_load_pk()
```


### 0.1. Functions related to regressions
#### Function to export results
```{r}
f_reg_results <- function(Regresults,arg_round=4) {
  # NOTES:
  # Regresults: data.table with 5 columns. (1) Name of variables, (2) Regression coefficient, (3) Standard value, (4) T-Value, (5) P_value
  # Arg_round: number of significance digits. 4 bu default
  
  #sig_10 <- qt(p=.1/2,df=arg_df,lower.tail=FALSE)
  #sig_5  <- qt(p=.05/2,df=arg_df,lower.tail=FALSE)
  #sig_1  <- qt(p=.01/2,df=arg_df,lower.tail=FALSE)
  X <- copy(Regresults)
  setnames(X,c(2,3,4,5),c("coef","std","t_value","p_value"))
  X[,coef_star:=ifelse(p_value>0.1,format(round(coef,arg_round),nsmall=2),ifelse(p_value>0.05,paste0(format(round(coef,arg_round),nsmall=2),"*"),ifelse(p_value>0.01,paste0(format(round(coef,arg_round),nsmall=2),"**"),paste0(format(round(coef,arg_round),nsmall=2),"***"))))]
  #coef.J[,coef_star:=ifelse(x==1,paste0(format(round(coef,arg_round),nsmall=2),"***"),ifelse(x==5,paste0(format(round(coef,arg_round),nsmall=2),"**"),ifelse(x==10,paste0(format(round(coef,arg_round),nsmall=2),"*"),format(round(coef,arg_round),nsmall=2))))]
  X[,std_par:=paste0("(",format(round(std,arg_round),nsmall=2),")")]
  return(X)
}
```

#### Function to perform a set of regressions
This function works with methods lm and lm_robust
**********TO-DO
- For lm_robust need to specify the possibility of not using clusters
```{r}
f_regressions <- function(arg_formula,arg_data,arg_weights,method,arg_clusters,to_iter = 1000, by_iter = 10) {
  # Arguments:
  #           - arg_formula: list with the set of regressions formulas
  #           - arg_data: dataset with the variables in arg_formula
  #           - arg_weights: variable contianing the weights used in the regression
  #           - method: either "lm" or "lm_robust"
  #           - arg_clusters: Variable used to cluster standard errors
  #           - iter_vec: vector containing the numbers of the iteration that you want to be displayed
  
  # Note1: There is a conflict if arg_formula is not a list. E.g. if you create a list (LS) but in arg_formula you introduce LS[[i]], the function will try to subset it and that will give an error. If that is the case introduce it as a list, e.g. list(LS[[i]])
  
  # Note2: Instead of copying arg_data I decided to change the names back to their original names at the end of the function.
  iter_vec <- seq(from =0, to = to_iter, by = by_iter)
  i <- 1
  ## IF argument ARG_WEIGHTS is specified
  if (!missing(arg_weights)) {
    setnames(arg_data,c(deparse(substitute(arg_weights))),c("arg_w"))
    if (i %in% iter_vec) {
      tic(paste0("Iteration ",i," to ",min(i+by_iter-1,length(arg_formula))))
      i0 <- i + by_iter -1
    }
    if (method=="lm") {
      A <- summary(lm(arg_formula[[1]],data=arg_data,weights=arg_w,model=FALSE))
      other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(length(A$residuals),format(round(A$adj.r.squared,4),nsmall=2)),unname(A$fstatistic)))
    } else if (method=="lm_robust") {
      setnames(arg_data,c(deparse(substitute(arg_clusters))),c("arg_cl"))
      A <- summary(lm_robust(arg_formula[[1]],weights=arg_w,clusters=arg_cl,se_type='stata',data=arg_data))
      other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(A$nobs,format(round(A$adj.r.squared,4),nsmall=2)),unname(A$fstatistic)))
    }
    coef <- f_reg_results( data.table(A$coefficients[,1:4],keep.rownames=TRUE), arg_round=4 )
    coef <- melt(coef,id.vars = c("rn"), measure.vars = c("coef","std","t_value","p_value","coef_star","std_par"),value.name=c(paste0("model_",1)))
    coef <- rbind(coef,other)
    if (i == i0) toc()
    rm(A,other)
    
    if (length(arg_formula)>1) {
      for (i in 2:length(arg_formula)) {
        if (i %in% iter_vec) {
          tic(paste0("Iteration ",i," to ",min(i+by_iter-1,length(arg_formula))))
          i0 <- i+by_iter -1
        }
        if (method=="lm") {
          A <- summary(lm(arg_formula[[i]],data=arg_data,weights=arg_w,model=FALSE))
          other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(length(A$residuals),format(round(A$adj.r.squared,4),nsmall=2)),unname(A$fstatistic)))
          setnames(other,c(3),c(paste0("model_",i)))
        } else if (method=="lm_robust") {
          A <- summary(lm_robust(arg_formula[[i]],weights=arg_w,clusters=arg_cl,se_type='stata',data=arg_data))
          other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(A$nobs,format(round(A$adj.r.squared,4),nsmall=2)),unname(A$fstatistic)))
          setnames(other,c(3),c(paste0("model_",i)))
        }
        
        t <- f_reg_results( data.table(A$coefficients[,1:4],keep.rownames=TRUE), arg_round=4)
        t <- melt(t,id.vars = c("rn"), measure.vars = c("coef","std","t_value","p_value","coef_star","std_par"),value.name=c(paste0("model_",i)))
        t <- rbind(t,other)
        coef <- merge(coef,t,by=c("rn","variable"),all=TRUE)
        rm(A,other,t)
        if (i0==i) toc()
      }
    
    }
    
    
  ## NOOO argument ARG_WEIGHTS 
  } else {
    if (i %in% iter_vec) {
      tic(paste0("Iteration ",i," to ",min(i+by_iter-1,length(arg_formula))))
      i0 <- i + by_iter -1
    }
    if (method=="lm") {
      A <- summary(lm(arg_formula[[1]],data=arg_data,model=FALSE))
      other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(length(A$residuals),format(round(A$adj.r.squared,4),nsmall=2)),unname(A$fstatistic)))
    } else if (method=="lm_robust") {
      setnames(arg_data,c(deparse(substitute(arg_clusters))),c("arg_cl"))
      A <- summary(lm_robust(arg_formula[[1]],clusters=arg_cl,se_type='stata',data=arg_data))
      other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(A$nobs,format(round(A$adj.r.squared,4),nsmall=2)),unname(A$fstatistic)))
    }
    coef <- f_reg_results( data.table(A$coefficients[,1:4],keep.rownames=TRUE), arg_round=4 )
    coef <- melt(coef,id.vars = c("rn"), measure.vars = c("coef","std","t_value","p_value","coef_star","std_par"),value.name=c(paste0("model_",1)))
    coef <- rbind(coef,other)
    if (i == i0) toc()
    rm(A,other)
    
    if (length(arg_formula)>1) {
      for (i in 2:length(arg_formula)) {
        if (i %in% iter_vec) {
          tic(paste0("Iteration ",i," to ",min(i+by_iter-1,length(arg_formula))))
          i0 <- i + by_iter -1
        }
        if (method=="lm") {
          A <- summary(lm(arg_formula[[i]],data=arg_data,model=FALSE))
          other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(length(A$residuals),format(round(A$adj.r.squared,4),nsmall=2)),unname(A$fstatistic)))
          setnames(other,c(3),c(paste0("model_",i)))
        } else if (method=="lm_robust") {
          A <- summary(lm_robust(arg_formula[[i]],clusters=arg_cl,se_type='stata',data=arg_data))
          other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(A$nobs,format(round(A$adj.r.squared,4),nsmall=2)),unname(A$fstatistic)))
          setnames(other,c(3),c(paste0("model_",i)))
        }
        
        t <- f_reg_results( data.table(A$coefficients[,1:4],keep.rownames=TRUE), arg_round=4)
        t <- melt(t,id.vars = c("rn"), measure.vars = c("coef","std","t_value","p_value","coef_star","std_par"),value.name=c(paste0("model_",i)))
        t <- rbind(t,other)
        coef <- merge(coef,t,by=c("rn","variable"),all=TRUE)
        rm(A,other,t)
        if (i == i0) toc()
      }
    
    }
    
    
  }
  
  coef <- as.data.table(coef)
  coef[,order:=ifelse(variable=="zother",1,0)]
  setorder(coef,order,rn)
  coef[,order:=NULL]
  
  if (!missing(arg_weights)) { setnames(arg_data, c("arg_w"), c(deparse(substitute(arg_weights))) )   }
  
  if (method=="lm_robust") {
    setnames(arg_data,c("arg_cl"),c(deparse(substitute(arg_clusters))))
  }
  if (i==length(arg_formula)) toc()
  return(coef)
}


```

#### Function to order (regressions)
Given a dataset (X) a variable in the data_set (order_var) and a vector of names of the variables, this function orders the dataset X according to the order provided in the vector Order
```{r}
f_order_reg <- function(X,Order,order_var) {
  Y <- copy(X)[,vec_order:=Inf]
  setnames(Y,c(deparse(substitute(order_var))),c("arg_order_var"))
  for (i in 1:length(Order)) {
    Y <- Y[arg_order_var %in% Order[[i]],vec_order:=i]
  }
  Y <- Y[order(vec_order,arg_order_var)][,vec_order:=NULL]
  setnames(Y,c("arg_order_var"),c(deparse(substitute(order_var))))
  return (Y)
}
```


## 0.2. Functions to export tables to Excel
```{r}
wrapper_Excel <- function(list_table,list_name,output) {
  t <- createWorkbook()
  for (i in 1:length(list_table)) {
    addWorksheet(t, list_name[[i]])
    writeData(t, list_name[[i]],list_table[[i]])
  }
  saveWorkbook(t, output,overwrite=TRUE)
}
```


## 1. Regressions following Lin (2011) - At the countynhg_1910 level
****** TO BE FINISHED **********
****** TO BE FINISHED **********
****** TO BE FINISHED **********
****** TO BE FINISHED **********
****** TO BE FINISHED **********

- To construct the database use the regional database of Part 6., to account for reginal variables excluding workers in new sectors
- As the explanatory variable we will use the fixed effects computed in the file boostrap_fixed_effects_model.Rmd

## Regressions at the countynhg_1910 level
### 1.1. Construct regional level database
```{r}
# 1930
census_sample_1930_countynhg_1910 <-read_fst(here(paste0("output/Rdata/census_sample_1930_agg_countynhg_1910.fst")),as.data.table=TRUE)
census_sample_1930_countynhg_1910 <- census_sample_1930_countynhg_1910[,`:=`(sh_age_less16 = sh_age_main_0+sh_age_main_1,sh_age_16_49 = sh_age_main_2+sh_age_main_3+sh_age_main_4+sh_age_main_5,sh_age_more50 = sh_age_main_6+sh_age_main_7)][,`:=`(new_sec_all=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466 +sh_new_sector_ind1950_556+sh_new_sector_ind1950_606+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816 + sh_new_sector_ind1950_856,
                              new_sec_main=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466+ sh_new_sector_ind1950_856,
                              new_sec_serv=sh_new_sector_ind1950_556+sh_new_sector_ind1950_606+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816)]
cols <- grep("^(?!.*sh_new_sector)(?!.*sh_age_main)",names(census_sample_1930_countynhg_1910),value=TRUE,perl=TRUE)
census_sample_1930_countynhg_1910 <- census_sample_1930_countynhg_1910[,cols,with=FALSE]
cols <- names(census_sample_1930_countynhg_1910[,!c("countynhg_1910")])
setnames(census_sample_1930_countynhg_1910,cols,paste0(cols,"_1930"))

temp <- read_fst(here(paste0("output/Rdata/census_sample_1930_agg_countynhg_1910_no_new_sec_all.fst")),as.data.table=TRUE)
cols <- grep("^countynhg_1910|^sh_ind1950|^sh_occ|^sh_base|^sh_red|^sh_race|^sh_male|^sh_lit|^H|^perwt",names(temp),value=TRUE)
temp <- temp[,cols,with=FALSE]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_1930_no_new_sec_all"))

census_sample_1930_countynhg_1910 <- merge(census_sample_1930_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)

temp <- read_fst(here(paste0("output/Rdata/census_sample_1930_agg_countynhg_1910_no_new_sec_main.fst")),as.data.table=TRUE)
cols <- grep("^countynhg_1910|^sh_ind1950|^sh_occ|^sh_base|^sh_red|^sh_race|^sh_male|^sh_lit|^H|^perwt",names(temp),value=TRUE)
temp <- temp[,cols,with=FALSE]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_1930_no_new_sec_main"))

census_sample_1930_countynhg_1910 <- merge(census_sample_1930_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)

# 1920
temp <-read_fst(here(paste0("output/Rdata/census_sample_1920_agg_countynhg_1910.fst")),as.data.table=TRUE)
temp <- temp[,`:=`(sh_age_less16 = sh_age_main_0+sh_age_main_1,sh_age_16_49 = sh_age_main_2+sh_age_main_3+sh_age_main_4+sh_age_main_5,sh_age_more50 = sh_age_main_6+sh_age_main_7)][,`:=`(new_sec_all=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466 +sh_new_sector_ind1950_556+sh_new_sector_ind1950_606+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816,
                              new_sec_main=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466,
                              new_sec_serv=sh_new_sector_ind1950_556+sh_new_sector_ind1950_606+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816)]
cols <- grep("^(?!.*sh_new_sector)(?!.*sh_age_main)",names(temp),value=TRUE,perl=TRUE)
temp <- temp[,cols,with=FALSE]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_1920"))

census_sample_1930_countynhg_1910 <- merge(census_sample_1930_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)

temp <- read_fst(here(paste0("output/Rdata/census_sample_1920_agg_countynhg_1910_no_new_sec_all.fst")),as.data.table=TRUE)
cols <- grep("^countynhg_1910|^sh_ind1950|^sh_occ|^sh_base|^sh_red|^sh_race|^sh_male|^sh_lit|^H|^perwt",names(temp),value=TRUE)
temp <- temp[,cols,with=FALSE]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_1920_no_new_sec_all"))

census_sample_1930_countynhg_1910 <- merge(census_sample_1930_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)

temp <- read_fst(here(paste0("output/Rdata/census_sample_1920_agg_countynhg_1910_no_new_sec_main.fst")),as.data.table=TRUE)
cols <- grep("^countynhg_1910|^sh_ind1950|^sh_occ|^sh_base|^sh_red|^sh_race|^sh_male|^sh_lit|^H|^perwt",names(temp),value=TRUE)
temp <- temp[,cols,with=FALSE]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_1920_no_new_sec_main"))

census_sample_1930_countynhg_1910 <- merge(census_sample_1930_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)

#*** Adding the estimated coefficients from the first stage regression performed in the file bootstrap_fixed_effects_model.Rmd
# NOTE: in the following temp files we use less counties because we are only working with counties that have at least 10000 workers
# Base individual, no ind1950_main
temp <- read_fst(here(paste0("output/Rdata/estimation.bootstrap.perwtge_10000.nostatefe_noindmain.fst")),as.data.table=TRUE)

census_sample_1930_countynhg_1910 <- merge(census_sample_1930_countynhg_1910[,countynhg_1910:=as.factor(countynhg_1910)],temp[,c("rn","coef.b","se.b")],by.x="countynhg_1910",by.y="rn",all.x=TRUE,all.y=FALSE)
# Constructing the weights
census_sample_1930_countynhg_1910[,weights_base.no_new_sec_all:=1/(se.b^2)] 
setnames(census_sample_1930_countynhg_1910,c("coef.b","se.b"),c("region_fe_base.no_new_sec_all","se_region_fe_base.no_new_sec_all"))


# Base individual, with ind1950_main
temp <- read_fst(here(paste0("output/Rdata/estimation.bootstrap.perwtge_10000.nostatefe_with_indmain.fst")),as.data.table=TRUE)

census_sample_1930_countynhg_1910 <- merge(census_sample_1930_countynhg_1910[,countynhg_1910:=as.factor(countynhg_1910)],temp[,c("rn","coef.b","se.b")],by.x="countynhg_1910",by.y="rn",all.x=TRUE,all.y=FALSE)
# Constructing the weights
census_sample_1930_countynhg_1910[,weights_with_ind1950_main.no_new_sec_all:=1/(se.b^2)] 
setnames(census_sample_1930_countynhg_1910,c("coef.b","se.b"),c("region_fe_with_ind1950_main.no_new_sec_all","se_region_fe_with_ind1950_main.no_new_sec_all"))

# No individual controls
temp <- read_fst(here(paste0("output/Rdata/estimation.bootstrap.perwtge_10000.nostatefe_with_indmain.fst")),as.data.table=TRUE)

census_sample_1930_countynhg_1910 <- merge(census_sample_1930_countynhg_1910[,countynhg_1910:=as.factor(countynhg_1910)],temp[,c("rn","coef.b","se.b")],by.x="countynhg_1910",by.y="rn",all.x=TRUE,all.y=FALSE)
# Constructing the weights
census_sample_1930_countynhg_1910[,weights_no_indiv_controls.no_new_sec_all:=1/(se.b^2)] 
setnames(census_sample_1930_countynhg_1910,c("coef.b","se.b"),c("region_fe_no_indiv_controls.no_new_sec_all","se_region_fe_no_indiv_controls.no_new_sec_all"))

rm(temp)
```


### 1.2 Creating some variables for regressions
```{r}
# Converting state to a factor variable
census_sample_1930_countynhg_1910 <- census_sample_1930_countynhg_1910[,statefip_1930:=as.factor(statefip_1930)]  

# Base
base_1 <- paste0(c("sh_age_16_49_1930","sh_age_more50_1930","sh_male_1930","sh_race_2_1930","sh_race_3_1930","sh_urban_1930","sh_mig_us_1930","sh_mig_ab_1930"),collapse=" + ")
base_2 <- paste0(c("sh_labforce_1930","sh_unemp_1930","sh_wrkwage_1930"),collapse=" + ")
base_3 <- paste0(c("sh_m_mig_us_1930","sh_m_mig_ab_1930","sh_f_mig_us_1930","sh_f_mig_ab_1930","sh_marst_2_1930","sh_marst_3_1930"),collapse=" + ")

# Regional
j <- 1; regional_1_1920 <- indsh_var_1920 <- occsh_var_1920 <- regional_1_1930 <- indsh_var_1930 <- occsh_var_1930 <- vector(mode = "list")
for (i in c("","_no_new_sec_all","_no_new_sec_main")) {
  regional_1_1920[[j]] <- paste0(paste0(paste0(c("sh_lit_1920","H_1920"),i),collapse=" + ")," + log(perwt_1920",i,")" )
  indsh_var_1920[[j]] <- paste0(paste0(grep("^sh_ind1950_main_[^1]_1920$",names(census_sample_1930_countynhg_1910),value=TRUE),i),collapse=" + ")
  occsh_var_1920[[j]] <- paste0(paste0(grep("^sh_occ1950_main_[^0].+_1920$",names(census_sample_1930_countynhg_1910),value=TRUE),i),collapse=" + ")
  regional_1_1930[[j]] <- paste0(paste0(paste0(c("sh_lit_1930","H_1930$"),i),collapse=" + ")," + log(perwt_1930",i,")" )
  indsh_var_1930[[j]] <- paste0(paste0(grep("^sh_ind1950_main_[^1]_1930$",names(census_sample_1930_countynhg_1910),value=TRUE),i),collapse=" + ")
  occsh_var_1930[[j]] <- paste0(paste0(grep("^sh_occ1950_main_[^0].+_1930$",names(census_sample_1930_countynhg_1910),value=TRUE),i),collapse=" + ")
  j <- j+1
}

# New Sector
# ???

```

### 1.3. Regressions
1. sh_lit + log(perwt) + sh_new sectors (3 different cases)
2. sh_lit + log(perwt) + sh_new sectors (3 different cases) + sh_ind1950_main
3. sh_lit + log(perwt) + sh_new sectors (3 different cases) + sh_ind1950_main + sh_occ1950_main

Where base:   - (1) sh_age (three different groups), sh_male, sh_race, sh_urban, sh_mig_us, sh_mig_ab,   (maybe) sh_farm
              - (2) sh_labforce, sh_unenemp, sh_wrkwage
              - (3) sh_m_mig_us, sh_m_mig_ab, sh_f_mig_us, sh_f_mig_ab, sh_marst
Fixed effects:- statefip    
            
"Regional":   - (1) sh_lit, H, log(perwt)
              - (2) sh_occ1950_main, sh_ind1950_main

New Sector:   - new_sec_all, new_sec_main, new_sec_serv

New Work:     - sh_new_method1, sh_base_tit

It is not very clear what year should we use for the different variables. For the new sector variables the year should be 1920 and probably also for the regional variables. For the base variables I'm not entirely sure.
Regarding the variables excluding workers in new sectors, for sure we should do that for the New Work variables. We could also try to do that for the regional variables.

#### 1.3.1 Main Regressions
#### 1.3.1.1 Creating the different formulas for the regressions
- TO-DO
  - Dependent variable: run more first stage regressions.
    - Changing the set of workers: (1) All workers, (2) Excluding workers in the Main New Sector
    - Changing the regressors: (1) No regressors, (2) Expand set of individual variables, (3) With ind_main1950
  - Add the different regressions to the following code chunk
    - What changes is the dependent variable, according to the previous bullet point.

```{r}
a1 <- a2 <- b1 <- b2 <- b1_no_new_sec_all <- b2_no_new_sec_all <- c1 <- c2 <- c1_no_new_sec_all <- c2_no_new_sec_all <- d1 <- d2 <- d1_no_new_sec_all <- d2_no_new_sec_all <- e <- e_no_new_sec_main <- vector(mode = "list")

j <- 1
for (i1 in c("region_fe")) {
  for (i2 in c(
    paste0(""),
    paste0(" + statefip_1930")
    # ****NOTE: not sure if I should include the base variables. In the first stage I am already accounting for that. Nonetheless, I did that for share of literate...
    #paste0(" + statefip_1930 + ",base_1),
    #paste0(" + statefip_1930 + ",base_1," + ",base_2),
    #paste0(" + statefip_1930 + ",base_1," + ",base_2," + ",base_3),
    #paste0(" + ",base_1),
    #paste0(" + ",base_1," + ",base_2),
    #paste0(" + ",base_1," + ",base_2," + ",base_3)
    )  ) { 
    for (i3 in c(
      paste0(""),
      paste0(" + ",regional_1_1920[[1]]),
      paste0(" + ",regional_1_1920[[1]]," + ",indsh_var_1920[[1]]),
      paste0(" + ",regional_1_1920[[1]]," + ",occsh_var_1920[[1]]),
      paste0(" + ",regional_1_1920[[1]]," + ",indsh_var_1920[[1]]," + ",occsh_var_1920[[1]]),
      paste0(" + ",indsh_var_1920[[1]]),
      paste0(" + ",occsh_var_1920[[1]]),
      paste0(" + ",indsh_var_1920[[1]]," + ",occsh_var_1920[[1]])
      )  ) {
      
      a1[[j]] <- as.formula(paste(i1," ~ new_sec_all_1920",i2,i3))
      a2[[j]] <- as.formula(paste(i1," ~ new_sec_main_1920 + new_sec_serv_1920",i2,i3))
      j <- j + 1
    }
  }
}


for (i1 in c("region_fe_no_indiv_controls.no_new_sec_all","region_fe_base.no_new_sec_all","region_fe_with_ind1950_main.no_new_sec_all","region_fe.no_new_sec_main")) {
  for (i2 in c(1,2,3)) {
    j <- 1
    for (i3 in c(
      paste0(""),
      paste0(" + statefip_1930"),
      # ****NOTE: not sure if I should include the base variables. In the first stage I am already accounting for that. Nonetheless, I did that for share of literate...
      paste0(" + statefip_1930 + ",base_1),
      paste0(" + statefip_1930 + ",base_1," + ",base_2),
      paste0(" + statefip_1930 + ",base_1," + ",base_2," + ",base_3),
      paste0(" + ",base_1),
      paste0(" + ",base_1," + ",base_2),
      paste0(" + ",base_1," + ",base_2," + ",base_3)
      )  ) { 
      for (i4 in c(
        paste0(""),
        paste0(" + ",regional_1_1920[[i2]]),
        paste0(" + ",regional_1_1920[[i2]]," + ",indsh_var_1920[[i2]]),
        paste0(" + ",regional_1_1920[[i2]]," + ",occsh_var_1920[[i2]]),
        paste0(" + ",regional_1_1920[[i2]]," + ",indsh_var_1920[[i2]]," + ",occsh_var_1920[[i2]]),
        paste0(" + ",indsh_var_1920[[i2]]),
        paste0(" + ",occsh_var_1920[[i2]]),
        paste0(" + ",indsh_var_1920[[i2]]," + ",occsh_var_1920[[i2]])
        )  ) {
        if (i1=="region_fe_base.no_new_sec_all" & (i2==1)) {
          b1[[j]] <- as.formula(paste(i1," ~ new_sec_all_1920",i3,i4))
          b2[[j]] <- as.formula(paste(i1," ~ new_sec_main_1920 + new_sec_serv_1920",i3,i4))
        } else if (i1=="region_fe_base.no_new_sec_all" & (i2==2)) {
          b1_no_new_sec_all[[j]] <- as.formula(paste(i1," ~ new_sec_all_1920",i3,i4))
          b2_no_new_sec_all[[j]] <- as.formula(paste(i1," ~ new_sec_main_1920 + new_sec_serv_1920",i3,i4))
        } else if (i1=="region_fe_with_ind1950_main.no_new_sec_all" & (i2==1)) {
          c1[[j]] <- as.formula(paste(i1," ~ new_sec_all_1920",i3,i4))
          c2[[j]] <- as.formula(paste(i1," ~ new_sec_main_1920 + new_sec_serv_1920",i3,i4))
        } else if (i1=="region_fe_with_ind1950_main.no_new_sec_all" & (i2==2)) {
          c1_no_new_sec_all[[j]] <- as.formula(paste(i1," ~ new_sec_all_1920",i3,i4))
          c2_no_new_sec_all[[j]] <- as.formula(paste(i1," ~ new_sec_main_1920 + new_sec_serv_1920",i3,i4))
        } else if (i1=="region_fe_no_indiv_controls.no_new_sec_all" & (i2==1)) {
          d1[[j]] <- as.formula(paste(i1," ~ new_sec_all_1920",i3,i4))
          d2[[j]] <- as.formula(paste(i1," ~ new_sec_main_1920 + new_sec_serv_1920",i3,i4))
        } else if (i1=="region_fe_no_indiv_controls.no_new_sec_all" & (i2==2)) {
          d1_no_new_sec_all[[j]] <- as.formula(paste(i1," ~ new_sec_all_1920",i3,i4))
          d2_no_new_sec_all[[j]] <- as.formula(paste(i1," ~ new_sec_main_1920 + new_sec_serv_1920",i3,i4)) 
        }else if (i1=="region_fe_base.no_new_sec_main" & (i2==1)) {
          e[[j]] <- as.formula(paste(i1," ~ new_sec_main_1920",i3,i4))
        } else if (i1=="region_fe_base.no_new_sec_main" & (i2==3)) {
          e_no_new_sec_main[[j]] <- as.formula(paste(i1," ~ new_sec_main_1920",i3,i4)) 
        }
        j <- j + 1
      }
    }
  }
}

```

#### 1.3.1.2. Main Regressions
```{r}
# First Stage regression using all the workers
## No first-stage controls
## Main first-stage controls
## Main first-stage controls + ind1950_main
## Expanded first-stage controls

# First Stage regression excluding workers in New Sectors
## Main first-stage controls
coef.excl_new_sec <- f_regressions (arg_formula=b1,arg_data=census_sample_1930_countynhg_1910[perwt_1930 > 10000 & !is.na(region_fe_base.no_new_sec_all)],arg_weights=weights_base.no_new_sec_all,method="lm")
coef.excl_new_sec.main_serv <- f_regressions (arg_formula=b2,arg_data=census_sample_1930_countynhg_1910[perwt_1930 > 10000 & !is.na(region_fe_base.no_new_sec_all)],arg_weights=weights_base.no_new_sec_all,method="lm")
coef.excl_new_sec._no_new_sec_all <- f_regressions (arg_formula=b1_no_new_sec_all,arg_data=census_sample_1930_countynhg_1910[perwt_1930 > 10000 & !is.na(region_fe_base.no_new_sec_all)],arg_weights=weights_base.no_new_sec_all,method="lm")
coef.excl_new_sec.main_serv_no_new_sec_all <- f_regressions (arg_formula=b2_no_new_sec_all,arg_data=census_sample_1930_countynhg_1910[perwt_1930 > 10000 & !is.na(region_fe_base.no_new_sec_all)],arg_weights=weights_base.no_new_sec_all,method="lm")

## Main first-stage controls + ind1950_main
coef_ind1950_main.excl_new_sec <- f_regressions (arg_formula=c1,arg_data=census_sample_1930_countynhg_1910[perwt_1930 > 10000 & !is.na(region_fe_with_ind1950_main.no_new_sec_all)],arg_weights=weights_with_ind1950_main.no_new_sec_all,method="lm")
coef_ind1950_main.excl_new_sec.main_serv <- f_regressions (arg_formula=c2,arg_data=census_sample_1930_countynhg_1910[perwt_1930 > 10000 & !is.na(region_fe_with_ind1950_main.no_new_sec_all)],arg_weights=weights_with_ind1950_main.no_new_sec_all,method="lm")
coef_ind1950_main.excl_new_sec._no_new_sec_all <- f_regressions (arg_formula=c1_no_new_sec_all,arg_data=census_sample_1930_countynhg_1910[perwt_1930 > 10000 & !is.na(region_fe_with_ind1950_main.no_new_sec_all)],arg_weights=weights_with_ind1950_main.no_new_sec_all,method="lm")
coef_ind1950_main.excl_new_sec.main_serv_no_new_sec_all <- f_regressions (arg_formula=c2_no_new_sec_all,arg_data=census_sample_1930_countynhg_1910[perwt_1930 > 10000 & !is.na(region_fe_with_ind1950_main.no_new_sec_all)],arg_weights=weights_with_ind1950_main.no_new_sec_all,method="lm")

## NO first-stage controls
coef_no_indiv_controls.excl_new_sec <- f_regressions (arg_formula=d1,arg_data=census_sample_1930_countynhg_1910[perwt_1930 > 10000 & !is.na(region_fe_no_indiv_controls.no_new_sec_all)],arg_weights=weights_no_indiv_controls.no_new_sec_all,method="lm")
coef_no_indiv_controls.excl_new_sec.main_serv <- f_regressions (arg_formula=d2,arg_data=census_sample_1930_countynhg_1910[perwt_1930 > 10000 & !is.na(region_fe_no_indiv_controls.no_new_sec_all)],arg_weights=weights_no_indiv_controls.no_new_sec_all,method="lm")
coef_no_indiv_controls.excl_new_sec._no_new_sec_all <- f_regressions (arg_formula=d1_no_new_sec_all,arg_data=census_sample_1930_countynhg_1910[perwt_1930 > 10000 & !is.na(region_fe_no_indiv_controls.no_new_sec_all)],arg_weights=weights_no_indiv_controls.no_new_sec_all,method="lm")
coef_no_indiv_controls.excl_new_sec.main_serv_no_new_sec_all <- f_regressions (arg_formula=d2_no_new_sec_all,arg_data=census_sample_1930_countynhg_1910[perwt_1930 > 10000 & !is.na(region_fe_no_indiv_controls.no_new_sec_all)],arg_weights=weights_no_indiv_controls.no_new_sec_all,method="lm")


```

##### Saving results
```{r}
# Variables to be exported
names_vector <- unique(c(coef.excl_new_sec$rn,coef.excl_new_sec.main_serv$rn,coef.excl_new_sec._no_new_sec_all$rn,coef.excl_new_sec.main_serv_no_new_sec_all$rn,coef_ind1950_main.excl_new_sec$rn,coef_ind1950_main.excl_new_sec.main_serv$rn,coef_ind1950_main.excl_new_sec._no_new_sec_all$rn,coef_ind1950_main.excl_new_sec.main_serv_no_new_sec_all$rn,coef_no_indiv_controls.excl_new_sec$rn,coef_no_indiv_controls.excl_new_sec.main_serv$rn,coef_no_indiv_controls.excl_new_sec._no_new_sec_all$rn,coef_no_indiv_controls.excl_new_sec.main_serv_no_new_sec_all$rn))
names_vector <- c(c(grep("^new_sec_all_1920",names_vector,value=TRUE)),c(grep("^new_sec_main_1920",names_vector,value=TRUE)),c(grep("^new_sec_serv_1920",names_vector,value=TRUE)),c(grep("perwt_1920",names_vector,value=TRUE)),c(grep("^H_",names_vector,value=TRUE)),c(grep("^sh_lit",names_vector,value=TRUE)),c(grep("^sh_ind1950_main",names_vector,value=TRUE)),c(grep("^sh_occ1950_main",names_vector,value=TRUE)),c(grep("^statefip_193010",names_vector,value=TRUE)),c(grep("^sh_ind1950_main_2_",names_vector,value=TRUE)),c(grep("^sh_occ1950_main",names_vector,value=TRUE)),c(grep("^statefip_193010",names_vector,value=TRUE)),c(grep("^sh_age_16_49",names_vector,value=TRUE)),c(grep("^sh_labforce_",names_vector,value=TRUE)),c(grep("^sh_m_mig_us_",names_vector,value=TRUE)),"adj.r2","nobs")

# Ordering variables
Order <- list(
            c(grep("^new_sec_all_1920",names_vector,value=TRUE)),
            c(grep("^new_sec_main_1920",names_vector,value=TRUE)),
            c(grep("^new_sec_serv_1920",names_vector,value=TRUE)),
            c(grep("^H_",names_vector,value=TRUE)),
            c(grep("perwt_1920",names_vector,value=TRUE)),
            c(grep("^sh_lit",names_vector,value=TRUE)),
            c(grep("^sh_occ1950_main",names_vector,value=TRUE)),
            c("adj.r2"),c("nobs"),
            c(grep("^sh_ind1950_main",names_vector,value=TRUE)),
            c(grep("^statefip_193010",names_vector,value=TRUE)),
            c(grep("^sh_age_16_49",names_vector,value=TRUE)),
            c(grep("^sh_labforce_",names_vector,value=TRUE)),
            c(grep("^sh_m_mig_us_",names_vector,value=TRUE))
            )

# Exporting results
wrapper_Excel(list(
                f_order_reg(coef.excl_new_sec[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn)[,!c("variable")],
                f_order_reg(coef.excl_new_sec._no_new_sec_all[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn)[,!c("variable")],
                f_order_reg(coef.excl_new_sec.main_serv[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn)[,!c("variable")],
                f_order_reg(coef.excl_new_sec.main_serv_no_new_sec_all[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn)[,!c("variable")],
                f_order_reg(coef_ind1950_main.excl_new_sec[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn)[,!c("variable")],
                f_order_reg(coef_ind1950_main.excl_new_sec._no_new_sec_all[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn)[,!c("variable")],
                f_order_reg(coef_ind1950_main.excl_new_sec.main_serv[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn)[,!c("variable")],
                f_order_reg(coef_ind1950_main.excl_new_sec.main_serv_no_new_sec_all[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn)[,!c("variable")],
                f_order_reg(coef_no_indiv_controls.excl_new_sec[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn)[,!c("variable")],
                f_order_reg(coef_no_indiv_controls.excl_new_sec._no_new_sec_all[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn)[,!c("variable")],
                f_order_reg(coef_no_indiv_controls.excl_new_sec.main_serv[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn)[,!c("variable")],
                f_order_reg(coef_no_indiv_controls.excl_new_sec.main_serv_no_new_sec_all[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn)[,!c("variable")]
),
            list("Base_No_new_sec","Base_No_new_sec_reg_exl_new","Base_No_new_sec_m_s","Base_No_new_sec_main_s_e_new","Indmain_No_new_sec","Indmain_No_new_sec_reg_exl_new","Indmain_No_new_sec_main_serv","Indmain_No_new_sec_m_s_excl_new","No_cs_No_new_sec","No_cs_No_new_sec_reg_exl_new","No_cs_No_new_sec_m_s","No_cs_No_new_sec_m_s_excl_new"),
            here(paste0("output/Tables/two_stage_regional_reg_1930_ctynhg_1910.xlsx")))

```

*** NOTE:
All of the result of the regressions show a positive and significant effect for the share of workers in new sectors. Even though the coefficient falls when we include occupational shares variables, it remains significant. This is contrary to what we observe in other regressions (both in the regional and the individual level one the coefficient falls and becomes insignificant when we include occupation shares.)
Looking at some of the other regional variables, we observe that the sign of the share of literate is negative and significant, which differs from the positive and significant effect when we perform the regional level regressions (Part 6.), but is similar to what we observe in the case of the individual level regressions without the first stage (Part 5.). One possible explanation for this is that once we account for the fact that a worker is or not literate, the share of literate workers in the region in 1920 doesn't matter.
Looking at the HHI_index we observe that the coefficient changes signs when we include different covariates. In the regional level regressions we observe the same behavior, while in the individual level regressions the sign is always negative but sometimes significant and others not.
The coefficient for the population variable is consistently positive as it has been in other regressions.




# Part 8. Correlations between different regional variables
Loading packages and erasing the workspace (make sure to have loaded f_load_pk)
```{r}
rm(list=setdiff(ls(all.names = TRUE), "f_load_pk"))
f_load_pk()
```

## 0. Functions used in this section
## 0.1. Functions to export tables to Excel
```{r}
wrapper_Excel <- function(list_table,list_name,output) {
  t <- createWorkbook()
  for (i in 1:length(list_table)) {
    addWorksheet(t, list_name[[i]])
    writeData(t, list_name[[i]],list_table[[i]])
  }
  saveWorkbook(t, output,overwrite=TRUE)
}
```

### 0.1. Functions related to regressions
#### Function to export results
```{r}
f_reg_results <- function(Regresults,arg_round=4) {
  # NOTES:
  # Regresults: data.table with 5 columns. (1) Name of variables, (2) Regression coefficient, (3) Standard value, (4) T-Value, (5) P_value
  # Arg_round: number of significance digits. 4 bu default
  
  #sig_10 <- qt(p=.1/2,df=arg_df,lower.tail=FALSE)
  #sig_5  <- qt(p=.05/2,df=arg_df,lower.tail=FALSE)
  #sig_1  <- qt(p=.01/2,df=arg_df,lower.tail=FALSE)
  X <- copy(Regresults)
  setnames(X,c(2,3,4,5),c("coef","std","t_value","p_value"))
  X[,coef_star:=ifelse(p_value>0.1,format(round(coef,arg_round),nsmall=2),ifelse(p_value>0.05,paste0(format(round(coef,arg_round),nsmall=2),"*"),ifelse(p_value>0.01,paste0(format(round(coef,arg_round),nsmall=2),"**"),paste0(format(round(coef,arg_round),nsmall=2),"***"))))]
  #coef.J[,coef_star:=ifelse(x==1,paste0(format(round(coef,arg_round),nsmall=2),"***"),ifelse(x==5,paste0(format(round(coef,arg_round),nsmall=2),"**"),ifelse(x==10,paste0(format(round(coef,arg_round),nsmall=2),"*"),format(round(coef,arg_round),nsmall=2))))]
  X[,std_par:=paste0("(",format(round(std,arg_round),nsmall=2),")")]
  return(X)
}
```

#### Function to perform a set of regressions
This function works with methods lm and lm_robust
TO-DO
- Allow the possibility of not specifying weights
- For lm_robust need to specify the possibility of not using clusters
```{r}
f_regressions <- function(arg_formula,arg_data,arg_weights,method,arg_clusters,to_iter = 1000, by_iter = 10) {
  # Arguments:
  #           - arg_formula: list with the set of regressions formulas
  #           - arg_data: dataset with the variables in arg_formula
  #           - arg_weights: variable contianing the weights used in the regression
  #           - method: either "lm" or "lm_robust"
  #           - arg_clusters: Variable used to cluster standard errors
  #           - iter_vec: vector containing the numbers of the iteration that you want to be displayed
  
  # Note1: There is a conflict if arg_formula is not a list. E.g. if you create a list (LS) but in arg_formula you introduce LS[[i]], the function will try to subset it and that will give an error. If that is the case introduce it as a list, e.g. list(LS[[i]])
  
  # Note2: Instead of copying arg_data I decided to change the names back to their original names at the end of the function.
  iter_vec <- seq(from =0, to = to_iter, by = by_iter)
  i <- 1
  ## IF argument ARG_WEIGHTS is specified
  if (!missing(arg_weights)) {
    setnames(arg_data,c(deparse(substitute(arg_weights))),c("arg_w"))
    if (i %in% iter_vec) {
      tic(paste0("Iteration ",i," to ",min(i+by_iter-1,length(arg_formula))))
      i0 <- i + by_iter -1
    }
    if (method=="lm") {
      A <- summary(lm(arg_formula[[1]],data=arg_data,weights=arg_w,model=FALSE))
      other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(length(A$residuals),format(round(A$adj.r.squared,4),nsmall=2)),unname(A$fstatistic)))
    } else if (method=="lm_robust") {
      setnames(arg_data,c(deparse(substitute(arg_clusters))),c("arg_cl"))
      A <- summary(lm_robust(arg_formula[[1]],weights=arg_w,clusters=arg_cl,se_type='stata',data=arg_data))
      other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(A$nobs,format(round(A$adj.r.squared,4),nsmall=2)),unname(A$fstatistic)))
    }
    coef <- f_reg_results( data.table(A$coefficients[,1:4],keep.rownames=TRUE), arg_round=4 )
    coef <- melt(coef,id.vars = c("rn"), measure.vars = c("coef","std","t_value","p_value","coef_star","std_par"),value.name=c(paste0("model_",1)))
    coef <- rbind(coef,other)
    if (i == i0) toc()
    rm(A,other)
    
    if (length(arg_formula)>1) {
      for (i in 2:length(arg_formula)) {
        if (i %in% iter_vec) {
          tic(paste0("Iteration ",i," to ",min(i+by_iter-1,length(arg_formula))))
          i0 <- i+by_iter -1
        }
        if (method=="lm") {
          A <- summary(lm(arg_formula[[i]],data=arg_data,weights=arg_w,model=FALSE))
          other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(length(A$residuals),format(round(A$adj.r.squared,4),nsmall=2)),unname(A$fstatistic)))
          setnames(other,c(3),c(paste0("model_",i)))
        } else if (method=="lm_robust") {
          A <- summary(lm_robust(arg_formula[[i]],weights=arg_w,clusters=arg_cl,se_type='stata',data=arg_data))
          other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(A$nobs,format(round(A$adj.r.squared,4),nsmall=2)),unname(A$fstatistic)))
          setnames(other,c(3),c(paste0("model_",i)))
        }
        
        t <- f_reg_results( data.table(A$coefficients[,1:4],keep.rownames=TRUE), arg_round=4)
        t <- melt(t,id.vars = c("rn"), measure.vars = c("coef","std","t_value","p_value","coef_star","std_par"),value.name=c(paste0("model_",i)))
        t <- rbind(t,other)
        coef <- merge(coef,t,by=c("rn","variable"),all=TRUE)
        rm(A,other,t)
        if (i0==i) toc()
      }
    
    }
    
    
  ## NOOO argument ARG_WEIGHTS 
  } else {
    if (i %in% iter_vec) {
      tic(paste0("Iteration ",i," to ",min(i+by_iter-1,length(arg_formula))))
      i0 <- i + by_iter -1
    }
    if (method=="lm") {
      A <- summary(lm(arg_formula[[1]],data=arg_data,model=FALSE))
      other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(length(A$residuals),format(round(A$adj.r.squared,4),nsmall=2)),unname(A$fstatistic)))
    } else if (method=="lm_robust") {
      setnames(arg_data,c(deparse(substitute(arg_clusters))),c("arg_cl"))
      A <- summary(lm_robust(arg_formula[[1]],clusters=arg_cl,se_type='stata',data=arg_data))
      other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(A$nobs,format(round(A$adj.r.squared,4),nsmall=2)),unname(A$fstatistic)))
    }
    coef <- f_reg_results( data.table(A$coefficients[,1:4],keep.rownames=TRUE), arg_round=4 )
    coef <- melt(coef,id.vars = c("rn"), measure.vars = c("coef","std","t_value","p_value","coef_star","std_par"),value.name=c(paste0("model_",1)))
    coef <- rbind(coef,other)
    if (i == i0) toc()
    rm(A,other)
    
    if (length(arg_formula)>1) {
      for (i in 2:length(arg_formula)) {
        if (i %in% iter_vec) {
          tic(paste0("Iteration ",i," to ",min(i+by_iter-1,length(arg_formula))))
          i0 <- i + by_iter -1
        }
        if (method=="lm") {
          A <- summary(lm(arg_formula[[i]],data=arg_data,model=FALSE))
          other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(length(A$residuals),format(round(A$adj.r.squared,4),nsmall=2)),unname(A$fstatistic)))
          setnames(other,c(3),c(paste0("model_",i)))
        } else if (method=="lm_robust") {
          A <- summary(lm_robust(arg_formula[[i]],clusters=arg_cl,se_type='stata',data=arg_data))
          other <- data.table(rn=c("nobs","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",5),model_1=c(c(A$nobs,format(round(A$adj.r.squared,4),nsmall=2)),unname(A$fstatistic)))
          setnames(other,c(3),c(paste0("model_",i)))
        }
        
        t <- f_reg_results( data.table(A$coefficients[,1:4],keep.rownames=TRUE), arg_round=4)
        t <- melt(t,id.vars = c("rn"), measure.vars = c("coef","std","t_value","p_value","coef_star","std_par"),value.name=c(paste0("model_",i)))
        t <- rbind(t,other)
        coef <- merge(coef,t,by=c("rn","variable"),all=TRUE)
        rm(A,other,t)
        if (i == i0) toc()
      }
    
    }
    
    
  }
  
  coef <- as.data.table(coef)
  coef[,order:=ifelse(variable=="zother",1,0)]
  setorder(coef,order,rn)
  coef[,order:=NULL]
  
  if (!missing(arg_weights)) { setnames(arg_data, c("arg_w"), c(deparse(substitute(arg_weights))) )   }
  
  if (method=="lm_robust") {
    setnames(arg_data,c("arg_cl"),c(deparse(substitute(arg_clusters))))
  }
  if (i==length(arg_formula)) toc()
  return(coef)
}

```


## 1. Correlations at the countynhg_1910 level
### 1.1. Construct regional level database
```{r}
# 1930
correlations_data_1880_to_1930_countynhg_1910 <-read_fst(here(paste0("output/Rdata/census_sample_1930_agg_countynhg_1910.fst")),as.data.table=TRUE)
correlations_data_1880_to_1930_countynhg_1910 <- correlations_data_1880_to_1930_countynhg_1910[,`:=`(new_sec_all=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466 +sh_new_sector_ind1950_556+sh_new_sector_ind1950_606+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816 + sh_new_sector_ind1950_856,
                              new_sec_main=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466+ sh_new_sector_ind1950_856,
                              new_sec_serv=sh_new_sector_ind1950_556+sh_new_sector_ind1950_606+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816)]
cols <- names(correlations_data_1880_to_1930_countynhg_1910[,!c("countynhg_1910")])
setnames(correlations_data_1880_to_1930_countynhg_1910,cols,paste0(cols,"_1930"))

# 1920
temp <- read_fst(here(paste0("output/Rdata/census_sample_1920_agg_countynhg_1910.fst")),as.data.table=TRUE)
temp <- temp[,`:=`(new_sec_all=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466 +sh_new_sector_ind1950_556+sh_new_sector_ind1950_606+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816,
                              new_sec_main=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466,
                              new_sec_serv=sh_new_sector_ind1950_556+sh_new_sector_ind1950_606+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816)]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_1920"))

correlations_data_1880_to_1930_countynhg_1910 <- merge(correlations_data_1880_to_1930_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)

#1910
temp <- read_fst(here(paste0("output/Rdata/census_sample_1910_agg_countynhg_1910.fst")),as.data.table=TRUE)
temp <- temp[,`:=`(new_sec_all=sh_new_sector_ind1950_376+sh_new_sector_ind1950_466 +sh_new_sector_ind1950_556+sh_new_sector_ind1950_606+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816,
                              new_sec_main=sh_new_sector_ind1950_376+sh_new_sector_ind1950_466,
                              new_sec_serv=sh_new_sector_ind1950_556+sh_new_sector_ind1950_606+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816)]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_1910"))

correlations_data_1880_to_1930_countynhg_1910 <- merge(correlations_data_1880_to_1930_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)

#1900
temp <- read_fst(here(paste0("output/Rdata/census_sample_1900_agg_countynhg_1910.fst")),as.data.table=TRUE)
temp <- temp[,`:=`(new_sec_all=sh_new_sector_ind1950_376+sh_new_sector_ind1950_466 +sh_new_sector_ind1950_556+sh_new_sector_ind1950_606+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668,
                              new_sec_main=sh_new_sector_ind1950_376+sh_new_sector_ind1950_466,
                              new_sec_serv=sh_new_sector_ind1950_556+sh_new_sector_ind1950_606+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668)]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_1900"))

correlations_data_1880_to_1930_countynhg_1910 <- merge(correlations_data_1880_to_1930_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)

#1880
temp <- read_fst(here(paste0("output/Rdata/census_sample_1880_agg_countynhg_1910.fst")),as.data.table=TRUE)
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_1880"))

correlations_data_1880_to_1930_countynhg_1910 <- merge(correlations_data_1880_to_1930_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)

```


### 1.2. Share of new sectors
- Between 1920 and 1930, 1910 and 1920, 1910 and 1930
- All new sectors, Main new sectors, service sectors, each individual sector
- Simple regressions

output:
- Correlation graphs (gather in one graph the three first: All new sectors, Main new sectors, service sectors. Don't plug correlations where in both years the share is 0)
- Regressions
#### 1.2.1. Correlations 
```{r}
# 1920 - 1930
x <- paste0(c("new_sec_all","new_sec_main","new_sec_serv"),"_1920")
y <- paste0(c("new_sec_all","new_sec_main","new_sec_serv"),"_1930")
lab_x <- paste0(c("Share of New Sector - All","Share of New Sector - Main","Share of New Sector - Service")," (1920)")
lab_y <- paste0(c("Share of New Sector - All","Share of New Sector - Main","Share of New Sector - Service")," (1930)")

p <- vector(mode = "list", length = length(x))
for (i in 1:length(p)) {
  p[[i]] <- ggplot(correlations_data_1880_to_1930_countynhg_1910, aes_string(y= y[i], x= x[i])) + geom_point(size=0.2) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="",x= lab_x[i], y = lab_y[i]) + geom_abline(intercept = 0, slope = 1,color="red") + theme_tufte() + theme(axis.line=element_line(color="black"), legend.position = "top")
}

ggarrange(p[[1]],p[[2]],p[[3]],labels=c("All New Sectors","Main New Sectors","Service New Sectors"),
          ncol=2,nrow=2)
ggsave(here(paste0("output/Graphs/countynhg_1910/corr_sh_new_sectors_1920_x_1930.jpeg")),plot=last_plot())

# 1910 - 1920
x <- paste0(c("new_sec_all","new_sec_main","new_sec_serv"),"_1910")
y <- paste0(c("new_sec_all","new_sec_main","new_sec_serv"),"_1920")
lab_x <- paste0(c("Share of New Sector - All","Share of New Sector - Main","Share of New Sector - Service")," (1910)")
lab_y <- paste0(c("Share of New Sector - All","Share of New Sector - Main","Share of New Sector - Service")," (1920)")

p <- vector(mode = "list", length = length(x))
for (i in 1:length(p)) {
  p[[i]] <- ggplot(correlations_data_1880_to_1930_countynhg_1910, aes_string(y= y[i], x= x[i])) + geom_point(size=0.2) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="",x= lab_x[i], y = lab_y[i]) + geom_abline(intercept = 0, slope = 1,color="red") + theme_tufte() + theme(axis.line=element_line(color="black"), legend.position = "top")
}

ggarrange(p[[1]],p[[2]],p[[3]],labels=c("All New Sectors","Main New Sectors","Service New Sectors"),
          ncol=2,nrow=2)
ggsave(here(paste0("output/Graphs/countynhg_1910/corr_sh_new_sectors_1910_x_1920.jpeg")),plot=last_plot())

# 1910 - 1930
x <- paste0(c("new_sec_all","new_sec_main","new_sec_serv"),"_1910")
y <- paste0(c("new_sec_all","new_sec_main","new_sec_serv"),"_1930")
lab_x <- paste0(c("Share of New Sector - All","Share of New Sector - Main","Share of New Sector - Service")," (1910)")
lab_y <- paste0(c("Share of New Sector - All","Share of New Sector - Main","Share of New Sector - Service")," (1930)")

p <- vector(mode = "list", length = length(x))
for (i in 1:length(p)) {
  p[[i]] <- ggplot(correlations_data_1880_to_1930_countynhg_1910, aes_string(y= y[i], x= x[i])) + geom_point(size=0.2) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="",x= lab_x[i], y = lab_y[i]) + geom_abline(intercept = 0, slope = 1,color="red") + theme_tufte() + theme(axis.line=element_line(color="black"), legend.position = "top")
}

ggarrange(p[[1]],p[[2]],p[[3]],labels=c("All New Sectors","Main New Sectors","Service New Sectors"),
          ncol=2,nrow=2)
ggsave(here(paste0("output/Graphs/countynhg_1910/corr_sh_new_sectors_1910_x_1930.jpeg")),plot=last_plot())

```
#### 1.2.2 Regressions
```{r}
a <- vector(mode = "list")

a[[1]] <- as.formula("new_sec_all_1930 ~ new_sec_all_1920")
a[[2]] <- as.formula("new_sec_main_1930 ~ new_sec_main_1920")
a[[3]] <- as.formula("new_sec_serv_1930 ~ new_sec_serv_1920")
a[[4]] <- as.formula("new_sec_all_1920 ~ new_sec_all_1910")
a[[5]] <- as.formula("new_sec_main_1920 ~ new_sec_main_1910")
a[[6]] <- as.formula("new_sec_serv_1920 ~ new_sec_serv_1910")
a[[7]] <- as.formula("new_sec_all_1930 ~ new_sec_all_1910")
a[[8]] <- as.formula("new_sec_main_1930 ~ new_sec_main_1910")
a[[9]] <- as.formula("new_sec_serv_1930 ~ new_sec_serv_1910")
j<-10
for (i in c(376,377,466,556,606,667,668,816)) {
  a[[j]] <- as.formula(paste0("sh_new_sector_ind1950_",i,"_1930 ~ sh_new_sector_ind1950_",i,"_1920"))
  j <- j + 1
  if (i != 377) {
    a[[j]] <- as.formula(paste0("sh_new_sector_ind1950_",i,"_1930 ~ sh_new_sector_ind1950_",i,"_1910"))
    a[[j+1]] <- as.formula(paste0("sh_new_sector_ind1950_",i,"_1920 ~ sh_new_sector_ind1950_",i,"_1910"))
    j <- j+2
  }
}

for (i in 1:length(a)) {
  T <- summary(lm(a[[i]],data=correlations_data_1880_to_1930_countynhg_1910))
  print(a[[i]])
  print(T)
}

coef.all <- f_regressions(arg_formula=a[c(1:3,10,13,14,17,20,23,26,29)],arg_data=correlations_data_1880_to_1930_countynhg_1910,method="lm")[(variable=="coef_star" | variable =="std_par" | variable=="zother")]


```

### 1.3. Share of main industries
#### 1.3.1. Correlations 
```{r}
for (var_y in c(1930,1920,1910)) {
  for (var_x in c(1880,1900,1910,1920)) {
    if (var_x < var_y) {
      x <- paste0("sh_ind1950_main_",c(1:7),"_",var_x)
      y <- paste0("sh_ind1950_main_",c(1:7),"_",var_y)
      lab_x <- paste0("Share of Main Industry ",c(1:7)," (",var_x,")")
      lab_y <- paste0("Share of Main Industry ",c(1:7)," (",var_y,")")
      
      p <- vector(mode = "list", length = length(x))
      for (i in 1:length(p)) {
        p[[i]] <- ggplot(correlations_data_1880_to_1930_countynhg_1910, aes_string(y= y[i], x= x[i])) + geom_point(size=0.2) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="",x= lab_x[i], y = lab_y[i]) + geom_abline(intercept = 0, slope = 1,color="red") + theme_tufte() + theme(axis.line=element_line(color="black"), legend.position = "top")
      }
      
      ggarrange(p[[1]],p[[2]],p[[3]],p[[4]],labels=c("Agriculture","Mining and Construction","Manufacturing","Trans., Comm., other Util."),
                ncol=2,nrow=2)
      ggsave(paste0(here(paste0("output/Graphs/countynhg_1910/corr_sh_main_ind1950_",var_x,"_x_",var_y,"_1.jpeg"))),plot=last_plot())
      ggarrange(p[[5]],p[[6]],p[[7]],labels=c("Trade","Services","Public Administration"),
                ncol=2,nrow=2)
      ggsave(paste0(here(paste0("output/Graphs/countynhg_1910/corr_sh_main_ind1950_",var_x,"_x_",var_y,"_2.jpeg"))),plot=last_plot())
    }
  }
}
```

### 1.3. Share of main occupations
#### 1.3.1. Correlations 
```{r}
for (var_y in c(1930,1920,1910)) {
  for (var_x in c(1880,1900,1910,1920)) {
    if (var_x < var_y) {
      x <- paste0("sh_occ1950_main_",c(0,100,200,300,400,500,600,700,730,800,900),"_",var_x)
      y <- paste0("sh_occ1950_main_",c(0,100,200,300,400,500,600,700,730,800,900),"_",var_y)
      lab_x <- paste0("Share of Main Occupation ",c(0,100,200,300,400,500,600,700,730,800,900)," (",var_x,")")
      lab_y <- paste0("Share of Main Occupation ",c(0,100,200,300,400,500,600,700,730,800,900)," (",var_y,")")
      
      p <- vector(mode = "list", length = length(x))
      for (i in 1:length(p)) {
        p[[i]] <- ggplot(correlations_data_1880_to_1930_countynhg_1910, aes_string(y= y[i], x= x[i])) + geom_point(size=0.2) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="",x= lab_x[i], y = lab_y[i]) + geom_abline(intercept = 0, slope = 1,color="red") + theme_tufte() + theme(axis.line=element_line(color="black"), legend.position = "top")
      }
      
      ggarrange(p[[1]],p[[2]],p[[3]],p[[4]],labels=c("Professional, Technical","Farmers","Managers, Officials, and Proprietors","Clerical and Kindred"),ncol=2,nrow=2)
      ggsave(paste0(here(paste0("output/Graphs/countynhg_1910/corr_sh_main_occ1950_",var_x,"_x_",var_y,"_1.jpeg"))),plot=last_plot())
      ggarrange(p[[5]],p[[6]],p[[7]],p[[8]],labels=c("Sales workers","Craftsmen","Operatives","Service Workers (private household)"),
                ncol=2,nrow=2)
      ggsave(paste0(here(paste0("output/Graphs/countynhg_1910/corr_sh_main_occ1950_",var_x,"_x_",var_y,"_2.jpeg"))),plot=last_plot())
      ggarrange(p[[9]],p[[10]],p[[11]],labels=c("Service Workers (not household)","Farm laborers","Laborers"),
                ncol=2,nrow=2)
      ggsave(paste0(here(paste0("output/Graphs/countynhg_1910/corr_sh_main_occ1950_",var_x,"_x_",var_y,"_3.jpeg"))),plot=last_plot())
    }
  }
}
```





































































































# Appendix

## Initial code chunks that were changed (I keep the original in case there are mistakes. Usually the original is a longer code, but that appears to be more robust)


## Industries and new titles
This function admits only two values for argument ind, and works by having different cases
```{r}
# Function to construct the data.table with information at the industry level
f_ind_new_titles <- function(x,flag,id_N,ind="ind",names=NULL) {
  y <- copy(x)
  # Selecting the new_titles variable
  if (flag==1)        {y[,c("sh_new_reordered","sh_new_stemmed"):=NULL]}
  else if (flag==2)    
  {
    y[,c("sh_new","sh_new_stemmed"):=NULL]
    setnames(y, "sh_new_reordered", "sh_new")
  }
  else if (flag==3)    
  {
    y[,c("sh_new","sh_new_reordered"):=NULL]
    setnames(y, "sh_new_stemmed", "sh_new")
  }
  
  # Computing the different things
  if (ind=="ind") {
      y <- y[,`:=`(sh_new=perwt*sh_new)][,lapply(.SD,sum),by=c("ind","occind"),.SDcols=c("perwt","sh_new")][,c("sum_new","emp"):=lapply(.SD,sum),by="ind",.SDcols=c("sh_new","perwt")][,`:=`(sh_occ=perwt/emp,sh_new_occ=sh_new/sum_new)]
    setorder(y,ind,-sh_new_occ)
    y <- y[,id:=1:.N,by="ind"][id<=id_N][,sh_new:=sh_new/emp][,sh_new:=sum_new/emp][,c("perwt","sum_new"):=NULL]
    y <- data.table::dcast(y, ind + sh_new + emp  ~ id, value.var = c("occind","sh_new_occ","sh_occ") )
    if (!is.null(names)) {
      y <- merge(y,names,by="ind",all.x=TRUE,all.y=FALSE)
      if(!is.null(names$ind_name)) {
        idcols <- c("ind","ind_name"); cols <- c(idcols, names(y)[-which(names(y) %in% idcols)])  
        setcolorder(y, cols)
        }
    }  
    setorder(y,-sh_new,ind)
    
    
  } else if (ind=="ind1950"){
    y <- y[,`:=`(sh_new=perwt*sh_new)][,lapply(.SD,sum),by=c("ind1950","occind"),.SDcols=c("perwt","sh_new")][,c("sum_new","emp"):=lapply(.SD,sum),by="ind1950",.SDcols=c("sh_new","perwt")][,`:=`(sh_occ=perwt/emp,sh_new_occ=sh_new/sum_new)]
    setorder(y,ind1950,-sh_new_occ)
    y <- y[,id:=1:.N,by="ind1950"][id<=id_N][,sh_new:=sh_new/emp][,sh_new:=sum_new/emp][,c("perwt","sum_new"):=NULL]
    y <- data.table::dcast(y, ind1950 + sh_new + emp  ~ id, value.var = c("occind","sh_new_occ","sh_occ") )
    if (!is.null(names)) {
      y <- merge(y,names,by="ind1950",all.x=TRUE,all.y=FALSE)
      if(!is.null(names$ind1950_name)) {
        idcols <- c("ind1950","ind1950_name"); cols <- c(idcols, names(y)[-which(names(y) %in% idcols)])  
        setcolorder(y, cols)
        }
      } 
    setorder(y,-sh_new,ind1950)
  }
}

census_sample_1930.countynhg.ind <- f_ind_new_titles(census_sample_1930.countynhg[!(occ %in% c(998,999)) & (ind1950 >=1 & ind1950<=990)],1,5,ind="ind1950",names=ind1950.codes[,c("ind1950","ind1950_name")])

```

## function to compute shares of varx against var y
```{r}
f_varx_x_vary <- function(X,id_N,varx,vary,weight_v,names=NULL,varx_n,varx_name_n) {
  y <- copy(X)
  setnames(y, c(deparse(substitute(varx)),deparse(substitute(vary))), c("v_x","v_y"))
  if (missing(weight_v)) y <- y[,v_w:=1]
  else setnames(y, c(deparse(substitute(weight_v))), c("v_w"))
  
  # Computing the different things
  
      y <- y[,lapply(.SD,sum),by=c("v_x","v_y"),.SDcols=c("v_w")][,c("sum_varx"):=lapply(.SD,sum),by="v_x",.SDcols=c("v_w")][,`:=`(sh_vary=v_w/sum_varx)]
  
  setorderv(y,   c("v_x" ,"sh_vary"),c(1,-1) )
  y <- y[,id:=1:.N,by="v_x"][id<=id_N]
   
  setnames(y, c("v_y","sh_vary"), c(deparse(substitute(vary)),paste0("sh_",deparse(substitute(vary))) ) )  
  y <- data.table::dcast(y, v_x + sum_varx  ~ id, value.var = c(paste0( "sh_",deparse(substitute(vary))),deparse(substitute(vary))))
    
  
  if (!is.null(names)) {
    # It seems that the names argument doesn't get changed by reference, so we don't need    "names <- copy(names)"
    setnames(names, c( deparse(substitute(varx_n))  ), c("v_x")  )

    y <- merge(y,names,by="v_x",all.x=TRUE,all.y=FALSE)
    
    idcols <- c("v_x", deparse(substitute(varx_name_n)) ); cols <- c(idcols, names(y)[-which(names(y) %in% idcols)])  
    setcolorder(y, cols)
  }
  setorderv(y,c("v_x"),  c(1))
  setnames(y, c("v_x","sum_varx"),
           c(deparse(substitute(varx)),
             c(paste0("total_",deparse(substitute(varx))))  
             )
           ) 
  
}
a <- f_varx_x_vary(census_sample_1930.countynhg,10,varx=occind.x,vary=occ1950,weight_v=perwt,names=occ1930.codes[,c("occind","occind1930_name")],varx_n = occind,varx_name_n = occind1930_name)
b <- f_varx_x_vary(census_sample_1930.countynhg,10,varx=occ1950,vary=occind.x,weight_v=perwt,names=occ1950.codes[,c("occ1950","occ1950_name")],varx_n = occ1950,varx_name_n = occ1950_name)
c <- f_varx_x_vary(census_sample_1930.countynhg,10,varx=ind,vary=ind1950,weight_v=perwt,names=ind1930.codes[,c("ind","ind_name")],varx_n = ind,varx_name_n = ind_name)
d <- f_varx_x_vary(census_sample_1930.countynhg,10,varx=ind1950,vary=ind,weight_v=perwt,names=ind1950.codes[,c("ind1950","ind1950_name")],varx_n = ind1950,varx_name_n = ind1950_name)

```



## Using textreg to export regression results
```{r}
if (FALSE) {
model <- vector(mode = "list", length = 6)
j <- 1
for (i in c(1,3,10,12,19,21) ) {
  tic()
  model[[j]] <- lm_robust(a[[i]],weights=perwt_ID,clusters=occind,se_type='stata',data=census_sample_1930_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1930 > 10000 & !(ind1950 %in% c(376,377,606,668,816,856))])
  j <- j+1
  toc()
}

texreg(model[1:2],stars = c(0.01, 0.05, 0.1),custom.coef.map=list("new_sec_main_1920" = "New Sector","new_sec_main_1920"="Main New Sector","new_sec_serv_1920"="Service related New Sector","H_1920"="H-H Index","log(perwt_1920)"="Population (logs)","sh_lit_1920"="Share of Literate"))
}
```



```{r}
Y %>%
  kbl(caption = "Comparing regressions (with and without industry fixed effects)") %>%
  kable_classic(full_width = F, html_font = "Cambria")

x_min <- -0.05 +min(
             min(g_no_new_sec_occ[[1]][[1]]$new_work),
             min(g_no_new_sec_occ[[2]][[1]]$new_work)
           )
x_max <- max(
             max(g_no_new_sec_occ[[1]][[1]]$new_work),
             max(g_no_new_sec_occ[[2]][[1]]$new_work)
           )

### Graph
ggarrange(
  g_no_new_sec_occ[[1]] + 
  scale_x_continuous(limits=c(x_min, x_max)) +
  theme(legend.position = "none",axis.title.x=element_blank(),axis.text.x=element_blank()) ,     # Last two elements delete text and title
  
  g_no_new_sec_occ[[2]] + 
  scale_x_continuous(limits=c(x_min, x_max)),
  
  ncol = 1, nrow = 2,
  labels=c("No New Sec workers (occupations) - Method 1 Dt 2","No New Sec (occupations) - Method 1 Dt3"),
  align = "v"
    )

g_all_people[[i]] <- 
      ggplot(copy(census_sample_1940_main[,c("new_work")]), aes(x=new_work)) +
      geom_histogram(color="black",bins=40,  aes(y = stat(width*density)),  fill="white") +
      geom_vline(data=census_sample_1940_main[,.(new_work=mean(new_work))],aes(xintercept=new_work),
                 linetype="dashed") + 
      scale_y_continuous(labels = percent_format()) +
      labs(title="",x="", y = "Share of people")  + 
      theme_tufte()

```

