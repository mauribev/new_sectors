---
title: "Processing cleaned list of occupational titles, 1930-1940"
output: html_document
---
# Delete Workspace and load packages
## Function to load necessary packages
```{r}
f_load_pk <- function() {
  
  # Pacman: packages manager. It does different things, here I use it to load multiple packages at the same time
  library (pacman)
  p_load(readxl,foreign,readstata13,data.table,plyr,dplyr,stringr,openxlsx,stringdist,reshape2,qdap,fst,ipumsr,tm,textreg,tmap,tmaptools,sf,leaflet,ipumsr)
  p_load(tictoc)
  
  # Statistical packages
  p_load(fastDummies,sandwich,lmtest,estimatr)
  p_load(weights)  # To perform weighted correlations
  
  #graphs
  p_load(ggplot2,maps,ggthemes,sjPlot,sjmisc,sjlabelled,jtools,ggstance,broom.mixed)
  p_load(ggpubr)   # Contains ggarrange, used to plot more than one grpah in the same figure
  p_load(scales)   # Used in histogram to show percent format
}
```

## Using function
```{r}
rm(list=setdiff(ls(all.names = TRUE), "f_load_pk"))
f_load_pk()
```

# Defining main and other directories
```{r}
main_directory <- "/Volumes/GoogleDrive/My Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/"

```


# 0. Some functions used
*** NOTE and TO-DO: All the functions used in this file should be included at the beginning, and even more, I should create a package that includes all of them

## 0.1. Cleaning functions
```{r}
# Cleaning punctuation signs
f_clean_punct <- function(x,flag=1){
  y=gsub("\\."," ",x)
  if (flag==1) y=gsub(","," ",y)
  y=gsub(",$","",y)
  y=gsub("’|`|'|‘|;|\"|”|“","",y) 
  y=gsub("-"," ",y)
  # Use capture and backtracking 
  y=gsub("([a-z0-9])\\(","\\1 \\(",y)
  y=gsub("\\)([a-z0-9])","\\) \\1",y)
  
  y=gsub("\\( ","\\(",y)
  y=gsub(" \\)","\\)",y)
  y=gsub("\\( \\)|\\(\\)","",y)
  y=gsub("\\)\\(","\\) \\(",y)
  y=str_squish(y)
  
  y=gsub(" , ",", ",y)
  y=gsub(", , |, , , ",", ",y)
  y=gsub("\\(, |\\(,","\\(",y)
  y=gsub(", \\)|,\\)","\\)",y)
  y=gsub("\\( *","\\(",y)
  y=gsub(" *\\)","\\)",y)
  y=gsub("\\( *\\)|\\(\\)","",y)
  y=gsub("\\(([vx0-9]) ","\\1 ",y)
  y=str_squish(y)
  y
}

f_change_syms <- function(x){
   # NOTE: For 1940: private and government worker are separated. To be able to compare it with 1930 I assigned them w
  # worker
  ## Parentheses
  y=gsub("\\(oa, pw, or gw\\)|\\( *[0o]a p* w *or g *w *\\)|\\([0o]a, p* w *or g *w *\\)|\\([0o]a, p* w, *or g *w *\\)|\\( *[0o]a p* w *dr g *w *\\)|\\( *[0o] *a p *w g *w *\\)","\\(o w\\)",x)
  y=gsub("\\( *p *w or *g *w\\)|\\( *g *w or *p *w\\)","\\(w\\)",y)
  y=gsub("\\(oa or pw\\)|\\([0o]a or p *w\\)|\\( *[0o]a *or p *w *\\)|\\( *[0o] *a dr p *w *\\)|\\( *[0o] *a p *w *\\)","\\(o w\\)",y)
  y=gsub("\\( *[0o]a *or g *w *\\)|\\( *[0o] *a dr g *w *\\)|\\( *[0o] *a g *w *\\)","\\(o w\\)",y)
  # Employer or own account
  y=gsub("\\( *e *m or [0o] *a *\\)|\\( *e *m *[0o] *a *\\)","\\(e o\\)",y)
  y=gsub("\\( *e *[0o] *\\)|\\( *e *or *[0o] *\\)|\\( *e *[0o] *\\)","\\(e o\\)",y)
  y=gsub("\\( *e *[0o]a *\\)|\\( *e *or *[0o]a *\\)|\\( *e *[0o]a *\\)","\\(e o\\)",y)
  # Employer
  y=gsub("\\( *e *m *\\)|\\( *e *\\)|\\<€\\>","\\(e\\)",y)
  # Own account
  y=gsub("\\( *[0o] *a *\\)|\\( *o *\\)","\\(o\\)",y)
  #government, private worker
  y=gsub("\\( *p *w\\)","\\(w\\)",y)
  y=gsub("\\( *g *w\\)","\\(w\\)",y)
  # worker
  y=gsub("\\( *working out *\\)|\\( *w *\\)","\\(w\\)",y)
  # owner or worker (no such symbol for 1920)
  y=gsub("\\( *[0o] *or *w *\\)|\\( *[0o] *w *\\)","\\(o w\\)",y)
  # non paid worker
  y=gsub("\\( *n *p *\\)|\\( *n *r *\\)","\\(np\\)",y)
  
 
  ## No parentheses
  # Employer or own account
  y=gsub("\\<e *m or [0o] *a\\>|\\<e *m *[0o] *a\\>","e o",y)
  y=gsub("\\<e *[0o]\\>|\\<e *or *[0o]\\>|\\<e *[0o]\\>","e o",y)
  y=gsub("\\<e *[0o]a\\>|\\<e *or *[0o]a\\>|\\<e *[0o]a\\>","e o",y)
  #Employer
  y=gsub("\\<e *m\\>|\\<e\\>","e",y)
  #own account
  y=gsub("\\<[0o] *a\\>|\\<o\\>","o",y)
  # worker
  y=gsub("\\<working out\\>|\\<w\\>","w",y)
  # owner or worker (no such symbol for 1920)
  y=gsub("\\<[0o] *or *w\\>|\\<[0o] *w\\>|\\<[0o]a *or *w\\>","o w",y)
  # non paid worker
  y=gsub("\\<n *p\\>|\\<n *r\\>","np",y)
  
  # NOTE: For 1940: private and government worker are separated. To be able to compare it with 1930 I assigned them w
  # worker
  y=gsub("\\<[0o]a, p* w, *or g *w\\>|\\<[0o]a p* w *or g *w\\>|\\<[0o]a p* w *dr g *w\\>|\\<[0o] *a p *w g *w\\>","o w",y)
  y=gsub("\\<p *w or *g *w\\>|\\<g *w or *p *w\\>","w",y)
  y=gsub("\\<[0o]a *or p *w\\>|\\<[0o] *a dr p *w\\>|\\<[0o] *a p *w\\>","o w",y)
  y=gsub("\\<[0o]a *or g *w\\>|\\<[0o] *a dr g *w\\>|\\<[0o] *a g *w\\>","o w",y)
  y=gsub("\\<p *w\\>","w",y)
  y=gsub("\\<g *w\\>","w",y)
  
  
  y=gsub("\\<unless\\>","except",y)
  
  y=str_squish(y)
  y=gsub(" , ",", ",y)
  y=gsub(", , |, , , ",", ",y)
  y=gsub("\\(, |\\(,","\\(",y)
  y=gsub(", \\)|,\\)","\\)",y)
  y=gsub("\\( *","\\(",y)
   y=gsub(" *\\)","\\)",y)
   y=gsub("\\( *\\)|\\(\\)","",y)
   y=str_squish(y)
  y
}

f_change_words <- function(x){
   y=gsub("\\( *e *t *c *\\)|\\( *e *t *e *\\)","\\(etc\\)",x)
   y=gsub("\\( *n *e *c *\\)|\\( *n *s *c *\\)|\\( *n *c *c *\\)","\\(nec\\)",y)
   y=gsub("\\( *a *o *s *\\)|\\( *n *o *s *\\)","\\(nos\\)",y)
   y=gsub("\\( *n *s *\\)|\\( *n *a *\\)|\\( *n *g *\\)|\\( *not specified *\\)|\\( *not .*specified *\\)","\\(ns\\)",y)
   y=gsub("\\(orns\\)","\\(or ns\\)",y)
   y=gsub("\\(not elsewhere classified\\)","\\(nec\\)",y)
   y=gsub("\\( *m *d *\\)","\\(md\\)",y)
   
   y=gsub("\\<e *t *c\\>|\\<e *t *e\\>","etc",y)
   y=gsub("\\<n *e *c\\>|\\<n *s *c\\>|\\<n *c *c\\>","nec",y)
   y=gsub("\\<a *o *s\\>|\\<n *o *s\\>","nos",y)
   y=gsub("\\<n *s\\>|\\<n *a\\>|\\<n *g\\>|\\<not specified\\>","ns",y)
   y=gsub("\\<orns\\>","or ns",y)
   y=gsub("\\<not elsewhere classified\\>","nec",y)
   y=gsub("\\<m *d\\>","md",y)
   y=gsub("\\<u *s\\>|\\<united states\\>","us",y)
   y=gsub("\\<b *r\\>","or",y)
   y=str_squish(y)
   y=gsub(" , ",", ",y)
   y=gsub(", , |, , , ",", ",y)
   y=gsub("\\(, |\\(,","\\(",y)
   y=gsub(", \\)|,\\)","\\)",y)
   y=gsub("\\( *","\\(",y)
   y=gsub(" *\\)","\\)",y)
   y=gsub("\\( *\\)|\\(\\)","",y)
   y=str_squish(y)
   y
}

f_clean_syms <- function(x){
  ## Parentheses
  # Employer or own account
  y=gsub("\\( *e *m or [0o] *a *\\)|\\( *e *m *[0o] *a *\\)|\\(e o\\)","",x)
  y=gsub("\\( *e *[0o] *\\)|\\( *e *or *[0o] *\\)|\\( *e *[0o] *\\)|\\(e o\\)","",y)
  y=gsub("\\( *e *[0o]a *\\)|\\( *e *or *[0o]a *\\)|\\( *e *[0o]a *\\)|\\(e o\\)","",y)
  # Employer
  y=gsub("\\( *e *m *\\)|\\( *e *\\)|\\(e\\)","",y)
  # Own account
  y=gsub("\\( *[0o] *a *\\)|\\( *o *\\)|\\(o\\)","",y)
  # worker
  y=gsub("\\( *working out *\\)|\\( *w *\\)|\\(w\\)","",y)
  # owner or worker (no such symbol for 1920)
  y=gsub("\\( *[0o] *or *w *\\)|\\( *[0o] *w *\\)|\\(o w\\)","",y)
  
  y=gsub("\\( *n *p *\\)|\\( *n *r *\\)|\\(np\\)","",y)
  
  # NOTE: For 1940: private and government worker are separated. To be able to compare it with 1930 I assigned them w
  # worker
  y=gsub("\\( *[0o]a p* w *or g *w *\\)|\\( *[0o]a p* w *dr g *w *\\)|\\( *[0o] *a p *w g *w *\\)","",y)
  y=gsub("\\( *p *w or *g *w\\)","",y)
  y=gsub("\\( *[0o]a *or p *w *\\)|\\( *[0o] *a dr p *w *\\)|\\( *[0o] *a p *w *\\)","",y)
  y=gsub("\\( *[0o]a *or g *w *\\)|\\( *[0o] *a dr g *w *\\)|\\( *[0o] *a g *w *\\)","",y)
  y=gsub("\\( *p *w\\)","",y)
  y=gsub("\\( *g *w\\)","",y)
  
  
  #Eliminate when (any) appears. We could also eliminate when \\<any\\> appears, but that might affect phrases that contain any
  y=gsub("\\( *any *\\)","",y)
  
  ## No parentheses
  # Employer or own account
  y=gsub("\\<e *m or [0o] *a\\>|\\<e *m *[0o] *a\\>|\\<e o\\>","",x)
  y=gsub("\\<e *[0o]\\>|\\<e *or *[0o]\\>|\\<e *[0o]\\>|\\<e o\\>","",y)
  y=gsub("\\<e *[0o]a\\>|\\<e *or *[0o]a\\>|\\<e *[0o]a\\>|\\<e o\\>","",y)
  #Employer
  y=gsub("\\<e *m\\>|\\<e\\>","",y)
  #own account
  y=gsub("\\<[0o] *a\\>|\\<o\\>","",y)
  # worker
  y=gsub("\\<working out\\>|\\<w\\>","",y)
  # owner or worker (no such symbol for 1920)
  y=gsub("\\<[0o] *or *w\\>|\\<[0o] *w\\>","",y)
  
  y=gsub("\\<n *p\\>|\\<n *r\\>|\\<np\\>","",y)
  y=str_squish(y)
  y=str_squish(gsub("\\( *\\)|\\( *or *\\)","",y))
  y=gsub(" , ",", ",y)
  y=gsub(", , |, , , ",", ",y)
  y=gsub("\\(, |\\(,","\\(",y)
  y=gsub(", \\)|,\\)","\\)",y)
  y=gsub("\\( *","\\(",y)
  y=gsub(" *\\)","\\)",y)
  y=gsub("\\( *\\)|\\(\\)","",y)
  y=str_squish(y)
}


f_clean_words <- function(x){
   y=gsub("\\( *e *t *c *\\)|\\( *e *t *e *\\)|\\(etc\\)","",x)
   y=gsub("\\( *n *e *c *\\)|\\( *n *s *c *\\)|\\( *n *c *c *\\)|\\(n e c\\)|\\(nec\\)","",y)
   y=gsub("\\( *a *o *s *\\)|\\( *n *o *s *\\)|\\(n o s\\)|\\(nos\\)","",y)
   y=gsub("\\( *n *s *\\)|\\( *n *a *\\)|\\(n s\\)|\\(ns\\)","",y)
   y=gsub("\\(not elsewhere classified\\)|\\(n e c\\)|\\(nec\\)","",y)
   y=gsub("\\( *m *d *\\)|\\(m d\\)|\\(md\\)","",y)
   

   y=gsub("\\<e *t *c\\>|\\<e *t *e\\>|\\<etc\\>","",y)
   y=gsub("\\<n *e *c\\>|\\<n *s *c\\>|\\<n *c *c\\>|\\<n e c\\>|\\<nec\\>","",y)
   y=gsub("\\<a *o *s\\>|\\<n *o *s\\>|\\<n o s\\>|\\<nos\\>","",y)
   y=gsub("\\<n *s\\>|\\<n *a\\>|\\<n s\\>|\\<ns\\>","",y)
   y=gsub("\\<not elsewhere classified\\>|\\<n e c\\>|\\<nec\\>","",y)
   y=gsub("\\<m *d\\>","",y)
#  y=gsub("\\<u *s\\>|\\<united states\\>|\\<us\\>","",y)
   y=str_squish(y)
   y=gsub(" , ",", ",y)
   y=gsub(", , |, , , ",", ",y)
   y=gsub("\\(, |\\(,","\\(",y)
   y=gsub(", \\)|,\\)","\\)",y)
   y=gsub("\\( *","\\(",y)
   y=gsub(" *\\)","\\)",y)
   y=gsub("\\( *\\)|\\(\\)","",y)
   y=str_squish(y)
   y
}

f_clean_conj <- function(x){
  # Note: We might/should(?) other conjunctions/pronouns different than "or"
  y=gsub("\\<in\\>|\\<and\\>|\\<of\\>|\\<on\\>|\\<for\\>|\\<to\\>","",x)
  y=gsub(" , ",", ",y)
  y=gsub(", , |, , , ",", ",y)
  y=gsub("\\(, |\\(,","\\(",y)
  y=gsub(", \\)|,\\)","\\)",y)
  y=gsub("\\( *","\\(",y)
  y=gsub(" *\\)","\\)",y)
  y=gsub("\\( *\\)|\\(\\)","",y)
  y=str_squish(y)
  y
}

f_adjust_ind_number_1940 <- function(x){
  y=gsub("\\(([vx][0-9])$","\\(\\1\\)",x)
  y=gsub("\\(([vx][vx])$","\\(\\1\\)",y)
  y=gsub("\\(([0-9][xv])$","\\(\\1\\)",y)
  y=gsub("\\(([0-9]+)$","\\(\\1\\)",y)
  y=gsub("\\(([0-9]+)$","\\(\\1\\)",y)
  y=gsub("^ ([vx][0-9])\\)$","\\(\\1\\)",y)
  y=gsub("^ ([vx][vx])\\)$","\\(\\1\\)",y)
  y=gsub("^ ([0-9][xv])\\)$","\\(\\1\\)",y)
  y=gsub("^([vx][0-9])\\)$","\\(\\1\\)",y)
  y=gsub("^([vx][vx])\\)$","\\(\\1\\)",y)
  y=gsub("^([0-9][xv])\\)$","\\(\\1\\)",y)
  y=gsub("^([vx][0-9])$","\\(\\1\\)",y)
  y=gsub("^([vx][vx])$","\\(\\1\\)",y)
  y=gsub("^([0-9][vx])$","\\(\\1\\)",y)
  y=gsub("^([0-9][0-9])$","\\(\\1\\)",y)
  y=gsub(" ([vx][0-9])$","\\(\\1\\)",y)
  y=gsub(" ([vx][vx])$","\\(\\1\\)",y)
  y=gsub(" ([0-9][vx])$"," \\(\\1\\)",y)
  y=gsub(" ([0-9][0-9])$"," \\(\\1\\)",y)
  y=str_squish(y)
  y
}

```

## 0.2 Paste 3 function
```{r}
paste3 <- function(x1,x2,s=" ") {
  # Problems if we have a separator different than " "
  x1 <- unlist(lapply(x1,function(x) {x[is.na(x)] <- ""; x}))
  x2 <- unlist(lapply(x2,function(x) {x[is.na(x)] <- ""; x}))
  t=str_squish(paste(x1,x2,sep=s))
  return(t)
}
```

## 0.3. Function to deal with comma issue
```{r}
f_comma_issues <- function(x) {
  y = gsub(" , ",", ",x)
  y = gsub("^,","",y)
  y = str_squish(y)
}
```

### 0.4. Function to lower the letters of all variables
```{r}
f_lower <- function(X) {
  cols <- colnames(X)
  y <- X[,(cols) := lapply(.SD,tolower),.SDcols=cols]
  return(y)
}
```

### 0.5 Function to reorder and stem titles
*** NOTE: There are other, more powerful and accurate, functions that can be used to stem words.
*** TO-DO: Use other stemming functions
```{r}
f_reorder_stem <- function(X,var,r=reordered,s=reordered_stemmed,flag_stem=0) {
  # Note: the user can change the name of the reordered and stemmed variable
  temp <- copy(X)
  var_ch <- deparse(substitute(var))
  # Through the code we will simply use varp as the variable
  setnames(temp, c(var_ch),c("var")) 
  r <- deparse(substitute(r))
  s <- deparse(substitute(s))
  
  temp <- temp[,c("var")][,var_r:=sapply(sapply(strsplit(var," "),sort),function(x) paste(x,collapse=' '))]
  
  if (flag_stem==0) {
    # Create corpus to unstem words
    texts <- temp$var
    corpus <- VCorpus(VectorSource(texts))
    stemmed_corpus<-stem.corpus(corpus, verbose=FALSE)
    
    temp$var_s <- data.table(text=unlist(sapply(stemmed_corpus, `[`, "content")), 
        stringsAsFactors=F)
    temp <- temp[,.SD[1],by="var"]
    setnames(temp,c("var","var_r","var_s"),c(var_ch, paste0(deparse(substitute(var)),"_",r)  , paste0(deparse(substitute(var)),"_",s)  ))
  } else if (flag_stem==1) {
    temp <- temp[,.SD[1],by="var"]
    setnames(temp,c("var","var_r"),c(var_ch, paste0(deparse(substitute(var)),"_",r)  ))
  }
  return(temp)
}

f_reorder <- function(X,var,r=reordered) {
  # Note: the user can change the name of the reordered and stemmed variable
  temp <- copy(X)
  var_ch <- deparse(substitute(var))
  # Through the code we will simply use varp as the variable
  setnames(temp, c(var_ch),c("var")) 
  r <- deparse(substitute(r))
  
  temp <- temp[,c("var")][,var_r:=sapply(sapply(strsplit(var," "),sort),function(x) paste(x,collapse=' '))]
  
  temp <- temp[,.SD[1],by="var"]
  setnames(temp,c("var","var_r"),c(var_ch, paste0(deparse(substitute(var)),"_",r)  ))
    
  return(temp)
}


f_stem <- function(X,var,s=reordered_stemmed,flag_plus=0) {
  # Note: the user can change the name of the reordered and stemmed variable
  # flag_plus=1 ---> Drop the plus sign.
  #  NOTE: any plus sign in the stemmed vector will be dropped
  temp <- copy(X)
  var_ch <- deparse(substitute(var))
  # Through the code we will simply use varp as the variable
  setnames(temp, c(var_ch),c("var")) 
  s <- deparse(substitute(s))
  
  temp <- temp[,c("var")][!is.na(var)]
  texts <- temp$var
  corpus <- VCorpus(VectorSource(texts))
  stemmed_corpus<-stem.corpus(corpus, verbose=FALSE)
    
  temp$var_s <- data.table(text=unlist(sapply(stemmed_corpus, `[`, "content")), 
        stringsAsFactors=F)
  temp <- temp[,.SD[1],by="var"]
  if (flag_plus==1) {
    temp <- temp[,var_s:=gsub("\\+","",var_s)]
  }
  
  setnames(temp,c("var","var_s"),c(var_ch, paste0(deparse(substitute(var)),"_",s)  ))
  return(temp)
}

```

## 0.6. Functions to export tables to Excel
```{r}
wrapper_Excel <- function(list_table,list_name,output) {
  t <- createWorkbook()
  for (i in 1:length(list_table)) {
    addWorksheet(t, list_name[[i]])
    writeData(t, list_name[[i]],list_table[[i]])
  }
  saveWorkbook(t, output,overwrite=TRUE)
}
```

# 1. Importing the databases
The following database was constructed from the information in the Alphabetical and Classified index to occupations (1930, 1940). In addition we create an observation ID and organize the database by original_1910, occ1910, indname_1910

```{r}
## 1930
index_1930 <- as.data.table( read_excel(paste0(main_directory,"R - Processing data/input/1930 - Cleaned.xlsx"), sheet = "1930 final",guess_max=10000) )[id_1930!=0][,`:=`(occ1930=tolower(occ1930),ind1930=tolower(ind1930),occind1930=tolower(occind1930))]
#setorderv(index_1930,c("original_1930","occ1930","ind1930","indname_1930_original"))  #order index_1990 by a vector

occ1930.names <- as.data.table( read_excel(paste0(main_directory,"R - Processing data/input/1930 - Cleaned.xlsx"), sheet = "1930 main groups",guess_max=10000) )[,ind1930:=tolower(ind1930)][,occ1930:=tolower(occ1930)][,occind1930:=tolower(occind1930)]

## 1940
index_1940 <- as.data.table( read_excel(paste0(main_directory,"R - Processing data/input/1940 - Cleaned.xlsx"), sheet = "1940 final",guess_max=10000) )[id_1940!=0][,`:=`(occ1940=tolower(as.character(occ1940)),ind1940=tolower(as.character(ind1940)),occind1940=tolower(as.character(occind1940)))]

### Changing the name of one problematic title and dropping some titles related with it
index_1940 <- index_1940[title_1940=="Merchant or dealer or owner or propietor or keeper or manager (n.s.) or superintendent (n.s.) (any wholesale or retail establishment)",title_1940:="merchant dealer plus others (wholesale plus retail)"]
merchant_problem <- as.data.table( read_excel(paste0(main_directory,"R - Processing data/input/1940 - Cleaned.xlsx"), sheet = "merchant_problem") )[,c("occ1940","ind1940","title_1940","indname_1940_original","drop")][,`:=`(occ1940=tolower(as.character(occ1940)),ind1940=tolower(as.character(ind1940)))]
index_1940 <- merge(index_1940,merchant_problem,by=c("occ1940","ind1940","title_1940","indname_1940_original"),all.x=TRUE,all.y=FALSE)[is.na(drop)]


occ1940.names <- as.data.table( read_excel(paste0(main_directory,"R - Processing data/input/1940 - Cleaned.xlsx"), sheet = "occ1940",guess_max=10000) )[,ind1940:=tolower(ind1940)][,occ1940:=tolower(occ1940)][,occind1940:=tolower(occind1940)][,name_occ1940:=f_clean_conj(f_change_words(f_change_syms(f_clean_punct(tolower(name_occ1940),flag=0) )) )]

ind1940.names <- as.data.table( read_excel(paste0(main_directory,"R - Processing data/input/1940 - Cleaned.xlsx"), sheet = "ind1940",guess_max=10000) )[,ind1940:=tolower(ind1940)][,name_ind1940:=f_clean_conj(f_change_words(f_change_syms(f_clean_punct(tolower(name_ind1940),flag=0) )) )][is.na(name_ind1940_subgroup),name_ind1940_subgroup:=name_ind1940_main]


# Table with common typos in words
words_subs1 <- as.data.table( read_excel(paste0(main_directory,"R - Processing data/temp/words_subs.xlsx"), sheet = "Sheet1") )
words_subs2 <- as.data.table( read_excel(paste0(main_directory,"R - Processing data/temp/words_subs.xlsx"), sheet = "Sheet2") )
words_subs3 <- as.data.table( read_excel(paste0(main_directory,"R - Processing data/temp/words_subs.xlsx"), sheet = "Sheet3") )
words_subs4 <- as.data.table( read_excel(paste0(main_directory,"R - Processing data/temp/words_subs.xlsx"), sheet = "Sheet4") )
# Create the vectors that will be used in the substitution
setorderv(words_subs1,c("term","length"),c("1","-1"))
setorderv(words_subs2,c("term","length"),c("1","-1"))
setorderv(words_subs3,c("term","length"),c("1","-1"))
setorderv(words_subs4,c("term","length"),c("1","-1"))
words_subs1$term <- paste0(paste0("\\<",words_subs1$term),"\\>")
words_subs2$term <- paste0(paste0("\\(",words_subs2$term),"\\)")
words_subs3$term <- paste0(paste0("\\<",words_subs3$term),"\\>")
words_subs4$term <- paste0(paste0("\\<",words_subs4$term),"\\>")

```

# 2. Quick Cleaning  
All the changes that we introduce here are minor and don't affect the meaning of the title
- Clean punctuation
- Clean words
- Change words: I provide a list that corrects for typos
- Clean conjunctions (except or, which carries additional information)

## 2.1. Original
### 2.1.1 1940 Extracting indname in parentheses
For 1940 we have title and industry separated. We will construct an original variable by joining them, separated by a comma. Before doing that we will extract the industry number in parentheses that appears in the industry column
```{r}
index_1940[,indname_1940_original:=tolower(indname_1940_original)][,ind1940_par:=""][grepl('\\([0-9][0-9]\\)|\\([xv][0-9]\\)|\\([0-9][xv]\\)|\\([xv][xv]\\)|[0-9][0-9]|[xv][0-9]|[0-9][xv]>|[xv][xv]',indname_1940_original),ind1940_par:=str_extract_all(indname_1940_original,"\\([0-9][0-9]\\)|\\([xv][0-9]\\)|\\([0-9][xv]\\)|\\([xv][xv]\\)|[0-9][0-9]|[xv][0-9]|[0-9][xv]>|[xv][xv]")][,ind1940_par:=gsub("\\(|\\)","",ind1940_par)]

# If industry is 99, the particular title couldn't be classified in any industry. We will keep that specification since a repeater occupation (title with ind1940=Ind) might still be assigned to a group of industries
# index_1940 <- index_1940[ind1940_par==99 | ind1940_par=="99",ind1940_par:=""]

#merge with industry
index_1940 <- merge(index_1940,ind1940.names[,c("ind1940","name_ind1940")][,`:=`(ind1940_par=ind1940,ind1940=NULL)],by="ind1940_par",all.x=TRUE,all.y=FALSE,incomparables=NULL)
setnames(index_1940,c("name_ind1940"),c("indname_1940_par_ind1940"))

# Dropping industry in parentheses
index_1940[,indname_1940_original:=str_squish(gsub("\\([0-9][0-9]\\)|\\([xv][0-9]\\)|\\([0-9][xv]\\)|\\([xv][xv]\\)|[0-9][0-9]|[xv][0-9]|[0-9][xv]|[xv][xv]","",indname_1940_original))]
```

### 2.1.2 Editing/creating the original variable
#### 1930
```{r}
# Note: We don't eliminate commas here (flag=0), as they might be informative. In a later stage we will eliminate them.
index_1930[,original_1930:=tolower(original_1930)][,original_1930:=f_clean_conj(f_change_words(f_change_syms(f_clean_punct(original_1930,flag=0) )))][,original_1930:=str_squish(gsub(", or | or, |, or, | ,or, | or ,|, or ,"," or ",original_1930))]
# Change words that are misspelled
index_1930$original_1930 <- mgsub(words_subs1$term,words_subs1$change,index_1930$original_1930,fixed=FALSE)
```

#### 1940
NOTE: for 1940 we don't have an original variable. In 1940 we don't have problems differentiating the title from the industry. In a later step we will create an original variables by combining the title and the industry, separated by a comma
```{r}
# Creating original variable
index_1940[,original_1940:=ifelse(indname_1940_original=="" | is.na(indname_1940_original),title_1940,str_c(title_1940,indname_1940_original,sep=", "))]

# Note: We don't eliminate commas here (flag=0), as they might be informative. In a later stage we will eliminate them.
index_1940[,original_1940:=tolower(original_1940)][,original_1940:=f_clean_conj(f_change_words(f_change_syms(f_clean_punct(original_1940,flag=0) )))][,original_1940:=str_squish(gsub(", or | or, |, or, | ,or, | or ,|, or ,"," or ",original_1940))]
# Change words that are misspelled
index_1940$original_1940 <- mgsub(words_subs1$term,words_subs1$change,index_1940$original_1940,fixed=FALSE)
```


## 2.2. Title
```{r}
# 1930
# Note: We don't care about commas here (flag=1).
index_1930[,title_1930:=tolower(title_1930)][,title_1930:=f_clean_conj(f_change_words(f_change_syms(f_clean_punct(title_1930,flag=1) )) )]
# Change words that are misspelled
index_1930$title_1930 <- mgsub(words_subs1$term,words_subs1$change,index_1930$title_1930,fixed=FALSE)

# 1940
# Note: We don't care about commas here (flag=1).
index_1940[,title_1940:=tolower(title_1940)][,title_1940:=f_clean_conj(f_change_words(f_change_syms(f_clean_punct(title_1940,flag=1) )) )][,title_1940:=str_squish(gsub(", or | or, |, or, | ,or, | or ,|, or ,"," or ",title_1940))]
# Change words that are misspelled
index_1940$title_1940 <- mgsub(words_subs1$term,words_subs1$change,index_1940$title_1940,fixed=FALSE)
```

## 2.3. indname_original
```{r}
# 1930
# Note: We care about commas here (flag=0).
index_1930[,indname_1930_original:=tolower(indname_1930_original)][,indname_1930_original:=f_clean_conj(f_change_words(f_change_syms(f_clean_punct(indname_1930_original,flag=0) )) )]
# Change words that are misspelled
index_1930$indname_1930_original <- mgsub(words_subs1$term,words_subs1$change,index_1930$indname_1930_original,fixed=FALSE)
# Correct for , before or after or
# Note: we don't eliminate "or" because it will be ussed in a later step
index_1930[,indname_1930_original:=str_squish(gsub(", or | or, |, or, | ,or, | or ,|, or ,"," or ",indname_1930_original))]
# If no industry leave empty
index_1930[,indname_1930_original:=ifelse(indname_1930_original==0,NA,indname_1930_original)]

# 1940
# Note: We care about commas here (flag=0).
index_1940[,indname_1940_original:=tolower(indname_1940_original)][,indname_1940_original:=f_clean_conj(f_change_words(f_change_syms(f_clean_punct(indname_1940_original,flag=0) ))) ]

# Change words that are misspelled
index_1940$indname_1940_original <- mgsub(words_subs1$term,words_subs1$change,index_1940$indname_1940_original,fixed=FALSE)
# Correct for , before or after or
# Note: we don't eliminate "or" because it will be ussed in a later step
index_1940[,indname_1940_original:=str_squish(gsub(", or | or, |, or, | ,or, | or ,|, or ,"," or ",indname_1940_original))]

# If no industry leave empty
index_1940[,indname_1940_original:=ifelse(indname_1940_original==0,NA,indname_1940_original)]
```

## 2.5. Create indexes for the terms np, o, e , o w, w
np: Unpaid family worker
o: working on own account
e: employer
w: worker
ns: (...or ns), in the industry part it has a industry name and the part or ns in parentheses -> If not the title 
```{r} 
# 1930
index_1930 <- index_1930[,w:=1][,c("np","e","o","ns"):=0]
index_1930[grepl('\\<o\\>|\\<e o\\>|\\<o w\\>',indname_1930_original),o:=1][grepl('\\<e\\>|\\<e o\\>',indname_1930_original),e:=1][grepl('\\<np\\>',indname_1930_original),np:=1][grepl('\\<e\\>|\\<o\\>|\\<np\\>|\\<e o\\>',indname_1930_original),w:=0][grepl('\\<o w\\>',indname_1930_original),w:=1][grepl('\\<or ns\\>|\\<ns\\>',indname_1930_original),ns:=1]
index_1930 <- index_1930[,var_for_ns:=tolower(str_squish(gsub("\\(.*?)","",indname_1930_original)))][,var_for_ns:=gsub("\\(|\\)","",var_for_ns)][,var_for_ns:=str_squish(var_for_ns)]

# New variable eliminating some things
# Note: The original variable in 1930 hasn't introduced the following changes. That is why we create a different variable
index_1930[,indname_1930_original:=gsub("\\<or w\\>|\\<or ns\\>|\\<w or ns\\>|\\(any nec\\)","",indname_1930_original)][,indname_1930_original:=f_clean_words(f_clean_syms(indname_1930_original))]

# Adding ns=1 to titles with industry only (ns)
index_1930[ns==1 & var_for_ns!="",ns:=0][,var_for_ns:=NULL]


# 1940
index_1940 <- index_1940[,w:=1][,c("np","e","o","ns"):=0]
index_1940[grepl('\\<o\\>|\\<e o\\>|\\<o w\\>',indname_1940_original),o:=1][grepl('\\<e\\>|\\<e o\\>',indname_1940_original),e:=1][grepl('\\<np\\>',indname_1940_original),np:=1][grepl('\\<e\\>|\\<o\\>|\\<np\\>|\\<e o\\>',indname_1940_original),w:=0][grepl('\\<o w\\>',indname_1940_original),w:=1][grepl('\\<or ns\\>|\\<ns\\>',indname_1940_original),ns:=1]
index_1940 <- index_1940[,var_for_ns:=tolower(str_squish(gsub("\\(.*?)","",indname_1940_original)))][,var_for_ns:=gsub("\\(|\\)","",var_for_ns)][,var_for_ns:=str_squish(var_for_ns)]

# New variable eliminating some things
# Note: The original variable in 1930 hasn't introduced the following changes. That is why we create a different variable
index_1940[,indname_1940_original:=gsub("\\<or w\\>|\\<or ns\\>|\\<w or ns\\>|\\(any nec\\)","",indname_1940_original)][,indname_1940_original:=f_clean_words(f_clean_syms(indname_1940_original))]

# Adding ns=1 to titles with industry only (ns)
index_1940[ns==1 & var_for_ns!="",ns:=0][,var_for_ns:=NULL]

```


## 2.7. Dealing with parentheses

### Creation of indname excluding parentheses
Here we eliminate what is in parentheses, change phrases of the form "a, b or c" to "a or b or c" and finally eliminate commas
1930
```{r}
# 1930
index_1930[,indname_1930:=tolower(str_squish(gsub("\\(.*?)","",indname_1930_original)))][,indname_1930:=gsub("\\(|\\)","",indname_1930)][,indname_1930:=str_squish(indname_1930)]
# Change "aa, bb or cc" to "aa or bb or cc". This will allow us later to separate the industries 
index_1930[,indname_1930:=gsub("([^,]+), ([^,]+), ([^ ]+) or ([^ ]+)","\\1 or \\2 or \\3 or \\4",indname_1930)][,indname_1930:=gsub("([^,]+), ([^ ]+) or ([^ ]+)","\\1 or \\2 or \\3",indname_1930)][,indname_1930:=str_squish(gsub(","," ",indname_1930))]

# less than 5 observations with any, except
#View(index_1930[grepl("\\<any\\>",indname_1930),c("original_1930","indname_1930")])
```

1940
```{r}
# 1940
#index_1940[,indname_1940_original:=indname_1940]
index_1940[,indname_1940:=tolower(str_squish(gsub("\\(.*?)","",indname_1940_original)))][,indname_1940:=gsub("\\(|\\)","",indname_1940)][,indname_1940:=str_squish(indname_1940)]
# Change "aa, bb or cc" to "aa or bb or cc". This will allow us later to separate the industries 
index_1940[,indname_1940:=gsub("([^,]+), ([^,]+), ([^ ]+) or ([^ ]+)","\\1 or \\2 or \\3 or \\4",indname_1940)][,indname_1940:=gsub("([^,]+), ([^ ]+) or ([^ ]+)","\\1 or \\2 or \\3",indname_1940)][,indname_1940:=str_squish(gsub(","," ",indname_1940))]

# less than 5 observations with any, except
#View(index_1930[grepl("\\<any\\>",indname_1930),c("original_1930","indname_1930")])
```



### Creating vectors with elements in parentheses
Here we create vectors with elements in parentheses and change phrases of the form "a, b or c" to "a or b or c" and finally eliminate commas
```{r}
# FUNCTION
# Extracts elements inside the y parenthesis of a character vector
f_par <- function(x,y){
  unlist( 
    lapply(
      str_extract_all(x, "\\([^()]+\\)"), function(l) l[y]
    )
  )
}
# #NOTE: 
# - The regular expression "\\([^()]+\\)": 
#     first a LHS parentheses, 
#     then any element except () "[^()]", repeated one or more times "+"
#     and finally a RHS parentheses
# - The regular expression "\\(.+?\\)":
#     first a LHS parentheses, 
#     then any element repeated one or more time, but evaluated in a lazy way, i.e. as few as needed to allow the overall pattern to match (lazy)
#     and finally a RHS parentheses
# 
# - str_extract_all(x, "regular expression"): given a vector x, it extracts the elements inside each element of x that satisfy the condition. If inside the element of a vector there is more than one match, then it puts them in a vector
# - I use lapply because I want to extract the first element of the vector, for each component of the list
# - Unlist so as to flatten the list. It creates a vector of dimension the number of levels of the initial list

#1930
index_1930[,parentheses1_1930:=f_par(index_1930$indname_1930_original,1)][,parentheses1_1930:=gsub("([^,]+), ([^,]+), ([^ ]+) or ([^ ]+)","\\1 or \\2 or \\3 or \\4",parentheses1_1930)][,parentheses1_1930:=gsub("([^,]+), ([^ ]+) or (.+)","\\1 or \\2 or \\3",parentheses1_1930)][,parentheses1_1930:=str_squish(gsub(","," ",parentheses1_1930))]
index_1930[,parentheses2_1930:=f_par(index_1930$indname_1930_original,2)][,parentheses2_1930:=gsub("([^,]+), ([^,]+), ([^ ]+) or ([^ ]+)","\\1 or \\2 or \\3 or \\4",parentheses2_1930)][,parentheses2_1930:=gsub("([^,]+), ([^ ]+) or (.+)","\\1 or \\2 or \\3",parentheses2_1930)][,parentheses2_1930:=str_squish(gsub(","," ",parentheses2_1930))]

#1940
index_1940[,parentheses1_1940:=f_par(index_1940$indname_1940_original,1)][,parentheses1_1940:=gsub("([^,]+), ([^,]+), ([^ ]+) or ([^ ]+)","\\1 or \\2 or \\3 or \\4",parentheses1_1940)][,parentheses1_1940:=gsub("([^,]+), ([^ ]+) or (.+)","\\1 or \\2 or \\3",parentheses1_1940)][,parentheses1_1940:=str_squish(gsub(","," ",parentheses1_1940))]
index_1940[,parentheses2_1940:=f_par(index_1940$indname_1940_original,2)][,parentheses2_1940:=gsub("([^,]+), ([^,]+), ([^ ]+) or ([^ ]+)","\\1 or \\2 or \\3 or \\4",parentheses2_1940)][,parentheses2_1940:=gsub("([^,]+), ([^ ]+) or (.+)","\\1 or \\2 or \\3",parentheses2_1940)][,parentheses2_1940:=str_squish(gsub(","," ",parentheses2_1940))]

```

## 2.8. Creation of tables index_[t].indpar_edits.
This Table  simplifies industry, parentheses1 and info about any, except, army, no_army

### Function to extract information about any, except, army, no_army
```{r}
# Compressed version
f_any_except <- function(X,var,name="") {
  y <- copy(X)
  var_ch <- deparse(substitute(var))
  setnames(y, c(var_ch),c("var")) 
  y  <- y[,initial:=gsub("\\(|\\)","",var)][,initial:=gsub("\\<except any\\>","except",initial)]
  y  <- y[,plain:=gsub("(^any| any) .*|(^except| except|^not| not) .*|^any$","",initial)]
  y[,any:=gsub("any (.*)","\\1",str_squish(str_extract(initial,"(^any| any) .*")))]
  y[,except:=gsub("(except|not) (.*)","\\2",str_squish(str_extract(any,"(^except| except|^not| not) .*")))]
  y[,any:=gsub("(^except| except|^not| not) .*","",any)][grepl("^any$",initial),any:=""]
  
  y[!grepl("(?=( any |^any | any$))",initial,perl=TRUE),except:=str_squish( gsub("(except|not) (.*)","\\2",    str_extract(initial,"(^except| except|^not| not) .*") ) )]  
  y[,no_army:=0][grepl("(?=( army |^army | army$|^army$| navy |^navy | navyy$|^navy$))",except,perl=TRUE),no_army:=1]
  y[,army:=0][grepl("(?=( army |^army | army$|^army$| navy |^navy | navyy$|^navy$))",any,perl=TRUE),army:=1][grepl("(?=( army |^army | army$|^army$| navy |^navy | navyy$|^navy$))",plain,perl=TRUE),army:=1]
  y[,initial:=NULL]
  setnames(y,c("var","plain","any","except","army","no_army"),c(var_ch, paste0(var_ch,"_plain"),  paste0("any",substitute(name)) , paste0("except",substitute(name)) , paste0("army",substitute(name)) , paste0("no_army",substitute(name)) ) )
  return(y)
}

#a <- f_any_except(index_1930[,c("id_1930","indname_1930")],indname_1930,name="_ind")
#View(unique(a[army==1],by="indname_1930_plain"))
# Just a handful of unique observations with army==1. We can decide to eliminate the info and create and extra column with the army info

```

### Function to split titles with "or" word
```{r}
f_split_or <- function(y,id,obs_var) {
  # var: variable that has the strings with the or options that we want to split
  # Note: We only consider cases that have at most 3 or. Any other cases will just be treated as a unique case, e.g. only one value associated to the variable
  
  if (missing(obs_var)) {
    stop("You need to provide an observation variable")
  } 
  X <- copy(y)
  id_ch <- deparse(substitute(id))
  setnames(X, c(id_ch),c("id")) 
  obs_ch <- deparse(substitute(obs_var))
  setnames(X, c(obs_ch),c("obs")) 
  
  X <- X[,rep_or:=str_count(id, pattern=" or ")]

  if ( nrow(X[rep_or==0]) > 0 | nrow(X[rep_or>=4]) >  0)     X[rep_or==0 | rep_or>=4,var1:=id]
  if (nrow(X[rep_or==1]) > 0) {
    X[rep_or==1,var1:=gsub("([^ ]+) or ([^ ]+)","\\1",id)][rep_or==1,var2:=gsub("([^ ]+) or ([^ ]+)","\\2",id)]
    X[rep_or==1,var3:=gsub("(.+) or (.+)","\\1",id)][rep_or==1,var4:=gsub("(.+) or (.+)","\\2",id)]
  } 
  if (nrow(X[rep_or==2]) > 0) {
    X[rep_or==2,var1:=gsub("([^ ]+) or (.+) or ([^ ]+)","\\1",id)][rep_or==2,var2:=gsub("([^ ]+) or (.+) or ([^ ]+)","\\2",id)][rep_or==2,var3:=gsub("([^ ]+) or (.+) or ([^ ]+)","\\3",id)]
    X[rep_or==2,var4:=gsub("(.+) or (.+) or (.+)","\\1",id)][rep_or==2,var5:=gsub("(.+) or (.+) or (.+)","\\2",id)][rep_or==2,var6:=gsub("(.+) or (.+) or (.+)","\\3",id)]
  }
  if (nrow(X[rep_or==3]) > 0) {
    X[rep_or==3,var1:=gsub("([^ ]+) or (.+) or (.+) or ([^ ]+)","\\1",id)][rep_or==3,var2:=gsub("([^ ]+) or (.+) or (.+) or ([^ ]+)","\\2",id)][rep_or==3,var3:=gsub("([^ ]+) or (.+) or (.+) or ([^ ]+)","\\3",id)][rep_or==3,var4:=gsub("([^ ]+) or (.+) or (.+) or ([^ ]+)","\\4",id)]
    X[rep_or==3,var5:=gsub("(.+) or (.+) or (.+) or (.+)","\\1",id)][rep_or==3,var6:=gsub("(.+) or (.+) or (.+) or (.+)","\\2",id)][rep_or==3,var7:=gsub("(.+) or (.+) or (.+) or (.+)","\\3",id)][rep_or==3,var8:=gsub("(.+) or (.+) or (.+) or (.+)","\\4",id)]
  }
  
  X <- as.data.table( melt(X[,!c("rep_or")],id.vars=c("id","obs"), measure.vars = colnames(X)[grepl( "var" , names(X) )],variable.name="t",value.name="var",na.rm=TRUE) )
  X <- X[, .SD[1], by = c("obs","id","var")][,t:=NULL]
  
  setnames(X, c("obs","id","var"), c(obs_ch,id_ch,paste0(deparse(substitute(id)),"_l"))  )
  

  return(X)
}

```

### 2.8.1. Separating parentheses 
1930
```{r}
#1930
a <- f_any_except(index_1930[,c("id_1930","indname_1930")],indname_1930,name="_ind")
b <- f_any_except(index_1930[,c("id_1930","parentheses1_1930")],parentheses1_1930,name="_par1")
index_1930.indpar_edits <- merge(a[,indname_1930:=NULL],b[,parentheses1_1930:=NULL],by="id_1930",all=TRUE)
index_1930.indpar_edits[,`:=`(army=pmax(army_ind, army_par1),no_army=pmax(no_army_ind, no_army_par1))][,c("army_ind","no_army_ind","army_par1","no_army_par1"):=NULL]
# pmax is vectorized (parallel) max
index_1930.indpar_edits[,any:=ifelse(!is.na(any_ind),any_ind,any_par1)][,except:=ifelse(!is.na(except_ind),except_ind,except_par1)][,c("any_ind","except_ind","any_par1","except_par1"):=NULL]

# Add ns variable
index_1930.indpar_edits <- merge(index_1930.indpar_edits,index_1930[,c("id_1930","ns")],all.x=TRUE,all.y=FALSE)

# Replace empty cell with NA
index_1930.indpar_edits <- index_1930.indpar_edits[,c("indname_1930_plain","parentheses1_1930_plain"):=lapply(.SD,function(x) ifelse(x=="",NA,x)),.SDcols=c("indname_1930_plain","parentheses1_1930_plain")]

rm(a,b)
```

1940
```{r}
#1940
a <- f_any_except(index_1940[,c("id_1940","indname_1940")],indname_1940,name="_ind")
b <- f_any_except(index_1940[,c("id_1940","parentheses1_1940")],parentheses1_1940,name="_par1")
index_1940.indpar_edits <- merge(a[,indname_1940:=NULL],b[,parentheses1_1940:=NULL],by="id_1940",all=TRUE)
index_1940.indpar_edits[,`:=`(army=pmax(army_ind, army_par1),no_army=pmax(no_army_ind, no_army_par1))][,c("army_ind","no_army_ind","army_par1","no_army_par1"):=NULL]
# pmax is vectorized (parallel) max
index_1940.indpar_edits[,any:=ifelse(!is.na(any_ind),any_ind,any_par1)][,except:=ifelse(!is.na(except_ind),except_ind,except_par1)][,c("any_ind","except_ind","any_par1","except_par1"):=NULL]

# Add ns variable
index_1940.indpar_edits <- merge(index_1940.indpar_edits,index_1940[,c("id_1940","ns")],all.x=TRUE,all.y=FALSE)

# Replace empty cell with NA
index_1940.indpar_edits <- index_1940.indpar_edits[,c("indname_1940_plain","parentheses1_1940_plain"):=lapply(.SD,function(x) ifelse(x=="",NA,x)),.SDcols=c("indname_1940_plain","parentheses1_1940_plain")]

rm(a,b)
```


### 2.8.2. Changing some words 
*** TO-DO:
- Improve the manual corrections
#### 1930
```{r}
# 0.a. Change some words based on the Index
index_1930.indpar_edits <- index_1930.indpar_edits[,indname_1930_plain_with_replacements:=str_squish(gsub("\\<mill\\>|\\<works\\>|\\<factory\\>|\\<plant\\>","factory",indname_1930_plain))][,indname_1930_plain_with_replacements:=str_squish(gsub("\\<factory or shop or factory or company\\>","factory or shop or company",indname_1930_plain_with_replacements))]

index_1930.indpar_edits <- index_1930.indpar_edits[,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<mill\\>|\\<works\\>|\\<factory\\>|\\<plant\\>","factory",parentheses1_1930_plain))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<factory or shop or company or factory\\>","factory or shop or company",parentheses1_1930_plain_with_replacements))]

# 0.b. Other changes
## Title
index_1930.indpar_edits <- index_1930.indpar_edits[,indname_1930_plain_with_replacements:=str_squish(gsub("\\<abbattoir\\>","abattoir",indname_1930_plain_with_replacements))][,indname_1930_plain_with_replacements:=str_squish(gsub("\\<agricultural\\>","agriculture",indname_1930_plain_with_replacements))][,indname_1930_plain_with_replacements:=str_squish(gsub("\\<aluminum\\>","alum",indname_1930_plain_with_replacements))][,indname_1930_plain_with_replacements:=str_squish(gsub("\\<apartment house\\>|\\<apartments or house\\>|\\<apartment or house\\>|\\<apartments or houses\\>|\\<apartment or houses\\>|\\<houses\\>|\\<apartments\\>|\\<apartment\\>","house",indname_1930_plain_with_replacements))][,indname_1930_plain_with_replacements:=str_squish(gsub("\\<architecture\\>","architect",indname_1930_plain_with_replacements))][,indname_1930_plain_with_replacements:=str_squish(gsub("\\<automobile\\>|\\<automotive\\>|\\<automobiles\\>","auto",indname_1930_plain_with_replacements))][,indname_1930_plain_with_replacements:=str_squish(gsub("\\<accessories\\>","supplies",indname_1930_plain_with_replacements))][,indname_1930_plain_with_replacements:=str_squish(gsub("\\<baggage\\>|\\<bagging\\>","bagg",indname_1930_plain_with_replacements))][,indname_1930_plain_with_replacements:=str_squish(gsub("\\<bakery\\>|\\<bakers\\>|\\<baking\\>","baker",indname_1930_plain_with_replacements))][,indname_1930_plain_with_replacements:=str_squish(gsub("\\<banking house\\>|\\<banking\\>|\\<bankers\\>","bank",indname_1930_plain_with_replacements))][,indname_1930_plain_with_replacements:=str_squish(gsub("\\<factory or company\\>","company or factory",indname_1930_plain_with_replacements))]
index_1930.indpar_edits <- index_1930.indpar_edits[,indname_1930_plain_with_replacements:=str_squish(gsub("\\<boat(s*) or ship(s*)\\>|\\<ship(s*) or boat(s*)\\>|\\<boat(s*) or ship(s*) or vessel(*)\\>|\\<boat(*) or vessel(s*) or ship(s*)\\>|\\<ship(s*) or vessel(s*)\\>|\\<boat(s*) or vessel(s*)\\>|boat(s*)$|ship(s*)$|vessel(s*)$","ship",indname_1930_plain_with_replacements))][,indname_1930_plain_with_replacements:=str_squish(gsub("boat(s*) |ship(s*) |vessel(s*) ","ship ",indname_1930_plain_with_replacements))][,indname_1930_plain_with_replacements:=str_squish(gsub("\\<co\\>","company",indname_1930_plain_with_replacements))][,indname_1930_plain_with_replacements:=str_squish(gsub("\\<court house\\>","court",indname_1930_plain_with_replacements))][,indname_1930_plain_with_replacements:=str_squish(gsub("\\<lightning\\>","lighting",indname_1930_plain_with_replacements))]


## Parentheses
index_1930.indpar_edits <- index_1930.indpar_edits[,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<abbattoir\\>","abattoir",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<agricultural\\>","agriculture",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<aluminum\\>","alum",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<apartment house\\>|\\<apartments or house\\>|\\<apartment or house\\>|\\<apartments or houses\\>|\\<apartment or houses\\>|\\<houses\\>|\\<apartments\\>|\\<apartment\\>","house",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<architecture\\>","architect",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<automobile\\>|\\<automotive\\>|\\<automobiles\\>","auto",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<accessories\\>","supplies",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<baggage\\>|\\<bagging\\>","bagg",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<bakery\\>|\\<bakers\\>|\\<baking\\>","baker",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<banking house\\>|\\<banking\\>|\\<bankers\\>","bank",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<factory or company\\>","company or factory",parentheses1_1930_plain_with_replacements))]
index_1930.indpar_edits <- index_1930.indpar_edits[,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<boat(s*) or ship(s*)\\>|\\<ship(s*) or boat(s*)\\>|\\<boat(s*) or ship(s*) or vessel(*)\\>|\\<boat(*) or vessel(s*) or ship(s*)\\>|\\<ship(s*) or vessel(s*)\\>|\\<boat(s*) or vessel(s*)\\>|boat(s*)$|ship(s*)$|vessel(s*)$","ship",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("boat(s*) |ship(s*) |vessel(s*) ","ship ",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<lightning\\>","lighting",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<co\\>","company",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<court house\\>","court",parentheses1_1930_plain_with_replacements))]


# 0.c. Replace terms [tit] or [tit2] or [tit] ---> [tit] or [tit2] 
index_1930.indpar_edits <- index_1930.indpar_edits[,indname_1930_plain_with_replacements:= str_squish(gsub("(.*)([a-z]+) or ([a-z]+) or \\2 (.+)","\\1\\2 or \\3 \\4",indname_1930_plain_with_replacements))][,indname_1930_plain_with_replacements:= str_squish(gsub("(.*)([a-z]+) or ([a-z]+) or \\2$","\\1\\2 or \\3",indname_1930_plain_with_replacements))]

index_1930.indpar_edits <- index_1930.indpar_edits[,parentheses1_1930_plain_with_replacements:= str_squish(gsub("(.*)([a-z]+) or ([a-z]+) or \\2 (.+)","\\1\\2 or \\3 \\4",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:= str_squish(gsub("(.*)([a-z]+) or ([a-z]+) or \\2$","\\1\\2 or \\3",parentheses1_1930_plain_with_replacements))]

# 0.d. Replace terms [tit] or [tit] ---> [tit]. 
index_1930.indpar_edits <- index_1930.indpar_edits[,indname_1930_plain_with_replacements:= str_squish(gsub("(.*)([a-z]+) or \\2 (.+)","\\1\\2 or \\3",indname_1930_plain_with_replacements))][,indname_1930_plain_with_replacements:= str_squish(gsub("(.*)([a-z]+) or \\2$","\\1\\2",indname_1930_plain_with_replacements))][,indname_1930_plain_with_replacements:= str_squish(gsub(" or or "," or ",indname_1930_plain_with_replacements))]

index_1930.indpar_edits <- index_1930.indpar_edits[,parentheses1_1930_plain_with_replacements:= str_squish(gsub("(.*)([a-z]+) or \\2 (.+)","\\1\\2 or \\3",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:= str_squish(gsub("(.*)([a-z]+) or \\2$","\\1\\2",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:= str_squish(gsub(" or or "," or ",parentheses1_1930_plain_with_replacements))]

# 1a. Replace terms of the form [tit] or [tit]er ---> [tit]
## Create replacement list
ind_replacement_list <- index_1930.indpar_edits[,c("indname_1930_plain_with_replacements")][,stem:=gsub("(.+) or \\1er","\\1",str_extract(indname_1930_plain_with_replacements,"(.+) or \\1er$"))][!is.na(stem)][,original_1:=paste0(str_squish(stem))][,original_2:=paste0(str_squish(stem),"er")][,change:=1]
temp <- index_1930.indpar_edits[,c("indname_1930_plain_with_replacements")][,stem:=gsub("(.+) or \\1er ","\\1",str_extract(indname_1930_plain_with_replacements,"(.+) or \\1er "))][!is.na(stem)][,original_1:=paste0(str_squish(stem))][,original_2:=paste0(str_squish(stem),"er")][,change:=1]
ind_replacement_list <- rbind(ind_replacement_list,temp,fill=TRUE)
ind_simplification_list <- unique(ind_replacement_list[,c("stem","original_1","original_2","change")])

## Check that replacement works
ind_replacement_list <- ind_replacement_list[change==1,check:=gsub("(.*)(.+) or \\2er$","\\1\\2",indname_1930_plain_with_replacements)][change==1,check:=gsub("(.*)(.+) or \\2er ","\\1\\2 ",check)]

## Replace 
index_1930.indpar_edits <- index_1930.indpar_edits[,indname_1930_plain_with_replacements:=str_squish( gsub("(.*)(.+) or \\2er$","\\1\\2",indname_1930_plain_with_replacements) )][,indname_1930_plain_with_replacements:=str_squish( gsub("(.*)(.+) or \\2er ","\\1\\2 ",indname_1930_plain_with_replacements) )]

# 1b. Replace terms of the form [tit] or [tit]r ---> [tit]
## Create replacement list
temp <- rbind(
          index_1930.indpar_edits[,c("indname_1930_plain_with_replacements")][,stem:=gsub("(.+) or \\1r","\\1",str_extract(indname_1930_plain_with_replacements,"(.+) or \\1r$"))][!is.na(stem)][,original_1:=paste0(str_squish(stem))][,original_2:=paste0(str_squish(stem),"r")][,change:=1.5],
          index_1930.indpar_edits[,c("indname_1930_plain_with_replacements")][,stem:=gsub("(.+) or \\1r ","\\1",str_extract(indname_1930_plain_with_replacements,"(.+) or \\1r "))][!is.na(stem)][,original_1:=paste0(str_squish(stem))][,original_2:=paste0(str_squish(stem),"r")][,change:=1.5]
             )
ind_replacement_list <- rbind(ind_replacement_list,temp,fill=TRUE)
ind_simplification_list <- rbind(ind_simplification_list,unique(temp[,c("stem","original_1","original_2","change")]))

## Check that replacement works
ind_replacement_list <- ind_replacement_list[change==1.5,check:=gsub("(.*)(.+) or \\2r ","\\1\\2 ",indname_1930_plain_with_replacements)][change==1.5,check:=gsub("(.*)(.+) or \\2r$","\\1\\2",check)]

## Replace 
index_1930.indpar_edits <- index_1930.indpar_edits[,indname_1930_plain_with_replacements:=str_squish( gsub("(.*)(.+) or \\2r ","\\1\\2 ",indname_1930_plain_with_replacements) )][,indname_1930_plain_with_replacements:=str_squish( gsub("(.*)(.+) or \\2r$","\\1\\2",indname_1930_plain_with_replacements) )]

# 2a. Replace terms of the form [tit]er or [tit] ---> [tit]
## Create replacement list
temp <- rbind(
          index_1930.indpar_edits[,c("indname_1930_plain_with_replacements")][,stem:=gsub("(.+)er or \\1","\\1",str_extract(indname_1930_plain_with_replacements,"(.+)er or \\1$"))][!is.na(stem)][,original_1:=paste0(str_squish(stem),"er")][,original_2:=paste0(str_squish(stem))][,change:=2],
          index_1930.indpar_edits[,c("indname_1930_plain_with_replacements")][,stem:=gsub("(.+)er or \\1 ","\\1",str_extract(indname_1930_plain_with_replacements,"(.+)er or \\1 "))][!is.na(stem)][,original_1:=paste0(str_squish(stem),"er")][,original_2:=paste0(str_squish(stem))][,change:=2]
             )
# Old way
#temp <- index_1930.indpar_edits[,c("indname_1930_plain_with_replacements")][,stem:=gsub("(.+)er or \\1 (.+)","\\1",str_extract(indname_1930_plain_with_replacements,"(.+)er or \\1 (.+)"))][!is.na(stem)][,original_1:=paste0(stem,"er")][,original_2:=paste0(stem)][,change:=2]

ind_replacement_list <- rbind(ind_replacement_list,temp,fill=TRUE)
ind_simplification_list <- rbind(ind_simplification_list,unique(temp[,c("stem","original_1","original_2","change")]))

## Check that replacement works
#ind_replacement_list <- ind_replacement_list[change==2,check:=gsub("(.+)er or \\1 (.+)","\\1 \\2",indname_1930_plain_with_replacements)]
ind_replacement_list <- ind_replacement_list[change==2,check:=gsub("(.+)er or \\1$","\\1",indname_1930_plain_with_replacements)][change==2,check:=gsub("(.+)er or \\1 ","\\1 ",check)]

## Replace 
index_1930.indpar_edits <- index_1930.indpar_edits[,indname_1930_plain_with_replacements:=str_squish( gsub("(.+)er or \\1$","\\1",indname_1930_plain_with_replacements) )][,indname_1930_plain_with_replacements:=str_squish( gsub("(.+)er or \\1 ","\\1 ",indname_1930_plain_with_replacements) )]

# 2b. Replace terms of the form [tit]r or [tit] ---> [tit]
## Create replacement list
temp <- rbind(
          index_1930.indpar_edits[,c("indname_1930_plain_with_replacements")][,stem:=gsub("(.+)r or \\1","\\1",str_extract(indname_1930_plain_with_replacements,"(.+)r or \\1$"))][!is.na(stem)][,original_1:=paste0(str_squish(stem),"r")][,original_2:=paste0(str_squish(stem))][,change:=2.5],
          index_1930.indpar_edits[,c("indname_1930_plain_with_replacements")][,stem:=gsub("(.+)r or \\1 ","\\1",str_extract(indname_1930_plain_with_replacements,"(.+)r or \\1 "))][!is.na(stem)][,original_1:=paste0(str_squish(stem),"r")][,original_2:=paste0(str_squish(stem))][,change:=2.5]
             )
ind_replacement_list <- rbind(ind_replacement_list,temp,fill=TRUE)
ind_simplification_list <- rbind(ind_simplification_list,unique(temp[,c("stem","original_1","original_2","change")]))

## Check that replacement works
ind_replacement_list <- ind_replacement_list[change==2.5,check:=gsub("([a-z]+)r or \\1$","\\1",indname_1930_plain_with_replacements)][change==2.5,check:=gsub("([a-z]+)r or \\1 ","\\1 ",check)]

## Replace 
index_1930.indpar_edits <- index_1930.indpar_edits[,indname_1930_plain_with_replacements:=str_squish( gsub("([a-z]+)r or \\1$","\\1",indname_1930_plain_with_replacements) )][,indname_1930_plain_with_replacements:=str_squish( gsub("([a-z]+)r or \\1 ","\\1 ",indname_1930_plain_with_replacements) )]

# 3. Use the simplification list to change words
## We will only replace COMPLETE words
ind_simplification_list$original_1 <- paste0(paste0("\\<",ind_simplification_list$original_1),"\\>")
ind_simplification_list$original_2 <- paste0(paste0("\\<",ind_simplification_list$original_2),"\\>")

## Title
index_1930.indpar_edits$indname_1930_plain_with_replacements <- str_squish( mgsub(ind_simplification_list$original_1,ind_simplification_list$stem,index_1930.indpar_edits$indname_1930_plain_with_replacements,fixed=FALSE) )
index_1930.indpar_edits$indname_1930_plain_with_replacements <- str_squish( mgsub(ind_simplification_list$original_2,ind_simplification_list$stem,index_1930.indpar_edits$indname_1930_plain_with_replacements,fixed=FALSE) )

# Parentheses
index_1930.indpar_edits$parentheses1_1930_plain_with_replacements <- str_squish( mgsub(ind_simplification_list$original_1,ind_simplification_list$stem,index_1930.indpar_edits$parentheses1_1930_plain_with_replacements,fixed=FALSE) )
index_1930.indpar_edits$parentheses1_1930_plain_with_replacements <- str_squish( mgsub(ind_simplification_list$original_2,ind_simplification_list$stem,index_1930.indpar_edits$parentheses1_1930_plain_with_replacements,fixed=FALSE) )

# Change parenthesis: if tit or tit ---> tit
index_1930.indpar_edits <- index_1930.indpar_edits[,parentheses1_1930_plain_with_replacements:= str_squish(gsub("([a-z]+) or \\1 ","\\1 ",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish( gsub("([a-z]+) or \\1$","\\1",parentheses1_1930_plain_with_replacements) )]

# 4. Reduce words ending in -er, -ist, -ing to their stem
## Find out all the words ending in er, ing, ist
temp <- index_1930.indpar_edits[,c("indname_1930_plain_with_replacements")][,original:=str_squish(unlist(lapply(str_extract_all(indname_1930_plain_with_replacements,"([^ ]+)er$|([^ ]+)er |([^ ]+)ers$|([^ ]+)ers |([^ ]+)ing$|([^ ]+)ing |([^ ]+)ist$|([^ ]+)ist "), function(l) l[1])))][,original1:=str_squish(unlist(lapply(str_extract_all(indname_1930_plain_with_replacements,"([^ ]+)er$|([^ ]+)er |([^ ]+)ers$|([^ ]+)ers |([^ ]+)ing$|([^ ]+)ing |([^ ]+)ist$|([^ ]+)ist "), function(l) l[2])))][,original2:=str_squish(unlist(lapply(str_extract_all(indname_1930_plain_with_replacements,"([^ ]+)er$|([^ ]+)er |([^ ]+)ers$|([^ ]+)ers |([^ ]+)ing$|([^ ]+)ing |([^ ]+)ist$|([^ ]+)ist "), function(l) l[3])))][,`:=`(original=str_squish(original),original1=str_squish(original1),original2=str_squish(original2))]

ind_simplification_list.er_ist_ing <- unique(rbind(unique(temp[,c("original")]),unique(temp[,c("original1")][,`:=`(original=original1,original1=NULL)]),unique(temp[,c("original2")][,`:=`(original=original2,original2=NULL)])))[!is.na(original)]
ind_simplification_list.er_ist_ing <- ind_simplification_list.er_ist_ing[,stem:=gsub("([a-z]+)er$","\\1",str_extract(original,"([a-z]+)er$"))][is.na(stem),stem:=gsub("([a-z]+)ers$","\\1",str_extract(original,"([a-z]+)ers$"))][is.na(stem),stem:=gsub("([a-z]+)ing$","\\1",str_extract(original,"([a-z]+)ing$"))][is.na(stem),stem:=gsub("([a-z]+)ist$","\\1",str_extract(original,"([a-z]+)ist$"))]

## Manually change and add some variables
# TO-DO: Look for manual changes
## Manually change and add some variables
ind_simplification_list.er_ist_ing <- ind_simplification_list.er_ist_ing[original %in% c("engineer","engineers","engineering"),stem:="engineer"][original %in% c("ringing","ringer","ring"),stem:="ring"][original %in% c("dyeing","dyer"),stem:="dy"][original=="drier",stem:="dry"][original %in% c("desulphuring","desulphurizer"),stem:="desulphur"][original=="cataloguer",stem:="catalogue"][original %in% c("timber","timbering","timberland"),stem:="timber"][original %in% c("feather","feathers","featherer"),stem:="feather"][original %in% c("mitering","miter"),stem:="miter"][original %in% c("plaster","plasterer"),stem:="plaster"]

## Keep only those words that appear more than once
ind_simplification_list.er_ist_ing <- ind_simplification_list.er_ist_ing[,dup:=0 + duplicated(stem)][,dup:=max(dup),by=c("stem")][dup>0][,dup:=NULL]

## Add other words
# TO-DO

## Convert into word for the search
ind_simplification_list.er_ist_ing$original <- paste0(paste0("\\<",ind_simplification_list.er_ist_ing$original),"\\>")

## Use simplification list to change words
index_1930.indpar_edits$indname_1930_plain_with_replacements <- str_squish( mgsub(ind_simplification_list.er_ist_ing$original,ind_simplification_list.er_ist_ing$stem,index_1930.indpar_edits$indname_1930_plain_with_replacements,fixed=FALSE) )

index_1930.indpar_edits$parentheses1_1930_plain_with_replacements <- str_squish( mgsub(ind_simplification_list.er_ist_ing$original,ind_simplification_list.er_ist_ing$stem,index_1930.indpar_edits$parentheses1_1930_plain_with_replacements,fixed=FALSE) )

# 5. Creating a simplifaction list that we will combine with the one for 1930
ind_simplification_list_1930_and_1940 <- copy(ind_simplification_list)
ind_simplification_list.er_ist_ing_1930_and_1940 <- copy(ind_simplification_list.er_ist_ing)
rm(ind_replacement_list,ind_simplification_list,ind_simplification_list.er_ist_ing)


```

#### 1940
```{r}
# 0.a. Change some words based on the Index
index_1940.indpar_edits <- index_1940.indpar_edits[,indname_1940_plain_with_replacements:=str_squish(gsub("\\<mill\\>|\\<works\\>|\\<factory\\>|\\<plant\\>","factory",indname_1940_plain))][,indname_1940_plain_with_replacements:=str_squish(gsub("\\<factory or shop or factory or company\\>","factory or shop or company",indname_1940_plain_with_replacements))]

index_1940.indpar_edits <- index_1940.indpar_edits[,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<mill\\>|\\<works\\>|\\<factory\\>|\\<plant\\>","factory",parentheses1_1940_plain))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<factory or shop or company or factory\\>","factory or shop or company",parentheses1_1940_plain_with_replacements))]

# 0.b. Other changes
## Title
index_1940.indpar_edits <- index_1940.indpar_edits[,indname_1940_plain_with_replacements:=str_squish(gsub("\\<abbattoir\\>","abattoir",indname_1940_plain_with_replacements))][,indname_1940_plain_with_replacements:=str_squish(gsub("\\<agricultural\\>","agriculture",indname_1940_plain_with_replacements))][,indname_1940_plain_with_replacements:=str_squish(gsub("\\<aluminum\\>","alum",indname_1940_plain_with_replacements))][,indname_1940_plain_with_replacements:=str_squish(gsub("\\<apartment house\\>|\\<apartments or house\\>|\\<apartment or house\\>|\\<apartments or houses\\>|\\<apartment or houses\\>|\\<houses\\>|\\<apartments\\>|\\<apartment\\>","house",indname_1940_plain_with_replacements))][,indname_1940_plain_with_replacements:=str_squish(gsub("\\<architecture\\>","architect",indname_1940_plain_with_replacements))][,indname_1940_plain_with_replacements:=str_squish(gsub("\\<automobile\\>|\\<automotive\\>|\\<automobiles\\>","auto",indname_1940_plain_with_replacements))][,indname_1940_plain_with_replacements:=str_squish(gsub("\\<accessories\\>","supplies",indname_1940_plain_with_replacements))][,indname_1940_plain_with_replacements:=str_squish(gsub("\\<baggage\\>|\\<bagging\\>","bagg",indname_1940_plain_with_replacements))][,indname_1940_plain_with_replacements:=str_squish(gsub("\\<bakery\\>|\\<bakers\\>|\\<baking\\>","baker",indname_1940_plain_with_replacements))][,indname_1940_plain_with_replacements:=str_squish(gsub("\\<banking house\\>|\\<banking\\>|\\<bankers\\>","bank",indname_1940_plain_with_replacements))][,indname_1940_plain_with_replacements:=str_squish(gsub("\\<factory or company\\>","company or factory",indname_1940_plain_with_replacements))]
index_1940.indpar_edits <- index_1940.indpar_edits[,indname_1940_plain_with_replacements:=str_squish(gsub("\\<boat(s*) or ship(s*)\\>|\\<ship(s*) or boat(s*)\\>|\\<boat(s*) or ship(s*) or vessel(*)\\>|\\<boat(*) or vessel(s*) or ship(s*)\\>|\\<ship(s*) or vessel(s*)\\>|\\<boat(s*) or vessel(s*)\\>|boat(s*)$|ship(s*)$|vessel(s*)$","ship",indname_1940_plain_with_replacements))][,indname_1940_plain_with_replacements:=str_squish(gsub("boat(s*) |ship(s*) |vessel(s*) ","ship ",indname_1940_plain_with_replacements))][,indname_1940_plain_with_replacements:=str_squish(gsub("\\<co\\>","company",indname_1940_plain_with_replacements))][,indname_1940_plain_with_replacements:=str_squish(gsub("\\<court house\\>","court",indname_1940_plain_with_replacements))][,indname_1940_plain_with_replacements:=str_squish(gsub("\\<lightning\\>","lighting",indname_1940_plain_with_replacements))]


## Parentheses
index_1940.indpar_edits <- index_1940.indpar_edits[,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<abbattoir\\>","abattoir",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<agricultural\\>","agriculture",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<aluminum\\>","alum",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<apartment house\\>|\\<apartments or house\\>|\\<apartment or house\\>|\\<apartments or houses\\>|\\<apartment or houses\\>|\\<houses\\>|\\<apartments\\>|\\<apartment\\>","house",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<architecture\\>","architect",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<automobile\\>|\\<automotive\\>|\\<automobiles\\>","auto",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<accessories\\>","supplies",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<baggage\\>|\\<bagging\\>","bagg",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<bakery\\>|\\<bakers\\>|\\<baking\\>","baker",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<banking house\\>|\\<banking\\>|\\<bankers\\>","bank",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<factory or company\\>","company or factory",parentheses1_1940_plain_with_replacements))]
index_1940.indpar_edits <- index_1940.indpar_edits[,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<boat(s*) or ship(s*)\\>|\\<ship(s*) or boat(s*)\\>|\\<boat(s*) or ship(s*) or vessel(*)\\>|\\<boat(*) or vessel(s*) or ship(s*)\\>|\\<ship(s*) or vessel(s*)\\>|\\<boat(s*) or vessel(s*)\\>|boat(s*)$|ship(s*)$|vessel(s*)$","ship",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("boat(s*) |ship(s*) |vessel(s*) ","ship ",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<lightning\\>","lighting",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<co\\>","company",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<court house\\>","court",parentheses1_1940_plain_with_replacements))]


# 0.c. Replace terms [tit] or [tit2] or [tit] ---> [tit] or [tit2] 
index_1940.indpar_edits <- index_1940.indpar_edits[,indname_1940_plain_with_replacements:= str_squish(gsub("(.*)([a-z]+) or ([a-z]+) or \\2 (.+)","\\1\\2 or \\3 \\4",indname_1940_plain_with_replacements))][,indname_1940_plain_with_replacements:= str_squish(gsub("(.*)([a-z]+) or ([a-z]+) or \\2$","\\1\\2 or \\3",indname_1940_plain_with_replacements))]

index_1940.indpar_edits <- index_1940.indpar_edits[,parentheses1_1940_plain_with_replacements:= str_squish(gsub("(.*)([a-z]+) or ([a-z]+) or \\2 (.+)","\\1\\2 or \\3 \\4",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:= str_squish(gsub("(.*)([a-z]+) or ([a-z]+) or \\2$","\\1\\2 or \\3",parentheses1_1940_plain_with_replacements))]

# 0.d. Replace terms [tit] or [tit] ---> [tit]. 
index_1940.indpar_edits <- index_1940.indpar_edits[,indname_1940_plain_with_replacements:= str_squish(gsub("(.*)([a-z]+) or \\2 (.+)","\\1\\2 or \\3",indname_1940_plain_with_replacements))][,indname_1940_plain_with_replacements:= str_squish(gsub("(.*)([a-z]+) or \\2$","\\1\\2",indname_1940_plain_with_replacements))][,indname_1940_plain_with_replacements:= str_squish(gsub(" or or "," or ",indname_1940_plain_with_replacements))]

index_1940.indpar_edits <- index_1940.indpar_edits[,parentheses1_1940_plain_with_replacements:= str_squish(gsub("(.*)([a-z]+) or \\2 (.+)","\\1\\2 or \\3",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:= str_squish(gsub("(.*)([a-z]+) or \\2$","\\1\\2",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:= str_squish(gsub(" or or "," or ",parentheses1_1940_plain_with_replacements))]

# 1a. Replace terms of the form [tit] or [tit]er ---> [tit]
## Create replacement list
ind_replacement_list <- index_1940.indpar_edits[,c("indname_1940_plain_with_replacements")][,stem:=gsub("(.+) or \\1er","\\1",str_extract(indname_1940_plain_with_replacements,"(.+) or \\1er$"))][!is.na(stem)][,original_1:=paste0(str_squish(stem))][,original_2:=paste0(str_squish(stem),"er")][,change:=1]
temp <- index_1940.indpar_edits[,c("indname_1940_plain_with_replacements")][,stem:=gsub("(.+) or \\1er ","\\1",str_extract(indname_1940_plain_with_replacements,"(.+) or \\1er "))][!is.na(stem)][,original_1:=paste0(str_squish(stem))][,original_2:=paste0(str_squish(stem),"er")][,change:=1]
ind_replacement_list <- rbind(ind_replacement_list,temp,fill=TRUE)
ind_simplification_list <- unique(ind_replacement_list[,c("stem","original_1","original_2","change")])

## Check that replacement works
ind_replacement_list <- ind_replacement_list[change==1,check:=gsub("(.*)(.+) or \\2er$","\\1\\2",indname_1940_plain_with_replacements)][change==1,check:=gsub("(.*)(.+) or \\2er ","\\1\\2 ",check)]

## Replace 
index_1940.indpar_edits <- index_1940.indpar_edits[,indname_1940_plain_with_replacements:=str_squish( gsub("(.*)(.+) or \\2er$","\\1\\2",indname_1940_plain_with_replacements) )][,indname_1940_plain_with_replacements:=str_squish( gsub("(.*)(.+) or \\2er ","\\1\\2 ",indname_1940_plain_with_replacements) )]

# 1b. Replace terms of the form [tit] or [tit]r ---> [tit]
## Create replacement list
temp <- rbind(
          index_1940.indpar_edits[,c("indname_1940_plain_with_replacements")][,stem:=gsub("(.+) or \\1r","\\1",str_extract(indname_1940_plain_with_replacements,"(.+) or \\1r$"))][!is.na(stem)][,original_1:=paste0(str_squish(stem))][,original_2:=paste0(str_squish(stem),"r")][,change:=1.5],
          index_1940.indpar_edits[,c("indname_1940_plain_with_replacements")][,stem:=gsub("(.+) or \\1r ","\\1",str_extract(indname_1940_plain_with_replacements,"(.+) or \\1r "))][!is.na(stem)][,original_1:=paste0(str_squish(stem))][,original_2:=paste0(str_squish(stem),"r")][,change:=1.5]
             )
ind_replacement_list <- rbind(ind_replacement_list,temp,fill=TRUE)
ind_simplification_list <- rbind(ind_simplification_list,unique(temp[,c("stem","original_1","original_2","change")]))

## Check that replacement works
ind_replacement_list <- ind_replacement_list[change==1.5,check:=gsub("(.*)(.+) or \\2r ","\\1\\2 ",indname_1940_plain_with_replacements)][change==1.5,check:=gsub("(.*)(.+) or \\2r$","\\1\\2",check)]

## Replace 
index_1940.indpar_edits <- index_1940.indpar_edits[,indname_1940_plain_with_replacements:=str_squish( gsub("(.*)(.+) or \\2r ","\\1\\2 ",indname_1940_plain_with_replacements) )][,indname_1940_plain_with_replacements:=str_squish( gsub("(.*)(.+) or \\2r$","\\1\\2",indname_1940_plain_with_replacements) )]

# 2a. Replace terms of the form [tit]er or [tit] ---> [tit]
## Create replacement list
temp <- rbind(
          index_1940.indpar_edits[,c("indname_1940_plain_with_replacements")][,stem:=gsub("(.+)er or \\1","\\1",str_extract(indname_1940_plain_with_replacements,"(.+)er or \\1$"))][!is.na(stem)][,original_1:=paste0(str_squish(stem),"er")][,original_2:=paste0(str_squish(stem))][,change:=2],
          index_1940.indpar_edits[,c("indname_1940_plain_with_replacements")][,stem:=gsub("(.+)er or \\1 ","\\1",str_extract(indname_1940_plain_with_replacements,"(.+)er or \\1 "))][!is.na(stem)][,original_1:=paste0(str_squish(stem),"er")][,original_2:=paste0(str_squish(stem))][,change:=2]
             )
# Old way
#temp <- index_1940.indpar_edits[,c("indname_1940_plain_with_replacements")][,stem:=gsub("(.+)er or \\1 (.+)","\\1",str_extract(indname_1940_plain_with_replacements,"(.+)er or \\1 (.+)"))][!is.na(stem)][,original_1:=paste0(stem,"er")][,original_2:=paste0(stem)][,change:=2]

ind_replacement_list <- rbind(ind_replacement_list,temp,fill=TRUE)
ind_simplification_list <- rbind(ind_simplification_list,unique(temp[,c("stem","original_1","original_2","change")]))

## Check that replacement works
#ind_replacement_list <- ind_replacement_list[change==2,check:=gsub("(.+)er or \\1 (.+)","\\1 \\2",indname_1940_plain_with_replacements)]
ind_replacement_list <- ind_replacement_list[change==2,check:=gsub("(.+)er or \\1$","\\1",indname_1940_plain_with_replacements)][change==2,check:=gsub("(.+)er or \\1 ","\\1 ",check)]

## Replace 
index_1940.indpar_edits <- index_1940.indpar_edits[,indname_1940_plain_with_replacements:=str_squish( gsub("(.+)er or \\1$","\\1",indname_1940_plain_with_replacements) )][,indname_1940_plain_with_replacements:=str_squish( gsub("(.+)er or \\1 ","\\1 ",indname_1940_plain_with_replacements) )]

# 2b. Replace terms of the form [tit]r or [tit] ---> [tit]
## Create replacement list
temp <- rbind(
          index_1940.indpar_edits[,c("indname_1940_plain_with_replacements")][,stem:=gsub("(.+)r or \\1","\\1",str_extract(indname_1940_plain_with_replacements,"(.+)r or \\1$"))][!is.na(stem)][,original_1:=paste0(str_squish(stem),"r")][,original_2:=paste0(str_squish(stem))][,change:=2.5],
          index_1940.indpar_edits[,c("indname_1940_plain_with_replacements")][,stem:=gsub("(.+)r or \\1 ","\\1",str_extract(indname_1940_plain_with_replacements,"(.+)r or \\1 "))][!is.na(stem)][,original_1:=paste0(str_squish(stem),"r")][,original_2:=paste0(str_squish(stem))][,change:=2.5]
             )
ind_replacement_list <- rbind(ind_replacement_list,temp,fill=TRUE)
ind_simplification_list <- rbind(ind_simplification_list,unique(temp[,c("stem","original_1","original_2","change")]))

## Check that replacement works
ind_replacement_list <- ind_replacement_list[change==2.5,check:=gsub("([a-z]+)r or \\1$","\\1",indname_1940_plain_with_replacements)][change==2.5,check:=gsub("([a-z]+)r or \\1 ","\\1 ",check)]

## Replace 
index_1940.indpar_edits <- index_1940.indpar_edits[,indname_1940_plain_with_replacements:=str_squish( gsub("([a-z]+)r or \\1$","\\1",indname_1940_plain_with_replacements) )][,indname_1940_plain_with_replacements:=str_squish( gsub("([a-z]+)r or \\1 ","\\1 ",indname_1940_plain_with_replacements) )]

# 3. Use the simplification list to change words
## We will only replace COMPLETE words
ind_simplification_list$original_1 <- paste0(paste0("\\<",ind_simplification_list$original_1),"\\>")
ind_simplification_list$original_2 <- paste0(paste0("\\<",ind_simplification_list$original_2),"\\>")

## Title
index_1940.indpar_edits$indname_1940_plain_with_replacements <- str_squish( mgsub(ind_simplification_list$original_1,ind_simplification_list$stem,index_1940.indpar_edits$indname_1940_plain_with_replacements,fixed=FALSE) )
index_1940.indpar_edits$indname_1940_plain_with_replacements <- str_squish( mgsub(ind_simplification_list$original_2,ind_simplification_list$stem,index_1940.indpar_edits$indname_1940_plain_with_replacements,fixed=FALSE) )

# Parentheses
index_1940.indpar_edits$parentheses1_1940_plain_with_replacements <- str_squish( mgsub(ind_simplification_list$original_1,ind_simplification_list$stem,index_1940.indpar_edits$parentheses1_1940_plain_with_replacements,fixed=FALSE) )
index_1940.indpar_edits$parentheses1_1940_plain_with_replacements <- str_squish( mgsub(ind_simplification_list$original_2,ind_simplification_list$stem,index_1940.indpar_edits$parentheses1_1940_plain_with_replacements,fixed=FALSE) )

# Change parenthesis: if tit or tit ---> tit
index_1940.indpar_edits <- index_1940.indpar_edits[,parentheses1_1940_plain_with_replacements:= str_squish(gsub("([a-z]+) or \\1 ","\\1 ",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish( gsub("([a-z]+) or \\1$","\\1",parentheses1_1940_plain_with_replacements) )]

# 4. Reduce words ending in -er, -ist, -ing to their stem
## Find out all the words ending in er, ing, ist
temp <- index_1940.indpar_edits[,c("indname_1940_plain_with_replacements")][,original:=str_squish(unlist(lapply(str_extract_all(indname_1940_plain_with_replacements,"([^ ]+)er$|([^ ]+)er |([^ ]+)ers$|([^ ]+)ers |([^ ]+)ing$|([^ ]+)ing |([^ ]+)ist$|([^ ]+)ist "), function(l) l[1])))][,original1:=str_squish(unlist(lapply(str_extract_all(indname_1940_plain_with_replacements,"([^ ]+)er$|([^ ]+)er |([^ ]+)ers$|([^ ]+)ers |([^ ]+)ing$|([^ ]+)ing |([^ ]+)ist$|([^ ]+)ist "), function(l) l[2])))][,original2:=str_squish(unlist(lapply(str_extract_all(indname_1940_plain_with_replacements,"([^ ]+)er$|([^ ]+)er |([^ ]+)ers$|([^ ]+)ers |([^ ]+)ing$|([^ ]+)ing |([^ ]+)ist$|([^ ]+)ist "), function(l) l[3])))][,`:=`(original=str_squish(original),original1=str_squish(original1),original2=str_squish(original2))]

ind_simplification_list.er_ist_ing <- unique(rbind(unique(temp[,c("original")]),unique(temp[,c("original1")][,`:=`(original=original1,original1=NULL)]),unique(temp[,c("original2")][,`:=`(original=original2,original2=NULL)])))[!is.na(original)]
ind_simplification_list.er_ist_ing <- ind_simplification_list.er_ist_ing[,stem:=gsub("([a-z]+)er$","\\1",str_extract(original,"([a-z]+)er$"))][is.na(stem),stem:=gsub("([a-z]+)ers$","\\1",str_extract(original,"([a-z]+)ers$"))][is.na(stem),stem:=gsub("([a-z]+)ing$","\\1",str_extract(original,"([a-z]+)ing$"))][is.na(stem),stem:=gsub("([a-z]+)ist$","\\1",str_extract(original,"([a-z]+)ist$"))]

## Manually change and add some variables
# TO-DO: Look for manual changes
## Manually change and add some variables
ind_simplification_list.er_ist_ing <- ind_simplification_list.er_ist_ing[original %in% c("engineer","engineers","engineering"),stem:="engineer"][original %in% c("ringing","ringer","ring"),stem:="ring"][original %in% c("dyeing","dyer"),stem:="dy"][original=="drier",stem:="dry"][original %in% c("desulphuring","desulphurizer"),stem:="desulphur"][original=="cataloguer",stem:="catalogue"][original %in% c("timber","timbering","timberland"),stem:="timber"][original %in% c("feather","feathers","featherer"),stem:="feather"][original %in% c("mitering","miter"),stem:="miter"][original %in% c("plaster","plasterer"),stem:="plaster"]

## Keep only those words that appear more than once
ind_simplification_list.er_ist_ing <- ind_simplification_list.er_ist_ing[,dup:=0 + duplicated(stem)][,dup:=max(dup),by=c("stem")][dup>0][,dup:=NULL]

## Add other words
# TO-DO

## Convert into word for the search
ind_simplification_list.er_ist_ing$original <- paste0(paste0("\\<",ind_simplification_list.er_ist_ing$original),"\\>")

## Use simplification list to change words
index_1940.indpar_edits$indname_1940_plain_with_replacements <- str_squish( mgsub(ind_simplification_list.er_ist_ing$original,ind_simplification_list.er_ist_ing$stem,index_1940.indpar_edits$indname_1940_plain_with_replacements,fixed=FALSE) )

index_1940.indpar_edits$parentheses1_1940_plain_with_replacements <- str_squish( mgsub(ind_simplification_list.er_ist_ing$original,ind_simplification_list.er_ist_ing$stem,index_1940.indpar_edits$parentheses1_1940_plain_with_replacements,fixed=FALSE) )

# 5. Creating a simplifaction list that we will combine with the one for 1930
ind_simplification_list_1930_and_1940 <- rbind(ind_simplification_list_1930_and_1940,ind_simplification_list)
ind_simplification_list.er_ist_ing_1930_and_1940 <- rbind(ind_simplification_list.er_ist_ing_1930_and_1940,ind_simplification_list.er_ist_ing)
rm(ind_replacement_list,ind_simplification_list,ind_simplification_list.er_ist_ing)

```

### 2.8.3. Using the combined simplication list
```{r}
# Keep only unique observations
ind_simplification_list_1930_and_1940 <- unique(ind_simplification_list_1930_and_1940)
ind_simplification_list.er_ist_ing_1930_and_1940 <- unique(ind_simplification_list.er_ist_ing_1930_and_1940)

# Replace words
## 1930
### ind_simplification_list
#### Title
index_1930.indpar_edits$indname_1930_plain_with_replacements <- str_squish( mgsub(ind_simplification_list_1930_and_1940$original_1,ind_simplification_list_1930_and_1940$stem,index_1930.indpar_edits$indname_1930_plain_with_replacements,fixed=FALSE) )
index_1930.indpar_edits$indname_1930_plain_with_replacements <- str_squish( mgsub(ind_simplification_list_1930_and_1940$original_2,ind_simplification_list_1930_and_1940$stem,index_1930.indpar_edits$indname_1930_plain_with_replacements,fixed=FALSE) )

#### Parentheses
index_1930.indpar_edits$parentheses1_1930_plain_with_replacements <- str_squish( mgsub(ind_simplification_list_1930_and_1940$original_1,ind_simplification_list_1930_and_1940$stem,index_1930.indpar_edits$parentheses1_1930_plain_with_replacements,fixed=FALSE) )
index_1930.indpar_edits$parentheses1_1930_plain_with_replacements <- str_squish( mgsub(ind_simplification_list_1930_and_1940$original_2,ind_simplification_list_1930_and_1940$stem,index_1930.indpar_edits$parentheses1_1930_plain_with_replacements,fixed=FALSE) )

### ind_simplification_list.er_ist_ing
index_1930.indpar_edits$indname_1930_plain_with_replacements <- str_squish( mgsub(ind_simplification_list.er_ist_ing_1930_and_1940$original,ind_simplification_list.er_ist_ing_1930_and_1940$stem,index_1930.indpar_edits$indname_1930_plain_with_replacements,fixed=FALSE) )
index_1930.indpar_edits$parentheses1_1930_plain_with_replacements <- str_squish( mgsub(ind_simplification_list.er_ist_ing_1930_and_1940$original,ind_simplification_list.er_ist_ing_1930_and_1940$stem,index_1930.indpar_edits$parentheses1_1930_plain_with_replacements,fixed=FALSE) )

## 1940
### ind_simplification_list
#### Title
index_1940.indpar_edits$indname_1940_plain_with_replacements <- str_squish( mgsub(ind_simplification_list_1930_and_1940$original_1,ind_simplification_list_1930_and_1940$stem,index_1940.indpar_edits$indname_1940_plain_with_replacements,fixed=FALSE) )
index_1940.indpar_edits$indname_1940_plain_with_replacements <- str_squish( mgsub(ind_simplification_list_1930_and_1940$original_2,ind_simplification_list_1930_and_1940$stem,index_1940.indpar_edits$indname_1940_plain_with_replacements,fixed=FALSE) )

#### Parentheses
index_1940.indpar_edits$parentheses1_1940_plain_with_replacements <- str_squish( mgsub(ind_simplification_list_1930_and_1940$original_1,ind_simplification_list_1930_and_1940$stem,index_1940.indpar_edits$parentheses1_1940_plain_with_replacements,fixed=FALSE) )
index_1940.indpar_edits$parentheses1_1940_plain_with_replacements <- str_squish( mgsub(ind_simplification_list_1930_and_1940$original_2,ind_simplification_list_1930_and_1940$stem,index_1940.indpar_edits$parentheses1_1940_plain_with_replacements,fixed=FALSE) )

### ind_simplification_list.er_ist_ing
#### Title
index_1940.indpar_edits$indname_1940_plain_with_replacements <- str_squish( mgsub(ind_simplification_list.er_ist_ing_1930_and_1940$original,ind_simplification_list.er_ist_ing_1930_and_1940$stem,index_1940.indpar_edits$indname_1940_plain_with_replacements,fixed=FALSE) )

#### Parentheses
index_1940.indpar_edits$parentheses1_1940_plain_with_replacements <- str_squish( mgsub(ind_simplification_list.er_ist_ing_1930_and_1940$original,ind_simplification_list.er_ist_ing_1930_and_1940$stem,index_1940.indpar_edits$parentheses1_1940_plain_with_replacements,fixed=FALSE) )

# Make sure we don't have combinations of the [tit] or [tit]

# Change: if tit or tit ---> tit
## 1930
index_1930.indpar_edits <- index_1930.indpar_edits[,indname_1930_plain_with_replacements:= str_squish(gsub("([a-z]+) or \\1 ","\\1 ",indname_1930_plain_with_replacements))][,indname_1930_plain_with_replacements:=str_squish( gsub("([a-z]+) or \\1$","\\1",indname_1930_plain_with_replacements) )]

index_1930.indpar_edits <- index_1930.indpar_edits[,parentheses1_1930_plain_with_replacements:= str_squish(gsub("([a-z]+) or \\1 ","\\1 ",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish( gsub("([a-z]+) or \\1$","\\1",parentheses1_1930_plain_with_replacements) )]

## 1940
index_1940.indpar_edits <- index_1940.indpar_edits[,indname_1940_plain_with_replacements:= str_squish(gsub("([a-z]+) or \\1 ","\\1 ",indname_1940_plain_with_replacements))][,indname_1940_plain_with_replacements:=str_squish( gsub("([a-z]+) or \\1$","\\1",indname_1940_plain_with_replacements) )]

index_1940.indpar_edits <- index_1940.indpar_edits[,parentheses1_1940_plain_with_replacements:= str_squish(gsub("([a-z]+) or \\1 ","\\1 ",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish( gsub("([a-z]+) or \\1$","\\1",parentheses1_1940_plain_with_replacements) )]


```

### 2.8.4. Stemming the title variables for 1930 and 1940
```{r}
# Stemming
## 1930
index_1930.indpar_edits <- merge(index_1930.indpar_edits,f_stem(index_1930.indpar_edits,indname_1930_plain_with_replacements,s=stemmed,flag_plus=1)[!is.na(indname_1930_plain_with_replacements) & !is.na(indname_1930_plain_with_replacements_stemmed) & indname_1930_plain_with_replacements_stemmed!= "" & indname_1930_plain_with_replacements_stemmed!= ""],by="indname_1930_plain_with_replacements",all=TRUE)
index_1930.indpar_edits <- merge(index_1930.indpar_edits,f_stem(index_1930.indpar_edits,parentheses1_1930_plain_with_replacements,s=stemmed,flag_plus=1)[!is.na(parentheses1_1930_plain_with_replacements) & !is.na(parentheses1_1930_plain_with_replacements_stemmed) & parentheses1_1930_plain_with_replacements_stemmed!= "" & parentheses1_1930_plain_with_replacements_stemmed!= ""],by="parentheses1_1930_plain_with_replacements",all=TRUE)

### Manually correcting some issues
index_1930.indpar_edits <- index_1930.indpar_edits[grepl('\\<engineer\\>|\\<engineers\\>|\\<engineering\\>',indname_1930_plain_with_replacements),indname_1930_plain_with_replacements_stemmed:=gsub("engin ","engineer ",indname_1930_plain_with_replacements_stemmed)][grepl('\\<engineer\\>|\\<engineers\\>|\\<engineering\\>',indname_1930_plain_with_replacements),indname_1930_plain_with_replacements_stemmed:=gsub("engin$","engineer",indname_1930_plain_with_replacements_stemmed)]
index_1930.indpar_edits <- index_1930.indpar_edits[grepl('\\<engineer\\>|\\<engineers\\>|\\<engineering\\>',parentheses1_1930_plain_with_replacements),parentheses1_1930_plain_with_replacements_stemmed:=gsub("engin ","engineer ",parentheses1_1930_plain_with_replacements_stemmed)][grepl('\\<engineer\\>|\\<engineers\\>|\\<engineering\\>',parentheses1_1930_plain_with_replacements),parentheses1_1930_plain_with_replacements_stemmed:=gsub("engin$","engineer",parentheses1_1930_plain_with_replacements_stemmed)]

## 1940
index_1940.indpar_edits <- merge(index_1940.indpar_edits,f_stem(index_1940.indpar_edits,indname_1940_plain_with_replacements,s=stemmed,flag_plus=1)[!is.na(indname_1940_plain_with_replacements) & !is.na(indname_1940_plain_with_replacements_stemmed) & indname_1940_plain_with_replacements_stemmed!= "" & indname_1940_plain_with_replacements_stemmed!= ""],by="indname_1940_plain_with_replacements",all=TRUE)
index_1940.indpar_edits <- merge(index_1940.indpar_edits,f_stem(index_1940.indpar_edits,parentheses1_1940_plain_with_replacements,s=stemmed,flag_plus=1)[!is.na(parentheses1_1940_plain_with_replacements) & !is.na(parentheses1_1940_plain_with_replacements_stemmed) & parentheses1_1940_plain_with_replacements_stemmed!= "" & parentheses1_1940_plain_with_replacements_stemmed!= ""],by="parentheses1_1940_plain_with_replacements",all=TRUE)

### Manually correcting some issues
index_1940.indpar_edits <- index_1940.indpar_edits[grepl('\\<engineer\\>|\\<engineers\\>|\\<engineering\\>',indname_1940_plain_with_replacements),indname_1940_plain_with_replacements_stemmed:=gsub("engin ","engineer ",indname_1940_plain_with_replacements_stemmed)][grepl('\\<engineer\\>|\\<engineers\\>|\\<engineering\\>',indname_1940_plain_with_replacements),indname_1940_plain_with_replacements_stemmed:=gsub("engin$","engineer",indname_1940_plain_with_replacements_stemmed)]
index_1940.indpar_edits <- index_1940.indpar_edits[grepl('\\<engineer\\>|\\<engineers\\>|\\<engineering\\>',parentheses1_1940_plain_with_replacements),parentheses1_1940_plain_with_replacements_stemmed:=gsub("engin ","engineer ",parentheses1_1940_plain_with_replacements_stemmed)][grepl('\\<engineer\\>|\\<engineers\\>|\\<engineering\\>',parentheses1_1940_plain_with_replacements),parentheses1_1940_plain_with_replacements_stemmed:=gsub("engin$","engineer",parentheses1_1940_plain_with_replacements_stemmed)]

# Reordering
## 1930
index_1930.indpar_edits <- merge(index_1930.indpar_edits,f_reorder(index_1930.indpar_edits,indname_1930_plain_with_replacements_stemmed,r=r)[!is.na(indname_1930_plain_with_replacements_stemmed) & !is.na(indname_1930_plain_with_replacements_stemmed) & indname_1930_plain_with_replacements_stemmed!= "" & indname_1930_plain_with_replacements_stemmed!= ""],by="indname_1930_plain_with_replacements_stemmed",all=TRUE)
index_1930.indpar_edits <- merge(index_1930.indpar_edits,f_reorder(index_1930.indpar_edits,parentheses1_1930_plain_with_replacements_stemmed,r=r)[!is.na(parentheses1_1930_plain_with_replacements_stemmed) & !is.na(parentheses1_1930_plain_with_replacements_stemmed) & parentheses1_1930_plain_with_replacements_stemmed!= "" & parentheses1_1930_plain_with_replacements_stemmed!= ""],by="parentheses1_1930_plain_with_replacements_stemmed",all=TRUE)

## 1940
index_1940.indpar_edits <- merge(index_1940.indpar_edits,f_reorder(index_1940.indpar_edits,indname_1940_plain_with_replacements_stemmed,r=r)[!is.na(indname_1940_plain_with_replacements_stemmed) & !is.na(indname_1940_plain_with_replacements_stemmed) & indname_1940_plain_with_replacements_stemmed!= "" & indname_1940_plain_with_replacements_stemmed!= ""],by="indname_1940_plain_with_replacements_stemmed",all=TRUE)
index_1940.indpar_edits <- merge(index_1940.indpar_edits,f_reorder(index_1940.indpar_edits,parentheses1_1940_plain_with_replacements_stemmed,r=r)[!is.na(parentheses1_1940_plain_with_replacements_stemmed) & !is.na(parentheses1_1940_plain_with_replacements_stemmed) & parentheses1_1940_plain_with_replacements_stemmed!= "" & parentheses1_1940_plain_with_replacements_stemmed!= ""],by="parentheses1_1940_plain_with_replacements_stemmed",all=TRUE)

```



# 3. Create dictionary of titles
We introduce some changes in the title's names and construct an ordered and unstemmed edited title.

## 3.1.  Change title names
Introduce some changes to the title name so as to reduce the number of unique titles later

### 3.1.1. Some functions
#### Functions to edit the titles 
```{r}
# Function that keeps all the different transformation of the title variable
f_title_edits_all <- function(X,tit,flag_par=0) {
  # flag_par=0  -> Eliminate parenthesis
  y <- copy(X)
  tit_ch <- deparse(substitute(tit))
  # Through the code we will simply use varp as the variable
  setnames(y, c(tit_ch),c("tit")) 
  y[,tit2:=f_clean_syms ( f_clean_words (  f_clean_conj( f_clean_punct ( tit )   )  ) )][,tit2:=mgsub(words_subs1$term,words_subs1$change,y$tit2,fixed=FALSE)][,tit2:=str_squish(tit2)]
  if (flag_par==0) {
    y[,tit3:=gsub("\\(|\\)","",tit2)][,tit3:=gsub("not enlisted|enlisted","",tit3)][,tit3:=str_squish(tit3)]
  } else {
    y[,tit3:=gsub("not enlisted|enlisted","",tit2)][,tit3:=gsub("\\(any\\)","",tit3)][,tit3:=gsub("\\( *\\)","",tit3)][,tit3:=str_squish(tit3)]
  }
  y[,tit4:=gsub("\\<manager superintendent\\>","manager",tit3)][,tit4:=gsub("\\<superintendent\\>","manager",tit4)][,tit4:=gsub("\\( *\\)","",tit4)][,tit4:=str_squish(tit4)]
  y[,tit5:=gsub("\\<foreman boss\\>|\\<boss foreman\\>|\\<boss master\\>|\\<foreman overseer\\>","foreman",tit4)][,tit5:=gsub("\\<boss\\>|\\<overseer\\>","foreman",tit5)][,tit5:=gsub("\\( *\\)","",tit5)][,tit5:=str_squish(tit5)]
  y[,tit6:=gsub("\\<hand man\\>|\\hand worker\\>|\\<man worker\\>","worker",tit5)][,tit6:=gsub("\\<yard man yard hand\\>","yard worker",tit6)][,tit6:=gsub("\\<hand\\>|\\<operative\\>|\\<employee\\>|\\<tender\\>","worker",tit6)][,tit6:=gsub("\\( *\\)","",tit6)][,tit6:=str_squish(tit6)]
  y[,tit7:=gsub("\\<machine hand\\>|\\<machine operator\\>|\\<machine tender\\>|\\<machine man\\>|\\<machine runner\\>","machine worker",tit6)][,tit7:=gsub("\\( *\\)","",tit7)][,tit7:=str_squish(tit7)]
  # Note: problem with occupations like hand cutter, hand sewer... The meaning is lost when we change it to worker cutter, worker sewer
  y[,tit8:=gsub("\\<proprietor\\>","owner",tit7)][,tit8:=gsub("\\( *\\)","",tit8)][,tit8:=gsub("\\<working out\\>","",tit8)][,tit8:=str_squish(tit8)]
  
  
  
  y[,tit9:=gsub("\\<day laborer\\>|\\<plantation laborer\\>|\\<farm laborer\\>","laborer",tit8)][,tit8:=gsub("\\( *\\)","",tit8)][,tit9:=str_squish(tit9)]
  
  setnames(y, c("tit","tit2","tit3","tit4","tit5","tit6","tit7","tit8","tit9"), c(tit_ch,paste0(deparse(substitute(tit)),"_round2"),paste0(deparse(substitute(tit)),"_round3"),paste0(deparse(substitute(tit)),"_round4"),paste0(deparse(substitute(tit)),"_round5"),paste0(deparse(substitute(tit)),"_round6"),paste0(deparse(substitute(tit)),"_round7"),paste0(deparse(substitute(tit)),"_round8"),paste0(deparse(substitute(tit)),"_round9")    )   
  )

}
# Function that only keeps the transformation of the specified round
f_title_edits <- function(X,tit,round,flag_par=0) {
  y <- copy(X)
  tit_ch <- deparse(substitute(tit))
  # Through the code we will simply use varp as the variable
  setnames(y, c(tit_ch),c("tit")) 
  
  if (round>=2) {
    y[,titnew:=f_clean_syms ( f_clean_words (  f_clean_conj( f_clean_punct ( tit )   )  ) )][,titnew:=mgsub(words_subs1$term,words_subs1$change,y$titnew,fixed=FALSE)][,titnew:=str_squish(titnew)]
    
    if (round>=3){
      if (flag_par==0) {
        y[,titnew:=gsub("\\(|\\)","",titnew)][,titnew:=gsub("not enlisted|enlisted","",titnew)][,titnew:=str_squish(titnew)]
      } else if (flag_par==1) {
        y[,titnew:=gsub("not enlisted|enlisted","",titnew)][,titnew:=gsub("\\( *any *\\)","",titnew)][,titnew:=gsub("\\( *\\)","",titnew)][,titnew:=str_squish(titnew)]
      }
      if (round>=4){
        y[,titnew:=gsub("\\<manager superintendent\\>","manager",titnew)][,titnew:=gsub("\\<superintendent\\>","manager",titnew)][,titnew:=gsub("\\( *\\)","",titnew)][,titnew:=str_squish(titnew)]
        
        if (round>=5){
          y[,titnew:=gsub("\\<foreman boss\\>|\\<boss foreman\\>|\\<boss master\\>|\\<foreman overseer\\>","foreman",titnew)][,titnew:=gsub("\\<boss\\>|\\<overseer\\>","foreman",titnew)][,titnew:=gsub("\\( *\\)","",titnew)][,titnew:=str_squish(titnew)]
          
          if (round>=6){
            # Note: problem with occupations like hand cutter, hand sewer... The meaning is lost when we change it to worker cutter, worker sewer
            y[,titnew:=gsub("\\<hand man\\>|\\hand worker\\>|\\<man worker\\>","worker",titnew)][,titnew:=gsub("\\<yard man yard hand\\>","yard worker",titnew)][,titnew:=gsub("\\<hand\\>|\\<operative\\>|\\<employee\\>|\\<tender\\>","worker",titnew)][,titnew:=gsub("\\( *\\)","",titnew)][,titnew:=str_squish(titnew)]
            
            if (round>=7){
              y[,titnew:=gsub("\\<machine hand\\>|\\<machine operator\\>|\\<machine tender\\>|\\<machine man\\>|\\<machine runner\\>","machine worker",titnew)][,titnew:=gsub("\\( *\\)","",titnew)][,titnew:=str_squish(titnew)]
              
              if (round>=8){
                y[,titnew:=gsub("\\<proprietor\\>","owner",titnew)][,titnew:=gsub("\\<working out\\>","",titnew)][,titnew:=gsub("\\( *\\)","",titnew)][,titnew:=str_squish(titnew)]
                
                if (round>=9){
                  y[,titnew:=gsub("\\<day laborer\\>|\\<plantation laborer\\>|\\<farm laborer\\>","laborer",titnew)][,titnew:=gsub("\\( *\\)","",titnew)][,titnew:=str_squish(tit)]
                }
              }
            }
          }
        }
      }
    }
  }
  setnames(y, 
            c("tit","titnew"), 
            c(   tit_ch,  paste0(deparse(substitute(tit)),"_round",deparse(substitute(round)))  )
   )
  
  return(y)
}

```

### 3.1.2 Splitting the parenthesis for the title
```{r}
# Extracting the non title part
title_edits.1930 <- index_1930[,c("id_1930","title_1930")][,title_1930:=tolower(str_squish(gsub("\\(.*?)","",title_1930)))][,title_1930:=gsub("\\(|\\)","",title_1930)][,title_1930:=str_squish(title_1930)]
# Change "aa, bb or cc" to "aa or bb or cc". This will allow us later to separate the industries 
title_edits.1930[,title_1930:=gsub("([^,]+), ([^,]+), ([^ ]+) or ([^ ]+)","\\1 or \\2 or \\3 or \\4",title_1930)][,title_1930:=gsub("([^,]+), ([^ ]+) or ([^ ]+)","\\1 or \\2 or \\3",title_1930)][,title_1930:=str_squish(gsub(","," ",title_1930))]

title_edits.1940 <- index_1940[,c("id_1940","title_1940")][,title_1940:=tolower(str_squish(gsub("\\(.*?)","",title_1940)))][,title_1940:=gsub("\\(|\\)","",title_1940)][,title_1940:=str_squish(title_1940)]
# Change "aa, bb or cc" to "aa or bb or cc". This will allow us later to separate the industries 
title_edits.1940[,title_1940:=gsub("([^,]+), ([^,]+), ([^ ]+) or ([^ ]+)","\\1 or \\2 or \\3 or \\4",title_1940)][,title_1940:=gsub("([^,]+), ([^ ]+) or ([^ ]+)","\\1 or \\2 or \\3",title_1940)][,title_1940:=str_squish(gsub(","," ",title_1940))]


# Extracting the parenthesis part
## 0. Some titles are of the form part_1 (or part_2). This code would drop the parentheses
title_edits.1930 <- title_edits.1930[,title_1930:=gsub("\\(or (.*)\\)","or \\1",title_1930)]

title_edits.1940 <- title_edits.1940[,title_1940:=gsub("\\(or (.*)\\)","or \\1",title_1940)]

## 1. Extracting parentheses terms
A_1930 <- index_1930[,c("id_1930","title_1930")][,parentheses1_1930:=f_par(title_1930,1)][,parentheses1_1930:=gsub("([^,]+), ([^,]+), ([^ ]+) or ([^ ]+)","\\1 or \\2 or \\3 or \\4",parentheses1_1930)][,parentheses1_1930:=gsub("([^,]+), ([^ ]+) or (.+)","\\1 or \\2 or \\3",parentheses1_1930)][,parentheses1_1930:=str_squish(gsub(","," ",parentheses1_1930))]

A_1940 <- index_1940[,c("id_1940","title_1940")][,parentheses1_1940:=f_par(title_1940,1)][,parentheses1_1940:=gsub("([^,]+), ([^,]+), ([^ ]+) or ([^ ]+)","\\1 or \\2 or \\3 or \\4",parentheses1_1940)][,parentheses1_1940:=gsub("([^,]+), ([^ ]+) or (.+)","\\1 or \\2 or \\3",parentheses1_1940)][,parentheses1_1940:=str_squish(gsub(","," ",parentheses1_1940))]

# Constructing other variables
## 1. Dealing with any and except
### 1930
a <- f_any_except(title_edits.1930[,c("id_1930","title_1930")],title_1930,name="_tit")
b <- f_any_except(A_1930[,c("id_1930","parentheses1_1930")],parentheses1_1930,name="_par1")
title_edits.1930 <- merge(a[,title_1930:=NULL],b[,parentheses1_1930:=NULL],by="id_1930",all=TRUE)
title_edits.1930[,`:=`(army=pmax(army_tit, army_par1),no_army=pmax(no_army_tit, no_army_par1))][,c("army_tit","no_army_tit","army_par1","no_army_par1"):=NULL]
# pmax is vectorized (parallel) max
title_edits.1930[,any:=ifelse(!is.na(any_tit),any_tit,any_par1)][,except:=ifelse(!is.na(except_tit),except_tit,except_par1)][,c("any_tit","except_tit","any_par1","except_par1"):=NULL]
# Replace empty cell with NA
title_edits.1930 <- title_edits.1930[,c("title_1930_plain","parentheses1_1930_plain"):=lapply(.SD,function(x) ifelse(x=="",NA,x)),.SDcols=c("title_1930_plain","parentheses1_1930_plain")]
rm(a,b,A_1930)

a <- f_any_except(title_edits.1940[,c("id_1940","title_1940")],title_1940,name="_tit")
b <- f_any_except(A_1940[,c("id_1940","parentheses1_1940")],parentheses1_1940,name="_par1")
title_edits.1940 <- merge(a[,title_1940:=NULL],b[,parentheses1_1940:=NULL],by="id_1940",all=TRUE)
title_edits.1940[,`:=`(army=pmax(army_tit, army_par1),no_army=pmax(no_army_tit, no_army_par1))][,c("army_tit","no_army_tit","army_par1","no_army_par1"):=NULL]
# pmax is vectorized (parallel) max
title_edits.1940[,any:=ifelse(!is.na(any_tit),any_tit,any_par1)][,except:=ifelse(!is.na(except_tit),except_tit,except_par1)][,c("any_tit","except_tit","any_par1","except_par1"):=NULL]
# Replace empty cell with NA
title_edits.1940 <- title_edits.1940[,c("title_1940_plain","parentheses1_1940_plain"):=lapply(.SD,function(x) ifelse(x=="",NA,x)),.SDcols=c("title_1940_plain","parentheses1_1940_plain")]
rm(a,b,A_1940)

## 2. Mix with orginal title
title_edits.1930 <- merge(index_1930[,c("id_1930","title_1930")],title_edits.1930,by=c("id_1930"),all=TRUE)
title_edits.1940 <- merge(index_1940[,c("id_1940","title_1940")],title_edits.1940,by=c("id_1940"),all=TRUE)

## 3. Dealing with ns
title_edits.1930[,ns:=0][grepl('\\<ns\\>',title_1930_plain),ns:=1][grepl('\\<ns\\>',parentheses1_1930_plain),ns:=1]
title_edits.1930[,title_1930_plain:=gsub("\\<ns\\>|\\<or ns\\>","",title_1930_plain)][,parentheses1_1930_plain:=gsub("\\<ns\\>|\\<or ns\\>","",parentheses1_1930_plain)][,title_1930_plain:=f_clean_words(f_clean_syms(title_1930_plain))][,parentheses1_1930_plain:=f_clean_words(f_clean_syms(parentheses1_1930_plain))]

title_edits.1940[,ns:=0][grepl('\\<ns\\>',title_1940_plain),ns:=1][grepl('\\<ns\\>',parentheses1_1940_plain),ns:=1]
title_edits.1940[,title_1940_plain:=gsub("\\<ns\\>|\\<or ns\\>","",title_1940_plain)][,parentheses1_1940_plain:=gsub("\\<ns\\>|\\<or ns\\>","",parentheses1_1940_plain)][,title_1940_plain:=f_clean_words(f_clean_syms(title_1940_plain))][,parentheses1_1940_plain:=f_clean_words(f_clean_syms(parentheses1_1940_plain))]

## 4. Flag for woman, girl, boy (excluded category would be man)
title_edits.1930[,c("woman","girl","maid","boy"):=0][grepl('woman',title_1930_plain),woman:=1][grepl('girl',title_1930_plain),girl:=1][grepl('maid',title_1930_plain),girl:=1][grepl('boy',title_1930_plain),boy:=1]
title_edits.1940[,c("woman","girl","maid","boy"):=0][grepl('woman',title_1940_plain),woman:=1][grepl('girl',title_1940_plain),girl:=1][grepl('maid',title_1940_plain),girl:=1][grepl('boy',title_1940_plain),boy:=1]

# Convert values of the form "" to NA
title_edits.1930 <- title_edits.1930[,c("title_1930_plain","parentheses1_1930_plain"):=lapply(.SD,function(x) ifelse(x=="",NA,x)),.SDcols=c("title_1930_plain","parentheses1_1930_plain")]

title_edits.1940 <- title_edits.1940[,c("title_1940_plain","parentheses1_1940_plain"):=lapply(.SD,function(x) ifelse(x=="",NA,x)),.SDcols=c("title_1940_plain","parentheses1_1940_plain")]

```

## 3.2. Stemming title
*** NO: Reorder titles (to find repeated titles written in an inverse order) and stem words
### !!!!!!!!!! ---> Check that I have the f_par function!!!!!!!!!
### 3.2.2. Simplifying some cases, dropping some words...
#### 1930
```{r}
# 0.a. Homogenize gender (e.g. woman -> man, lady -> man, girl -> boy)
# NOTE: We need to decide if we also homogenize boy and man
title_edits.1930 <- title_edits.1930[,title_1930_plain_with_replacements:=str_squish(gsub("woman|lady|girl|boy|maid","man",title_1930_plain))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("woman|lady|girl|boy|maid","man",parentheses1_1930_plain))]

# 0.b. Change some words based on the Index
## Title
### Changes stipulated in the Index
title_edits.1930 <- title_edits.1930[,title_1930_plain_with_replacements:=str_squish(gsub("\\<superintendent\\>","manager",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<boss\\>|\\<overseer\\>","foreman",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<machine hand\\>|\\<machine tender\\>|\\<machine worker\\>","machine operator",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<drill press hand\\>|\\<drill presser\\>|\\<drill pressman\\>","driller",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<day laborer\\>","laborer",title_1930_plain_with_replacements))]

### Other changes
title_edits.1930 <- title_edits.1930[,title_1930_plain_with_replacements:=str_squish(gsub("\\<authoress\\>","author",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<actress\\>","actor",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<therapeutist\\>","therapist",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<seamstress\\>","sewer",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<mender\\>","repairer",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<waitress\\>","waiter",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<arcer\\>","archer",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<builder\\>","maker",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<mistress\\>","master",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<postmistress\\>","postmaster",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<logging\\>","log",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<heckler\\>","hackler",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<knobbler\\>","knobber",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<masonry\\>","mason",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<lantern\\>","lamp",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<moulder\\>","molder",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<tailoress\\>","tailor",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<fixer\\>","repairer",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<merchant\\>|dealer merchant|merchant dealer","dealer",title_1930_plain_with_replacements))]
title_edits.1930 <- title_edits.1930[,title_1930_plain_with_replacements:=str_squish(gsub("\\<bartender\\>","barkeeper",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<scrubber\\>","sweeper",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<seamer\\>","sewer",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<slagger\\>","slager",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<stewardess\\>","steward",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<proprietor\\>","owner",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<raiser\\>","breeder",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<piler\\>","stacker",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<drover\\>","driver",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<exodonist\\>","exodontist",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<coper\\>","copper",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<cuter\\>","cutter",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<desinger\\>","designer",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<drier\\>","dryer",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<gagger\\>","gager",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<slinger\\>","swinger",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<weighter\\>","weigher",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<automobile\\>|\\<automotive\\>|\\<automobiles\\>","auto",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish(gsub("\\<concessionaire\\>","concessioner",title_1930_plain_with_replacements))]


## Parentheses
### Changes stipulated in the Index
title_edits.1930 <- title_edits.1930[,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<superintendent\\>","manager",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<boss\\>|\\<overseer\\>","foreman",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<machine hand\\>|\\<machine tender\\>|\\<machine worker\\>","machine operator",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<drill press hand\\>|\\<drill presser\\>|\\<drill pressman\\>","driller",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<day laborer\\>","laborer",parentheses1_1930_plain_with_replacements))]

### Other changes
title_edits.1930 <- title_edits.1930[,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<authoress\\>","author",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<actress\\>","actor",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<therapeutist\\>","therapist",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<seamstress\\>","sewer",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<mender\\>","repairer",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<waitress\\>","waiter",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<arcer\\>","archer",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<builder\\>","maker",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<mistress\\>","master",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<postmistress\\>","postmaster",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<logging\\>","log",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<heckler\\>","hackler",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<knobbler\\>","knobber",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<masonry\\>","mason",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<lantern\\>","lamp",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<merchant\\>|dealer merchant|merchant dealer","dealer",parentheses1_1930_plain_with_replacements))]
title_edits.1930 <- title_edits.1930[,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<moulder\\>","molder",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<tailoress\\>","tailor",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<fixer\\>","repairer",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<bartender\\>","barkeeper",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<scrubber\\>","sweeper",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<seamer\\>","sewer",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<slagger\\>","slager",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<stewardess\\>","steward",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<proprietor\\>","owner",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<raiser\\>","breeder",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<piler\\>","stacker",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<drover\\>","driver",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<exodonist\\>","exodontist",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<coper\\>","copper",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<cuter\\>","cutter",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<desinger\\>","designer",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<drier\\>","dryer",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<gagger\\>","gager",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<slinger\\>","swinger",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<weighter\\>","weigher",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<automobile\\>|\\<automotive\\>|\\<automobiles\\>","auto",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish(gsub("\\<concessionaire\\>","concessioner",parentheses1_1930_plain_with_replacements))]

# 0.c. Replace terms [tit] or [tit] ---> [tit]. 
# If we have [tit1] [tit] or [tit] [tit2] ---> [tit1] [tit] ([tit2]) e.g. shaker and shaker out --> shaker + out in parentheses
title_edits.1930 <- title_edits.1930[,temp:=gsub("(.*)(.+) or \\2 (.+)","\\3",str_extract(title_1930_plain_with_replacements,"(.*)(.+) or \\2 (.+)"))]
title_edits.1930 <- title_edits.1930[,parentheses1_1930_plain_with_replacements:= str_squish(
                                           ifelse(!is.na(temp) & is.na(parentheses1_1930_plain_with_replacements),    
                                                  temp,   
                                                  ifelse(!is.na(temp) & !is.na(parentheses1_1930_plain_with_replacements), 
                                                         paste(parentheses1_1930_plain_with_replacements,temp,sep=" "),
                                                         parentheses1_1930_plain_with_replacements))  )][,temp:=NULL]

title_edits.1930 <- title_edits.1930[,title_1930_plain_with_replacements:= str_squish(gsub("(.*)(.+) or \\2 (.+)","\\1\\2",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish( gsub("(.*)(.+) or \\2$","\\1\\2",title_1930_plain_with_replacements) )]
title_edits.1930 <- title_edits.1930[,parentheses1_1930_plain_with_replacements:= str_squish(gsub("(.*)(.+) or \\2 (.+)","\\1\\2 \\3",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish( gsub("(.*)(.+) or \\2$","\\1\\2",parentheses1_1930_plain_with_replacements) )]


# 0.c. Manually change some troublesome cases
# yard man or yard hand --> yard (hand)
# tongsman or tonger --> tong
title_edits.1930 <- title_edits.1930[title_1930_plain_with_replacements=="yard man or yard hand",`:=`(title_1930_plain_with_replacements="yard",parentheses1_1930_plain_with_replacements="hand")]
title_edits.1930 <- title_edits.1930[title_1930_plain_with_replacements=="tongsman or tonger",title_1930_plain_with_replacements:="tong"]

# 1a. Replace terms of the form [tit] or [tit]er ---> [tit]
## Create replacement list
replacement_list <- title_edits.1930[,c("title_1930_plain_with_replacements")][,stem:=gsub("(.+) or \\1er","\\1",str_extract(title_1930_plain_with_replacements,"(.+) or \\1er$"))][!is.na(stem)][,original_1:=paste0(str_squish(stem))][,original_2:=paste0(str_squish(stem),"er")][,change:=1]
temp <- title_edits.1930[,c("title_1930_plain_with_replacements")][,stem:=gsub("(.+) or \\1er ","\\1",str_extract(title_1930_plain_with_replacements,"(.+) or \\1er "))][!is.na(stem)][,original_1:=paste0(str_squish(stem))][,original_2:=paste0(str_squish(stem),"er")][,change:=1]
replacement_list <- rbind(replacement_list,temp,fill=TRUE)
simplification_list <- unique(replacement_list[,c("stem","original_1","original_2","change")])

## Check that replacement works
replacement_list <- replacement_list[change==1,check:=gsub("(.*)(.+) or \\2er$","\\1\\2",title_1930_plain_with_replacements)][change==1,check:=gsub("(.*)(.+) or \\2er ","\\1\\2 ",check)]

## Replace 
title_edits.1930 <- title_edits.1930[,title_1930_plain_with_replacements:=str_squish( gsub("(.*)(.+) or \\2er$","\\1\\2",title_1930_plain_with_replacements) )][,title_1930_plain_with_replacements:=str_squish( gsub("(.*)(.+) or \\2er ","\\1\\2 ",title_1930_plain_with_replacements) )]

# 1b. Replace terms of the form [tit] or [tit]r ---> [tit]
## Create replacement list
temp <- rbind(
          title_edits.1930[,c("title_1930_plain_with_replacements")][,stem:=gsub("(.+) or \\1r","\\1",str_extract(title_1930_plain_with_replacements,"(.+) or \\1r$"))][!is.na(stem)][,original_1:=paste0(str_squish(stem))][,original_2:=paste0(str_squish(stem),"r")][,change:=1.5],
          title_edits.1930[,c("title_1930_plain_with_replacements")][,stem:=gsub("(.+) or \\1r ","\\1",str_extract(title_1930_plain_with_replacements,"(.+) or \\1r "))][!is.na(stem)][,original_1:=paste0(str_squish(stem))][,original_2:=paste0(str_squish(stem),"r")][,change:=1.5]
             )
replacement_list <- rbind(replacement_list,temp,fill=TRUE)
simplification_list <- rbind(simplification_list,unique(temp[,c("stem","original_1","original_2","change")]))

## Check that replacement works
replacement_list <- replacement_list[change==1.5,check:=gsub("(.*)(.+) or \\2r ","\\1\\2 ",title_1930_plain_with_replacements)][change==1.5,check:=gsub("(.*)(.+) or \\2r$","\\1\\2",check)]

## Replace 
title_edits.1930 <- title_edits.1930[,title_1930_plain_with_replacements:=str_squish( gsub("(.*)(.+) or \\2r ","\\1\\2 ",title_1930_plain_with_replacements) )][,title_1930_plain_with_replacements:=str_squish( gsub("(.*)(.+) or \\2r$","\\1\\2",title_1930_plain_with_replacements) )]

# 2a. Replace terms of the form [tit]er or [tit] ---> [tit]
## Create replacement list
temp <- rbind(
          title_edits.1930[,c("title_1930_plain_with_replacements")][,stem:=gsub("(.+)er or \\1","\\1",str_extract(title_1930_plain_with_replacements,"(.+)er or \\1$"))][!is.na(stem)][,original_1:=paste0(str_squish(stem),"er")][,original_2:=paste0(str_squish(stem))][,change:=2],
          title_edits.1930[,c("title_1930_plain_with_replacements")][,stem:=gsub("(.+)er or \\1 ","\\1",str_extract(title_1930_plain_with_replacements,"(.+)er or \\1 "))][!is.na(stem)][,original_1:=paste0(str_squish(stem),"er")][,original_2:=paste0(str_squish(stem))][,change:=2]
             )
# Old way
#temp <- title_edits.1930[,c("title_1930_plain_with_replacements")][,stem:=gsub("(.+)er or \\1 (.+)","\\1",str_extract(title_1930_plain_with_replacements,"(.+)er or \\1 (.+)"))][!is.na(stem)][,original_1:=paste0(stem,"er")][,original_2:=paste0(stem)][,change:=2]

replacement_list <- rbind(replacement_list,temp,fill=TRUE)
simplification_list <- rbind(simplification_list,unique(temp[,c("stem","original_1","original_2","change")]))

## Check that replacement works
#replacement_list <- replacement_list[change==2,check:=gsub("(.+)er or \\1 (.+)","\\1 \\2",title_1930_plain_with_replacements)]
replacement_list <- replacement_list[change==2,check:=gsub("(.+)er or \\1$","\\1",title_1930_plain_with_replacements)][change==2,check:=gsub("(.+)er or \\1 ","\\1 ",check)]

## Replace 
title_edits.1930 <- title_edits.1930[,title_1930_plain_with_replacements:=str_squish( gsub("(.+)er or \\1$","\\1",title_1930_plain_with_replacements) )][,title_1930_plain_with_replacements:=str_squish( gsub("(.+)er or \\1 ","\\1 ",title_1930_plain_with_replacements) )]

# 2b. Replace terms of the form [tit]r or [tit] ---> [tit]
## Create replacement list
temp <- rbind(
          title_edits.1930[,c("title_1930_plain_with_replacements")][,stem:=gsub("(.+)r or \\1","\\1",str_extract(title_1930_plain_with_replacements,"(.+)r or \\1$"))][!is.na(stem)][,original_1:=paste0(str_squish(stem),"r")][,original_2:=paste0(str_squish(stem))][,change:=2.5],
          title_edits.1930[,c("title_1930_plain_with_replacements")][,stem:=gsub("(.+)r or \\1 ","\\1",str_extract(title_1930_plain_with_replacements,"(.+)r or \\1 "))][!is.na(stem)][,original_1:=paste0(str_squish(stem),"r")][,original_2:=paste0(str_squish(stem))][,change:=2.5]
             )
replacement_list <- rbind(replacement_list,temp,fill=TRUE)
simplification_list <- rbind(simplification_list,unique(temp[,c("stem","original_1","original_2","change")]))

## Check that replacement works
replacement_list <- replacement_list[change==2.5,check:=gsub("([a-z]+)r or \\1$","\\1",title_1930_plain_with_replacements)][change==2.5,check:=gsub("([a-z]+)r or \\1 ","\\1 ",check)]

## Replace 
title_edits.1930 <- title_edits.1930[,title_1930_plain_with_replacements:=str_squish( gsub("([a-z]+)r or \\1$","\\1",title_1930_plain_with_replacements) )][,title_1930_plain_with_replacements:=str_squish( gsub("([a-z]+)r or \\1 ","\\1 ",title_1930_plain_with_replacements) )]

# 3. Replace titles of the form [tit] or [tit]man ( e.g. beater or beaterman)
temp <- rbind(
          title_edits.1930[,c("title_1930_plain_with_replacements")][,stem:=gsub("(.+) or \\1man","\\1",str_extract(title_1930_plain_with_replacements,"([a-z]+) or \\1man$"))][!is.na(stem)][,original_1:=paste0(str_squish(stem))][,original_2:=paste0(str_squish(stem),"man")][,change:=3],
          title_edits.1930[,c("title_1930_plain_with_replacements")][,stem:=gsub("(.+) or \\1man ","\\1",str_extract(title_1930_plain_with_replacements,"([a-z]+) or \\1man "))][!is.na(stem)][,original_1:=paste0(str_squish(stem))][,original_2:=paste0(str_squish(stem),"man")][,change:=3]
             )
replacement_list <- rbind(replacement_list,temp,fill=TRUE)
simplification_list <- rbind(simplification_list,unique(temp[,c("stem","original_1","original_2","change")]))

## Check that replacement works
replacement_list <- replacement_list[change==3,check:=sub("([a-z]+) or \\1man$","\\1",title_1930_plain_with_replacements)][change==3,check:=gsub("([a-z]+) or \\1man ","\\1 ",check)]

## Replace 
title_edits.1930 <- title_edits.1930[,title_1930_plain_with_replacements:=str_squish( gsub("([a-z]+) or \\1man$","\\1",title_1930_plain_with_replacements) )][,title_1930_plain_with_replacements:=str_squish( gsub("([a-z]+) or \\1man ","\\1 ",title_1930_plain_with_replacements) )]


# 4. Replace titles of the form [tit]man or [tit] ( e.g. )
temp <- rbind(
              title_edits.1930[,c("title_1930_plain_with_replacements")][,stem:=gsub("([a-z]+)man or \\1 ","\\1",str_extract(title_1930_plain_with_replacements,"([a-z]+)man or \\1 "))][!is.na(stem)][,original_1:=paste0(stem,"man")][,original_2:=paste0(stem)][,change:=4],
              title_edits.1930[,c("title_1930_plain_with_replacements")][,stem:=gsub("([a-z]+)man or \\1","\\1",str_extract(title_1930_plain_with_replacements,"([a-z]+)man or \\1$"))][!is.na(stem)][,original_1:=paste0(stem,"man")][,original_2:=paste0(stem)][,change:=4]
              )

replacement_list <- rbind(replacement_list,temp,fill=TRUE)
simplification_list <- rbind(simplification_list,unique(temp[,c("stem","original_1","original_2","change")]))

## Check that replacement works
replacement_list <- replacement_list[change==4,check:=gsub("([a-z]+)man or \\1 ","\\1 ",title_1930_plain_with_replacements)][change==4,check:=gsub("([a-z]+)man or \\1$","\\1",check)]

## Replace 
title_edits.1930 <- title_edits.1930[,title_1930_plain_with_replacements:=str_squish( gsub("([a-z]+)man or \\1 ","\\1 ",title_1930_plain_with_replacements) )][,title_1930_plain_with_replacements:=str_squish( gsub("([a-z]+)man or \\1$","\\1",title_1930_plain_with_replacements) )]


# 5. Replace titles of the form [tit]er or [tit]man
temp <- rbind(
                title_edits.1930[,c("title_1930_plain_with_replacements")][,stem:=gsub("([a-z]+)er or \\1man ","\\1",str_extract(title_1930_plain_with_replacements,"([a-z]+)er or \\1man "))][!is.na(stem)][,original_1:=paste0(stem,"er")][,original_2:=paste0(stem,"man")][,change:=5],
                title_edits.1930[,c("title_1930_plain_with_replacements")][,stem:=gsub("([a-z]+)er or \\1man$","\\1",str_extract(title_1930_plain_with_replacements,"([a-z]+)er or \\1man$"))][!is.na(stem)][,original_1:=paste0(stem,"er")][,original_2:=paste0(stem,"man")][,change:=5]
            )

replacement_list <- rbind(replacement_list,temp,fill=TRUE)
simplification_list <- rbind(simplification_list,unique(temp[,c("stem","original_1","original_2","change")]))

## Check that replacement works
replacement_list <- replacement_list[change==5,check:=gsub("([a-z]+)er or \\1man ","\\1 ",title_1930_plain_with_replacements)][change==5,check:=gsub("([a-z]+)er or \\1man$","\\1",check)]

## Replace 
title_edits.1930 <- title_edits.1930[,title_1930_plain_with_replacements:=str_squish( gsub("([a-z]+)er or \\1man ","\\1 ",title_1930_plain_with_replacements) )][,title_1930_plain_with_replacements:=str_squish( gsub("([a-z]+)er or \\1man$","\\1",title_1930_plain_with_replacements) )]


# 6. Replace titles of the form [tit]man or [tit]er
temp <- rbind(
              title_edits.1930[,c("title_1930_plain_with_replacements")][,stem:=gsub("([a-z]+)man or \\1er ","\\1",str_extract(title_1930_plain_with_replacements,"([a-z]+)man or \\1er "))][!is.na(stem)][,original_1:=paste0(stem,"man")][,original_2:=paste0(stem,"er")][,change:=6],
              title_edits.1930[,c("title_1930_plain_with_replacements")][,stem:=gsub("([a-z]+)man or \\1er","\\1",str_extract(title_1930_plain_with_replacements,"([a-z]+)man or \\1er$"))][!is.na(stem)][,original_1:=paste0(stem,"man")][,original_2:=paste0(stem,"er")][,change:=6]
              )

replacement_list <- rbind(replacement_list,temp,fill=TRUE)
simplification_list <- rbind(simplification_list,unique(temp[,c("stem","original_1","original_2","change")]))

## Check that replacement works
replacement_list <- replacement_list[change==6,check:=gsub("([a-z]+)man or \\1er ","\\1 ",title_1930_plain_with_replacements)][change==6,check:=gsub("([a-z]+)man or \\1er$","\\1",check)]

## Replace 
title_edits.1930 <- title_edits.1930[,title_1930_plain_with_replacements:=str_squish( gsub("([a-z]+)man or \\1er ","\\1 ",title_1930_plain_with_replacements) )][,title_1930_plain_with_replacements:=str_squish( gsub("([a-z]+)man or \\1er$","\\1$",title_1930_plain_with_replacements) )]

# 7. Replace titles of the form [tit]r or [tit]man e.g. bridger or bridgeman
temp <- rbind(
              title_edits.1930[,c("title_1930_plain_with_replacements")][,stem:=gsub("([a-z]+)r or \\1man ","\\1",str_extract(title_1930_plain_with_replacements,"([a-z]+)r or \\1man "))][!is.na(stem)][,original_1:=paste0(stem,"r")][,original_2:=paste0(stem,"man")][,change:=7],
              title_edits.1930[,c("title_1930_plain_with_replacements")][,stem:=gsub("([a-z]+)r or \\1man","\\1",str_extract(title_1930_plain_with_replacements,"([a-z]+)r or \\1man$"))][!is.na(stem)][,original_1:=paste0(stem,"r")][,original_2:=paste0(stem,"man")][,change:=7]
)

replacement_list <- rbind(replacement_list,temp,fill=TRUE)
simplification_list <- rbind(simplification_list,unique(temp[,c("stem","original_1","original_2","change")]))

## Check that replacement works
replacement_list <- replacement_list[change==7,check:=gsub("([a-z]+)r or \\1man ","\\1 ",title_1930_plain_with_replacements)][change==7,check:=gsub("([a-z]+)r or \\1man$","\\1",check)]

## Replace 
title_edits.1930 <- title_edits.1930[,title_1930_plain_with_replacements:=str_squish( gsub("([a-z]+)r or \\1man ","\\1 ",title_1930_plain_with_replacements) )][,title_1930_plain_with_replacements:=str_squish( gsub("([a-z]+)r or \\1man$","\\1",title_1930_plain_with_replacements) )]


# 8. Replace titles of the form [tit]man or [tit]r
temp <- rbind(
              title_edits.1930[,c("title_1930_plain_with_replacements")][,stem:=gsub("([a-z]+)man or \\1r ","\\1",str_extract(title_1930_plain_with_replacements,"([a-z]+)man or \\1r "))][!is.na(stem)][,original_1:=paste0(stem,"man")][,original_2:=paste0(stem,"r")][,change:=8],
              title_edits.1930[,c("title_1930_plain_with_replacements")][,stem:=gsub("([a-z]+)man or \\1r","\\1",str_extract(title_1930_plain_with_replacements,"([a-z]+)man or \\1r$"))][!is.na(stem)][,original_1:=paste0(stem,"man")][,original_2:=paste0(stem,"r")][,change:=8]
)

replacement_list <- rbind(replacement_list,temp,fill=TRUE)
simplification_list <- rbind(simplification_list,unique(temp[,c("stem","original_1","original_2","change")]))

## Check that replacement works
replacement_list <- replacement_list[change==8,check:=gsub("([a-z]+)man or \\1r ","\\1 ",title_1930_plain_with_replacements)][change==8,check:=gsub("([a-z]+)man or \\1r$","\\1",check)]

## Replace 
title_edits.1930 <- title_edits.1930[,title_1930_plain_with_replacements:=str_squish( gsub("([a-z]+)man or \\1r ","\\1 ",title_1930_plain_with_replacements) )][,title_1930_plain_with_replacements:=str_squish( gsub("([a-z]+)man or \\1r$","\\1",title_1930_plain_with_replacements) )]


# 9. Use the simplification list to change words
## We will only replace COMPLETE words
simplification_list$original_1 <- paste0(paste0("\\<",simplification_list$original_1),"\\>")
simplification_list$original_2 <- paste0(paste0("\\<",simplification_list$original_2),"\\>")

## Title
title_edits.1930$title_1930_plain_with_replacements <- str_squish( mgsub(simplification_list$original_1,simplification_list$stem,title_edits.1930$title_1930_plain_with_replacements,fixed=FALSE) )
title_edits.1930$title_1930_plain_with_replacements <- str_squish( mgsub(simplification_list$original_2,simplification_list$stem,title_edits.1930$title_1930_plain_with_replacements,fixed=FALSE) )

# Parentheses
title_edits.1930$parentheses1_1930_plain_with_replacements <- str_squish( mgsub(simplification_list$original_1,simplification_list$stem,title_edits.1930$parentheses1_1930_plain_with_replacements,fixed=FALSE) )
title_edits.1930$parentheses1_1930_plain_with_replacements <- str_squish( mgsub(simplification_list$original_2,simplification_list$stem,title_edits.1930$parentheses1_1930_plain_with_replacements,fixed=FALSE) )

# Change parenthesis: if tit or tit ---> tit
#title_edits.1930 <- title_edits.1930[,parentheses1_1930_plain_with_replacements:= str_squish(gsub("(.+) (.+) or \\2([^a-z]+)","\\1 \\2\\3",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish( gsub("^(.+) or \\1([^a-z]+)","\\1\\2",parentheses1_1930_plain_with_replacements) )]
title_edits.1930 <- title_edits.1930[,parentheses1_1930_plain_with_replacements:= str_squish(gsub("([a-z]+) or \\1 ","\\1 ",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish( gsub("([a-z]+) or \\1$","\\1",parentheses1_1930_plain_with_replacements) )]

# if "[tit] or man" -> [tit]
title_edits.1930 <- title_edits.1930[,parentheses1_1930_plain_with_replacements:= str_squish(gsub("([a-z]+) or man$","\\1",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:= str_squish(gsub("([a-z]+) or man ","\\1 ",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:= str_squish(gsub("^or man$","",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:= str_squish(gsub("^man or ([a-z]+) ","\\1 ",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:= str_squish(gsub("^man or ([a-z]+)$","\\1",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:= str_squish(gsub("^or (.+)$","\\1",parentheses1_1930_plain_with_replacements))]

#***** dealing with MAN or WORK
# 10. Replace titles of the form [tit] man or [tit2] --> [tit] ([tit2])
title_edits.1930 <- title_edits.1930[,temp:=gsub("(.+) man or (.+)","\\2",str_extract(title_1930_plain_with_replacements,"(.+) man or (.+)"))]
title_edits.1930 <- title_edits.1930[,parentheses1_1930_plain_with_replacements:= str_squish(
                                           ifelse(!is.na(temp) & is.na(parentheses1_1930_plain_with_replacements),    
                                                  temp,   
                                                  ifelse(!is.na(temp) & !is.na(parentheses1_1930_plain_with_replacements), 
                                                         paste(parentheses1_1930_plain_with_replacements,temp,sep=" "),
                                                         parentheses1_1930_plain_with_replacements))  )]

title_edits.1930 <- title_edits.1930[,title_1930_plain_with_replacements:= str_squish(gsub("(.+) man or (.+)","\\1",title_1930_plain_with_replacements))]

# 11. Replace titles of the form [tit] [tit2] or man --> [tit] ([tit2])
title_edits.1930 <- title_edits.1930[,temp:=gsub("(.+) (.+) or man","\\2",str_extract(title_1930_plain_with_replacements,"(.+) (.+) or man$"))]
title_edits.1930 <- title_edits.1930[,parentheses1_1930_plain_with_replacements:= str_squish(
                                           ifelse(!is.na(temp) & is.na(parentheses1_1930_plain_with_replacements),    
                                                  temp,   
                                                  ifelse(!is.na(temp) & !is.na(parentheses1_1930_plain_with_replacements), 
                                                         paste(parentheses1_1930_plain_with_replacements,temp,sep=" "),
                                                         parentheses1_1930_plain_with_replacements))  )][,temp:=NULL]

title_edits.1930 <- title_edits.1930[,title_1930_plain_with_replacements:= str_squish(gsub("(.+) (.+) or man$","\\1",title_1930_plain_with_replacements))]

# 12. Drop words with man
title_edits.1930 <- title_edits.1930[,title_1930_plain_with_replacements := str_squish(gsub("\\<mans\\>","",title_1930_plain_with_replacements))]
title_edits.1930 <- title_edits.1930[,title_1930_plain_with_replacements := str_squish(gsub("([^ ]+)mans$","\\1",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements := str_squish(gsub("([^ ]+)mans (.+)","\\1 \\2",title_1930_plain_with_replacements))]
title_edits.1930 <- title_edits.1930[,title_1930_plain_with_replacements := str_squish(gsub("\\<man\\>","",title_1930_plain_with_replacements))]
title_edits.1930 <- title_edits.1930[,title_1930_plain_with_replacements := str_squish(gsub("([^ ]+)man$","\\1",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements := str_squish(gsub("([^ ]+)man (.+)","\\1 \\2",title_1930_plain_with_replacements))]

title_edits.1930 <- title_edits.1930[,parentheses1_1930_plain_with_replacements := str_squish(gsub("\\<mans\\>","",parentheses1_1930_plain_with_replacements))]
title_edits.1930 <- title_edits.1930[,parentheses1_1930_plain_with_replacements := str_squish(gsub("([^ ]+)mans$","\\1",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements := str_squish(gsub("([^ ]+)mans (.+)","\\1 \\2",parentheses1_1930_plain_with_replacements))]
title_edits.1930 <- title_edits.1930[,parentheses1_1930_plain_with_replacements := str_squish(gsub("\\<man\\>","",parentheses1_1930_plain_with_replacements))]
title_edits.1930 <- title_edits.1930[,parentheses1_1930_plain_with_replacements := str_squish(gsub("([^ ]+)man$","\\1",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements := str_squish(gsub("([^ ]+)man (.+)","\\1 \\2",parentheses1_1930_plain_with_replacements))]

# 13. Replace certain words that include "work" with employee
title_edits.1930 <- title_edits.1930[title_1930_plain_with_replacements %in% c("employee or work","work","work man","working out","works out","work or works","works or work","works at","working"),title_1930_plain_with_replacements := "employee"]

# 14. Replace titles of the form [tit] work or [tit2] --> [tit] ([tit2])
title_edits.1930 <- title_edits.1930[,temp:=gsub("(.+) work or (.+)","\\2",str_extract(title_1930_plain_with_replacements,"(.+) work or (.+)"))]
title_edits.1930 <- title_edits.1930[,parentheses1_1930_plain_with_replacements:= str_squish(
                                           ifelse(!is.na(temp) & is.na(parentheses1_1930_plain_with_replacements),    
                                                  temp,   
                                                  ifelse(!is.na(temp) & !is.na(parentheses1_1930_plain_with_replacements), 
                                                         paste(parentheses1_1930_plain_with_replacements,temp,sep=" "),
                                                         parentheses1_1930_plain_with_replacements))  )][,temp:=NULL]

title_edits.1930 <- title_edits.1930[,title_1930_plain_with_replacements:= str_squish(gsub("(.+) work or (.+)","\\1",title_1930_plain_with_replacements))]

# 15. Replace titles of the form [tit] [tit2] or man --> [tit] ([tit2])
title_edits.1930 <- title_edits.1930[,temp:=gsub("(.+) (.+) or work","\\2",str_extract(title_1930_plain_with_replacements,"(.+) (.+) or work$"))]
title_edits.1930 <- title_edits.1930[,parentheses1_1930_plain_with_replacements:= str_squish(
                                           ifelse(!is.na(temp) & is.na(parentheses1_1930_plain_with_replacements),    
                                                  temp,   
                                                  ifelse(!is.na(temp) & !is.na(parentheses1_1930_plain_with_replacements), 
                                                         paste(parentheses1_1930_plain_with_replacements,temp,sep=" "),
                                                         parentheses1_1930_plain_with_replacements))  )][,temp:=NULL]

title_edits.1930 <- title_edits.1930[,title_1930_plain_with_replacements:= str_squish(gsub("(.+) (.+) or work$","\\1",title_1930_plain_with_replacements))]

# 16. Drop words with man
title_edits.1930 <- title_edits.1930[,title_1930_plain_with_replacements := str_squish(gsub("\\<works\\>","",title_1930_plain_with_replacements))]
title_edits.1930 <- title_edits.1930[,title_1930_plain_with_replacements := str_squish(gsub("([^ ]+)works$","\\1",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements := str_squish(gsub("([^ ]+)works (.+)","\\1 \\2",title_1930_plain_with_replacements))]
title_edits.1930 <- title_edits.1930[,title_1930_plain_with_replacements := str_squish(gsub("\\<work\\>","",title_1930_plain_with_replacements))]
title_edits.1930 <- title_edits.1930[,title_1930_plain_with_replacements := str_squish(gsub("([^ ]+)work$","\\1",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements := str_squish(gsub("([^ ]+)work (.+)","\\1 \\2",title_1930_plain_with_replacements))]

# If title is empty and parentheses has something related with work ---> employee in title
title_edits.1930 <- title_edits.1930[(is.na(title_1930_plain_with_replacements) | title_1930_plain_with_replacements=="") & (parentheses1_1930_plain_with_replacements %in% c("employee or work","work","work man","working out","works out","work or works","works or work","works at","working") ),`:=`(title_1930_plain_with_replacements = "employee",parentheses1_1930_plain_with_replacements=NA)][( is.na(title_1930_plain_with_replacements) | title_1930_plain_with_replacements=="") & !(parentheses1_1930_plain_with_replacements %in% c("employee or work","work","work man","working out","works out","work or works","works or work","works at","working") ),`:=`(title_1930_plain_with_replacements = parentheses1_1930_plain_with_replacements,parentheses1_1930_plain_with_replacements=NA)]

# 17. Dropping "work" in parentheses
title_edits.1930 <- title_edits.1930[,parentheses1_1930_plain_with_replacements := str_squish(gsub("\\<works\\>","",parentheses1_1930_plain_with_replacements))]
title_edits.1930 <- title_edits.1930[,parentheses1_1930_plain_with_replacements := str_squish(gsub("([^ ]+)works$","\\1",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements := str_squish(gsub("([^ ]+)works (.+)","\\1 \\2",parentheses1_1930_plain_with_replacements))]
title_edits.1930 <- title_edits.1930[,parentheses1_1930_plain_with_replacements := str_squish(gsub("\\<work\\>","",parentheses1_1930_plain_with_replacements))]
title_edits.1930 <- title_edits.1930[,parentheses1_1930_plain_with_replacements := str_squish(gsub("([^ ]+)work$","\\1",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements := str_squish(gsub("([^ ]+)work (.+)","\\1 \\2",parentheses1_1930_plain_with_replacements))]

# 18. Reduce words ending in -er, -ist, -ing to their stem
## Find out all the words ending in er, ing, ist
temp <- title_edits.1930[,c("title_1930_plain_with_replacements")][,original:=str_squish(unlist(lapply(str_extract_all(title_1930_plain_with_replacements,"([^ ]+)er$|([^ ]+)er |([^ ]+)ers$|([^ ]+)ers |([^ ]+)ing$|([^ ]+)ing |([^ ]+)ist$|([^ ]+)ist "), function(l) l[1])))][,original1:=str_squish(unlist(lapply(str_extract_all(title_1930_plain_with_replacements,"([^ ]+)er$|([^ ]+)er |([^ ]+)ers$|([^ ]+)ers |([^ ]+)ing$|([^ ]+)ing |([^ ]+)ist$|([^ ]+)ist "), function(l) l[2])))][,original2:=str_squish(unlist(lapply(str_extract_all(title_1930_plain_with_replacements,"([^ ]+)er$|([^ ]+)er |([^ ]+)ers$|([^ ]+)ers |([^ ]+)ing$|([^ ]+)ing |([^ ]+)ist$|([^ ]+)ist "), function(l) l[3])))][,`:=`(original=str_squish(original),original1=str_squish(original1),original2=str_squish(original2))]

simplification_list.er_ist_ing <- unique(rbind(unique(temp[,c("original")]),unique(temp[,c("original1")][,`:=`(original=original1,original1=NULL)]),unique(temp[,c("original2")][,`:=`(original=original2,original2=NULL)])))[!is.na(original)]
simplification_list.er_ist_ing <- simplification_list.er_ist_ing[,stem:=gsub("([a-z]+)er$","\\1",str_extract(original,"([a-z]+)er$"))][is.na(stem),stem:=gsub("([a-z]+)ers$","\\1",str_extract(original,"([a-z]+)ers$"))][is.na(stem),stem:=gsub("([a-z]+)ing$","\\1",str_extract(original,"([a-z]+)ing$"))][is.na(stem),stem:=gsub("([a-z]+)ist$","\\1",str_extract(original,"([a-z]+)ist$"))]

## Manually change and add some variables
simplification_list.er_ist_ing <- simplification_list.er_ist_ing[original %in% c("tonguer","tongue","tongues","tongueing"),stem:="tongue"][original %in% c("glazier","glaziers"),stem:="glaz"][original=="engineer",stem:="engineer"][original %in% c("ringing","ringer","ring"),stem:="ring"][original %in% c("dyeing","dyer"),stem:="dy"][original=="drier",stem:="dry"][original %in% c("desulphuring","desulphurizer"),stem:="desulphur"][original=="cataloguer",stem:="catalogue"][original %in% c("timber","timbering","timberland"),stem:="timber"][original %in% c("feather","feathers","featherer"),stem:="feather"][original %in% c("mitering","miter"),stem:="miter"][original %in% c("plaster","plasterer"),stem:="plaster"]

simplification_list.er_ist_ing <- simplification_list.er_ist_ing[,dup:=0 + duplicated(stem)][,dup:=max(dup),by=c("stem")][dup>0][,dup:=NULL]

simplification_list.er_ist_ing <-
  unique(
        rbind(simplification_list.er_ist_ing,
              data.table(original=c("tonguer","tongue","tongues","tongueing","milker","timber","timbering","timberland","cataloguer","catalogue","catalogues","silverer"), 
                         stem=c(rep("tongue",4),"milk",rep("timber",3),rep("catalogue",3),"silver" )
                        )
              )
  )
                                    

## Convert into word for the search
simplification_list.er_ist_ing$original <- paste0(paste0("\\<",simplification_list.er_ist_ing$original),"\\>")

## Use simplification list to change words
title_edits.1930$title_1930_plain_with_replacements <- str_squish( mgsub(simplification_list.er_ist_ing$original,simplification_list.er_ist_ing$stem,title_edits.1930$title_1930_plain_with_replacements,fixed=FALSE) )

title_edits.1930$parentheses1_1930_plain_with_replacements <- str_squish( mgsub(simplification_list.er_ist_ing$original,simplification_list.er_ist_ing$stem,title_edits.1930$parentheses1_1930_plain_with_replacements,fixed=FALSE) )


## Look again for titles of the form [tit] or [tit]
title_edits.1930 <- title_edits.1930[,temp:=gsub("(.*)(.+) or \\2 (.+)","\\3",str_extract(title_1930_plain_with_replacements,"(.*)(.+) or \\2 (.+)"))]
title_edits.1930 <- title_edits.1930[,parentheses1_1930_plain_with_replacements:= str_squish(
                                           ifelse(!is.na(temp) & is.na(parentheses1_1930_plain_with_replacements),    
                                                  temp,   
                                                  ifelse(!is.na(temp) & !is.na(parentheses1_1930_plain_with_replacements), 
                                                         paste(parentheses1_1930_plain_with_replacements,temp,sep=" "),
                                                         parentheses1_1930_plain_with_replacements))  )][,temp:=NULL]

title_edits.1930 <- title_edits.1930[,title_1930_plain_with_replacements:= str_squish(gsub("(.*)(.+) or \\2 (.+)","\\1\\2",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish( gsub("(.*)(.+) or \\2$","\\1\\2",title_1930_plain_with_replacements) )]
title_edits.1930 <- title_edits.1930[,parentheses1_1930_plain_with_replacements:= str_squish(gsub("(.*)(.+) or \\2 (.+)","\\1\\2 \\3",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish( gsub("(.*)(.+) or \\2$","\\1\\2",parentheses1_1930_plain_with_replacements) )]

# 19. Creating a simplifaction list that we will combine with the one for 1930
simplification_list_1930_and_1940 <- copy(simplification_list)
simplification_list.er_ist_ing_1930_and_1940 <- copy(simplification_list.er_ist_ing)
rm(replacement_list,simplification_list,simplification_list.er_ist_ing)

```

#### 1940
```{r}
# 0.a. Homogenize gender (e.g. woman -> man, lady -> man, girl -> boy)
# NOTE: We need to decide if we also homogenize boy and man
title_edits.1940 <- title_edits.1940[,title_1940_plain_with_replacements:=str_squish(gsub("woman|lady|girl|boy|maid","man",title_1940_plain))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("woman|lady|girl|boy|maid","man",parentheses1_1940_plain))]

# 0.b. Change some words based on the Index
## Title
### Changes stipulated in the Index
title_edits.1940 <- title_edits.1940[,title_1940_plain_with_replacements:=str_squish(gsub("\\<superintendent\\>","manager",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<boss\\>|\\<overseer\\>","foreman",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<machine hand\\>|\\<machine tender\\>|\\<machine worker\\>","machine operator",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<drill press hand\\>|\\<drill presser\\>|\\<drill pressman\\>","driller",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<day laborer\\>","laborer",title_1940_plain_with_replacements))]

### Other changes
title_edits.1940 <- title_edits.1940[,title_1940_plain_with_replacements:=str_squish(gsub("\\<authoress\\>","author",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<actress\\>","actor",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<therapeutist\\>","therapist",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<seamstress\\>","sewer",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<mender\\>","repairer",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<waitress\\>","waiter",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<arcer\\>","archer",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<builder\\>","maker",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<mistress\\>","master",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<postmistress\\>","postmaster",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<logging\\>","log",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<heckler\\>","hackler",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<knobbler\\>","knobber",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<masonry\\>","mason",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<lantern\\>","lamp",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<moulder\\>","molder",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<tailoress\\>","tailor",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<fixer\\>","repairer",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<merchant\\>|dealer merchant|merchant dealer","dealer",title_1940_plain_with_replacements))]
title_edits.1940 <- title_edits.1940[,title_1940_plain_with_replacements:=str_squish(gsub("\\<bartender\\>","barkeeper",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<scrubber\\>","sweeper",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<seamer\\>","sewer",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<slagger\\>","slager",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<stewardess\\>","steward",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<proprietor\\>","owner",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<raiser\\>","breeder",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<piler\\>","stacker",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<drover\\>","driver",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<exodonist\\>","exodontist",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<coper\\>","copper",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<cuter\\>","cutter",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<desinger\\>","designer",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<drier\\>","dryer",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<gagger\\>","gager",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<slinger\\>","swinger",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<weighter\\>","weigher",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<automobile\\>|\\<automotive\\>|\\<automobiles\\>","auto",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish(gsub("\\<concessionaire\\>","concessioner",title_1940_plain_with_replacements))]


## Parentheses
### Changes stipulated in the Index
title_edits.1940 <- title_edits.1940[,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<superintendent\\>","manager",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<boss\\>|\\<overseer\\>","foreman",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<machine hand\\>|\\<machine tender\\>|\\<machine worker\\>","machine operator",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<drill press hand\\>|\\<drill presser\\>|\\<drill pressman\\>","driller",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<day laborer\\>","laborer",parentheses1_1940_plain_with_replacements))]

### Other changes
title_edits.1940 <- title_edits.1940[,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<authoress\\>","author",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<actress\\>","actor",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<therapeutist\\>","therapist",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<seamstress\\>","sewer",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<mender\\>","repairer",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<waitress\\>","waiter",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<arcer\\>","archer",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<builder\\>","maker",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<mistress\\>","master",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<postmistress\\>","postmaster",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<logging\\>","log",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<heckler\\>","hackler",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<knobbler\\>","knobber",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<masonry\\>","mason",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<lantern\\>","lamp",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<merchant\\>|dealer merchant|merchant dealer","dealer",parentheses1_1940_plain_with_replacements))]
title_edits.1940 <- title_edits.1940[,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<moulder\\>","molder",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<tailoress\\>","tailor",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<fixer\\>","repairer",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<bartender\\>","barkeeper",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<scrubber\\>","sweeper",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<seamer\\>","sewer",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<slagger\\>","slager",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<stewardess\\>","steward",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<proprietor\\>","owner",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<raiser\\>","breeder",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<piler\\>","stacker",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<drover\\>","driver",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<exodonist\\>","exodontist",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<coper\\>","copper",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<cuter\\>","cutter",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<desinger\\>","designer",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<drier\\>","dryer",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<gagger\\>","gager",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<slinger\\>","swinger",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<weighter\\>","weigher",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<automobile\\>|\\<automotive\\>|\\<automobiles\\>","auto",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish(gsub("\\<concessionaire\\>","concessioner",parentheses1_1940_plain_with_replacements))]

# 0.c. Replace terms [tit] or [tit] ---> [tit]. 
# If we have [tit1] [tit] or [tit] [tit2] ---> [tit1] [tit] ([tit2]) e.g. shaker and shaker out --> shaker + out in parentheses
title_edits.1940 <- title_edits.1940[,temp:=gsub("(.*)(.+) or \\2 (.+)","\\3",str_extract(title_1940_plain_with_replacements,"(.*)(.+) or \\2 (.+)"))]
title_edits.1940 <- title_edits.1940[,parentheses1_1940_plain_with_replacements:= str_squish(
                                           ifelse(!is.na(temp) & is.na(parentheses1_1940_plain_with_replacements),    
                                                  temp,   
                                                  ifelse(!is.na(temp) & !is.na(parentheses1_1940_plain_with_replacements), 
                                                         paste(parentheses1_1940_plain_with_replacements,temp,sep=" "),
                                                         parentheses1_1940_plain_with_replacements))  )][,temp:=NULL]

title_edits.1940 <- title_edits.1940[,title_1940_plain_with_replacements:= str_squish(gsub("(.*)(.+) or \\2 (.+)","\\1\\2",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish( gsub("(.*)(.+) or \\2$","\\1\\2",title_1940_plain_with_replacements) )]
title_edits.1940 <- title_edits.1940[,parentheses1_1940_plain_with_replacements:= str_squish(gsub("(.*)(.+) or \\2 (.+)","\\1\\2 \\3",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish( gsub("(.*)(.+) or \\2$","\\1\\2",parentheses1_1940_plain_with_replacements) )]


# 0.c. Manually change some troublesome cases
# yard man or yard hand --> yard (hand)
# tongsman or tonger --> tong
title_edits.1940 <- title_edits.1940[title_1940_plain_with_replacements=="yard man or yard hand",`:=`(title_1940_plain_with_replacements="yard",parentheses1_1940_plain_with_replacements="hand")]
title_edits.1940 <- title_edits.1940[title_1940_plain_with_replacements=="tongsman or tonger",title_1940_plain_with_replacements:="tong"]

# 1a. Replace terms of the form [tit] or [tit]er ---> [tit]
## Create replacement list
replacement_list <- title_edits.1940[,c("title_1940_plain_with_replacements")][,stem:=gsub("(.+) or \\1er","\\1",str_extract(title_1940_plain_with_replacements,"(.+) or \\1er$"))][!is.na(stem)][,original_1:=paste0(str_squish(stem))][,original_2:=paste0(str_squish(stem),"er")][,change:=1]
temp <- title_edits.1940[,c("title_1940_plain_with_replacements")][,stem:=gsub("(.+) or \\1er ","\\1",str_extract(title_1940_plain_with_replacements,"(.+) or \\1er "))][!is.na(stem)][,original_1:=paste0(str_squish(stem))][,original_2:=paste0(str_squish(stem),"er")][,change:=1]
replacement_list <- rbind(replacement_list,temp,fill=TRUE)
simplification_list <- unique(replacement_list[,c("stem","original_1","original_2","change")])

## Check that replacement works
replacement_list <- replacement_list[change==1,check:=gsub("(.*)(.+) or \\2er$","\\1\\2",title_1940_plain_with_replacements)][change==1,check:=gsub("(.*)(.+) or \\2er ","\\1\\2 ",check)]

## Replace 
title_edits.1940 <- title_edits.1940[,title_1940_plain_with_replacements:=str_squish( gsub("(.*)(.+) or \\2er$","\\1\\2",title_1940_plain_with_replacements) )][,title_1940_plain_with_replacements:=str_squish( gsub("(.*)(.+) or \\2er ","\\1\\2 ",title_1940_plain_with_replacements) )]

# 1b. Replace terms of the form [tit] or [tit]r ---> [tit]
## Create replacement list
temp <- rbind(
          title_edits.1940[,c("title_1940_plain_with_replacements")][,stem:=gsub("(.+) or \\1r","\\1",str_extract(title_1940_plain_with_replacements,"(.+) or \\1r$"))][!is.na(stem)][,original_1:=paste0(str_squish(stem))][,original_2:=paste0(str_squish(stem),"r")][,change:=1.5],
          title_edits.1940[,c("title_1940_plain_with_replacements")][,stem:=gsub("(.+) or \\1r ","\\1",str_extract(title_1940_plain_with_replacements,"(.+) or \\1r "))][!is.na(stem)][,original_1:=paste0(str_squish(stem))][,original_2:=paste0(str_squish(stem),"r")][,change:=1.5]
             )
replacement_list <- rbind(replacement_list,temp,fill=TRUE)
simplification_list <- rbind(simplification_list,unique(temp[,c("stem","original_1","original_2","change")]))

## Check that replacement works
replacement_list <- replacement_list[change==1.5,check:=gsub("(.*)(.+) or \\2r ","\\1\\2 ",title_1940_plain_with_replacements)][change==1.5,check:=gsub("(.*)(.+) or \\2r$","\\1\\2",check)]

## Replace 
title_edits.1940 <- title_edits.1940[,title_1940_plain_with_replacements:=str_squish( gsub("(.*)(.+) or \\2r ","\\1\\2 ",title_1940_plain_with_replacements) )][,title_1940_plain_with_replacements:=str_squish( gsub("(.*)(.+) or \\2r$","\\1\\2",title_1940_plain_with_replacements) )]

# 2a. Replace terms of the form [tit]er or [tit] ---> [tit]
## Create replacement list
temp <- rbind(
          title_edits.1940[,c("title_1940_plain_with_replacements")][,stem:=gsub("(.+)er or \\1","\\1",str_extract(title_1940_plain_with_replacements,"(.+)er or \\1$"))][!is.na(stem)][,original_1:=paste0(str_squish(stem),"er")][,original_2:=paste0(str_squish(stem))][,change:=2],
          title_edits.1940[,c("title_1940_plain_with_replacements")][,stem:=gsub("(.+)er or \\1 ","\\1",str_extract(title_1940_plain_with_replacements,"(.+)er or \\1 "))][!is.na(stem)][,original_1:=paste0(str_squish(stem),"er")][,original_2:=paste0(str_squish(stem))][,change:=2]
             )
# Old way
#temp <- title_edits.1940[,c("title_1940_plain_with_replacements")][,stem:=gsub("(.+)er or \\1 (.+)","\\1",str_extract(title_1940_plain_with_replacements,"(.+)er or \\1 (.+)"))][!is.na(stem)][,original_1:=paste0(stem,"er")][,original_2:=paste0(stem)][,change:=2]

replacement_list <- rbind(replacement_list,temp,fill=TRUE)
simplification_list <- rbind(simplification_list,unique(temp[,c("stem","original_1","original_2","change")]))

## Check that replacement works
#replacement_list <- replacement_list[change==2,check:=gsub("(.+)er or \\1 (.+)","\\1 \\2",title_1940_plain_with_replacements)]
replacement_list <- replacement_list[change==2,check:=gsub("(.+)er or \\1$","\\1",title_1940_plain_with_replacements)][change==2,check:=gsub("(.+)er or \\1 ","\\1 ",check)]

## Replace 
title_edits.1940 <- title_edits.1940[,title_1940_plain_with_replacements:=str_squish( gsub("(.+)er or \\1$","\\1",title_1940_plain_with_replacements) )][,title_1940_plain_with_replacements:=str_squish( gsub("(.+)er or \\1 ","\\1 ",title_1940_plain_with_replacements) )]

# 2b. Replace terms of the form [tit]r or [tit] ---> [tit]
## Create replacement list
temp <- rbind(
          title_edits.1940[,c("title_1940_plain_with_replacements")][,stem:=gsub("(.+)r or \\1","\\1",str_extract(title_1940_plain_with_replacements,"(.+)r or \\1$"))][!is.na(stem)][,original_1:=paste0(str_squish(stem),"r")][,original_2:=paste0(str_squish(stem))][,change:=2.5],
          title_edits.1940[,c("title_1940_plain_with_replacements")][,stem:=gsub("(.+)r or \\1 ","\\1",str_extract(title_1940_plain_with_replacements,"(.+)r or \\1 "))][!is.na(stem)][,original_1:=paste0(str_squish(stem),"r")][,original_2:=paste0(str_squish(stem))][,change:=2.5]
             )
replacement_list <- rbind(replacement_list,temp,fill=TRUE)
simplification_list <- rbind(simplification_list,unique(temp[,c("stem","original_1","original_2","change")]))

## Check that replacement works
replacement_list <- replacement_list[change==2.5,check:=gsub("([a-z]+)r or \\1$","\\1",title_1940_plain_with_replacements)][change==2.5,check:=gsub("([a-z]+)r or \\1 ","\\1 ",check)]

## Replace 
title_edits.1940 <- title_edits.1940[,title_1940_plain_with_replacements:=str_squish( gsub("([a-z]+)r or \\1$","\\1",title_1940_plain_with_replacements) )][,title_1940_plain_with_replacements:=str_squish( gsub("([a-z]+)r or \\1 ","\\1 ",title_1940_plain_with_replacements) )]

# 3. Replace titles of the form [tit] or [tit]man ( e.g. beater or beaterman)
temp <- rbind(
          title_edits.1940[,c("title_1940_plain_with_replacements")][,stem:=gsub("(.+) or \\1man","\\1",str_extract(title_1940_plain_with_replacements,"([a-z]+) or \\1man$"))][!is.na(stem)][,original_1:=paste0(str_squish(stem))][,original_2:=paste0(str_squish(stem),"man")][,change:=3],
          title_edits.1940[,c("title_1940_plain_with_replacements")][,stem:=gsub("(.+) or \\1man ","\\1",str_extract(title_1940_plain_with_replacements,"([a-z]+) or \\1man "))][!is.na(stem)][,original_1:=paste0(str_squish(stem))][,original_2:=paste0(str_squish(stem),"man")][,change:=3]
             )
replacement_list <- rbind(replacement_list,temp,fill=TRUE)
simplification_list <- rbind(simplification_list,unique(temp[,c("stem","original_1","original_2","change")]))

## Check that replacement works
replacement_list <- replacement_list[change==3,check:=sub("([a-z]+) or \\1man$","\\1",title_1940_plain_with_replacements)][change==3,check:=gsub("([a-z]+) or \\1man ","\\1 ",check)]

## Replace 
title_edits.1940 <- title_edits.1940[,title_1940_plain_with_replacements:=str_squish( gsub("([a-z]+) or \\1man$","\\1",title_1940_plain_with_replacements) )][,title_1940_plain_with_replacements:=str_squish( gsub("([a-z]+) or \\1man ","\\1 ",title_1940_plain_with_replacements) )]


# 4. Replace titles of the form [tit]man or [tit] ( e.g. )
temp <- rbind(
              title_edits.1940[,c("title_1940_plain_with_replacements")][,stem:=gsub("([a-z]+)man or \\1 ","\\1",str_extract(title_1940_plain_with_replacements,"([a-z]+)man or \\1 "))][!is.na(stem)][,original_1:=paste0(stem,"man")][,original_2:=paste0(stem)][,change:=4],
              title_edits.1940[,c("title_1940_plain_with_replacements")][,stem:=gsub("([a-z]+)man or \\1","\\1",str_extract(title_1940_plain_with_replacements,"([a-z]+)man or \\1$"))][!is.na(stem)][,original_1:=paste0(stem,"man")][,original_2:=paste0(stem)][,change:=4]
              )

replacement_list <- rbind(replacement_list,temp,fill=TRUE)
simplification_list <- rbind(simplification_list,unique(temp[,c("stem","original_1","original_2","change")]))

## Check that replacement works
replacement_list <- replacement_list[change==4,check:=gsub("([a-z]+)man or \\1 ","\\1 ",title_1940_plain_with_replacements)][change==4,check:=gsub("([a-z]+)man or \\1$","\\1",check)]

## Replace 
title_edits.1940 <- title_edits.1940[,title_1940_plain_with_replacements:=str_squish( gsub("([a-z]+)man or \\1 ","\\1 ",title_1940_plain_with_replacements) )][,title_1940_plain_with_replacements:=str_squish( gsub("([a-z]+)man or \\1$","\\1",title_1940_plain_with_replacements) )]


# 5. Replace titles of the form [tit]er or [tit]man
temp <- rbind(
                title_edits.1940[,c("title_1940_plain_with_replacements")][,stem:=gsub("([a-z]+)er or \\1man ","\\1",str_extract(title_1940_plain_with_replacements,"([a-z]+)er or \\1man "))][!is.na(stem)][,original_1:=paste0(stem,"er")][,original_2:=paste0(stem,"man")][,change:=5],
                title_edits.1940[,c("title_1940_plain_with_replacements")][,stem:=gsub("([a-z]+)er or \\1man$","\\1",str_extract(title_1940_plain_with_replacements,"([a-z]+)er or \\1man$"))][!is.na(stem)][,original_1:=paste0(stem,"er")][,original_2:=paste0(stem,"man")][,change:=5]
            )

replacement_list <- rbind(replacement_list,temp,fill=TRUE)
simplification_list <- rbind(simplification_list,unique(temp[,c("stem","original_1","original_2","change")]))

## Check that replacement works
replacement_list <- replacement_list[change==5,check:=gsub("([a-z]+)er or \\1man ","\\1 ",title_1940_plain_with_replacements)][change==5,check:=gsub("([a-z]+)er or \\1man$","\\1",check)]

## Replace 
title_edits.1940 <- title_edits.1940[,title_1940_plain_with_replacements:=str_squish( gsub("([a-z]+)er or \\1man ","\\1 ",title_1940_plain_with_replacements) )][,title_1940_plain_with_replacements:=str_squish( gsub("([a-z]+)er or \\1man$","\\1",title_1940_plain_with_replacements) )]


# 6. Replace titles of the form [tit]man or [tit]er
temp <- rbind(
              title_edits.1940[,c("title_1940_plain_with_replacements")][,stem:=gsub("([a-z]+)man or \\1er ","\\1",str_extract(title_1940_plain_with_replacements,"([a-z]+)man or \\1er "))][!is.na(stem)][,original_1:=paste0(stem,"man")][,original_2:=paste0(stem,"er")][,change:=6],
              title_edits.1940[,c("title_1940_plain_with_replacements")][,stem:=gsub("([a-z]+)man or \\1er","\\1",str_extract(title_1940_plain_with_replacements,"([a-z]+)man or \\1er$"))][!is.na(stem)][,original_1:=paste0(stem,"man")][,original_2:=paste0(stem,"er")][,change:=6]
              )

replacement_list <- rbind(replacement_list,temp,fill=TRUE)
simplification_list <- rbind(simplification_list,unique(temp[,c("stem","original_1","original_2","change")]))

## Check that replacement works
replacement_list <- replacement_list[change==6,check:=gsub("([a-z]+)man or \\1er ","\\1 ",title_1940_plain_with_replacements)][change==6,check:=gsub("([a-z]+)man or \\1er$","\\1",check)]

## Replace 
title_edits.1940 <- title_edits.1940[,title_1940_plain_with_replacements:=str_squish( gsub("([a-z]+)man or \\1er ","\\1 ",title_1940_plain_with_replacements) )][,title_1940_plain_with_replacements:=str_squish( gsub("([a-z]+)man or \\1er$","\\1$",title_1940_plain_with_replacements) )]

# 7. Replace titles of the form [tit]r or [tit]man e.g. bridger or bridgeman
temp <- rbind(
              title_edits.1940[,c("title_1940_plain_with_replacements")][,stem:=gsub("([a-z]+)r or \\1man ","\\1",str_extract(title_1940_plain_with_replacements,"([a-z]+)r or \\1man "))][!is.na(stem)][,original_1:=paste0(stem,"r")][,original_2:=paste0(stem,"man")][,change:=7],
              title_edits.1940[,c("title_1940_plain_with_replacements")][,stem:=gsub("([a-z]+)r or \\1man","\\1",str_extract(title_1940_plain_with_replacements,"([a-z]+)r or \\1man$"))][!is.na(stem)][,original_1:=paste0(stem,"r")][,original_2:=paste0(stem,"man")][,change:=7]
)

replacement_list <- rbind(replacement_list,temp,fill=TRUE)
simplification_list <- rbind(simplification_list,unique(temp[,c("stem","original_1","original_2","change")]))

## Check that replacement works
replacement_list <- replacement_list[change==7,check:=gsub("([a-z]+)r or \\1man ","\\1 ",title_1940_plain_with_replacements)][change==7,check:=gsub("([a-z]+)r or \\1man$","\\1",check)]

## Replace 
title_edits.1940 <- title_edits.1940[,title_1940_plain_with_replacements:=str_squish( gsub("([a-z]+)r or \\1man ","\\1 ",title_1940_plain_with_replacements) )][,title_1940_plain_with_replacements:=str_squish( gsub("([a-z]+)r or \\1man$","\\1",title_1940_plain_with_replacements) )]


# 8. Replace titles of the form [tit]man or [tit]r
temp <- rbind(
              title_edits.1940[,c("title_1940_plain_with_replacements")][,stem:=gsub("([a-z]+)man or \\1r ","\\1",str_extract(title_1940_plain_with_replacements,"([a-z]+)man or \\1r "))][!is.na(stem)][,original_1:=paste0(stem,"man")][,original_2:=paste0(stem,"r")][,change:=8],
              title_edits.1940[,c("title_1940_plain_with_replacements")][,stem:=gsub("([a-z]+)man or \\1r","\\1",str_extract(title_1940_plain_with_replacements,"([a-z]+)man or \\1r$"))][!is.na(stem)][,original_1:=paste0(stem,"man")][,original_2:=paste0(stem,"r")][,change:=8]
)

replacement_list <- rbind(replacement_list,temp,fill=TRUE)
simplification_list <- rbind(simplification_list,unique(temp[,c("stem","original_1","original_2","change")]))

## Check that replacement works
replacement_list <- replacement_list[change==8,check:=gsub("([a-z]+)man or \\1r ","\\1 ",title_1940_plain_with_replacements)][change==8,check:=gsub("([a-z]+)man or \\1r$","\\1",check)]

## Replace 
title_edits.1940 <- title_edits.1940[,title_1940_plain_with_replacements:=str_squish( gsub("([a-z]+)man or \\1r ","\\1 ",title_1940_plain_with_replacements) )][,title_1940_plain_with_replacements:=str_squish( gsub("([a-z]+)man or \\1r$","\\1",title_1940_plain_with_replacements) )]


# 9. Use the simplification list to change words
## We will only replace COMPLETE words
simplification_list$original_1 <- paste0(paste0("\\<",simplification_list$original_1),"\\>")
simplification_list$original_2 <- paste0(paste0("\\<",simplification_list$original_2),"\\>")

## Title
title_edits.1940$title_1940_plain_with_replacements <- str_squish( mgsub(simplification_list$original_1,simplification_list$stem,title_edits.1940$title_1940_plain_with_replacements,fixed=FALSE) )
title_edits.1940$title_1940_plain_with_replacements <- str_squish( mgsub(simplification_list$original_2,simplification_list$stem,title_edits.1940$title_1940_plain_with_replacements,fixed=FALSE) )

# Parentheses
title_edits.1940$parentheses1_1940_plain_with_replacements <- str_squish( mgsub(simplification_list$original_1,simplification_list$stem,title_edits.1940$parentheses1_1940_plain_with_replacements,fixed=FALSE) )
title_edits.1940$parentheses1_1940_plain_with_replacements <- str_squish( mgsub(simplification_list$original_2,simplification_list$stem,title_edits.1940$parentheses1_1940_plain_with_replacements,fixed=FALSE) )

# Change parenthesis: if tit or tit ---> tit
#title_edits.1940 <- title_edits.1940[,parentheses1_1940_plain_with_replacements:= str_squish(gsub("(.+) (.+) or \\2([^a-z]+)","\\1 \\2\\3",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish( gsub("^(.+) or \\1([^a-z]+)","\\1\\2",parentheses1_1940_plain_with_replacements) )]
title_edits.1940 <- title_edits.1940[,parentheses1_1940_plain_with_replacements:= str_squish(gsub("([a-z]+) or \\1 ","\\1 ",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish( gsub("([a-z]+) or \\1$","\\1",parentheses1_1940_plain_with_replacements) )]

# if "[tit] or man" -> [tit]
title_edits.1940 <- title_edits.1940[,parentheses1_1940_plain_with_replacements:= str_squish(gsub("([a-z]+) or man$","\\1",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:= str_squish(gsub("([a-z]+) or man ","\\1 ",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:= str_squish(gsub("^or man$","",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:= str_squish(gsub("^man or ([a-z]+) ","\\1 ",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:= str_squish(gsub("^man or ([a-z]+)$","\\1",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:= str_squish(gsub("^or (.+)$","\\1",parentheses1_1940_plain_with_replacements))]

#***** dealing with MAN or WORK
# 10. Replace titles of the form [tit] man or [tit2] --> [tit] ([tit2])
title_edits.1940 <- title_edits.1940[,temp:=gsub("(.+) man or (.+)","\\2",str_extract(title_1940_plain_with_replacements,"(.+) man or (.+)"))]
title_edits.1940 <- title_edits.1940[,parentheses1_1940_plain_with_replacements:= str_squish(
                                           ifelse(!is.na(temp) & is.na(parentheses1_1940_plain_with_replacements),    
                                                  temp,   
                                                  ifelse(!is.na(temp) & !is.na(parentheses1_1940_plain_with_replacements), 
                                                         paste(parentheses1_1940_plain_with_replacements,temp,sep=" "),
                                                         parentheses1_1940_plain_with_replacements))  )]

title_edits.1940 <- title_edits.1940[,title_1940_plain_with_replacements:= str_squish(gsub("(.+) man or (.+)","\\1",title_1940_plain_with_replacements))]

# 11. Replace titles of the form [tit] [tit2] or man --> [tit] ([tit2])
title_edits.1940 <- title_edits.1940[,temp:=gsub("(.+) (.+) or man","\\2",str_extract(title_1940_plain_with_replacements,"(.+) (.+) or man$"))]
title_edits.1940 <- title_edits.1940[,parentheses1_1940_plain_with_replacements:= str_squish(
                                           ifelse(!is.na(temp) & is.na(parentheses1_1940_plain_with_replacements),    
                                                  temp,   
                                                  ifelse(!is.na(temp) & !is.na(parentheses1_1940_plain_with_replacements), 
                                                         paste(parentheses1_1940_plain_with_replacements,temp,sep=" "),
                                                         parentheses1_1940_plain_with_replacements))  )][,temp:=NULL]

title_edits.1940 <- title_edits.1940[,title_1940_plain_with_replacements:= str_squish(gsub("(.+) (.+) or man$","\\1",title_1940_plain_with_replacements))]

# 12. Drop words with man
title_edits.1940 <- title_edits.1940[,title_1940_plain_with_replacements := str_squish(gsub("\\<mans\\>","",title_1940_plain_with_replacements))]
title_edits.1940 <- title_edits.1940[,title_1940_plain_with_replacements := str_squish(gsub("([^ ]+)mans$","\\1",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements := str_squish(gsub("([^ ]+)mans (.+)","\\1 \\2",title_1940_plain_with_replacements))]
title_edits.1940 <- title_edits.1940[,title_1940_plain_with_replacements := str_squish(gsub("\\<man\\>","",title_1940_plain_with_replacements))]
title_edits.1940 <- title_edits.1940[,title_1940_plain_with_replacements := str_squish(gsub("([^ ]+)man$","\\1",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements := str_squish(gsub("([^ ]+)man (.+)","\\1 \\2",title_1940_plain_with_replacements))]

title_edits.1940 <- title_edits.1940[,parentheses1_1940_plain_with_replacements := str_squish(gsub("\\<mans\\>","",parentheses1_1940_plain_with_replacements))]
title_edits.1940 <- title_edits.1940[,parentheses1_1940_plain_with_replacements := str_squish(gsub("([^ ]+)mans$","\\1",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements := str_squish(gsub("([^ ]+)mans (.+)","\\1 \\2",parentheses1_1940_plain_with_replacements))]
title_edits.1940 <- title_edits.1940[,parentheses1_1940_plain_with_replacements := str_squish(gsub("\\<man\\>","",parentheses1_1940_plain_with_replacements))]
title_edits.1940 <- title_edits.1940[,parentheses1_1940_plain_with_replacements := str_squish(gsub("([^ ]+)man$","\\1",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements := str_squish(gsub("([^ ]+)man (.+)","\\1 \\2",parentheses1_1940_plain_with_replacements))]

# 13. Replace certain words that include "work" with employee
title_edits.1940 <- title_edits.1940[title_1940_plain_with_replacements %in% c("employee or work","work","work man","working out","works out","work or works","works or work","works at","working"),title_1940_plain_with_replacements := "employee"]

# 14. Replace titles of the form [tit] work or [tit2] --> [tit] ([tit2])
title_edits.1940 <- title_edits.1940[,temp:=gsub("(.+) work or (.+)","\\2",str_extract(title_1940_plain_with_replacements,"(.+) work or (.+)"))]
title_edits.1940 <- title_edits.1940[,parentheses1_1940_plain_with_replacements:= str_squish(
                                           ifelse(!is.na(temp) & is.na(parentheses1_1940_plain_with_replacements),    
                                                  temp,   
                                                  ifelse(!is.na(temp) & !is.na(parentheses1_1940_plain_with_replacements), 
                                                         paste(parentheses1_1940_plain_with_replacements,temp,sep=" "),
                                                         parentheses1_1940_plain_with_replacements))  )][,temp:=NULL]

title_edits.1940 <- title_edits.1940[,title_1940_plain_with_replacements:= str_squish(gsub("(.+) work or (.+)","\\1",title_1940_plain_with_replacements))]

# 15. Replace titles of the form [tit] [tit2] or man --> [tit] ([tit2])
title_edits.1940 <- title_edits.1940[,temp:=gsub("(.+) (.+) or work","\\2",str_extract(title_1940_plain_with_replacements,"(.+) (.+) or work$"))]
title_edits.1940 <- title_edits.1940[,parentheses1_1940_plain_with_replacements:= str_squish(
                                           ifelse(!is.na(temp) & is.na(parentheses1_1940_plain_with_replacements),    
                                                  temp,   
                                                  ifelse(!is.na(temp) & !is.na(parentheses1_1940_plain_with_replacements), 
                                                         paste(parentheses1_1940_plain_with_replacements,temp,sep=" "),
                                                         parentheses1_1940_plain_with_replacements))  )][,temp:=NULL]

title_edits.1940 <- title_edits.1940[,title_1940_plain_with_replacements:= str_squish(gsub("(.+) (.+) or work$","\\1",title_1940_plain_with_replacements))]

# 16. Drop words with man
title_edits.1940 <- title_edits.1940[,title_1940_plain_with_replacements := str_squish(gsub("\\<works\\>","",title_1940_plain_with_replacements))]
title_edits.1940 <- title_edits.1940[,title_1940_plain_with_replacements := str_squish(gsub("([^ ]+)works$","\\1",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements := str_squish(gsub("([^ ]+)works (.+)","\\1 \\2",title_1940_plain_with_replacements))]
title_edits.1940 <- title_edits.1940[,title_1940_plain_with_replacements := str_squish(gsub("\\<work\\>","",title_1940_plain_with_replacements))]
title_edits.1940 <- title_edits.1940[,title_1940_plain_with_replacements := str_squish(gsub("([^ ]+)work$","\\1",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements := str_squish(gsub("([^ ]+)work (.+)","\\1 \\2",title_1940_plain_with_replacements))]

# If title is empty and parentheses has something related with work ---> employee in title
title_edits.1940 <- title_edits.1940[(is.na(title_1940_plain_with_replacements) | title_1940_plain_with_replacements=="") & (parentheses1_1940_plain_with_replacements %in% c("employee or work","work","work man","working out","works out","work or works","works or work","works at","working") ),`:=`(title_1940_plain_with_replacements = "employee",parentheses1_1940_plain_with_replacements=NA)][( is.na(title_1940_plain_with_replacements) | title_1940_plain_with_replacements=="") & !(parentheses1_1940_plain_with_replacements %in% c("employee or work","work","work man","working out","works out","work or works","works or work","works at","working") ),`:=`(title_1940_plain_with_replacements = parentheses1_1940_plain_with_replacements,parentheses1_1940_plain_with_replacements=NA)]

# 17. Dropping "work" in parentheses
title_edits.1940 <- title_edits.1940[,parentheses1_1940_plain_with_replacements := str_squish(gsub("\\<works\\>","",parentheses1_1940_plain_with_replacements))]
title_edits.1940 <- title_edits.1940[,parentheses1_1940_plain_with_replacements := str_squish(gsub("([^ ]+)works$","\\1",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements := str_squish(gsub("([^ ]+)works (.+)","\\1 \\2",parentheses1_1940_plain_with_replacements))]
title_edits.1940 <- title_edits.1940[,parentheses1_1940_plain_with_replacements := str_squish(gsub("\\<work\\>","",parentheses1_1940_plain_with_replacements))]
title_edits.1940 <- title_edits.1940[,parentheses1_1940_plain_with_replacements := str_squish(gsub("([^ ]+)work$","\\1",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements := str_squish(gsub("([^ ]+)work (.+)","\\1 \\2",parentheses1_1940_plain_with_replacements))]

# 18. Reduce words ending in -er, -ist, -ing to their stem
## Find out all the words ending in er, ing, ist
temp <- title_edits.1940[,c("title_1940_plain_with_replacements")][,original:=str_squish(unlist(lapply(str_extract_all(title_1940_plain_with_replacements,"([^ ]+)er$|([^ ]+)er |([^ ]+)ers$|([^ ]+)ers |([^ ]+)ing$|([^ ]+)ing |([^ ]+)ist$|([^ ]+)ist "), function(l) l[1])))][,original1:=str_squish(unlist(lapply(str_extract_all(title_1940_plain_with_replacements,"([^ ]+)er$|([^ ]+)er |([^ ]+)ers$|([^ ]+)ers |([^ ]+)ing$|([^ ]+)ing |([^ ]+)ist$|([^ ]+)ist "), function(l) l[2])))][,original2:=str_squish(unlist(lapply(str_extract_all(title_1940_plain_with_replacements,"([^ ]+)er$|([^ ]+)er |([^ ]+)ers$|([^ ]+)ers |([^ ]+)ing$|([^ ]+)ing |([^ ]+)ist$|([^ ]+)ist "), function(l) l[3])))][,`:=`(original=str_squish(original),original1=str_squish(original1),original2=str_squish(original2))]

simplification_list.er_ist_ing <- unique(rbind(unique(temp[,c("original")]),unique(temp[,c("original1")][,`:=`(original=original1,original1=NULL)]),unique(temp[,c("original2")][,`:=`(original=original2,original2=NULL)])))[!is.na(original)]
simplification_list.er_ist_ing <- simplification_list.er_ist_ing[,stem:=gsub("([a-z]+)er$","\\1",str_extract(original,"([a-z]+)er$"))][is.na(stem),stem:=gsub("([a-z]+)ers$","\\1",str_extract(original,"([a-z]+)ers$"))][is.na(stem),stem:=gsub("([a-z]+)ing$","\\1",str_extract(original,"([a-z]+)ing$"))][is.na(stem),stem:=gsub("([a-z]+)ist$","\\1",str_extract(original,"([a-z]+)ist$"))]

## Manually change and add some variables
simplification_list.er_ist_ing <- simplification_list.er_ist_ing[original %in% c("tonguer","tongue","tongues","tongueing"),stem:="tongue"][original %in% c("glazier","glaziers"),stem:="glaz"][original=="engineer",stem:="engineer"][original %in% c("ringing","ringer","ring"),stem:="ring"][original %in% c("dyeing","dyer"),stem:="dy"][original=="drier",stem:="dry"][original %in% c("desulphuring","desulphurizer"),stem:="desulphur"][original=="cataloguer",stem:="catalogue"][original %in% c("timber","timbering","timberland"),stem:="timber"][original %in% c("feather","feathers","featherer"),stem:="feather"][original %in% c("mitering","miter"),stem:="miter"][original %in% c("plaster","plasterer"),stem:="plaster"]

simplification_list.er_ist_ing <- simplification_list.er_ist_ing[,dup:=0 + duplicated(stem)][,dup:=max(dup),by=c("stem")][dup>0][,dup:=NULL]

simplification_list.er_ist_ing <-
  unique(
        rbind(simplification_list.er_ist_ing,
              data.table(original=c("tonguer","tongue","tongues","tongueing","milker","timber","timbering","timberland","cataloguer","catalogue","catalogues","silverer"), 
                         stem=c(rep("tongue",4),"milk",rep("timber",3),rep("catalogue",3),"silver" )
                        )
              )
  )
                                    

## Convert into word for the search
simplification_list.er_ist_ing$original <- paste0(paste0("\\<",simplification_list.er_ist_ing$original),"\\>")

## Use simplification list to change words
title_edits.1940$title_1940_plain_with_replacements <- str_squish( mgsub(simplification_list.er_ist_ing$original,simplification_list.er_ist_ing$stem,title_edits.1940$title_1940_plain_with_replacements,fixed=FALSE) )

title_edits.1940$parentheses1_1940_plain_with_replacements <- str_squish( mgsub(simplification_list.er_ist_ing$original,simplification_list.er_ist_ing$stem,title_edits.1940$parentheses1_1940_plain_with_replacements,fixed=FALSE) )


## Look again for titles of the form [tit] or [tit]
title_edits.1940 <- title_edits.1940[,temp:=gsub("(.*)(.+) or \\2 (.+)","\\3",str_extract(title_1940_plain_with_replacements,"(.*)(.+) or \\2 (.+)"))]
title_edits.1940 <- title_edits.1940[,parentheses1_1940_plain_with_replacements:= str_squish(
                                           ifelse(!is.na(temp) & is.na(parentheses1_1940_plain_with_replacements),    
                                                  temp,   
                                                  ifelse(!is.na(temp) & !is.na(parentheses1_1940_plain_with_replacements), 
                                                         paste(parentheses1_1940_plain_with_replacements,temp,sep=" "),
                                                         parentheses1_1940_plain_with_replacements))  )][,temp:=NULL]

title_edits.1940 <- title_edits.1940[,title_1940_plain_with_replacements:= str_squish(gsub("(.*)(.+) or \\2 (.+)","\\1\\2",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish( gsub("(.*)(.+) or \\2$","\\1\\2",title_1940_plain_with_replacements) )]
title_edits.1940 <- title_edits.1940[,parentheses1_1940_plain_with_replacements:= str_squish(gsub("(.*)(.+) or \\2 (.+)","\\1\\2 \\3",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish( gsub("(.*)(.+) or \\2$","\\1\\2",parentheses1_1940_plain_with_replacements) )]

# 19. Creating a simplifaction list that we will combine with the one for 1930
simplification_list_1930_and_1940 <- rbind(simplification_list_1930_and_1940,simplification_list)
simplification_list.er_ist_ing_1930_and_1940 <- rbind(simplification_list.er_ist_ing_1930_and_1940,simplification_list.er_ist_ing)
rm(replacement_list,simplification_list,simplification_list.er_ist_ing)

```

### 3.2.3. Using the combined simplication list
```{r}
# Keep only unique observations
simplification_list_1930_and_1940 <- unique(simplification_list_1930_and_1940)
simplification_list.er_ist_ing_1930_and_1940 <- unique(simplification_list.er_ist_ing_1930_and_1940)

# Replace words
## 1930
### ind_simplification_list
#### Title
title_edits.1930$title_1930_plain_with_replacements <- str_squish( mgsub(simplification_list_1930_and_1940$original_1,simplification_list_1930_and_1940$stem,title_edits.1930$title_1930_plain_with_replacements,fixed=FALSE) )
title_edits.1930$title_1930_plain_with_replacements <- str_squish( mgsub(simplification_list_1930_and_1940$original_2,simplification_list_1930_and_1940$stem,title_edits.1930$title_1930_plain_with_replacements,fixed=FALSE) )

# Parentheses
title_edits.1930$parentheses1_1930_plain_with_replacements <- str_squish( mgsub(simplification_list_1930_and_1940$original_1,simplification_list_1930_and_1940$stem,title_edits.1930$parentheses1_1930_plain_with_replacements,fixed=FALSE) )
title_edits.1930$parentheses1_1930_plain_with_replacements <- str_squish( mgsub(simplification_list_1930_and_1940$original_2,simplification_list_1930_and_1940$stem,title_edits.1930$parentheses1_1930_plain_with_replacements,fixed=FALSE) )

### ind_simplification_list.er_ist_ing
#### Title
title_edits.1930$title_1930_plain_with_replacements <- str_squish( mgsub(simplification_list.er_ist_ing_1930_and_1940$original,simplification_list.er_ist_ing_1930_and_1940$stem,title_edits.1930$title_1930_plain_with_replacements,fixed=FALSE) )

#### Parentheses
title_edits.1930$parentheses1_1930_plain_with_replacements <- str_squish( mgsub(simplification_list.er_ist_ing_1930_and_1940$original,simplification_list.er_ist_ing_1930_and_1940$stem,title_edits.1930$parentheses1_1930_plain_with_replacements,fixed=FALSE) )

## 1940
### ind_simplification_list
## Title
title_edits.1940$title_1940_plain_with_replacements <- str_squish( mgsub(simplification_list_1930_and_1940$original_1,simplification_list_1930_and_1940$stem,title_edits.1940$title_1940_plain_with_replacements,fixed=FALSE) )
title_edits.1940$title_1940_plain_with_replacements <- str_squish( mgsub(simplification_list_1930_and_1940$original_2,simplification_list_1930_and_1940$stem,title_edits.1940$title_1940_plain_with_replacements,fixed=FALSE) )

# Parentheses
title_edits.1940$parentheses1_1940_plain_with_replacements <- str_squish( mgsub(simplification_list_1930_and_1940$original_1,simplification_list_1930_and_1940$stem,title_edits.1940$parentheses1_1940_plain_with_replacements,fixed=FALSE) )
title_edits.1940$parentheses1_1940_plain_with_replacements <- str_squish( mgsub(simplification_list_1930_and_1940$original_2,simplification_list_1930_and_1940$stem,title_edits.1940$parentheses1_1940_plain_with_replacements,fixed=FALSE) )

### ind_simplification_list.er_ist_ing
#### Title
title_edits.1940$title_1940_plain_with_replacements <- str_squish( mgsub(simplification_list.er_ist_ing_1930_and_1940$original,simplification_list.er_ist_ing_1930_and_1940$stem,title_edits.1940$title_1940_plain_with_replacements,fixed=FALSE) )

#### Parentheses
title_edits.1940$parentheses1_1940_plain_with_replacements <- str_squish( mgsub(simplification_list.er_ist_ing_1930_and_1940$original,simplification_list.er_ist_ing_1930_and_1940$stem,title_edits.1940$parentheses1_1940_plain_with_replacements,fixed=FALSE) )

# Make sure we don't have combinations of the [tit] or [tit]

# Change: if tit or tit ---> tit
## 1930
title_edits.1930 <- title_edits.1930[,title_1930_plain_with_replacements:= str_squish(gsub("([a-z]+) or \\1 ","\\1 ",title_1930_plain_with_replacements))][,title_1930_plain_with_replacements:=str_squish( gsub("([a-z]+) or \\1$","\\1",title_1930_plain_with_replacements) )][,title_1930_plain_with_replacements:= str_squish(gsub(" or or "," or ",title_1930_plain_with_replacements))]

title_edits.1930 <- title_edits.1930[,parentheses1_1930_plain_with_replacements:= str_squish(gsub("([a-z]+) or \\1 ","\\1 ",parentheses1_1930_plain_with_replacements))][,parentheses1_1930_plain_with_replacements:=str_squish( gsub("([a-z]+) or \\1$","\\1",parentheses1_1930_plain_with_replacements) )][,parentheses1_1930_plain_with_replacements:=str_squish( gsub(" or or "," or ",parentheses1_1930_plain_with_replacements) )]

## 1940
title_edits.1940 <- title_edits.1940[,title_1940_plain_with_replacements:= str_squish(gsub("([a-z]+) or \\1 ","\\1 ",title_1940_plain_with_replacements))][,title_1940_plain_with_replacements:=str_squish( gsub("([a-z]+) or \\1$","\\1",title_1940_plain_with_replacements) )][,title_1940_plain_with_replacements:= str_squish(gsub(" or or "," or ",title_1940_plain_with_replacements))]

title_edits.1940 <- title_edits.1940[,parentheses1_1940_plain_with_replacements:= str_squish(gsub("([a-z]+) or \\1 ","\\1 ",parentheses1_1940_plain_with_replacements))][,parentheses1_1940_plain_with_replacements:=str_squish( gsub("([a-z]+) or \\1$","\\1",parentheses1_1940_plain_with_replacements) )][,parentheses1_1940_plain_with_replacements:=str_squish( gsub(" or or "," or ",parentheses1_1940_plain_with_replacements) )]


```



### 3.2.4. Stemming and reordering the title variables for 1930 and 1940
**NOTE: When we reorder the title we have a problem when or is present. !!!!!
```{r}
# Stemming
## 1930
title_edits.1930 <- merge(title_edits.1930,f_stem(title_edits.1930,title_1930_plain_with_replacements,s=stemmed,flag_plus=1)[!is.na(title_1930_plain_with_replacements) & !is.na(title_1930_plain_with_replacements_stemmed) & title_1930_plain_with_replacements_stemmed!= "" & title_1930_plain_with_replacements_stemmed!= ""],by="title_1930_plain_with_replacements",all=TRUE)
title_edits.1930 <- merge(title_edits.1930,f_stem(title_edits.1930,parentheses1_1930_plain_with_replacements,s=stemmed,flag_plus=1)[!is.na(parentheses1_1930_plain_with_replacements) & !is.na(parentheses1_1930_plain_with_replacements_stemmed) & parentheses1_1930_plain_with_replacements_stemmed!= "" & parentheses1_1930_plain_with_replacements_stemmed!= ""],by="parentheses1_1930_plain_with_replacements",all=TRUE)

### Manually introducing some corrections
title_edits.1930 <- title_edits.1930[grepl('\\<engineer\\>|\\<engineers\\>|\\<engineering\\>',title_1930_plain_with_replacements),title_1930_plain_with_replacements_stemmed:=gsub("engin ","engineer ",title_1930_plain_with_replacements_stemmed)][grepl('\\<engineer\\>|\\<engineers\\>|\\<engineering\\>',title_1930_plain_with_replacements),title_1930_plain_with_replacements_stemmed:=gsub("engin$","engineer",title_1930_plain_with_replacements_stemmed)]
title_edits.1930 <- title_edits.1930[grepl('\\<engineer\\>|\\<engineers\\>|\\<engineering\\>',parentheses1_1930_plain_with_replacements),parentheses1_1930_plain_with_replacements_stemmed:=gsub("engin ","engineer ",parentheses1_1930_plain_with_replacements_stemmed)][grepl('\\<engineer\\>|\\<engineers\\>|\\<engineering\\>',parentheses1_1930_plain_with_replacements),parentheses1_1930_plain_with_replacements_stemmed:=gsub("engin$","engineer",parentheses1_1930_plain_with_replacements_stemmed)]

## 1940
title_edits.1940 <- merge(title_edits.1940,f_stem(title_edits.1940,title_1940_plain_with_replacements,s=stemmed,flag_plus=1)[!is.na(title_1940_plain_with_replacements) & !is.na(title_1940_plain_with_replacements_stemmed) & title_1940_plain_with_replacements_stemmed!= "" & title_1940_plain_with_replacements_stemmed!= ""],by="title_1940_plain_with_replacements",all=TRUE)
title_edits.1940 <- merge(title_edits.1940,f_stem(title_edits.1940,parentheses1_1940_plain_with_replacements,s=stemmed,flag_plus=1)[!is.na(parentheses1_1940_plain_with_replacements) & !is.na(parentheses1_1940_plain_with_replacements_stemmed) & parentheses1_1940_plain_with_replacements_stemmed!= "" & parentheses1_1940_plain_with_replacements_stemmed!= ""],by="parentheses1_1940_plain_with_replacements",all=TRUE)

### Manually introducing some corrections
title_edits.1940 <- title_edits.1940[grepl('\\<engineer\\>|\\<engineers\\>|\\<engineering\\>',title_1940_plain_with_replacements),title_1940_plain_with_replacements_stemmed:=gsub("engin ","engineer ",title_1940_plain_with_replacements_stemmed)][grepl('\\<engineer\\>|\\<engineers\\>|\\<engineering\\>',title_1940_plain_with_replacements),title_1940_plain_with_replacements_stemmed:=gsub("engin$","engineer",title_1940_plain_with_replacements_stemmed)]
title_edits.1940 <- title_edits.1940[grepl('\\<engineer\\>|\\<engineers\\>|\\<engineering\\>',parentheses1_1940_plain_with_replacements),parentheses1_1940_plain_with_replacements_stemmed:=gsub("engin ","engineer ",parentheses1_1940_plain_with_replacements_stemmed)][grepl('\\<engineer\\>|\\<engineers\\>|\\<engineering\\>',parentheses1_1940_plain_with_replacements),parentheses1_1940_plain_with_replacements_stemmed:=gsub("engin$","engineer",parentheses1_1940_plain_with_replacements_stemmed)]

# Reordering
## 1930
title_edits.1930 <- merge(title_edits.1930,f_reorder(title_edits.1930,title_1930_plain_with_replacements_stemmed,r=r)[!is.na(title_1930_plain_with_replacements_stemmed) & !is.na(title_1930_plain_with_replacements_stemmed) & title_1930_plain_with_replacements_stemmed!= "" & title_1930_plain_with_replacements_stemmed!= ""],by="title_1930_plain_with_replacements_stemmed",all=TRUE)
title_edits.1930 <- merge(title_edits.1930,f_reorder(title_edits.1930,parentheses1_1930_plain_with_replacements_stemmed,r=r)[!is.na(parentheses1_1930_plain_with_replacements_stemmed) & !is.na(parentheses1_1930_plain_with_replacements_stemmed) & parentheses1_1930_plain_with_replacements_stemmed!= "" & parentheses1_1930_plain_with_replacements_stemmed!= ""],by="parentheses1_1930_plain_with_replacements_stemmed",all=TRUE)

## 1940
title_edits.1940 <- merge(title_edits.1940,f_reorder(title_edits.1940,title_1940_plain_with_replacements_stemmed,r=r)[!is.na(title_1940_plain_with_replacements_stemmed) & !is.na(title_1940_plain_with_replacements_stemmed) & title_1940_plain_with_replacements_stemmed!= "" & title_1940_plain_with_replacements_stemmed!= ""],by="title_1940_plain_with_replacements_stemmed",all=TRUE)
title_edits.1940 <- merge(title_edits.1940,f_reorder(title_edits.1940,parentheses1_1940_plain_with_replacements_stemmed,r=r)[!is.na(parentheses1_1940_plain_with_replacements_stemmed) & !is.na(parentheses1_1940_plain_with_replacements_stemmed) & parentheses1_1940_plain_with_replacements_stemmed!= "" & parentheses1_1940_plain_with_replacements_stemmed!= ""],by="parentheses1_1940_plain_with_replacements_stemmed",all=TRUE)

```


### To-DO

Drop duplicates if the title is in ind and its name also appears in a specific sector? Look at stemmed, reordered. What to do with or

## 3.3. Some final corrections
Here we can correct for minor issues that appeared.

### 3.3.2. Introducing final corrections
```{r}
cols <- c("title_1940","indname_1940","original_1940","indname_1940_original","parentheses1_1940","parentheses2_1940")
index_1940 <- index_1940[,(cols):=lapply(.SD,f_comma_issues),.SDcols=cols]

cols <- c("title_1930","indname_1930","original_1930","parentheses1_1930","parentheses2_1930")
index_1930 <- index_1930[,(cols):=lapply(.SD,f_comma_issues),.SDcols=(cols)]
```



# 4. Finding occupations that are the same 1930-1940

In this section I perform different operations to find out occupations that are the same in both years. I begin by looking at exact matches (after having eliminated punctuation signs and other uninformative words), then I look at fuzzy matches, then at matches of title and industry, then only industry and finally at matches within occupational categories that we know are the same in both years

## 4.1. Finding matches using some simple operations
- 1. Drop observations having the exact same original
- 2. Find matches eliminating punctuation signs, but not commas!! (functions used: f_clean_punct, f_clean_conj)


```{r}
# 1.  Merge using basic original (eliminate points, homogenize some words and symbols, for 1940 I leave out the industry in parentheses)
# 1930
title_merge_1930 <- index_1930[,c("id_1930","occ1930","ind1930","original_1930")]
title_merge_1930[,original:=original_1930][,dup:=0+duplicated(title_merge_1930, incomparables=FALSE, fromLast=FALSE, by=c("original"))][,dup:=max(dup),keyby=.(original)]
table(title_merge_1930$dup)
#  observations have the exact same original_1930
title_merge_1930_repeated <- title_merge_1930[dup>=1][,dup:=NULL]
title_merge_1930_repeated <- title_merge_1930_repeated[!duplicated(title_merge_1930_repeated,by=c("id_1930")),]
title_merge_1930[,dup:= NULL][,original:=str_squish(original)]

# 1940
title_merge_1940 <- index_1940[,c("id_1940","occ1940","ind1940","original_1940")]
title_merge_1940[,original:=original_1940][,dup:=0+duplicated(title_merge_1940, incomparables=FALSE, fromLast=FALSE, by=c("original"))][,dup:=max(dup),keyby=.(original)]
table(title_merge_1940$dup)
#  observations have the exact same original_1940
title_merge_1940_repeated <- title_merge_1940[dup>=1][,dup:=NULL]
title_merge_1940_repeated <- title_merge_1940_repeated[!duplicated(title_merge_1940_repeated,by=c("id_1940")),]
title_merge_1940[,dup:= NULL][,original:=str_squish(original)]

# Merge using basic original
merged_1930_1940 <- merge(title_merge_1930,title_merge_1940,by.x="original",by.y="original",all=TRUE)
merged_1930_1940[,notm_1930:=0+is.na(original_1940)][,notm_1940:=0+is.na(original_1930)][,round:=1]

# table with matched occupations id
matched_1930_1940 <- merged_1930_1940[notm_1930==0 & notm_1940==0,c("id_1930","occ1930","ind1930","id_1940","occ1940","ind1940","original","original_1930","original_1940","round")]

## 2. Find matches eliminating punctuation signs (functions used: f_clean_punct, f_clean_conj)
# Find the titles that couldn't be matched and change the variable used to matched (eliminate punctuation signs, some words...)
# Merge eliminating punctuation signs
title_merge_1930 <- merged_1930_1940[notm_1940==0 & notm_1930==1,c("id_1930","original","occ1930","ind1930","original_1930")]
title_merge_1930[,original:=f_clean_conj( f_clean_punct(original) )][,dup:=0+duplicated(title_merge_1930, incomparables=FALSE, fromLast=FALSE, by=c("original"))][,dup:=max(dup),keyby=.(original)]
table(title_merge_1930$dup)
#  observations have the exact same original
title_merge_1930_repeated <- rbind(title_merge_1930_repeated,title_merge_1930[dup>=1][,dup:=NULL])
title_merge_1930_repeated <- title_merge_1930_repeated[!duplicated(title_merge_1930_repeated,by=c("id_1930")),]
title_merge_1930[,dup:= NULL][,original:=str_squish(original)]

title_merge_1940 <- merged_1930_1940[notm_1940==1 & notm_1930==0,c("id_1940","original","occ1940","ind1940","original_1940")]
title_merge_1940[,original:=f_clean_conj( f_clean_punct(original) )][,dup:=0+duplicated(title_merge_1940, incomparables=FALSE, fromLast=FALSE, by=c("original"))][,dup:=max(dup),keyby=.(original)]
table(title_merge_1940$dup)
# No observations have the exact same original
title_merge_1940_repeated <- rbind(title_merge_1940_repeated,title_merge_1940[dup>=1][,dup:=NULL])
title_merge_1940_repeated <- title_merge_1940_repeated[!duplicated(title_merge_1940_repeated,by=c("id_1940")),]
title_merge_1940[,dup:= NULL][,original:=str_squish(original)]


# Merging
merged_1930_1940 <- merge(title_merge_1930,title_merge_1940,by.x="original",by.y="original",all=TRUE)
merged_1930_1940[,notm_1930:=0+is.na(original_1940)][,notm_1940:=0+is.na(original_1930)][,round:=2]

# Adding to the matched dt
matched_1930_1940 <- rbind(matched_1930_1940,merged_1930_1940[notm_1930==0 & notm_1940==0,c("id_1930","occ1930","ind1930","id_1940","occ1940","ind1940","original","original_1930","original_1940","round")])

#View(merged_1930_1940[notm_1930!=0 | notm_1940!=0])
#write.xlsx(merged_1930_1940[notm_1930!=0 | notm_1940!=0],paste0(main_directory,"R - Processing data/temp/not_merged_1930_1940.xlsx"),row.names = TRUE)

```


Next step is to use some manual changes (e.g. common occupations that are spelled wrong)
- 3. Merge after introducing the substitution that are in words_subs
- 4. Merge eliminating all parentheses
- 5. Merge eliminating words inside the parenthesis
- 6. Merge eliminating "or"

```{r}

# 3. Merge after introducing the substitution that are in words_subs

# Subset the unmatched titles
title_merge_1930 <- merged_1930_1940[notm_1930==1 & notm_1940==0,c("id_1930","original","occ1930","ind1930","original_1930")]
title_merge_1940 <- merged_1930_1940[notm_1930==0 & notm_1940==1,c("id_1940","original","occ1940","ind1940","original_1940")]

# Substitute the words
title_merge_1930$original <- mgsub(words_subs4$term,words_subs4$change,title_merge_1930$original,fixed=FALSE)
title_merge_1930$original <- mgsub(words_subs2$term,"",title_merge_1930$original,fixed=FALSE)
title_merge_1930$original <- mgsub(words_subs3$term,"",title_merge_1930$original,fixed=FALSE)
title_merge_1930[,original:=str_squish(original)]
#Duplicates: Here we don't look for duplicates
title_merge_1940$original <- mgsub(words_subs4$term,words_subs4$change,title_merge_1940$original,fixed=FALSE)
title_merge_1940$original <- mgsub(words_subs2$term,"",title_merge_1940$original,fixed=FALSE)
title_merge_1940$original <- mgsub(words_subs3$term,"",title_merge_1940$original,fixed=FALSE)
title_merge_1940[,original:=str_squish(original)]
#Duplicates: Here we don't look for duplicates

# Merging again
merged_1930_1940 <- merge(title_merge_1930,title_merge_1940,by.x="original",by.y="original",all=TRUE)
merged_1930_1940[,notm_1930:=0+is.na(original_1940)][,notm_1940:=0+is.na(original_1930)][,round:=4]
matched_1930_1940 <- rbind(matched_1930_1940,merged_1930_1940[notm_1930==0 & notm_1940==0,c("id_1930","occ1930","ind1930","id_1940","ind1940","occ1940","original","original_1930","original_1940","round")])


# 4. Merge eliminating all parentheses
# Subset the unmatched titles
title_merge_1930 <- merged_1930_1940[notm_1930==1 & notm_1940==0,c("id_1930","original","occ1930","ind1930","original_1930")]
title_merge_1940 <- merged_1930_1940[notm_1930==0 & notm_1940==1,c("id_1940","original","occ1940","ind1940","original_1940")]

# Eliminate parentheses
title_merge_1930 <- title_merge_1930[,original_step3_1930:=original][,original:=gsub("\\(|\\)","",original)][,dup:=0 + duplicated(title_merge_1930, incomparables=FALSE, fromLast=FALSE, by=c("original"))][,dup:=max(dup),keyby=.(original)]
table(title_merge_1930$dup)
# No observations have the exact same original_1930
title_merge_1930_repeated <- rbind(title_merge_1930_repeated,title_merge_1930[dup>=1][,`:=`(dup=NULL,original_step3_1930=NULL)])
title_merge_1930_repeated <- title_merge_1930_repeated[!duplicated(title_merge_1930_repeated,by=c("id_1930")),]
title_merge_1930 <- title_merge_1930[,dup:= NULL][,original:=str_squish(original)]

title_merge_1940[,original_step3_1940:=original][,original:=gsub("\\(|\\)","",original)][,dup:=0 + duplicated(title_merge_1940, incomparables=FALSE, fromLast=FALSE, by=c("original"))][,dup:=max(dup),keyby=.(original)]
table(title_merge_1940$dup)
#  observations have the exact same original
title_merge_1940_repeated <- rbind(title_merge_1940_repeated,title_merge_1940[dup>=1][,`:=`(dup=NULL,original_step3_1940=NULL)])
title_merge_1940_repeated <- title_merge_1940_repeated[!duplicated(title_merge_1940_repeated,by=c("id_1940")),]
title_merge_1940[,dup:= NULL][,original:=str_squish(original)]

# Merge
merged_1930_1940 <- merge(title_merge_1930,title_merge_1940,by.x="original",by.y="original",all=TRUE)
merged_1930_1940[,notm_1930:=0+is.na(original_1940)][,notm_1940:=0+is.na(original_1930)][,round:=5]
matched_1930_1940 <- rbind(matched_1930_1940,merged_1930_1940[notm_1930==0 & notm_1940==0,c("id_1930","occ1930","ind1930","id_1940","ind1940","occ1940","original","original_1930","original_1940","round")])


# 5. Merge eliminating terms in parentheses
# Subset the unmatched titles
title_merge_1930 <- merged_1930_1940[notm_1930==1 & notm_1940==0,c("id_1930","original_step3_1930","occ1930","ind1930","original_1930")]
title_merge_1940 <- merged_1930_1940[notm_1930==0 & notm_1940==1,c("id_1940","original_step3_1940","occ1940","ind1940","original_1940")]

# Eliminate parentheses
title_merge_1930[,original:=gsub("\\(.*?)","",original_step3_1930)][,dup:=0 + duplicated(title_merge_1930, incomparables=FALSE, fromLast=FALSE, by=c("original"))][,dup:=max(dup),keyby=.(original)]
table(title_merge_1930$dup)
# No observations have the exact same original_1930
title_merge_1930_repeated <- rbind(title_merge_1930_repeated,title_merge_1930[dup>=1][,`:=`(dup=NULL,original_step3_1930=NULL)])
title_merge_1930_repeated <- title_merge_1930_repeated[!duplicated(title_merge_1930_repeated,by=c("id_1930")),]
title_merge_1930[,dup:= NULL][,original:=str_squish(original)]

title_merge_1940[,original:=gsub("\\(.*?)","",original_step3_1940)][,original:=gsub("\\(|\\)","",original)][,dup:=0 + duplicated(title_merge_1940, incomparables=FALSE, fromLast=FALSE, by=c("original"))][,dup:=max(dup),keyby=.(original)]
table(title_merge_1940$dup)
#  observations have the exact same original
title_merge_1940_repeated <- rbind(title_merge_1940_repeated,title_merge_1940[dup>=1][,`:=`(dup=NULL,original_step3_1940=NULL)])
title_merge_1940_repeated <- title_merge_1940_repeated[!duplicated(title_merge_1940_repeated,by=c("id_1940")),]
title_merge_1940[,dup:= NULL][,original:=str_squish(original)]

# Merge
merged_1930_1940 <- merge(title_merge_1930,title_merge_1940,by.x="original",by.y="original",all=TRUE)
merged_1930_1940[,notm_1930:=0+is.na(original_1940)][,notm_1940:=0+is.na(original_1930)][,round:=6]
matched_1930_1940 <- rbind(matched_1930_1940,merged_1930_1940[notm_1930==0 & notm_1940==0,c("id_1930","occ1930","ind1930","id_1940","ind1940","occ1940","original","original_1930","original_1940","round")])



# 6. Merge eliminating "or"
# Note: I didn't include "or" in the f_conj because we will use it later to create different titles (e.g. driller or setter ---> a. driller, b. setter)
# Subset the unmatched titles
title_merge_1930 <- merged_1930_1940[notm_1930==1 & notm_1940==0,c("id_1930","original_step3_1930","occ1930","ind1930","original_1930")]
title_merge_1940 <- merged_1930_1940[notm_1930==0 & notm_1940==1,c("id_1940","original_step3_1940","occ1940","ind1940","original_1940")]

# Eliminate or
title_merge_1930[,original:=str_squish(gsub(" or "," ",original_step3_1930))][,dup:=0 + duplicated(title_merge_1930, incomparables=FALSE, fromLast=FALSE, by=c("original"))][,dup:=max(dup),keyby=.(original)][,original_step3_1930:=NULL]
table(title_merge_1930$dup)
# No observations have the exact same original_1930
title_merge_1930_repeated <- rbind(title_merge_1930_repeated,title_merge_1930[dup>=1][,dup:=NULL])
title_merge_1930_repeated <- title_merge_1930_repeated[!duplicated(title_merge_1930_repeated,by=c("id_1930")),]
title_merge_1930[,dup:= NULL][,original:=str_squish(original)]

title_merge_1940[,original:=str_squish(gsub(" or "," ",original_step3_1940))][,dup:=0 + duplicated(title_merge_1940, incomparables=FALSE, fromLast=FALSE, by=c("original"))][,dup:=max(dup),keyby=.(original)][,original_step3_1940:=NULL]
table(title_merge_1940$dup)
# 8 observations have the exact same original
title_merge_1940_repeated <- rbind(title_merge_1940_repeated,title_merge_1940[dup>=1][,dup:=NULL])
title_merge_1940_repeated <- title_merge_1940_repeated[!duplicated(title_merge_1940_repeated,by=c("id_1940")),]
title_merge_1940[,dup:= NULL][,original:=str_squish(original)]

# Merge
merged_1930_1940 <- merge(title_merge_1930,title_merge_1940,by.x="original",by.y="original",all=TRUE)
merged_1930_1940[,notm_1930:=0+is.na(original_1940)][,notm_1940:=0+is.na(original_1930)][,round:=7]
matched_1930_1940 <- rbind(matched_1930_1940,merged_1930_1940[notm_1930==0 & notm_1940==0,c("id_1930","occ1930","ind1930","id_1940","ind1940","occ1940","original","original_1930","original_1940","round")])



# Subset the unmatched titles
title_merge_1930 <- merged_1930_1940[notm_1930==1 & notm_1940==0,c("id_1930","original","occ1930","ind1930","original_1930")]
title_merge_1940 <- merged_1930_1940[notm_1930==0 & notm_1940==1,c("id_1940","original","occ1940","ind1940","original_1940")]
# Attach industry names
title_merge_1930 <- merge(title_merge_1930,index_1930[,c("id_1930","indname_1930")],by="id_1930",all.x=TRUE,all.y=FALSE)
title_merge_1940 <- merge(title_merge_1940,index_1940[,c("id_1940","indname_1940")],by="id_1940",all.x=TRUE,all.y=FALSE)


## Final file of matched titles
# Find duplicates in the matched set
matched_1930_1940[,dup:=0+duplicated(matched_1930_1940, incomparables=FALSE, fromLast=FALSE, by=c("id_1930","id_1940"))]
#table(matched_1910_1930$dup)
#head(matched_1910_1930[dup!=0],100)
matched_1930_1940 <- matched_1930_1940[dup==0][,dup:=NULL]

# Attach industry names
matched_1930_1940 <- merge(matched_1930_1940,index_1930[,c("id_1930","indname_1930")],by="id_1930",all.x=TRUE,all.y=FALSE)
matched_1930_1940 <- merge(matched_1930_1940,index_1940[,c("id_1940","indname_1940")],by="id_1940",all.x=TRUE,all.y=FALSE)

#View(unique(matched_1930_1940,by="indname_1940"))

```



## 4.2. Try to match unmatched observation using the title but keeping only those matches that are unique
We expand the title so as to have also the title + parentheses
```{r}
# "Expand" the titles
## 1930
temp_1930 <- title_edits.1930[,c("id_1930","title_1930_plain_with_replacements_stemmed_r","parentheses1_1930_plain_with_replacements_stemmed_r")][parentheses1_1930_plain_with_replacements_stemmed_r!="" & !is.na(parentheses1_1930_plain_with_replacements_stemmed_r),parentheses1_1930_plain_with_replacements_stemmed_r:=paste(title_1930_plain_with_replacements_stemmed_r,parentheses1_1930_plain_with_replacements_stemmed_r,sep= " ")]
temp <- temp_1930[,c("id_1930","parentheses1_1930_plain_with_replacements_stemmed_r")][!is.na(parentheses1_1930_plain_with_replacements_stemmed_r)]
setnames(temp,c("parentheses1_1930_plain_with_replacements_stemmed_r"),c("title_1930_plain_with_replacements_stemmed"))
temp <- merge(temp,f_reorder(temp,title_1930_plain_with_replacements_stemmed,r=r),by="title_1930_plain_with_replacements_stemmed")[,c("title_1930_plain_with_replacements_stemmed"):=NULL]
temp_1930 <- rbind(temp_1930[,c("id_1930","title_1930_plain_with_replacements_stemmed_r")],temp)
rm(temp)

## 1940
temp_1940 <- title_edits.1940[,c("id_1940","title_1940_plain_with_replacements_stemmed_r","parentheses1_1940_plain_with_replacements_stemmed_r")][parentheses1_1940_plain_with_replacements_stemmed_r!="" & !is.na(parentheses1_1940_plain_with_replacements_stemmed_r),parentheses1_1940_plain_with_replacements_stemmed_r:=paste(title_1940_plain_with_replacements_stemmed_r,parentheses1_1940_plain_with_replacements_stemmed_r,sep= " ")]
temp <- temp_1940[,c("id_1940","parentheses1_1940_plain_with_replacements_stemmed_r")][!is.na(parentheses1_1940_plain_with_replacements_stemmed_r)]
setnames(temp,c("parentheses1_1940_plain_with_replacements_stemmed_r"),c("title_1940_plain_with_replacements_stemmed"))
temp <- merge(temp,f_reorder(temp,title_1940_plain_with_replacements_stemmed,r=r),by="title_1940_plain_with_replacements_stemmed")[,c("title_1940_plain_with_replacements_stemmed"):=NULL]
temp_1940 <- rbind(temp_1940[,c("id_1940","title_1940_plain_with_replacements_stemmed_r")],temp)
rm(temp)

# Mix title
title_merge_1930 <- merge(title_merge_1930,temp_1930,by="id_1930",all.x=TRUE,all.y=FALSE)
title_merge_1940 <- merge(title_merge_1940,temp_1940,by="id_1940",all.x=TRUE,all.y=FALSE)

# Keep only those titles that are unique
title_merge_1930.unique <- title_merge_1930[,dup:=0+duplicated(title_merge_1930, by=c("title_1930_plain_with_replacements_stemmed_r"))][,title:=title_1930_plain_with_replacements_stemmed_r][,dup:=max(dup),by="title_1930_plain_with_replacements_stemmed_r"][dup==0][,dup:=NULL]
title_merge_1940.unique <- title_merge_1940[,dup:=0+duplicated(title_merge_1940, by=c("title_1940_plain_with_replacements_stemmed_r"))][,title:=title_1940_plain_with_replacements_stemmed_r][,dup:=max(dup),by="title_1940_plain_with_replacements_stemmed_r"][dup==0][,dup:=NULL]

# Merge
merged_1930_1940 <- merge(title_merge_1930.unique,title_merge_1940.unique,by="title",all=FALSE)[,original:=original.y][,c("original.x","original.y","title"):=NULL][,round:=8]
matched_1930_1940 <- rbind(matched_1930_1940,merged_1930_1940[,!c("title_1930_plain_with_replacements_stemmed_r","title_1940_plain_with_replacements_stemmed_r")])

# Subset the unmatched titles
title_merge_1930 <- merge(title_merge_1930,merged_1930_1940[,c("id_1930","round")],by="id_1930",all.x=TRUE,all.y=FALSE)[is.na(round)][,c("dup","round","title"):=NULL]
title_merge_1940 <- merge(title_merge_1940,merged_1930_1940[,c("id_1940","round")],by="id_1940",all.x=TRUE,all.y=FALSE)[is.na(round)][,c("dup","round","title"):=NULL]

# Merge the two unmerged title lists to manually look for matches
unmatched_1930_1940.manual <- merge(title_merge_1930,title_merge_1940,by="original",all=TRUE)

write.xlsx(unmatched_1930_1940.manual,paste0(main_directory,"R - Processing data/temp/unmatched_1930_1940.manual.xlsx"),row.names = TRUE)

rm(title_merge_1930.unique,title_merge_1940.unique)
```
Note: I have to review the repeated occupations (over 100 in 1930). How are they being assigned?

## 4.3. Finding matches using Manual changes
Using the file "unmatched_1930_1940.manual" we manually linked some of the titles and created a new file that we import here. We use the original_[year] variable to link the titles

### 4.3.1. Importing and adjusting manually created tables
```{r}
# 0. Get the title, occupation and industry for some of the Sheets in the unmatched_edited file
if (FALSE) {
# Code_5: matches with possibly occupations that were already matched. Initially I used the id variable, but here I attach the title and industry. In this way the match keeps working even if the order of the titles changes
R_matches <- as.data.table( read_excel(paste0(main_directory,"R - Processing data/temp/unmatched_1930_1940.manual_edited.xlsx"), sheet = "code_5") )
R_matches <-merge(R_matches,index_1930[,c("id_1930","indname_1930")],by="id_1930",all.x=TRUE,all.y=FALSE)
R_matches <-merge(R_matches,index_1940[,c("id_1940","indname_1940")],by="id_1940",all.x=TRUE,all.y=FALSE)
R_matches_1930 <- R_matches[id_1930!="",c("match_id_1940","id_1930","original","original_1930","indname_1930","occ1930","ind1930")][,id_1940:=match_id_1940][,match_id_1940:=NULL]
R_matches_1940 <- R_matches[id_1940!="",c("match_id_1930","id_1940","original","original_1940","indname_1940","occ1940","ind1940")][,id_1930:=match_id_1930][,match_id_1930:=NULL]

R_matches_1930 <- merge(R_matches_1930,index_1940[,c("id_1940","original_1940","occ1940","ind1940","indname_1940")],by=c("id_1940"),all.x=TRUE,all.y=FALSE)
R_matches_1940 <- merge(R_matches_1940,index_1930[,c("id_1930","original_1930","occ1930","ind1930","indname_1930")],by=c("id_1930"),all.x=TRUE,all.y=FALSE)

## Code 7: Titles that we know are not new, but for which we can't find a match
## Almost sure that could be matched
code_7 <- as.data.table( read_excel(paste0(main_directory,"R - Processing data/temp/unmatched_1930_1940.manual_edited.xlsx"), sheet = "code_7") )[,'7':=NULL]
code_7 <-merge(code_7,index_1930[,c("id_1930","indname_1930")],by="id_1930",all.x=TRUE,all.y=FALSE)
code_7 <-merge(code_7,index_1940[,c("id_1940","indname_1940")],by="id_1940",all.x=TRUE,all.y=FALSE)
Almost_sure_1930 <- code_7[id_1930!="",c("match_id_1940","id_1930","original","original_1930","indname_1930","occ1930","ind1930")][,id_1940:=match_id_1940][,match_id_1940:=NULL]
Almost_sure_1930 <-merge(Almost_sure_1930,index_1940[,c("id_1940","original_1940","occ1940","ind1940","indname_1940")],by="id_1940",all.x=TRUE,all.y=FALSE)
Almost_sure_1940 <- code_7[id_1940!="",c("match_id_1930","id_1940","original","original_1940","indname_1940","occ1940","ind1940")][,id_1930:=match_id_1930][,match_id_1930:=NULL]
Almost_sure_1940 <-merge(Almost_sure_1940,index_1930[,c("id_1930","original_1930","occ1930","ind1930","indname_1930")],by="id_1930",all.x=TRUE,all.y=FALSE)
rm(code_7)

## Code_6: Titles to look closer at
code_6 <- as.data.table( read_excel(paste0(main_directory,"R - Processing data/temp/unmatched_1930_1940.manual_edited.xlsx"), sheet = "code_6") )[,'6':=NULL]
code_6 <-merge(code_6,index_1930[,c("id_1930","indname_1930")],by="id_1930",all.x=TRUE,all.y=FALSE)
code_6 <-merge(code_6,index_1940[,c("id_1940","indname_1940")],by="id_1940",all.x=TRUE,all.y=FALSE)
To_review_1930 <- code_6[id_1930!="",c("match_id_1940","id_1930","original","indname_1930","original_1930","occ1930","ind1930")][,id_1940:=match_id_1940][,match_id_1940:=NULL]
To_review_1930 <- merge(To_review_1930,index_1940[,c("id_1940","original_1940","occ1940","ind1940","indname_1940")],by="id_1940",all.x=TRUE,all.y=FALSE)
To_review_1940 <- code_6[id_1940!="",c("match_id_1930","id_1940","original","indname_1940","original_1940","occ1940","ind1940")][,id_1930:=match_id_1930][,match_id_1930:=NULL]
To_review_1940 <- merge(To_review_1940,index_1930[,c("id_1930","original_1930","occ1930","ind1930","indname_1930")],by="id_1930",all.x=TRUE,all.y=FALSE)
rm(code_6)

# Save
write_fst(R_matches_1930,paste0(main_directory,"R - Processing data/output/Rdata/R_matches_1930.fst"))
write_fst(R_matches_1940,paste0(main_directory,"R - Processing data/output/Rdata/R_matches_1940.fst"))
write_fst(Almost_sure_1930,paste0(main_directory,"R - Processing data/output/Rdata/Almost_sure_1930.fst"))
write_fst(Almost_sure_1940,paste0(main_directory,"R - Processing data/output/Rdata/Almost_sure_1940.fst"))
write_fst(To_review_1930,paste0(main_directory,"R - Processing data/output/Rdata/To_review_1930.fst"))
write_fst(To_review_1940,paste0(main_directory,"R - Processing data/output/Rdata/To_review_1940.fst"))
rm(R_matches,R_matches_1930,R_matches_1940,Almost_sure_1930,Almost_sure_1940,To_review_1930,To_review_1940)

}


# 1. Importing tables
## A. Single and multiple: for these the file contains both a title (industry, occupation) in 1930 and in 1940. (I.e. the file didn't rely on id variable)
### Single files: Contain one-to-one matches
single <- f_lower(as.data.table( read_excel(paste0(main_directory,"R - Processing data/temp/unmatched_1930_1940.manual_edited.xlsx"), sheet = "single") )[,'2':=NULL])
#single <- merge(single,index_1930[,c("id_1930","indname_1930")],by="id_1930",all.x=TRUE,all.y=FALSE)
#single <- merge(single,index_1940[,c("id_1940","indname_1940")],by="id_1940",all.x=TRUE,all.y=FALSE)
single <- merge(single,index_1930[,c("original_1930","occ1930","ind1930","indname_1930")],by=c("original_1930","occ1930","ind1930"),all.x=TRUE,all.y=FALSE)
single <- merge(single,index_1940[,c("original_1940","occ1940","ind1940","indname_1940")],by=c("original_1940","occ1940","ind1940"),all.x=TRUE,all.y=FALSE)[,`:=`(id_1930=as.numeric(id_1930),id_1940=as.numeric(id_1940))]

### Multiple: one-to-many matches
code_3_1930 <- f_lower(as.data.table( read_excel(paste0(main_directory,"R - Processing data/temp/unmatched_1930_1940.manual_edited.xlsx"), sheet = "code_3_1930") ))
code_3_1940 <- f_lower(as.data.table( read_excel(paste0(main_directory,"R - Processing data/temp/unmatched_1930_1940.manual_edited.xlsx"), sheet = "code_3_1940") ))
multiple <- merge(code_3_1930,code_3_1940,by="match_id_code_3",all=TRUE)
#multiple <- merge(multiple,index_1930[,c("id_1930","indname_1930")],by="id_1930",all.x=TRUE,all.y=FALSE)
#multiple <- merge(multiple,index_1940[,c("id_1940","indname_1940")],by="id_1940",all.x=TRUE,all.y=FALSE)
multiple <- merge(multiple,index_1930[,c("original_1930","occ1930","ind1930","indname_1930")],by=c("original_1930","occ1930","ind1930"),all.x=TRUE,all.y=FALSE)
multiple <- merge(multiple,index_1940[,c("original_1940","occ1940","ind1940","indname_1940")],by=c("original_1940","occ1940","ind1940"),all.x=TRUE,all.y=FALSE)
multiple <- multiple[,`:=`(multiple_year=NULL,match_id_code_3=NULL)][,`:=`(id_1930=as.numeric(id_1930),id_1940=as.numeric(id_1940))]
rm(code_3_1930,code_3_1940)

### Drop
code_8 <- f_lower(as.data.table( read_excel(paste0(main_directory,"R - Processing data/temp/unmatched_1930_1940.manual_edited.xlsx"), sheet = "code_8") )[,'8':=NULL])[,`:=`(id_1930=as.numeric(id_1930),id_1940=as.numeric(id_1940))]
Drop_1930 <- code_8[id_1930!="",c("id_1930","original","original_1930","occ1930","ind1930")]
Drop_1940 <- code_8[id_1940!="",c("id_1940","original","original_1940","occ1940","ind1940")]
rm(code_8)

## B. R_match, Almost_sure, To_review: the original sheets in the "unmatched...edited" relied on id variables. In a previous step we used the id variables to attach the title/industry/occupation variables of the matched title. Here we simply import those files

R_matches_1930 <- f_lower(read_fst(paste0(main_directory,"R - Processing data/output/Rdata/R_matches_1930.fst"),as.data.table=TRUE) )[,`:=`(id_1930=as.numeric(id_1930),id_1940=as.numeric(id_1940))]
R_matches_1940 <- f_lower(read_fst(paste0(main_directory,"R - Processing data/output/Rdata/R_matches_1940.fst"),as.data.table=TRUE) )[,`:=`(id_1930=as.numeric(id_1930),id_1940=as.numeric(id_1940))]
Almost_sure_1930 <- f_lower(read_fst(paste0(main_directory,"R - Processing data/output/Rdata/Almost_sure_1930.fst"),as.data.table=TRUE) )[,`:=`(id_1930=as.numeric(id_1930),id_1940=as.numeric(id_1940))]
Almost_sure_1940 <- f_lower(read_fst(paste0(main_directory,"R - Processing data/output/Rdata/Almost_sure_1940.fst"),as.data.table=TRUE) )[,`:=`(id_1930=as.numeric(id_1930),id_1940=as.numeric(id_1940))]
To_review_1930 <- f_lower(read_fst(paste0(main_directory,"R - Processing data/output/Rdata/To_review_1930.fst"),as.data.table=TRUE) )[,`:=`(id_1930=as.numeric(id_1930),id_1940=as.numeric(id_1940))]
To_review_1940 <- f_lower(read_fst(paste0(main_directory,"R - Processing data/output/Rdata/To_review_1940.fst"),as.data.table=TRUE) )[,`:=`(id_1930=as.numeric(id_1930),id_1940=as.numeric(id_1940))]
```


### 4.3.2. Using the manually created matched files
```{r}
# 2. Changing original variables
f <- function(X) {
  # Note: The function changes by reference the data.table X
  # TODO: Make it so that we can choose the columns (first one, then multiple) 
  X[,original_1930:=tolower(original_1930)][,original_1930:=f_clean_conj(f_change_words(f_change_syms(f_clean_punct(original_1930,flag=0) )))][,original_1930:=str_squish(gsub(", or | or, |, or, | ,or, | or ,|, or ,"," or ",original_1930))]
  X[,original_1940:=tolower(original_1940)][,original_1940:=f_clean_conj(f_change_words(f_change_syms(f_clean_punct(original_1940,flag=0) )))][,original_1940:=str_squish(gsub(", or | or, |, or, | ,or, | or ,|, or ,"," or ",original_1940))]
  
  #X$original <- mgsub(words_subs1$term,words_subs1$change,X$original,fixed=FALSE)
  X$original_1930 <- mgsub(words_subs1$term,words_subs1$change,X$original_1930,fixed=FALSE)
  X$original_1940 <- mgsub(words_subs1$term,words_subs1$change,X$original_1940,fixed=FALSE)
  return(X)
}

# TO-DO: Do we need to use this function in the files created? 


# 3. Match using the single file
## Add the single matches
matched_1930_1940 <- rbind(matched_1930_1940,single[,round:=9],fill=TRUE)

## Subset the unmatched titles
#title_merge_1930 <- merge(title_merge_1930,matched_1930_1940[,c("id_1930","round")],by="id_1930",all.x=TRUE,all.y=FALSE)[is.na(round)][,round:=NULL]
#title_merge_1940 <- merge(title_merge_1940,matched_1930_1940[,c("id_1940","round")],by="id_1940",all.x=TRUE,all.y=FALSE)[is.na(round)][,round:=NULL]
title_merge_1930 <- merge(title_merge_1930,matched_1930_1940[,c("original_1930","occ1930","ind1930","round")],by=c("original_1930","occ1930","ind1930"),all.x=TRUE,all.y=FALSE)[is.na(round)][,round:=NULL]
title_merge_1940 <- merge(title_merge_1940,matched_1930_1940[,c("original_1940","occ1940","ind1940","round")],by=c("original_1940","occ1940","ind1940"),all.x=TRUE,all.y=FALSE)[is.na(round)][,round:=NULL]

# 4. Match using the multiple files
## Add the multiple matches
matched_1930_1940 <- rbind(matched_1930_1940,multiple[,round:=10],fill=TRUE)

# Subset the unmatched titles
title_merge_1930 <- merge(title_merge_1930,matched_1930_1940[,c("original_1930","occ1930","ind1930","round")],by=c("original_1930","occ1930","ind1930"),all.x=TRUE,all.y=FALSE)[is.na(round)][,round:=NULL]
title_merge_1940 <- merge(title_merge_1940,matched_1930_1940[,c("original_1940","occ1940","ind1940","round")],by=c("original_1940","occ1940","ind1940"),all.x=TRUE,all.y=FALSE)[is.na(round)][,round:=NULL]

# 5. Match using the R_match file
matched_1930_1940 <- rbind(
                          rbind(matched_1930_1940,R_matches_1930[,round:=11],fill=TRUE),
                          R_matches_1940[,round:=11],fill=TRUE
                          )

## Subset the unmatched titles
title_merge_1930 <- merge(title_merge_1930,matched_1930_1940[,c("original_1930","occ1930","ind1930","round")],by=c("original_1930","occ1930","ind1930"),all.x=TRUE,all.y=FALSE)[is.na(round)][,round:=NULL]
title_merge_1940 <- merge(title_merge_1940,matched_1930_1940[,c("original_1940","occ1940","ind1940","round")],by=c("original_1940","occ1940","ind1940"),all.x=TRUE,all.y=FALSE)[is.na(round)][,round:=NULL]

# 6. Match using the almost sure
matched_1930_1940 <- rbind(
                          rbind(matched_1930_1940,Almost_sure_1930[,round:=12],fill=TRUE),
                          Almost_sure_1940[,round:=12],fill=TRUE
                          )

## Subset the unmatched titles
title_merge_1930 <- merge(title_merge_1930,matched_1930_1940[,c("original_1930","occ1930","ind1930","round")],by=c("original_1930","occ1930","ind1930"),all.x=TRUE,all.y=FALSE)[is.na(round)][,round:=NULL]
title_merge_1940 <- merge(title_merge_1940,matched_1930_1940[,c("original_1940","occ1940","ind1940","round")],by=c("original_1940","occ1940","ind1940"),all.x=TRUE,all.y=FALSE)[is.na(round)][,round:=NULL]

# 7. Match using the to review
matched_1930_1940 <- rbind(
                          rbind(matched_1930_1940,To_review_1930[,round:=13],fill=TRUE),
                          To_review_1940[,round:=13],fill=TRUE
                          )

## Subset the unmatched titles
title_merge_1930 <- merge(title_merge_1930,matched_1930_1940[,c("original_1930","occ1930","ind1930","round")],by=c("original_1930","occ1930","ind1930"),all.x=TRUE,all.y=FALSE)[is.na(round)][,round:=NULL]
title_merge_1940 <- merge(title_merge_1940,matched_1930_1940[,c("original_1940","occ1940","ind1940","round")],by=c("original_1940","occ1940","ind1940"),all.x=TRUE,all.y=FALSE)[is.na(round)][,round:=NULL]

# 8. Drop some titles using the Drop file and (in 1940 I will drop all the titles that have a "See ..." type of statement)
title_merge_1930 <- merge(title_merge_1930,Drop_1930[,c("original_1930","occ1930","ind1930")][,round:=14],by=c("original_1930","occ1930","ind1930"),all.x=TRUE,all.y=FALSE)[is.na(round)][,round:=NULL]

title_merge_1940 <- merge(title_merge_1940,Drop_1940[,c("original_1940","occ1940","ind1940")][,round:=14],by=c("original_1940","occ1940","ind1940"),all.x=TRUE,all.y=FALSE)[is.na(round)][,round:=NULL]
title_merge_1940 <- title_merge_1940[!(occ1940=="0" | is.na(occ1940)) ]

```

### 4.4. Using the stemmed and reordered title and industry
### Creating an expanded file with title and industry
```{r}
# "Expand" the titles
## 1930
temp_1930 <- title_edits.1930[,c("id_1930","title_1930_plain_with_replacements_stemmed_r","parentheses1_1930_plain_with_replacements_stemmed_r")][parentheses1_1930_plain_with_replacements_stemmed_r!="" & !is.na(parentheses1_1930_plain_with_replacements_stemmed_r),parentheses1_1930_plain_with_replacements_stemmed_r:=paste(title_1930_plain_with_replacements_stemmed_r,parentheses1_1930_plain_with_replacements_stemmed_r,sep= " ")]
temp <- temp_1930[,c("id_1930","parentheses1_1930_plain_with_replacements_stemmed_r")][!is.na(parentheses1_1930_plain_with_replacements_stemmed_r)]
setnames(temp,c("parentheses1_1930_plain_with_replacements_stemmed_r"),c("title_1930_plain_with_replacements_stemmed"))
temp <- merge(temp,f_reorder(temp,title_1930_plain_with_replacements_stemmed,r=r),by="title_1930_plain_with_replacements_stemmed")[,c("title_1930_plain_with_replacements_stemmed"):=NULL]
temp_1930 <- rbind(temp_1930[,c("id_1930","title_1930_plain_with_replacements_stemmed_r")],temp)
rm(temp)

## 1940
temp_1940 <- title_edits.1940[,c("id_1940","title_1940_plain_with_replacements_stemmed_r","parentheses1_1940_plain_with_replacements_stemmed_r")][parentheses1_1940_plain_with_replacements_stemmed_r!="" & !is.na(parentheses1_1940_plain_with_replacements_stemmed_r),parentheses1_1940_plain_with_replacements_stemmed_r:=paste(title_1940_plain_with_replacements_stemmed_r,parentheses1_1940_plain_with_replacements_stemmed_r,sep= " ")]
temp <- temp_1940[,c("id_1940","parentheses1_1940_plain_with_replacements_stemmed_r")][!is.na(parentheses1_1940_plain_with_replacements_stemmed_r)]
setnames(temp,c("parentheses1_1940_plain_with_replacements_stemmed_r"),c("title_1940_plain_with_replacements_stemmed"))
temp <- merge(temp,f_reorder(temp,title_1940_plain_with_replacements_stemmed,r=r),by="title_1940_plain_with_replacements_stemmed")[,c("title_1940_plain_with_replacements_stemmed"):=NULL]
temp_1940 <- rbind(temp_1940[,c("id_1940","title_1940_plain_with_replacements_stemmed_r")],temp)
rm(temp)

# "Expand" the industries
## 1930
ind_temp_1930 <- index_1930.indpar_edits[,c("id_1930","indname_1930_plain_with_replacements_stemmed_r","parentheses1_1930_plain_with_replacements_stemmed_r")]
ind_temp_1930 <- ind_temp_1930[parentheses1_1930_plain_with_replacements_stemmed_r!="" & !is.na(parentheses1_1930_plain_with_replacements_stemmed_r),parentheses1_1930_plain_with_replacements_stemmed_r:=
                                 ifelse(
                                   !(indname_1930_plain_with_replacements_stemmed_r=="" | is.na(indname_1930_plain_with_replacements_stemmed_r)),
                                   str_squish(paste(indname_1930_plain_with_replacements_stemmed_r,parentheses1_1930_plain_with_replacements_stemmed_r,sep= " ")),
                                   parentheses1_1930_plain_with_replacements_stemmed_r
                                   )]
ind_temp <- ind_temp_1930[,c("id_1930","parentheses1_1930_plain_with_replacements_stemmed_r")][!is.na(parentheses1_1930_plain_with_replacements_stemmed_r)]
setnames(ind_temp,c("parentheses1_1930_plain_with_replacements_stemmed_r"),c("indname_1930_plain_with_replacements_stemmed"))
ind_temp <- merge(ind_temp,f_reorder(ind_temp,indname_1930_plain_with_replacements_stemmed,r=r),by="indname_1930_plain_with_replacements_stemmed")[,c("indname_1930_plain_with_replacements_stemmed"):=NULL]
ind_temp_1930 <- rbind(ind_temp_1930[,c("id_1930","indname_1930_plain_with_replacements_stemmed_r")],ind_temp)
rm(ind_temp)

## 1940
ind_temp_1940 <- index_1940.indpar_edits[,c("id_1940","indname_1940_plain_with_replacements_stemmed_r","parentheses1_1940_plain_with_replacements_stemmed_r")]
ind_temp_1940 <- ind_temp_1940[parentheses1_1940_plain_with_replacements_stemmed_r!="" & !is.na(parentheses1_1940_plain_with_replacements_stemmed_r),parentheses1_1940_plain_with_replacements_stemmed_r:=
                                 ifelse(
                                   !(indname_1940_plain_with_replacements_stemmed_r=="" | is.na(indname_1940_plain_with_replacements_stemmed_r)),
                                   str_squish(paste(indname_1940_plain_with_replacements_stemmed_r,parentheses1_1940_plain_with_replacements_stemmed_r,sep= " ")),
                                   parentheses1_1940_plain_with_replacements_stemmed_r
                                   )]
ind_temp <- ind_temp_1940[,c("id_1940","parentheses1_1940_plain_with_replacements_stemmed_r")][!is.na(parentheses1_1940_plain_with_replacements_stemmed_r)]
setnames(ind_temp,c("parentheses1_1940_plain_with_replacements_stemmed_r"),c("indname_1940_plain_with_replacements_stemmed"))
ind_temp <- merge(ind_temp,f_reorder(ind_temp,indname_1940_plain_with_replacements_stemmed,r=r),by="indname_1940_plain_with_replacements_stemmed")[,c("indname_1940_plain_with_replacements_stemmed"):=NULL]
ind_temp_1940 <- rbind(ind_temp_1940[,c("id_1940","indname_1940_plain_with_replacements_stemmed_r")],ind_temp)
rm(ind_temp)

# Combine title and industry
temp_1930 <- merge(temp_1930,ind_temp_1930,by="id_1930",all=TRUE,allow.cartesian=TRUE)[,`:=`(title=title_1930_plain_with_replacements_stemmed_r,industry=indname_1930_plain_with_replacements_stemmed_r)]
temp_1940 <- merge(temp_1940,ind_temp_1940,by="id_1940",all=TRUE,allow.cartesian=TRUE)[,`:=`(title=title_1940_plain_with_replacements_stemmed_r,industry=indname_1940_plain_with_replacements_stemmed_r)]

# Merge unmatched titles with temp
a_1930 <- merge(title_merge_1930[,c("id_1930")],temp_1930,by="id_1930",all.x=TRUE,all.y=FALSE,allow.cartesian = TRUE)
a_1940 <- merge(title_merge_1940[,c("id_1940")],temp_1940,by="id_1940",all.x=TRUE,all.y=FALSE,allow.cartesian = TRUE)

# Find matches
a_1930 <- merge(a_1930,temp_1940,by=c("title","industry"),allow.x=TRUE,allow.y=FALSE,allow.cartesian=TRUE)
a_1940 <- merge(a_1940,temp_1930,by=c("title","industry"),allow.x=TRUE,allow.y=FALSE,allow.cartesian=TRUE)

# Select the matched titles
a_1930 <- 
  merge(
        merge(title_merge_1930,a_1930[,c("id_1930","id_1940")],by="id_1930",all.x=FALSE,all.y=TRUE),
        index_1940[,c("id_1940","original_1940","occ1940","ind1940","indname_1940")],by="id_1940", all.x=TRUE,all.y=FALSE
  )
a_1940 <- 
  merge(
        merge(title_merge_1940,a_1940[,c("id_1930","id_1940")],by="id_1940",all.x=FALSE,all.y=TRUE),
        index_1930[,c("id_1930","original_1930","occ1930","ind1930","indname_1930")],by="id_1930", all.x=TRUE,all.y=FALSE
  )

matched_1930_1940 <-  rbind(
            rbind(matched_1930_1940,a_1930[,!c("title_1930_plain_with_replacements_stemmed_r")][,round:=14],fill=TRUE),
            a_1940[,!c("title_1940_plain_with_replacements_stemmed_r")][,round:=14],fill=TRUE
            )

## Subset the unmatched titles
title_merge_1930 <- merge(title_merge_1930,matched_1930_1940[,c("id_1930","round")],by=c("id_1930"),all.x=TRUE,all.y=FALSE)[is.na(round)][,round:=NULL]
title_merge_1940 <- merge(title_merge_1940,matched_1930_1940[,c("id_1940","round")],by=c("id_1940"),all.x=TRUE,all.y=FALSE)[is.na(round)][,round:=NULL]

```
After the different changes that the original variables have gone through (including the manual matches) we were able to match all but a few titles in 1930. In a parallel way, we were not able to match around 1330 titles in 1940. These are candidates for new  

# 5. Match the different final sets with title edits, which contains title names after cleaning, reordered title names and stemmed ones
*** NOTE: Should we also include title parentheses, industry, industry parentheses ???
```{r}
matched_1930_1940 <- merge( 
  merge(matched_1930_1940,title_edits.1930[,c("id_1930","title_1930_plain_with_replacements_stemmed","title_1930_plain_with_replacements_stemmed_r")],by="id_1930"),
  title_edits.1940[,c("id_1940","title_1940_plain_with_replacements_stemmed","title_1940_plain_with_replacements_stemmed_r")],by="id_1940")

title_merge_1930 <- merge(title_merge_1930,title_edits.1930[,c("id_1930","title_1930_plain_with_replacements_stemmed","title_1930_plain_with_replacements_stemmed_r")],by="id_1930")
title_merge_1940 <- merge(title_merge_1940,title_edits.1940[,c("id_1940","title_1940_plain_with_replacements_stemmed","title_1940_plain_with_replacements_stemmed_r")],by="id_1940")

```


# 6. Crosswalk between occ1930 and occind1940
Using the table of matched titles we construct a simple crosswalk between the two occupational classifications. Even though there were not major changes from one year to another in terms of the number of groups, the numbering system (??better word??) changed substantially from one year to another and many titles were moved to different groups. These crosswalk might allow us to construct an homogeneous classification that covers both year (keep in mind that IPUMS did something similar with his 1950 classification).


********** TO BE DONE **************
```{r}
if (FALSE) {
# Constructing the crosswalk
crosswalk.1930_1940.matched <- matched_1930_1940[,c("occ1930","occind1930")][,n:=1][,lapply(.SD,sum),by=c("occ1920","occind1930"),.SDcols=c("n")][,n.occind1930:=sum(n),by="occind1930"][,share.occind1930:=n/n.occind1930][,n.occ1920:=sum(n),by="occ1920"][,share.occ1920:=n/n.occ1920][,lapply(.SD,mean),by=c("occ1920","occind1930"),.SDcols=c("n","n.occ1920","n.occind1930","share.occ1920","share.occind1930")]

# Matching occ names
crosswalk.1920_1930.matched <- merge(  merge(crosswalk.1920_1930.matched,occ1930.names[,c("occind1930","occind1930_name")],by="occind1930",all.x=TRUE,all.y=FALSE),
                                       occ1920.names[,c("occ1920","occ1920_name")],by="occ1920",all.x=TRUE,all.y=FALSE)
setorderv(crosswalk.1920_1930.matched,c("share.occ1920","occind1930"),c(-1,1))

}
```


# 7. Explore the set of unique titles and the set of industries
One of the problems that we have is when we are dealing with occupations that appear in multiple 2 digit industries. Where should we assign them?
Here we will look at the list of occupations by occ/ind combination, accounting the number of titles and unique titles. The objective is to define for each occupation a set of industries that can be associated to them.

## 7.1. Construct an expanded dataset index_1940, by assigning industry in ind1940_par to titles where ind1940="ind" and ind1940_par!=99
To reduce the number of titles with an unspecified industry (i.e. ind) we will create a list of different combinations of "indname_1940_par_ind1940" and "indname_1940_change". In some cases it is straightforward to assign an occ1940-Ind-indname_1940_par_ind1940-indname_1940 to a specific ind1940 or industry group. In other cases we might be dealing with a true "repeater" occupation. In those cases it is better to assign the title to every possible industry.
We create a file that specifies which occupations can be assigned to an industry using ind1940_par
```{r}
A <- index_1940[ind1940=="ind" & ind1940_par!="99" & ind1940_par!="" & !is.na(ind1940_par)][,.(count=sum(.N)),by=c("indname_1940_par_ind1940","indname_1940","parentheses1_1940")]
B <- merge(index_1940[ind1940=="ind"][,.(count=sum(.N)),by=c("ind1940_par","indname_1940_par_ind1940","indname_1940","parentheses1_1940")],ind1940.names[,c("ind1940","name_ind1940_subgroup")],by.x=c("ind1940_par"),by.y=c("ind1940"),all.x=TRUE,all.y=FALSE)[order(ind1940_par,indname_1940,parentheses1_1940)]

write.xlsx(B,paste0(main_directory,"R - Processing data/temp/index_1940_occs_with_ind1940_ind.xlsx"),row.names = TRUE)
```

After manually specifying which Ind-ind1940_par-indname_1940_change to assign to a specific industry we import the file
```{r}
B <- as.data.table( read_excel(paste0(main_directory,"R - Processing data/temp/index_1940_occs_with_ind1940_ind_edited.xlsx"), sheet = "Final") )


# EXPAND THE INDEX_1940 FILE AND CREATE NEW VARIABLE (IND1940_CHANGE)
## Mix with ind1940.names
index_1940.expanded <- rbind(
      merge(B[code==2 & !is.na(match_var)],ind1940.names[,c("ind1940","name_ind1940_subgroup")],by.x=c("match_var"),by.y=c("name_ind1940_subgroup"),all.x=TRUE,all.y=FALSE,allow.cartesian=TRUE),
      merge(B[code==3 & !is.na(match_var)],ind1940.names[,c("ind1940","name_ind1940_main")],by.x=c("match_var"),by.y=c("name_ind1940_main"),all.x=TRUE,all.y=FALSE,allow.cartesian=TRUE),
      copy(B)[!is.na(ind1940_par) & is.na(code)][,ind1940:=ind1940_par],fill=TRUE)

## Drop if it is an excluded sector
index_1940.expanded <- index_1940.expanded[is.na(exc_1) | (!is.na(exc_1) & (is.na(exc_2) & (ind1940 != exc_1) | !is.na(exc_2) & (ind1940 != exc_1 & ind1940 != exc_2)  ) )]

## Assign different ind1940 variable for merge with index_1940
index_1940.expanded <- index_1940.expanded[,ind1940_change:=ind1940][,ind1940:="ind"][,indname_1940:=ifelse(is.na(indname_1940),"",indname_1940)][,ind1940_par:=ifelse(is.na(ind1940_par),"",ind1940_par)]

## Merge with index_1940
### Merge those titles with both "ind1940_par" and "indname_1940_change"
index_1940.expanded <- merge(index_1940,index_1940.expanded[,c("ind1940","ind1940_par","indname_1940","parentheses1_1940","ind1940_change")],by=c("ind1940","ind1940_par","indname_1940","parentheses1_1940"),all.x=TRUE,all.y=TRUE,allow.cartesian=TRUE)
index_1940.expanded <- index_1940.expanded[,ind1940_change:=ifelse(is.na(ind1940_change),ind1940,ind1940_change)]
rm(B)


#Drop some repeated observations that are due to the matched of occupations with ind1940=="ind"
## Flags FUNCTION
flag <- function(X) {
  ### Flag duplicated titles by c("occ1940","ind1940_change")
  y <- X[,dup:=0+duplicated(title_1940),by=c("occ1940","ind1940_change")][,maxdup:=max(dup),by=c("title_1940","occ1940","ind1940_change")]
  ### Flag titles that are ind1940==ind
  y <- y[,select:=ifelse(ind1940=="ind",1,0)][,maxselect:=max(select),by=c("title_1940","occ1940","ind1940_change")][,minselect:=min(select),by=c("title_1940","occ1940","ind1940_change")]
  ### Flag titles that have only ind1940_par == 99 or ""
  y <- y[,na_or_99:=ifelse(ind1940=="ind" & (ind1940_par=="99" | ind1940_par==""),1,0)][,maxna_or_99:=max(na_or_99),by=c("title_1940","occ1940","ind1940_change")][,minna_or_99:=min(na_or_99),by=c("title_1940","occ1940","ind1940_change")]
  return(y)
}

## Drop
# NOTE: I keep track of the number of titles in each one of the iterations
count.index_1940.expanded <- data.table(set=c(1),No_titles=c(count(index_1940.expanded)))

### 2. Duplicated titles where at least one has an ind1940!=ind. -> Drop titles that have ind1940!="ind"
index_1940.expanded <- flag(index_1940.expanded)
index_1940.expanded <- index_1940.expanded[!(  (maxdup==1 & (minselect==0 & maxselect==1)) & (ind1940=="ind")  )]
count.index_1940.expanded <- rbind(count.index_1940.expanded,data.table(set=c(2),No_titles=c(count(index_1940.expanded))))

### Duplicated titles (maxdup==1) where the category is ind1940_change=="ind" 
#### 3. ---> Drop ind1940_par=99 or ="" IF at least one ind1940_par different than 99 or "" (minna_or_99==0)
index_1940.expanded <- flag(index_1940.expanded[,c("dup","maxdup","select","maxselect","minselect","na_or_99","maxna_or_99","minna_or_99"):=NULL])
index_1940.expanded <- index_1940.expanded[!(  
               maxdup==1  
               & (ind1940_change=="ind") 
               & (minna_or_99==0)   
               & (ind1940_par=="99" | ind1940_par=="")    
          )]
count.index_1940.expanded <- rbind(count.index_1940.expanded,data.table(set=c(3),No_titles=c(count(index_1940.expanded))))

#### 4. ---> If all repeated titles have ind1940_par=99 or "" (minna_or_99==1)
index_1940.expanded <- flag(index_1940.expanded[,c("dup","maxdup","select","maxselect","minselect","na_or_99","maxna_or_99","minna_or_99"):=NULL])
index_1940.expanded <- index_1940.expanded[!(  
               maxdup==1  
               & (ind1940_change=="ind") 
               & (minna_or_99==1)   
               & dup==1    
          )]
count.index_1940.expanded <- rbind(count.index_1940.expanded,data.table(set=c(4),No_titles=c(count(index_1940.expanded))))

### Duplicated titles (maxdup==1) where all have ind1940=="ind" (minselect==1)
#### 5. At least one has ind1940_par==99 or na and one not that not --> Drop 99 or na
index_1940.expanded <- flag(index_1940.expanded[,c("dup","maxdup","select","maxselect","minselect","na_or_99","maxna_or_99","minna_or_99"):=NULL])
index_1940.expanded <- index_1940.expanded[!(  
               maxdup==1  
               & (minselect==1)   
               & (minna_or_99==0 & maxna_or_99==1)   
               & (ind1940_par=="99" | ind1940_par=="")
          )]
count.index_1940.expanded <- rbind(count.index_1940.expanded,data.table(set=c(5),No_titles=c(count(index_1940.expanded))))

#### 6. NO ind1940_par==99 or na (maxna_or_99==0)
index_1940.expanded <- flag(index_1940.expanded[,c("dup","maxdup","select","maxselect","minselect","na_or_99","maxna_or_99","minna_or_99"):=NULL])
index_1940.expanded <- index_1940.expanded[!(  
               maxdup==1  
               & (minselect==1)   
               & (maxna_or_99==0)   
               & dup==1
          )]
count.index_1940.expanded <- rbind(count.index_1940.expanded,data.table(set=c(6),No_titles=c(count(index_1940.expanded))))

### 7. Drop titles that have ind1940==99 and that already exist in the occupation category
index_1940.expanded <- index_1940.expanded[,c("dup","maxdup","select","maxselect","minselect","na_or_99","maxna_or_99","minna_or_99"):=NULL][,dup:=0+duplicated(title_1940),by=c("occ1940")][,maxdup:=max(dup),by=c("title_1940","occ1940")]
index_1940.expanded <- index_1940.expanded[!(
              maxdup==1
              & ind1940=="99"
          )]
count.index_1940.expanded <- rbind(count.index_1940.expanded,data.table(set=c(7),No_titles=c(count(index_1940.expanded))))


### 8. Drop titles that are not new, that already appear in the occ group and that have and ind_1940_par of 99 or "empty" (not sure about this)
#### Merge with the title_merge_1940 dataset
index_1940.expanded <- merge(index_1940.expanded[,!c("dup","maxdup")],title_merge_1940[,c("id_1940")][,new:=1],by="id_1940",all.x=TRUE,all.y=FALSE)[is.na(new),new:=0]

#### Merge with expanded, stemmed, reordered title.
#* NOTE: Do we care about the industry???
index_1940.expanded <- merge(index_1940.expanded,unique(temp_1940[,c("id_1940","title_1940_plain_with_replacements_stemmed_r")]),by="id_1940",all.x=TRUE,all.y=FALSE)

#### Drop if already appear in the occ group and that have and ind_1940_par of 99 or "empty" (not sure about this).
# 1. max dup variable if title already appears 
index_1940.expanded <-index_1940.expanded[,dup:=0+duplicated(title_1940_plain_with_replacements_stemmed_r),by=c("occ1940")][,not_ind:=ifelse(ind1940!="ind",1,0)][,`:=`(dup=max(dup),not_ind=max(not_ind)),by=c("title_1940_plain_with_replacements_stemmed_r","occ1940")]

# 2. Flag if conditions are satisfied but title is new
index_1940.expanded <- index_1940.expanded[,flag:=ifelse(ind1940=="ind" & ind1940_par %in% c(99,"") & dup==1 & not_ind==1 & new==1,1,0)]

# 3. drop if max dup=1, ind_1940=ind, ind_1940_par=99 or "" and new=0
index_1940.expanded <- index_1940.expanded[!(ind1940=="ind" & ind1940_par %in% c(99,"") & dup==1 & not_ind==1 & new==0 & flag==0)][,!c("dup","not_ind")]


```
Variables:
- ind1940_change = industry category that includes the manual replacements using ind1940_par


## 7.2. Reduce occ-ind combinations
We only care about keeping different ind1940 by occ if there are difference in the number of new titles between them. Thus, we will combine any occ-ind groups that satisfy this condition

### Reduce if no new titles or just one ind category
```{r}
# Combine all titles in retail and wholesale
## Merge with the subindustry names
index_1940.expanded <- merge(index_1940.expanded,ind1940.names[,c("ind1940","name_ind1940_subgroup")],by.x="ind1940_change",by.y="ind1940",all.x=TRUE,all.y=FALSE)

## Combine Retail Industry and Government
index_1940.expanded <- index_1940.expanded[name_ind1940_subgroup=="Retail Trade",ind1940_change:="61"][name_ind1940_subgroup=="GOVERNMENT",ind1940_change:="95"]

## Drop repeated titles
index_1940.expanded <- index_1940.expanded[,dup:=0+duplicated(id_1940),by=c("occ1940","ind1940_change")][dup==0][,dup:=NULL]

# Combine if no new title in the occ1940 group
index_1940.expanded <- index_1940.expanded[,sumnew:=sum(new),by="occ1940"][,ind1940_change:=ifelse(sumnew==0,NA,ind1940_change)]

# Combine if only one industry category in the occ1940 group (we don't count "ind" as an industry category)
index_1940.expanded <- index_1940.expanded[,count_ind1940:=0+duplicated(ind1940),by="occ1940"][,count_ind1940:=(-1)*ifelse(count_ind1940==0,-1,0)*ifelse(ind1940=="ind",0,1)][,count_ind1940:=sum(count_ind1940),by="occ1940"][,ind1940_change:=ifelse(count_ind1940<=1,NA,ind1940_change)][,!c("sumnew","count_ind1940")]
#**** TO-DO: Should I work with ind1940_change???

# Reduce titles in occ1940-ind1940_change category
index_1940.expanded <- index_1940.expanded[,dup:=0+duplicated(id_1940),by=c("occ1940","ind1940_change")][dup==0][,dup:=NULL]

# Drop if occ1940 is NA or 0 
index_1940.expanded <- index_1940.expanded[!is.na(occ1940) & occ1940!=0 & occ1940!=""]

```

### Explore the set of occ1940
```{r}
count.occ1940_x_ind1940_change <- index_1940.expanded[,.(N_titles=.N,N_new=sum(new)),by=c("occ1940","ind1940_change")][,sh_new:=N_new/N_titles]

```

## 7.3. Work only with sub_industries
```{r}
# Create the dataset with subindustry
index_1940.by_subindustry <- index_1940.expanded[,dup:=0+duplicated(id_1940),by=c("occ1940","name_ind1940_subgroup")][dup==0][,dup:=NULL]

# Combine if no new title in the occ1940 group
index_1940.by_subindustry <- index_1940.by_subindustry[,sumnew:=sum(new),by="occ1940"][,`:=`(ind1940_change=ifelse(sumnew==0,NA,ind1940_change),name_ind1940_subgroup=ifelse(sumnew==0,NA,name_ind1940_subgroup))]

# Combine if only one industry category in the occ1940 group (we don't count "ind" as an industry category)
index_1940.by_subindustry <- index_1940.by_subindustry[,count_name_ind1940_subgroup:=0+duplicated(name_ind1940_subgroup),by="occ1940"][,count_name_ind1940_subgroup:=(-1)*ifelse(count_name_ind1940_subgroup==0,-1,0)*ifelse(name_ind1940_subgroup=="" | is.na(name_ind1940_subgroup),0,1)][,count_name_ind1940_subgroup:=sum(count_name_ind1940_subgroup),by="occ1940"][,`:=`(ind1940_change=ifelse(count_name_ind1940_subgroup<=1,NA,ind1940_change),name_ind1940_subgroup=ifelse(count_name_ind1940_subgroup<=1,NA,name_ind1940_subgroup) )][,!c("sumnew","count_name_ind1940_subgroup")]


# Collapsed list of occ1940-name_ind1940_subgroup 
## Create: (1: number of titles, 2: Number of ind groups per occ1940, 3: Share of new titles, 4: occ1940 with an ind==NA)
count.occ1940_x_name_ind1940_subgroup <- index_1940.by_subindustry[,.(N_titles=.N,N_new=sum(new)),by=c("occ1940","name_ind1940_subgroup")][,N_ind_per_occ1940:=-1+duplicated(name_ind1940_subgroup),by="occ1940"][,N_ind_per_occ1940:=-sum(N_ind_per_occ1940),by="occ1940"][,sh_new:=N_new/N_titles]
count.occ1940_x_name_ind1940_subgroup <- count.occ1940_x_name_ind1940_subgroup[,NA_category:=ifelse(is.na(name_ind1940_subgroup),1,0)][,NA_category:=max(NA_category),by="occ1940"]

#View(count.occ1940_x_name_ind1940_subgroup[N_ind_per_occ1940>1 & NA_category==1])
```


## 7.4. Reduce titles
TO-DO: The following procedure should be done for both the set with  the disaggregated industries and the set with the subindustries. For now I'm just doing it for the aggregated set
### 7.4.1. Flag/drop repeated titles if no industry, eliminate titles with industry group "NONCLASSIFIABLE"...
```{r}
# 1. Creating expanded list
index_1940.by_subindustry <- 
  merge(
    index_1940.by_subindustry[,c("id_1940","occ1940","name_ind1940_subgroup","new")],
    temp_1940[,c("id_1940","title_1940_plain_with_replacements_stemmed_r","indname_1940_plain_with_replacements_stemmed_r")][order(id_1940,title_1940_plain_with_replacements_stemmed_r,indname_1940_plain_with_replacements_stemmed_r)][,.SD[1],by=c("id_1940","title_1940_plain_with_replacements_stemmed_r")],
    by="id_1940",
    all.x=TRUE, all.y=FALSE, allow.cartesian=TRUE
  )[order(occ1940,name_ind1940_subgroup,title_1940_plain_with_replacements_stemmed_r,indname_1940_plain_with_replacements_stemmed_r,-new)]

# 2. Drop if exact same tit, ind, occ...
index_1940.by_subindustry <- index_1940.by_subindustry[,dup:=0+duplicated(index_1940.by_subindustry, by=c("title_1940_plain_with_replacements_stemmed_r","indname_1940_plain_with_replacements_stemmed_r","occ1940","name_ind1940_subgroup"))][dup==0][,!c("dup")]

# 3. Flag/drop repeated titles that have no name_ind1940_subgroup
index_1940.by_subindustry <- index_1940.by_subindustry[,dup:=0+duplicated(title_1940_plain_with_replacements_stemmed_r),by=c("occ1940","name_ind1940_subgroup")][,dup:=max(dup),by=c("occ1940","name_ind1940_subgroup","title_1940_plain_with_replacements_stemmed_r")]
## Drop if repeated and industry is NA
index_1940.by_subindustry <- index_1940.by_subindustry[!(dup==1 & is.na(indname_1940_plain_with_replacements_stemmed_r))]

# 4. Drop workers in category 99
a <- list(N_titles=count(index_1940.by_subindustry[(name_ind1940_subgroup=="NONCLASSIFIABLE")]),N_new=sum(index_1940.by_subindustry[(name_ind1940_subgroup=="NONCLASSIFIABLE")]$new),N_problem_new="")
print(paste("Number of titles in the NONCLASSIFIABLE category: ",a[[1]]))
print(paste("Number of NEW titles in the NONCLASSIFIABLE category: ",a[[2]]))

index_1940.by_subindustry <- index_1940.by_subindustry[name_ind1940_subgroup!="NONCLASSIFIABLE" | is.na(name_ind1940_subgroup)]
# *NOTE: When I select name_ind1940_subgroup!="NONCLASSIFIABLE", R also drops every observation with NA in that column!!!

count.index_1940.by_subindustry <- index_1940.by_subindustry[,.(N_titles=.N,N_new=sum(new)),by=c("occ1940","name_ind1940_subgroup")][,N_ind_per_occ1940:=-1+duplicated(name_ind1940_subgroup),by="occ1940"][,N_ind_per_occ1940:=-sum(N_ind_per_occ1940),by="occ1940"][,sh_new:=N_new/N_titles]
count.index_1940.by_subindustry <- count.index_1940.by_subindustry[,NA_category:=ifelse(is.na(name_ind1940_subgroup),1,0)][,NA_category:=max(NA_category),by="occ1940"]
#View(count.index_1940.by_subindustry[N_ind_per_occ1940>1 & NA_category==1])

count.index_1940.by_subindustry <- count.index_1940.by_subindustry[,flag_few_titles:=ifelse(N_titles<4 & sh_new>=0.5,1,0)]
a[[3]] <- sum(count.index_1940.by_subindustry$flag_few_titles)
print(paste("Number of occ1940-subindustry categories that have less than 4 titles and a share of new larger than 50%: ",a[[3]]))

count.index_1940.by_subindustry <- count.index_1940.by_subindustry[,flag_few_titles:=max(flag_few_titles),by=c("occ1940")]
#View(count.index_1940.by_subindustry[flag_few_titles==1])
rm("a")

```

### 7.4.2. Finding duplicates within category
In this section we look at duplicates within the occupation-industry category. We further use those duplicates to recalculate the vector of new titles.
To deal with problem of the titles that have an industry category equal to "ind", we construct three different datasets: (i) one where the titles in the "ind" category are assigned to a new category, (ii) where we assign every title with "ind" category to each one of the existing industries and (iii) we omit the industry category, working only with the occupation category

#### 7.4.2.1 Dataset 1: "ind" as an independent category
##### Creating dataset, creating "Rest" industry
```{r}
# 1. Merging with stemmed title and industry information
index_1940.by_subindustry_dataset1 <- 
  merge(index_1940.by_subindustry[,c("id_1940","occ1940","name_ind1940_subgroup","new")],
        merge(
          title_edits.1940[,c("id_1940","title_1940_plain_with_replacements_stemmed","parentheses1_1940_plain_with_replacements_stemmed")],
          index_1940.indpar_edits[,c("id_1940","indname_1940_plain_with_replacements_stemmed","parentheses1_1940_plain_with_replacements_stemmed")][,`:=`(ind_parentheses1_1940_plain_with_replacements_stemmed=parentheses1_1940_plain_with_replacements_stemmed,parentheses1_1940_plain_with_replacements_stemmed=NULL)],
          by="id_1940",all=TRUE
        ),
        by="id_1940",all.x=TRUE,all.y=FALSE
  )
        
# 2. Rename industry category
index_1940.by_subindustry_dataset1 <- index_1940.by_subindustry_dataset1[is.na(name_ind1940_subgroup),name_ind1940_subgroup:= "REST"]

# 3. Drop repeated id within occ1940-name_ind1940_subgroup
index_1940.by_subindustry_dataset1 <- index_1940.by_subindustry_dataset1[,dup:=0+duplicated(id_1940),by=c("occ1940","name_ind1940_subgroup")][dup==0]

#View(index_1940.by_subindustry_dataset1[,dup:=max(dup),by=c("id_1940","occ1940","name_ind1940_subgroup")][dup==1])  
```
*** TO-DO : Why do I have repeated id_1940 variable by occ1940-name_ind_subgroup???


#### 7.4.2.1 Create variables to reduce observations and expand the set of matched observations
Here we use the f_reduce_match function, which creates 6 binary vectors to be described below. We can use half of them later to reduce the set of observation, by dropping repeated observations. We use different criteria to select repeated observations. The other half is used to extend the vector of matched titles. In the most basic example, if two observations within occind have the same title, but one has been matched to an observation in the 1920 index and another not, then we will assume that the other title was also matched.

##### Function to reduce the set of obs and to expand the matched observations
* NOTE: In the function we use many if statements which depend on the existence or not of the title and industry variables. Note that even if the user provides those variables, within an occupation-industry group, those variables might be NA (e.g. titles don't have parentheses) and the program will consider that the variable doesn't exist. Because of this, DON'T TRY TO REDUCE ALL THE CASES TO ONLY ONE, since the function won't work.
***TO-DO: Organize better the function's code
```{r}
f_reduce_match <- function(obs_f,tit_f,ind_f,tit_par_f,ind_par_f,match_f,flag_return=0,flag_extra=0){
  # 0. Some flag variables
  flag_tit_par <- flag_ind <- flag_ind_par <- 0
  # 1. Changing the name of the variables for further calculations and creating parentheses variables if they don't exist
  # The function has to have ind and tit
  if (missing(obs_f)) { stop("You need to provide and obs_v variable")
  } else if (missing(tit_f)) { stop("You need to provide a tit variable")
  } else if (missing(ind_f)) { stop("You need to provide an ind variable, even if the industries are all empty")
  }
  
  # Make sure obs variable is unique
  
  X_f <- data.table(obs=obs_f,tit=tit_f,ind=ind_f)
  y_f <- X_f[,c("obs")][,initial_obs:=1:.N]
  # Make sure obs variable is unique
  if (  nrow(unique(y_f,by="obs")) != nrow(y_f)   ) {
    stop("At least one number in the obs vector is repeated")
  }
  X_f <- X_f[,l:=0][ind=="",ind:=NA]
   
   # Title has to be different than NA for all observations  
  if (nrow(X_f[is.na(tit) | tit==""]) > 0) {
    warining("At least one observations has no title. Observation(s) will be eliminated")
    X_f <- X_f[!(is.na(tit) | tit=="")]
  }
   
  # Change flags if some of the variables are missing or are all NA or ""
  if ( !missing(tit_par_f) ) {
     X_f[,tit_par:=tit_par_f]
     X_f <- X_f[tit_par=="",tit_par:=NA][,l:= l + unlist(lapply(tit, str_length))][!is.na(tit_par),l:= l + 2 + unlist(lapply(tit_par, str_length))]
     if (nrow(X_f[!(is.na(tit_par) | tit_par=="")]) == 0) {flag_tit_par <-1}
  } else {
    X_f <- X_f[,l:= l + unlist(lapply(tit, str_length))]
    if (nrow(X_f[grepl("\\([^()]+\\)",tit)])>0) {
      X_f[grepl("\\([^()]+\\)",tit),tit_par:=gsub("\\(|\\)","",str_extract(tit,"\\([^()]+\\)"))][,tit := str_squish(  gsub("\\([^()]+\\)","",tit))]
    } else { 
      flag_tit_par <-1 
      }
  } 
  
  if (nrow(X_f[!(is.na(ind) | ind=="")]) == 0) { flag_ind <- 1}
  
  if (!missing(ind_par_f)) {
    X_f[,ind_par:=ind_par_f]
    X_f <- X_f[ind_par=="",ind_par:=NA][!is.na(ind),l:= l + unlist(lapply(ind, str_length))][!is.na(ind_par),l:= l + 2 + unlist(lapply(ind_par, str_length))]
    if (nrow(X_f[!(is.na(ind_par) | ind_par=="")]) == 0) {flag_ind_par <- 1}
  } else {
    X_f <- X_f[!is.na(ind),l:= l + unlist(lapply(ind, str_length))]
    if (nrow(X_f[grepl("\\([^()]+\\)",ind)])>0) {
      X_f[grepl("\\([^()]+\\)",ind),ind_par:=gsub("\\(|\\)","",str_extract(ind,"\\([^()]+\\)"))][,ind := str_squish(  gsub("\\([^()]+\\)","",ind))]
      X_f <- X_f[ind_par=="",ind_par:=NA][ind=="",ind:=NA]
    } else { flag_ind_par <-1 }
  }
  
  if (!missing(match_f)) {
    X_f[,match:=match_f]
  } else {
    print("No match variable provided. A match vaariable with value of 0 is created")
    X_f <- X_f[,match:=0]
  }

  # 2. Keeping only unique variables and
  # 3. Expand observations (title and industry part, with/without parentheses)
   
  X_f <- X_f[,`:=`(  sort_tit=      sapply(lapply(strsplit(tit," "),sort),function(x) paste(x,collapse=' '))
                   )]
  # In the next block we consider all the different cases
  if ( flag_ind ==1 & flag_ind_par==1 & flag_tit_par==1 ) {                     
    #1.  ######### - tit - ##########
    # Drop duplicated observations
    X_f <- X_f[,match:=max(match),by=c("sort_tit")][,.SD[1],by=c("sort_tit"),.SDcols=c("obs","match","tit","l")][,c("sort_tit"):=NULL]
    
    ex_tit <- f_split_or(X_f[,c("obs","tit")],tit,obs)
    ex_tit_f <- ex_tit[,final_t:=sapply(lapply(strsplit(tit_l," "),sort),function(x) paste(x,collapse=' '))][,.SD[1],by=c("obs","final_t")][,c("obs","final_t")]
    
  } else if (flag_ind ==1 & flag_ind_par==0 & flag_tit_par==0) {                
    #2.  ######### - tit, tit_par, ind_par - ##########
    X_f <- X_f[,`:=`(  sort_tit_par=  sapply(lapply(strsplit(tit_par," "),sort),function(x) paste(x,collapse=' ')),
                   sort_ind_par=  sapply(lapply(strsplit(ind_par," "),sort),function(x) paste(x,collapse=' '))
            )]
    
    X_f <- X_f[,match:=max(match),by=c("sort_tit","sort_tit_par","sort_ind_par")][,.SD[1],by=c("sort_tit","sort_tit_par","sort_ind_par"),.SDcols=c("obs","match","tit","tit_par","ind_par","l")][,c("sort_tit","sort_tit_par","sort_ind_par"):=NULL]
    
    # Expanding title
    # Expand title
    ex_tit <- f_split_or(X_f[,c("obs","tit")],tit,obs)
    # Expand title par 
    ex_tit_par <- f_split_or(X_f[,c("obs","tit_par")],tit_par,obs)

    ex_tit_f <- rbind(ex_tit[,c("obs","tit_l")],merge(ex_tit[,c("obs","tit_l")],ex_tit_par[,c("obs","tit_par_l")],by="obs",all=TRUE,allow.cartesian=TRUE),fill=TRUE)
    ex_tit_f <- ex_tit_f[!is.na(tit_par_l),final_t:=paste3(tit_l,tit_par_l)][is.na(tit_par_l),final_t:=tit_l][,final_t:=sapply(lapply(strsplit(final_t," "),sort),function(x) paste(x,collapse=' '))][,.SD[1],by=c("obs","final_t")][,c("obs","final_t")]
    
    # Expanding industry par
    ex_ind_par <- f_split_or(X_f[,c("obs","ind_par")],ind_par,obs)
    ex_ind_f <- ex_ind_par[,final_i:=sapply(lapply(strsplit(ind_par_l," "),sort),function(x) paste(x,collapse=' '))][,.SD[1],by=c("obs","final_i")][,c("obs","final_i")]
    
  } else if (flag_ind ==1 & flag_ind_par==1 & flag_tit_par==0) {                
    #2.  ######### - tit, tit_par - ##########
    X_f <- X_f[,`:=`(  sort_tit_par=  sapply(lapply(strsplit(tit_par," "),sort),function(x) paste(x,collapse=' '))
            )]
    
    X_f <- X_f[,match:=max(match),by=c("sort_tit","sort_tit_par")][,.SD[1],by=c("sort_tit","sort_tit_par"),.SDcols=c("obs","match","tit","tit_par","l")][,c("sort_tit","sort_tit_par"):=NULL]
    
    # Expanding title
    # Expand title
    ex_tit <- f_split_or(X_f[,c("obs","tit")],tit,obs)
    # Expand title par 
    ex_tit_par <- f_split_or(X_f[,c("obs","tit_par")],tit_par,obs)

    ex_tit_f <- rbind(ex_tit[,c("obs","tit_l")],merge(ex_tit[,c("obs","tit_l")],ex_tit_par[,c("obs","tit_par_l")],by="obs",all=TRUE,allow.cartesian=TRUE),fill=TRUE)
    ex_tit_f <- ex_tit_f[!is.na(tit_par_l),final_t:=paste3(tit_l,tit_par_l)][is.na(tit_par_l),final_t:=tit_l][,final_t:=sapply(lapply(strsplit(final_t," "),sort),function(x) paste(x,collapse=' '))][,.SD[1],by=c("obs","final_t")][,c("obs","final_t")]
    
  } else if (flag_ind ==1 & flag_ind_par==0 & flag_tit_par==1) {                
    #3.  ######### - tit, ind_par - ##########
    X_f <- X_f[,`:=`(  sort_ind_par=  sapply(lapply(strsplit(ind_par," "),sort),function(x) paste(x,collapse=' '))
            )]
    X_f <- X_f[,match:=max(match),by=c("sort_tit","sort_ind_par")][,.SD[1],by=c("sort_tit","sort_ind_par"),.SDcols=c("obs","match","tit","ind_par","l")][,c("sort_tit","sort_ind_par"):=NULL]
    
    # Title
    ex_tit <- f_split_or(X_f[,c("obs","tit")],tit,obs)
    ex_tit_f <- ex_tit[,final_t:=sapply(lapply(strsplit(tit_l," "),sort),function(x) paste(x,collapse=' '))][,.SD[1],by=c("obs","final_t")][,c("obs","final_t")]
    
    # Industry
    # Par
    ex_ind_par <- f_split_or(X_f[,c("obs","ind_par")],ind_par,obs)
    ex_ind_f <- ex_ind_par[,final_i:=sapply(lapply(strsplit(ind_par_l," "),sort),function(x) paste(x,collapse=' '))][,.SD[1],by=c("obs","final_i")][,c("obs","final_i")]
    
  } else if (flag_ind ==0 & flag_ind_par==1 & flag_tit_par==1) {                
    #5.  ######### - tit, ind - ##########
    X_f <- X_f[,`:=`(  sort_ind=  sapply(lapply(strsplit(ind," "),sort),function(x) paste(x,collapse=' '))
            )]
    
    X_f <- X_f[,match:=max(match),by=c("sort_tit","sort_ind")][,.SD[1],by=c("sort_tit","sort_ind"),.SDcols=c("obs","match","tit","ind","l")][,c("sort_tit","sort_ind"):=NULL]
    
    # Title
    ex_tit <- f_split_or(X_f[,c("obs","tit")],tit,obs)
    ex_tit_f <- ex_tit[,final_t:=sapply(lapply(strsplit(tit_l," "),sort),function(x) paste(x,collapse=' '))][,.SD[1],by=c("obs","final_t")][,c("obs","final_t")]
    
    # Industry
    ex_ind <- f_split_or(X_f[,c("obs","ind")],ind,obs)
    ex_ind_f <- ex_ind[,final_i:=sapply(lapply(strsplit(ind_l," "),sort),function(x) paste(x,collapse=' '))][,.SD[1],by=c("obs","final_i")][,c("obs","final_i")]
    
  } else if (flag_ind ==0 & flag_ind_par==0 & flag_tit_par==1) {                
    #6.  ######### - tit, ind, ind_par - ##########
    X_f <- X_f[,`:=`(  sort_ind=  sapply(lapply(strsplit(ind," "),sort),function(x) paste(x,collapse=' ')),
                   sort_ind_par=  sapply(lapply(strsplit(ind_par," "),sort),function(x) paste(x,collapse=' '))
            )]
    
    X_f <- X_f[,match:=max(match),by=c("sort_tit","sort_ind","sort_ind_par")][,.SD[1],by=c("sort_tit","sort_ind","sort_ind_par"),.SDcols=c("obs","match","tit","ind","ind_par","l")][,c("sort_tit","sort_ind","sort_ind_par"):=NULL]
    
    # Title
    ex_tit <- f_split_or(X_f[,c("obs","tit")],tit,obs)
    ex_tit_f <- ex_tit[,final_t:=sapply(lapply(strsplit(tit_l," "),sort),function(x) paste(x,collapse=' '))][,.SD[1],by=c("obs","final_t")][,c("obs","final_t")]
    
    # Industry
    ex_ind <- f_split_or(X_f[,c("obs","ind")],ind,obs)
    #Expand title par 
    ex_ind_par <- f_split_or(X_f[,c("obs","ind_par")],ind_par,obs)
    
    ex_ind_f <- rbind(ex_ind[,c("obs","ind_l")],merge(ex_ind[,c("obs","ind_l")],ex_ind_par[,c("obs","ind_par_l")],by="obs",all=TRUE,allow.cartesian=TRUE),fill=TRUE)
    ex_ind_f <- ex_ind_f[!is.na(ind_par_l),final_i:=paste3(ind_l,ind_par_l)][is.na(ind_par_l),final_i:=ind_l][,final_i:=sapply(lapply(strsplit(final_i," "),sort),function(x) paste(x,collapse=' '))][,.SD[1],by=c("obs","final_i")][,c("obs","final_i")]
  
  } else if (flag_ind ==0 & flag_ind_par==1 & flag_tit_par==0) {                
    #7.  ######### - tit, tit_par, ind - ##########
    X_f <- X_f[,`:=`(  sort_tit_par=  sapply(lapply(strsplit(tit_par," "),sort),function(x) paste(x,collapse=' ')),
                   sort_ind=  sapply(lapply(strsplit(ind," "),sort),function(x) paste(x,collapse=' '))
            )]
    
    X_f <- X_f[,match:=max(match),by=c("sort_tit","sort_tit_par","sort_ind")][,.SD[1],by=c("sort_tit","sort_tit_par","sort_ind"),.SDcols=c("obs","match","tit","tit_par","ind","l")][,c("sort_tit","sort_tit_par","sort_ind"):=NULL]
    
    # Expanding title
    # Expand title
    ex_tit <- f_split_or(X_f[,c("obs","tit")],tit,obs)
    # Expand title par 
    ex_tit_par <- f_split_or(X_f[,c("obs","tit_par")],tit_par,obs)

    ex_tit_f <- rbind(ex_tit[,c("obs","tit_l")],merge(ex_tit[,c("obs","tit_l")],ex_tit_par[,c("obs","tit_par_l")],by="obs",all=TRUE,allow.cartesian=TRUE),fill=TRUE)
    ex_tit_f <- ex_tit_f[!is.na(tit_par_l),final_t:=paste3(tit_l,tit_par_l)][is.na(tit_par_l),final_t:=tit_l][,final_t:=sapply(lapply(strsplit(final_t," "),sort),function(x) paste(x,collapse=' '))][,.SD[1],by=c("obs","final_t")][,c("obs","final_t")]
    
    # Expanding industry par
    ex_ind <- f_split_or(X_f[,c("obs","ind")],ind,obs)
    ex_ind_f <- ex_ind[,final_i:=sapply(lapply(strsplit(ind_l," "),sort),function(x) paste(x,collapse=' '))][,.SD[1],by=c("obs","final_i")][,c("obs","final_i")]
    
  }  else if (flag_ind ==0 & flag_ind_par==0 & flag_tit_par==0) {
    # Reorder title + par and ind + par
    X_f <- X_f[,`:=`(  sort_tit_par=  sapply(lapply(strsplit(tit_par," "),sort),function(x) paste(x,collapse=' ')),
                   sort_ind=      sapply(lapply(strsplit(ind," "),sort),function(x) paste(x,collapse=' ')),
                   sort_ind_par=  sapply(lapply(strsplit(ind_par," "),sort),function(x) paste(x,collapse=' '))
            )]
    # Drop duplicated observations
    X_f <- X_f[,match:=max(match),by=c("sort_tit","sort_tit_par","sort_ind","sort_ind_par")][,.SD[1],by=c("sort_tit","sort_tit_par","sort_ind","sort_ind_par"),.SDcols=c("obs","match","tit","tit_par","ind","ind_par","l")][,c("sort_tit","sort_tit_par","sort_ind","sort_ind_par"):=NULL]
    
    # Expanding title
    # Expand title
    ex_tit <- f_split_or(X_f[,c("obs","tit")],tit,obs)
    # Expand title par 
    ex_tit_par <- f_split_or(X_f[,c("obs","tit_par")],tit_par,obs)

    ex_tit_f <- rbind(ex_tit[,c("obs","tit_l")],merge(ex_tit[,c("obs","tit_l")],ex_tit_par[,c("obs","tit_par_l")],by="obs",all=TRUE,allow.cartesian=TRUE),fill=TRUE)
    ex_tit_f <- ex_tit_f[!is.na(tit_par_l),final_t:=paste3(tit_l,tit_par_l)][is.na(tit_par_l),final_t:=tit_l][,final_t:=sapply(lapply(strsplit(final_t," "),sort),function(x) paste(x,collapse=' '))][,.SD[1],by=c("obs","final_t")][,c("obs","final_t")]
    
    # Industry
    ex_ind <- f_split_or(X_f[,c("obs","ind")],ind,obs)
    #Expand title par 
    ex_ind_par <- f_split_or(X_f[,c("obs","ind_par")],ind_par,obs)
    #NOte: Make sure to consider the case where the tit_par vector is all NAs
    ex_ind_f <- rbind(ex_ind[,c("obs","ind_l")],merge(ex_ind[,c("obs","ind_l")],ex_ind_par[,c("obs","ind_par_l")],by="obs",all=TRUE,allow.cartesian=TRUE),fill=TRUE)
    ex_ind_f <- ex_ind_f[!is.na(ind_par_l),final_i:=paste3(ind_l,ind_par_l)][is.na(ind_par_l),final_i:=ind_l][,final_i:=sapply(lapply(strsplit(final_i," "),sort),function(x) paste(x,collapse=' '))][,.SD[1],by=c("obs","final_i")][,c("obs","final_i")]
  
  }
  
  # 4. Construct the match variable
  
  # A. Using both industry and title
  if (flag_ind==1 & flag_ind_par==1) {
    # Update
    # Merging
    ex <- merge(ex_tit_f,X_f[,c("obs","match","l")],by="obs",all.x=TRUE,all.y=FALSE,allow.cartesian=TRUE)
    # Assigning and updating match variable
    ex <- ex[,match := max(match),by=c("final_t")]
    ex_inv <- copy(ex)[,final:=final_t][,!c("final_t")]
    ex_f <- ex[,.(match=max(match)),by=c("obs","l")]
    
  } else if (flag_ind==0) {
    # Update
    # Merging
    ex <- merge(ex_tit_f,ex_ind_f,by="obs",all=TRUE,allow.cartesian=TRUE)
    # Assigning and updating match variable
    ex <- merge(ex,X_f[,c("obs","match","l")],by="obs",all.x=TRUE,all.y=FALSE,allow.cartesian = TRUE)
    ex <- ex[,match := max(match),by=c("final_t","final_i")]
    ex_inv <- copy(ex)[!is.na(final_i),final:=paste3(final_t,final_i)][is.na(final_i),final:=final_t][,final:=sapply(lapply(strsplit(final," "),sort),function(x) paste(x,collapse=' '))][,match := max(match),by=c("final")][,c("obs","l","match","final")]
    ex_f <- ex[,.(match=max(match)),by=c("obs","l")]
    
  } else if (flag_ind==1 & flag_ind_par==0) {
    # Merging
    ex <- rbind(ex_tit_f,
                merge(ex_tit_f,ex_ind_f,by="obs",all=TRUE,allow.cartesian=TRUE), fill=TRUE
                )

    # Assigning and updating match variable
    ex <- merge(ex,X_f[,c("obs","match","l")],by="obs",all.x=TRUE,all.y=FALSE,allow.cartesian = TRUE)
    ex <- ex[,match := max(match),by=c("final_t","final_i")]
    ex_inv <- copy(ex)[!is.na(final_i),final:=paste3(final_t,final_i)][is.na(final_i),final:=final_t][,final:=sapply(lapply(strsplit(final," "),sort),function(x) paste(x,collapse=' '))][,match := max(match),by=c("final")][,c("obs","l","match","final")]
    ex_f <- ex[,.(match=max(match)),by=c("obs","l")]
  }
  
  # B. Using only title
  ex_1 <- merge(ex_tit_f,X_f[,c("obs","match")],by="obs",all.x=TRUE,all.y=FALSE,allow.cartesian=TRUE)
  ex_1 <- ex_1[,match := max(match),by=c("final_t")][,.(match=max(match)),by=c("obs")]
  
  # C. Using title and industry but looking also at inverted possibilities
  ex_2 <- ex_inv[,.(match=max(match)),by=c("obs")]

  
  # 5. Construct the reduced set of cases
  # A. Convoluted way combining different cases
 
  if ( flag_ind ==1 & flag_ind_par==1 & flag_tit_par==1 ) {
    ex_tit <- ex_tit[,final_t:=sapply(lapply(strsplit(tit_l," "),sort),function(x) paste(x,collapse=' '))]
    r <- merge(ex_tit,X_f[,c("obs","l")],by="obs",all.x=TRUE,all.y=FALSE,allow.cartesian=TRUE)
    setorderv(r,c("final_t","l"),c(1,-1) )
    r <- r[,.SD[1],by=c("final_t"),.SDcols="obs"][,.SD[1],by=c("obs")][,c("obs")]
    
  } else if (flag_ind ==1 & flag_ind_par==0 & flag_tit_par==0) {
    # Shrinking ex_* variables
    ex_tit <- ex_tit[,final_t:=sapply(lapply(strsplit(tit_l," "),sort),function(x) paste(x,collapse=' '))][,.SD[1],by=c("obs","final_t"),.SDcols="tit_l"][,c("obs","final_t")]
    ex_tit_par <- merge(ex_tit,ex_tit_par[,!c("tit_par")],by="obs",all=TRUE,allow.cartesian=TRUE)[!is.na(tit_par_l),final_t:=paste3(final_t,tit_par_l)][,final_t:=sapply(lapply(strsplit(final_t," "),sort),function(x) paste(x,collapse=' '))][,.SD[1],by=c("obs","final_t"),.SDcols="tit_par_l"][,c("obs","final_t")] 
    
    ex_ind_par <- ex_ind_par[,final_i:=sapply(lapply(strsplit(ind_par_l," "),sort),function(x) paste(x,collapse=' '))][,.SD[1],by=c("obs","final_i"),.SDcols="ind_par_l"][,c("obs","final_i")]
    
    r_1 <- merge( 
              merge(ex_tit_par[,c("obs","final_t")],
                    ex_ind_par[,c("obs","final_i")],
                    by="obs",all=TRUE,allow.cartesian=TRUE),
                  X_f[,c("obs","l")],by="obs",all.x=TRUE,all.y=FALSE,allow.cartesian=TRUE)[,t:=1]
    r_2 <- merge(ex_tit_par[,c("obs","final_t")],
                 X_f[,c("obs","l")],by="obs",all.x=TRUE,all.y=FALSE,allow.cartesian=TRUE)[,t:=2]
    r_3 <- merge( merge(ex_tit[,c("obs","final_t")],
                        ex_ind_par[,c("obs","final_i")],
                        by="obs",all=TRUE,allow.cartesian=TRUE),
                  X_f[,c("obs","l")],by="obs",all.x=TRUE,all.y=FALSE,allow.cartesian=TRUE)[,t:=3]
    r_4 <- merge(ex_tit[,c("obs","final_t")],
                  X_f[,c("obs","l")],by="obs",all.x=TRUE,all.y=FALSE,allow.cartesian=TRUE)[,t:=4]
    
    r <- rbind(r_1,r_2,r_3,r_4,fill=TRUE)
    setorderv(r,c("t","final_t","final_i","l"),c(1,1,1,-1) )
    # 1. Keep only one observation (longest one - reason for setorderv ..(-1)) for each c("t","final_t","final_i") combination
    # 2. Keep only 1 observation per c("obs","t") (one observation might be associated with multiple "final_t","final_i")
    # 3. Add up number of times an "obs" appear (using n). Max number of appearances is equal to max number of t
    r <- r[,.SD[1],by=c("t","final_t","final_i"),.SDcols=c("obs")][,n:=1][,.SD[1],by=c("obs","t"),.SDcols="n"][,.(n=sum(n)),by="obs"]
    rm(r_1,r_2,r_3,r_4)
    r <- r[n==4][,c("obs")]
    
  } else if (flag_ind ==1 & flag_ind_par==1 & flag_tit_par==0) { 
    # Shrinking ex_* variables
    ex_tit <- ex_tit[,final_t:=sapply(lapply(strsplit(tit_l," "),sort),function(x) paste(x,collapse=' '))][,.SD[1],by=c("obs","final_t"),.SDcols="tit_l"][,c("obs","final_t")]
    ex_tit_par <- merge(ex_tit,ex_tit_par[,!c("tit_par")],by="obs",all=TRUE,allow.cartesian=TRUE)[!is.na(tit_par_l),final_t:=paste3(final_t,tit_par_l)][,final_t:=sapply(lapply(strsplit(final_t," "),sort),function(x) paste(x,collapse=' '))][,.SD[1],by=c("obs","final_t"),.SDcols="tit_par_l"][,c("obs","final_t")] 
    
    r <- rbind(
              merge(ex_tit,X_f[,c("obs","l")],by="obs",all.x=TRUE,all.y=FALSE,allow.cartesian=TRUE)[,t:=1],
              merge(ex_tit_par,X_f[,c("obs","l")],by="obs",all.x=TRUE,all.y=FALSE,allow.cartesian=TRUE)[,t:=2], fill=TRUE)
    setorderv(r,c("t","final_t","l"),c(1,1,-1) )
    r <- r[,.SD[1],by=c("t","final_t"),.SDcols=c("obs")][,n:=1][,.SD[1],by=c("obs","t"),.SDcols="n"][,.(n=sum(n)),by="obs"]
    r <- r[n==2][,c("obs")]
  
  } else if (flag_ind ==1 & flag_ind_par==0 & flag_tit_par==1) {
    # Shrinking ex_* variables
    ex_tit <- ex_tit[,final_t:=sapply(lapply(strsplit(tit_l," "),sort),function(x) paste(x,collapse=' '))][,.SD[1],by=c("obs","final_t"),.SDcols="tit_l"][,c("obs","final_t")]
    
    ex_ind_par <- ex_ind_par[,final_i:=sapply(lapply(strsplit(ind_par_l," "),sort),function(x) paste(x,collapse=' '))][,.SD[1],by=c("obs","final_i"),.SDcols="ind_par_l"][,c("obs","final_i")]
    
    
    r_1 <- merge( 
              merge(ex_tit[,c("obs","final_t")],
                    ex_ind_par[,c("obs","final_i")],
                    by="obs",all=TRUE,allow.cartesian=TRUE),
                  X_f[,c("obs","l")],by="obs",all.x=TRUE,all.y=FALSE,allow.cartesian=TRUE)[,t:=1]
    r_2 <- merge(ex_tit[,c("obs","final_t")],
                 X_f[,c("obs","l")],by="obs",all.x=TRUE,all.y=FALSE,allow.cartesian=TRUE)[,t:=2]
    
    r <- rbind(r_1,r_2,fill=TRUE)
    setorderv(r,c("t","final_t","final_i","l"),c(1,1,1,-1) )
    r <- r[,.SD[1],by=c("t","final_t","final_i"),.SDcols=c("obs")][,n:=1][,.SD[1],by=c("obs","t"),.SDcols="n"][,.(n=sum(n)),by="obs"]
    rm(r_1,r_2)
    r <- r[n==2][,c("obs")]
    
  } else if (flag_ind ==0 & flag_ind_par==1 & flag_tit_par==1) {
    # Shrinking ex_* variables
    ex_tit <- ex_tit[,final_t:=sapply(lapply(strsplit(tit_l," "),sort),function(x) paste(x,collapse=' '))][,.SD[1],by=c("obs","final_t"),.SDcols="tit_l"][,c("obs","final_t")]
    
    ex_ind <- ex_ind[,final_i:=sapply(lapply(strsplit(ind_l," "),sort),function(x) paste(x,collapse=' '))][,.SD[1],by=c("obs","final_i"),.SDcols="ind_l"][,c("obs","final_i")]
    
    r <- merge(merge(ex_tit,ex_ind,by="obs",all=TRUE,allow.cartesian=TRUE),
               X_f[,c("obs","l")],by="obs",all.x=TRUE,all.y=FALSE,allow.cartesian=TRUE)
    
    setorderv(r, c("final_t","final_i","l") , c(1,1,-1) )
    r <- r[,.SD[1],by=c("final_t","final_i"),.SDcols=c("obs")][,.SD[1],by=c("obs")][,c("obs")]
    
  } else if (flag_ind ==0 & flag_ind_par==0 & flag_tit_par==1) {
    # Shrinking ex_* variables
    ex_tit <- ex_tit[,final_t:=sapply(lapply(strsplit(tit_l," "),sort),function(x) paste(x,collapse=' '))][,.SD[1],by=c("obs","final_t"),.SDcols="tit_l"][,c("obs","final_t")]
    
    ex_ind <- ex_ind[,final_i:=sapply(lapply(strsplit(ind_l," "),sort),function(x) paste(x,collapse=' '))][,.SD[1],by=c("obs","final_i"),.SDcols="ind_l"][,c("obs","final_i")]
    ex_ind_par <- merge(ex_ind,ex_ind_par[,!c("ind_par")],by="obs",all=TRUE,allow.cartesian=TRUE)[!is.na(ind_par_l),final_i:=paste3(final_i,ind_par_l)][,final_i:=sapply(lapply(strsplit(final_i," "),sort),function(x) paste(x,collapse=' '))][,.SD[1],by=c("obs","final_i"),.SDcols="ind_par_l"][,c("obs","final_i")] 
    
    r_1 <- merge( 
              merge(ex_tit[,c("obs","final_t")],
                    ex_ind_par[,c("obs","final_i")],
                    by="obs",all=TRUE,allow.cartesian=TRUE),
                  X_f[,c("obs","l")],by="obs",all.x=TRUE,all.y=FALSE,allow.cartesian=TRUE)[,t:=1]
    r_2 <- merge( 
              merge(ex_tit[,c("obs","final_t")],
                    ex_ind[,c("obs","final_i")],
                    by="obs",all=TRUE,allow.cartesian=TRUE),
                  X_f[,c("obs","l")],by="obs",all.x=TRUE,all.y=FALSE,allow.cartesian=TRUE)[,t:=2]
    
    r <- rbind(r_1,r_2,fill=TRUE)
    setorderv(r,c("t","final_t","final_i","l"),c(1,1,1,-1) )
    r <- r[,.SD[1],by=c("t","final_t","final_i"),.SDcols=c("obs")][,n:=1][,.SD[1],by=c("obs","t"),.SDcols="n"][,.(n=sum(n)),by="obs"]
    rm(r_1,r_2)
    r <- r[n==2][,c("obs")]
    
  } else if (flag_ind ==0 & flag_ind_par==1 & flag_tit_par==0) {
    # Shrinking ex_* variables
    ex_tit <- ex_tit[,final_t:=sapply(lapply(strsplit(tit_l," "),sort),function(x) paste(x,collapse=' '))][,.SD[1],by=c("obs","final_t"),.SDcols="tit_l"][,c("obs","final_t")]
    ex_tit_par <- merge(ex_tit,ex_tit_par[,!c("tit_par")],by="obs",all=TRUE,allow.cartesian=TRUE)[!is.na(tit_par_l),final_t:=paste3(final_t,tit_par_l)][,final_t:=sapply(lapply(strsplit(final_t," "),sort),function(x) paste(x,collapse=' '))][,.SD[1],by=c("obs","final_t"),.SDcols="tit_par_l"][,c("obs","final_t")] 
    
    ex_ind <- ex_ind[,final_i:=sapply(lapply(strsplit(ind_l," "),sort),function(x) paste(x,collapse=' '))][,.SD[1],by=c("obs","final_i"),.SDcols="ind_l"][,c("obs","final_i")]
    
    r_1 <- merge( 
              merge(ex_tit_par[,c("obs","final_t")],
                    ex_ind[,c("obs","final_i")],
                    by="obs",all=TRUE,allow.cartesian=TRUE),
                  X_f[,c("obs","l")],by="obs",all.x=TRUE,all.y=FALSE,allow.cartesian=TRUE)[,t:=1]
    r_2 <- merge( merge(ex_tit[,c("obs","final_t")],
                        ex_ind[,c("obs","final_i")],
                        by="obs",all=TRUE,allow.cartesian=TRUE),
                  X_f[,c("obs","l")],by="obs",all.x=TRUE,all.y=FALSE,allow.cartesian=TRUE)[,t:=2]
    
    r <- rbind(r_1,r_2,fill=TRUE)
    setorderv(r,c("t","final_t","final_i","l"),c(1,1,1,-1) )
    r <- r[,.SD[1],by=c("t","final_t","final_i"),.SDcols=c("obs")][,n:=1][,.SD[1],by=c("obs","t"),.SDcols="n"][,.(n=sum(n)),by="obs"]
    rm(r_1,r_2)
    r <- r[n==2][,c("obs")]
    
  } else if (flag_ind ==0 & flag_ind_par==0 & flag_tit_par==0) {
    # Shrinking ex_* variables
    ex_tit <- ex_tit[,final_t:=sapply(lapply(strsplit(tit_l," "),sort),function(x) paste(x,collapse=' '))][,.SD[1],by=c("obs","final_t"),.SDcols="tit_l"][,c("obs","final_t")]
    ex_tit_par <- merge(ex_tit,ex_tit_par[,!c("tit_par")],by="obs",all=TRUE,allow.cartesian=TRUE)[!is.na(tit_par_l),final_t:=paste3(final_t,tit_par_l)][,final_t:=sapply(lapply(strsplit(final_t," "),sort),function(x) paste(x,collapse=' '))][,.SD[1],by=c("obs","final_t"),.SDcols="tit_par_l"][,c("obs","final_t")] 
    
    ex_ind <- ex_ind[,final_i:=sapply(lapply(strsplit(ind_l," "),sort),function(x) paste(x,collapse=' '))][,.SD[1],by=c("obs","final_i"),.SDcols="ind_l"][,c("obs","final_i")]
    ex_ind_par <- merge(ex_ind,ex_ind_par[,!c("ind_par")],by="obs",all=TRUE,allow.cartesian=TRUE)[!is.na(ind_par_l),final_i:=paste3(final_i,ind_par_l)][,final_i:=sapply(lapply(strsplit(final_i," "),sort),function(x) paste(x,collapse=' '))][,.SD[1],by=c("obs","final_i"),.SDcols="ind_par_l"][,c("obs","final_i")] 
    
    # Constructing the different cases
    # Construct 4 cases, reduce the list if tit_ind, tit_list is the same by keeping the longest string, and assign a number to each obs, based on how many time they appear
    r_1 <- merge( 
              merge(ex_tit_par[,c("obs","final_t")],
                    ex_ind_par[,c("obs","final_i")],
                    by="obs",all=TRUE,allow.cartesian=TRUE),
                  X_f[,c("obs","l")],by="obs",all.x=TRUE,all.y=FALSE,allow.cartesian=TRUE)[,t:=1]
    r_2 <- merge( merge(ex_tit_par[,c("obs","final_t")],
                        ex_ind[,c("obs","final_i")],
                        by="obs",all=TRUE,allow.cartesian=TRUE),
                  X_f[,c("obs","l")],by="obs",all.x=TRUE,all.y=FALSE,allow.cartesian=TRUE)[,t:=2]
    
    r_3 <- merge( merge(ex_tit[,c("obs","final_t")],
                        ex_ind_par[,c("obs","final_i")],
                        by="obs",all=TRUE,allow.cartesian=TRUE),
                  X_f[,c("obs","l")],by="obs",all.x=TRUE,all.y=FALSE,allow.cartesian=TRUE)[,t:=3]
    
    r_4 <- merge( merge(ex_tit[,c("obs","final_t")],
                        ex_ind[,c("obs","final_i")],
                        by="obs",all=TRUE,allow.cartesian=TRUE),
                  X_f[,c("obs","l")],by="obs",all.x=TRUE,all.y=FALSE,allow.cartesian=TRUE)[,t:=4]
    
    r <- rbind(r_1,r_2,r_3,r_4)
    setorderv(r,c("t","final_t","final_i","l"),c(1,1,1,-1) )
    r <- r[,.SD[1],by=c("t","final_t","final_i"),.SDcols=c("obs")][,n:=1][,.SD[1],by=c("obs","t"),.SDcols="n"][,.(n=sum(n)),by="obs"]
    rm(r_1,r_2,r_3,r_4)
    r <- r[n==4][,c("obs")]
  }
  
  # B. Simpler case
  if (flag_ind==1 & flag_ind_par==1) {
    # Compute the share of different combinations of an observation title-industry combination that
    # cannot be eliminated after matching with other variables
    r_all <- ex[,.SD[1],by=c("obs","final_t"),.SDcols="l"][,criteria:=.N,by="obs"]
    setorderv(r_all,c("final_t","l"),c(1,-1))
    r_all <- r_all[,.SD[1],by=c("final_t"),.SDcols=c("l","obs","criteria")]
    r_all <- r_all[,{c=.N; list(criteria=c/criteria)},by="obs"]
    
  } else  {
    # Compute the share of different combinations of an observation title-industry combination that
    # cannot be eliminated after matching with other variables
    r_all <- ex[,.SD[1],by=c("obs","final_t","final_i"),.SDcols="l"][,criteria:=.N,by="obs"]
    setorderv(r_all,c("final_t","final_i","l"),c(1,1,-1))
    r_all <- r_all[,.SD[1],by=c("final_t","final_i"),.SDcols=c("l","obs","criteria")]
    r_all <- r_all[,{c=.N; list(criteria=c/criteria)},by="obs"]
    
  } 
  # Only keep those observations that keep at least 3/4 of their expanded title-industry combination
  r_all <- r_all[criteria>0.75][,.SD[1],by="obs",.SDcols="criteria"][,c("obs")]  # 0.75 is an ARBITRARY VALUE!!
  
  # C. Simpler case considering inverted industry and title
  r_all_inv <- ex_inv[,.SD[1],by=c("obs","final"),.SDcols="l"][,criteria:=.N,by="obs"]
  setorderv(r_all_inv,c("final","l"),c(1,-1))
  r_all_inv <- r_all_inv[,.SD[1],by=c("final"),.SDcols=c("l","obs","criteria")]
  r_all_inv <- r_all_inv[,{c=.N; list(criteria=c/criteria)},by="obs"]
  r_all_inv <- r_all_inv[criteria>0.75][,.SD[1],by="obs",.SDcols="criteria"][,c("obs")]  # 0.75 is an ARBITRARY VALUE!!
    
  
  # 7. Check that all observations can be generated with the reduced set
  # Combine with vector with all possible combinations
  # A. Convoluted case
  if (flag_ind==1 & flag_ind_par==1) {
    # 1. No industry info ---> no variable final_i
    # Obtain all possible combinations of observations in the r vector
    # Note: replace r_exp with r in final code
    r_exp <- merge(r,ex[,c("obs","final_t")],by="obs",all.x=TRUE,all.y=FALSE,allow.cartesian=TRUE)
      
    # Merge this expanded r vector with all possible combinations of all observations
    # NOTE: change r_t for r in final code
    # 1. Merge r_exp with all possible combinations of observations using final_t
    # 2. Find out obs that couldn't be linked with the observations in vector r
    # 3. Keep only observations that couldn't be linked (those for which max(n)=0)
    r_exp <- merge(r_exp,ex[,c("obs","final_t")],by=c("final_t"),all=TRUE,allow.cartesian=TRUE)[,n:=1][is.na("obs.x"),n:=0][,n:=max(n),by=c("obs.y")][n==0][,obs:=obs.y]  
      
    # Create final vector of unique titles my addin r to the previous vector
    if (nrow(r_exp)!=0) { unique <- rbind(  r, r_exp[,c("obs")],fill=TRUE)
    } else            { unique <- copy(r)
    }
  } else {
    # Obtain all possible combinations of observations in the r vector
    # Note: replace r_exp with r in final code
    r_exp <- merge(r,ex[,c("obs","final_t","final_i")],by="obs",all.x=TRUE,all.y=FALSE,allow.cartesian=TRUE)
      
    r_exp <- merge(r_exp,ex[,c("obs","final_t","final_i")],by=c("final_t","final_i"),all=TRUE,allow.cartesian=TRUE)[,n:=1][is.na("obs.x"),n:=0][,n:=max(n),by="obs.y"][n==0][,obs:=obs.y]  
      
    # Create final vector of unique titles my addin r to the previous vector
    if (nrow(r_exp)!=0) { unique <- rbind(r,r_exp[,c("obs")],fill=TRUE)
    } else            { unique <- copy(r)  
    }
  }
  
  # B. Simpler case
  rm(r_exp)
  if (flag_ind==1 & flag_ind_par==1) {
    
    r_exp <- merge(r_all,ex[,c("obs","final_t")],by="obs",all.x=TRUE,all.y=FALSE,allow.cartesian=TRUE)

    r_exp <- merge(r_exp,ex[,c("obs","final_t")],by=c("final_t"),all=TRUE,allow.cartesian=TRUE)[,n:=1][is.na("obs.x"),n:=0][,n:=max(n),by=c("obs.y")][n==0][,obs:=obs.y]  
      
    # Create final vector of unique titles my adding r_all to the previous vector
    if (nrow(r_exp)!=0) { unique_all <- rbind(  r_all, r_exp[,c("obs")],fill=TRUE)
    } else            { unique_all <- copy(r_all)
    }
  } else {
    # Obtain all possible combinations of observations in the r vector
    r_exp <- merge(r_all,ex[,c("obs","final_t","final_i")],by="obs",all.x=TRUE,all.y=FALSE,allow.cartesian=TRUE)
      
    r_exp <- merge(r_exp,ex[,c("obs","final_t","final_i")],by=c("final_t","final_i"),all=TRUE,allow.cartesian=TRUE)[,n:=1][is.na("obs.x"),n:=0][,n:=max(n),by="obs.y"][n==0][,obs:=obs.y]  
      
    # Create final vector of unique titles my addin r to the previous vector
    if (nrow(r_exp)!=0) { unique_all <- rbind(r_all,r_exp[,c("obs")],fill=TRUE)
    } else            { unique_all <- copy(r_all)  
    }
  }
  
  # C. Simpler case + title, industry
  rm(r_exp)
  if (flag_ind==1 & flag_ind_par==1) {
    unique_all_inv <- copy(unique_all)
    
  } else {
    r_exp <- merge(r_all_inv,ex_inv[,c("obs","final")],by="obs",all.x=TRUE,all.y=FALSE,allow.cartesian=TRUE)
    r_exp <- merge(r_exp,ex_inv[,c("obs","final")],by=c("final"),all=TRUE,allow.cartesian=TRUE)[,n:=1][is.na("obs.x"),n:=0][,n:=max(n),by="obs.y"][n==0][,obs:=obs.y]  
      
    # Create final vector of unique titles my addin r to the previous vector
    if (nrow(r_exp)!=0) { unique_all_inv <- rbind(r_all_inv,r_exp[,c("obs")],fill=TRUE)
    } else            { unique_all_inv <- copy(r_all_inv)  
    }
  }
  
  
  # Constructing the final set of variables
  f_initial_obs <-function(x,flag_match) {
    #Note: y_f was created before in the code for this function
    if (flag_match=="red") {
      x <- merge(x[,reduced:=1],y_f[,c("obs","initial_obs")],by="obs",all=TRUE,allow.cartesian=TRUE)[is.na(reduced),reduced:=0][,c("initial_obs","reduced")]
      setorderv(x,c("initial_obs"),c(1))
    } else {
      x <- merge(x,y_f[,c("obs","initial_obs")],by="obs",all=TRUE,allow.cartesian=TRUE)[is.na(match),match:=1][,c("initial_obs","match")]
    setorderv(x,c("initial_obs"),c(1))
    }
    return(x)
  }
  
  # NOTE: we could probably use a list and lapply/sapply
  unique <- f_initial_obs(unique,"red")
  unique_all <- f_initial_obs(unique_all,"red")
  unique_all_inv <- f_initial_obs(unique_all_inv,"red")
  
  matched <- f_initial_obs(ex_1,"match")
  matched_all <- f_initial_obs(ex_f,"match")
  matched_all_inv <- f_initial_obs(ex_2,"match")
  
  # ex contains the list of observations with the updated match variable. It should be the same size as the y variable after dropping out duplicated observations
  # Note: If the variable was not created withing the function, R will look in the workspace
  if (flag_return==0) {
    return( list( unique[[2]],unique_all[[2]],unique_all_inv[[2]],matched[[2]],matched_all[[2]],matched_all_inv[[2]] ) )
  } else if (flag_return==1){
    return( list( unique[[2]],matched[[2]] ) )
  } else if (flag_return==2){
    return( list( unique_all[[2]],matched_all[[2]] ) )
  } else if (flag_return==3){
    return( list( unique_all_inv[[2]],matched_all_inv[[2]] ) )
  } else if (flag_return==4) {
    if (flag_ind==1 & flag_ind_par==1){ 
      return(list(matched,matched_all,matched_all_inv,unique,unique_all,unique_all_inv,X_f,r,r_all,r_all_inv,ex,ex_inv,ex_1,ex_2,ex_tit_f,flag=c(flag_tit_par,flag_ind,flag_ind_par)))
    } else {return(list(matched,matched_all,matched_all_inv,unique,unique_all,unique_all_inv,X_f,r,r_all,r_all_inv,ex,ex_inv,ex_1,ex_2,ex_tit_f,ex_ind_f,flag=c(flag_tit_par,flag_ind,flag_ind_par)))}
  }
}

```
Description of the different variables created:
- unique (METHOD 1):             To define the set of repeated observation we construct different sets by combining the different possible cases that arise when a title or an industry comes with a parentheses term. For each set we keep only unique title-industry combination. We combine all the sets (a max of 4) and keep only those observations that appear in all the sets.          
- unique_all (METHOD 2):         We extend the set of observations (e.g. separating "or" cases, including and excluding parentheses) and compute the share of cases per observation that could not be dropped when looking at all the other observations in the occind group. We only keep those observations that keep 3/4 of their cases
- unique_all_inv:               Same as unique_all, but considering title and industry together (contains the unique_all_inv cases)

- matched:            Using only title
- matched_all:        Using industry and title (separately) and dropped duplicated observations
- matched_all_inv:    Using industry and title jointly and dropping duplicated observations (contains the matched_all cases)


##### Create variables to reduce observations and expand the set of matched observations
Here we use the f_reduce_match function, which creates 6 binary vectors to be described below. 
**** TO-DO Reorganize variables created
```{r}
# 1. Creating the matched variable
index_1940.by_subindustry_dataset1 <- index_1940.by_subindustry_dataset1[,matched:=ifelse(new==1,0,1)][!is.na(title_1940_plain_with_replacements_stemmed)]
# NOTE!!! To-DO: some observations without title. These are the ones with titles like girl, lady's maid... For now I dropped them


# 2. Adding the binary vectors to reduce observations and extend the matching vector
# We look at the whole dataset
clean_1940.by_subindustry_dataset1.all <- copy(index_1940.by_subindustry_dataset1)[,dup:=0+duplicated(id_1940)][dup==0]

## Use f_reduce_match to flag repeated observations and expand the matched variable
clean_1940.by_subindustry_dataset1.all <- clean_1940.by_subindustry_dataset1.all[,c("red","red1","red1_inv","match_tit","match_titind","match_titind_inv"):=mapply(FUN=f_reduce_match,obs_f=list(id_1940),tit_f=list(title_1940_plain_with_replacements_stemmed),tit_par_f=list(parentheses1_1940_plain_with_replacements_stemmed),ind_f=list(indname_1940_plain_with_replacements_stemmed),ind_par_f=list(ind_parentheses1_1940_plain_with_replacements_stemmed),match_f=list(matched))]
## Use the inverted case to further falg observations that need to be flagged
## We drop observations that are discarded using both methods
clean_1940.by_subindustry_dataset1.all <- clean_1940.by_subindustry_dataset1.all[,`:=`(match_tit_inv=pmax(match_tit,match_titind_inv))][,`:=`(red_inv=pmin(red,red1_inv))][,c("id_1940","occ1940","name_ind1940_subgroup","red","red_inv","red1","red1_inv","matched","match_tit","match_tit_inv","match_titind","match_titind_inv")][!( red==0 & red_inv==0 & red1==0 & red1_inv==0 )]

# We look within occ-name_ind1940_subgroup category 
clean_1940.by_subindustry_dataset1.by_occ_subind <- copy(index_1940.by_subindustry_dataset1)[,c("red","red1","red1_inv","match_tit","match_titind","match_titind_inv"):=mapply(FUN=f_reduce_match,obs_f=list(id_1940),tit_f=list(title_1940_plain_with_replacements_stemmed),tit_par_f=list(parentheses1_1940_plain_with_replacements_stemmed),ind_f=list(indname_1940_plain_with_replacements_stemmed),ind_par_f=list(ind_parentheses1_1940_plain_with_replacements_stemmed),match_f=list(matched)),by=c("occ1940","name_ind1940_subgroup")][,`:=`(match_tit_inv=pmax(match_tit,match_titind_inv))][,`:=`(red_inv=pmin(red,red1_inv))][,c("id_1940","occ1940","name_ind1940_subgroup","red","red_inv","red1","red1_inv","matched","match_tit","match_tit_inv","match_titind","match_titind_inv")][!( red==0 & red_inv==0 & red1==0 & red1_inv==0 )]

# 3. Data table to manually inspect
clean_1940.by_subindustry_dataset1.by_occ_subind <- 
  merge(clean_1940.by_subindustry_dataset1.by_occ_subind,
        merge(
          title_edits.1940[,c("id_1940","title_1940_plain","title_1940_plain_with_replacements_stemmed","parentheses1_1940_plain_with_replacements_stemmed")],
          index_1940.indpar_edits[,c("id_1940","indname_1940_plain","indname_1940_plain_with_replacements_stemmed","parentheses1_1940_plain_with_replacements_stemmed")][,`:=`(ind_parentheses1_1940_plain_with_replacements_stemmed=parentheses1_1940_plain_with_replacements_stemmed,parentheses1_1940_plain_with_replacements_stemmed=NULL)],
          by="id_1940",all=TRUE),
        by="id_1940",all.x=TRUE,all.y=FALSE
  )[order(occ1940,name_ind1940_subgroup,title_1940_plain_with_replacements_stemmed,indname_1940_plain_with_replacements_stemmed)]


# 4. Count number of matched cases without dropping any observations
#* NOTE: When computing the share of new titles using different methods, be careful to multiply the matched vector by the vector of reduced titles (e.g. match_m=match_titind_inv*red_inv  --> sh_new_method1=1-match_m/red_inv)
## Aggregating the different measures and constructing share variables
count.clean_1940.by_subindustry_dataset1 <-
  rbind(
    clean_1940.by_subindustry_dataset1.by_occ_subind[,n:=1][,`:=`(match_m=match_titind_inv*red_inv,match_m1=match_titind_inv*red1_inv)][,lapply(.SD,sum),.SDcols=c("n","red","red_inv","red1","red1_inv","matched","match_tit","match_tit_inv","match_titind","match_titind_inv","match_m","match_m1"),by=c("occ1940","name_ind1940_subgroup")][,set:="within"][order(occ1940,name_ind1940_subgroup)],
    clean_1940.by_subindustry_dataset1.all[,n:=1][,`:=`(match_m=match_titind_inv*red_inv,match_m1=match_titind_inv*red1_inv)][,lapply(.SD,sum),.SDcols=c("n","red","red_inv","red1","red1_inv","matched","match_tit","match_tit_inv","match_titind","match_titind_inv","match_m","match_m1"),by=c("occ1940","name_ind1940_subgroup")][,set:="all"][order(occ1940,name_ind1940_subgroup)],
    clean_1940.by_subindustry_dataset1.by_occ_subind[,n:=1][,`:=`(match_m=match_titind_inv*red_inv,match_m1=match_titind_inv*red1_inv)][,lapply(.SD,sum),.SDcols=c("n","red","red_inv","red1","red1_inv","matched","match_tit","match_tit_inv","match_titind","match_titind_inv","match_m","match_m1")][,set:="Total_within"],
    clean_1940.by_subindustry_dataset1.all[,n:=1][,`:=`(match_m=match_titind_inv*red_inv,match_m1=match_titind_inv*red1_inv)][,lapply(.SD,sum),.SDcols=c("n","red","red_inv","red1","red1_inv","matched","match_tit","match_tit_inv","match_titind","match_titind_inv","match_m","match_m1")][,set:="Total_all"],
    fill=TRUE
  )[,`:=`(sh_new_all=1-matched/n,sh_new_method1=1-match_m/red_inv,sh_new_method2=1-match_m1/red1_inv)]

## Expand the set of occ-name_ind1940_subgroup by associating REST with all the other sectors
#*** NOTE: 
### Create table to merge
#* Merge with REST. We will use this to associate the value of the share variable for REST with the other sectors not present in the occ1940 group
temp <- unique(ind1940.names[name_ind1940_subgroup!="NONCLASSIFIABLE",c("name_ind1940_subgroup")])[,`:=`(temp_name_ind1940_subgroup=name_ind1940_subgroup,name_ind1940_subgroup="REST")]
temp <- rbind(temp,data.table(temp_name_ind1940_subgroup="REST",name_ind1940_subgroup="REST"))

### Merge with count.clean_1940.by_subindustry_dataset1
count.clean_1940.by_subindustry_dataset1 <- merge(count.clean_1940.by_subindustry_dataset1,temp,by="name_ind1940_subgroup",all.x=TRUE,all.y=FALSE,allow.cartesian=TRUE)[order(set,occ1940,name_ind1940_subgroup)]
count.clean_1940.by_subindustry_dataset1 <- count.clean_1940.by_subindustry_dataset1[name_ind1940_subgroup=="REST",name_ind1940_subgroup:=temp_name_ind1940_subgroup][,dup:=0+duplicated(name_ind1940_subgroup),by=c("occ1940","set")][,dup:=max(dup),by=c("occ1940","set","name_ind1940_subgroup")][order(set,occ1940,name_ind1940_subgroup)]
count.clean_1940.by_subindustry_dataset1 <- count.clean_1940.by_subindustry_dataset1[!( dup==1 & !is.na(temp_name_ind1940_subgroup) )][order(set,occ1940,name_ind1940_subgroup)][,!c("dup","temp_name_ind1940_subgroup")]

# 5. Export dataset for manual inspection
wrapper_Excel(
  list(
    clean_1940.by_subindustry_dataset1.by_occ_subind[red_inv==1,c("id_1940","occ1940","name_ind1940_subgroup","match_m","red_inv","title_1940_plain","indname_1940_plain","title_1940_plain_with_replacements_stemmed","parentheses1_1940_plain_with_replacements_stemmed","indname_1940_plain_with_replacements_stemmed","parentheses1_1940_plain_with_replacements_stemmed","match_tit","match_tit_inv","match_titind","match_titind_inv")],
    clean_1940.by_subindustry_dataset1.by_occ_subind[red1_inv==1,c("id_1940","occ1940","name_ind1940_subgroup","match_m1","red1_inv","title_1940_plain","indname_1940_plain","title_1940_plain_with_replacements_stemmed","parentheses1_1940_plain_with_replacements_stemmed","indname_1940_plain_with_replacements_stemmed","parentheses1_1940_plain_with_replacements_stemmed","match_tit","match_tit_inv","match_titind","match_titind_inv")],
    clean_1940.by_subindustry_dataset1.by_occ_subind[,c("id_1940","occ1940","name_ind1940_subgroup","matched","title_1940_plain","indname_1940_plain","title_1940_plain_with_replacements_stemmed","parentheses1_1940_plain_with_replacements_stemmed","indname_1940_plain_with_replacements_stemmed","parentheses1_1940_plain_with_replacements_stemmed","match_tit","match_tit_inv","match_titind","match_titind_inv")]
  ),
  list(
    "Reduction Method 1",
    "Reduction Methos 2",
    "No reduction"
  ),
  paste0(main_directory,"R - Processing data/temp/clean_1940.by_subindustry_dataset1.by_occ_subind.xlsx"))

```
Both clean_1940.by_subindustry_dataset1.all and clean_1940.by_subindustry_dataset1.by_occ_subind assigns to each observation in the 1940 Index a set of variables that defines if it could be matched with a title in 1930 and if it should be included in a list of non - repeated titles (e.g engineer flight, airplane is considered to be the same as flight engineer, airplane, if both are in the same occ). We use different methods to compute if a title is unique or repeated, as well as if it could be matched with a 1920 title
Differences between the two tables:
clean_1940....by_occ_subind:     This data set is constructed only comparing titles within an occ group
clean_1930....all: This data set is constructed only comparing titles in all the dataset, without distinguishing by occ

Description of the variables created:
- Match vectors: binary vector where 1 indicates that the title appeared in 1930 and 0 that it didn't
matched:        Original binary vector, before looking for repeated title
match_tit:      Extend matched by looking at repeated titles
match_tit_inv:  Extend match_tit by looking repeated title-industry combinations (considering reordering the combination)
match_titind:   Extend matched by looking at repeated title-industry combination
match_titind_inv:   Extend match_titind by looking at repeated title-industry combination REORDERED

- Red vectors: binary vector where 0 indicates that the title is repeated and 1 that it is not. Depending on the vector chosen we will only keep the titles that have a value of 1.
red:            Reduce titles using method 1
red_inv:        Extend red by considering title and industry together (reordered)
red1:           Reduce titles using method 2
red1_inv:       Extend red1 by considering title and industry together (reordered)


#### 7.4.2.2 Dataset 2: "ind" is allocated in each individual sector
##### Creating dataset, creating "Rest" industry
```{r}
# Creating the expanded Dataset2
## a. Extracting information from index_1940.by_subindustry
index_1940.by_subindustry_dataset2 <- index_1940.by_subindustry[,c("id_1940","occ1940","name_ind1940_subgroup","new")]

## b. Extract all titles with name_ind1940_subgroup equal to NA and where the occ1940 has more than 1 category
Temp <- copy(index_1940.by_subindustry_dataset2)[,N_ind:=(-1+duplicated(name_ind1940_subgroup))*(-1),by="occ1940"][,N_ind:=sum(N_ind),by="occ1940"][is.na(name_ind1940_subgroup) & N_ind>1][,!c("N_ind","name_ind1940_subgroup")]

## c. List of occ-name_ind1940_subgroup combinations
Temp_2 <- index_1940.by_subindustry_dataset2[,.SD[1],by=c("occ1940","name_ind1940_subgroup")][,c("occ1940","name_ind1940_subgroup")][!is.na(name_ind1940_subgroup)]

## d. Combine
Temp <- 
  merge(
    Temp,
    Temp_2,
    by="occ1940",all.x=TRUE,all.y=FALSE,allow.cartesian = TRUE
  )[,!c("N_ind")]

## e. rbind set
index_1940.by_subindustry_dataset2 <- 
  rbind(
    index_1940.by_subindustry_dataset2[is.na(name_ind1940_subgroup),name_ind1940_subgroup:="REST"],
    Temp
  )
rm(Temp,Temp_2)

## f. Merging with title and ind information
index_1940.by_subindustry_dataset2 <- 
  merge(index_1940.by_subindustry_dataset2,
        merge(
          title_edits.1940[,c("id_1940","title_1940_plain_with_replacements_stemmed","parentheses1_1940_plain_with_replacements_stemmed","title_1940_plain_with_replacements_stemmed_r","parentheses1_1940_plain_with_replacements_stemmed_r")],
          index_1940.indpar_edits[,c("id_1940","indname_1940_plain_with_replacements_stemmed","parentheses1_1940_plain_with_replacements_stemmed","indname_1940_plain_with_replacements_stemmed_r","parentheses1_1940_plain_with_replacements_stemmed_r")][,`:=`(ind_parentheses1_1940_plain_with_replacements_stemmed=parentheses1_1940_plain_with_replacements_stemmed,ind_parentheses1_1940_plain_with_replacements_stemmed_r=parentheses1_1940_plain_with_replacements_stemmed_r,parentheses1_1940_plain_with_replacements_stemmed=NULL,parentheses1_1940_plain_with_replacements_stemmed_r=NULL)],
          by="id_1940",all=TRUE
        ),
        by="id_1940",all.x=TRUE,all.y=FALSE
  )

# 2. Cleaning the Dataset2
## a. Drop duplicated ids
index_1940.by_subindustry_dataset2 <- index_1940.by_subindustry_dataset2[,dup:=0+duplicated(id_1940),by=c("occ1940","name_ind1940_subgroup")][dup==0]

## b. Drop repeated title - par and indname -par 
index_1940.by_subindustry_dataset2 <- index_1940.by_subindustry_dataset2[,dup:=0+duplicated(index_1940.by_subindustry_dataset2, by=c("title_1940_plain_with_replacements_stemmed_r","parentheses1_1940_plain_with_replacements_stemmed_r","indname_1940_plain_with_replacements_stemmed_r","ind_parentheses1_1940_plain_with_replacements_stemmed_r","occ1940","name_ind1940_subgroup"))][dup==0][,!c("dup")]

## c. Repeated title and no industry name
#*** NOTE: Be careful of two titles with the same name both have no industry.
index_1940.by_subindustry_dataset2 <- index_1940.by_subindustry_dataset2[,dup:=0+duplicated(title_1940_plain_with_replacements_stemmed_r),by=c("occ1940","name_ind1940_subgroup")][!(dup==1 & is.na(indname_1940_plain_with_replacements_stemmed_r))][,dup:=0+duplicated(title_1940_plain_with_replacements_stemmed_r),by=c("occ1940","name_ind1940_subgroup")][,dup:=max(dup),by=c("title_1940_plain_with_replacements_stemmed_r","occ1940","name_ind1940_subgroup")][!(dup==1 & is.na(indname_1940_plain_with_replacements_stemmed_r))][,!c("dup")]

## d. Repeated title, par, industry but no ind-par
index_1940.by_subindustry_dataset2 <- index_1940.by_subindustry_dataset2[,dup:=0+duplicated(index_1940.by_subindustry_dataset2, by=c("title_1940_plain_with_replacements_stemmed_r","parentheses1_1940_plain_with_replacements_stemmed_r","indname_1940_plain_with_replacements_stemmed_r","occ1940","name_ind1940_subgroup"))][!(dup==1 & is.na(ind_parentheses1_1940_plain_with_replacements_stemmed_r))][,dup:=max(dup),by=c("title_1940_plain_with_replacements_stemmed_r","parentheses1_1940_plain_with_replacements_stemmed_r","indname_1940_plain_with_replacements_stemmed_r","occ1940","name_ind1940_subgroup")][!(dup==1 & is.na(ind_parentheses1_1940_plain_with_replacements_stemmed_r))][,!c("dup")]

## e. Repeated title, industry, ind_par but no tit-par
index_1940.by_subindustry_dataset2 <- index_1940.by_subindustry_dataset2[,dup:=0+duplicated(index_1940.by_subindustry_dataset2, by=c("title_1940_plain_with_replacements_stemmed_r","ind_parentheses1_1940_plain_with_replacements_stemmed_r","indname_1940_plain_with_replacements_stemmed_r","occ1940","name_ind1940_subgroup"))][!(dup==1 & is.na(parentheses1_1940_plain_with_replacements_stemmed_r))][,dup:=max(dup),by=c("title_1940_plain_with_replacements_stemmed_r","ind_parentheses1_1940_plain_with_replacements_stemmed_r","indname_1940_plain_with_replacements_stemmed_r","occ1940","name_ind1940_subgroup")][!(dup==1 & is.na(parentheses1_1940_plain_with_replacements_stemmed_r))][,!c("dup")]

```
*** TO-DO : Why do I have repeated id_1940 variable by occ1940-name_ind_subgroup???

##### Create variables to reduce observations and expand the set of matched observations
Here we use the f_reduce_match function, which creates 6 binary vectors to be described below. 
**** TO-DO Reorganize variables created
*** NOTE: It doesn't make much sense to look at repeated titles using the whole dataset in dataset2. Since we took all the titles in REST categories and repeated them into the other industries we have a lot of repeated titles
---> No dataset clean_1940.by_subindustry_dataset2.all will be created
```{r}
# 1. Creating the matched variable
index_1940.by_subindustry_dataset2 <- index_1940.by_subindustry_dataset2[,matched:=ifelse(new==1,0,1)][!is.na(title_1940_plain_with_replacements_stemmed)]
# NOTE!!! To-DO: some observations without title. These are the ones with titles like girl, lady's maid... For now I dropped them


# 2. Adding the binary vectors to reduce observations and extend the matching vector
# We look at the whole dataset
#*** NOTE: It doesn't make much sense to look at repeated titles using the whole dataset in dataset2. Since we took all the titles in REST categories and repeated them into the other industries we have a lot of repeated titles

if (FALSE) {
clean_1940.by_subindustry_dataset2.all <- copy(index_1940.by_subindustry_dataset2)[,dup:=0+duplicated(id_1940)][dup==0]

## Use f_reduce_match to flag repeated observations and expand the matched variable
clean_1940.by_subindustry_dataset2.all <- clean_1940.by_subindustry_dataset2.all[,c("red","red1","red1_inv","match_tit","match_titind","match_titind_inv"):=mapply(FUN=f_reduce_match,obs_f=list(id_1940),tit_f=list(title_1940_plain_with_replacements_stemmed),tit_par_f=list(parentheses1_1940_plain_with_replacements_stemmed),ind_f=list(indname_1940_plain_with_replacements_stemmed),ind_par_f=list(ind_parentheses1_1940_plain_with_replacements_stemmed),match_f=list(matched))]
## Use the inverted case to further falg observations that need to be flagged
## We drop observations that are discarded using both methods
clean_1940.by_subindustry_dataset2.all <- clean_1940.by_subindustry_dataset2.all[,`:=`(match_tit_inv=pmax(match_tit,match_titind_inv))][,`:=`(red_inv=pmin(red,red1_inv))][,c("id_1940","occ1940","name_ind1940_subgroup","red","red_inv","red1","red1_inv","matched","match_tit","match_tit_inv","match_titind","match_titind_inv")][!( red==0 & red_inv==0 & red1==0 & red1_inv==0 )]
}

# We look within occ-name_ind1940_subgroup category 
clean_1940.by_subindustry_dataset2.by_occ_subind <- copy(index_1940.by_subindustry_dataset2)[,c("red","red1","red1_inv","match_tit","match_titind","match_titind_inv"):=mapply(FUN=f_reduce_match,obs_f=list(id_1940),tit_f=list(title_1940_plain_with_replacements_stemmed),tit_par_f=list(parentheses1_1940_plain_with_replacements_stemmed),ind_f=list(indname_1940_plain_with_replacements_stemmed),ind_par_f=list(ind_parentheses1_1940_plain_with_replacements_stemmed),match_f=list(matched)),by=c("occ1940","name_ind1940_subgroup")][,`:=`(match_tit_inv=pmax(match_tit,match_titind_inv))][,`:=`(red_inv=pmin(red,red1_inv))][,c("id_1940","occ1940","name_ind1940_subgroup","red","red_inv","red1","red1_inv","matched","match_tit","match_tit_inv","match_titind","match_titind_inv")][!( red==0 & red_inv==0 & red1==0 & red1_inv==0 )]

# 3. Data table to manually inspect
clean_1940.by_subindustry_dataset2.by_occ_subind <- 
  merge(clean_1940.by_subindustry_dataset2.by_occ_subind,
        merge(
          title_edits.1940[,c("id_1940","title_1940_plain","title_1940_plain_with_replacements_stemmed","parentheses1_1940_plain_with_replacements_stemmed")],
          index_1940.indpar_edits[,c("id_1940","indname_1940_plain","indname_1940_plain_with_replacements_stemmed","parentheses1_1940_plain_with_replacements_stemmed")][,`:=`(ind_parentheses1_1940_plain_with_replacements_stemmed=parentheses1_1940_plain_with_replacements_stemmed,parentheses1_1940_plain_with_replacements_stemmed=NULL)],
          by="id_1940",all=TRUE),
        by="id_1940",all.x=TRUE,all.y=FALSE
  )[order(occ1940,name_ind1940_subgroup,title_1940_plain,indname_1940_plain)]


# 4. Count number of matched cases without dropping any observations
## Aggregate
count.clean_1940.by_subindustry_dataset2 <-
  rbind(
    clean_1940.by_subindustry_dataset2.by_occ_subind[,n:=1][,`:=`(match_m=match_titind_inv*red_inv,match_m1=match_titind_inv*red1_inv)][,lapply(.SD,sum),.SDcols=c("n","red","red_inv","red1","red1_inv","matched","match_tit","match_tit_inv","match_titind","match_titind_inv","match_m","match_m1"),by=c("occ1940","name_ind1940_subgroup")][,set:="within"][order(occ1940,name_ind1940_subgroup)],
    clean_1940.by_subindustry_dataset2.by_occ_subind[,n:=1][,`:=`(match_m=match_titind_inv*red_inv,match_m1=match_titind_inv*red1_inv)][,lapply(.SD,sum),.SDcols=c("n","red","red_inv","red1","red1_inv","matched","match_tit","match_tit_inv","match_titind","match_titind_inv","match_m","match_m1")][,set:="Total_within"],
    fill=TRUE
  )[,`:=`(sh_new_all=1-matched/n,sh_new_method1=1-match_m/red_inv,sh_new_method2=1-match_m1/red1_inv)]

## Expand the set of occ-name_ind1940_subgroup by associating REST with all the other sectors
### Create table to merge
temp <- unique(ind1940.names[name_ind1940_subgroup!="NONCLASSIFIABLE",c("name_ind1940_subgroup")])[,`:=`(temp_name_ind1940_subgroup=name_ind1940_subgroup,name_ind1940_subgroup="REST")]
temp <- rbind(temp,data.table(temp_name_ind1940_subgroup="REST",name_ind1940_subgroup="REST"))

### Merge with count.clean_1940.by_subindustry_dataset1
count.clean_1940.by_subindustry_dataset2 <- merge(count.clean_1940.by_subindustry_dataset2,temp,by="name_ind1940_subgroup",all.x=TRUE,all.y=FALSE,allow.cartesian=TRUE)[order(set,occ1940,name_ind1940_subgroup)]
count.clean_1940.by_subindustry_dataset2 <- count.clean_1940.by_subindustry_dataset2[name_ind1940_subgroup=="REST",name_ind1940_subgroup:=temp_name_ind1940_subgroup][,dup:=0+duplicated(name_ind1940_subgroup),by=c("occ1940","set")][,dup:=max(dup),by=c("occ1940","set","name_ind1940_subgroup")][order(set,occ1940,name_ind1940_subgroup)]
count.clean_1940.by_subindustry_dataset2 <- count.clean_1940.by_subindustry_dataset2[!( dup==1 & !is.na(temp_name_ind1940_subgroup) )][order(set,occ1940,name_ind1940_subgroup)][,!c("dup","temp_name_ind1940_subgroup")]

# 5. Export dataset for manual inspection
wrapper_Excel(
  list(
    clean_1940.by_subindustry_dataset2.by_occ_subind[red_inv==1,c("id_1940","occ1940","name_ind1940_subgroup","match_m","red_inv","title_1940_plain","indname_1940_plain","title_1940_plain_with_replacements_stemmed","parentheses1_1940_plain_with_replacements_stemmed","indname_1940_plain_with_replacements_stemmed","parentheses1_1940_plain_with_replacements_stemmed","match_tit","match_tit_inv","match_titind","match_titind_inv")],
    clean_1940.by_subindustry_dataset2.by_occ_subind[red1_inv==1,c("id_1940","occ1940","name_ind1940_subgroup","match_m1","red1_inv","title_1940_plain","indname_1940_plain","title_1940_plain_with_replacements_stemmed","parentheses1_1940_plain_with_replacements_stemmed","indname_1940_plain_with_replacements_stemmed","parentheses1_1940_plain_with_replacements_stemmed","match_tit","match_tit_inv","match_titind","match_titind_inv")],
    clean_1940.by_subindustry_dataset2.by_occ_subind[,c("id_1940","occ1940","name_ind1940_subgroup","matched","title_1940_plain","indname_1940_plain","title_1940_plain_with_replacements_stemmed","parentheses1_1940_plain_with_replacements_stemmed","indname_1940_plain_with_replacements_stemmed","parentheses1_1940_plain_with_replacements_stemmed","match_tit","match_tit_inv","match_titind","match_titind_inv")]
  ),
  list(
    "Reduction Method 1",
    "Reduction Methos 2",
    "No reduction"
  ),
  paste0(main_directory,"R - Processing data/temp/clean_1940.by_subindustry_dataset2.by_occ_subind.xlsx"))


```
- clean_1940....all: The reduction vectors and new matched vectors are created using the whole dataset. E.g. two observations with the same title-par-industry-ind-par combination in different occupations will be treated as the same title
- clean_1940....by_occ_subind: The reduction vectors and new matched vectors are created using information within the occ1940-name_ind1940_subgroup group. E.g. two observations with the same title-par-industry-ind-par combination in different occupations - subindustry will be treated as different

#### 7.4.2.3 Dataset 3: work only with occupation categories
##### Creating dataset, creating "Rest" industry
```{r}
# 1. Creating the expanded Dataset2
index_1940.by_subindustry_dataset3 <- 
  merge(index_1940.by_subindustry[,c("id_1940","occ1940","new")],
        merge(
          title_edits.1940[,c("id_1940","title_1940_plain_with_replacements_stemmed","parentheses1_1940_plain_with_replacements_stemmed","title_1940_plain_with_replacements_stemmed_r","parentheses1_1940_plain_with_replacements_stemmed_r")],
          index_1940.indpar_edits[,c("id_1940","indname_1940_plain_with_replacements_stemmed","parentheses1_1940_plain_with_replacements_stemmed","indname_1940_plain_with_replacements_stemmed_r","parentheses1_1940_plain_with_replacements_stemmed_r")][,`:=`(ind_parentheses1_1940_plain_with_replacements_stemmed=parentheses1_1940_plain_with_replacements_stemmed,ind_parentheses1_1940_plain_with_replacements_stemmed_r=parentheses1_1940_plain_with_replacements_stemmed_r,parentheses1_1940_plain_with_replacements_stemmed=NULL,parentheses1_1940_plain_with_replacements_stemmed_r=NULL)],
          by="id_1940",all=TRUE
        ),
        by="id_1940",all.x=TRUE,all.y=FALSE
  )

# 2. Cleaning the Dataset3
## a. Drop duplicated ids
index_1940.by_subindustry_dataset3 <- index_1940.by_subindustry_dataset3[,dup:=0+duplicated(id_1940),by=c("occ1940")][dup==0]

## b. Drop repeated title - par and indname -par 
index_1940.by_subindustry_dataset3 <- index_1940.by_subindustry_dataset3[,dup:=0+duplicated(index_1940.by_subindustry_dataset3, by=c("title_1940_plain_with_replacements_stemmed_r","parentheses1_1940_plain_with_replacements_stemmed_r","indname_1940_plain_with_replacements_stemmed_r","ind_parentheses1_1940_plain_with_replacements_stemmed_r","occ1940"))][dup==0][,!c("dup")]

## c. Repeated title and no industry name
index_1940.by_subindustry_dataset3 <- index_1940.by_subindustry_dataset3[,dup:=0+duplicated(title_1940_plain_with_replacements_stemmed_r),by=c("occ1940")][!(dup==1 & is.na(indname_1940_plain_with_replacements_stemmed_r))][,dup:=0+duplicated(title_1940_plain_with_replacements_stemmed_r),by=c("occ1940")][,dup:=max(dup),by=c("title_1940_plain_with_replacements_stemmed_r","occ1940")][!(dup==1 & is.na(indname_1940_plain_with_replacements_stemmed_r))][,!c("dup")]

## d. Repeated title, par, industry but no ind-par
index_1940.by_subindustry_dataset3 <- index_1940.by_subindustry_dataset3[,dup:=0+duplicated(index_1940.by_subindustry_dataset3, by=c("title_1940_plain_with_replacements_stemmed_r","parentheses1_1940_plain_with_replacements_stemmed_r","indname_1940_plain_with_replacements_stemmed_r","occ1940"))][!(dup==1 & is.na(ind_parentheses1_1940_plain_with_replacements_stemmed_r))][,dup:=max(dup),by=c("title_1940_plain_with_replacements_stemmed_r","parentheses1_1940_plain_with_replacements_stemmed_r","indname_1940_plain_with_replacements_stemmed_r","occ1940")][!(dup==1 & is.na(ind_parentheses1_1940_plain_with_replacements_stemmed_r))][,!c("dup")]

## e. Repeated title, industry, ind_par but no tit-par
index_1940.by_subindustry_dataset3 <- index_1940.by_subindustry_dataset3[,dup:=0+duplicated(index_1940.by_subindustry_dataset3, by=c("title_1940_plain_with_replacements_stemmed_r","ind_parentheses1_1940_plain_with_replacements_stemmed_r","indname_1940_plain_with_replacements_stemmed_r","occ1940"))][!(dup==1 & is.na(parentheses1_1940_plain_with_replacements_stemmed_r))][,dup:=max(dup),by=c("title_1940_plain_with_replacements_stemmed_r","ind_parentheses1_1940_plain_with_replacements_stemmed_r","indname_1940_plain_with_replacements_stemmed_r","occ1940")][!(dup==1 & is.na(parentheses1_1940_plain_with_replacements_stemmed_r))][,!c("dup")]

```
*** TO-DO : Why do I have repeated id_1940 variable by occ1940-name_ind_subgroup???

##### Create variables to reduce observations and expand the set of matched observations
Here we use the f_reduce_match function, which creates 6 binary vectors to be described below. 
**** TO-DO Reorganize variables created
```{r}
# 1. Creating the matched variable
index_1940.by_subindustry_dataset3 <- index_1940.by_subindustry_dataset3[,matched:=ifelse(new==1,0,1)][!is.na(title_1940_plain_with_replacements_stemmed)]
# NOTE!!! To-DO: some observations without title. These are the ones with titles like girl, lady's maid... For now I dropped them


# 2. Adding the binary vectors to reduce observations and extend the matching vector
# We look at the whole dataset
clean_1940.by_subindustry_dataset3.all <- copy(index_1940.by_subindustry_dataset3)[,dup:=0+duplicated(id_1940)][dup==0]

## Use f_reduce_match to flag repeated observations and expand the matched variable
clean_1940.by_subindustry_dataset3.all <- clean_1940.by_subindustry_dataset3.all[,c("red","red1","red1_inv","match_tit","match_titind","match_titind_inv"):=mapply(FUN=f_reduce_match,obs_f=list(id_1940),tit_f=list(title_1940_plain_with_replacements_stemmed),tit_par_f=list(parentheses1_1940_plain_with_replacements_stemmed),ind_f=list(indname_1940_plain_with_replacements_stemmed),ind_par_f=list(ind_parentheses1_1940_plain_with_replacements_stemmed),match_f=list(matched))]
## Use the inverted case to further falg observations that need to be flagged
## We drop observations that are discarded using both methods
clean_1940.by_subindustry_dataset3.all <- clean_1940.by_subindustry_dataset3.all[,`:=`(match_tit_inv=pmax(match_tit,match_titind_inv))][,`:=`(red_inv=pmin(red,red1_inv))][,c("id_1940","occ1940","red","red_inv","red1","red1_inv","matched","match_tit","match_tit_inv","match_titind","match_titind_inv")][!( red==0 & red_inv==0 & red1==0 & red1_inv==0 )]

# We look within occ-name_ind1940_subgroup category 
clean_1940.by_subindustry_dataset3.by_occ <- copy(index_1940.by_subindustry_dataset3)[,c("red","red1","red1_inv","match_tit","match_titind","match_titind_inv"):=mapply(FUN=f_reduce_match,obs_f=list(id_1940),tit_f=list(title_1940_plain_with_replacements_stemmed),tit_par_f=list(parentheses1_1940_plain_with_replacements_stemmed),ind_f=list(indname_1940_plain_with_replacements_stemmed),ind_par_f=list(ind_parentheses1_1940_plain_with_replacements_stemmed),match_f=list(matched)),by=c("occ1940")][,`:=`(match_tit_inv=pmax(match_tit,match_titind_inv))][,`:=`(red_inv=pmin(red,red1_inv))][,c("id_1940","occ1940","red","red_inv","red1","red1_inv","matched","match_tit","match_tit_inv","match_titind","match_titind_inv")][!( red==0 & red_inv==0 & red1==0 & red1_inv==0 )]

# 3. Data table the manually inspect
clean_1940.by_subindustry_dataset3.by_occ <- 
  merge(clean_1940.by_subindustry_dataset3.by_occ,
        merge(
          title_edits.1940[,c("id_1940","title_1940_plain","title_1940_plain_with_replacements_stemmed","parentheses1_1940_plain_with_replacements_stemmed")],
          index_1940.indpar_edits[,c("id_1940","indname_1940_plain","indname_1940_plain_with_replacements_stemmed","parentheses1_1940_plain_with_replacements_stemmed")][,`:=`(ind_parentheses1_1940_plain_with_replacements_stemmed=parentheses1_1940_plain_with_replacements_stemmed,parentheses1_1940_plain_with_replacements_stemmed=NULL)],
          by="id_1940",all=TRUE),
        by="id_1940",all.x=TRUE,all.y=FALSE
  )
# Merge subindustry (even though we didn't work with subindustry)
clean_1940.by_subindustry_dataset3.by_occ <- 
  merge(clean_1940.by_subindustry_dataset3.by_occ,
        merge(
          index_1940[,c("id_1940","ind1940")],
          ind1940.names[,c("ind1940","name_ind1940_subgroup")],
          by="ind1940",all.x=TRUE,all.y=FALSE
        ),
        by="id_1940",all.x=TRUE,all.y=FALSE
  )[order(occ1940,title_1940_plain_with_replacements_stemmed,indname_1940_plain_with_replacements_stemmed,parentheses1_1940_plain_with_replacements_stemmed,ind_parentheses1_1940_plain_with_replacements_stemmed)]

# 4. Count number of matched cases without dropping any observations
count.clean_1940.by_subindustry_dataset3 <-
  rbind(
    clean_1940.by_subindustry_dataset3.by_occ[,n:=1][,`:=`(match_m=match_titind_inv*red_inv,match_m1=match_titind_inv*red1_inv)][,lapply(.SD,sum),.SDcols=c("n","red","red_inv","red1","red1_inv","matched","match_tit","match_tit_inv","match_titind","match_titind_inv","match_m","match_m1"),by=c("occ1940")][,set:="within"][order(occ1940)],
    clean_1940.by_subindustry_dataset3.all[,n:=1][,`:=`(match_m=match_titind_inv*red_inv,match_m1=match_titind_inv*red1_inv)][,lapply(.SD,sum),.SDcols=c("n","red","red_inv","red1","red1_inv","matched","match_tit","match_tit_inv","match_titind","match_titind_inv","match_m","match_m1"),by=c("occ1940")][,set:="all"][order(occ1940)],
    clean_1940.by_subindustry_dataset3.by_occ[,n:=1][,`:=`(match_m=match_titind_inv*red_inv,match_m1=match_titind_inv*red1_inv)][,lapply(.SD,sum),.SDcols=c("n","red","red_inv","red1","red1_inv","matched","match_tit","match_tit_inv","match_titind","match_titind_inv","match_m","match_m1")][,set:="Total_within"],
    clean_1940.by_subindustry_dataset3.all[,n:=1][,`:=`(match_m=match_titind_inv*red_inv,match_m1=match_titind_inv*red1_inv)][,lapply(.SD,sum),.SDcols=c("n","red","red_inv","red1","red1_inv","matched","match_tit","match_tit_inv","match_titind","match_titind_inv","match_m","match_m1")][,set:="Total_all"],
    fill=TRUE
  )[,`:=`(sh_new_all=1-matched/n,sh_new_method1=1-match_m/red_inv,sh_new_method2=1-match_m1/red1_inv)]

# 5. Export dataset for manual inspection
wrapper_Excel(
  list(
    clean_1940.by_subindustry_dataset3.by_occ[red_inv==1,c("id_1940","occ1940","name_ind1940_subgroup","match_m","red_inv","title_1940_plain","indname_1940_plain","title_1940_plain_with_replacements_stemmed","parentheses1_1940_plain_with_replacements_stemmed","indname_1940_plain_with_replacements_stemmed","parentheses1_1940_plain_with_replacements_stemmed","match_tit","match_tit_inv","match_titind","match_titind_inv")],
    clean_1940.by_subindustry_dataset3.by_occ[red1_inv==1,c("id_1940","occ1940","name_ind1940_subgroup","match_m1","red1_inv","title_1940_plain","indname_1940_plain","title_1940_plain_with_replacements_stemmed","parentheses1_1940_plain_with_replacements_stemmed","indname_1940_plain_with_replacements_stemmed","parentheses1_1940_plain_with_replacements_stemmed","match_tit","match_tit_inv","match_titind","match_titind_inv")],
    clean_1940.by_subindustry_dataset3.by_occ[,c("id_1940","occ1940","name_ind1940_subgroup","matched","title_1940_plain","indname_1940_plain","title_1940_plain_with_replacements_stemmed","parentheses1_1940_plain_with_replacements_stemmed","indname_1940_plain_with_replacements_stemmed","parentheses1_1940_plain_with_replacements_stemmed","match_tit","match_tit_inv","match_titind","match_titind_inv")]
  ),
  list(
    "Reduction Method 1",
    "Reduction Methos 2",
    "No reduction"
  ),
  paste0(main_directory,"R - Processing data/temp/clean_1940.by_subindustry_dataset3.by_occ.xlsx"))

```


## 7.5 Create dataset with all measures and compare different measures of share of new sectors
*** NOTE: In IPUMS it appears that there exists an occupation category 510, Laundresses, private family. In the Index of titles there is no title associated to that category. We will those assign a value of 0 for all variables.
```{r}
# Mix dataset1 and dataset2 with the complete set of sub-industries. This way we make sure that every occ1940-subind combination has assigned a value btw 0 and 1 for the share of new variables
## Dataset1
count.clean_1940.by_subindustry_dataset1 <-
  merge(
    count.clean_1940.by_subindustry_dataset1,
    rbind(
      merge(
        unique(occ1940.names[,c("occ1940")])[,nn:=1],
        unique(ind1940.names[,c("name_ind1940_subgroup")])[,nn:=1],
        by="nn",all=TRUE,allow.cartesian=TRUE
      )[name_ind1940_subgroup!="NONCLASSIFIABLE"][,set:="all"],
      merge(
        unique(occ1940.names[,c("occ1940")])[,nn:=1],
        unique(ind1940.names[,c("name_ind1940_subgroup")])[,nn:=1],
        by="nn",all=TRUE,allow.cartesian=TRUE
      )[name_ind1940_subgroup!="NONCLASSIFIABLE"][,set:="within"]
    ),
    by=c("occ1940","name_ind1940_subgroup","set"),all=TRUE
  )[order(set,occ1940,name_ind1940_subgroup)]
count.clean_1940.by_subindustry_dataset1 <-
  count.clean_1940.by_subindustry_dataset1[is.na(n),names(count.clean_1940.by_subindustry_dataset1[,!c("occ1940","name_ind1940_subgroup","set","nn")]):=0][,nn:=NULL]

## Dataset2
count.clean_1940.by_subindustry_dataset2 <-
  merge(
    count.clean_1940.by_subindustry_dataset2,
    merge(
      unique(occ1940.names[,c("occ1940")])[,nn:=1],
      unique(ind1940.names[,c("name_ind1940_subgroup")])[,nn:=1],
      by="nn",all=TRUE,allow.cartesian=TRUE
    )[name_ind1940_subgroup!="NONCLASSIFIABLE"][,set:="within"],
    by=c("occ1940","name_ind1940_subgroup","set"),all=TRUE,allow.cartesian=TRUE
  )[order(set,occ1940,name_ind1940_subgroup)]
count.clean_1940.by_subindustry_dataset2 <-
  count.clean_1940.by_subindustry_dataset2[is.na(n),names(count.clean_1940.by_subindustry_dataset1[,!c("occ1940","name_ind1940_subgroup","set","nn")]):=0][,nn:=NULL]

# Creating the dataset
New_titles_1940_by_occ_subind <-
  merge(
    merge(
      count.clean_1940.by_subindustry_dataset1[,c("occ1940","name_ind1940_subgroup","set","sh_new_all","sh_new_method1","sh_new_method2","n","red_inv","red1_inv")][,`:=`(sh_new_all_dataset1=sh_new_all,sh_new_method1_dataset1=sh_new_method1,sh_new_method2_dataset1=sh_new_method2,N_dataset1=n,N_red_inv_dataset1=red_inv,N_red1_inv_dataset1=red1_inv)][,c("sh_new_all","sh_new_method1","sh_new_method2","n","red_inv","red1_inv"):=NULL],
      count.clean_1940.by_subindustry_dataset2[,c("occ1940","name_ind1940_subgroup","set","sh_new_all","sh_new_method1","sh_new_method2","n","red_inv","red1_inv")][,`:=`(sh_new_all_dataset2=sh_new_all,sh_new_method1_dataset2=sh_new_method1,sh_new_method2_dataset2=sh_new_method2,N_dataset2=n,N_red_inv_dataset2=red_inv,N_red1_inv_dataset2=red1_inv)][,c("sh_new_all","sh_new_method1","sh_new_method2","n","red_inv","red1_inv"):=NULL],
      by=c("occ1940","name_ind1940_subgroup","set"),all=TRUE,allow.cartesian=TRUE
    ),
    count.clean_1940.by_subindustry_dataset3[,c("occ1940","set","sh_new_all","sh_new_method1","sh_new_method2","n","red_inv","red1_inv")][,`:=`(sh_new_all_dataset3=sh_new_all,sh_new_method1_dataset3=sh_new_method1,sh_new_method2_dataset3=sh_new_method2,N_dataset3=n,N_red_inv_dataset3=red_inv,N_red1_inv_dataset3=red1_inv)][,c("sh_new_all","sh_new_method1","sh_new_method2","n","red_inv","red1_inv"):=NULL],
    by=c("occ1940","set"),all=TRUE,allow.cartesian=TRUE
  )[order(set,occ1940,name_ind1940_subgroup)]


# Drop name_ind1940_subgroup=="NONCLASSIFIABLE"

New_titles_1940_by_occ_subind <- New_titles_1940_by_occ_subind[name_ind1940_subgroup!="NONCLASSIFIABLE" | is.na(name_ind1940_subgroup)]

# Converting NA values to 0.
#*** NOTE: Check why there are NA values. In this case the NA values are related to the occupation category 510, which has no titles associated
New_titles_1940_by_occ_subind <- New_titles_1940_by_occ_subind[,names(New_titles_1940_by_occ_subind[,!c("set","occ1940","name_ind1940_subgroup")]):=lapply(.SD,function(x) {x[is.na(x)] <- 0; x}),.SDcols=names(New_titles_1940_by_occ_subind[,!c("set","occ1940","name_ind1940_subgroup")])]

setcolorder(New_titles_1940_by_occ_subind, c("set","occ1940","name_ind1940_subgroup","sh_new_all_dataset1","sh_new_all_dataset2","sh_new_all_dataset3","sh_new_method1_dataset1","sh_new_method1_dataset2","sh_new_method1_dataset3","sh_new_method2_dataset1","sh_new_method2_dataset2","sh_new_method2_dataset3")) 

# Saving the dataset
write_fst(New_titles_1940_by_occ_subind,paste0(main_directory,"R - Processing data/output/Rdata/new_titles_1940_by_occ_subind.fst"))

# Understand the correlations
summary(lm(sh_new_method1_dataset1 ~ sh_new_method1_dataset2,data=New_titles_1940_by_occ_subind[set=="within"]))
summary(lm(sh_new_method1_dataset1 ~ sh_new_method1_dataset3,data=New_titles_1940_by_occ_subind[set=="within"]))
summary(lm(sh_new_method1_dataset2 ~ sh_new_method1_dataset3,data=New_titles_1940_by_occ_subind[set=="within"]))
```

- sh_new_all_... : The share variable is constructed using all titles and the initial matches. For this variable we don't reduce the set of titles and we don't adjust the initial matched vector
- sh_new_method1_...: We use method 1 to reduce the set of titles and adjust the matched vector by looking at repeated title-industry pairs within occ1940-name_ind1940_subgroup
- sh_new_method2_...: We use method 2 to reduce the set of titles and adjust the matched vector by looking at repeated title-industry pairs within occ1940-name_ind1940_subgroup

- ..._dataset1: the titles in the "ind" category are assigned to a new category
- ..._dataset2: assign every title with "ind" category to each one of the existing industries and the industries not present int the occ1940 will be assign the values of the ind category
- ..._dataset3: we omit the industry category, working only with the occupation category













