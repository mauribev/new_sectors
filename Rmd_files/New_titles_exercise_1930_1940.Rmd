---
title: "New titles exercise 1930-1940"
output: html_document
---
# Delete Workspace and load packages
## Function to load necessary packages
```{r}
f_load_pk <- function() {
  
  # Pacman: packages manager. It does different things, here I use it to load multiple packages at the same time
  library (pacman)
  p_load(readxl,foreign,readstata13,data.table,DT,plyr,dplyr,stringr,openxlsx,stringdist,reshape2,qdap,fst,ipumsr,tm,textreg,tmap,tmaptools,sf,leaflet,ipumsr)
  p_load(tictoc)
  p_load(formula.tools) # This package allows us to use as.characters on formulas. Will be used in the function f_regressions
  
  p_load(Hmisc)
  
  p_load(here) # allows to source files from the working directory of the project
  
  # Statistical packages
  p_load(fastDummies,sandwich,lmtest,estimatr)
  p_load(lfe,plm) # To use functions felm and plm
  p_load(weights)  # To perform weighted correlations
  
  #graphs
  p_load(ggplot2,maps,ggthemes,sjPlot,sjmisc,sjlabelled,jtools,ggstance,broom.mixed)
  p_load(ggpubr)   # Contains ggarrange, used to plot more than one grpah in the same figure
  p_load(scales)   # Used in histogram to show percent format
}
```



## Using function
```{r}
rm(list=setdiff(ls(all.names = TRUE), "f_load_pk"))
f_load_pk()
```

# Defining main and other directories
```{r}
main_directory <- "/Volumes/GoogleDrive/My Drive/New York 2015-2020/NYU/Year 4/Data Manuals/Alphabetical Index of Occupations and Industries/Occupational Title Lists - READY/"

```

# Part 0. Loading All the functions that will be used in this Rmd file

## Functions to draw multiple graphs at the regional level
```{r}
f_graph_regional <- function(X,year,geof,New_work) {
  for (i in New_work) {
    if (typeof(geof)!="character") stop("The argument geof has to be given as a character, i.e. in quotation")
    # Histogram
    ggplot(X, aes(x=!!sym(i))) +
      geom_histogram(color="black",bins=25,fill="white") +
      labs(title="",x="Share of New Work", y = "Count")  + 
      theme_tufte() + theme(legend.position = "none")
    
    ggsave(here(paste0("output/Graphs/",geof,"/",year,"/histogram_",i,".jpeg")),plot=last_plot())
    
    # Some Scatterplots
    # Population
    ggplot(X, aes(y=!!sym(i), x=log(perwt))) + geom_point(size=0.1) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and population",x="Population (log)", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))
    
    ggsave(here(paste0("output/Graphs/",geof,"/",year,"/corr_pop_x_",i,".jpeg")),plot=last_plot())
    
    # Gender
    ggplot(X, aes(y=!!sym(i), x=sh_male)) + geom_point(size=0.1) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and male population",x="Share of Males", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))
    
    ggsave(here(paste0("output/Graphs/",geof,"/",year,"/corr_sh_male_x_",i,".jpeg")),plot=last_plot())
    
    # Black population
    ggplot(X, aes(y=!!sym(i), x=sh_race_2)) + geom_point(size=0.1) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and black population",x="Share of Black population", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))
    
    ggsave(here(paste0("output/Graphs/",geof,"/",year,"/corr_sh_race_2_x_",i,".jpeg")),plot=last_plot())
    
    # Literate
    if (length(X$lit)>0) {
      ggplot(X, aes(y=!!sym(i), x=sh_lit)) + geom_point(size=0.1) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of literate population",x="Share of literate population", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))
      
      ggsave(here(paste0("output/Graphs/",geof,"/",year,"/corr_sh_lit_x_",i,".jpeg")),plot=last_plot())
    }
      
    # Labor force
    ggplot(X, aes(y=!!sym(i), x=sh_labforce_emp)) + geom_point(size=0.1) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of labor force",x="Share of labor force", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))
    
    ggsave(here(paste0("output/Graphs/",geof,"/",year,"/corr_sh_labforce_emp_x_",i,".jpeg")),plot=last_plot())
    
    # Working for wages
    ggplot(X, aes(y=!!sym(i), x=sh_wrkwage)) + geom_point(size=0.1) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of population working for wages",x="Share of population working for wages", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))
    
    ggsave(here(paste0("output/Graphs/",geof,"/",year,"/corr_sh_wrkwage_x_",i,".jpeg")),plot=last_plot())
    
    # Urban
    ggplot(X, aes(y=!!sym(i), x=sh_urban)) + geom_point(size=0.1) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of urban population",x="Share of urban population", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))
    
    ggsave(here(paste0("output/Graphs/",geof,"/",year,"/corr_sh_urban_x_",i,".jpeg")),plot=last_plot())
    
    # Farm
    ggplot(X, aes(y=!!sym(i), x=sh_farm)) + geom_point(size=0.1) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of farm population",x="Share of farm population", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))
    
    ggsave(here(paste0("output/Graphs/",geof,"/",year,"/corr_sh_farm_x_",i,".jpeg")),plot=last_plot())
    
    # Migration within the US
    ggplot(X, aes(y=!!sym(i), x=sh_mig_us)) + geom_point(size=0.1) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of internal migrants",x="Share of internal migrants", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))
    
    ggsave(here(paste0("output/Graphs/",geof,"/",year,"/corr_sh_mig_us_x_",i,".jpeg")),plot=last_plot())
    
    # Migration within the US at the state level - 5 years ago
    if (length(X$sh_mig5_state_1)>0) {
      ggplot(X, aes(y=!!sym(i), x=1-sh_mig5_state_1)) + geom_point(size=0.1) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of internal migrants",x="Share of internal migrants", y = "Share of New Work", caption="Internal migrants: people who lived in a different state 5 years ago") + theme_tufte() + theme(axis.line=element_line(color="black"))
      
      ggsave(here(paste0("output/Graphs/",geof,"/",year,"/corr_sh_mig_state_x_",i,".jpeg")),plot=last_plot())
    }
    
    # Migration within the US at the county level - 5 years ago
    if (length(X$sh_mig5_county_1)>0) {
      ggplot(X, aes(y=!!sym(i), x=1-sh_mig5_county_1)) + geom_point(size=0.1) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of internal migrants",x="Share of internal migrants", y = "Share of New Work", caption="Internal migrants: people who lived in a different county 5 years ago") + theme_tufte() + theme(axis.line=element_line(color="black"))
      
      ggsave(here(paste0("output/Graphs/",geof,"/",year,"/corr_sh_mig_county_x_",i,".jpeg")),plot=last_plot())
    }
    
    # Foreign migrants
    ggplot(X, aes(y=!!sym(i), x=sh_mig_ab)) + geom_point(size=0.1) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and share of foreign migrants",x="Share of foreign migrants", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))
    
    ggsave(here(paste0("output/Graphs/",geof,"/",year,"/corr_sh_mig_ab_x_",i,".jpeg")),plot=last_plot())
    
    # Education
    if (length(X$sh_educ_main_1)>0) {
      x <- c("sh_educ_main_1","sh_educ_main_2","sh_educ_main_3")
      p <- vector(mode = "list", length = length(x))
      for (j in 1:length(x)) {
        p[[j]] <- ggplot(X, aes_string(y=i, x= x[j])) + geom_point(size=0.1) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="",x="Share of workers", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"), legend.position = "top")
      }
      ggarrange(p[[1]],p[[2]],p[[3]],labels=c("HS Dropout","HS - College Dropout","College"),ncol=2,nrow=2)
      ggsave(here(paste0("output/Graphs/",geof,"/",year,"/corr_sh_educ_main_x_",i,"_1.jpeg")),plot=last_plot())
    }
    
    # Wage variables
    ## Yearly wage
    if (length(X$av_incwage)>0) {
      ggplot(X, aes(y=!!sym(i), x=av_incwage)) + geom_point(size=0.1) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and average yearly wages",x="average yearly wages", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))
      
      ggsave(here(paste0("output/Graphs/",geof,"/",year,"/corr_av_yearwage_",i,".jpeg")),plot=last_plot())
    }
    
    ## Weekly wage
    if (length(X$av_wkwage)>0) {
      ggplot(X, aes(y=!!sym(i), x=av_wkwage)) + geom_point(size=0.1) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and average weekly wages",x="average weekly wages", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))
      
      ggsave(here(paste0("output/Graphs/",geof,"/",year,"/corr_av_wkwage_",i,".jpeg")),plot=last_plot())
    }
    
    ## Hourly wage
    if (length(X$av_hrwage)>0) {
      ggplot(X, aes(y=!!sym(i), x=av_hrwage)) + geom_point(size=0.1) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work and average hourly wages",x="average hourly wages", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"))
      
      ggsave(here(paste0("output/Graphs/",geof,"/",year,"/corr_av_hrwage_",i,".jpeg")),plot=last_plot())
    }
    
    # Industry
    x <- c("sh_ind1950_main_1","sh_ind1950_main_2","sh_ind1950_main_3","sh_ind1950_main_4","sh_ind1950_main_5","sh_ind1950_main_6","sh_ind1950_main_7")
    p <- vector(mode = "list", length = length(x))
    for (j in 1:7) {
      p[[j]] <- ggplot(X, aes_string(y=i, x= x[j])) + geom_point(size=0.1) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="",x="Share of workers", y = "Share of New Work") + theme_tufte() + theme(axis.line=element_line(color="black"), legend.position = "top")
    }
    ggarrange(p[[1]],p[[2]],p[[3]],p[[4]],labels=c("Agriculture","Mining-Construction","Manufacturing","Tr-Comm-Util"),
              ncol=2,nrow=2)
    ggsave(here(paste0("output/Graphs/",geof,"/",year,"/corr_sh_ind1950_main_x_",i,"_1.jpeg")),plot=last_plot())
    ggarrange(p[[5]],p[[6]],p[[7]],labels=c("Trade","Services","Public Admin."),
              ncol=2,nrow=2)
    ggsave(here(paste0("output/Graphs/",geof,"/",year,"/corr_sh_ind1950_main_x_",i,"_2.jpeg")),plot=last_plot())
    
    
    # Occupation
    x <- c("sh_occ1950_main_0","sh_occ1950_main_100","sh_occ1950_main_200","sh_occ1950_main_300","sh_occ1950_main_400","sh_occ1950_main_500","sh_occ1950_main_600","sh_occ1950_main_700","sh_occ1950_main_730","sh_occ1950_main_800","sh_occ1950_main_900")
    p <- vector(mode = "list", length = length(x))
    for (j in 1:length(x)) {
      p[[j]] <- ggplot(X, aes_string(y=i, x= x[j])) +
        geom_point(size=0.1) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) +
        labs(title="",x="Share of workers", y = "Share of New Work") + theme(axis.line=element_line(color="black"), legend.position = "top") + theme_tufte() 
    }
    ggarrange(p[[1]],p[[2]],p[[3]],p[[4]],labels=c("Professional, Technical","Farmers","Managers, Officials and Proprietors","Clerical and Kindred"),font.label = list(size = 10),
              ncol = 2, nrow =2)
    ggsave(here(paste0("output/Graphs/",geof,"/",year,"/corr_sh_occ1950_main_x_",i,"_1.jpeg")),plot=last_plot())
    ggarrange(p[[5]],p[[6]],p[[7]],p[[8]],labels=c("Sales workers","Craftsmen","Operatives","Service Workers (private household)"),font.label = list(size = 10), ncol = 2, nrow =2)
    ggsave(here(paste0("output/Graphs/",geof,"/",year,"/corr_sh_occ1950_main_x_",i,"_2.jpeg")),plot=last_plot())
    ggarrange(p[[9]],p[[10]],p[[11]],labels=c("Service Workers (not household)","Farm laborers","Laborers"),font.label = list(size = 10),
              ncol = 2, nrow =2)
    ggsave(here(paste0("output/Graphs/",geof,"/",year,"/corr_sh_occ1950_main_x_",i,"_3.jpeg")),plot=last_plot())
      
  }
}
```

## Function to create industry variable
*!!!!! NOTE: This function can be used to create a table with industries (occupations) as rows and 5 main occupations (industries) as columns
*** TO-DO: *** Fix the function so that cols_.. and sh_new_cols_... Are not repeated
```{r}
# Function to construct the data.table with information at the industry level
# This code works by using a given (unchanged) name for some variables inside the code and by changing the name of argument var (and "var"_name)
# to those inside variables and then reverting to the original variables
# Note: Here we are using non-standard evaluation
f_ind_new_titles <- function(X,id_N,var=ind,sh_v,w_v=perwt,cols_v=occind,names=NULL) {
  # @param X data.table with at least 3 variables. (1) var, (2) sh_v, (3) cols_v
  # @param id_N Number of different cols_v to provide information about
  # @param var Variable that we are gonna have as the rows
  # @param cols_v Variable that we are gonna compute how var is distributed across cols_v
  
  y <- copy(X)

  # Through the code we will simply use varp as the variable
  setnames(y, c(deparse(substitute(var)),deparse(substitute(sh_v)),deparse(substitute(w_v)),deparse(substitute(cols_v))), c("varp","sh_new","perwt","cols")) 
  
  
  # Computing the different things
      y <- y[,`:=`(sh_new=perwt*sh_new)][,lapply(.SD,sum),by=c("varp","cols"),.SDcols=c("perwt","sh_new")][,c("sum_new","emp"):=lapply(.SD,sum),by="varp",.SDcols=c("sh_new","perwt")][,`:=`(sh_cols=perwt/emp,sh_new_cols=sh_new/sum_new)]
  
  setorderv(y,   c("varp" ,"sh_new_cols"),c(1,-1) )
  y <- y[,id:=1:.N,by="varp"][id<=id_N][,sh_new:=sh_new/emp][,sh_new:=sum_new/emp][,c("perwt","sum_new"):=NULL]
    
  y <- data.table::dcast(y, varp + sh_new + emp  ~ id, value.var = c("cols","sh_new_cols","sh_cols") )
    
  
  setnames(
    y,
    c("cols_1","cols_2","cols_3","cols_4","cols_5","sh_new_cols_1","sh_new_cols_2","sh_new_cols_3","sh_new_cols_4","sh_new_cols_5","sh_cols_1","sh_cols_2","sh_cols_3","sh_cols_4","sh_cols_5"),
    c( 
      paste0(substitute(cols_v),"_",c(1,2,3,4,5)),
      paste0("sh_new_",substitute(cols_v),"_",c(1,2,3,4,5)),
      paste0("sh_",substitute(cols_v),"_",c(1,2,3,4,5))
    )
  )
  
  if (!is.null(names)) {
    # It seems that the names argument doesn't get changed by reference, so we don't need    "names <- copy(names)"
    setnames(names, c(deparse(substitute(var)), paste0(substitute(var),"_name")  ), c("varp","varp_name")  )
  
    y <- merge(y,names,by="varp",all.x=TRUE,all.y=FALSE)
    
    # Reorder columns so that we have the industry code and name  
    if(!is.null(names$varp_name)) {
       idcols <- c("varp","varp_name"); cols <- c(idcols, names(y)[-which(names(y) %in% idcols)])
       setcolorder(y, cols)
    }
    setnames(y, c("varp_name"), c( paste0(substitute(var),"_name")   )) 
  }
  setorderv(y,c("sh_new",  "varp")  ,  c(-1,1)  )
  setnames(y, c("varp","sh_new"),
           c(deparse(substitute(var)),deparse(substitute(sh_v)))
           ) 
  
}
```
In the IPUMS sample the ind variable for the Census 1930 is missing for many workers. This is not the case for ind1950. It might be better to use the ind1950 variable instead of the ind one.

## Function to create occupations and new titles
****!!!! TO-DO: Review code. 
****!!!! Note: The code doesn't work that well. We could use the code initially created for industry to compute also the occupations table
```{r}
# Function to construct the data.table with information at the occupation level
 # NOte: FOr now we don't use different occ codes as the new titles are only created using occ1940
if (FALSE) {  
  f_occ_new_titles <- function(X,id_N,ind_v=ind,sh_v,w_v=perwt,occind_v=occind,names=NULL,occind_n,occind_name_n) {
    # Avoids confusion with variable ind
    y <- copy(X)
    #print(y)
    # Through the code we will simply use varp as the variable
    setnames(y, c(deparse(substitute(ind_v)),deparse(substitute(sh_v)),deparse(substitute(w_v)),deparse(substitute(occind_v))), c("v_ind","sh_new","perwt","occind")) 
  
    # Computing the different things
    y <- y[,lapply(.SD,sum),by=c("occind","sh_new","v_ind"),.SDcols=c("perwt")][,c("emp_occ"):=lapply(.SD,sum),by=c("occind","sh_new"),.SDcols=c("perwt")][,`:=`(sh_ind=perwt/emp_occ)]
    setorder(y,occind,-sh_ind)
    y <- y[,id:=1:.N,by="occind"][id<=id_N][,c("perwt"):=NULL]
    
    setnames(y, c("v_ind"), c(deparse(substitute(ind_v))) ) 
    # Since the variables in value.var are given as characters I can easily use var_ch. That way I have the correct name for the wide variable
    y <- data.table::dcast(y, occind + sh_new + emp_occ  ~ id, value.var = c(deparse(substitute(ind_v)),"sh_ind") )
    
    if (!is.null(names)) {
      
      setnames(names, c( deparse(substitute(occind_n) ), deparse(substitute(occind_name_n))  ), c("occind","occind_name")  )
      
      y <- merge(y,names,by="occind",all.x=TRUE,all.y=FALSE)
      
      idcols <- c("occind","occind_name"); cols <- c(idcols, names(y)[-which(names(y) %in% idcols)])  
      setcolorder(y, cols)
      
    }
    setorder(y,-sh_new,occind)
    
    setnames(y, c("occind","sh_new","occind_name"),
             c(deparse(substitute(occind_v)),deparse(substitute(sh_v)),deparse(substitute(occind_name_n)))
             ) 
  }
}

```

## Functions related to regressions
### Function to export results
```{r}
f_reg_results <- function(Regresults,arg_round=4) {
  # NOTES:
  # Regresults: data.table with 5 columns. (1) Name of variables, (2) Regression coefficient, (3) Standard value, (4) T-Value, (5) P_value
  # Arg_round: number of significance digits. 4 bu default
  
  X <- copy(Regresults)
  setnames(X,c(2,3,4,5),c("coef","std","t_value","p_value"))
  X[,coef_star:=ifelse(p_value>0.1,format(round(coef,arg_round),nsmall=2),ifelse(p_value>0.05,paste0(format(round(coef,arg_round),nsmall=2),"*"),ifelse(p_value>0.01,paste0(format(round(coef,arg_round),nsmall=2),"**"),paste0(format(round(coef,arg_round),nsmall=2),"***"))))]
  #coef.J[,coef_star:=ifelse(x==1,paste0(format(round(coef,arg_round),nsmall=2),"***"),ifelse(x==5,paste0(format(round(coef,arg_round),nsmall=2),"**"),ifelse(x==10,paste0(format(round(coef,arg_round),nsmall=2),"*"),format(round(coef,arg_round),nsmall=2))))]
  X[,std_par:=paste0("(",format(round(std,arg_round),nsmall=2),")")]
  return(X)
}
```

### Function to add a YES,NO vector if a given variable exists
```{r}
# arg_rn: name of the data.table variable containing all the names of the variables in the regression
# var_rn: name of the Regression variable that will be used to construct the Yes, NO vector
# name:   name of the Regression variable that will contain the Yes, NO vector
# NOTES: var_rn and names have to have the same size and have to be vectors of strings
f_reg_results_VAR_exist <- function(X,arg_rn,var_rn,name) {
  setnames(X,deparse(substitute(arg_rn)),c("arg_rn"))
  if (length(var_rn) != length(name)) stop("var_rn and name have to have the same dimension")
  for (i in 1:length(var_rn)) {
    X <- 
      rbind(
        X,
        X[arg_rn==var_rn[i]][,lapply(.SD,function(x) {ifelse(is.na(x),"NO","YES")}),.SDcols=names(Y)][,arg_rn:=name[i]]
      )
    
  } 
  setnames(X,c("arg_rn"),deparse(substitute(arg_rn)))
  return(X)
}
```

### Function to perform a set of regressions
This function works with methods lm and lm_robust
TO-DO:
- For lm_robust need to specify the possibility of not using clusters
NOTE: This first function doesn't include the method felm. I use the second function, but keep this in case the second function doesn't work.

```{r}
f_regressions <- function(arg_formula,arg_data,arg_weights,method,arg_clusters,arg_fe,to_iter = 1000, by_iter = 10) {
  # Arguments:
  #           - arg_formula: list with the set of regressions formulas
  #           - arg_data: dataset with the variables in arg_formula
  #           - arg_weights: variable contianing the weights used in the regression
  #           - method: either "lm", "lm_robust" or "felm:
  #           - arg_clusters: Variable used to cluster standard errors.
  #           - arg_fe: It will be a character with the name of the fe variable. This variable will only be used if you specify the "felm" method
  #           - iter_vec: vector containing the numbers of the iteration that you want to be displayed
  
  # !!!!! Note 1: There is a conflict if arg_formula is not a list. E.g. if you create a list (LS) but in arg_formula you introduce LS[[i]], the function will try to subset it and that will give an error. If that is the case introduce it as a list, e.g. list(LS[[i]])
  # !!!!! Note 2: For lm and lm_robust the arg_formula argument needs to be a list of formulas. 
  #               For felm the arg_formula argumente can be a character or a formula. Make sure that the package formula.tools is loaded 
  
  # Note 3: Instead of copying arg_data I decided to change the names back to their original names at the end of the function.
  # Note4-TO-DO: Allow for the introduction of instrumental variables! (for felm for sure, other methods???)
  # Note5: For an unknown reason when we convert a matrix with just one row to a data.table we ran into trouble
  #        Previous command data.table(A$coefficients[1:4],keep.rownames=TRUE): when only one row, row names are not kept and we simply get a vector of dimension for and column name V1
  #        New command data.table(A$coefficients,keep.rownames=TRUE)[,1:5]: We first convert to data.table and then select the columns that we want
  
  iter_vec <- seq(from =0, to = to_iter, by = by_iter)
  i <- 1
  i0 <- 0 # Initialize i0 
  
  ## IF argument ARG_CLUSTER is specified
  #* NOTE: I create a new variable because there is an issue if the FE variable is the same as the cluster
  if (!missing(arg_clusters)) {
    setnames(arg_data,c(deparse(substitute(arg_clusters))),c("temp"))
    arg_data[,arg_cl:=temp]
    setnames(arg_data,c("temp"),c(deparse(substitute(arg_clusters))))
  }
  
  ## IF argument ARG_WEIGHTS is specified
  if (!missing(arg_weights)) {
    setnames(arg_data,c(deparse(substitute(arg_weights))),c("arg_w"))
    if (i %in% iter_vec) {
      tic(paste0("Iteration ",i," to ",min(i+by_iter-1,length(arg_formula))))
      i0 <- i + by_iter -1
    }
    if (method=="lm") {
      A <- summary(lm(arg_formula[[1]],data=arg_data,weights=arg_w,model=FALSE))
      other <- data.table(rn=c("nobs","r2","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",6),model_1=    c(length(A$residuals),format(round(A$r.squared,4),nsmall=2),format(round(A$adj.r.squared,4),nsmall=2),unname(A$fstatistic)) )
    } else if (method=="lm_robust") {
      if (missing(arg_clusters)) {
        A <- summary(lm_robust(arg_formula[[1]],weights=arg_w,se_type="stata",data=arg_data))
      } else {
        A <- summary(lm_robust(arg_formula[[1]],weights=arg_w,clusters=arg_cl,se_type="stata",data=arg_data))
      }
      other <- data.table(rn=c("nobs","r2","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",6),model_1=c(A$nobs,format(round(A$r.squared,4),nsmall=2),format(round(A$adj.r.squared,4),nsmall=2),unname(A$fstatistic)))
    } else if (method=="felm") {
      if (missing(arg_fe)) arg_fe <- "0"
      
      if (!missing(arg_clusters)) {
        #setnames(arg_data,c(deparse(substitute(arg_clusters))),c("arg_cl"))
        A <- summary(felm(as.formula(paste0(as.character(arg_formula[[1]])," | ",arg_fe," | 0 | arg_cl")),weights=arg_data$arg_w,data=arg_data))
      } else {
        A <- summary(felm(as.formula(paste0(as.character(arg_formula[[1]])," | ",arg_fe," | 0 | 0")),weights=arg_data$arg_w,data=arg_data))
      }
      
      other <- data.table(rn=c("nobs","r2","adj.r2","fstat_value","fstat_numdf","fstat_dendf","fstat_proj_value","fstat_proj_numdf","fstat_proj_dendf"),variable=rep("zother",9),model_1=c(A$N,format(round(A$r.squared,4),nsmall=2),format(round(A$adj.r.squared,4)),unname(A$F.fstat[1:3]),unname(A$P.fstat[c(5,3,6)])) )
    }
    #*** Look at Note5
    coef <- f_reg_results( data.table(A$coefficients,keep.rownames=TRUE)[,1:5], arg_round=4 )
    coef <- melt(coef,id.vars = c("rn"), measure.vars = c("coef","std","t_value","p_value","coef_star","std_par"),value.name=c(paste0("model_",1)))
    coef <- rbind(coef,other)
    if (i == i0) toc()
    rm(A,other)
    
    if (length(arg_formula)>1) {
      for (i in 2:length(arg_formula)) {
        if (i %in% iter_vec) {
          tic(paste0("Iteration ",i," to ",min(i+by_iter-1,length(arg_formula))))
          i0 <- i+by_iter -1
        }
        if (method=="lm") {
          A <- summary(lm(arg_formula[[i]],data=arg_data,weights=arg_w,model=FALSE))
          other <- data.table(rn=c("nobs","r2","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",6),model_1=    c(length(A$residuals),format(round(A$r.squared,4),nsmall=2),format(round(A$adj.r.squared,4),nsmall=2),unname(A$fstatistic)) )
          setnames(other,c(3),c(paste0("model_",i)))
        } else if (method=="lm_robust") {
          if (missing(arg_clusters)) {
            A <- summary(lm_robust(arg_formula[[i]],weights=arg_w,se_type="stata",data=arg_data))
          } else {
            A <- summary(lm_robust(arg_formula[[i]],weights=arg_w,clusters=arg_cl,se_type='stata',data=arg_data))
          }
          other <- data.table(rn=c("nobs","r2","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",6),model_1=c(A$nobs,format(round(A$r.squared,4),nsmall=2),format(round(A$adj.r.squared,4),nsmall=2),unname(A$fstatistic)))
          setnames(other,c(3),c(paste0("model_",i)))
        } else if (method=="felm") {
          
          if (!missing(arg_clusters)) {
            A <- summary(felm(as.formula(paste0(as.character(arg_formula[[i]])," | ",arg_fe," | 0 | arg_cl")),weights=arg_data$arg_w,data=arg_data))
          } else {
            A <- summary(felm(as.formula(paste0(as.character(arg_formula[[i]])," | ",arg_fe," | 0 | 0")),weights=arg_data$arg_w,data=arg_data))
          }
          other <- data.table(rn=c("nobs","r2","adj.r2","fstat_value","fstat_numdf","fstat_dendf","fstat_proj_value","fstat_proj_numdf","fstat_proj_dendf"),variable=rep("zother",9),model_1=c(A$N,format(round(A$r.squared,4),nsmall=2),format(round(A$adj.r.squared,4)),unname(A$F.fstat[1:3]),unname(A$P.fstat[c(5,3,6)])) )
          setnames(other,c(3),c(paste0("model_",i)))
        }
        #*** Look at Note5
        t <- f_reg_results( data.table(A$coefficients,keep.rownames=TRUE)[,1:5], arg_round=4)
        t <- melt(t,id.vars = c("rn"), measure.vars = c("coef","std","t_value","p_value","coef_star","std_par"),value.name=c(paste0("model_",i)))
        t <- rbind(t,other)
        coef <- merge(coef,t,by=c("rn","variable"),all=TRUE)
        rm(A,other,t)
        if (i0==i) toc()
      }
    
    }
    
    
  ## NOOO argument ARG_WEIGHTS 
  } else {
    if (i %in% iter_vec) {
      tic(paste0("Iteration ",i," to ",min(i+by_iter-1,length(arg_formula))))
      i0 <- i + by_iter -1
    }
    if (method=="lm") {
      A <- summary(lm(arg_formula[[1]],data=arg_data,model=FALSE))
      other <- data.table(rn=c("nobs","r2","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",6),model_1=    c(length(A$residuals),format(round(A$r.squared,4),nsmall=2),format(round(A$adj.r.squared,4),nsmall=2),unname(A$fstatistic)) )
    } else if (method=="lm_robust") {
      if (missing(arg_clusters)) {
        A <- summary(lm_robust(arg_formula[[1]],se_type="stata",data=arg_data))
      } else {
        A <- summary(lm_robust(arg_formula[[1]],clusters=arg_cl,se_type='stata',data=arg_data))
      }
      other <- data.table(rn=c("nobs","r2","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",6),model_1=c(A$nobs,format(round(A$r.squared,4),nsmall=2),format(round(A$adj.r.squared,4),nsmall=2),unname(A$fstatistic)))
    } else if (method=="felm") {
      if (missing(arg_fe)) arg_fe <- "0"
      
      if (!missing(arg_clusters)) {
        #setnames(arg_data,c(deparse(substitute(arg_clusters))),c("arg_cl"))
        A <- summary(felm(as.formula(paste0(as.character(arg_formula[[1]])," | ",arg_fe," | 0 | arg_cl")),data=arg_data))
      } else {
        A <- summary(felm(as.formula(paste0(as.character(arg_formula[[1]])," | ",arg_fe," | 0 | 0")),data=arg_data))
      }
      
      other <- data.table(rn=c("nobs","r2","adj.r2","fstat_value","fstat_numdf","fstat_dendf","fstat_proj_value","fstat_proj_numdf","fstat_proj_dendf"),variable=rep("zother",9),model_1=c(A$N,format(round(A$r.squared,4),nsmall=2),format(round(A$adj.r.squared,4)),unname(A$F.fstat[1:3]),unname(A$P.fstat[c(5,3,6)])) )
    }
    
    coef <- f_reg_results( data.table(A$coefficients,keep.rownames=TRUE)[,1:5], arg_round=4 )
    coef <- melt(coef,id.vars = c("rn"), measure.vars = c("coef","std","t_value","p_value","coef_star","std_par"),value.name=c(paste0("model_",1)))
    coef <- rbind(coef,other)
    if (i == i0) toc()
    rm(A,other)
    
    if (length(arg_formula)>1) {
      for (i in 2:length(arg_formula)) {
        if (i %in% iter_vec) {
          tic(paste0("Iteration ",i," to ",min(i+by_iter-1,length(arg_formula))))
          i0 <- i + by_iter -1
        }
        if (method=="lm") {
          A <- summary(lm(arg_formula[[i]],data=arg_data,model=FALSE))
          other <- data.table(rn=c("nobs","r2","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",6),model_1=    c(length(A$residuals),format(round(A$r.squared,4),nsmall=2),format(round(A$adj.r.squared,4),nsmall=2),unname(A$fstatistic)) )
          setnames(other,c(3),c(paste0("model_",i)))
        } else if (method=="lm_robust") {
          if (missing(arg_clusters)) {
            A <- summary(lm_robust(arg_formula[[i]],weights=arg_w,se_type="stata",data=arg_data))
          } else {
            A <- summary(lm_robust(arg_formula[[i]],weights=arg_w,clusters=arg_cl,se_type='stata',data=arg_data))
          }
          other <- data.table(rn=c("nobs","r2","adj.r2","fstat_value","fstat_numdf","fstat_dendf"),variable=rep("zother",6),model_1=c(A$nobs,format(round(A$r.squared,4),nsmall=2),format(round(A$adj.r.squared,4),nsmall=2),unname(A$fstatistic)))
          setnames(other,c(3),c(paste0("model_",i)))
        } else if (method=="felm") {
          
          if (!missing(arg_clusters)) {
            A <- summary(felm(as.formula(paste0(as.character(arg_formula[[i]])," | ",arg_fe," | 0 | arg_cl")),data=arg_data))
          } else {
            A <- summary(felm(as.formula(paste0(as.character(arg_formula[[i]])," | ",arg_fe," | 0 | 0")),data=arg_data))
          }
          other <- data.table(rn=c("nobs","r2","adj.r2","fstat_value","fstat_numdf","fstat_dendf","fstat_proj_value","fstat_proj_numdf","fstat_proj_dendf"),variable=rep("zother",9),model_1=c(A$N,format(round(A$r.squared,4),nsmall=2),format(round(A$adj.r.squared,4)),unname(A$F.fstat[1:3]),unname(A$P.fstat[c(5,3,6)])) )
        }
        
        t <- f_reg_results( data.table(A$coefficients,keep.rownames=TRUE)[,1:5], arg_round=4)
        t <- melt(t,id.vars = c("rn"), measure.vars = c("coef","std","t_value","p_value","coef_star","std_par"),value.name=c(paste0("model_",i)))
        t <- rbind(t,other)
        coef <- merge(coef,t,by=c("rn","variable"),all=TRUE)
        rm(A,other,t)
        if (i == i0) toc()
      }
    
    }
    
    
  }
  
  coef <- as.data.table(coef)
  coef[,order:=ifelse(variable=="zother",1,0)]
  setorder(coef,order,rn)
  coef[,order:=NULL]
  
  if (!missing(arg_weights)) { setnames(arg_data, c("arg_w"), c(deparse(substitute(arg_weights))) )   }
  
  if (!missing(arg_clusters)) {
    #setnames(arg_data,c("arg_cl"),c(deparse(substitute(arg_clusters))))
    arg_data <- arg_data[,arg_cl:=NULL]
  }
  if (i==length(arg_formula)) toc()
  return(coef)
}

```

### Function to order (regressions)
Given a dataset (X) a variable in the data_set (order_var) and a vector of names of the variables, this function orders the dataset X according to the order provided in the vector Order
```{r}
f_order_reg <- function(X,Order,order_var) {
  Y <- copy(X)[,vec_order:=Inf]
  setnames(Y,c(deparse(substitute(order_var))),c("arg_order_var"))
  for (i in 1:length(Order)) {
    Y <- Y[arg_order_var %in% Order[[i]],vec_order:=i]
  }
  Y <- Y[order(vec_order,arg_order_var)][,vec_order:=NULL]
  setnames(Y,c("arg_order_var"),c(deparse(substitute(order_var))))
  return (Y)
}
```

## Functions to export tables to Excel
```{r}
wrapper_Excel <- function(list_table,list_name,output) {
  t <- createWorkbook()
  for (i in 1:length(list_table)) {
    addWorksheet(t, list_name[[i]])
    writeData(t, list_name[[i]],list_table[[i]])
  }
  saveWorkbook(t, output,overwrite=TRUE)
}
```

## Functions to simplify ind1950 and occ1950
```{r}
f_ind1950 <- function(X,sec_v,flag=0) {
  setnames( X,c(deparse(substitute(sec_v))),c("industry"))
  
  X <- X[industry %in% 100:199,ind1950_main:=1] # Agriculture
  X <- X[industry %in% 200:299,ind1950_main:=2] # Mining and Construction
  X <- X[industry %in% 300:499,ind1950_main:=3] # Manufacturing
  X <- X[industry %in% 500:599,ind1950_main:=4] # Transportation, Communication, and Other Utilities
  X <- X[industry %in% 600:699,ind1950_main:=5] # Trade
  X <- X[industry %in% 700:899,ind1950_main:=6] # Services
  X <- X[industry %in% 900:949,ind1950_main:=7] # Public Administration
  X <- X[industry == 0 | industry>=950,ind1950_main:=0] # Non-specified, missing
  
  if (flag==0) {
    setnames(X,c("industry"),c(deparse(substitute(sec_v))))
  } else {
    # Drop the individual industry number
    X <- X[,industry:=NULL]
  }
  return(X)
}


### Main occupation using occ1950
# We use the occ1950 because it is available in every sample. We have to think carefully what might be the issue if you use occ for other parts of the work.
# NOTE: you need to provide the ind1950 variable
f_occ1950 <- function(X,occ_v,flag=0) {
  setnames( X,c(deparse(substitute(occ_v))),c("occupation"))
  
  X <- X[occupation >= 0 & occupation<= 99 ,occ1950_main:= 0] #           "Professional, Technical"
  X <- X[occupation >= 100 & occupation<= 199, occ1950_main:= 100 ] #     "Farmers"
  X <- X[occupation >= 200 & occupation<= 299, occ1950_main:= 200] #      "Managers, Officials, and Proprietors"',
  X <- X[occupation >= 300 & occupation<= 399, occ1950_main:= 300] #      "Clerical and Kindred"
  X <- X[occupation >= 400 & occupation<= 499, occ1950_main:= 400] #      "Sales workers"
  X <- X[occupation >= 500 & occupation<= 599 , occ1950_main:= 500] #     "Craftsmen"
  X <- X[occupation >= 600 & occupation<= 699, occ1950_main:= 600] #      "Operatives"
  X <- X[occupation >= 700 & occupation<= 729, occ1950_main:= 700] #      "Service Workers (private household)"
  X <- X[occupation >= 730 & occupation<= 799, occ1950_main:= 730] #      "Service Workers (not household)"
  X <- X[occupation >= 800 & occupation<= 899, occ1950_main:= 800] #      "Farm laborers"
  X <- X[occupation >= 900 & occupation<= 970, occ1950_main:= 900] #      "Laborers"
  X <- X[occupation >= 979 & occupation<= 999, occ1950_main:= 979] #      "Missing, not classified"
  
  if (flag==0) {
    setnames(X,c("occupation"),c(deparse(substitute(occ_v))))
  } else {
    # Drop the individual industry number
    X <- X[,occupation:=NULL]
  }
  return(X)
}
```

## Function to create Hirschman-Herfindahl index
```{r}
f_HHI <- function(X,geof,weight,arg_ind) {
  X <- copy(X)
  
  # If no geof compute the HHI index for the whole dataset. 
  if (missing(geof)) {
    X[,g:=1]
    setnames( X,c(deparse(substitute(weight)),deparse(substitute(arg_ind))),c("w","v"))
  } else {
    setnames( X,c(deparse(substitute(weight)),deparse(substitute(arg_ind)),deparse(substitute(geof))),c("w","v","g"))
  }
  # flag=1 drop observations with NA values
  X <- X[!is.na(w) & w>0 & !is.na(g) & (!is.na(v))]
  
  X <- X[,lapply(.SD,sum,na.rm=TRUE),by=c("g","v"),.SDcols=c("w")][,N:=.N,by=c("g")]
  X <- X[,si:=sum(w),by=c("g")][,si:=w/si][,si2:=si*si]
  X <- X[,H:=sum(si2),by=c("g")][,H:=-(H-1/N)/(1-1/N)]   # Last formula scales the index between -1 and 0. Values closer to zero imply more variety
  X <- X[,.SD[1],by=c("g"),.SDcols=c("H")]
  if (!missing(geof)) { 
    setnames(X,c("g"),c(deparse(substitute(geof))))
  } else {
    X[,g:=NULL]
  }
  return(X)
}

```

# Part 1. Data Analysis at the geographic level
Here we look at correlations between the share of new titles and different geographic level variables

## Loading packages and erasing the workspace (make sure to have loaded f_load_pk)
```{r}
rm(list = setdiff(ls(),c(lsf.str(),"main_directory") ))
f_load_pk()
```

## 1. County 1910
### Histogram and correlation graphs
```{r}
# Note: We work with counties with more than 10000 inhabitants
census_sample_1940_agg_countynhg_1910 <- read_fst(here("output/Rdata/census_sample_1940_agg_countynhg_1910.fst"),as.data.table=TRUE)[perwt>=10000][,statefip:=as.factor(statefip)]

f_graph_regional(census_sample_1940_agg_countynhg_1910,1940,"countynhg_1910",c("sh_new_method1_dataset1","sh_new_method1_dataset2","sh_new_method1_dataset3"))
```


### Basic regressions
```{r}
# Basic
m1 <- lm(sh_red_tit ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab, data=census_sample_1940_agg_countynhg_1910)
m2 <- lm(sh_red_tit ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab + statefip , data=census_sample_1940_agg_countynhg_1910)
m3 <- plm(sh_red_tit ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab, 
                    data = census_sample_1940_agg_countynhg_1910,
                    index = c("statefip"), 
                    model = "within")

tab_model(m1,m2,m3,show.ci=FALSE,show.se=TRUE,use.viewer=FALSE)
plot_summs(m1,m3, scale = FALSE,legend.title = "") + theme_tufte()
ggsave(here("output/Graphs/countynhg_1910/reg_basic_1940.jpeg"),plot=last_plot())

# Industry variables
(indvar <- grep("^sh_ind1950_main_[^1]",names(census_sample_1940_agg_countynhg_1910),value=TRUE))

form <- as.formula(paste("sh_red_tit ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab +",paste0(indvar,collapse=" + ")))
form1 <- as.formula(paste("sh_red_tit ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab + statefip +",paste0(indvar,collapse=" + ")))

m4 <- lm(form,data=census_sample_1940_agg_countynhg_1910)
m5 <- lm(form1, data=census_sample_1940_agg_countynhg_1910)
m6 <- plm(form1, 
                    data = census_sample_1940_agg_countynhg_1910,
                    index = c("statefip"), 
                    model = "within")

tab_model(m4,m5,m6,show.ci=FALSE,show.se=TRUE,use.viewer=FALSE)
plot_summs(m4,m6, scale = FALSE,legend.title = "") + theme_tufte()
ggsave(paste0(main_directory,"R - Processing data/output/Graphs/countynhg_1910/reg_industry_1940.jpeg"),plot=last_plot())


# Occupation variables
(occvar <- grep("^sh_occ1950_main_[^0]",names(census_sample_1940_agg_countynhg_1910),value=TRUE))

form <- as.formula(paste("sh_red_tit ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab +",paste0(occvar,collapse=" + ")))
form1 <- as.formula(paste("sh_red_tit ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab + statefip +",paste0(occvar,collapse=" + ")))

m7 <- lm(form,data=census_sample_1940_agg_countynhg_1910)
m8 <- lm(form1, data=census_sample_1940_agg_countynhg_1910)
m9 <- plm(form1, 
                    data = census_sample_1940_agg_countynhg_1910,
                    index = c("statefip"), 
                    model = "within")

tab_model(m7,m8,m9,show.ci=FALSE,show.se=TRUE,use.viewer=FALSE)
plot_summs(m7,m9, scale = FALSE,legend.title = "") + theme_tufte()
ggsave(paste0(main_directory,"R - Processing data/output/Graphs/countynhg_1910/reg_occupation_1940.jpeg"),plot=last_plot())


# Industry and occupation variables
form <- as.formula(paste("sh_red_tit ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab +",paste0(indvar,collapse=" + ")," + ",paste0(occvar,collapse=" + ")))
form1 <- as.formula(paste("sh_red_tit ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab + statefip +",paste0(indvar,collapse=" + ")," + ",paste0(occvar,collapse=" + ")))

m10 <- lm(form,data=census_sample_1940_agg_countynhg_1910)
m11 <- lm(form1, data=census_sample_1940_agg_countynhg_1910)
m12 <- plm(form1, 
                    data = census_sample_1940_agg_countynhg_1910,
                    index = c("statefip"), 
                    model = "within")

tab_model(m10,m11,m12,show.ci=FALSE,show.se=TRUE,use.viewer=FALSE)
plot_summs(m10,m12, scale = FALSE,legend.title = "") + theme_tufte()
ggsave(paste0(main_directory,"R - Processing data/output/Graphs/countynhg_1910/reg_industry_occupation_1940.jpeg"),plot=last_plot())



plot_summs(m1,m4,m7,m10, scale = FALSE,legend.title = "") + theme_tufte()
ggsave(paste0(main_directory,"R - Processing data/output/Graphs/countynhg_1910/reg_all_no_statefip_1940.jpeg"),plot=last_plot())

plot_summs(m3,m6,m9,m12, scale = FALSE,legend.title = "") + theme_tufte()
ggsave(paste0(main_directory,"R - Processing data/output/Graphs/countynhg_1910/reg_all_statefip_1940.jpeg"),plot=last_plot())


rm(list=paste0("m",1:12))
rm(form,form1)
```
Notes:
-"scale=TRUE" standardizes the beta coefficients. This helps to display all the coefficients in the graph

## 2. Metarea_1940

### Histogram and correlation grpahs
```{r}
census_sample_1940_agg_metarea_1940 <- read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1940_agg_metarea_1940.fst"),as.data.table=TRUE)[,MSA:=factor(ifelse(metarea_1940<1000,1,0), levels = c(0,1),labels = c("Non MSAs","MSAs"))]

f_graph_regional(census_sample_1940_agg_metarea_1940,1940,"metarea_1940",c("sh_new_method1_dataset1","sh_new_method1_dataset2","sh_new_method1_dataset3"))

```

### Basic regressions
```{r}
# Basic
m1 <- lm(sh_red_tit ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab, data=census_sample_1940_agg_metarea_1940)
m2 <- lm(sh_red_tit ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab, data=census_sample_1940_agg_metarea_1940[MSA=="Non MSAs"])
m3 <- lm(sh_red_tit ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab, data=census_sample_1940_agg_metarea_1940[MSA=="MSAs"])

tab_model(m1,m2,m3,show.ci=FALSE,show.se=TRUE,use.viewer=FALSE)
plot_summs(m1,m2,m3, scale = TRUE) + theme_tufte()
ggsave(paste0(main_directory,"R - Processing data/output/Graphs/metarea_1940/reg_basic_1940.jpeg"),plot=last_plot())

# Industry variables
(indvar <- grep("^sh_ind1950_main_[^1]",names(census_sample_1940_agg_metarea_1940),value=TRUE))
#form <- reformulate(c("perwt","sh_race_1","sh_race_2","sh_lit","sh_urban","sh_farm","sh_mig_us","sh_mig_ab",indvar),response="sh_red_tit")

form <- as.formula(paste("sh_red_tit ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab +",paste0(indvar,collapse=" + ")))

m4 <- lm(form,data=census_sample_1940_agg_metarea_1940)
m5 <- lm(form, data=census_sample_1940_agg_metarea_1940[MSA=="Non MSAs"])
m6 <- lm(form, data=census_sample_1940_agg_metarea_1940[MSA=="MSAs"])

tab_model(m4,m5,m6,show.ci=FALSE,show.se=TRUE,use.viewer=FALSE)
plot_summs(m4, m5,m6, scale = FALSE) + theme_tufte()
ggsave(paste0(main_directory,"R - Processing data/output/Graphs/metarea_1940/reg_industry_1940.jpeg"),plot=last_plot())


# Occupation variables
(occvar <- grep("^sh_occ1950_main_[^0]",names(census_sample_1940_agg_metarea_1940),value=TRUE))

form <- as.formula(paste("sh_red_tit ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab +",paste0(occvar,collapse=" + ")))

m7 <- lm(form,data=census_sample_1940_agg_metarea_1940)
m8 <- lm(form, data=census_sample_1940_agg_metarea_1940[MSA=="Non MSAs"])
m9 <- lm(form, data=census_sample_1940_agg_metarea_1940[MSA=="MSAs"])

tab_model(m7,m8,m9,show.ci=FALSE,show.se=TRUE,use.viewer=FALSE)
plot_summs(m7, m8,m9, scale = FALSE) + theme_tufte()
ggsave(paste0(main_directory,"R - Processing data/output/Graphs/metarea_1940/reg_occupation_1940.jpeg"),plot=last_plot())


# Industry + Occupation variables
form <- as.formula(paste("sh_red_tit ~ log(perwt) + sh_race_1 + sh_race_2 + sh_lit + sh_urban + sh_farm + sh_mig_us + sh_mig_ab +",paste0(occvar,collapse=" + ")," + ",paste0(indvar,collapse=" + ")))

m10 <- lm(form,data=census_sample_1940_agg_metarea_1940)
m11 <- lm(form, data=census_sample_1940_agg_metarea_1940[MSA=="Non MSAs"])
m12 <- lm(form, data=census_sample_1940_agg_metarea_1940[MSA=="MSAs"])

tab_model(m10,m11,m12,show.ci=FALSE,show.se=TRUE,use.viewer=FALSE)
plot_summs(m10,m12, scale = FALSE,legend.title = "") + theme_tufte()
ggsave(paste0(main_directory,"R - Processing data/output/Graphs/metarea_1940/reg_industry_occupation_1940.jpeg"),plot=last_plot())



plot_summs(m1,m4,m7,m10, scale = FALSE,legend.title = "") + theme_tufte()
ggsave(paste0(main_directory,"R - Processing data/output/Graphs/metarea_1940/reg_all_1940.jpeg"),plot=last_plot())

plot_summs(m2,m5,m8,m11, scale = FALSE,legend.title = "") + theme_tufte()
ggsave(paste0(main_directory,"R - Processing data/output/Graphs/metarea_1940/reg_all_non_MSAs_1940.jpeg"),plot=last_plot())

plot_summs(m3,m6,m9,m12, scale = FALSE,legend.title = "") + theme_tufte()
ggsave(paste0(main_directory,"R - Processing data/output/Graphs/metarea_1940/reg_all_MSAs_1940.jpeg"),plot=last_plot())

rm(list=paste0("m",1:12))
```


# Part 2. Data Analysis focused on the new titles
Here we look more in depth at the share of "new titles" in different industries and occupations 
## Loading packages and erasing the workspace (make sure to have loaded f_load_pk)
```{r}
rm(list = setdiff(ls(),c(lsf.str(),"main_directory") ))
f_load_pk()
```

## 1. Industries/Occupations and new titles
### 1.2. Creating sample of interest
#### New titles
```{r}
new_titles_1940.by_occ_subind <- read_fst(paste0(main_directory,"R - Processing data/output/Rdata/new_titles_1940_by_occ_subind.fst"),as.data.table=TRUE)[set=="within"][,set:=NULL]
```

#### Census sample
```{r}
census_sample_1940_ind_occ_table <- read_fst(paste0(main_directory,"R - Processing data/input/census_sample/census_sample_1940.fst"),as.data.table=TRUE,columns=c("perwt","occ1950","occ","occ1940","ind","ind1950","name_ind1940_subgroup"))[!is.na(occ1940) & (ind1950 >=1 & ind1950<=990)]

# Aggregate at the "occ1950","occ1940","ind","ind1950" level
census_sample_1940_ind_occ_table <-
  merge(
    census_sample_1940_ind_occ_table,
    new_titles_1940.by_occ_subind[,!c("N_dataset1","N_red_inv_dataset1","N_red1_inv_dataset1","N_dataset2","N_red_inv_dataset2","N_red1_inv_dataset2","N_dataset3","N_red_inv_dataset3","N_red1_inv_dataset3")],
    by=c("occ1940","name_ind1940_subgroup"),all=FALSE
    )[,perwt_sum:=sum(perwt),by=c("occ1950","occ1940","ind","ind1950")][,lapply(.SD,weighted.mean,w=perwt),by=c("occ1950","occ1940","ind","ind1950"),.SDcols=c("perwt_sum","sh_new_all_dataset1","sh_new_all_dataset2","sh_new_all_dataset3","sh_new_method1_dataset1","sh_new_method1_dataset2","sh_new_method1_dataset3","sh_new_method2_dataset1","sh_new_method2_dataset2","sh_new_method2_dataset3")]
setnames(census_sample_1940_ind_occ_table,"perwt_sum","perwt")
```

### 1.3 Creating tables of interest

### Calling names of industries and occupations
```{r}
ind1950.codes <- as.data.table( read_excel(paste0(main_directory,"R - Processing data/input/1930 - Cleaned.xlsx"), sheet = "ind1950",guess_max=10000) )

occ1940.codes <- as.data.table( read_excel(paste0(main_directory,"R - Processing data/input/1940 - Cleaned.xlsx"), sheet = "occ1940",guess_max=10000) )[,`:=`(occ1940_IPUMS=as.numeric(occ1940_IPUMS),occ1940=tolower(occ1940))][,!c("ind1940_IPUMS","ind1940","occind1940")][,.SD[1],by="occ1940"]

occ1950.codes <- as.data.table( read_excel(paste0(main_directory,"R - Processing data/input/1930 - Cleaned.xlsx"), sheet = "occ1950",guess_max=10000) )
```

#### Creating and exporting tables
```{r}
for (i in c("sh_new_method1_dataset1","sh_new_method1_dataset2","sh_new_method1_dataset3")) {
  setnames(census_sample_1940_ind_occ_table, i, c("new")) 
  
  table_ind <-
    f_ind_new_titles(census_sample_1940_ind_occ_table,id_N=5,var=ind1950,sh_v=new,cols_v=occ1940,names=ind1950.codes[,c("ind1950","ind1950_name")])  
  table_occ <- 
    f_ind_new_titles(census_sample_1940_ind_occ_table,id_N=5,var=occ1940,sh_v=new,cols_v=ind1950,names=occ1940.codes[,c("occ1940","name_occ1940")][,`:=`(occ1940_name=name_occ1940,name_occ1940=NULL)])
  
  write.xlsx(table_ind,paste0(main_directory,"R - Processing data/output/Tables/1940/Table_",i,"_by_ind1950.xlsx"),row.names = TRUE)
  write.xlsx(table_occ,paste0(main_directory,"R - Processing data/output/Tables/1940/Table_",i,"_by_occ1940.xlsx"),row.names = TRUE)
  
  setnames(census_sample_1940_ind_occ_table,c("new"),i) 
  rm(table_ind,table_occ)
}
  
```


## 2. Locations and new titles
### 2.2. Preparing the data
#### Data at the county level (county 1910)
We can simply use the aggregated county level data created in Part 1.
```{r}
new_title_1940_location.countynhg_1910_more1000 <- read_fst(here(paste0("output/Rdata/census_sample_1940_agg_countynhg_1910.fst")),as.data.table=TRUE,columns=c("countynhg_1910","perwt","sh_new_method1_dataset1","sh_new_method1_dataset2","sh_new_method1_dataset3"))[perwt>=1000 & !is.na(countynhg_1910)]

new_title_1940_location.countynhg_1910_more10000 <- read_fst(here(paste0("output/Rdata/census_sample_1940_agg_countynhg_1910.fst")),as.data.table=TRUE,columns=c("countynhg_1910","perwt","sh_new_method1_dataset1","sh_new_method1_dataset2","sh_new_method1_dataset3"))[perwt>=10000 & !is.na(countynhg_1910)]

```

#### Data at the metarea level
For the mapping we aggregate MSAs and those non-dentified MSAs we aggregate by state.
We use a dataset previously created that contains the share of new titles by occind, countynhg, countynhg_1910, metarea_1940. 
** We could use the data aggregated at the MSA level once we know how to combine counties in the map function
```{r}
new_titles_agg <- read_fst(here(paste0("output/Rdata/new_titles_agg_1940.fst")),as.data.table=TRUE)

new_title_location.metarea_1940 <- new_titles_agg[!is.na(metarea_1940) & !is.na(countynhg_1910),!c("occ1940","name_ind1940_subgroup")][,perwt_sum:=sum(perwt),by=c("countynhg_1910","metarea_1940")][,lapply(.SD,weighted.mean,w=perwt),by=c("countynhg_1910","metarea_1940"),.SDcols=c("perwt_sum","sh_new_all_dataset1","sh_new_all_dataset2","sh_new_all_dataset3","sh_new_method1_dataset1","sh_new_method1_dataset2","sh_new_method1_dataset3","sh_new_method2_dataset1","sh_new_method2_dataset2","sh_new_method2_dataset3")]

# If a county is repeated ( e.g. because one part belongs to an MSA and another to another), keep the county with the largest population
setorderv(new_title_location.metarea_1940,c("countynhg_1910","perwt_sum"),c(1,-1))
new_title_location.metarea_1940 <- new_title_location.metarea_1940[,.SD[1],by=c("countynhg_1910"),.SDcols=c("metarea_1940","perwt_sum","sh_new_all_dataset1","sh_new_all_dataset2","sh_new_all_dataset3","sh_new_method1_dataset1","sh_new_method1_dataset2","sh_new_method1_dataset3","sh_new_method2_dataset1","sh_new_method2_dataset2","sh_new_method2_dataset3")]

# Counties within the same MSA have the same value for the variables
new_title_location.metarea_1940 <- new_title_location.metarea_1940[,perwt:=sum(perwt_sum),by=c("metarea_1940")][,c("perwt","sh_base","sh_base_tit","sh_base_titind","sh_red","sh_red_tit","sh_red_titind"):=lapply(.SD,weighted.mean,w=perwt_sum),by=c("metarea_1940"),.SDcols=c("perwt_sum","sh_new_all_dataset1","sh_new_all_dataset2","sh_new_all_dataset3","sh_new_method1_dataset1","sh_new_method1_dataset2","sh_new_method1_dataset3","sh_new_method2_dataset1","sh_new_method2_dataset2","sh_new_method2_dataset3")]

```


### 2.3. Mapping
#### 2.3.1. Import and subset shape files
```{r}
# Importing shp file 
# 1 Option
map.cty <- st_read(here(paste0("input/shapefiles/shapefile_us_county_1910")), quiet = TRUE)


map.state <- st_read(here(paste0("input/shapefiles/shapefile_us_state_1910")), quiet = TRUE)

if (FALSE) {
# 2 option
map.cty <- read_sf(dsn=here(paste0("input/shapefiles/shapefile_us_county_1910")))

# 3 option
# NOTE requires the data_file
map.state <- read_nhgis_sf(
  data_file = here(paste0("input/shapefiles/nhgis0006_csv")),
  shape_file = here(paste0("input/shapefiles/nhgis0006_shape.zip"))
)
}
#subsetting it and dropping Alaska and Hawaii
map.cty <- subset(map.cty,select=c(GISJOIN2,STATENAM,geometry))
map.cty <- subset(map.cty, STATENAM !="Alaska Territory" & STATENAM != "Hawaii Territory")
map.cty$GISJOIN2 <- as.numeric(map.cty$GISJOIN2)
map.state <- subset(map.state,select=c(GISJOIN2,STATENAM,geometry))
map.state <- subset(map.state, STATENAM !="Alaska Territory" & STATENAM != "Hawaii Territory")

```


#### 2.3.2. Join with info for population and share of new work

##### countynhg_1910
```{r}
setnames(new_title_1940_location.countynhg_1910_more10000,c("countynhg_1910"),c("GISJOIN2"))
setnames(new_title_1940_location.countynhg_1910_more1000,c("countynhg_1910"),c("GISJOIN2"))

for (i in c("sh_new_method1_dataset2","sh_new_method1_dataset3")) {
  map.countynhg_1910_more10000 <- merge(map.cty,new_title_1940_location.countynhg_1910_more10000,by="GISJOIN2",all.x=TRUE,all.y=FALSE)

  png(here(paste0("output/Maps/1940/",i,"_countynhg_1910_more10000.png")),900,900*2/3)  
    tm_shape(map.countynhg_1910_more10000) + tm_fill(i,title="Share of New Work",palette="viridis",n=7,style="quantile",colorNA=NULL) +
    tm_shape(map.state) + tm_borders(alpha=0.1,lwd=0.5)
  dev.off() 
  
  map.countynhg_1910_more1000 <- merge(map.cty,new_title_1940_location.countynhg_1910_more1000,by="GISJOIN2",all.x=TRUE,all.y=FALSE)
  png(here(paste0("output/Maps/1940/",i,"_countynhg_1910_more1000.png")),900,900*2/3)  
    tm_shape(map.countynhg_1910_more1000) + tm_fill(i,title="Share of New Work",palette="viridis",n=7,style="quantile",colorNA=NULL) +
    tm_shape(map.state) + tm_borders(alpha=0.1,lwd=0.5)
  dev.off()
  
  rm(map.countynhg_1910_more10000,map.countynhg_1910_more1000)
}
map.countynhg_1910_more10000 <- merge(map.cty,new_title_1940_location.countynhg_1910_more10000,by="GISJOIN2",all.x=TRUE,all.y=FALSE)
png(here(paste0("output/Maps/1940/sh_new_method1_dataset2_countynhg_1910_more10000.png")),900,900*2/3)
    tm_shape(map.countynhg_1910_more10000) + tm_fill("sh_new_method1_dataset2",title="Share of New Work",palette="viridis",n=7,style="quantile",colorNA=NULL) +
    tm_shape(map.state) + tm_borders(alpha=0.1,lwd=0.5)
dev.off() 

png(here(paste0("output/Maps/1940/sh_new_method1_dataset3_countynhg_1910_more10000.png")),900,900*2/3)
    tm_shape(map.countynhg_1910_more10000) + tm_fill("sh_new_method1_dataset3",title="Share of New Work",palette="viridis",n=7,style="quantile",colorNA=NULL) +
    tm_shape(map.state) + tm_borders(alpha=0.1,lwd=0.5)
dev.off() 

map.countynhg_1910_more1000 <- merge(map.cty,new_title_1940_location.countynhg_1910_more1000,by="GISJOIN2",all.x=TRUE,all.y=FALSE)
png(here(paste0("output/Maps/1940/sh_new_method1_dataset2_countynhg_1910_more1000.png")),900,900*2/3)
    tm_shape(map.countynhg_1910_more1000) + tm_fill("sh_new_method1_dataset2",title="Share of New Work",palette="viridis",n=7,style="quantile",colorNA=NULL) +
    tm_shape(map.state) + tm_borders(alpha=0.1,lwd=0.5)
dev.off() 

png(here(paste0("output/Maps/1940/sh_new_method1_dataset3_countynhg_1910_more1000.png")),900,900*2/3)
    tm_shape(map.countynhg_1910_more1000) + tm_fill("sh_new_method1_dataset3",title="Share of New Work",palette="viridis",n=7,style="quantile",colorNA=NULL) +
    tm_shape(map.state) + tm_borders(alpha=0.1,lwd=0.5)
dev.off() 

```

##### metarea_1940
```{r}
setnames(new_title_location.metarea_1940,c("countynhg_1910"),c("GISJOIN2"))

for (i in c("sh_new_method1_dataset1","sh_new_method1_dataset2","sh_new_method1_dataset3")) {
  map.metarea <- merge(map.cty,new_title_location.metarea_1940,by="GISJOIN2",all.x=TRUE,all.y=FALSE)
  metarea <- tm_shape(subset(map.metarea)) + tm_polygons(i,style = "pretty", n=10,lwd=0) +
    tm_shape(map.state) + tm_borders(alpha=0.1,lwd=0.5)
  tmap_save(metarea, paste0(main_directory,"R - Processing data/output/Maps/1940/",i,"_metarea_1940.jpeg"))
  rm(metarea,map.metarea)
}
```

##  3. Different information related with new sectors
### Loading packages and erasing the workspace (make sure to have loaded f_load_pk)
```{r}
rm(list = setdiff(ls(),c(lsf.str(),"main_directory") ))
f_load_pk()
```
### 3.1. Preparing the data

- Keep a variable for population and another for workers?? ---> In the individual_data we don't have info about whole population!!!! Where to get it
- What workers to keep? 
  - Employed people: (empstat==1 or classwkr==1 | classwkr==2) Empstat is not available for 1920. In some cases people that say the are unemployed appear as working for wages or self-employed.
  - Working age: age in (16,64)
  - Valid industry and occupation (occ1950_main!=979 & ind1950_main!=0)
```{r Data Preparation}
# Importing data and Simplifying
census_sample_1920_individual_data <- 
  read_fst(here(paste0("output/Rdata/census_sample_1920_individual_data.fst")),as.data.table=TRUE,columns=c("countynhg_1910","statefip","perwt_ID","ind1950","ind1950_main","occ","occ1950","occ1950_main","classwkr","age"))[occ1950_main!=979 & ind1950_main!=0 & (classwkr==1 | classwkr==2) & (age>=16 & age <=64)][,.(perwt=sum(perwt_ID)),by=c("countynhg_1910","statefip","ind1950","ind1950_main","occ","occ1950","occ1950_main")]

census_sample_1930_individual_data <- 
  read_fst(here(paste0("output/Rdata/census_sample_1930_individual_data.fst")),as.data.table=TRUE,columns=c("countynhg_1910","statefip","perwt_ID","ind1950","ind1950_main","occind","occ1950","occ1950_main","sh_red_tit","empstat","classwkr","age"))[occ1950_main!=979 & ind1950_main!=0 & (empstat==1 |classwkr==1 | classwkr==2) & (age>=16 & age <=64)][,.(perwt=sum(perwt_ID)),by=c("countynhg_1910","statefip","ind1950","ind1950_main","occind","occ1950","occ1950_main","sh_red_tit")]

census_sample_1940_individual_data <- read_fst(here(paste0("output/Rdata/census_sample_1940_individual_data.fst")),as.data.table=TRUE,columns=c("countynhg_1910","statefip","perwt_ID","ind1950","ind1950_main","occ1940","occ1950","occ1950_main","sh_new_method1_dataset1","sh_new_method1_dataset2","sh_new_method2_dataset3","empstat","classwkr","age"))[occ1950_main!=979 & ind1950_main!=0 & (empstat==1 | classwkr==1 | classwkr==2) & (age>=16 & age <=64)][,.(perwt=sum(perwt_ID)),by=c("countynhg_1910","statefip","ind1950","ind1950_main","occ1940","occ1950","occ1950_main","sh_new_method1_dataset1","sh_new_method1_dataset2","sh_new_method2_dataset3")]

```

### 3.2. Descriptive statistics
- Dispersion measures: how disperse a new sector is across the Nation. We use the HHI index (***we slightly changed the function f_HHI***). This should be compared against other sectors??

```{r}
A <- copy(census_sample_1920_individual_data)

# Computing some Variables (working population, number of different counties, states, occupations)

temp <- A[,`:=`(
                perwt_ind1950_main=sum(perwt),
                N_countynhg_1910_ind1950_main=length(unique(countynhg_1910)),
                N_statefip_ind1950_main=length(unique(statefip)),
                N_occ_ind1950_main=length(unique(occ)),
                N_occ1950_ind1950_main=length(unique(occ1950))
               ),by=c("ind1950_main")
          ]
temp <- temp[,`:=`(
                perwt_nat=sum(perwt),
                N_countynhg_1910_nat=length(unique(A$countynhg_1910)),
                N_statefip_nat=length(unique(A$statefip)),
                N_occ_nat=length(unique(A$occ)),
                N_occ1950_nat=length(unique(A$occ1950))
               )
          ][,perwt_ind1950_main:=sum(perwt),by=c("ind1950_main")]
temp <- temp[ind1950 %in% c(376,377,466,556,606,667,668,816,856)][,`:=`(
                perwt=sum(perwt),
                N_countynhg_1910=length(unique(countynhg_1910)),
                N_statefip=length(unique(statefip)),
                N_occ=length(unique(occ)),
                N_occ1950=length(unique(occ1950))
               ),by="ind1950"]
temp <- temp[,.SD[1],by="ind1950",.SDcols=names(temp[,!c("ind1950","countynhg_1910","occ","occ1950","occ1950_main","statefip")])]

# HHI
temp <- 
  merge(
    temp,
    data.table(
       ind1950=c(376,377,556,606,667,668,816),
       HHI=unlist(lapply(list(A[ind1950==376],A[ind1950==377],A[ind1950==556],A[ind1950==606],A[ind1950==667],A[ind1950==668],A[ind1950==816]),f_HHI,weight=perwt,arg_ind=countynhg_1910))
    ), by="ind1950"
)
    
# Creating the share variables
f_division <- function(Y,a,b,names) {
  if (!(length(a)==length(b) & length(b)==length(names))) stop("Vectors a, b and names have to have the same length")
  #Y <- copy(X)
  for (i in 1:length(a)) {
    setnames(Y,c(a[i],b[i]),c("var1","var2"))
    #Y <- Y[,c:=var1/var2]
    Y[,c:=var1/var2]
    setnames(Y,c("c"),c(names[i]))
    setnames(Y,c("var1","var2"),c(a[i],b[i]))
  }
  return(Y)
}

temp <- f_division(temp,c("perwt","N_countynhg_1910","N_statefip","N_occ","N_occ1950","perwt","N_countynhg_1910","N_statefip","N_occ","N_occ1950"),c(paste0(c("perwt","N_countynhg_1910","N_statefip","N_occ","N_occ1950"),"_nat"),paste0(c("perwt","N_countynhg_1910","N_statefip","N_occ","N_occ1950"),"_ind1950_main")),c(paste0("sh_",c("perwt","N_countynhg_1910","N_statefip","N_occ","N_occ1950")),paste0("sh_ind1950_main_",c("perwt","N_countynhg_1910","N_statefip","N_occ","N_occ1950"))))




# Distribution of share of employment of a sector
## Creating distribution variables
temp_dis <- A[,c("ind1950","perwt","countynhg_1910")][,perwt_cty:=sum(perwt),by="countynhg_1910"][ind1950 %in% c(376,377,466,556,606,667,668,816,856)][,.(perwt=sum(perwt),perwt_cty=mean(perwt_cty)),by=c("countynhg_1910","ind1950")][,sh_perwt:=perwt/perwt_cty]

temp_dis <- as.data.table(lapply(list(temp_dis[ind1950==376],temp_dis[ind1950==377],temp_dis[ind1950==556],temp_dis[ind1950==606],temp_dis[ind1950==667],temp_dis[ind1950==668],temp_dis[ind1950==816]),function(x) quantile(x$sh_perwt)))[,percentile:=c("p0","p25","p50","p75","p100")]
setnames(temp_dis,c(paste0("V",1:7)),c("376","377","556","606","667","668","816"))
temp_dis <- as.data.table(dcast(melt(temp_dis, id.vars = "percentile"), variable ~ percentile))
temp_dis <- temp_dis[,ind1950:=as.numeric(as.character(variable))][,!c("variable")]
setcolorder(temp_dis,c("ind1950","p0","p25","p50","p75","p100"))

## Merging
temp <- merge(temp,temp_dis,by="ind1950")

```


# Part 2.a Data Analysis for New Titles
## 1. Importing 
```{r Importing}
# County datasets ----
census_sample_1930_countynhg_1910_data <-
  read_fst(here(paste0("output/Rdata/census_sample_1930_agg_countynhg_1910.fst")),as.data.table=TRUE,columns=c("countynhg_1910","perwt","sh_base","sh_base_tit","sh_base_titind","sh_red","sh_red_tit","sh_red_titind"))[!is.na(countynhg_1910)]
census_sample_1940_countynhg_1910_data <-
  read_fst(here(paste0("output/Rdata/census_sample_1940_agg_countynhg_1910.fst")),as.data.table=TRUE,columns=c("countynhg_1910","perwt","sh_new_method1_dataset1","sh_new_method1_dataset2","sh_new_method1_dataset3"))[!is.na(countynhg_1910)]

# Individual level datasets ----
census_sample_1930_individual_data <- 
  merge(
    read_fst(here(paste0("output/Rdata/census_sample_1930_individual_data.fst")),as.data.table=TRUE,columns=c("perwt_ID","countynhg_1910","occind","sh_red_tit","ind1950")),
    census_sample_1930_countynhg_1910_data[,c("countynhg_1910","perwt")],
    by=c("countynhg_1910"),all.x=TRUE,all.y=FALSE
  )
census_sample_1940_individual_data <-
  merge(
    read_fst(here(paste0("output/Rdata/census_sample_1940_individual_data.fst")),as.data.table=TRUE,columns=c("perwt_ID","countynhg_1910","occ1940","name_ind1940_subgroup","ind1950","sh_new_method1_dataset1","sh_new_method1_dataset2","sh_new_method1_dataset3")),
    census_sample_1940_countynhg_1910_data[,c("countynhg_1910","perwt")],
    by=c("countynhg_1910"),all.x=TRUE,all.y=FALSE
  )


# New titles ----
# Note: new_titles_1930_by_occind.fst was constructed by looking at similar titles within industry.
new_titles.occind1930 <- 
  merge(
    read_fst(here(paste0("output/Rdata/new_titles_1930_by_occind.fst")),as.data.table=TRUE),
    as.data.table( read_excel(here(paste0("input/1930 - Cleaned.xlsx")), sheet = "1930 main groups",guess_max=10000) )[,c("occind","occind1930","occind1930_name")],
    by="occind1930",all.x=TRUE,all.y=FALSE
  )[,occind1930:=NULL]
setcolorder(new_titles.occind1930,c("occind","occind1930_name"))


new_titles_1940.by_occ_subind <- read_fst(paste0(main_directory,"R - Processing data/output/Rdata/new_titles_1940_by_occ_subind.fst"),as.data.table=TRUE)[set=="within"][,set:=NULL]

# Note: Create an identifier for occs that have different sh_new_method1_dataset2 within occ1940.
# Note: Within occ1940 I want to focus on subindustries that have different occ1940
new_titles_1940.by_occ_subind <- 
  merge(
    new_titles_1940.by_occ_subind,
    new_titles_1940.by_occ_subind[,.(occ1940_subocc_method1_dataset2=name_ind1940_subgroup[1]),by=c("occ1940","sh_new_method1_dataset2")][order(occ1940,sh_new_method1_dataset2)][,occ1940_subocc_method1_dataset2:=1:.N,by=c("occ1940")],
    by=c("occ1940","sh_new_method1_dataset2"),all=TRUE
  )


# Names ----
occ1930.codes <- as.data.table( read_excel(here(paste0("input/1930 - Cleaned.xlsx")), sheet = "1930 main groups",guess_max=10000) )[,c("occind","occind1930","occind1930_name")]
occ1940.codes <- as.data.table( read_excel(here(paste0("input/1940 - Cleaned.xlsx")), sheet = "occ1940",guess_max=10000) )[,c("occ1940","name_occ1940_unique")][,occ1940:=tolower(occ1940)][,.SD[1],by="occ1940"]

```


## 2. Descriptive statistics
```{r}
#
census_sample_1930_grouped_occ <- census_sample_1930_individual_data[perwt>=10000][,.(perwt=sum(perwt_ID)),by=c("occind","sh_red_tit")]
census_sample_1940_grouped_occ_dt2 <- census_sample_1940_individual_data[perwt>=10000][,.(perwt=sum(perwt_ID)),by=c("occ1940","sh_new_method1_dataset2")][!is.na(sh_new_method1_dataset2)]
census_sample_1940_grouped_occ_dt3 <- census_sample_1940_individual_data[perwt>=10000][,.(perwt=sum(perwt_ID)),by=c("occ1940","sh_new_method1_dataset3")][!is.na(sh_new_method1_dataset3)]


Table_new_titles <- data.table(
  Variable=c("Number of Occ-Ind","Mean of New Work","St. Dev. New Work","Percentile 0","Percentile 25","Percentile 50","Percentile 75","Percentile 100"),
  '1930'=c(
                  nrow(census_sample_1930_grouped_occ),
                  format(round(mean(census_sample_1930_grouped_occ$sh_red_tit),2),nsmall=2),
                  format(round(sd(census_sample_1930_grouped_occ$sh_red_tit),2),nsmall=2),
                  format(round(unname(quantile(census_sample_1930_grouped_occ$sh_red_tit)),2),nsmall=2)
  ),
  '1940 - Dt2'=c(
                  nrow(census_sample_1940_grouped_occ_dt2),
                  format(round(mean(census_sample_1940_grouped_occ_dt2$sh_new_method1_dataset2,na.rm=TRUE),2),nsmall=2),
                  format(round(sd(census_sample_1940_grouped_occ_dt2$sh_new_method1_dataset2,na.rm=TRUE),2),nsmall=2),
                  format(round(unname(quantile(census_sample_1940_grouped_occ_dt2$sh_new_method1_dataset2,na.rm=TRUE)),2),nsmall=2)
  ),
  '1940 - Dt3'=c(
                  nrow(census_sample_1940_grouped_occ_dt3),
                  format(round(mean(census_sample_1940_grouped_occ_dt3$sh_new_method1_dataset3),2),nsmall=2),
                  format(round(sd(census_sample_1940_grouped_occ_dt3$sh_new_method1_dataset3),2),nsmall=2),
                  format(round(unname(quantile(census_sample_1940_grouped_occ_dt3$sh_new_method1_dataset3,na.rm=TRUE)),2),nsmall=2)
  ),
                  
  '1930 People'=c(
                  nrow(census_sample_1930_grouped_occ),
                  round(weighted.mean(census_sample_1930_grouped_occ$sh_red_tit,census_sample_1930_grouped_occ$perwt,na.rm=TRUE),2),
                  round(sqrt(wtd.var(census_sample_1930_grouped_occ$sh_red_tit,census_sample_1930_grouped_occ$perwt,na.rm=TRUE)),2),
                  round(unname(wtd.quantile(census_sample_1930_grouped_occ$sh_red_tit,census_sample_1930_grouped_occ$perwt,na.rm=TRUE)),2)
  ),
  '1940 People - Dt2'=c(
                  nrow(census_sample_1940_grouped_occ_dt2),
                  round(weighted.mean(census_sample_1940_grouped_occ_dt2$sh_new_method1_dataset2,census_sample_1940_grouped_occ_dt2$perwt,na.rm=TRUE),2),
                  round(sqrt(wtd.var(census_sample_1940_grouped_occ_dt2$sh_new_method1_dataset2,census_sample_1940_grouped_occ_dt2$perwt,na.rm=TRUE)),2),
                  round(unname(wtd.quantile(census_sample_1940_grouped_occ_dt2$sh_new_method1_dataset2,census_sample_1940_grouped_occ_dt2$perwt,na.rm=TRUE)),2)
  ),
  '1940 People - Dt3'=c(
                  nrow(census_sample_1940_grouped_occ_dt3),
                  round(weighted.mean(census_sample_1940_grouped_occ_dt3$sh_new_method1_dataset3,census_sample_1940_grouped_occ_dt3$perwt,na.rm=TRUE),2),
                  round(sqrt(wtd.var(census_sample_1940_grouped_occ_dt3$sh_new_method1_dataset3,census_sample_1940_grouped_occ_dt3$perwt,na.rm=TRUE)),2),
                  round(unname(wtd.quantile(census_sample_1940_grouped_occ_dt3$sh_new_method1_dataset3,census_sample_1940_grouped_occ_dt3$perwt,na.rm=TRUE)),2)
  )
)

Table <- data.table(
  Variable=c("Number of People/Counties","Mean of New Work","St. Dev. New Work","Percentile 0","Percentile 25","Percentile 50","Percentile 75","Percentile 100"),
  '1930 - Individuals'=c(
                  nrow(census_sample_1930_individual_data[perwt>=10000]),
                  format(round(mean(census_sample_1930_individual_data[perwt>=10000]$sh_red_tit),4),nsmall=2),
                  format(round(sd(census_sample_1930_individual_data[perwt>=10000]$sh_red_tit),4),nsmall=2),
                  format(round(unname(quantile(census_sample_1930_individual_data[perwt>=10000]$sh_red_tit)),4),nsmall=2)
  ),
  '1930 - Counties'=c(
                  nrow(census_sample_1930_countynhg_1910_data[perwt>=10000]),
                  format(round(mean(census_sample_1930_countynhg_1910_data[perwt>=10000]$sh_red_tit),4),nsmall=2),
                  format(round(sd(census_sample_1930_countynhg_1910_data[perwt>=10000]$sh_red_tit),4),nsmall=2),
                  format(round(unname(quantile(census_sample_1930_countynhg_1910_data[perwt>=10000]$sh_red_tit)),4),nsmall=2)
  ),
  '1940 - Individuals - Dt2'=c(
                  nrow(census_sample_1940_individual_data[perwt>=10000]),
                  format(round(mean(census_sample_1940_individual_data[perwt>=10000]$sh_new_method1_dataset2,na.rm=TRUE),4),nsmall=2),
                  format(round(sd(census_sample_1940_individual_data[perwt>=10000]$sh_new_method1_dataset2,na.rm=TRUE),4),nsmall=2),
                  format(round(unname(quantile(census_sample_1940_individual_data[perwt>=10000]$sh_new_method1_dataset2,na.rm=TRUE)),4),nsmall=2)
  ),
  '1940 - Counties - Dt2'=c(
                  nrow(census_sample_1940_countynhg_1910_data[perwt>=10000]),
                  format(round(mean(census_sample_1940_countynhg_1910_data[perwt>=10000]$sh_new_method1_dataset3,na.rm=TRUE),4),nsmall=2),
                  format(round(sd(census_sample_1940_countynhg_1910_data[perwt>=10000]$sh_new_method1_dataset3,na.rm=TRUE),4),nsmall=2),
                  format(round(unname(quantile(census_sample_1940_countynhg_1910_data[perwt>=10000]$sh_new_method1_dataset3,na.rm=TRUE)),4),nsmall=2)
  ),
  '1940 - Individuals - Dt3'=c(
                  nrow(census_sample_1940_individual_data[perwt>=10000]),
                  format(round(mean(census_sample_1940_individual_data[perwt>=10000]$sh_new_method1_dataset3),4),nsmall=2),
                  format(round(sd(census_sample_1940_individual_data[perwt>=10000]$sh_new_method1_dataset3),4),nsmall=2),
                  format(round(unname(quantile(census_sample_1940_individual_data[perwt>=10000]$sh_new_method1_dataset3,na.rm=TRUE)),4),nsmall=2)
  ),
  '1940 - Counties - Dt3'=c(
                  nrow(census_sample_1940_countynhg_1910_data[perwt>=10000]),
                  format(round(mean(census_sample_1940_countynhg_1910_data[perwt>=10000]$sh_new_method1_dataset3),4),nsmall=2),
                  format(round(sd(census_sample_1940_countynhg_1910_data[perwt>=10000]$sh_new_method1_dataset3),4),nsmall=2),
                  format(round(unname(quantile(census_sample_1940_countynhg_1910_data[perwt>=10000]$sh_new_method1_dataset3,na.rm=TRUE)),4),nsmall=2)
  )
)
```
*** NOTE: *** For 1940, when working with individuals we observe that the number of occupations is smaller than when we look at the new titles file. This happens because there are no workers employed in many of the occupations-industry combinations.


## 3. Histograms
```{r}
# Individual plots ----
## Counties
g_1930_countynhg_1910 <-
  ggplot(census_sample_1930_countynhg_1910_data[perwt>=10000][,c("sh_red_tit")], aes(x=sh_red_tit)) +
        geom_histogram(color="black",bins=80,  aes(y = stat(width*density)),  fill="white") +
        geom_vline(data=census_sample_1930_countynhg_1910_data[,.(sh_red_tit=mean(sh_red_tit,na.rm=TRUE))],aes(xintercept=sh_red_tit),
                   linetype="dashed") + 
        scale_y_continuous(labels = percent_format()) +
        labs(title="",x="", y = "Share of people")  + 
        theme_tufte()

g_1940_countynhg_1910_dt2 <-
  ggplot(census_sample_1940_countynhg_1910_data[perwt>=10000][,c("sh_new_method1_dataset2")], aes(x=sh_new_method1_dataset2)) +
        geom_histogram(color="black",bins=80,  aes(y = stat(width*density)),  fill="white") +
        geom_vline(data=census_sample_1940_countynhg_1910_data[,.(sh_new_method1_dataset2=mean(sh_new_method1_dataset2,na.rm=TRUE))],aes(xintercept=sh_new_method1_dataset2),
                   linetype="dashed") + 
        scale_y_continuous(labels = percent_format()) +
        labs(title="",x="", y = "Share of people")  + 
        theme_tufte()

g_1940_countynhg_1910_dt3 <-
  ggplot(census_sample_1940_countynhg_1910_data[perwt>=10000][,c("sh_new_method1_dataset3")], aes(x=sh_new_method1_dataset3)) +
        geom_histogram(color="black",bins=80,  aes(y = stat(width*density)),  fill="white") +
        geom_vline(data=census_sample_1940_countynhg_1910_data[,.(sh_new_method1_dataset3=mean(sh_new_method1_dataset3,na.rm=TRUE))],aes(xintercept=sh_new_method1_dataset3),
                   linetype="dashed") + 
        scale_y_continuous(labels = percent_format()) +
        labs(title="",x="", y = "Share of people")  + 
        theme_tufte()

# Individuals
g_1930_individuals <-
  ggplot(census_sample_1930_individual_data[perwt>=10000][,c("sh_red_tit")], aes(x=sh_red_tit)) +
        geom_histogram(color="black",bins=80,  aes(y = stat(width*density)),  fill="white") +
        geom_vline(data=census_sample_1930_individual_data[,.(sh_red_tit=mean(sh_red_tit,na.rm=TRUE))],aes(xintercept=sh_red_tit),
                   linetype="dashed") + 
        scale_y_continuous(labels = percent_format()) +
        labs(title="",x="", y = "Share of people")  + 
        theme_tufte()

g_1940_individuals_dt2 <-
  ggplot(census_sample_1940_individual_data[perwt>=10000][,c("sh_new_method1_dataset2")], aes(x=sh_new_method1_dataset2)) +
        geom_histogram(color="black",bins=80,  aes(y = stat(width*density)),  fill="white") +
        geom_vline(data=census_sample_1940_individual_data[,.(sh_new_method1_dataset2=mean(sh_new_method1_dataset2,na.rm=TRUE))],aes(xintercept=sh_new_method1_dataset2),
                   linetype="dashed") + 
        scale_y_continuous(labels = percent_format()) +
        labs(title="",x="", y = "Share of people")  + 
        theme_tufte()

g_1940_individuals_dt3 <-
  ggplot(census_sample_1940_individual_data[perwt>=10000][,c("sh_new_method1_dataset3")], aes(x=sh_new_method1_dataset3)) +
        geom_histogram(color="black",bins=80,  aes(y = stat(width*density)),  fill="white") +
        geom_vline(data=census_sample_1940_individual_data[,.(sh_new_method1_dataset3=mean(sh_new_method1_dataset3,na.rm=TRUE))],aes(xintercept=sh_new_method1_dataset3),
                   linetype="dashed") + 
        scale_y_continuous(labels = percent_format()) +
        labs(title="",x="", y = "Share of people")  + 
        theme_tufte()

# Occupations
g_1930_occ <-
  ggplot(census_sample_1930_grouped_occ[,c("sh_red_tit")], aes(x=sh_red_tit)) +
          geom_histogram(color="black",bins=80,  aes(y = stat(width*density)),  fill="white") +
          geom_vline(data=census_sample_1930_grouped_occ[,.(sh_red_tit=mean(sh_red_tit,na.rm=TRUE))],aes(xintercept=sh_red_tit),
                     linetype="dashed") + 
          scale_y_continuous(labels = percent_format()) +
          labs(title="",x="", y = "Share of occupations")  + 
          theme_tufte()

g_1940_occ_dt2 <-
  ggplot(census_sample_1940_grouped_occ_dt2[,c("perwt","sh_new_method1_dataset2")], aes(x=sh_new_method1_dataset2)) +
          geom_histogram(color="black",bins=80,  aes(y = stat(width*density)),  fill="white") +
          geom_vline(data=census_sample_1940_grouped_occ_dt2[,.(sh_new_method1_dataset2=mean(sh_new_method1_dataset2,na.rm=TRUE))],aes(xintercept=sh_new_method1_dataset2),
                     linetype="dashed") + 
          scale_y_continuous(labels = percent_format()) +
          labs(title="",x="", y = "Share of occupations")  + 
          theme_tufte()

g_1940_occ_dt3 <-
  ggplot(census_sample_1940_grouped_occ_dt3[,c("perwt","sh_new_method1_dataset3")], aes(x=sh_new_method1_dataset3)) +
          geom_histogram(color="black",bins=80,  aes(y = stat(width*density)),  fill="white") +
          geom_vline(data=census_sample_1940_grouped_occ_dt3[,.(sh_new_method1_dataset3=mean(sh_new_method1_dataset3,na.rm=TRUE))],aes(xintercept=sh_new_method1_dataset3),
                     linetype="dashed") + 
          scale_y_continuous(labels = percent_format()) +
          labs(title="",x="", y = "Share of occupations")  + 
          theme_tufte()



x_min <- -0.05 +min(
             min(census_sample_1930_individual_data[perwt>=10000][,c("sh_red_tit")]$sh_red_tit),
             min(census_sample_1940_individual_data[perwt>=10000][,c("sh_new_method1_dataset2")]$sh_new_method1_dataset2)
           )
x_max <- max(
             max(census_sample_1930_individual_data[perwt>=10000][,c("sh_red_tit")]$sh_red_tit),
             max(census_sample_1940_individual_data[perwt>=10000][,c("sh_new_method1_dataset2")]$sh_new_method1_dataset2)
           )
## Graph
ggarrange(
  g_1930_individuals + scale_x_continuous(limits=c(x_min, x_max)),
  g_1940_individuals_dt2 + scale_x_continuous(limits=c(x_min, x_max)),
  g_1940_individuals_dt3 + scale_x_continuous(limits=c(x_min, x_max)),
  ncol = 1, nrow = 3,
  labels=c("   1930","1940 - Dt2","1940 - Dt3"
    )
)
ggsave(here(paste0("output/Graphs/histogram_new_titles.png")),plot=last_plot())


ggarrange(
  g_1930_individuals,
  g_1930_countynhg_1910,
  ncol = 1, nrow = 2,
  labels=c("Histograms (Individuals)","Histogram (counties)"),
  align = "v"
  )



ggarrange(
  g_1940_individuals_dt2,
  g_1940_countynhg_1910_dt2,
  ncol = 1, nrow = 2,
  labels=c("Histograms (Individuals)","Histogram (counties)"),
  align = "v"
  )

ggarrange(
  g_1930_occ,
  g_1940_occ_dt2,
  ncol = 1, nrow = 2,
  labels=c("   1930","1940 - Dt2"),
  align = "v"
  )


```


## 4. Intraquartile range for counties
```{r}
A_1930 <- census_sample_1930_individual_data[perwt>=10000][,.(perwt=sum(perwt_ID),sh_0=sum(perwt_ID*(sh_red_tit<=0.0001)),mean=mean(sh_red_tit,na.rm=TRUE),q25=quantile(sh_red_tit,na.rm=TRUE)[2],q75=quantile(sh_red_tit,na.rm=TRUE)[4],q80=quantile(sh_red_tit,probs=c(0.8),na.rm=TRUE),q90=quantile(sh_red_tit,probs=c(0.9),na.rm=TRUE),q95=quantile(sh_red_tit,probs=c(0.95),na.rm=TRUE),q99=quantile(sh_red_tit,probs=c(0.99),na.rm=TRUE)),by="countynhg_1910"][,sh_0:=sh_0/perwt]
A_1930 <- A_1930[order(mean,q75)][,order:=1:.N]

A_1940 <- census_sample_1940_individual_data[perwt>=10000 & !is.na(sh_new_method1_dataset2)][,.(perwt=sum(perwt_ID),sh_0=sum(perwt_ID*(sh_new_method1_dataset2<=0.0001)),mean=mean(sh_new_method1_dataset2,na.rm=TRUE),q25=quantile(sh_new_method1_dataset2,na.rm=TRUE)[2],q75=quantile(sh_new_method1_dataset2,na.rm=TRUE)[4],q80=quantile(sh_new_method1_dataset2,probs=c(0.8),na.rm=TRUE),q90=quantile(sh_new_method1_dataset2,probs=c(0.9),na.rm=TRUE),q95=quantile(sh_new_method1_dataset2,probs=c(0.95),na.rm=TRUE),q99=quantile(sh_new_method1_dataset2,probs=c(0.99),na.rm=TRUE)),by="countynhg_1910"][,sh_0:=sh_0/perwt]
A_1940 <- A_1940[order(mean,q75)][,order:=1:.N]


g_A_1930 <-
  ggplot(data=A_1930[order %in% floor(seq(1,2905,length=290))], aes(x=order)) +
    geom_line(aes(y=q75), color="blue") + geom_line(aes(y=q25), color="blue") +
    geom_line(aes(y=mean), color="red") + labs(title="",x="", y = "") +
      theme_tufte()

g_A_1940 <-
  ggplot(data=A_1940[order %in% floor(seq(1,2905,length=290))], aes(x=order)) +
    geom_line(aes(y=q75), color="blue") + geom_line(aes(y=q25), color="blue") +
    geom_line(aes(y=mean), color="red") + labs(title="",x="", y = "") +
      theme_tufte()

ggarrange(
  g_A_1930,
  g_A_1940,
  ncol = 1, nrow = 2,
  labels=c("1930","1940"),
  align = "v"
  )
ggsave(here(paste0("output/Graphs/figure_new_titles_interquantile_range.png")),plot=last_plot())

# percentiles
g_A_1930 <-
  ggplot(data=A_1930[order %in% floor(seq(1,2905,length=290))], aes(x=order)) +
      geom_line(aes(y=q95), color="black") + geom_line(aes(y=q99), color="yellow") +
      geom_line(aes(y=q80), color="gray") + geom_line(aes(y=q90), color="gray") + 
      geom_line(aes(y=q75), color="blue") + geom_line(aes(y=q25), color="blue") +
      geom_line(aes(y=mean), color="red") + labs(title="",x="", y = "") +
        theme_tufte()
g_A_1940 <-
  ggplot(data=A_1940[order %in% floor(seq(1,2905,length=290))], aes(x=order)) +
      geom_line(aes(y=q95), color="black") + geom_line(aes(y=q99), color="yellow") +
      geom_line(aes(y=q80), color="gray") + geom_line(aes(y=q90), color="gray") + 
      geom_line(aes(y=q75), color="blue") + geom_line(aes(y=q25), color="blue") +
      geom_line(aes(y=mean), color="red") + labs(title="",x="", y = "") +
        theme_tufte()

ggarrange(
  g_A_1930,
  g_A_1940,
  ncol = 1, nrow = 2,
  labels=c("1930","1940"),
  align = "v"
  )
ggsave(here(paste0("output/Graphs/figure_new_titles_percentiles.png")),plot=last_plot())

g_A_1930 <-
  ggplot(data=A_1930[order %in% floor(seq(1,2905,length=290))], aes(x=order)) +
      geom_line(aes(y=sh_0), color="black") + 
      geom_line(aes(y=q75), color="blue") + geom_line(aes(y=q25), color="blue") +
      geom_line(aes(y=mean), color="red") + labs(title="",x="", y = "") +
        theme_tufte()
g_A_1940 <-
  ggplot(data=A_1940[order %in% floor(seq(1,2905,length=290))], aes(x=order)) +
      geom_line(aes(y=sh_0), color="black") + 
      geom_line(aes(y=q75), color="blue") + geom_line(aes(y=q25), color="blue") +
      geom_line(aes(y=mean), color="red") + labs(title="",x="", y = "") +
        theme_tufte()

ggarrange(
  g_A_1930,
  g_A_1940,
  ncol = 1, nrow = 2,
  labels=c("1930","1940"),
  align = "v"
  )

```
As we can see in the previous graphs, for 1940 the distribution of the share of new occupations is very similar for most of the counties. The 80th percentile is basically the same for the first 2600 counties. Thus, the differences in mean are mostly explained by the upper 20% of the distribution. Because of the way the share of new occupations was constructed (using 3 digit occupations), we can't be sure that this behavior reflects the true distribution of new titles across the U.S. As an additional piece of information, I computed the share of the population that works in an occupation without any new titles. The last figure plots that share across counties. In 1930 the share of people with a 0 share of new titles is very low (around 8%) compared to 1940, where the average is is somewhere around 17%. 

## 5. New titles, number of titles, number of people.
In this section I will focus on the 3 digit occupation, the share of new titles, the number of titles. I want to have a better understanding of the difference between 1930 and 1940.
```{r}
# 1930 ----
Table_1930_occ <- 
  merge(
    census_sample_1930_individual_data[perwt>=10000 & !is.na(sh_red_tit)],
    new_titles.occind1930[,c("occind","occind1930_name","n_red_tit")],
    by=c("occind"),all.x=TRUE,all.y=FALSE
  )

# Next steps: computing different measures.
# Dispersion measures
## Across Industries
X_ind <- f_HHI(Table_1930_occ,occind,perwt_ID,ind1950)
setnames(X_ind,c("H"),c("H_ind1950"))

## Across space
X_spa <- f_HHI(Table_1930_occ,occind,perwt_ID,countynhg_1910)
setnames(X_spa,c("H"),c("H_countynhg_1910"))

# Main industries associated with a given occupation
table_ind <- 
    f_ind_new_titles(Table_1930_occ,id_N=5,var=occind,w_v=perwt_ID,sh_v=sh_red_tit,cols_v=ind1950)
col <- grep("^sh_ind1950|^emp|^sh_red_tit",names(table_ind),value=TRUE)
table_ind <- table_ind[,!..col]

table_countynhg_1910 <- 
    f_ind_new_titles(Table_1930_occ,id_N=5,var=occind,w_v=perwt_ID,sh_v=sh_red_tit,cols_v=countynhg_1910)
col <- grep("^sh_ind1950|^emp|^sh_red_tit",names(table_countynhg_1910),value=TRUE)
table_countynhg_1910 <- table_countynhg_1910[,!..col]

# Compiling the whole table
Table_1930_occ <- Table_1930_occ[,.(occind1930_name=occind1930_name[1],sh_red_tit=sh_red_tit[1],perwt=sum(perwt_ID),n_red_tit=n_red_tit[1]),by=c("occind")][,sh_perwt:=sum(perwt)][,`:=`(sh_perwt=perwt/sh_perwt)]
setcolorder(Table_1930_occ,c("occind","occind1930_name","sh_red_tit","perwt","sh_perwt"))

Table_1930_occ <- 
  Reduce(
          function(x, y, ...) merge(x, y, by="occind", all = TRUE, allow.cartesian = TRUE, ...),
          list(
            Table_1930_occ,
            X_spa,
            X_ind,
            table_ind,
            table_countynhg_1910
            )
        )


# 1940 ----
Table_1940_occ_dt2 <- 
  merge(
    census_sample_1940_individual_data[perwt>=10000 & !is.na(sh_new_method1_dataset2)][,!c("sh_new_method1_dataset1","sh_new_method1_dataset3")],
    new_titles_1940.by_occ_subind[,c("occ1940","name_ind1940_subgroup","occ1940_subocc_method1_dataset2","count","N_dataset2","N_red_inv_dataset2")],
    by=c("occ1940","name_ind1940_subgroup"),all.x=TRUE,all.y=FALSE
  )
Table_1940_occ_dt2[,occ1940_subocc_method1_dataset2:=paste0(occ1940,"_",occ1940_subocc_method1_dataset2)]

# Next steps: computing different measures.
# Dispersion measures
## Across Industries
X_ind <- f_HHI(Table_1940_occ_dt2,occ1940_subocc_method1_dataset2,perwt_ID,ind1950)
setnames(X_ind,c("H"),c("H_ind1950"))

## Across space
X_spa <- f_HHI(Table_1940_occ_dt2,occ1940_subocc_method1_dataset2,perwt_ID,countynhg_1910)
setnames(X_spa,c("H"),c("H_countynhg_1910"))

# Main industries associated with a given occupation
table_ind <- 
    f_ind_new_titles(Table_1940_occ_dt2,id_N=5,var=occ1940_subocc_method1_dataset2,w_v=perwt_ID,sh_v=sh_new_method1_dataset2,cols_v=ind1950)
col <- grep("^sh_ind1950|^emp|^sh_new_method",names(table_ind),value=TRUE)
table_ind <- table_ind[,!..col]

table_countynhg_1910 <- 
    f_ind_new_titles(Table_1940_occ_dt2,id_N=5,var=occ1940_subocc_method1_dataset2,w_v=perwt_ID,sh_v=sh_new_method1_dataset2,cols_v=countynhg_1910)
col <- grep("^sh_ind1950|^emp|^sh_new_method",names(table_countynhg_1910),value=TRUE)
table_countynhg_1910 <- table_countynhg_1910[,!..col]

# Compiling the whole table
Table_1940_occ_dt2 <- Table_1940_occ_dt2[,.(name_ind1940_subgroup=name_ind1940_subgroup[1],sh_new_method1_dataset2=sh_new_method1_dataset2[1],perwt=sum(perwt_ID),N_dataset2=N_dataset2[1],N_red_inv_dataset2=N_red_inv_dataset2[1],count=count[1]),by=c("occ1940","occ1940_subocc_method1_dataset2")][,sh_perwt:=sum(perwt)][,`:=`(sh_perwt=perwt/sh_perwt)][count>1,name_ind1940_subgroup:=NA]
setcolorder(Table_1940_occ_dt2,c("occ1940","occ1940_subocc_method1_dataset2","name_ind1940_subgroup","sh_new_method1_dataset2","perwt","sh_perwt"))

Table_1940_occ_dt2 <- 
  Reduce(
          function(x, y, ...) merge(x, y, by="occ1940_subocc_method1_dataset2", all = TRUE, allow.cartesian = TRUE, ...),
          list(
            Table_1940_occ_dt2,
            X_spa,
            X_ind,
            table_ind,
            table_countynhg_1910
            )
        )
      



```



# Part 3. Data Analysis using individual level observations
Here we study the main characteristics of persons employed in new work. 
We construct scatterplots to see the relationship between different individual level characteristics and the likelihood of being employed in a new occupaiton
*** TO-DO: Include here the individual level regressions.
## Loading packages and erasing the workspace (make sure to have loaded f_load_pk)
```{r}
rm(list = setdiff(ls(),c(lsf.str(),"main_directory") ))
f_load_pk()
```

```{r}
census_sample_1940_individual_data <- read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1940_individual_data.fst"),as.data.table=TRUE)
```

## 1.  Basic Plots of the different variables
### 1.1. Scatter (binned) plots
```{r}
y <- c("urban","farm","ownershp","famsize","male","educ","marst","age","mig_us","mig_ab","m_mig_us","m_mig_ab","f_mig_us","f_mig_ab","educ_main","wkswork1","hrswork1")

for (j in c("sh_new_method1_dataset1","sh_new_method1_dataset2","sh_new_method1_dataset3")) {
  for (i in 1:length(y)) {
    setnames(census_sample_1940_individual_data,c(y[i],j),c("v_plot","new"))
    p <- ggplot(census_sample_1940_individual_data[,c("new","v_plot")], aes_string(x="new",y="v_plot")) +
      geom_point(size=0.5) +
      stat_summary_bin(fun='mean', bins=10,
                       color='orange', size=4, geom='point') + labs(title=paste0(y[i]," x Share of New Work (",j,")"),x="Share of New Work", y = y[i]) + theme_tufte() 
    ggsave(paste0(main_directory,"R - Processing data/output/Graphs/individual_basic_plots/1940/corr_",j,"_x_",y[i],".jpeg"),plot=p)
    setnames(
      census_sample_1940_individual_data,
      c("v_plot","new"),
      c(y[i],j)
    )
   
  }
}

```


# Part 4. Map with share of new sector + Histograms with shares of new sectors
## Loading packages and erasing the workspace (make sure to have loaded f_load_pk)
```{r}
rm(list = setdiff(ls(),c(lsf.str(),"main_directory") ))
f_load_pk()
```

## 1. countynhg_1910
### 1.1. Call individual level data
```{r}
census_sample_1940_individual_data <-read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1940_individual_data_x_countynhg_1910.fst"),as.data.table=TRUE)
```

### 1.2. Database for histogram and map
```{r}
new_sectors_countynhg_1910 <- census_sample_1940_individual_data[,.SD[1],by=c("countynhg_1910"),.SDcols=c("perwt_1930","new_sec_all_1930","new_sec_main_1930","new_sec_serv_1930","perwt_1940","new_sec_all_1940","new_sec_main_1940","new_sec_serv_1940","rank_new_sec_1930","rank_new_sec_1940")]
```

### 1.3. Histogram
- Share of New Sector in 1930 and 1940 (excluding counties with highest shares of new sectors)
```{r}
p <- vector(mode = "list")
# 1930
p[[1]] <- ggplot(new_sectors_countynhg_1910[perwt_1930>=10000], aes(x=new_sec_all_1930)) +
  geom_histogram(color="black",bins=40,  aes(y = stat(width*density)),  fill="white") +
  scale_y_continuous(labels = percent_format()) +
  labs(title="",x="Share of New Sector", y = "")  + 
  theme_tufte() + theme(legend.position = "none")
ggsave(paste0(main_directory,"R - Processing data/output/Graphs/countynhg_1910/1930/histogram_share_new_sec_1930.jpeg"),plot=last_plot())

p[[2]] <- ggplot(new_sectors_countynhg_1910[perwt_1940>=10000], aes(x=new_sec_all_1940)) +
  geom_histogram(color="black",bins=40,  aes(y = stat(width*density)),fill="white") +
  scale_y_continuous(labels = percent_format()) +
  labs(title="",x="Share of New Sector", y = "")  + 
  theme_tufte() + theme(legend.position = "none")

ggsave(paste0(main_directory,"R - Processing data/output/Graphs/countynhg_1910/1940/histogram_share_new_sec_1940.jpeg"),plot=last_plot())

# Excluding counties with the highest share of new sectors
j <- 3
for (i in c(3,5,10,20,50,100,200)) {
  p[[j]] <- ggplot(new_sectors_countynhg_1910[perwt_1930>=10000 & rank_new_sec_1930>=i], aes(x=new_sec_all_1930)) +
    geom_histogram(color="black",bins=40,  aes(y = stat(width*density)),  fill="white") +
    scale_y_continuous(labels = percent_format()) +
    labs(title="",x="Share of New Sector", y = "")  + 
    theme_tufte() + theme(legend.position = "none")
  p[[j+1]] <- ggplot(new_sectors_countynhg_1910[perwt_1940>=10000 & rank_new_sec_1940>=i], aes(x=new_sec_all_1940)) +
    geom_histogram(color="black",bins=40,  aes(y = stat(width*density)),  fill="white") +
    scale_y_continuous(labels = percent_format()) +
    labs(title="",x="Share of New Sector", y = "")  + 
    theme_tufte() + theme(legend.position = "none")
  j <- j+2 
}

ggarrange(p[[1]], p[[3]], p[[5]], p[[7]],
          labels = c("All", "Excl. 2", "Excl. 4", "Excl. 9"),
          ncol = 2, nrow = 2)
ggsave(paste0(main_directory,"R - Processing data/output/Graphs/countynhg_1910/1930/histogram_share_new_sec_1930_excluding_regions_1.jpeg"),plot=last_plot())
ggarrange(p[[9]], p[[11]], p[[13]], p[[15]],
          labels = c("Excl. 19", "Excl. 49", "Excl. 99", "Excl. 199"),
          ncol = 2, nrow = 2)
ggsave(paste0(main_directory,"R - Processing data/output/Graphs/countynhg_1910/1930/histogram_share_new_sec_1930_excluding_regions_2.jpeg"),plot=last_plot())

ggarrange(p[[2]], p[[4]], p[[6]], p[[8]],
          labels = c("All", "Excl. 2", "Excl. 4", "Excl. 9"),
          ncol = 2, nrow = 2)
ggsave(paste0(main_directory,"R - Processing data/output/Graphs/countynhg_1910/1940/histogram_share_new_sec_1940_excluding_regions_1.jpeg"),plot=last_plot())
ggarrange(p[[10]], p[[12]], p[[14]], p[[16]],
          labels = c("Excl. 19", "Excl. 49", "Excl. 99", "Excl. 199"),
          ncol = 2, nrow = 2)
ggsave(paste0(main_directory,"R - Processing data/output/Graphs/countynhg_1910/1940/histogram_share_new_sec_1940_excluding_regions_2.jpeg"),plot=last_plot())


# DELETE LATER - Graphs for presentation
if (FALSE) {
  ggarrange(p[[1]], p[[3]], p[[11]], p[[13]],
            labels = c("All", "Excl. 4", "Excl. 49", "Excl. 99"),
            ncol = 2, nrow = 2)
  ggsave(paste0(main_directory,"R - Processing data/output/Graphs/countynhg_1910/histogram_share_new_sec_1930_excluding_regions_3-DELETE.jpeg"),plot=last_plot())
  ggarrange(p[[2]], p[[4]], p[[12]], p[[14]],
            labels = c("All", "Excl. 4", "Excl. 49", "Excl. 99"),
            ncol = 2, nrow = 2)
  ggsave(paste0(main_directory,"R - Processing data/output/Graphs/countynhg_1910/histogram_share_new_sec_1940_excluding_regions_3-DELETE.jpeg"),plot=last_plot())
}

rm(p)
```

### 1.4. Map
- Share of New Sector

#### Import and subset shape files
```{r}
# Importing shp file 
# 1 Option
map.cty <- st_read(paste0(main_directory,"R - Processing data/input/shapefiles/shapefile_us_county_1910"), quiet = TRUE)


map.state <- st_read(paste0(main_directory,"R - Processing data/input/shapefiles/shapefile_us_state_1910"), quiet = TRUE)

if (FALSE) {
# 2 option
map.cty <- read_sf(dsn=paste0(main_directory,"R - Processing data/input/shapefiles/shapefile_us_county_1910"))

# 3 option
# NOTE requires the data_file
map.state <- read_nhgis_sf(
  data_file = paste0(main_directory,"R - Processing data/input/shapefiles/nhgis0006_csv"),
  shape_file = paste0(main_directory,"R - Processing data/input/shapefiles/nhgis0006_shape.zip")
)
}
#subsetting it and dropping Alaska and Hawaii
map.cty <- subset(map.cty,select=c(GISJOIN2,STATENAM,geometry))
map.cty <- subset(map.cty, STATENAM !="Alaska Territory" & STATENAM != "Hawaii Territory")
map.cty$GISJOIN2 <- as.numeric(map.cty$GISJOIN2)
map.state <- subset(map.state,select=c(GISJOIN2,STATENAM,geometry))
map.state <- subset(map.state, STATENAM !="Alaska Territory" & STATENAM != "Hawaii Territory")

```

#### Join with info for share of new sector

##### countynhg_1910
```{r}
#1930
setnames(new_sectors_countynhg_1910,c("countynhg_1910"),c("GISJOIN2"))
map.countynhg_1910 <- merge(map.cty,new_sectors_countynhg_1910,by="GISJOIN2",all.x=TRUE,all.y=FALSE)
county <- tm_shape(subset(map.countynhg_1910)) + tm_polygons("new_sec_all_1930",style = "pretty", n=10,lwd=0) +
  tm_shape(map.state) + tm_borders(alpha=0.1,lwd=0.5)
tmap_save(county, paste0(main_directory,"R - Processing data/output/Maps/1930/sh_new_sector_1930_all_countynhg_1910.jpeg"))
rm(county)

#1940
county <- tm_shape(subset(map.countynhg_1910)) + tm_polygons("new_sec_all_1940",style = "pretty", n=10,lwd=0) +
  tm_shape(map.state) + tm_borders(alpha=0.1,lwd=0.5)
tmap_save(county, paste0(main_directory,"R - Processing data/output/Maps/1940/sh_new_sector_1940_all_countynhg_1910.jpeg"))
rm(county)
```

## 2. metarea_1940
### 2.1. Call individual level data
```{r}
census_sample_1940_individual_data <-read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1940_individual_data_x_metarea_1940.fst"),as.data.table=TRUE)
```

### 2.2. Database for histogram and map
```{r}
new_sectors_metarea_1940 <- census_sample_1940_individual_data[,.SD[1],by=c("metarea_1940"),.SDcols=c("perwt_1930","new_sec_all_1930","new_sec_main_1930","new_sec_serv_1930","perwt_1940","new_sec_all_1940","new_sec_main_1940","new_sec_serv_1940","rank_new_sec_1930","rank_new_sec_1940")]
```

### 2.3. Histogram
- Share of New Sector in 1930 and 1940 (excluding counties with highest shares of new sectors)
```{r}
p <- vector(mode = "list")
# 1930
p[[1]] <- ggplot(new_sectors_metarea_1940[perwt_1930>=10000], aes(x=new_sec_all_1930)) +
  geom_histogram(color="black",bins=40,  aes(y = stat(width*density)),  fill="white") +
  scale_y_continuous(labels = percent_format()) +
  labs(title="",x="Share of New Sector", y = "")  + 
  theme_tufte() + theme(legend.position = "none")
ggsave(paste0(main_directory,"R - Processing data/output/Graphs/metarea_1940/1930/histogram_share_new_sec_1930.jpeg"),plot=last_plot())

p[[2]] <- ggplot(new_sectors_metarea_1940[perwt_1940>=10000], aes(x=new_sec_all_1940)) +
  geom_histogram(color="black",bins=40,  aes(y = stat(width*density)),fill="white") +
  scale_y_continuous(labels = percent_format()) +
  labs(title="",x="Share of New Sector", y = "")  + 
  theme_tufte() + theme(legend.position = "none")

ggsave(paste0(main_directory,"R - Processing data/output/Graphs/metarea_1940/1940/histogram_share_new_sec_1940.jpeg"),plot=last_plot())

# Excluding counties with the highest share of new sectors
j <- 3
for (i in c(3,5,10)) {
  p[[j]] <- ggplot(new_sectors_metarea_1940[perwt_1930>=10000 & rank_new_sec_1930>=i], aes(x=new_sec_all_1930)) +
    geom_histogram(color="black",bins=40,  aes(y = stat(width*density)),  fill="white") +
    scale_y_continuous(labels = percent_format()) +
    labs(title="",x="Share of New Sector", y = "")  + 
    theme_tufte() + theme(legend.position = "none")
  p[[j+1]] <- ggplot(new_sectors_metarea_1940[perwt_1940>=10000 & rank_new_sec_1940>=i], aes(x=new_sec_all_1940)) +
    geom_histogram(color="black",bins=40,  aes(y = stat(width*density)),  fill="white") +
    scale_y_continuous(labels = percent_format()) +
    labs(title="",x="Share of New Sector", y = "")  + 
    theme_tufte() + theme(legend.position = "none")
  j <- j+2 
}

ggarrange(p[[1]], p[[3]], p[[5]], p[[7]],
          labels = c("All", "Excl. 2", "Excl. 4", "Excl. 9"),
          ncol = 2, nrow = 2)
ggsave(paste0(main_directory,"R - Processing data/output/Graphs/metarea_1940/1930/histogram_share_new_sec_1930_excluding_regions_1.jpeg"),plot=last_plot())

ggarrange(p[[2]], p[[4]], p[[6]], p[[8]],
          labels = c("All", "Excl. 2", "Excl. 4", "Excl. 9"),
          ncol = 2, nrow = 2)
ggsave(paste0(main_directory,"R - Processing data/output/Graphs/metarea_1940/1940/histogram_share_new_sec_1940_excluding_regions_2.jpeg"),plot=last_plot())

rm(p)
```

### 1.4. Map
- Share of New Sector

#### Import and subset shape files
```{r}
# Importing shp file 
# 1 Option
map.cty <- st_read(paste0(main_directory,"R - Processing data/input/shapefiles/shapefile_us_county_1910"), quiet = TRUE)

map.state <- st_read(paste0(main_directory,"R - Processing data/input/shapefiles/shapefile_us_state_1910"), quiet = TRUE)

if (FALSE) {
# 2 option
map.cty <- read_sf(dsn=paste0(main_directory,"R - Processing data/input/shapefiles/shapefile_us_county_1910"))

# 3 option
# NOTE requires the data_file
map.state <- read_nhgis_sf(
  data_file = paste0(main_directory,"R - Processing data/input/shapefiles/nhgis0006_csv"),
  shape_file = paste0(main_directory,"R - Processing data/input/shapefiles/nhgis0006_shape.zip")
)
}
#subsetting it and dropping Alaska and Hawaii
map.cty <- subset(map.cty,select=c(GISJOIN2,STATENAM,geometry))
map.cty <- subset(map.cty, STATENAM !="Alaska Territory" & STATENAM != "Hawaii Territory")
map.cty$GISJOIN2 <- as.numeric(map.cty$GISJOIN2)
map.state <- subset(map.state,select=c(GISJOIN2,STATENAM,geometry))
map.state <- subset(map.state, STATENAM !="Alaska Territory" & STATENAM != "Hawaii Territory")

```

#### Join with info for share of new sector
##### metarea_1940
***!!!! TO-DO: Map doesn't work
```{r}
# Merge new_sectors_metarea_1940 with map linking countynhg_1910 with metarea to be able to graph
temp <-
  merge(
    census_sample_1940_individual_data[,.SD[1],by=c("metarea_1940","countynhg_1910"),.SDcols=c("perwt_1930")][,perwt_1930:=NULL],
    new_sectors_metarea_1940,
    by="metarea_1940",all.x=FALSE,all.y=TRUE
  )

setnames(temp,c("countynhg_1910"),c("GISJOIN2"))
map.metarea_1940 <- merge(map.cty,temp,by="GISJOIN2",all.x=TRUE,all.y=FALSE)

metarea <- tm_shape(subset(map.metarea_1940)) + tm_polygons("new_sec_all_1930",style = "pretty", n=10,lwd=0) +
  tm_shape(map.state) + tm_borders(alpha=0.1,lwd=0.5)
tmap_save(metarea, paste0(main_directory,"R - Processing data/output/Maps/1930/sh_new_sector_1930_all_metarea_1940.jpeg"))
rm(metarea)

metarea <- tm_shape(subset(map.metarea_1940)) + tm_polygons("new_sec_all_1940",style = "pretty", n=10,lwd=0) +
  tm_shape(map.state) + tm_borders(alpha=0.1,lwd=0.5)
tmap_save(metarea, paste0(main_directory,"R - Processing data/output/Maps/1940/sh_new_sector_1940_all_metarea_1940.jpeg"))
rm(metarea,temp)
```


# Part 5. Looking at years 1920, 1930 and 1940 together
- Correlation graphs for new jobs 1920-1930, 1930-1940, 1920-1940
- Correlation graphs for new sectors 1920-1930, 1930-1940, 1920-1940 
- Correlation between new jobs and new sectors (1930-1920, 1940-1930, 1940-1920, 1920-1920, 1930-1930, 1940-1940)


!!!!! NOTE: The share of new sectors in 1930 should be rerun using sh_red_titind
## Loading packages and erasing the workspace (make sure to have loaded f_load_pk)
```{r}
rm(list = setdiff(ls(),c(lsf.str(),"main_directory") ))
f_load_pk()
```

## 0. Creating database
### Information without excluding workers
```{r}
# Adding 1920 information
census_sample_1920_1930_1940 <- read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1920_agg_countynhg_1910.fst"),as.data.table=TRUE,columns=c("countynhg_1910","perwt","sh_new_sector_ind1950_0","sh_new_sector_ind1950_376","sh_new_sector_ind1950_377","sh_new_sector_ind1950_466","sh_new_sector_ind1950_556","sh_new_sector_ind1950_606","sh_new_sector_ind1950_667","sh_new_sector_ind1950_668","sh_new_sector_ind1950_816"))[,`:=`(
  new_sec_all=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466 +sh_new_sector_ind1950_556+sh_new_sector_ind1950_606+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816,
  new_sec_main = sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466,
  new_sec_serv = sh_new_sector_ind1950_556+sh_new_sector_ind1950_606+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816 
  )
]
setorder(census_sample_1920_1930_1940,-new_sec_all)                           
census_sample_1920_1930_1940[,rank_new_sec:=1:.N]

col <- names(census_sample_1920_1930_1940[,!c("countynhg_1910")])
setnames(census_sample_1920_1930_1940,col,paste0(col,"_1920"))

# Adding 1930 info
temp <- read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1930_agg_countynhg_1910.fst"),as.data.table=TRUE,columns=c("countynhg_1910","perwt","sh_new_sector_ind1950_0","sh_new_sector_ind1950_376","sh_new_sector_ind1950_377","sh_new_sector_ind1950_466","sh_new_sector_ind1950_556","sh_new_sector_ind1950_606","sh_new_sector_ind1950_667","sh_new_sector_ind1950_668","sh_new_sector_ind1950_816","sh_new_sector_ind1950_856","sh_base_tit","sh_red_tit"))[,`:=`(
  new_sec_all=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466 +sh_new_sector_ind1950_556+sh_new_sector_ind1950_606+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816 + sh_new_sector_ind1950_856,
  new_sec_main = sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466,
  new_sec_serv = sh_new_sector_ind1950_556+sh_new_sector_ind1950_606+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816 + sh_new_sector_ind1950_856
  )
]
setorder(temp,-new_sec_all)                           
temp[,rank_new_sec:=1:.N]
col <- names(temp[,!c("countynhg_1910")])
setnames(temp,col,paste0(col,"_1930"))

census_sample_1920_1930_1940 <- 
  merge(
    census_sample_1920_1930_1940,temp,by="countynhg_1910",all=TRUE
  )

# Adding 1940 info
temp <- read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1940_agg_countynhg_1910.fst"),as.data.table=TRUE,columns=c("countynhg_1910","perwt","sh_new_sector_ind1950_0","sh_new_sector_ind1950_376","sh_new_sector_ind1950_377","sh_new_sector_ind1950_466","sh_new_sector_ind1950_556","sh_new_sector_ind1950_667","sh_new_sector_ind1950_668","sh_new_sector_ind1950_816","sh_new_sector_ind1950_856","sh_new_all_dataset1","sh_new_all_dataset2","sh_new_all_dataset3","sh_new_method1_dataset1","sh_new_method1_dataset2","sh_new_method1_dataset3","sh_new_method2_dataset1","sh_new_method2_dataset2","sh_new_method2_dataset3"))[,`:=`(
  new_sec_all=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466 +sh_new_sector_ind1950_556+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816 + sh_new_sector_ind1950_856,
  new_sec_main = sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466,
  new_sec_serv = sh_new_sector_ind1950_556+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816 + sh_new_sector_ind1950_856
  )
]
setorder(temp,-new_sec_all)                           
temp[,rank_new_sec:=1:.N]
col <- names(temp[,!c("countynhg_1910")])
setnames(temp,col,paste0(col,"_1940"))

census_sample_1920_1930_1940 <- 
  merge(
    census_sample_1920_1930_1940,temp,by="countynhg_1910",all=TRUE
  )

rm(temp)
```

### Information excluding workers in New Sectors
```{r}
# 1930
## No new sec all
temp <- 
  read_fst(paste0(main_directory,"R - Processing data/output/Rdata/new_titles_agg_no_new_sec_all.fst"),as.data.table=TRUE,columns=c("countynhg_1910","perwt","sh_red_tit","sh_red_titind"))[!is.na(countynhg_1910)][,lapply(.SD,weighted.mean,w=perwt),by=c("countynhg_1910"),.SDcols=c("sh_red_tit","sh_red_titind")]
col <- names(temp[,!c("countynhg_1910")])
setnames(temp,col,paste0(col,"_1930_no_new_sec"))

census_sample_1920_1930_1940 <- 
  merge(
    census_sample_1920_1930_1940,temp,by="countynhg_1910",all=TRUE
  )

## No new sec main
temp <- 
  read_fst(paste0(main_directory,"R - Processing data/output/Rdata/new_titles_agg_no_new_sec_main.fst"),as.data.table=TRUE,columns=c("countynhg_1910","perwt","sh_red_tit","sh_red_titind"))[!is.na(countynhg_1910)][,lapply(.SD,weighted.mean,w=perwt),by=c("countynhg_1910"),.SDcols=c("sh_red_tit","sh_red_titind")]
col <- names(temp[,!c("countynhg_1910")])
setnames(temp,col,paste0(col,"_1930_no_new_sec_main"))

census_sample_1920_1930_1940 <- 
  merge(
    census_sample_1920_1930_1940,temp,by="countynhg_1910",all=TRUE
  )

# 1940
## No new sec all
temp <- 
  read_fst(paste0(main_directory,"R - Processing data/output/Rdata/new_titles_agg_no_new_sec_all_1940.fst"),as.data.table=TRUE,columns=c("countynhg_1910","perwt","sh_new_method1_dataset1","sh_new_method1_dataset2","sh_new_method1_dataset3"))[!is.na(countynhg_1910)][,lapply(.SD,weighted.mean,w=perwt),by=c("countynhg_1910"),.SDcols=c("sh_new_method1_dataset1","sh_new_method1_dataset2","sh_new_method1_dataset3")]
col <- names(temp[,!c("countynhg_1910")])
setnames(temp,col,paste0(col,"_1940_no_new_sec"))

census_sample_1920_1930_1940 <- 
  merge(
    census_sample_1920_1930_1940,temp,by="countynhg_1910",all=TRUE
  )

## No new sec main
temp <- 
  read_fst(paste0(main_directory,"R - Processing data/output/Rdata/new_titles_agg_no_new_sec_main_1940.fst"),as.data.table=TRUE,columns=c("countynhg_1910","perwt","sh_new_method1_dataset1","sh_new_method1_dataset2","sh_new_method1_dataset3"))[!is.na(countynhg_1910)][,lapply(.SD,weighted.mean,w=perwt),by=c("countynhg_1910"),.SDcols=c("sh_new_method1_dataset1","sh_new_method1_dataset2","sh_new_method1_dataset3")]
col <- names(temp[,!c("countynhg_1910")])
setnames(temp,col,paste0(col,"_1940_no_new_sec_main"))

census_sample_1920_1930_1940 <- 
  merge(
    census_sample_1920_1930_1940,temp,by="countynhg_1910",all=TRUE
  )
rm(temp)
```

## 1. Correlation graphs for new jobs
```{r}
# 1930 - 1940
for (i in c("sh_new_method1_dataset1_1940","sh_new_method1_dataset2_1940","sh_new_method1_dataset3_1940")) {
  j <- "sh_red_tit_1930"

  ggplot(census_sample_1920_1930_1940, aes(y=!!sym(i), x=!!sym(j))) + geom_point(size=0.1) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Correlation between share of New Work in 1930 and 1940",x="Share of New Work (1930)", y = "Share of New Work (1940)") + theme_tufte() + theme(axis.line=element_line(color="black"))
      
      ggsave(paste0(main_directory,"R - Processing data/output/Graphs/countynhg_1910/corr_",i,"_x_",j,".jpeg"),plot=last_plot())
}
```

## 2. Correlation graphs for new sector
```{r}
for (i in c("new_sec_all","new_sec_main","new_sec_serv")) {
  i_1920 <- paste0(i,"_1920")
  i_1930 <- paste0(i,"_1930")
  i_1940 <- paste0(i,"_1940")
  
  if (i=="new_sec_all")  tit <- "" 
  if (i=="new_sec_main")  tit <- " (Main)" 
  if (i=="new_sec_serv")  tit <- " (Service)" 
  
  ggplot(census_sample_1920_1930_1940, aes(y=!!sym(i_1930), x=!!sym(i_1920))) + geom_point(size=0.1) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title=paste0("Correlation between share of New Sectors",tit," in 1920 and 1930"),x="Share of New Sectors (1920)", y = "Share of New Sectors (1930)") + theme_tufte() + theme(axis.line=element_line(color="black"))
  ggsave(paste0(main_directory,"R - Processing data/output/Graphs/countynhg_1910/corr_",i_1920,"_x_",i_1930,".jpeg"),plot=last_plot())
  
  ggplot(census_sample_1920_1930_1940, aes(y=!!sym(i_1940), x=!!sym(i_1930))) + geom_point(size=0.1) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title=paste0("Correlation between share of New Sectors",tit," in 1930 and 1940"),x="Share of New Sectors (1930)", y = "Share of New Sectors (1940)") + theme_tufte() + theme(axis.line=element_line(color="black"))
  ggsave(paste0(main_directory,"R - Processing data/output/Graphs/countynhg_1910/corr_",i_1930,"_x_",i_1940,".jpeg"),plot=last_plot())
  
  ggplot(census_sample_1920_1930_1940, aes(y=!!sym(i_1940), x=!!sym(i_1920))) + geom_point(size=0.1) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title=paste0("Correlation between share of New Sectors",tit," in 1920 and 1940"),x="Share of New Sectors (1920)", y = "Share of New Sectors (1940)") + theme_tufte() + theme(axis.line=element_line(color="black"))
  ggsave(paste0(main_directory,"R - Processing data/output/Graphs/countynhg_1910/corr_",i_1920,"_x_",i_1940,".jpeg"),plot=last_plot())
  
}

```

## 3. Correlation between new sectors and new occupations

- sh_red_tit                        x new_sec_all_1920, new_sec_main_1920
- sh_red_tit_no_new_sec_all         x new_sec_all_1920, new_sec_main_1920
- sh_red_tit_no_new_sec_main        x new_sec_all_1920, new_sec_main_1920
- sh_new_method...                  x new_sec_all_1930, new_sec_main_1930
- sh_new_method..._no_new_sec_all   x new_sec_all_1930, new_sec_main_1930
- sh_new_method..._no_new_main_all  x new_sec_all_1930, new_sec_main_1930

```{r}
# 1930 - 1940
for (i1 in c("sh_new_method1_dataset1_1940","sh_new_method1_dataset2_1940","sh_new_method1_dataset3_1940")) {
  for (i2 in c("","_no_new_sec","_no_new_sec_main")) {
    i <- paste0(i1,i2)
    titi <- 
      ifelse(
        i2=="_no_new_sec",
        " excluding new sectors",
        ifelse(
          i2=="_no_new_sec_main",
          " excluding new main sectors", 
          ""
        )
      )
    for (j in c("new_sec_all_1930","new_sec_main_1930")) {
      titj <- ifelse(j=="new_sec_all_1930",""," Main")
    
      ggplot(census_sample_1920_1930_1940, aes(y=!!sym(i), x=!!sym(j))) + geom_point(size=0.1) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Share of New Sector (1930) x Share of New Work (1940)",x=paste0("Share of New",titj," Sector (1930)"), y = paste0("Share of New Work",titi," (1940)")) + theme_tufte() + theme(axis.line=element_line(color="black"))
      ggsave(paste0(main_directory,"R - Processing data/output/Graphs/countynhg_1910/corr_",i,"_x_",j,".jpeg"),plot=last_plot())
    }
  }
}

# 1920 - 1930
#****!!! NOTE, TO-DO: Need also to include "sh_red_titind_1930". This one is part of 
for (i1 in c("sh_red_tit_1930")) {
  for (i2 in c("","_no_new_sec","_no_new_sec_main")) {
    i <- paste0(i1,i2)
    titi <- 
      ifelse(
        i2=="_no_new_sec",
        " excluding new sectors",
        ifelse(
          i2=="_no_new_sec_main",
          " excluding new main sectors", 
          ""
        )
      )
    for (j in c("new_sec_all_1920","new_sec_main_1920")) {
      titj <- ifelse(j=="new_sec_all_1920",""," Main")
    
      ggplot(census_sample_1920_1930_1940, aes(y=!!sym(i), x=!!sym(j))) + geom_point(size=0.1) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Share of New Sector (1920) x Share of New Work (1930)",x=paste0("Share of New",titj," Sector (1920)"), y = paste0("Share of New Work",titi," (1930)")) + theme_tufte() + theme(axis.line=element_line(color="black"))
      ggsave(paste0(main_directory,"R - Processing data/output/Graphs/countynhg_1910/corr_",i,"_x_",j,".jpeg"),plot=last_plot())
    }
  }
}
  
# 1920 - 1940
for (i1 in c("sh_new_method1_dataset1_1940","sh_new_method1_dataset2_1940","sh_new_method1_dataset3_1940")) {
  for (i2 in c("","_no_new_sec","_no_new_sec_main")) {
    i <- paste0(i1,i2)
    titi <- 
      ifelse(
        i2=="_no_new_sec",
        " excluding new sectors",
        ifelse(
          i2=="_no_new_sec_main",
          " excluding new main sectors", 
          ""
        )
      )
    for (j in c("new_sec_all_1920","new_sec_main_1920")) {
      titj <- ifelse(j=="new_sec_all_1920",""," Main")
    
      ggplot(census_sample_1920_1930_1940, aes(y=!!sym(i), x=!!sym(j))) + geom_point(size=0.1) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="Share of New Sector (1920) x Share of New Work (1940)",x=paste0("Share of New",titj," Sector (1920)"), y = paste0("Share of New Work",titi," (1940)")) + theme_tufte() + theme(axis.line=element_line(color="black"))
      ggsave(paste0(main_directory,"R - Processing data/output/Graphs/countynhg_1910/corr_",i,"_x_",j,".jpeg"),plot=last_plot())
    }
  }
}
  
```

# Part 6. Regressions following Lin (2011)
## 1. Regressions following Lin (2011) - At the countynhg_1910 level
## Loading packages and erasing the workspace (make sure to have loaded f_load_pk)
```{r}
rm(list = setdiff(ls(),c(lsf.str(),"main_directory") ))
f_load_pk()
```

### 1.1. Create Dataset to run regressions
*NOTE: The observation units in the dataset are individuals. The dataset contains both individual level variables as well as regional level variables.
#### Call Main dataset
```{r}
census_sample_1940_individual_data <-read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1940_individual_data_x_countynhg_1910.fst"),as.data.table=TRUE)
```

#### Include regional information computed excluding workers in new sectors
```{r}
# 1940
## Excluding new sectors
temp <- read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1940_agg_countynhg_1910_no_new_sec_all.fst"),as.data.table=TRUE)
cols <- grep("^countynhg_1910|^sh_ind1950|^sh_occ|^sh_new|^sh_educ_main|^av_wkwage|^sh_mig5_state_1|^sh_mig5_county_1|^H|^perwt",names(temp),value=TRUE)
temp <- temp[,cols,with=FALSE]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_1940_no_new_sec_all"))

census_sample_1940_individual_data <- merge(census_sample_1940_individual_data,temp,by="countynhg_1910",all=FALSE)
rm(temp)

## Excluding new MAIN sectors
temp <- read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1940_agg_countynhg_1910_no_new_sec_main.fst"),as.data.table=TRUE)
cols <- grep("^countynhg_1910|^sh_ind1950|^sh_occ|^sh_new|^sh_educ_main|^av_wkwage|^sh_mig5_state_1|^sh_mig5_county_1|^H|^perwt",names(temp),value=TRUE)
temp <- temp[,cols,with=FALSE]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_1940_no_new_sec_main"))

census_sample_1940_individual_data <- merge(census_sample_1940_individual_data,temp,by="countynhg_1910",all=FALSE)
rm(temp)

# 1930
## Excluding new sectors
temp <- read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1930_agg_countynhg_1910_no_new_sec_all.fst"),as.data.table=TRUE)
cols <- grep("^countynhg_1910|^sh_ind1950|^sh_occ|^sh_base|^sh_red|^sh_lit|^H|^perwt",names(temp),value=TRUE)
temp <- temp[,cols,with=FALSE]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_1930_no_new_sec_all"))

census_sample_1940_individual_data <- merge(census_sample_1940_individual_data,temp,by="countynhg_1910",all=FALSE)
rm(temp)

## Excluding new MAIN sectors
temp <- read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1930_agg_countynhg_1910_no_new_sec_main.fst"),as.data.table=TRUE)
cols <- grep("^countynhg_1910|^sh_ind1950|^sh_occ|^sh_base|^sh_red|^sh_lit|^H|^perwt",names(temp),value=TRUE)
temp <- temp[,cols,with=FALSE]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_1930_no_new_sec_main"))

census_sample_1940_individual_data <- merge(census_sample_1940_individual_data,temp,by="countynhg_1910",all=FALSE)
rm(temp)

```


### 1.2. Creating some variables variables
```{r}
# Change categorical variables to factors
# Note: - using factors allows R to easily create dummies
#       - We don't change binary variables, as they are already interpreted as Dummy variables  
cols <- c("race","marst","age_main","educ_main","ind1950_main","occ1950_main")
census_sample_1940_individual_data[,(cols):=lapply(.SD,as.factor),.SDcols=cols]

# County and State migration
census_sample_1940_individual_data[,`:=`(state_mig = 0+(mig5_state!=1),county_mig = 0+(mig5_county!=1))]

# Converting state to a factor variable
census_sample_1940_individual_data[,statefip:=as.factor(statefip)]  
```

### 1.3 Main Regressions
* NOTE: 
- Run regression for all workers without including income information
- Run regression for all workers with weeks and income information
- Run regression for full time workers including income information

- Individual variable combinations (these variables are only for year 1940)
 - base_1 (c("male","marst","race","wwages","age_main","educ_main"))
 - base_1 + base_wage_1
 - base_1 + base_wage_2
 - base_1 + base_mig_2
 - base_1 + base_mig_2 + base_wage_1
 - base_1 + base_mig_2 + base_wage_2
 - base_1 + base_mig_2
 - base_1 + base_mig_2 + base_wage_1
 - base_1 + base_mig_2 + base_wage_2
 
- Regional variables (some are only for 1930 others for both 1940 and 1930)
 - Variables of interes:
    - reg_main:     - (1)  sh_lit (or sh_educ for 1940), H, log(perwt)
                    - (2)  sh_occ1950_main, sh_ind1950_main
    - reg_second:   - (1)  sh_age (three different groups), sh_male, sh_race, sh_urban (maybe sh_farm???)
                    - (2)  av_wkwage
                    - (3)  sh_labforce, sh_unenemp, sh_wrkwage
                    - (4a) sh_mig_us, sh_mig_ab
                    - (4b) sh_mig5_state_1_1940, sh_mig5_county_1_1940,   
                    
#### 1.3.2. Creating formulas for Main Regression
##### Variables
```{r}
# Indiidual Variables
base_1 <- paste0(c("male","marst","race","wwages","age_main","educ_main"),collapse=" + ")
base_mig_1 <- paste0(c("mig_us","mig_ab"),collapse=" + ")
base_mig_2 <- paste0(c("state_mig","county_mig"),collapse=" + ")
base_wage_1 <- paste0(c("incwage"),collapse=" + ")
base_wage_2 <- paste0(c("wkwage","wkswork1"),collapse=" + ")

# Regional Variables
## reg_main
# Regional
j <- 1; regional_1_1930 <- indsh_var_1930 <- occsh_var_1930 <- regional_1_1940 <- indsh_var_1940 <- occsh_var_1940 <- vector(mode = "list")
for (i in c("","_no_new_sec_all","_no_new_sec_main")) {
  regional_1_1930[[j]] <- paste0(paste0(paste0(c("sh_lit_1930","H_1930"),i),collapse=" + ")," + log(perwt_1930",i,")" )
  indsh_var_1930[[j]] <- paste0(paste0(grep("^sh_ind1950_main_[^1]_1930$",names(census_sample_1940_individual_data),value=TRUE),i),collapse=" + ")
  occsh_var_1930[[j]] <- paste0(paste0(grep("^sh_occ1950_main_[^0].+_1930$",names(census_sample_1940_individual_data),value=TRUE),i),collapse=" + ")
  regional_1_1940[[j]] <- paste0(paste0(paste0(c("sh_educ_main_2_1940","sh_educ_main_3_1940","H_1940$"),i),collapse=" + ")," + log(perwt_1940",i,")" )
  indsh_var_1940[[j]] <- paste0(paste0(grep("^sh_ind1950_main_[^1]_1940$",names(census_sample_1940_individual_data),value=TRUE),i),collapse=" + ")
  occsh_var_1940[[j]] <- paste0(paste0(grep("^sh_occ1950_main_[^0].+_1940$",names(census_sample_1940_individual_data),value=TRUE),i),collapse=" + ")
  j <- j+1
}

### Base
reg_second_1_1930 <- paste0(c("sh_age_16_49_1930","sh_age_more50_1930","sh_male_1930","sh_race_2_1930","sh_race_3_1930","sh_urban_1930"),collapse=" + ")
reg_second_3_1930 <- paste0(c("sh_labforce_1930","sh_unemp_1930","sh_wrkwage_1930"),collapse=" + ")
reg_second_4_1930 <- paste0(c("sh_mig_us_1930", "sh_mig_ab_1930"),collapse=" + ")

reg_second_1_1940 <- paste0(c("sh_age_16_49_1940","sh_age_more50_1940","sh_male_1940","sh_race_2_1940","sh_race_3_1940","sh_urban_1940"),collapse=" + ")
# NOTE: reg_second doesn't exist for 1930
reg_second_2_1940 <- paste0(c("av_wkwage_1940"),collapse=" + ")
reg_second_3_1940 <- paste0(c("sh_labforce_1940","sh_unemp_1940","sh_wrkwage_1940"),collapse=" + ")
reg_second_4_1940 <- paste0(c("sh_mig5_state_1_1940", "sh_mig5_county_1_1940"),collapse=" + ")


```

#### 1.3.3 First stage regression (following Lin (2011))
*** TO-DO: Construct regressions for this part. The main problem is that the algorithm collapses when we include countynhg_1910 dummies
```{r}
```

#### 1.3.4. Regression fomulas
- Regressions with base variables in 1940  
- Regressions with reg_second in 1930  vs     reg_second in 1940 
- Regressions with ind and occ in 1930 vs     ind and occ in 1940
- Regressions with educ,pop,H in 1930  vs     educ,pop,H in 1940

- What variables should be constructed excluding new sectors?
  - Only occ and ind
  - occ, ind and other educ, pop, H
  
  
Regression groups
- All workers
    a_1: all variables in 1930 except the individual ones
    a_2: individual vars + reg_second in 1940
  
- Excluding all new sectors
    b1,b2: Dropping workers in new sectors, all variables in 1930 except the individual ones
      - _x_controls_all: no variables excluding new sectors
      - _x_no_new_sec1_all: occ and ind excluding new sectors
      - _x_no_new_sec2_all: occ, ind and other educ, pop, H excluding new sectors
    c1,c2: dropping workers in MAIN sectors, all variables in 1930 except the individual ones
      - _x_controls_all: no variables excluding new sectors
      - _x_no_new_sec1_all: occ and ind excluding new sectors
      - _x_no_new_sec2_all: occ, ind and other educ, pop, H excluding new sectors
      
##### Complete set of regressions
```{r}
# All variables in 1930 (except individual ones) - All Sectors and excluding sectors in the dependent variables BUT NOT in the independent ones

## Creating variables
for (i1 in c("_dataset1","_dataset2","_dataset3")) {
  for (i2 in c("a","b","c")) {
    if (i2=="a") {
      assign(paste0(i2,"1",i1),vector(mode = "list")) 
      assign(paste0(i2,"2",i1),vector(mode = "list"))
    } else if (i2=="b" | i2=="c") {
      assign(paste0(i2,"1_x_controls_all",i1),vector(mode = "list")) 
      assign(paste0(i2,"2_x_controls_all",i1),vector(mode = "list")) 
    }
  }
}

for (i1 in c("sh_new_method1_dataset1","sh_new_method1_dataset2","sh_new_method1_dataset3")) {
  j <- 1
  for (i2 in c(
    paste0(""),
    paste0(" + statefip"),
    paste0(" + statefip + ",base_1),
    paste0(" + statefip + ",base_1," + ",base_mig_2),
    paste0(" + statefip + ",base_1," + ",base_wage_1),
    paste0(" + statefip + ",base_1," + ",base_wage_2),
    paste0(" + statefip + ",base_1," + ",base_wage_1," + ",base_mig_2),
    paste0(" + statefip + ",base_1," + ",base_wage_2," + ",base_mig_2),
    paste0(" + ",base_1),
    paste0(" + ",base_1," + ",base_mig_2),
    paste0(" + ",base_1," + ",base_wage_1),
    paste0(" + ",base_1," + ",base_wage_2),
    paste0(" + ",base_1," + ",base_wage_1," + ",base_mig_2),
    paste0(" + ",base_1," + ",base_wage_2," + ",base_mig_2)
  )  ) { 
    for (i3 in c(
      paste0(""),
      paste0(" + ",regional_1_1930[[1]]),
      paste0(" + ",regional_1_1930[[1]]," + ",indsh_var_1930[[1]]),
      paste0(" + ",regional_1_1930[[1]]," + ",occsh_var_1930[[1]]),
      paste0(" + ",regional_1_1930[[1]]," + ",indsh_var_1930[[1]]," + ",occsh_var_1930[[1]]),
      paste0(" + ",indsh_var_1930[[1]]),
      paste0(" + ",occsh_var_1930[[1]]),
      paste0(" + ",indsh_var_1930[[1]]," + ",occsh_var_1930[[1]])
    )  ) {
      
      for (i4 in c(
        paste0(""),
        paste0(" + ",reg_second_1_1930),
        paste0(" + ",reg_second_1_1930," + ",reg_second_3_1930),
        paste0(" + ",reg_second_1_1930," + ",reg_second_3_1930," + ",reg_second_4_1930)
      )   )   {
        if (i1=="sh_new_method1_dataset1") {
            # NOTE: The only thing that changes here is the set of observations used. Nonetheless we create different vectors for a better organization
            a1_dataset1[[j]] <- b1_x_controls_all_dataset1[[j]] <- c1_x_controls_all_dataset1[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i2,i3,i4))
            a2_dataset1[[j]] <- b2_x_controls_all_dataset1[[j]] <- c2_x_controls_all_dataset1[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i2,i3,i4))
        } else if (i1=="sh_new_method1_dataset2") {
            a1_dataset2[[j]] <- b1_x_controls_all_dataset2[[j]] <- c1_x_controls_all_dataset2[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i2,i3,i4))
            a2_dataset2[[j]] <- b2_x_controls_all_dataset2[[j]] <- c2_x_controls_all_dataset2[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i2,i3,i4))
        } else if (i1=="sh_new_method1_dataset3") {
            a1_dataset3[[j]] <- b1_x_controls_all_dataset3[[j]] <- c1_x_controls_all_dataset3[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i2,i3,i4))
            a2_dataset3[[j]] <- b2_x_controls_all_dataset3[[j]] <- c2_x_controls_all_dataset3[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i2,i3,i4))
        }
        j <- j + 1
      }
    }
  }  

}

## individual vars + reg_second in 1940 
#**** TO-DO

# Excluding new sectors
## Creating the variables
for (i1 in c("_dataset1","_dataset2","_dataset3")) {
  for (i2 in c("b","c")) {
    for (i3 in c("cont_no_new_sec_1","cont_no_new_sec_2")) {
      assign(paste0(i2,"1_x_",i3,i1),vector(mode = "list")) 
      assign(paste0(i2,"2_x_",i3,i1),vector(mode = "list")) 
    }
  }
}

## occ and ind excluding new sectors
for (i1_a in c("sh_new_method1_dataset1","sh_new_method1_dataset2","sh_new_method1_dataset3")) {
  for (i1_b in c("_no_new_sec_all","_no_new_sec_main")) {
    if (i1_b=="_no_new_sec_all") i2 <- 2
    if (i1_b=="_no_new_sec_main") i2 <- 3
    j <- 1
    for (i3 in c(
      paste0(""),
      paste0(" + statefip"),
      paste0(" + statefip + ",base_1),
      paste0(" + statefip + ",base_1," + ",base_mig_2),
      paste0(" + statefip + ",base_1," + ",base_wage_1),
      paste0(" + statefip + ",base_1," + ",base_wage_2),
      paste0(" + statefip + ",base_1," + ",base_wage_1," + ",base_mig_2),
      paste0(" + statefip + ",base_1," + ",base_wage_2," + ",base_mig_2),
      paste0(" + ",base_1),
      paste0(" + ",base_1," + ",base_mig_2),
      paste0(" + ",base_1," + ",base_wage_1),
      paste0(" + ",base_1," + ",base_wage_2),
      paste0(" + ",base_1," + ",base_wage_1," + ",base_mig_2),
      paste0(" + ",base_1," + ",base_wage_2," + ",base_mig_2)
    )  ) { 
      for (i4 in c(
        paste0(""),
        paste0(" + ",regional_1_1930[[1]]," + ",indsh_var_1930[[i2]]),
        paste0(" + ",regional_1_1930[[1]]," + ",occsh_var_1930[[i2]]),
        paste0(" + ",regional_1_1930[[1]]," + ",indsh_var_1930[[i2]]," + ",occsh_var_1930[[i2]]),
        paste0(" + ",indsh_var_1930[[i2]]),
        paste0(" + ",occsh_var_1930[[i2]]),
        paste0(" + ",indsh_var_1930[[i2]]," + ",occsh_var_1930[[i2]])
      )  ) {
        
        for (i5 in c(
          paste0(""),
          paste0(" + ",reg_second_1_1930),
          paste0(" + ",reg_second_1_1930," + ",reg_second_3_1930),
          paste0(" + ",reg_second_1_1930," + ",reg_second_3_1930," + ",reg_second_4_1930)
        )   )   {
          if (i1_a=="sh_new_method1_dataset1") {
            if (i1_b=="_no_new_sec_all") {
              b1_x_cont_no_new_sec_1_dataset1[[j]] <- as.formula(paste(i1_a," ~ new_sec_all_1930",i3,i4,i5))
              b2_x_cont_no_new_sec_1_dataset1[[j]] <- as.formula(paste(i1_a," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
            } else if (i1_b=="_no_new_sec_main") {
              c1_x_cont_no_new_sec_1_dataset1[[j]] <- as.formula(paste(i1_a," ~ new_sec_all_1930",i3,i4,i5))
              c2_x_cont_no_new_sec_1_dataset1[[j]] <- as.formula(paste(i1_a," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
            }
          } else if (i1_a=="sh_new_method1_dataset2") {
            if (i1_b=="_no_new_sec_all") {
              b1_x_cont_no_new_sec_1_dataset2[[j]] <- as.formula(paste(i1_a," ~ new_sec_all_1930",i3,i4,i5))
              b2_x_cont_no_new_sec_1_dataset2[[j]] <- as.formula(paste(i1_a," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
            } else if (i1_b=="_no_new_sec_main") {
              c1_x_cont_no_new_sec_1_dataset2[[j]] <- as.formula(paste(i1_a," ~ new_sec_all_1930",i3,i4,i5))
              c2_x_cont_no_new_sec_1_dataset2[[j]] <- as.formula(paste(i1_a," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
            }
          } else if (i1_a=="sh_new_method1_dataset3") {
            if (i1_b=="_no_new_sec_all") {
              b1_x_cont_no_new_sec_1_dataset3[[j]] <- as.formula(paste(i1_a," ~ new_sec_all_1930",i3,i4,i5))
              b2_x_cont_no_new_sec_1_dataset3[[j]] <- as.formula(paste(i1_a," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
            } else if (i1_b=="_no_new_sec_main") {
              c1_x_cont_no_new_sec_1_dataset3[[j]] <- as.formula(paste(i1_a," ~ new_sec_all_1930",i3,i4,i5))
              c2_x_cont_no_new_sec_1_dataset3[[j]] <- as.formula(paste(i1_a," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
            }
          }
          j <- j + 1
        }
      }
    }
  }
}

## occ, ind and other educ, pop, H excluding new sectors
for (i1_a in c("sh_new_method1_dataset1","sh_new_method1_dataset2","sh_new_method1_dataset3")) {
  for (i1_b in c("_no_new_sec_all","_no_new_sec_main")) {
    if (i1_b=="_no_new_sec_all") i2 <- 2
    if (i1_b=="_no_new_sec_main") i2 <- 3
    j <- 1
    for (i3 in c(
      paste0(""),
      paste0(" + statefip"),
      paste0(" + statefip + ",base_1),
      paste0(" + statefip + ",base_1," + ",base_mig_2),
      paste0(" + statefip + ",base_1," + ",base_wage_1),
      paste0(" + statefip + ",base_1," + ",base_wage_2),
      paste0(" + statefip + ",base_1," + ",base_wage_1," + ",base_mig_2),
      paste0(" + statefip + ",base_1," + ",base_wage_2," + ",base_mig_2),
      paste0(" + ",base_1),
      paste0(" + ",base_1," + ",base_mig_2),
      paste0(" + ",base_1," + ",base_wage_1),
      paste0(" + ",base_1," + ",base_wage_2),
      paste0(" + ",base_1," + ",base_wage_1," + ",base_mig_2),
      paste0(" + ",base_1," + ",base_wage_2," + ",base_mig_2)
    )  ) { 
      for (i4 in c(
        paste0(""),
        paste0(" + ",regional_1_1930[[i2]]," + ",indsh_var_1930[[i2]]),
        paste0(" + ",regional_1_1930[[i2]]," + ",occsh_var_1930[[i2]]),
        paste0(" + ",regional_1_1930[[i2]]," + ",indsh_var_1930[[i2]]," + ",occsh_var_1930[[i2]]),
        paste0(" + ",indsh_var_1930[[i2]]),
        paste0(" + ",occsh_var_1930[[i2]]),
        paste0(" + ",indsh_var_1930[[i2]]," + ",occsh_var_1930[[i2]])
      )  ) {
        
        for (i5 in c(
          paste0(""),
          paste0(" + ",reg_second_1_1930),
          paste0(" + ",reg_second_1_1930," + ",reg_second_3_1930),
          paste0(" + ",reg_second_1_1930," + ",reg_second_3_1930," + ",reg_second_4_1930)
        )   )   {
          if (i1_a=="sh_new_method1_dataset1") {
            if (i1_b=="_no_new_sec_all") {
              b1_x_cont_no_new_sec_2_dataset1[[j]] <- as.formula(paste(i1_a," ~ new_sec_all_1930",i3,i4,i5))
              b2_x_cont_no_new_sec_2_dataset1[[j]] <- as.formula(paste(i1_a," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
            } else if (i1_b=="_no_new_sec_main") {
              c1_x_cont_no_new_sec_2_dataset1[[j]] <- as.formula(paste(i1_a," ~ new_sec_all_1930",i3,i4,i5))
              c2_x_cont_no_new_sec_2_dataset1[[j]] <- as.formula(paste(i1_a," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
            }
          } else if (i1_a=="sh_new_method1_dataset2") {
            if (i1_b=="_no_new_sec_all") {
              b1_x_cont_no_new_sec_2_dataset2[[j]] <- as.formula(paste(i1_a," ~ new_sec_all_1930",i3,i4,i5))
              b2_x_cont_no_new_sec_2_dataset2[[j]] <- as.formula(paste(i1_a," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
            } else if (i1_b=="_no_new_sec_main") {
              c1_x_cont_no_new_sec_2_dataset2[[j]] <- as.formula(paste(i1_a," ~ new_sec_all_1930",i3,i4,i5))
              c2_x_cont_no_new_sec_2_dataset2[[j]] <- as.formula(paste(i1_a," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
            }
          } else if (i1_a=="sh_new_method1_dataset3") {
            if (i1_b=="_no_new_sec_all") {
              b1_x_cont_no_new_sec_2_dataset3[[j]] <- as.formula(paste(i1_a," ~ new_sec_all_1930",i3,i4,i5))
              b2_x_cont_no_new_sec_2_dataset3[[j]] <- as.formula(paste(i1_a," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
            } else if (i1_b=="_no_new_sec_main") {
              c1_x_cont_no_new_sec_2_dataset3[[j]] <- as.formula(paste(i1_a," ~ new_sec_all_1930",i3,i4,i5))
              c2_x_cont_no_new_sec_2_dataset3[[j]] <- as.formula(paste(i1_a," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
            }
          }
          j <- j + 1
        }
      }
    }
  }
}

#*****!!!!!!!!!1 If we want to include all the individual vectors containing formulas in a list
# formulas <- mget( ls( pattern = "^a1_|^a2_|^b1_|^b2_|^c1_|^c2_"))


```

##### Reduced set of regressions
```{r}
for (i1 in c("_dataset1","_dataset2","_dataset3")) {
  for (i2 in c("a","b","c")) {
    if (i2=="a") {
      assign(paste0(i2,"1_red",i1),vector(mode = "list")) 
      assign(paste0(i2,"2_red",i1),vector(mode = "list"))
    } else {
      assign(paste0(i2,"1_red_x_controls_all",i1),vector(mode = "list")) 
      assign(paste0(i2,"2_red_x_controls_all",i1),vector(mode = "list")) 
    }
  }
}

for (i1 in c("sh_new_method1_dataset1","sh_new_method1_dataset2","sh_new_method1_dataset3")) {
  j <- 1
  for (i2 in c(
    paste0(""),
    paste0(" + ",base_1),
    paste0(" + ",base_1," + ",base_wage_1),
    paste0(" + ",base_1," + ",base_wage_2),
    paste0(" + statefip"),
    paste0(" + statefip + ",base_1),
    paste0(" + statefip + ",base_1," + ",base_wage_1),
    paste0(" + statefip + ",base_1," + ",base_wage_2)
  )  ) { 
    for (i3 in c(
      paste0(""),
      paste0(" + ",regional_1_1930[[1]]),
      paste0(" + ",regional_1_1930[[1]]," + ",indsh_var_1930[[1]]),
      paste0(" + ",regional_1_1930[[1]]," + ",occsh_var_1930[[1]]),
      paste0(" + ",regional_1_1930[[1]]," + ",indsh_var_1930[[1]]," + ",occsh_var_1930[[1]]),
      paste0(" + ",indsh_var_1930[[1]]),
      paste0(" + ",occsh_var_1930[[1]]),
      paste0(" + ",indsh_var_1930[[1]]," + ",occsh_var_1930[[1]])
    )  ) {
      
      for (i4 in c(
        paste0(""),
        paste0(" + ",reg_second_1_1930," + ",reg_second_3_1930)
      )   )   {
        if (i1=="sh_new_method1_dataset1") {
            # NOTE: The only thing that changes here is the set of observations used. Nonetheless we create different vectors for a better organization
            a1_red_dataset1[[j]] <- b1_red_x_controls_all_dataset1[[j]] <- c1_red_x_controls_all_dataset1[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i2,i3,i4))
            a2_red_dataset1[[j]] <- b2_red_x_controls_all_dataset1[[j]] <- c2_red_x_controls_all_dataset1[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i2,i3,i4))
        } else if (i1=="sh_new_method1_dataset2") {
            a1_red_dataset2[[j]] <- b1_red_x_controls_all_dataset2[[j]] <- c1_red_x_controls_all_dataset2[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i2,i3,i4))
            a2_red_dataset2[[j]] <- b2_red_x_controls_all_dataset2[[j]] <- c2_red_x_controls_all_dataset2[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i2,i3,i4))
        } else if (i1=="sh_new_method1_dataset3") {
            a1_red_dataset3[[j]] <- b1_red_x_controls_all_dataset3[[j]] <- c1_red_x_controls_all_dataset3[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i2,i3,i4))
            a2_red_dataset3[[j]] <- b2_red_x_controls_all_dataset3[[j]] <- c2_red_x_controls_all_dataset3[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i2,i3,i4))
        }
        j <- j + 1
      }
    }
  }  
}

for (i1 in c("_dataset1","_dataset2","_dataset3")) {
  for (i2 in c("b","c")) {
    for (i3 in c("cont_no_new_sec_1","cont_no_new_sec_2")) {
      assign(paste0(i2,"1_red_x_",i3,i1),vector(mode = "list")) 
      assign(paste0(i2,"2_red_x_",i3,i1),vector(mode = "list")) 
    }
  }
}

## occ and ind excluding new sectors
for (i1_a in c("sh_new_method1_dataset1","sh_new_method1_dataset2","sh_new_method1_dataset3")) {
  for (i1_b in c("_no_new_sec_all","_no_new_sec_main")) {
    if (i1_b=="_no_new_sec_all") i2 <- 2
    if (i1_b=="_no_new_sec_main") i2 <- 3
    j <- 1
    for (i3 in c(
      paste0(""),
      paste0(" + ",base_1),
      paste0(" + ",base_1," + ",base_wage_1),
      paste0(" + ",base_1," + ",base_wage_2),
      paste0(" + statefip"),
      paste0(" + statefip + ",base_1),
      paste0(" + statefip + ",base_1," + ",base_wage_1),
      paste0(" + statefip + ",base_1," + ",base_wage_2)
    )  ) { 
      for (i4 in c(
        paste0(""),
        paste0(" + ",regional_1_1930[[1]]),
        paste0(" + ",regional_1_1930[[1]]," + ",indsh_var_1930[[i2]]),
        paste0(" + ",regional_1_1930[[1]]," + ",occsh_var_1930[[i2]]),
        paste0(" + ",regional_1_1930[[1]]," + ",indsh_var_1930[[i2]]," + ",occsh_var_1930[[i2]]),
        paste0(" + ",indsh_var_1930[[i2]]),
        paste0(" + ",occsh_var_1930[[i2]]),
        paste0(" + ",indsh_var_1930[[i2]]," + ",occsh_var_1930[[i2]])
      )  ) {
        
        for (i5 in c(
          paste0(""),
          paste0(" + ",reg_second_1_1930," + ",reg_second_3_1930)
        )   )   {
          if (i1_a=="sh_new_method1_dataset1") {
            if (i1_b=="_no_new_sec_all") {
              b1_red_x_cont_no_new_sec_1_dataset1[[j]] <- as.formula(paste(i1_a," ~ new_sec_all_1930",i3,i4,i5))
              b2_red_x_cont_no_new_sec_1_dataset1[[j]] <- as.formula(paste(i1_a," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
            } else if (i1_b=="_no_new_sec_main") {
              c1_red_x_cont_no_new_sec_1_dataset1[[j]] <- as.formula(paste(i1_a," ~ new_sec_all_1930",i3,i4,i5))
              c2_red_x_cont_no_new_sec_1_dataset1[[j]] <- as.formula(paste(i1_a," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
            }
          } else if (i1_a=="sh_new_method1_dataset2") {
            if (i1_b=="_no_new_sec_all") {
              b1_red_x_cont_no_new_sec_1_dataset2[[j]] <- as.formula(paste(i1_a," ~ new_sec_all_1930",i3,i4,i5))
              b2_red_x_cont_no_new_sec_1_dataset2[[j]] <- as.formula(paste(i1_a," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
            } else if (i1_b=="_no_new_sec_main") {
              c1_red_x_cont_no_new_sec_1_dataset2[[j]] <- as.formula(paste(i1_a," ~ new_sec_all_1930",i3,i4,i5))
              c2_red_x_cont_no_new_sec_1_dataset2[[j]] <- as.formula(paste(i1_a," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
            }
          } else if (i1_a=="sh_new_method1_dataset3") {
            if (i1_b=="_no_new_sec_all") {
              b1_red_x_cont_no_new_sec_1_dataset3[[j]] <- as.formula(paste(i1_a," ~ new_sec_all_1930",i3,i4,i5))
              b2_red_x_cont_no_new_sec_1_dataset3[[j]] <- as.formula(paste(i1_a," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
            } else if (i1_b=="_no_new_sec_main") {
              c1_red_x_cont_no_new_sec_1_dataset3[[j]] <- as.formula(paste(i1_a," ~ new_sec_all_1930",i3,i4,i5))
              c2_red_x_cont_no_new_sec_1_dataset3[[j]] <- as.formula(paste(i1_a," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
            }
          }
          j <- j + 1
        }
      }
    }
  }
}

## occ, ind and other educ, pop, H excluding new sectors
for (i1_a in c("sh_new_method1_dataset1","sh_new_method1_dataset2","sh_new_method1_dataset3")) {
  for (i1_b in c("_no_new_sec_all","_no_new_sec_main")) {
    if (i1_b=="_no_new_sec_all") i2 <- 2
    if (i1_b=="_no_new_sec_main") i2 <- 3
    j <- 1
    for (i3 in c(
      paste0(""),
      paste0(" + ",base_1),
      paste0(" + ",base_1," + ",base_wage_1),
      paste0(" + ",base_1," + ",base_wage_2),
      paste0(" + statefip"),
      paste0(" + statefip + ",base_1),
      paste0(" + statefip + ",base_1," + ",base_wage_1),
      paste0(" + statefip + ",base_1," + ",base_wage_2)
    )  ) { 
      for (i4 in c(
        paste0(""),
        paste0(" + ",regional_1_1930[[i2]]),
        paste0(" + ",regional_1_1930[[i2]]," + ",indsh_var_1930[[i2]]),
        paste0(" + ",regional_1_1930[[i2]]," + ",occsh_var_1930[[i2]]),
        paste0(" + ",regional_1_1930[[i2]]," + ",indsh_var_1930[[i2]]," + ",occsh_var_1930[[i2]]),
        paste0(" + ",indsh_var_1930[[i2]]),
        paste0(" + ",occsh_var_1930[[i2]]),
        paste0(" + ",indsh_var_1930[[i2]]," + ",occsh_var_1930[[i2]])
      )  ) {
        
        for (i5 in c(
          paste0(""),
          paste0(" + ",reg_second_1_1930," + ",reg_second_3_1930)
        )   )   {
          if (i1_a=="sh_new_method1_dataset1") {
            if (i1_b=="_no_new_sec_all") {
              b1_red_x_cont_no_new_sec_2_dataset1[[j]] <- as.formula(paste(i1_a," ~ new_sec_all_1930",i3,i4,i5))
              b2_red_x_cont_no_new_sec_2_dataset1[[j]] <- as.formula(paste(i1_a," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
            } else if (i1_b=="_no_new_sec_main") {
              c1_red_x_cont_no_new_sec_2_dataset1[[j]] <- as.formula(paste(i1_a," ~ new_sec_all_1930",i3,i4,i5))
              c2_red_x_cont_no_new_sec_2_dataset1[[j]] <- as.formula(paste(i1_a," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
            }
          } else if (i1_a=="sh_new_method1_dataset2") {
            if (i1_b=="_no_new_sec_all") {
              b1_red_x_cont_no_new_sec_2_dataset2[[j]] <- as.formula(paste(i1_a," ~ new_sec_all_1930",i3,i4,i5))
              b2_red_x_cont_no_new_sec_2_dataset2[[j]] <- as.formula(paste(i1_a," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
            } else if (i1_b=="_no_new_sec_main") {
              c1_red_x_cont_no_new_sec_2_dataset2[[j]] <- as.formula(paste(i1_a," ~ new_sec_all_1930",i3,i4,i5))
              c2_red_x_cont_no_new_sec_2_dataset2[[j]] <- as.formula(paste(i1_a," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
            }
          } else if (i1_a=="sh_new_method1_dataset3") {
            if (i1_b=="_no_new_sec_all") {
              b1_red_x_cont_no_new_sec_2_dataset3[[j]] <- as.formula(paste(i1_a," ~ new_sec_all_1930",i3,i4,i5))
              b2_red_x_cont_no_new_sec_2_dataset3[[j]] <- as.formula(paste(i1_a," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
            } else if (i1_b=="_no_new_sec_main") {
              c1_red_x_cont_no_new_sec_2_dataset3[[j]] <- as.formula(paste(i1_a," ~ new_sec_all_1930",i3,i4,i5))
              c2_red_x_cont_no_new_sec_2_dataset3[[j]] <- as.formula(paste(i1_a," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
            }
          }
          j <- j + 1
        }
      }
    }
  }
}

#*****!!!!!!!!!1 If we want to include all the individual vectors containing formulas in a list
# formulas <- mget( ls( pattern = "^a1_|^a2_|^b1_|^b2_|^c1_|^c2_"))

```


#### 1.3.5 Runing the regressions
##### 1.3.5.1. Main Regressions
 - a, b, c
 - dataset1, dataset2, dataset3
 - _x_controls_all
 - _x_cont_no_new_sec_1,x_cont_no_new_sec_2
 
```{r}
# Set of vectors: specify the formulas that you want to use, if you don't want to run all the regressions (is time consuming)
#cols <- seq(1,length(a1_red_dataset1),1)
cols <- c(1,4,6,8,10,17,21,23,25,65,68,70,72,74,81,85,87,89)

for (i1 in c("a","b","c")) {
  for (i2 in c("_dataset1","_dataset2","_dataset3")) {
    # The name is too long to use it as a Sheet's name, reduce it
    if (i2=="_dataset1") {            i2t <- "_dt1"
    } else if (i2=="_dataset2") {     i2t <- "_dt2"
    } else if (i2=="_dataset3") {     i2t <- "_dt3"
    }
    if (i1=="a") {
      formula <- eval(as.name(paste0(i1,"1_red",i2)))
      assign(
        paste0("coef_",i1,"1_red",i2t),
        f_regressions (arg_formula=formula[cols],arg_data=census_sample_1940_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1940 > 10000],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occ1940)
      )
      formula <- eval(as.name(paste0(i1,"2_red",i2)))
      assign(
        paste0("coef_",i1,"2_red",i2t),
        f_regressions (arg_formula=formula[cols],arg_data=census_sample_1940_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1940 > 10000],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occ1940)
      )
    } else if (i1=="b") {
      for (i3 in c("_red_x_controls_all","_red_x_cont_no_new_sec_1","_red_x_cont_no_new_sec_2")) {
        formula <- eval(as.name(paste0(i1,"1",i3,i2)))
        assign(
          paste0("coef_",i1,"1",i3,i2t),
         f_regressions (arg_formula=formula[cols],arg_data=census_sample_1940_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1940 > 10000 & !(ind1950 %in% c(376,377,466,556,606,667,668,816,856))],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occ1940)
        )
        formula <- eval(as.name(paste0(i1,"2",i3,i2)))
        assign(
          paste0("coef_",i1,"2",i3,i2t),
          f_regressions (arg_formula=formula[cols],arg_data=census_sample_1940_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1940 > 10000 & !(ind1950 %in% c(376,377,466,556,606,667,668,816,856))],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occ1940)
        )
      }
    } else if (i1=="c") {
      for (i3 in c("_red_x_controls_all","_red_x_cont_no_new_sec_1","_red_x_cont_no_new_sec_2")) {
        formula <- eval(as.name(paste0(i1,"1",i3,i2)))
        assign(
          paste0("coef_",i1,"1",i3,i2t),
         f_regressions (arg_formula=formula[cols],arg_data=census_sample_1940_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1940 > 10000 & !(ind1950 %in% c(376,377,466))],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occ1940)
        )
        formula <- eval(as.name(paste0(i1,"2",i3,i2)))
        assign(
          paste0("coef_",i1,"2",i3,i2t),
          f_regressions (arg_formula=formula[cols],arg_data=census_sample_1940_individual_data[occ1950_main!=979 & ind1950_main!=0 & perwt_1940 > 10000 & !(ind1950 %in% c(376,377,466))],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occ1940)
        )
      }
    }
  }
}
```

##### Saving results
###### Creating vectors for the different coefficient tables
```{r}
# Vector with the name of all the coefficient objects
vect_coef_a <- vect_coef_b <- vect_coef_c <- vector(mode="character")
vect_coef_a <- 
  c( paste0("a1_red",c("_dt1","_dt2","_dt3")),
     paste0("a2_red",c("_dt1","_dt2","_dt3"))
  )
for (i1 in c("1_red_x_controls_all","2_red_x_controls_all","1_red_x_cont_no_new_sec_1","2_red_x_cont_no_new_sec_1","1_red_x_cont_no_new_sec_2","2_red_x_cont_no_new_sec_2")) {
  for (i2 in c("b","c")) {
    if (i2=="b") {
      vect_coef_b <- 
        c(
          vect_coef_b,
          paste0(paste0(i2,i1),c("_dt1","_dt2","_dt3"))
        )
    } else if (i2=="c") {
      vect_coef_c <- 
        c(
          vect_coef_c,
          paste0(paste0(i2,i1),c("_dt1","_dt2","_dt3"))
        )
    }
  }
}

# Vector with the names of all the unique variables in all the coefficient vectors
#NOTE: paste0 creates a character of the form c(a1_red_dataset1$rn,a1_red_dataset2$rn), and eval(parse(text=...)) evaluates this vector
names_vector <- 
  unique( 
    eval(parse(
      text = 
        paste0(
          "c(",
          paste0( paste0("coef_",vect_coef_a,"$rn"),collapse=","),
          paste0( paste0("coef_",vect_coef_b,"$rn"),collapse=","),
          paste0( paste0("coef_",vect_coef_c,"$rn"),collapse=","),
          ")"
          )
      )) 
    )
# NOTE: We could further reduce the set of variables that we want to display

# Ordering variables
Order <- list(
            c(grep("^new_sec_all_1930",names_vector,value=TRUE)),
            c(grep("^new_sec_main_1930",names_vector,value=TRUE)),
            c(grep("^new_sec_serv_1930",names_vector,value=TRUE)),
            c(grep("^H_",names_vector,value=TRUE)),
            c(grep("perwt_",names_vector,value=TRUE)),
            c(grep("^sh_lit",names_vector,value=TRUE)),
            c(grep("^sh_occ1950_main",names_vector,value=TRUE)),
            c("adj.r2"),c("nobs"),
            c(grep("^statefip10",names_vector,value=TRUE)),
            c(grep("^sh_ind1950_main",names_vector,value=TRUE)),
            c(grep("^sh_age_16_49",names_vector,value=TRUE)),
            c(grep("^sh_age_more5",names_vector,value=TRUE)),
            c(grep("^sh_labforce_",names_vector,value=TRUE)),
            c(grep("^sh_unemp_",names_vector,value=TRUE)),
            c(grep("^sh_wrkwage_",names_vector,value=TRUE)),
            c(grep("^sh_mig_us_",names_vector,value=TRUE)),
            c(grep("^sh_mig_ab_",names_vector,value=TRUE))
            )
```

###### Exporting results
```{r}
# Dependent variable and individual var in 1940, rest in 1930
## Coefficients that don't exclude any workers 
list <- vector(mode="list"); j<- 1
for (i in c(paste0("coef_",vect_coef_a))) {
  X <- eval(parse(text=i))
  list[[j]] <- f_order_reg(X[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn)[,!c("variable")]
  j <- j+1
}

wrapper_Excel(
  list,
  as.list(vect_coef_a),
  paste0(main_directory,"R - Processing data/output/Tables/reg_all_1940_ctynhg_1910.xlsx")
)

## Coefficients that exclude workers in all new sectors
list <- vector(mode="list"); j<- 1
for (i in c(paste0("coef_",vect_coef_b))) {
  X <- eval(parse(text=i))
  list[[j]] <- f_order_reg(X[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn)[,!c("variable")]
  j <- j+1
}

wrapper_Excel(
  list,
  as.list(vect_coef_b),
  paste0(main_directory,"R - Processing data/output/Tables/reg_no_new_sec_1940_ctynhg_1910.xlsx")
)

## Coefficients that exclude workers in all new main sectors
list <- vector(mode="list"); j<- 1
for (i in c(paste0("coef_",vect_coef_c))) {
  X <- eval(parse(text=i))
  list[[j]] <- f_order_reg(X[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn)[,!c("variable")]
  j <- j+1
}

wrapper_Excel(
  list,
  as.list(vect_coef_c),
  paste0(main_directory,"R - Processing data/output/Tables/reg_no_new_sec_main_1940_ctynhg_1910.xlsx")
)
```

#### 1.5.2.2 Robustness Regressions
```{r}
# Excluding regions with the highest shares of New Sectors 
#* use rank_new_sec_1920>=_ To work only with certain regions
## 2

## 4
```

###### Saving results
```{r}

```


## 2. Regressions following Lin (2011) - At the metarea_1940 level
****!!! TO-DO: Review the code and run
## Loading packages and erasing the workspace (make sure to have loaded f_load_pk)
```{r}
rm(list = setdiff(ls(),c(lsf.str(),"main_directory") ))
f_load_pk()
```

### 1.1. Create Dataset to run regressions
*NOTE: The observation units in the dataset are individuals. The dataset contains both individual level variables as well as regional level variables.
#### Call Main dataset
```{r}
census_sample_1940_individual_data <-read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1940_individual_data_x_metarea_1940.fst"),as.data.table=TRUE)
```

#### Include regional information computed excluding workers in new sectors
```{r}
# 1940
## Excluding new sectors
temp <- read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1940_agg_metarea_1940_no_new_sec_all.fst"),as.data.table=TRUE)
cols <- grep("^metarea_1940|^sh_ind1950|^sh_occ|^sh_new|^sh_educ_main|^av_wkwage|^sh_mig5_state_1|^sh_mig5_county_1|^H|^perwt",names(temp),value=TRUE)
temp <- temp[,cols,with=FALSE]
cols <- names(temp[,!c("metarea_1940")])
setnames(temp,cols,paste0(cols,"_1940_no_new_sec_all"))

census_sample_1940_individual_data <- merge(census_sample_1940_individual_data,temp,by="metarea_1940",all=FALSE)
rm(temp)

## Excluding new MAIN sectors
temp <- read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1940_agg_metarea_1940_no_new_sec_main.fst"),as.data.table=TRUE)
cols <- grep("^metarea_1940|^sh_ind1950|^sh_occ|^sh_new|^sh_educ_main|^av_wkwage|^sh_mig5_state_1|^sh_mig5_county_1|^H|^perwt",names(temp),value=TRUE)
temp <- temp[,cols,with=FALSE]
cols <- names(temp[,!c("metarea_1940")])
setnames(temp,cols,paste0(cols,"_1940_no_new_sec_main"))

census_sample_1940_individual_data <- merge(census_sample_1940_individual_data,temp,by="metarea_1940",all=FALSE)
rm(temp)

# 1930
## Excluding new sectors
temp <- read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1930_agg_metarea_1940_no_new_sec_all.fst"),as.data.table=TRUE)
cols <- grep("^metarea_1940|^sh_ind1950|^sh_occ|^sh_base|^sh_red|^sh_lit|^H|^perwt",names(temp),value=TRUE)
temp <- temp[,cols,with=FALSE]
cols <- names(temp[,!c("metarea_1940")])
setnames(temp,cols,paste0(cols,"_1930_no_new_sec_all"))

census_sample_1940_individual_data <- merge(census_sample_1940_individual_data,temp,by="metarea_1940",all=FALSE)
rm(temp)

## Excluding new MAIN sectors
temp <- read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1930_agg_metarea_1940_no_new_sec_main.fst"),as.data.table=TRUE)
cols <- grep("^metarea_1940|^sh_ind1950|^sh_occ|^sh_base|^sh_red|^sh_lit|^H|^perwt",names(temp),value=TRUE)
temp <- temp[,cols,with=FALSE]
cols <- names(temp[,!c("metarea_1940")])
setnames(temp,cols,paste0(cols,"_1930_no_new_sec_main"))

census_sample_1940_individual_data <- merge(census_sample_1940_individual_data,temp,by="metarea_1940",all=FALSE)
rm(temp)

```


### 1.2. Creating some variables variables
```{r}
# Change categorical variables to factors
# Note: - using factors allows R to easily create dummies
#       - We don't change binary variables, as they are already interpreted as Dummy variables  
cols <- c("race","marst","age_main","educ_main","ind1950_main","occ1950_main")
census_sample_1940_individual_data[,(cols):=lapply(.SD,as.factor),.SDcols=cols]

# County and State migration
census_sample_1940_individual_data[,`:=`(state_mig = 0+(mig5_state!=1),county_mig = 0+(mig5_county!=1))]

# Converting state to a factor variable
census_sample_1940_individual_data[,statefip:=as.factor(statefip)]  
```

### 1.3 Main Regressions
* NOTE: 
- Run regression for all workers without including income information
- Run regression for all workers with weeks and income information
- Run regression for full time workers including income information

- Individual variable combinations (these variables are only for year 1940)
 - base_1 (c("male","marst","race","wwages","age_main","educ_main"))
 - base_1 + base_wage_1
 - base_1 + base_wage_2
 - base_1 + base_mig_2
 - base_1 + base_mig_2 + base_wage_1
 - base_1 + base_mig_2 + base_wage_2
 - base_1 + base_mig_2
 - base_1 + base_mig_2 + base_wage_1
 - base_1 + base_mig_2 + base_wage_2
 
- Regional variables (some are only for 1930 others for both 1940 and 1930)
 - Variables of interes:
    - reg_main:     - (1)  sh_lit (or sh_educ for 1940), H, log(perwt)
                    - (2)  sh_occ1950_main, sh_ind1950_main
    - reg_second:   - (1)  sh_age (three different groups), sh_male, sh_race, sh_urban (maybe sh_farm???)
                    - (2)  av_wkwage
                    - (3)  sh_labforce, sh_unenemp, sh_wrkwage
                    - (4a) sh_mig_us, sh_mig_ab
                    - (4b) sh_mig5_state_1_1940, sh_mig5_county_1_1940,   
                    
#### 1.3.2. Creating formulas for Main Regression
##### Variables
```{r}
# Indiidual Variables
base_1 <- paste0(c("male","marst","race","wwages","age_main","educ_main"),collapse=" + ")
base_mig_1 <- paste0(c("mig_us","mig_ab"),collapse=" + ")
base_mig_2 <- paste0(c("state_mig","county_mig"),collapse=" + ")
base_wage_1 <- paste0(c("incwage"),collapse=" + ")
base_wage_2 <- paste0(c("wkwage","wkswork1"),collapse=" + ")

# Regional Variables
## reg_main
# Regional
j <- 1; regional_1_1930 <- indsh_var_1930 <- occsh_var_1930 <- regional_1_1940 <- indsh_var_1940 <- occsh_var_1940 <- vector(mode = "list")
for (i in c("","_no_new_sec_all","_no_new_sec_main")) {
  regional_1_1930[[j]] <- paste0(paste0(paste0(c("sh_lit_1930","H_1930"),i),collapse=" + ")," + log(perwt_1930",i,")" )
  indsh_var_1930[[j]] <- paste0(paste0(grep("^sh_ind1950_main_[^1]_1930$",names(census_sample_1940_individual_data),value=TRUE),i),collapse=" + ")
  occsh_var_1930[[j]] <- paste0(paste0(grep("^sh_occ1950_main_[^0].+_1930$",names(census_sample_1940_individual_data),value=TRUE),i),collapse=" + ")
  regional_1_1940[[j]] <- paste0(paste0(paste0(c("sh_educ_main_2_1940","sh_educ_main_3_1940","H_1940$"),i),collapse=" + ")," + log(perwt_1940",i,")" )
  indsh_var_1940[[j]] <- paste0(paste0(grep("^sh_ind1950_main_[^1]_1940$",names(census_sample_1940_individual_data),value=TRUE),i),collapse=" + ")
  occsh_var_1940[[j]] <- paste0(paste0(grep("^sh_occ1950_main_[^0].+_1940$",names(census_sample_1940_individual_data),value=TRUE),i),collapse=" + ")
  j <- j+1
}

### Base
reg_second_1_1930 <- paste0(c("sh_age_16_49_1930","sh_age_more50_1930","sh_male_1930","sh_race_2_1930","sh_race_3_1930","sh_urban_1930"),collapse=" + ")
reg_second_3_1930 <- paste0(c("sh_labforce_1930","sh_unemp_1930","sh_wrkwage_1930"),collapse=" + ")
reg_second_4_1930 <- paste0(c("sh_mig_us_1930", "sh_mig_ab_1930"),collapse=" + ")

reg_second_1_1940 <- paste0(c("sh_age_16_49_1940","sh_age_more50_1940","sh_male_1940","sh_race_2_1940","sh_race_3_1940","sh_urban_1940"),collapse=" + ")
# NOTE: reg_second doesn't exist for 1930
reg_second_2_1940 <- paste0(c("av_wkwage_1940"),collapse=" + ")
reg_second_3_1940 <- paste0(c("sh_labforce_1940","sh_unemp_1940","sh_wrkwage_1940"),collapse=" + ")
reg_second_4_1940 <- paste0(c("sh_mig5_state_1_1940", "sh_mig5_county_1_1940"),collapse=" + ")


```

### 1.3.3 First stage regression (following Lin (2011))
*** TO-DO: Construct regressions for this part. The main problem is that the algorithm collapses when we include countynhg_1910 dummies
```{r}
```

### 1.3.4. Regression fomulas
- Regressions with base variables in 1940  
- Regressions with reg_second in 1930  vs     reg_second in 1940 
- Regressions with ind and occ in 1930 vs     ind and occ in 1940
- Regressions with educ,pop,H in 1930  vs     educ,pop,H in 1940

- What variables should be constructed excluding new sectors?
  - Only occ and ind
  - occ, ind and other educ, pop, H
  
  
Regression groups
- All workers
    a_1: all variables in 1930 except the individual ones
    a_2: individual vars + reg_second in 1940
  
- Excluding all new sectors
    b1,b2: Dropping workers in new sectors, all variables in 1930 except the individual ones
      - _x_controls_all: no variables excluding new sectors
      - _x_no_new_sec1_all: occ and ind excluding new sectors
      - _x_no_new_sec2_all: occ, ind and other educ, pop, H excluding new sectors
    c1,c2: dropping workers in MAIN sectors, all variables in 1930 except the individual ones
      - _x_controls_all: no variables excluding new sectors
      - _x_no_new_sec1_all: occ and ind excluding new sectors
      - _x_no_new_sec2_all: occ, ind and other educ, pop, H excluding new sectors
      
#### Complete set of regressions
```{r}
# All variables in 1930 (except individual ones) - All Sectors and excluding sectors in the dependent variables BUT NOT in the independent ones

## Creating variables
for (i1 in c("_dataset1","_dataset2","_dataset3")) {
  for (i2 in c("a","b","c")) {
    if (i2=="a") {
      assign(paste0(i2,"1",i1),vector(mode = "list")) 
      assign(paste0(i2,"2",i1),vector(mode = "list"))
    } else if (i2=="b" | i2=="c") {
      assign(paste0(i2,"1_x_controls_all",i1),vector(mode = "list")) 
      assign(paste0(i2,"2_x_controls_all",i1),vector(mode = "list")) 
    }
  }
}

for (i1_a in c("sh_new_method1_dataset1","sh_new_method1_dataset2","sh_new_method1_dataset3")) {
  for (i1_b in c("","_1940_no_new_sec_all","_1940_no_new_sec_main")) {
    i1 <- paste0(i1_a,i1_b)
    j <- 1
    for (i2 in c(
      paste0(""),
      paste0(" + statefip"),
      paste0(" + statefip + ",base_1),
      paste0(" + statefip + ",base_1," + ",base_mig_2),
      paste0(" + statefip + ",base_1," + ",base_wage_1),
      paste0(" + statefip + ",base_1," + ",base_wage_2),
      paste0(" + statefip + ",base_1," + ",base_wage_1," + ",base_mig_2),
      paste0(" + statefip + ",base_1," + ",base_wage_2," + ",base_mig_2),
      paste0(" + ",base_1),
      paste0(" + ",base_1," + ",base_mig_2),
      paste0(" + ",base_1," + ",base_wage_1),
      paste0(" + ",base_1," + ",base_wage_2),
      paste0(" + ",base_1," + ",base_wage_1," + ",base_mig_2),
      paste0(" + ",base_1," + ",base_wage_2," + ",base_mig_2)
      )  ) { 
      for (i3 in c(
        paste0(""),
        paste0(" + ",regional_1_1930[[1]]),
        paste0(" + ",regional_1_1930[[1]]," + ",indsh_var_1930[[1]]),
        paste0(" + ",regional_1_1930[[1]]," + ",occsh_var_1930[[1]]),
        paste0(" + ",regional_1_1930[[1]]," + ",indsh_var_1930[[1]]," + ",occsh_var_1930[[1]]),
        paste0(" + ",indsh_var_1930[[1]]),
        paste0(" + ",occsh_var_1930[[1]]),
        paste0(" + ",indsh_var_1930[[1]]," + ",occsh_var_1930[[1]])
        )  ) {
        
        for (i4 in c(
          paste0(""),
          paste0(" + ",reg_second_1_1930),
          paste0(" + ",reg_second_1_1930," + ",reg_second_3_1930),
          paste0(" + ",reg_second_1_1930," + ",reg_second_3_1930," + ",reg_second_4_1930)
          )   )   {
          if (i1_a=="sh_new_method1_dataset1") {
            if (i1_b=="") {
              a1_dataset1[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i2,i3,i4))
              a2_dataset1[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i2,i3,i4))
            } else if (i1_b=="_1940_no_new_sec_all") {
              b1_x_controls_all_dataset1[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i2,i3,i4))
              b2_x_controls_all_dataset1[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i2,i3,i4))
            } else if (i1_b=="_1940_no_new_sec_main") {
              c1_x_controls_all_dataset1[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i2,i3,i4))
              c2_x_controls_all_dataset1[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i2,i3,i4))
            }
          } else if (i1_a=="sh_new_method1_dataset2") {
            if (i1_b=="") {
              a1_dataset2[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i2,i3,i4))
              a2_dataset2[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i2,i3,i4))
            } else if (i1_b=="_1940_no_new_sec_all") {
              b1_x_controls_all_dataset2[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i2,i3,i4))
              b2_x_controls_all_dataset2[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i2,i3,i4))
            } else if (i1_b=="_1940_no_new_sec_main") {
              c1_x_controls_all_dataset2[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i2,i3,i4))
              c2_x_controls_all_dataset2[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i2,i3,i4))
            }
          } else if (i1_a=="sh_new_method1_dataset3") {
            if (i1_b=="") {
              a1_dataset3[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i2,i3,i4))
              a2_dataset3[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i2,i3,i4))
            } else if (i1_b=="_1940_no_new_sec_all") {
              b1_x_controls_all_dataset3[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i2,i3,i4))
              b2_x_controls_all_dataset3[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i2,i3,i4))
            } else if (i1_b=="_1940_no_new_sec_main") {
              c1_x_controls_all_dataset3[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i2,i3,i4))
              c2_x_controls_all_dataset3[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i2,i3,i4))
            }
          }
          j <- j + 1
        }
      }
    }  
  }
}

## individual vars + reg_second in 1940 
#**** TO-DO

# Excluding new sectors
## Creating the variables
for (i1 in c("_dataset1","_dataset2","_dataset3")) {
  for (i2 in c("b","c")) {
    for (i3 in c("cont_no_new_sec_1","cont_no_new_sec_2")) {
      assign(paste0(i2,"1_x_",i3,i1),vector(mode = "list")) 
      assign(paste0(i2,"2_x_",i3,i1),vector(mode = "list")) 
    }
  }
}

## occ and ind excluding new sectors
for (i1_a in c("sh_new_method1_dataset1_1940","sh_new_method1_dataset2_1940","sh_new_method1_dataset3_1940")) {
  for (i1_b in c("_no_new_sec_all","_no_new_sec_main")) {
    i1 <- paste0(i1_a,i1_b)
    if (i1_b=="_no_new_sec_all") i2 <- 2
    if (i1_b=="_no_new_sec_main") i2 <- 3
    j <- 1
    for (i3 in c(
      paste0(""),
      paste0(" + statefip"),
      paste0(" + statefip + ",base_1),
      paste0(" + statefip + ",base_1," + ",base_mig_2),
      paste0(" + statefip + ",base_1," + ",base_wage_1),
      paste0(" + statefip + ",base_1," + ",base_wage_2),
      paste0(" + statefip + ",base_1," + ",base_wage_1," + ",base_mig_2),
      paste0(" + statefip + ",base_1," + ",base_wage_2," + ",base_mig_2),
      paste0(" + ",base_1),
      paste0(" + ",base_1," + ",base_mig_2),
      paste0(" + ",base_1," + ",base_wage_1),
      paste0(" + ",base_1," + ",base_wage_2),
      paste0(" + ",base_1," + ",base_wage_1," + ",base_mig_2),
      paste0(" + ",base_1," + ",base_wage_2," + ",base_mig_2)
    )  ) { 
      for (i4 in c(
        paste0(""),
        paste0(" + ",regional_1_1930[[1]]," + ",indsh_var_1930[[i2]]),
        paste0(" + ",regional_1_1930[[1]]," + ",occsh_var_1930[[i2]]),
        paste0(" + ",regional_1_1930[[1]]," + ",indsh_var_1930[[i2]]," + ",occsh_var_1930[[i2]]),
        paste0(" + ",indsh_var_1930[[i2]]),
        paste0(" + ",occsh_var_1930[[i2]]),
        paste0(" + ",indsh_var_1930[[i2]]," + ",occsh_var_1930[[i2]])
      )  ) {
        
        for (i5 in c(
          paste0(""),
          paste0(" + ",reg_second_1_1930),
          paste0(" + ",reg_second_1_1930," + ",reg_second_3_1930),
          paste0(" + ",reg_second_1_1930," + ",reg_second_3_1930," + ",reg_second_4_1930)
        )   )   {
          if (i1=="sh_new_method1_dataset1_1940_no_new_sec_all") {
            b1_x_cont_no_new_sec_1_dataset1[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i3,i4,i5))
            b2_x_cont_no_new_sec_1_dataset1[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
          } else if (i1=="sh_new_method1_dataset2_1940_no_new_sec_all") {
            b1_x_cont_no_new_sec_1_dataset2[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i3,i4,i5))
            b2_x_cont_no_new_sec_1_dataset2[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
          } else if (i1=="sh_new_method1_dataset3_1940_no_new_sec_all") {
            b1_x_cont_no_new_sec_1_dataset3[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i3,i4,i5))
            b2_x_cont_no_new_sec_1_dataset3[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
            
          } else if (i1=="sh_new_method1_dataset1_1940_no_new_sec_main") {
            c1_x_cont_no_new_sec_1_dataset1[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i3,i4,i5))
            c2_x_cont_no_new_sec_1_dataset1[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
          } else if (i1=="sh_new_method1_dataset2_1940_no_new_sec_main") {
            c1_x_cont_no_new_sec_1_dataset2[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i3,i4,i5))
            c2_x_cont_no_new_sec_1_dataset2[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
          } else if (i1=="sh_new_method1_dataset3_1940_no_new_sec_main") {
            c1_x_cont_no_new_sec_1_dataset3[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i3,i4,i5))
            c2_x_cont_no_new_sec_1_dataset3[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
          }
          j <- j + 1
        }
      }
    }
  }
}

## occ, ind and other educ, pop, H excluding new sectors
for (i1_a in c("sh_new_method1_dataset1_1940","sh_new_method1_dataset2_1940","sh_new_method1_dataset3_1940")) {
  for (i1_b in c("_no_new_sec_all","_no_new_sec_main")) {
    i1 <- paste0(i1_a,i1_b)
    if (i1_b=="_no_new_sec_all") i2 <- 2
    if (i1_b=="_no_new_sec_main") i2 <- 3
    j <- 1
    for (i3 in c(
      paste0(""),
      paste0(" + statefip"),
      paste0(" + statefip + ",base_1),
      paste0(" + statefip + ",base_1," + ",base_mig_2),
      paste0(" + statefip + ",base_1," + ",base_wage_1),
      paste0(" + statefip + ",base_1," + ",base_wage_2),
      paste0(" + statefip + ",base_1," + ",base_wage_1," + ",base_mig_2),
      paste0(" + statefip + ",base_1," + ",base_wage_2," + ",base_mig_2),
      paste0(" + ",base_1),
      paste0(" + ",base_1," + ",base_mig_2),
      paste0(" + ",base_1," + ",base_wage_1),
      paste0(" + ",base_1," + ",base_wage_2),
      paste0(" + ",base_1," + ",base_wage_1," + ",base_mig_2),
      paste0(" + ",base_1," + ",base_wage_2," + ",base_mig_2)
    )  ) { 
      for (i4 in c(
        paste0(""),
        paste0(" + ",regional_1_1930[[i2]]," + ",indsh_var_1930[[i2]]),
        paste0(" + ",regional_1_1930[[i2]]," + ",occsh_var_1930[[i2]]),
        paste0(" + ",regional_1_1930[[i2]]," + ",indsh_var_1930[[i2]]," + ",occsh_var_1930[[i2]]),
        paste0(" + ",indsh_var_1930[[i2]]),
        paste0(" + ",occsh_var_1930[[i2]]),
        paste0(" + ",indsh_var_1930[[i2]]," + ",occsh_var_1930[[i2]])
      )  ) {
        
        for (i5 in c(
          paste0(""),
          paste0(" + ",reg_second_1_1930),
          paste0(" + ",reg_second_1_1930," + ",reg_second_3_1930),
          paste0(" + ",reg_second_1_1930," + ",reg_second_3_1930," + ",reg_second_4_1930)
        )   )   {
          if (i1=="sh_new_method1_dataset1_1940_no_new_sec_all") {
            b1_x_cont_no_new_sec_2_dataset1[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i3,i4,i5))
            b2_x_cont_no_new_sec_2_dataset1[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
          } else if (i1=="sh_new_method1_dataset2_1940_no_new_sec_all") {
            b1_x_cont_no_new_sec_2_dataset2[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i3,i4,i5))
            b2_x_cont_no_new_sec_2_dataset2[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
          } else if (i1=="sh_new_method1_dataset3_1940_no_new_sec_all") {
            b1_x_cont_no_new_sec_2_dataset3[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i3,i4,i5))
            b2_x_cont_no_new_sec_2_dataset3[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
            
          } else if (i1=="sh_new_method1_dataset1_1940_no_new_sec_main") {
            c1_x_cont_no_new_sec_2_dataset1[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i3,i4,i5))
            c2_x_cont_no_new_sec_2_dataset1[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
          } else if (i1=="sh_new_method1_dataset2_1940_no_new_sec_main") {
            c1_x_cont_no_new_sec_2_dataset2[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i3,i4,i5))
            c2_x_cont_no_new_sec_2_dataset2[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
          } else if (i1=="sh_new_method1_dataset3_1940_no_new_sec_main") {
            c1_x_cont_no_new_sec_2_dataset3[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i3,i4,i5))
            c2_x_cont_no_new_sec_2_dataset3[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
          }
          j <- j + 1
        }
      }
    }
  }
}

#*****!!!!!!!!!1 If we want to include all the individual vectors containing formulas in a list
# formulas <- mget( ls( pattern = "^a1_|^a2_|^b1_|^b2_|^c1_|^c2_"))


```

#### Reduced set of regressions
```{r}
for (i1 in c("_dataset1","_dataset2","_dataset3")) {
  for (i2 in c("a","b","c")) {
    if (i2=="a") {
      assign(paste0(i2,"1_red",i1),vector(mode = "list")) 
      assign(paste0(i2,"2_red",i1),vector(mode = "list"))
    } else {
      assign(paste0(i2,"1_red_x_controls_all",i1),vector(mode = "list")) 
      assign(paste0(i2,"2_red_x_controls_all",i1),vector(mode = "list")) 
    }
  }
}

for (i1_a in c("sh_new_method1_dataset1","sh_new_method1_dataset2","sh_new_method1_dataset3")) {
  for (i1_b in c("","_1940_no_new_sec_all","_1940_no_new_sec_main")) {
    i1 <- paste0(i1_a,i1_b)
    j <- 1
    for (i2 in c(
      paste0(""),
      paste0(" + ",base_1),
      paste0(" + ",base_1," + ",base_wage_1),
      paste0(" + ",base_1," + ",base_wage_2),
      paste0(" + statefip"),
      paste0(" + statefip + ",base_1),
      paste0(" + statefip + ",base_1," + ",base_wage_1),
      paste0(" + statefip + ",base_1," + ",base_wage_2)
      )  ) { 
      for (i3 in c(
        paste0(""),
        paste0(" + ",regional_1_1930[[1]]),
        paste0(" + ",regional_1_1930[[1]]," + ",indsh_var_1930[[1]]),
        paste0(" + ",regional_1_1930[[1]]," + ",occsh_var_1930[[1]]),
        paste0(" + ",regional_1_1930[[1]]," + ",indsh_var_1930[[1]]," + ",occsh_var_1930[[1]]),
        paste0(" + ",indsh_var_1930[[1]]),
        paste0(" + ",occsh_var_1930[[1]]),
        paste0(" + ",indsh_var_1930[[1]]," + ",occsh_var_1930[[1]])
        )  ) {
        
        for (i4 in c(
          paste0(""),
          paste0(" + ",reg_second_1_1930," + ",reg_second_3_1930)
          )   )   {
          if (i1_a=="sh_new_method1_dataset1") {
            if (i1_b=="") {
              a1_red_dataset1[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i2,i3,i4))
              a2_red_dataset1[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i2,i3,i4))
            } else if (i1_b=="_1940_no_new_sec_all") {
              b1_red_x_controls_all_dataset1[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i2,i3,i4))
              b2_red_x_controls_all_dataset1[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i2,i3,i4))
            } else if (i1_b=="_1940_no_new_sec_main") {
              c1_red_x_controls_all_dataset1[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i2,i3,i4))
              c2_red_x_controls_all_dataset1[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i2,i3,i4))
            }
          } else if (i1_a=="sh_new_method1_dataset2") {
            if (i1_b=="") {
              a1_red_dataset2[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i2,i3,i4))
              a2_red_dataset2[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i2,i3,i4))
            } else if (i1_b=="_1940_no_new_sec_all") {
              b1_red_x_controls_all_dataset2[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i2,i3,i4))
              b2_red_x_controls_all_dataset2[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i2,i3,i4))
            } else if (i1_b=="_1940_no_new_sec_main") {
              c1_red_x_controls_all_dataset2[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i2,i3,i4))
              c2_red_x_controls_all_dataset2[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i2,i3,i4))
            }
          } else if (i1_a=="sh_new_method1_dataset3") {
            if (i1_b=="") {
              a1_red_dataset3[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i2,i3,i4))
              a2_red_dataset3[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i2,i3,i4))
            } else if (i1_b=="_1940_no_new_sec_all") {
              b1_red_x_controls_all_dataset3[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i2,i3,i4))
              b2_red_x_controls_all_dataset3[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i2,i3,i4))
            } else if (i1_b=="_1940_no_new_sec_main") {
              c1_red_x_controls_all_dataset3[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i2,i3,i4))
              c2_red_x_controls_all_dataset3[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i2,i3,i4))
            }
          }
          j <- j + 1
        }
      }
    }  
  }
}

for (i1 in c("_dataset1","_dataset2","_dataset3")) {
  for (i2 in c("b","c")) {
    for (i3 in c("cont_no_new_sec_1","cont_no_new_sec_2")) {
      assign(paste0(i2,"1_red_x_",i3,i1),vector(mode = "list")) 
      assign(paste0(i2,"2_red_x_",i3,i1),vector(mode = "list")) 
    }
  }
}

## occ and ind excluding new sectors
for (i1_a in c("sh_new_method1_dataset1_1940","sh_new_method1_dataset2_1940","sh_new_method1_dataset3_1940")) {
  for (i1_b in c("_no_new_sec_all","_no_new_sec_main")) {
    i1 <- paste0(i1_a,i1_b)
    if (i1_b=="_no_new_sec_all") i2 <- 2
    if (i1_b=="_no_new_sec_main") i2 <- 3
    j <- 1
    for (i3 in c(
      paste0(""),
      paste0(" + ",base_1),
      paste0(" + ",base_1," + ",base_wage_1),
      paste0(" + ",base_1," + ",base_wage_2),
      paste0(" + statefip"),
      paste0(" + statefip + ",base_1),
      paste0(" + statefip + ",base_1," + ",base_wage_1),
      paste0(" + statefip + ",base_1," + ",base_wage_2)
    )  ) { 
      for (i4 in c(
        paste0(""),
        paste0(" + ",regional_1_1930[[1]]),
        paste0(" + ",regional_1_1930[[1]]," + ",indsh_var_1930[[i2]]),
        paste0(" + ",regional_1_1930[[1]]," + ",occsh_var_1930[[i2]]),
        paste0(" + ",regional_1_1930[[1]]," + ",indsh_var_1930[[i2]]," + ",occsh_var_1930[[i2]]),
        paste0(" + ",indsh_var_1930[[i2]]),
        paste0(" + ",occsh_var_1930[[i2]]),
        paste0(" + ",indsh_var_1930[[i2]]," + ",occsh_var_1930[[i2]])
      )  ) {
        
        for (i5 in c(
          paste0(""),
          paste0(" + ",reg_second_1_1930," + ",reg_second_3_1930)
        )   )   {
          if (i1=="sh_new_method1_dataset1_1940_no_new_sec_all") {
            b1_red_x_cont_no_new_sec_1_dataset1[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i3,i4,i5))
            b2_red_x_cont_no_new_sec_1_dataset1[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
          } else if (i1=="sh_new_method1_dataset2_1940_no_new_sec_all") {
            b1_red_x_cont_no_new_sec_1_dataset2[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i3,i4,i5))
            b2_red_x_cont_no_new_sec_1_dataset2[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
          } else if (i1=="sh_new_method1_dataset3_1940_no_new_sec_all") {
            b1_red_x_cont_no_new_sec_1_dataset3[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i3,i4,i5))
            b2_red_x_cont_no_new_sec_1_dataset3[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
            
          } else if (i1=="sh_new_method1_dataset1_1940_no_new_sec_main") {
            c1_red_x_cont_no_new_sec_1_dataset1[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i3,i4,i5))
            c2_red_x_cont_no_new_sec_1_dataset1[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
          } else if (i1=="sh_new_method1_dataset2_1940_no_new_sec_main") {
            c1_red_x_cont_no_new_sec_1_dataset2[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i3,i4,i5))
            c2_red_x_cont_no_new_sec_1_dataset2[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
          } else if (i1=="sh_new_method1_dataset3_1940_no_new_sec_main") {
            c1_red_x_cont_no_new_sec_1_dataset3[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i3,i4,i5))
            c2_red_x_cont_no_new_sec_1_dataset3[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
          }
          j <- j + 1
        }
      }
    }
  }
}

## occ, ind and other educ, pop, H excluding new sectors
for (i1_a in c("sh_new_method1_dataset1_1940","sh_new_method1_dataset2_1940","sh_new_method1_dataset3_1940")) {
  for (i1_b in c("_no_new_sec_all","_no_new_sec_main")) {
    i1 <- paste0(i1_a,i1_b)
    if (i1_b=="_no_new_sec_all") i2 <- 2
    if (i1_b=="_no_new_sec_main") i2 <- 3
    j <- 1
    for (i3 in c(
      paste0(""),
      paste0(" + ",base_1),
      paste0(" + ",base_1," + ",base_wage_1),
      paste0(" + ",base_1," + ",base_wage_2),
      paste0(" + statefip"),
      paste0(" + statefip + ",base_1),
      paste0(" + statefip + ",base_1," + ",base_wage_1),
      paste0(" + statefip + ",base_1," + ",base_wage_2)
    )  ) { 
      for (i4 in c(
        paste0(""),
        paste0(" + ",regional_1_1930[[i2]]),
        paste0(" + ",regional_1_1930[[i2]]," + ",indsh_var_1930[[i2]]),
        paste0(" + ",regional_1_1930[[i2]]," + ",occsh_var_1930[[i2]]),
        paste0(" + ",regional_1_1930[[i2]]," + ",indsh_var_1930[[i2]]," + ",occsh_var_1930[[i2]]),
        paste0(" + ",indsh_var_1930[[i2]]),
        paste0(" + ",occsh_var_1930[[i2]]),
        paste0(" + ",indsh_var_1930[[i2]]," + ",occsh_var_1930[[i2]])
      )  ) {
        
        for (i5 in c(
          paste0(""),
          paste0(" + ",reg_second_1_1930," + ",reg_second_3_1930)
        )   )   {
          if (i1=="sh_new_method1_dataset1_1940_no_new_sec_all") {
            b1_red_x_cont_no_new_sec_2_dataset1[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i3,i4,i5))
            b2_red_x_cont_no_new_sec_2_dataset1[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
          } else if (i1=="sh_new_method1_dataset2_1940_no_new_sec_all") {
            b1_red_x_cont_no_new_sec_2_dataset2[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i3,i4,i5))
            b2_red_x_cont_no_new_sec_2_dataset2[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
          } else if (i1=="sh_new_method1_dataset3_1940_no_new_sec_all") {
            b1_red_x_cont_no_new_sec_2_dataset3[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i3,i4,i5))
            b2_red_x_cont_no_new_sec_2_dataset3[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
            
          } else if (i1=="sh_new_method1_dataset1_1940_no_new_sec_main") {
            c1_red_x_cont_no_new_sec_2_dataset1[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i3,i4,i5))
            c2_red_x_cont_no_new_sec_2_dataset1[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
          } else if (i1=="sh_new_method1_dataset2_1940_no_new_sec_main") {
            c1_red_x_cont_no_new_sec_2_dataset2[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i3,i4,i5))
            c2_red_x_cont_no_new_sec_2_dataset2[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
          } else if (i1=="sh_new_method1_dataset3_1940_no_new_sec_main") {
            c1_red_x_cont_no_new_sec_2_dataset3[[j]] <- as.formula(paste(i1," ~ new_sec_all_1930",i3,i4,i5))
            c2_red_x_cont_no_new_sec_2_dataset3[[j]] <- as.formula(paste(i1," ~ new_sec_main_1930 + new_sec_serv_1930",i3,i4,i5))
          }
          j <- j + 1
        }
      }
    }
  }
}

#*****!!!!!!!!!1 If we want to include all the individual vectors containing formulas in a list
# formulas <- mget( ls( pattern = "^a1_|^a2_|^b1_|^b2_|^c1_|^c2_"))

```


#### 1.3.5 Runing the regressions
##### 1.3.5.1. Main Regressions
 - a, b, c
 - dataset1, dataset2, dataset3
 - _x_controls_all
 - _x_cont_no_new_sec_1,x_cont_no_new_sec_2
```{r}
for (i1 in c("a","b","c")){
  for (i2 in c("_dataset1","_dataset2","_dataset3")) {
    # The name is too long to use it as a Sheet's name, reduce it
    if (i2=="_dataset1") {            i2t <- "_dt1"
    } else if (i2=="_dataset2") {     i2t <- "_dt2"
    } else if (i2=="_dataset3") {     i2t <- "_dt3"
    }
    if (i1=="a") {
      formula <- eval(as.name(paste0(i1,"1_red",i2)))
      assign(
        paste0("coef_",i1,"1_red",i2t),
        f_regressions (arg_formula=formula,arg_data=census_sample_1940_countynhg_1910[perwt_1940 > 10000],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occ1940)
      )
      formula <- eval(as.name(paste0(i1,"2_red",i2)))
      assign(
        paste0("coef_",i1,"1_red",i2t),
        f_regressions (arg_formula=formula,arg_data=census_sample_1940_countynhg_1910[perwt_1940 > 10000],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occ1940)
      )
    } else if (i1=="b") {
      for (i3 in c("_red_x_controls_all","_red_x_cont_no_new_sec_1","_red_x_cont_no_new_sec_2")) {
        formula <- eval(as.name(paste0(i1,"1",i3,i2)))
        assign(
          paste0("coef_",i1,"1",i3,i2t),
         f_regressions (arg_formula=formula,arg_data=census_sample_1940_countynhg_1910[perwt_1940 > 1000],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occ1940)
        )
        formula <- eval(as.name(paste0(i1,"2",i3,i2)))
        assign(
          paste0("coef_",i1,"2",i3,i2t),
          f_regressions (arg_formula=formula,arg_data=census_sample_1940_countynhg_1910[perwt_1940 > 10000],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occ1940)
        )
      }
    } else if (i1=="c") {
      for (i3 in c("_red_x_controls_all","_red_x_cont_no_new_sec_1","_red_x_cont_no_new_sec_2")) {
        formula <- eval(as.name(paste0(i1,"1",i3,i2)))
        assign(
          paste0("coef_",i1,"1",i3,i2t),
         f_regressions (arg_formula=formula,arg_data=census_sample_1940_countynhg_1910[perwt_1940 > 10000],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occ1940)
        )
        formula <- eval(as.name(paste0(i1,"2",i3,i2)))
        assign(
          paste0("coef_",i1,"2",i3,i2t),
          f_regressions (arg_formula=formula,arg_data=census_sample_1940_countynhg_1910[perwt_1940 > 10000],arg_weights=perwt_ID,method="lm_robust",arg_clusters=occ1940)
        )
      }
    }
  }
}

```

##### Saving results
###### Creating vectors for the different coefficient tables
```{r}
# Vector with the name of all the coefficient objects
vect_coef_a <- vect_coef_b <- vect_coef_c <- vector(mode="character")
vect_coef_a <- 
  c( paste0("a1_red",c("_dt1","_dt2","_dt3")),
     paste0("a2_red",c("_dt1","_dt2","_dt3"))
  )
for (i1 in c("1_red_x_controls_all","2_red_x_controls_all","1_red_x_cont_no_new_sec_1","2_red_x_cont_no_new_sec_1","1_red_x_cont_no_new_sec_2","2_red_x_cont_no_new_sec_2")) {
  for (i2 in c("b","c")) {
    if (i2=="b") {
      vect_coef_b <- 
        c(
          vect_coef_b,
          paste0(paste0(i2,i1),c("_dt1","_dt2","_dt3"))
        )
    } else if (i2=="c") {
      vect_coef_c <- 
        c(
          vect_coef_c,
          paste0(paste0(i2,i1),c("_dt1","_dt2","_dt3"))
        )
    }
  }
}

# Vector with the names of all the unique variables in all the coefficient vectors
#NOTE: paste0 creates a character of the form c(a1_red_dataset1$rn,a1_red_dataset2$rn), and eval(parse(text=...)) evaluates this vector
names_vector <- 
  unique( 
    eval(parse(
      text = 
        paste0(
          "c(",
          paste0( paste0("coef_",vect_coef_a,"$rn"),collapse=","),
          paste0( paste0("coef_",vect_coef_b,"$rn"),collapse=","),
          paste0( paste0("coef_",vect_coef_c,"$rn"),collapse=","),
          ")"
          )
      )) 
    )
# NOTE: We could further reduce the set of variables that we want to display

# Ordering variables
Order <- list(
            c(grep("^new_sec_all_1930",names_vector,value=TRUE)),
            c(grep("^new_sec_main_1930",names_vector,value=TRUE)),
            c(grep("^new_sec_serv_1930",names_vector,value=TRUE)),
            c(grep("^H_",names_vector,value=TRUE)),
            c(grep("perwt_",names_vector,value=TRUE)),
            c(grep("^sh_lit",names_vector,value=TRUE)),
            c(grep("^sh_occ1950_main",names_vector,value=TRUE)),
            c("adj.r2"),c("nobs"),
            c(grep("^statefip10",names_vector,value=TRUE)),
            c(grep("^sh_ind1950_main",names_vector,value=TRUE)),
            c(grep("^sh_age_16_49",names_vector,value=TRUE)),
            c(grep("^sh_age_more5",names_vector,value=TRUE)),
            c(grep("^sh_labforce_",names_vector,value=TRUE)),
            c(grep("^sh_unemp_",names_vector,value=TRUE)),
            c(grep("^sh_wrkwage_",names_vector,value=TRUE)),
            c(grep("^sh_mig_us_",names_vector,value=TRUE)),
            c(grep("^sh_mig_ab_",names_vector,value=TRUE))
            )
```

###### Exporting results
```{r}
# Dependent variable and individual var in 1940, rest in 1930
## Coefficients that don't exclude any workers 
list <- vector(mode="list"); j<- 1
for (i in c(vect_coef_a)) {
  X <- eval(parse(text=i))
  list[[j]] <- f_order_reg(X[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn)[,!c("variable")]
  j <- j+1
}

wrapper_Excel(
  list,
  as.list(vector_coef_a),
  paste0(main_directory,"R - Processing data/output/Tables/reg_all_1940_metarea_1940.xlsx")
)

## Coefficients that exclude workers in all new sectors
list <- vector(mode="list"); j<- 1
for (i in c(vect_coef_b)) {
  X <- eval(parse(text=i))
  list[[j]] <- f_order_reg(X[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn)[,!c("variable")]
  j <- j+1
}

wrapper_Excel(
  list,
  as.list(vect_coef_b),
  paste0(main_directory,"R - Processing data/output/Tables/reg_no_new_sec_1940_metarea_1940.xlsx")
)

## Coefficients that exclude workers in all new main sectors
list <- vector(mode="list"); j<- 1
for (i in c(vect_coef_c)) {
  X <- eval(parse(text=i))
  list[[j]] <- f_order_reg(X[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn)[,!c("variable")]
  j <- j+1
}

wrapper_Excel(
  list,
  as.list(vect_coef_c),
  paste0(main_directory,"R - Processing data/output/Tables/reg_no_new_sec_main_1940_metarea_1940.xlsx")
)
```

#### 1.5.2.2 Robustness Regressions
```{r}
# Excluding regions with the highest shares of New Sectors 
#* use rank_new_sec_1920>=_ To work only with certain regions
## 2

## 4
```

###### Saving results
```{r}

```


## 3. Exercises to better understand some of the regression results


# Part 7. Regressions working directly with the regional level variables
***!!! TO-DO: 
- Regressions for metarea
- Robustness Checks


## Loading packages and erasing the workspace (make sure to have loaded f_load_pk)
```{r}
rm(list = setdiff(ls(),c(lsf.str(),"main_directory") ))
f_load_pk()
```

## 1. Regressions at the countynhg_1910 level
### 1.1. Construct regional level database
```{r}
# 1940
census_sample_1940_countynhg_1910 <-read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1940_agg_countynhg_1910.fst"),as.data.table=TRUE)
census_sample_1940_countynhg_1910 <- census_sample_1940_countynhg_1910[,`:=`(sh_age_less16 = sh_age_main_0+sh_age_main_1,sh_age_16_49 = sh_age_main_2+sh_age_main_3+sh_age_main_4+sh_age_main_5,sh_age_more50 = sh_age_main_6+sh_age_main_7)][,`:=`(new_sec_all=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466 +sh_new_sector_ind1950_556+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816 + sh_new_sector_ind1950_856,
                              new_sec_main=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466+ sh_new_sector_ind1950_856,
                              new_sec_serv=sh_new_sector_ind1950_556+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816)]
cols <- grep("^(?!.*sh_new_sector)(?!.*sh_age_main)",names(census_sample_1940_countynhg_1910),value=TRUE,perl=TRUE)
census_sample_1940_countynhg_1910 <- census_sample_1940_countynhg_1910[,cols,with=FALSE]
cols <- names(census_sample_1940_countynhg_1910[,!c("countynhg_1910")])
setnames(census_sample_1940_countynhg_1910,cols,paste0(cols,"_1940"))

temp <- read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1940_agg_countynhg_1910_no_new_sec_all.fst"),as.data.table=TRUE)
cols <- grep("^sh_m_|^sh_f_|^statefip",names(temp),value=TRUE)
temp <- temp[,!cols,with=FALSE][,`:=`(sh_age_less16 = sh_age_main_0+sh_age_main_1,sh_age_16_49 = sh_age_main_2+sh_age_main_3+sh_age_main_4+sh_age_main_5,sh_age_more50 = sh_age_main_6+sh_age_main_7)]
cols <- grep("^(?!.*sh_age_main)",names(temp),value=TRUE,perl=TRUE)
temp <- temp[,cols,with=FALSE]

cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_1940_no_new_sec_all"))

census_sample_1940_countynhg_1910 <- merge(census_sample_1940_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)

temp <- read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1940_agg_countynhg_1910_no_new_sec_main.fst"),as.data.table=TRUE)
cols <- grep("^sh_m_|^sh_f_|^statefip",names(temp),value=TRUE)
temp <- temp[,!cols,with=FALSE][,`:=`(sh_age_less16 = sh_age_main_0+sh_age_main_1,sh_age_16_49 = sh_age_main_2+sh_age_main_3+sh_age_main_4+sh_age_main_5,sh_age_more50 = sh_age_main_6+sh_age_main_7)]
cols <- grep("^(?!.*sh_age_main)",names(temp),value=TRUE,perl=TRUE)
temp <- temp[,cols,with=FALSE]

cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_1940_no_new_sec_main"))

census_sample_1940_countynhg_1910 <- merge(census_sample_1940_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)

# 1930
temp <-read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1930_agg_countynhg_1910.fst"),as.data.table=TRUE)
cols <- grep("^sh_m_|^sh_f_|^statefip|^sh_base|^sh_red",names(temp),value=TRUE)
temp <- temp[,!cols,with=FALSE][,`:=`(sh_age_less16 = sh_age_main_0+sh_age_main_1,sh_age_16_49 = sh_age_main_2+sh_age_main_3+sh_age_main_4+sh_age_main_5,sh_age_more50 = sh_age_main_6+sh_age_main_7)][,`:=`(new_sec_all=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466 +sh_new_sector_ind1950_556+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816 + sh_new_sector_ind1950_856,
                              new_sec_main=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466+ sh_new_sector_ind1950_856,
                              new_sec_serv=sh_new_sector_ind1950_556+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816)]
cols <- grep("^(?!.*sh_new_sector)(?!.*sh_age_main)",names(temp),value=TRUE,perl=TRUE)
temp <- temp[,cols,with=FALSE]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_1930"))

census_sample_1940_countynhg_1910 <- merge(census_sample_1940_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)

temp <-read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1930_agg_countynhg_1910_no_new_sec_all.fst"),as.data.table=TRUE)
cols <- grep("^sh_m_|^sh_f_|^statefip|^sh_base|^sh_red",names(temp),value=TRUE)
temp <- temp[,!cols,with=FALSE][,`:=`(sh_age_less16 = sh_age_main_0+sh_age_main_1,sh_age_16_49 = sh_age_main_2+sh_age_main_3+sh_age_main_4+sh_age_main_5,sh_age_more50 = sh_age_main_6+sh_age_main_7)]
cols <- grep("^(?!.*sh_age_main)",names(temp),value=TRUE,perl=TRUE)
temp <- temp[,cols,with=FALSE]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_1930_no_new_sec_all"))

census_sample_1940_countynhg_1910 <- merge(census_sample_1940_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)

temp <-read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1930_agg_countynhg_1910_no_new_sec_main.fst"),as.data.table=TRUE)
cols <- grep("^sh_m_|^sh_f_|^statefip|^sh_base|^sh_red",names(temp),value=TRUE)
temp <- temp[,!cols,with=FALSE][,`:=`(sh_age_less16 = sh_age_main_0+sh_age_main_1,sh_age_16_49 = sh_age_main_2+sh_age_main_3+sh_age_main_4+sh_age_main_5,sh_age_more50 = sh_age_main_6+sh_age_main_7)]
cols <- grep("^(?!.*sh_age_main)",names(temp),value=TRUE,perl=TRUE)
temp <- temp[,cols,with=FALSE]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_1930_no_new_sec_main"))

census_sample_1940_countynhg_1910 <- merge(census_sample_1940_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)
```


### 1.2 Creating some variables for regressions
```{r}
# Converting state to a factor variable
census_sample_1940_countynhg_1910 <- census_sample_1940_countynhg_1910[,statefip_1940:=as.factor(statefip_1940)]  

# Base
base_1_1930 <- paste0(c("sh_age_16_49_1930","sh_age_more50_1930","sh_male_1930","sh_race_2_1930","sh_race_3_1930","sh_urban_1930","sh_mig_us_1930","sh_mig_ab_1930"),collapse=" + ")
base_2_1930 <- paste0(c("sh_labforce_1930","sh_unemp_1930","sh_wrkwage_1930"),collapse=" + ")
base_3_1930 <- paste0(c("sh_marst_2_1930","sh_marst_3_1930"),collapse=" + ")

base_1_1940 <- paste0(c("sh_age_16_49_1940","sh_age_more50_1940","sh_male_1940","sh_race_2_1940","sh_race_3_1940","sh_urban_1940","sh_mig_us_1940","sh_mig_ab_1940"),collapse=" + ")
base_2_1940 <- paste0(c("sh_labforce_1940","sh_unemp_1940","sh_wrkwage_1940"),collapse=" + ")
base_3_1940 <- paste0(c("sh_marst_2_1940","sh_marst_3_1940"),collapse=" + ")
base_4_1940 <- paste0(c("av_incwage_1940"),collapse=" + ")
base_5_1940 <- paste0(c("av_incwage_1940","av_wkwage_1940"),collapse=" + ")

# Regional
j <- 1; regional_1_1930 <- indsh_var_1930 <- occsh_var_1930 <- regional_1_1940 <- indsh_var_1940 <- occsh_var_1940 <- vector(mode = "list")
for (i in c("","_no_new_sec_all","_no_new_sec_main")) {
  regional_1_1930[[j]] <- paste0(paste0(paste0(c("sh_lit_1930","H_1930"),i),collapse=" + ")," + log(perwt_1930",i,")" )
  indsh_var_1930[[j]] <- paste0(paste0(grep("^sh_ind1950_main_[^1]_1930$",names(census_sample_1940_countynhg_1910),value=TRUE),i),collapse=" + ")
  occsh_var_1930[[j]] <- paste0(paste0(grep("^sh_occ1950_main_[^0].+_1930$",names(census_sample_1940_countynhg_1910),value=TRUE),i),collapse=" + ")
  regional_1_1940[[j]] <- paste0(paste0(paste0(c("sh_educ_main_2_1940","sh_educ_main_2_1940","H_1940$"),i),collapse=" + ")," + log(perwt_1940",i,")" )
  indsh_var_1940[[j]] <- paste0(paste0(grep("^sh_ind1950_main_[^1]_1940$",names(census_sample_1940_countynhg_1910),value=TRUE),i),collapse=" + ")
  occsh_var_1940[[j]] <- paste0(paste0(grep("^sh_occ1950_main_[^0].+_1940$",names(census_sample_1940_countynhg_1910),value=TRUE),i),collapse=" + ")
  j <- j+1
}


```

### 1.3. Regressions
1. base_individual + ind1950_main + sh_lit + log(perwt) + sh_new sectors (3 different cases)
2. base_individual + ind1950_main + sh_lit + log(perwt) + sh_new sectors (3 different cases) + sh_ind1950_main
3. base_individual + ind1950_main + sh_lit + log(perwt) + sh_new sectors (3 different cases) + sh_ind1950_main + sh_occ1950_main

Where base:   - (1) sh_age (three different groups), sh_male, sh_race, sh_urban, sh_mig_us, sh_mig_ab,   (maybe) sh_farm
              - (2) sh_labforce, sh_unenemp, sh_wrkwage
              - (3) sh_m_mig_us, sh_m_mig_ab, sh_f_mig_us, sh_f_mig_ab, sh_marst
Fixed effects:- statefip    
            
"Regional":   - (1) sh_lit, H, log(perwt)
              - (2) sh_occ1950_main, sh_ind1950_main

New Sector:   - new_sec_all, new_sec_main, new_sec_serv

New Work:     - sh_red_tit, sh_base_tit

It is not very clear what year should we use for the different variables. For the new sector variables the year should be 1920 and probably also for the regional variables. For the base variables I'm not entirely sure.
Regarding the variables excluding workers in new sectors, for sure we should do that for the New Work variables. We could also try to do that for the regional variables.

#### 1.3.1 Main Regressions
##### 1.3.1.1 Creating the different formulas for the regressions
- a1_...: share of new jobs constructed using all the workers - main regressor: new_sec_all
- a2_...: share of new jobs constructed using all the workers - main regressor: new_sec_main + new_sec_serv
- b1_...: share of new jobs constructed excluding workers in new sectors - main regressor: new_sec_all
- b2_...: share of new jobs constructed excluding workers in new sectors - main regressor: new_sec_main + new_sec_serv
- c1_...: share of new jobs constructed excluding workers in new MAIN sectors - main regressor: new_sec_all
- c2_...: share of new jobs constructed excluding workers in new MAIN sectors - main regressor: new_sec_main + new_sec_serv

***!!! NOTE: The main set of regressions uses the "base variables" in the year 1940
***!!! TO-DO: Change the way the different regressions are created to avoid loops. This was done already in one of the chunks in this section using expand.grid
```{r}
# All controls use all the workers
for (i1 in c(paste0("_method1_dataset",c(1,2,3)),paste0("_method2_dataset",c(1,2,3))) ) {
  for (i4 in c("","_no_new_sec_all","_no_new_sec_main")) {
    temp1 <- temp2 <- vector(mode = "list")
    j <- 1
    for (i2 in c(
      paste0(""),
      paste0(" + statefip_1940"),
      paste0(" + statefip_1940 + ",base_1_1940),
      paste0(" + statefip_1940 + ",base_1_1940," + ",base_2_1940),
      paste0(" + statefip_1940 + ",base_1_1940," + ",base_2_1940," + ",base_5_1940),
      paste0(" + ",base_1_1940),
      paste0(" + ",base_1_1940," + ",base_2_1940),
      paste0(" + ",base_1_1940," + ",base_2_1940," + ",base_5_1940)
      )  ) { 
      for (i3 in c(
        paste0(""),
        paste0(" + ",regional_1_1930[[1]]),
        paste0(" + ",regional_1_1930[[1]]," + ",indsh_var_1930[[1]]),
        paste0(" + ",regional_1_1930[[1]]," + ",occsh_var_1930[[1]]),
        paste0(" + ",regional_1_1930[[1]]," + ",indsh_var_1930[[1]]," + ",occsh_var_1930[[1]]),
        paste0(" + ",indsh_var_1930[[1]]),
        paste0(" + ",occsh_var_1930[[1]]),
        paste0(" + ",indsh_var_1930[[1]]," + ",occsh_var_1930[[1]])
        )  ) {
          temp1[[j]] <- as.formula(paste0("sh_new",i1,"_1940",i4," ~ new_sec_all_1930",i2,i3))
          temp2[[j]] <- as.formula(paste0("sh_new",i1,"_1940",i4," ~ new_sec_main_1930 + new_sec_serv_1930",i2,i3))
          j <- j + 1
      }
    }
    if (i4=="") {
      assign(
        paste0("a1",i1),
        temp1
        )
      assign(
        paste0("a2",i1),
        temp2
        )
    } else if (i4=="_no_new_sec_all") {
      assign(
        paste0("b1_X_all",i1),
        temp1
        )
      assign(
        paste0("b2_X_all",i1),
        temp2
        )
    } else if (i4=="_no_new_sec_main") {
      assign(
        paste0("c1_X_all",i1),
        temp1
        )
      assign(
        paste0("c2_X_all",i1),
        temp2
        )
    }
  }
}

# For the industry and occ variables we exclude the workers in the main sectors
for (i1 in c(paste0("_method1_dataset",c(1,2,3)),paste0("_method2_dataset",c(1,2,3)))) {
  for (i4 in c("_no_new_sec_all","_no_new_sec_main")) {
    temp1 <- temp2 <- vector(mode = "list")
    if (i4=="_no_new_sec_all") { i5 <- 2
    } else if (i4=="_no_new_sec_main") { i5 <- 3
    }
    j <- 1
    for (i2 in c(
      paste0(""),
      paste0(" + statefip_1940"),
      paste0(" + statefip_1940 + ",base_1_1940),
      paste0(" + statefip_1940 + ",base_1_1940," + ",base_2_1940),
      paste0(" + statefip_1940 + ",base_1_1940," + ",base_2_1940," + ",base_5_1940),
      paste0(" + ",base_1_1940),
      paste0(" + ",base_1_1940," + ",base_2_1940),
      paste0(" + ",base_1_1940," + ",base_2_1940," + ",base_5_1940)
      )  ) { 
      for (i3 in c(
        paste0(""),
        paste0(" + ",regional_1_1930[[1]]),
        paste0(" + ",regional_1_1930[[1]]," + ",indsh_var_1930[[i5]]),
        paste0(" + ",regional_1_1930[[1]]," + ",occsh_var_1930[[i5]]),
        paste0(" + ",regional_1_1930[[1]]," + ",indsh_var_1930[[i5]]," + ",occsh_var_1930[[i5]]),
        paste0(" + ",indsh_var_1930[[i5]]),
        paste0(" + ",occsh_var_1930[[i5]]),
        paste0(" + ",indsh_var_1930[[i5]]," + ",occsh_var_1930[[i5]])
        )  ) {
          temp1[[j]] <- as.formula(paste0("sh_new",i1,"_1940",i4," ~ new_sec_all_1930",i2,i3))
          temp2[[j]] <- as.formula(paste0("sh_new",i1,"_1940",i4," ~ new_sec_main_1930 + new_sec_serv_1930",i2,i3))
          j <- j + 1
      }
    }
    if (i4=="_no_new_sec_all") {
      assign(
        paste0("b1_X_no_nsec_1",i1),
        temp1
        )
      assign(
        paste0("b2_X_no_nsec_1",i1),
        temp2
        )
    } else if (i4=="_no_new_sec_main") {
      assign(
        paste0("c1_X_no_nsec_1",i1),
        temp1
        )
      assign(
        paste0("c2_X_no_nsec_1",i1),
        temp2
        )
    }
  }
}

# Ind, occ and regional variables exclude the workers in the new sectors
for (i2 in c("_no_new_sec_all","_no_new_sec_main")) {
  if (i2=="_no_new_sec_all") { i3 <- 2
  } else if (i2=="_no_new_sec_main") { i3 <- 3
  }
  # Vector with all the different combinations of regressions
  vector <- 
    as.data.table(expand.grid(
      c(
        paste0(""),
        paste0(" + statefip_1940"),
        paste0(" + statefip_1940 + ",base_1_1940),
        paste0(" + statefip_1940 + ",base_1_1940," + ",base_2_1940),
        paste0(" + statefip_1940 + ",base_1_1940," + ",base_2_1940," + ",base_5_1940),
        paste0(" + ",base_1_1940),
        paste0(" + ",base_1_1940," + ",base_2_1940),
        paste0(" + ",base_1_1940," + ",base_2_1940," + ",base_5_1940)
      ),
      c(
        paste0(""),
        paste0(" + ",regional_1_1930[[i3]]),
        paste0(" + ",regional_1_1930[[i3]]," + ",indsh_var_1930[[i3]]),
        paste0(" + ",regional_1_1930[[i3]]," + ",occsh_var_1930[[i3]]),
        paste0(" + ",regional_1_1930[[i3]]," + ",indsh_var_1930[[i3]]," + ",occsh_var_1930[[i3]]),
        paste0(" + ",indsh_var_1930[[i3]]),
        paste0(" + ",occsh_var_1930[[i3]]),
        paste0(" + ",indsh_var_1930[[i3]]," + ",occsh_var_1930[[i3]])
      )
    ))[,p:=paste0(Var1,Var2)]$p
  
  for (i1 in c(paste0("_method1_dataset",c(1,2,3)),paste0("_method2_dataset",c(1,2,3))) ) {
    if (i2=="_no_new_sec_all") {
      assign(
        paste0("b1_X_no_nsec_2",i1),
        lapply(paste0("sh_new",i1,"_1940",i2," ~ new_sec_all_1930",vector),as.formula)
      )
      assign(
        paste0("b2_X_no_nsec_2",i1),
        lapply(paste0("sh_new",i1,"_1940",i2," ~ new_sec_main_1930 + new_sec_serv_1930",vector),as.formula)
      )
    } else if (i2=="_no_new_sec_main") {
      assign(
        paste0("c1_X_no_nsec_2",i1),
        lapply(paste0("sh_new",i1,"_1940",i2," ~ new_sec_all_1930",vector),as.formula)
      )
      assign(
        paste0("c2_X_no_nsec_2",i1),
        lapply(paste0("sh_new",i1,"_1940",i2," ~ new_sec_main_1930 + new_sec_serv_1930",vector),as.formula)
      )
    }
  }
}

```

##### 1.3.1.2. Main Regressions
 - a, b, c
 - dataset1, dataset2, dataset3
 - _x_controls_all
 - _x_cont_no_new_sec_1,x_cont_no_new_sec_2
```{r}
for (i1 in c("a","b","c")){
  for (method in c(1,2)) {
    for (dt in c(1,2,3)) {
      # The name is too long to use it as a Sheet's name, reduce it
      if (i1=="a") {
        # NO weights
        formula <- eval(as.name(paste0(i1,"1_method",method,"_dataset",dt)))
        assign(
          paste0("coef_",i1,"1_mt",method,"_dt",dt),
          f_regressions(arg_formula=formula,arg_data=census_sample_1940_countynhg_1910[perwt_1940 > 10000],method="lm",by_iter = 30)
        )
        formula <- eval(as.name(paste0(i1,"2_method",method,"_dataset",dt)))
        assign(
          paste0("coef_",i1,"2_mt",method,"_dt",dt),
          f_regressions(arg_formula=formula,arg_data=census_sample_1940_countynhg_1910[perwt_1940 > 10000],method="lm",by_iter = 30)
        )
        # WITH weights
        formula <- eval(as.name(paste0(i1,"1_method",method,"_dataset",dt)))
        assign(
          paste0("coef_",i1,"1_mt",method,"_dt",dt,"_wt"),
          f_regressions(arg_formula=formula,arg_data=census_sample_1940_countynhg_1910[perwt_1940 > 10000],method="lm",arg_weights = perwt_1940,by_iter = 30)
        )
        formula <- eval(as.name(paste0(i1,"2_method",method,"_dataset",dt)))
        assign(
          paste0("coef_",i1,"2_mt",method,"_dt",dt,"_wt"),
          f_regressions(arg_formula=formula,arg_data=census_sample_1940_countynhg_1910[perwt_1940 > 10000],method="lm",arg_weights = perwt_1940,by_iter = 30)
        )
      } else if (i1=="b") {
        for (i3 in c("_X_all","_X_no_nsec_1","_X_no_nsec_2")) {
          # NO weights
          formula <- eval(as.name(paste0(i1,"1",i3,"_method",method,"_dataset",dt))) 
          assign(
            paste0("coef_",i1,"1",i3,"_mt",method,"_dt",dt),
            f_regressions(arg_formula=formula,arg_data=census_sample_1940_countynhg_1910[perwt_1940 > 10000],method="lm",by_iter = 30)
          )
          formula <- eval(as.name(paste0(i1,"2",i3,"_method",method,"_dataset",dt))) 
          assign(
            paste0("coef_",i1,"2",i3,"_mt",method,"_dt",dt),
            f_regressions(arg_formula=formula,arg_data=census_sample_1940_countynhg_1910[perwt_1940 > 10000],method="lm",by_iter = 30)
          )
          #WITH weights
          formula <- eval(as.name(paste0(i1,"1",i3,"_method",method,"_dataset",dt))) 
          assign(
            paste0("coef_",i1,"1",i3,"_mt",method,"_dt",dt,"_wt"),
            f_regressions(arg_formula=formula,arg_data=census_sample_1940_countynhg_1910[perwt_1940 > 10000],method="lm",arg_weights = perwt_1940,by_iter = 30)
          )
          formula <- eval(as.name(paste0(i1,"2",i3,"_method",method,"_dataset",dt))) 
          assign(
            paste0("coef_",i1,"2",i3,"_mt",method,"_dt",dt,"_wt"),
            f_regressions(arg_formula=formula,arg_data=census_sample_1940_countynhg_1910[perwt_1940 > 10000],method="lm",arg_weights = perwt_1940,by_iter = 30)
          )
        }
      } else if (i1=="c") {
        for (i3 in c("_X_all","_X_no_nsec_1","_X_no_nsec_2")) {
          # NO Weights
          formula <- eval(as.name(paste0(i1,"1",i3,"_method",method,"_dataset",dt))) 
          assign(
            paste0("coef_",i1,"1",i3,"_mt",method,"_dt",dt),
            f_regressions(arg_formula=formula,arg_data=census_sample_1940_countynhg_1910[perwt_1940 > 10000],method="lm",by_iter = 30)
          )
          formula <- eval(as.name(paste0(i1,"2",i3,"_method",method,"_dataset",dt))) 
          assign(
            paste0("coef_",i1,"2",i3,"_mt",method,"_dt",dt),
            f_regressions(arg_formula=formula,arg_data=census_sample_1940_countynhg_1910[perwt_1940 > 10000],method="lm",by_iter = 30)
          )
          # WITH weights
          formula <- eval(as.name(paste0(i1,"1",i3,"_method",method,"_dataset",dt))) 
          assign(
            paste0("coef_",i1,"1",i3,"_mt",method,"_dt",dt,"_wt"),
            f_regressions(arg_formula=formula,arg_data=census_sample_1940_countynhg_1910[perwt_1940 > 10000],method="lm",arg_weights = perwt_1940,by_iter = 30)
          )
          formula <- eval(as.name(paste0(i1,"2",i3,"_method",method,"_dataset",dt))) 
          assign(
            paste0("coef_",i1,"2",i3,"_mt",method,"_dt",dt,"_wt"),
            f_regressions(arg_formula=formula,arg_data=census_sample_1940_countynhg_1910[perwt_1940 > 10000],method="lm",arg_weights = perwt_1940,by_iter = 30)
          )
        }
      }
    }
  }
}
```


##### Saving results
```{r}
vect_coef_a <- vect_coef_b <- vect_coef_c <- vector(mode="character")
vect_coef_a <- 
  c( paste0("a1_mt1",paste0("_dt",c(1,2,3))),
     paste0("a1_mt2",paste0("_dt",c(1,2,3))),
     paste0("a2_mt1",paste0("_dt",c(1,2,3))),
     paste0("a2_mt2",paste0("_dt",c(1,2,3)))
  )
paste0("_dt",c(1,2,3))

for (i1 in c("1_X_all","2_X_all","1_X_no_nsec_1","2_X_no_nsec_1","1_X_no_nsec_2","2_X_no_nsec_2")) {
  for (i2 in c("b","c")) {
    if (i2=="b") {
      vect_coef_b <- 
        c(
          vect_coef_b,
          paste0(paste0(i2,i1,"_mt1"),paste0("_dt",c(1,2,3))),
          paste0(paste0(i2,i1,"_mt2"),paste0("_dt",c(1,2,3)))
        )
    } else if (i2=="c") {
      vect_coef_c <- 
        c(
          vect_coef_c,
          paste0(paste0(i2,i1,"_mt1"),paste0("_dt",c(1,2,3))),
          paste0(paste0(i2,i1,"_mt2"),paste0("_dt",c(1,2,3)))
        )
    }
  }
}

names_vector <- 
  unique( 
    eval(parse(
      text = 
        paste0(
          "c(",
          paste0( paste0("coef_",vect_coef_a,"$rn"),collapse=","),
          paste0( paste0("coef_",vect_coef_b,"$rn"),collapse=","),
          paste0( paste0("coef_",vect_coef_c,"$rn"),collapse=","),
          ")"
          )
      )) 
    )

vect_coef_a_weighted <- paste0(vect_coef_a,"_wt")
vect_coef_b_weighted <- paste0(vect_coef_b,"_wt")
vect_coef_c_weighted <- paste0(vect_coef_c,"_wt")

# Ordering variables
Order <- list(
            c(grep("^new_sec_all_1930",names_vector,value=TRUE)),
            c(grep("^new_sec_main_1930",names_vector,value=TRUE)),
            c(grep("^new_sec_serv_1930",names_vector,value=TRUE)),
            c(grep("^H_",names_vector,value=TRUE)),
            c(grep("perwt_1930",names_vector,value=TRUE)),
            c(grep("^sh_lit",names_vector,value=TRUE)),
            c(grep("^sh_occ1950_main",names_vector,value=TRUE)),
            c("adj.r2"),c("nobs"),
            c(grep("^statefip_194010",names_vector,value=TRUE)),
            c(grep("^sh_ind1950_main",names_vector,value=TRUE)),
            c(grep("^sh_age_16_49",names_vector,value=TRUE)),
            c(grep("^sh_age_more5",names_vector,value=TRUE)),
            c(grep("^sh_labforce_",names_vector,value=TRUE)),
            c(grep("^sh_unemp_",names_vector,value=TRUE)),
            c(grep("^sh_wrkwage_",names_vector,value=TRUE)),
            c(grep("^sh_educ_",names_vector,value=TRUE)),
            c(grep("^sh_mig_us_",names_vector,value=TRUE)),
            c(grep("^sh_mig_ab_",names_vector,value=TRUE))
            )
```

###### Exporting results
```{r}
# Dependent variable and individual var in 1940, rest in 1930
## Coefficients that don't exclude any workers 
### Unweighted
list <- vector(mode="list"); j<- 1
for (i in c(paste0("coef_",vect_coef_a)) ) {
  X <- eval(parse(text=i))
  list[[j]] <- f_order_reg(X[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn)[,!c("variable")]
  j <- j+1
}

wrapper_Excel(
  list,
  as.list(vect_coef_a),
  paste0(main_directory,"R - Processing data/output/Tables/regional_reg_all_1940_ctynhg_1910.xlsx")
)

### Weighted
list <- vector(mode="list"); j<- 1
for (i in c(paste0("coef_",vect_coef_a,"_wt")) ) {
  X <- eval(parse(text=i))
  list[[j]] <- f_order_reg(X[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn)[,!c("variable")]
  j <- j+1
}

wrapper_Excel(
  list,
  as.list(vect_coef_a),
  paste0(main_directory,"R - Processing data/output/Tables/regional_reg_all_1940_ctynhg_1910_weighted.xlsx")
)

## Coefficients that exclude workers in all new sectors
### UnWeighted
list <- vector(mode="list"); j<- 1
for (i in c(paste0("coef_",vect_coef_b))) {
  X <- eval(parse(text=i))
  list[[j]] <- f_order_reg(X[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn)[,!c("variable")]
  j <- j+1
}

wrapper_Excel(
  list,
  as.list(vect_coef_b),
  paste0(main_directory,"R - Processing data/output/Tables/regional_reg_no_new_sec_1940_ctynhg_1910.xlsx")
)

### weighted
list <- vector(mode="list"); j<- 1
for (i in c(paste0("coef_",vect_coef_a,"_wt"))) {
  X <- eval(parse(text=i))
  list[[j]] <- f_order_reg(X[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn)[,!c("variable")]
  j <- j+1
}

wrapper_Excel(
  list,
  as.list(vect_coef_b_weighted),
  paste0(main_directory,"R - Processing data/output/Tables/regional_reg_no_new_sec_1940_ctynhg_1910_weighted.xlsx")
)

## Coefficients that exclude workers in all new main sectors
list <- vector(mode="list"); j<- 1
### Unweighted
for (i in c(paste0("coef_",vect_coef_c))) {
  X <- eval(parse(text=i))
  list[[j]] <- f_order_reg(X[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn)[,!c("variable")]
  j <- j+1
}

wrapper_Excel(
  list,
  as.list(vect_coef_c),
  paste0(main_directory,"R - Processing data/output/Tables/regional_reg_no_new_sec_main_1940_ctynhg_1910.xlsx")
)

### Weighted
list <- vector(mode="list"); j<- 1
for (i in c(paste0("coef_",vect_coef_c,"_wt"))) {
  X <- eval(parse(text=i))
  list[[j]] <- f_order_reg(X[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn)[,!c("variable")]
  j <- j+1
}

wrapper_Excel(
  list,
  as.list(vect_coef_c_weighted),
  paste0(main_directory,"R - Processing data/output/Tables/regional_reg_no_new_sec_main_1940_ctynhg_1910_weighted.xlsx")
)
```

#### 1.3.2 Robustness Regressions - Exploring the importance of different occupations
##### 1.3.2.1 Creating the different formulas for the regressions
#### 1.3.2.2. Regressions
##### Saving results

# Part 8. Regressions following Lin (2011) - Obtaining residual for the county or city fixed effects and then performing the regional regression on these coefficients.
## Loading packages and erasing the workspace (make sure to have loaded f_load_pk)
```{r}
rm(list = setdiff(ls(),c(lsf.str(),"main_directory") ))
f_load_pk()
```

## 1. Regressions following Lin (2011) - At the countynhg_1910 level
****** TO BE FINISHED **********
****** TO BE FINISHED **********
****** TO BE FINISHED **********
****** TO BE FINISHED **********
****** TO BE FINISHED **********

- To construct the database use the regional database of Part 6., to account for reginal variables excluding workers in new sectors
- As the explanatory variable we will use the fixed effects computed in the file boostrap_fixed_effects_model.Rmd
## 1. Regressions at the countynhg_1910 level
### 1.1. Construct regional level database
#### 1.1.1 Adding regional level variables
```{r}
# 1940
census_sample_1940_countynhg_1910 <-read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1940_agg_countynhg_1910.fst"),as.data.table=TRUE)
census_sample_1940_countynhg_1910 <- census_sample_1940_countynhg_1910[,`:=`(sh_age_less16 = sh_age_main_0+sh_age_main_1,sh_age_16_49 = sh_age_main_2+sh_age_main_3+sh_age_main_4+sh_age_main_5,sh_age_more50 = sh_age_main_6+sh_age_main_7)][,`:=`(new_sec_all=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466 +sh_new_sector_ind1950_556+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816 + sh_new_sector_ind1950_856,
                              new_sec_main=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466+ sh_new_sector_ind1950_856,
                              new_sec_serv=sh_new_sector_ind1950_556+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816)]
cols <- grep("^(?!.*sh_new_)(?!.*sh_age_main)",names(census_sample_1940_countynhg_1910),value=TRUE,perl=TRUE)
census_sample_1940_countynhg_1910 <- census_sample_1940_countynhg_1910[,cols,with=FALSE]
cols <- names(census_sample_1940_countynhg_1910[,!c("countynhg_1910")])
setnames(census_sample_1940_countynhg_1910,cols,paste0(cols,"_1940"))

temp <- read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1940_agg_countynhg_1910_no_new_sec_all.fst"),as.data.table=TRUE)
cols <- grep("^sh_m_|^sh_f_|^statefip",names(temp),value=TRUE)
temp <- temp[,!cols,with=FALSE][,`:=`(sh_age_less16 = sh_age_main_0+sh_age_main_1,sh_age_16_49 = sh_age_main_2+sh_age_main_3+sh_age_main_4+sh_age_main_5,sh_age_more50 = sh_age_main_6+sh_age_main_7)]
cols <- grep("^(?!.*sh_new_)(?!.*sh_age_main)",names(temp),value=TRUE,perl=TRUE)
temp <- temp[,cols,with=FALSE]

cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_1940_no_new_sec_all"))

census_sample_1940_countynhg_1910 <- merge(census_sample_1940_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)
temp <- read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1940_agg_countynhg_1910_no_new_sec_main.fst"),as.data.table=TRUE)
cols <- grep("^sh_m_|^sh_f_|^statefip",names(temp),value=TRUE)
temp <- temp[,!cols,with=FALSE][,`:=`(sh_age_less16 = sh_age_main_0+sh_age_main_1,sh_age_16_49 = sh_age_main_2+sh_age_main_3+sh_age_main_4+sh_age_main_5,sh_age_more50 = sh_age_main_6+sh_age_main_7)]
cols <- grep("^(?!.*sh_new_)(?!.*sh_age_main)",names(temp),value=TRUE,perl=TRUE)
temp <- temp[,cols,with=FALSE]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_1940_no_new_sec_main"))
census_sample_1940_countynhg_1910 <- merge(census_sample_1940_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)

# 1930
temp <-read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1930_agg_countynhg_1910.fst"),as.data.table=TRUE)
cols <- grep("^sh_m_|^sh_f_|^statefip|^sh_base|^sh_red",names(temp),value=TRUE)
temp <- temp[,!cols,with=FALSE][,`:=`(sh_age_less16 = sh_age_main_0+sh_age_main_1,sh_age_16_49 = sh_age_main_2+sh_age_main_3+sh_age_main_4+sh_age_main_5,sh_age_more50 = sh_age_main_6+sh_age_main_7)][,`:=`(new_sec_all=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466 +sh_new_sector_ind1950_556+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816 + sh_new_sector_ind1950_856,
                              new_sec_main=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466+ sh_new_sector_ind1950_856,
                              new_sec_serv=sh_new_sector_ind1950_556+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816)]
cols <- grep("^(?!.*sh_new_sector)(?!.*sh_age_main)",names(temp),value=TRUE,perl=TRUE)
temp <- temp[,cols,with=FALSE]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_1930"))

census_sample_1940_countynhg_1910 <- merge(census_sample_1940_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)

temp <-read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1930_agg_countynhg_1910_no_new_sec_all.fst"),as.data.table=TRUE)
cols <- grep("^sh_m_|^sh_f_|^statefip|^sh_base|^sh_red",names(temp),value=TRUE)
temp <- temp[,!cols,with=FALSE][,`:=`(sh_age_less16 = sh_age_main_0+sh_age_main_1,sh_age_16_49 = sh_age_main_2+sh_age_main_3+sh_age_main_4+sh_age_main_5,sh_age_more50 = sh_age_main_6+sh_age_main_7)]
cols <- grep("^(?!.*sh_age_main)",names(temp),value=TRUE,perl=TRUE)
temp <- temp[,cols,with=FALSE]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_1930_no_new_sec_all"))

census_sample_1940_countynhg_1910 <- merge(census_sample_1940_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)

temp <-read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1930_agg_countynhg_1910_no_new_sec_main.fst"),as.data.table=TRUE)
cols <- grep("^sh_m_|^sh_f_|^statefip|^sh_base|^sh_red",names(temp),value=TRUE)
temp <- temp[,!cols,with=FALSE][,`:=`(sh_age_less16 = sh_age_main_0+sh_age_main_1,sh_age_16_49 = sh_age_main_2+sh_age_main_3+sh_age_main_4+sh_age_main_5,sh_age_more50 = sh_age_main_6+sh_age_main_7)]
cols <- grep("^(?!.*sh_age_main)",names(temp),value=TRUE,perl=TRUE)
temp <- temp[,cols,with=FALSE]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_1930_no_new_sec_main"))

census_sample_1940_countynhg_1910 <- merge(census_sample_1940_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)

```

#### 1.1.2. Adding the region fixed effects
- Different number of fixed effects:
  - Method, dataset
  - All, no_new_sec, no_new_sec_main
  - different controls
  
  For now I only computed the fixed effects for method 1 and datasets 2 and 3
  - Excluding all new sector workers
  coef_final_1940_method",method,"_dt",dt,".btrap.perwtge_",pop,".base.no_new_sec.fst"
    .base.no_new_sec.fst
    .base.marst.educ.race.no_new_sec.fst
    .base.marst.educ.race.work.no_new_sec.fst
    .base.marst.educ.race.ind1950.no_new_sec.fst
    .base.marst.educ.race.work.ind1950.no_new_sec.fst
    
  - All workers
    only change the last part with .all
    
```{r}
for (pop in c(10000)) {
  for (method in c(1)) {
    for (dataset in c(2,3)) {
      for (workers in c("all","no_new_sec")) {
        for(cov in c("base","base.marst.educ.race","base.marst.educ.race.work","base.marst.educ.race.ind1950","base.marst.educ.race.work.ind1950")) {
          temp <- read_fst(paste0(main_directory,"R - Processing data/output/Rdata/coef_final_1940_method",method,"_dt",dataset,".btrap.perwtge_",pop,".",cov,".",workers,".fst"),as.data.table=TRUE,columns = c("rn","coef.b","se.b"))
          census_sample_1940_countynhg_1910 <- merge(census_sample_1940_countynhg_1910[,countynhg_1910:=as.factor(countynhg_1910)],temp[,c("rn","coef.b","se.b")],by.x="countynhg_1910",by.y="rn",all.x=TRUE,all.y=FALSE)
          census_sample_1940_countynhg_1910[,weights:=1/(se.b^2)] 
          
          setnames(
            census_sample_1940_countynhg_1910,
            c("coef.b","se.b","weights"),
            c(
              paste0("fe.method",method,"_dt",dataset,".perwtge_",pop,".",cov,".",workers),
              paste0("se.method",method,"_dt",dataset,".perwtge_",pop,".",cov,".",workers),
              paste0("weights.method",method,"_dt",dataset,".perwtge_",pop,".",cov,".",workers)
            )
          )
          rm(temp)
        }
      }
    }
  }
}

```


### 1.2 Creating variables for regressions and regression formulas
```{r}
# Converting state to a factor variable
census_sample_1940_countynhg_1910 <- census_sample_1940_countynhg_1910[,statefip_1940:=as.factor(statefip_1940)]  

# Regional
j <- 1; regional_1_1930 <- indsh_var_1930 <- occsh_var_1930 <- regional_1_1940 <- indsh_var_1940 <- occsh_var_1940 <- base_1_1940 <- base_2_1940 <- base_3_1940 <- base_4_1940 <- base_1_1930 <- base_2_1930 <- base_3_1930 <- base_4_1930 <- vector(mode = "list")
for (i in c("","_no_new_sec_all","_no_new_sec_main")) {
  regional_1_1930[[j]] <- paste0(paste0(paste0(c("sh_lit_1930","H_1930"),i),collapse=" + ")," + log(perwt_1930",i,")" )
  indsh_var_1930[[j]] <- paste0(paste0(grep("^sh_ind1950_main_[^1]_1930$",names(census_sample_1940_countynhg_1910),value=TRUE),i),collapse=" + ")
  occsh_var_1930[[j]] <- paste0(paste0(grep("^sh_occ1950_main_[^0].+_1930$",names(census_sample_1940_countynhg_1910),value=TRUE),i),collapse=" + ")
  base_1_1930[[j]] <- paste0( paste0(c("sh_age_16_49_1930","sh_age_more50_1930","sh_male_1930","sh_race_2_1930","sh_race_3_1930","sh_urban_1930"),i),collapse=" + ")
  base_2_1930[[j]] <- paste0( paste0(c("sh_mig_us_1930","sh_mig_ab_1930"),i),collapse=" + ")
  base_3_1930[[j]] <- paste0( paste0(c("sh_labforce_1930","sh_unemp_1930","sh_wrkwage_1930"),i),collapse=" + ")
  base_4_1930[[j]] <- paste0( paste0(c("sh_marst_2_1930","sh_marst_3_1930"),collapse=" + "),i)
  regional_1_1940[[j]] <- paste0(paste0(paste0(c("sh_educ_main_1_1940","sh_educ_main_2_1940","H_1940$"),i),collapse=" + ")," + log(perwt_1940",i,")" )
  indsh_var_1940[[j]] <- paste0(paste0(grep("^sh_ind1950_main_[^1]_1940$",names(census_sample_1940_countynhg_1910),value=TRUE),i),collapse=" + ")
  occsh_var_1940[[j]] <- paste0(paste0(grep("^sh_occ1950_main_[^0].+_1940$",names(census_sample_1940_countynhg_1910),value=TRUE),i),collapse=" + ")
  base_1_1940[[j]] <- paste0( paste0(c("sh_age_16_49_1940","sh_age_more50_1940","sh_male_1940","sh_race_2_1940","sh_race_3_1940","sh_urban_1940"),collapse=" + "),i)
  base_2_1940[[j]] <- paste0( paste0(c("sh_mig_us_1940","sh_mig_ab_1940"),i),collapse=" + ")
  base_3_1940[[j]] <- paste0( paste0(c("sh_labforce_1940","sh_unemp_1940","sh_wrkwage_1940"),i),collapse=" + ")
  base_4_1940[[j]] <- paste0( paste0(c("sh_marst_2_1940","sh_marst_3_1940"),i),collapse=" + ")
  j <- j+1
}

```

### 1.3. Regressions
1. sh_lit + log(perwt) + sh_new sectors (3 different cases)
2. sh_lit + log(perwt) + sh_new sectors (3 different cases) + sh_ind1950_main
3. sh_lit + log(perwt) + sh_new sectors (3 different cases) + sh_ind1950_main + sh_occ1950_main

Where base:   - (1) sh_age (three different groups), sh_male, sh_race, sh_urban, sh_mig_us, sh_mig_ab,   (maybe) sh_farm
              - (2) sh_labforce, sh_unenemp, sh_wrkwage
              - (3) sh_m_mig_us, sh_m_mig_ab, sh_f_mig_us, sh_f_mig_ab, sh_marst
Fixed effects:- statefip    
            
"Regional":   - (1) sh_lit, H, log(perwt)
              - (2) sh_occ1950_main, sh_ind1950_main

New Sector:   - new_sec_all, new_sec_main, new_sec_serv

New Work:     - sh_red_tit, sh_base_tit

It is not very clear what year should we use for the different variables. For the new sector variables the year should be 1920 and probably also for the regional variables. For the base variables I'm not entirely sure.
Regarding the variables excluding workers in new sectors, for sure we should do that for the New Work variables. We could also try to do that for the regional variables.

#### 1.3.1 Main Regressions
#### 1.3.1.1 Creating the different formulas for the regressions
- Regressions by: method (for now only one), dataset (2 and 3), individual covariates, with all workers are excluding workers in new sectors, with and without state FE ??, with main and services sectors separated

- All workers (lists a):
  - All the regional variables include all the workers (_X_all)
- Excluding workers in new sectors (lists b):   
  - 1. All regional variables include all workers (_X_all)
  - 2. Only the industry and occupation exclude workers (_X_nsec2)
  - 3. Industry, occupation and regional exclude workers (_X_nsec3)
  - 4. All variables exclude regional (_X_nsec4)
```{r}
for (pop in c(10000)) {
  for (method in c(1)) {
    for (dataset in c(2,3)) {
      for (workers in c("all","no_new_sec")) {
        icov <- 0
        for(cov in c("base","base.marst.educ.race","base.marst.educ.race.work","base.marst.educ.race.ind1950","base.marst.educ.race.work.ind1950")) {
          icov <- icov + 1
          for (nsec in c(1,2,3,4)) {
            if (nsec==1) { i1 <- i2 <- i3 <- 1
            } else if (nsec==2) { i1 <- i2 <- 1; i3 <- 2
            } else if (nsec==3) { i1 <-  1; i3 <- i2 <- 2
            } else if (nsec==4) { i1 <- i2 <- i3 <- 2
            }
            # Vector with all the different combinations of regressions
            vector <- 
              as.data.table(expand.grid(
                c(
                        paste0(""),
                        paste0(" + statefip_1940"),
                        paste0(" + statefip_1940 + ",base_1_1930[[i1]]),
                        paste0(" + statefip_1940 + ",base_1_1930[[i1]]," + ",base_2_1930[[i1]]),
                        paste0(" + statefip_1940 + ",base_1_1930[[i1]]," + ",base_2_1930[[i1]]," + ",base_3_1930[[i1]]),
                        paste0(" + statefip_1940 + ",base_1_1930[[i1]]," + ",base_2_1930[[i1]]," + ",base_3_1930[[i1]]," + ",base_4_1930[[i1]]),
                        paste0(" + ",base_1_1930[[i1]]),
                        paste0(" + ",base_1_1930[[i1]]," + ",base_2_1930[[i1]]),
                        paste0(" + ",base_1_1930[[i1]]," + ",base_2_1930[[i1]]," + ",base_3_1930[[i1]]),
                        paste0(" + ",base_1_1930[[i1]]," + ",base_2_1930[[i1]]," + ",base_3_1930[[i1]]," + ",base_4_1930[[i1]])
                      ),
                      c(
                        paste0(""),
                        paste0(" + ",regional_1_1930[[i2]]),
                        paste0(" + ",regional_1_1930[[i2]]," + ",indsh_var_1930[[i3]]),
                        paste0(" + ",regional_1_1930[[i2]]," + ",occsh_var_1930[[i3]]),
                        paste0(" + ",regional_1_1930[[i2]]," + ",indsh_var_1930[[i3]]," + ",occsh_var_1930[[i3]]),
                        paste0(" + ",indsh_var_1930[[i3]]),
                        paste0(" + ",occsh_var_1930[[i3]]),
                        paste0(" + ",indsh_var_1930[[i3]]," + ",occsh_var_1930[[i3]])
                      )
              ))[,p:=paste0(Var1,Var2)]$p
            
            if (workers=="all" & nsec==1) {
              assign(
                paste0("a1_X_all_m",method,"_dt",dataset,"_p",pop,"_X",icov),
                lapply(paste0("fe.method",method,"_dt",dataset,".perwtge_",pop,".",cov,".",workers," ~ new_sec_all_1930",vector),as.formula)
              )
              assign(
                paste0("a2_X_all_m",method,"_dt",dataset,"_p",pop,"_X",icov),
                lapply(paste0("fe.method",method,"_dt",dataset,".perwtge_",pop,".",cov,".",workers," ~ new_sec_main_1930 + new_sec_serv_1930",vector),as.formula)
              )
            } else if (workers=="no_new_sec") {
              if (nsec==1) {
                assign(
                  paste0("b1_X_all_m",method,"_dt",dataset,"_p",pop,"_X",icov),
                  lapply(paste0("fe.method",method,"_dt",dataset,".perwtge_",pop,".",cov,".",workers," ~ new_sec_all_1930",vector),as.formula)
                )
                assign(
                  paste0("b2_X_all_m",method,"_dt",dataset,"_p",pop,"_X",icov),
                  lapply(paste0("fe.method",method,"_dt",dataset,".perwtge_",pop,".",cov,".",workers," ~  new_sec_main_1930 + new_sec_serv_1930",vector),as.formula)
                )
              } else if (nsec!=1) {
                assign(
                  paste0("b1_X_nsec",nsec,"_m",method,"_dt",dataset,"_p",pop,"_X",icov),
                  lapply(paste0("fe.method",method,"_dt",dataset,".perwtge_",pop,".",cov,".",workers," ~ new_sec_all_1930",vector),as.formula)
                )
                assign(
                  paste0("b2_X_nsec",nsec,"_m",method,"_dt",dataset,"_p",pop,"_X",icov),
                  lapply(paste0("fe.method",method,"_dt",dataset,".perwtge_",pop,".",cov,".",workers," ~  new_sec_main_1930 + new_sec_serv_1930",vector),as.formula)
                )
              }
            }
          }
        }
      }
    }
  }
}
```

##### 1.3.1.2. Main Regressions
 - a, b, c
 - dataset1, dataset2, dataset3
 - _x_controls_all
 - _x_cont_no_new_sec_1,x_cont_no_new_sec_2
```{r}
for (pop in c(10000)) {
  for (method in c(1)) {
    for (dataset in c(2,3)) {
      for (workers in c("all","no_new_sec")) {
        for(cov in c(1,2,3,4,5)) {
          for (nsec in c(1,2,3,4)) {
            if (workers=="all" & nsec==1) {
              # NO weights
              formula <- eval(as.name(paste0("a1_X_all_m",method,"_dt",dataset,"_p",pop,"_X",cov)))
              assign(
                paste0("coef_a1_X_all_m",method,"_dt",dataset,"_p",pop,"_X",cov),
                f_regressions(arg_formula=formula,arg_data=census_sample_1940_countynhg_1910[perwt_1940 > 10000],method="lm",by_iter = 30)
              )
              formula <- eval(as.name(paste0("a2_X_all_m",method,"_dt",dataset,"_p",pop,"_X",cov)))
              assign(
                paste0("coef_a2_X_all_m",method,"_dt",dataset,"_p",pop,"_X",cov),
                f_regressions(arg_formula=formula,arg_data=census_sample_1940_countynhg_1910[perwt_1940 > 10000],method="lm",by_iter = 30)
              )
              # WITH weights
              formula <- eval(as.name(paste0("a1_X_all_m",method,"_dt",dataset,"_p",pop,"_X",cov)))
              assign(
                paste0("coef_a1_X_all_m",method,"_dt",dataset,"_p",pop,"_X",cov,"_wt"),
                f_regressions(arg_formula=formula,arg_data=census_sample_1940_countynhg_1910[perwt_1940 > 10000],method="lm",arg_weights = perwt_1940,by_iter = 30)
              )
              formula <- eval(as.name(paste0("a2_X_all_m",method,"_dt",dataset,"_p",pop,"_X",cov)))
              assign(
                paste0("coef_a2_X_all_m",method,"_dt",dataset,"_p",pop,"_X",cov,"_wt"),
                f_regressions(arg_formula=formula,arg_data=census_sample_1940_countynhg_1910[perwt_1940 > 10000],method="lm",arg_weights = perwt_1940,by_iter = 30)
              )
            } else if (workers=="no_new_sec" & nsec==1) {
              # NO weights
              formula <- eval(as.name(paste0("b1_X_all_m",method,"_dt",dataset,"_p",pop,"_X",cov)))
              assign(
                paste0("coef_b1_X_all_m",method,"_dt",dataset,"_p",pop,"_X",cov),
                f_regressions(arg_formula=formula,arg_data=census_sample_1940_countynhg_1910[perwt_1940 > 10000],method="lm",by_iter = 30)
              )
              formula <- eval(as.name(paste0("b2_X_all_m",method,"_dt",dataset,"_p",pop,"_X",cov)))
              assign(
                paste0("coef_b2_X_all_m",method,"_dt",dataset,"_p",pop,"_X",cov),
                f_regressions(arg_formula=formula,arg_data=census_sample_1940_countynhg_1910[perwt_1940 > 10000],method="lm",by_iter = 30)
              )
              # WITH weights
              formula <- eval(as.name(paste0("b1_X_all_m",method,"_dt",dataset,"_p",pop,"_X",cov)))
              assign(
                paste0("coef_b1_X_all_m",method,"_dt",dataset,"_p",pop,"_X",cov,"_wt"),
                f_regressions(arg_formula=formula,arg_data=census_sample_1940_countynhg_1910[perwt_1940 > 10000],method="lm",arg_weights = perwt_1940,by_iter = 30)
              )
              formula <- eval(as.name(paste0("b2_X_all_m",method,"_dt",dataset,"_p",pop,"_X",cov)))
              assign(
                paste0("coef_b2_X_all_m",method,"_dt",dataset,"_p",pop,"_X",cov,"_wt"),
                f_regressions(arg_formula=formula,arg_data=census_sample_1940_countynhg_1910[perwt_1940 > 10000],method="lm",arg_weights = perwt_1940,by_iter = 30)
              )
            } else if (workers=="no_new_sec" & nsec!=1){
              # NO weights
              formula <- eval(as.name(paste0("b1_X_nsec",nsec,"_m",method,"_dt",dataset,"_p",pop,"_X",cov)))
              assign(
                paste0("coef_b1_X_nsec",nsec,"_m",method,"_dt",dataset,"_p",pop,"_X",cov),
                f_regressions(arg_formula=formula,arg_data=census_sample_1940_countynhg_1910[perwt_1940 > 10000],method="lm",by_iter = 30)
              )
               formula <- eval(as.name(paste0("b2_X_nsec",nsec,"_m",method,"_dt",dataset,"_p",pop,"_X",cov)))
              assign(
                paste0("coef_b2_X_nsec",nsec,"_m",method,"_dt",dataset,"_p",pop,"_X",cov),
                f_regressions(arg_formula=formula,arg_data=census_sample_1940_countynhg_1910[perwt_1940 > 10000],method="lm",by_iter = 30)
              )
              # WITH weights
              formula <- eval(as.name(paste0("b1_X_nsec",nsec,"_m",method,"_dt",dataset,"_p",pop,"_X",cov)))
              assign(
                paste0("coef_b1_X_nsec",nsec,"_m",method,"_dt",dataset,"_p",pop,"_X",cov,"_wt"),
                f_regressions(arg_formula=formula,arg_data=census_sample_1940_countynhg_1910[perwt_1940 > 10000],method="lm",arg_weights = perwt_1940,by_iter = 30)
              )
              formula <- eval(as.name(paste0("b2_X_nsec",nsec,"_m",method,"_dt",dataset,"_p",pop,"_X",cov)))
              assign(
                paste0("coef_b2_X_nsec",nsec,"_m",method,"_dt",dataset,"_p",pop,"_X",cov,"_wt"),
                f_regressions(arg_formula=formula,arg_data=census_sample_1940_countynhg_1910[perwt_1940 > 10000],method="lm",arg_weights = perwt_1940,by_iter = 30)
              )
            }
          }
        }
      }
    }
  }
}
            
```

##### Saving results
```{r}
vect_coef_a <- ls(pattern="^a[12].+[12345]$")
vect_coef_b <- ls(pattern="^b[12].+[12345]$")

names_vector <- 
  unique( 
    eval(parse(
      text = 
        paste0(
          "c(",
          paste0( paste0("coef_",vect_coef_a,"$rn"),collapse=","),
          paste0( paste0("coef_",vect_coef_b,"$rn"),collapse=","),
          ")"
          )
      )) 
    )

# Ordering variables
Order <- list(
            c(grep("^new_sec_all_1930",names_vector,value=TRUE)),
            c(grep("^new_sec_main_1930",names_vector,value=TRUE)),
            c(grep("^new_sec_serv_1930",names_vector,value=TRUE)),
            c(grep("^H_",names_vector,value=TRUE)),
            c(grep("perwt_1930",names_vector,value=TRUE)),
            c(grep("^sh_lit",names_vector,value=TRUE)),
            c(grep("^sh_occ1950_main",names_vector,value=TRUE)),
            c("adj.r2"),c("nobs"),
            c(grep("^statefip_194010",names_vector,value=TRUE)),
            c(grep("^sh_ind1950_main",names_vector,value=TRUE)),
            c(grep("^sh_age_16_49",names_vector,value=TRUE)),
            c(grep("^sh_age_more5",names_vector,value=TRUE)),
            c(grep("^sh_labforce_",names_vector,value=TRUE)),
            c(grep("^sh_unemp_",names_vector,value=TRUE)),
            c(grep("^sh_wrkwage_",names_vector,value=TRUE)),
            c(grep("^sh_educ_",names_vector,value=TRUE)),
            c(grep("^sh_mig_us_",names_vector,value=TRUE)),
            c(grep("^sh_mig_ab_",names_vector,value=TRUE))
            )
```

###### Exporting results
```{r}
# Dependent variable and individual var in 1940, rest in 1930
## Coefficients that don't exclude any workers 
### Unweighted
list <- vector(mode="list"); j<- 1
for (i in c(paste0("coef_",vect_coef_a)) ) {
  X <- eval(parse(text=i))
  list[[j]] <- f_order_reg(X[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn)[,!c("variable")]
  j <- j+1
}

wrapper_Excel(
  list,
  as.list(vect_coef_a),
  paste0(main_directory,"R - Processing data/output/Tables/fe_reg_all_1940_ctynhg_1910.xlsx")
)

### Weighted
list <- vector(mode="list"); j<- 1
for (i in c(paste0("coef_",vect_coef_a,"_wt")) ) {
  X <- eval(parse(text=i))
  list[[j]] <- f_order_reg(X[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn)[,!c("variable")]
  j <- j+1
}

wrapper_Excel(
  list,
  as.list(vect_coef_a),
  paste0(main_directory,"R - Processing data/output/Tables/fe_reg_all_1940_ctynhg_1910_weighted.xlsx")
)

## Coefficients that exclude workers in all new sectors
### UnWeighted
list <- vector(mode="list"); j<- 1
for (i in c(paste0("coef_",vect_coef_b))) {
  X <- eval(parse(text=i))
  list[[j]] <- f_order_reg(X[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn)[,!c("variable")]
  j <- j+1
}

wrapper_Excel(
  list,
  as.list(vect_coef_b),
  paste0(main_directory,"R - Processing data/output/Tables/fe_reg_no_new_sec_1940_ctynhg_1910.xlsx")
)

### weighted
list <- vector(mode="list"); j<- 1
for (i in c(paste0("coef_",vect_coef_b,"_wt"))) {
  X <- eval(parse(text=i))
  list[[j]] <- f_order_reg(X[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector],Order,rn)[,!c("variable")]
  j <- j+1
}

wrapper_Excel(
  list,
  as.list(vect_coef_b),
  paste0(main_directory,"R - Processing data/output/Tables/fe_reg_no_new_sec_1940_ctynhg_1910_weighted.xlsx")
)


```

*** NOTE:
All of the result of the regressions show a positive and significant effect for the share of workers in new sectors. Even though the coefficient falls when we include occupational shares variables, it remains significant. This is contrary to what we observe in other regressions (both in the regional and the individual level one the coefficient falls and becomes insignificant when we include occupation shares.)
Looking at some of the other regional variables, we observe that the sign of the share of literate is negative and significant, which differs from the positive and significant effect when we perform the regional level regressions (Part 6.), but is similar to what we observe in the case of the individual level regressions without the first stage (Part 5.). One possible explanation for this is that once we account for the fact that a worker is or not literate, the share of literate workers in the region in 1920 doesn't matter.
Looking at the HHI_index we observe that the coefficient changes signs when we include different covariates. In the regional level regressions we observe the same behavior, while in the individual level regressions the sign is always negative but sometimes significant and others not.
The coefficient for the population variable is consistently positive as it has been in other regressions.

# Part 9. Comparing different regressions
## Loading packages and erasing the workspace (make sure to have loaded f_load_pk)
```{r}
rm(list = setdiff(ls(),c(lsf.str(),"main_directory") ))
f_load_pk()
```

## 1. Loading the different coefficients
*** to-DO: Correct problem with weights, among other things
```{r}
# Regional Regressions
for (reg in c("regional_reg_")) {
  for (type in c("all_1940_ctynhg_1910")) {
    for (sheet in c("a1_mt1_dt2","a1_mt1_dt3","a2_mt1_dt2","a2_mt1_dt3") ) {
      temp <- 
        as.data.table(read_excel(paste0(main_directory,"R - Processing data/output/Tables/",reg,type,".xlsx"), sheet = sheet,guess_max=10000))[,c("rn",paste0("model_",c(1,2,3,4,5,42,50,61)))][,dup:=0+duplicated(rn)][dup==1,rn:=paste0(rn,"_se")][,dup:=NULL]
      cols <- names(temp[,!c("rn")])
      setnames(temp,cols,paste0(cols,"_",reg,sheet))
      ## This only works if for each regression variable we have two observations and the second is SE
      temp[,dup:=0+duplicated(rn)][dup==1,rn:=paste0(rn,"_se")][,dup:=NULL]
      assign(
        paste0(reg,type,"_",sheet),
        temp
      )
      
      temp1 <- 
        as.data.table(read_excel(paste0(main_directory,"R - Processing data/output/Tables/",reg,type,".xlsx"), sheet = sheet,guess_max=10000))[,c("rn",paste0("model_",c(9,10,11,12,13,18,26,37)))][,dup:=0+duplicated(rn)][dup==1,rn:=paste0(rn,"_se")][,dup:=NULL]
      cols <- names(temp1[,!c("rn")])
      setnames(temp1,cols,paste0(cols,"_",reg,sheet))
      ## This only works if for each regression variable we have two observations and the second is SE
      temp1[,dup:=0+duplicated(rn)][dup==1,rn:=paste0(rn,"_se")][,dup:=NULL]
      assign(
        paste0(reg,type,"_",sheet,"_stateFE"),
        temp1
      )
      rm(temp,temp1)
    }
  }
  for (type in c("no_new_sec_1940_ctynhg_1910")) {
    for (sheet in c("b1_X_all_mt1_dt2","b1_X_no_nsec_1_mt1_dt2","b1_X_no_nsec_2_mt1_dt2","b1_X_all_mt1_dt3","b1_X_no_nsec_1_mt1_dt3","b1_X_no_nsec_2_mt1_dt3",
                    "b2_X_all_mt1_dt2","b2_X_no_nsec_1_mt1_dt2","b2_X_no_nsec_2_mt1_dt2","b2_X_all_mt1_dt3","b2_X_no_nsec_1_mt1_dt3","b2_X_no_nsec_2_mt1_dt3") ) {
      temp <- 
        as.data.table(read_excel(paste0(main_directory,"R - Processing data/output/Tables/",reg,type,".xlsx"), sheet = sheet,guess_max=10000))[,c("rn",paste0("model_",c(1,2,3,4,5,42,50,61)))][,dup:=0+duplicated(rn)][dup==1,rn:=paste0(rn,"_se")][,dup:=NULL]
      cols <- names(temp[,!c("rn")])
      setnames(temp,cols,paste0(cols,"_",reg,sheet))
      ## This only works if for each regression variable we have two observations and the second is SE
      temp[,dup:=0+duplicated(rn)][dup==1,rn:=paste0(rn,"_se")][,dup:=NULL]
      assign(
        paste0(reg,type,"_",sheet),
        temp
      )
      temp1 <- 
        as.data.table(read_excel(paste0(main_directory,"R - Processing data/output/Tables/",reg,type,".xlsx"), sheet = sheet,guess_max=10000))[,c("rn",paste0("model_",c(9,10,11,12,13,18,26,37)))][,dup:=0+duplicated(rn)][dup==1,rn:=paste0(rn,"_se")][,dup:=NULL]
      cols <- names(temp1[,!c("rn")])
      setnames(temp1,cols,paste0(cols,"_",reg,sheet))
      ## This only works if for each regression variable we have two observations and the second is SE
      temp1[,dup:=0+duplicated(rn)][dup==1,rn:=paste0(rn,"_se")][,dup:=NULL]
      assign(
        paste0(reg,type,"_",sheet,"_stateFE"),
        temp1
      )
      rm(temp,temp1)
    }
  }
}


# FE Regressions
for (reg in c("fe_reg_")) {
  for (type in c("all_1940_ctynhg_1910","all_1940_ctynhg_1910_weighted")) {
    for (sheet in c("a1_X_all_m1_dt2","a1_X_all_m1_dt3","a2_X_all_m1_dt2","a2_X_all_m1_dt3") ) {
      for (cov in c(1,2,5)) {
        temp <- 
          as.data.table(read_excel(paste0(main_directory,"R - Processing data/output/Tables/",reg,type,".xlsx"), sheet = paste0(sheet,"_p10000_X",cov),guess_max=10000))[,c("rn",paste0("model_",c(1,11,21,31,41,17,19,50)))][,dup:=0+duplicated(rn)][dup==1,rn:=paste0(rn,"_se")][,dup:=NULL]
        cols <- names(temp[,!c("rn")])
        setnames(temp,cols,paste0(cols,"_",reg,sheet,"_X",cov))
        ## This only works if for each regression variable we have two observations and the second is SE
        temp[,dup:=0+duplicated(rn)][dup==1,rn:=paste0(rn,"_se")][,dup:=NULL]
        assign(
          paste0(reg,type,"_",sheet,"X",cov),
          temp
        )
        temp1 <- 
          as.data.table(read_excel(paste0(main_directory,"R - Processing data/output/Tables/",reg,type,".xlsx"), sheet = paste0(sheet,"_p10000_X",cov),guess_max=10000))[,c("rn",paste0("model_",c(2,12,22,32,42,13,15,46)))][,dup:=0+duplicated(rn)][dup==1,rn:=paste0(rn,"_se")][,dup:=NULL]
        cols <- names(temp1[,!c("rn")])
        setnames(temp1,cols,paste0(cols,"_",reg,sheet,"_X",cov))
        ## This only works if for each regression variable we have two observations and the second is SE
        temp1[,dup:=0+duplicated(rn)][dup==1,rn:=paste0(rn,"_se")][,dup:=NULL]
        assign(
          paste0(reg,type,"_",sheet,"X",cov,"_stateFE"),
          temp1
        )
        rm(temp,temp1)
      }
    }
  }
  for (type in c("no_new_sec_1940_ctynhg_1910")) {
    for (sheet in c("b1_X_all_m1_dt2","b1_X_nsec2_m1_dt2","b1_X_nsec3_m1_dt2","b1_X_all_m1_dt3","b1_X_nsec2_m1_dt3","b1_X_nsec3_m1_dt3",
                    "b2_X_all_m1_dt2","b2_X_nsec2_m1_dt2","b2_X_nsec3_m1_dt2","b2_X_all_m1_dt3","b2_X_nsec2_m1_dt3","b2_X_nsec3_m1_dt3") ) {
      for (cov in c(1,2,5)) {
        temp <- 
          as.data.table(read_excel(paste0(main_directory,"R - Processing data/output/Tables/",reg,type,".xlsx"), sheet = paste0(sheet,"_p10000_X",cov),guess_max=10000))[,c("rn",paste0("model_",c(1,11,21,31,41,17,19,50)))][,dup:=0+duplicated(rn)][dup==1,rn:=paste0(rn,"_se")][,dup:=NULL]
        cols <- names(temp[,!c("rn")])
        setnames(temp,cols,paste0(cols,"_",reg,sheet,"_X",cov))
        ## This only works if for each regression variable we have two observations and the second is SE
        temp[,dup:=0+duplicated(rn)][dup==1,rn:=paste0(rn,"_se")][,dup:=NULL]
        assign(
          paste0(reg,type,"_",sheet,"X",cov),
          temp
        )
        temp1 <- 
          as.data.table(read_excel(paste0(main_directory,"R - Processing data/output/Tables/",reg,type,".xlsx"), sheet = paste0(sheet,"_p10000_X",cov),guess_max=10000))[,c("rn",paste0("model_",c(2,12,22,32,42,13,15,46)))][,dup:=0+duplicated(rn)][dup==1,rn:=paste0(rn,"_se")][,dup:=NULL]
        cols <- names(temp1[,!c("rn")])
        setnames(temp1,cols,paste0(cols,"_",reg,sheet,"_X",cov))
        ## This only works if for each regression variable we have two observations and the second is SE
        temp1[,dup:=0+duplicated(rn)][dup==1,rn:=paste0(rn,"_se")][,dup:=NULL]
        assign(
          paste0(reg,type,"_",sheet,"X",cov,"_stateFE"),
          temp1
        )
        rm(temp,temp1)
      }
    }
  }
}

```

## 2. Creating combined coefficients tables
```{r}
# Database where no workers are excluded
for (i in c("","_stateFE")) {
  list_names <- list <- vector(mode="list"); t <- 1
  for (j in c(1,2)) {
    for (dt in c(2,3)) {
      Y <- Reduce(
          function(x, y, ...) merge(x, y, by="rn", all = TRUE, allow.cartesian = TRUE, ...),
          list(
            eval(as.name(paste0("regional_reg_all_1940_ctynhg_1910_a",j,"_mt1_dt",dt,i))),
            eval(as.name(paste0("fe_reg_all_1940_ctynhg_1910_a",j,"_X_all_m1_dt",dt,"X1",i))),
            eval(as.name(paste0("fe_reg_all_1940_ctynhg_1910_a",j,"_X_all_m1_dt",dt,"X2",i))),
            eval(as.name(paste0("fe_reg_all_1940_ctynhg_1910_a",j,"_X_all_m1_dt",dt,"X5",i)))
            )
        )
      
      # Create vectors with TRUTH values if a given variable is not NA
      Y <- 
        f_reg_results_VAR_exist(Y,rn,
                                c("statefip_194010","sh_lit_1930","sh_age_16_49_1930","sh_age_16_49_1940","sh_ind1950_main_2_1930","sh_occ1950_main_100_1930","sh_labforce_1930","sh_labforce_1940"),
                                c("State FE","Regional V.","Base V. 1930","Base V. 1940","Industry V.","Occupation V.","Laborforce V. 1930","Laborforce V. 1940")  
                                )
      
      # Ordering regression variables
      names_vector <- 
         unique( 
           Y$rn
           )
      Order <- list(
                  c(grep("^new_sec_all_1930",names_vector,value=TRUE)),c(grep("^new_sec_main_1930",names_vector,value=TRUE)),
                  c(grep("^new_sec_serv_1930",names_vector,value=TRUE)),c(grep("^H_",names_vector,value=TRUE)),
                  c(grep("perwt_1930",names_vector,value=TRUE)),c(grep("^sh_lit",names_vector,value=TRUE)),
                  c(grep("State FE",names_vector,value=TRUE)),c(grep("Regional V.",names_vector,value=TRUE)),
                  c(grep("Occupation V.",names_vector,value=TRUE)),c(grep("Industry V.",names_vector,value=TRUE)),
                  c(grep("Base V. 1930",names_vector,value=TRUE)),c(grep("Base V. 1940",names_vector,value=TRUE)),
                  c(grep("Laborforce V. 1930",names_vector,value=TRUE)),c(grep("Laborforce V. 1940",names_vector,value=TRUE)),
                  c("adj.r2"),c("nobs"),c(grep("^sh_occ1950_main",names_vector,value=TRUE)),
                  c(grep("^sh_ind1950_main",names_vector,value=TRUE)),c(grep("^sh_age_16_49",names_vector,value=TRUE)),
                  c(grep("^sh_educ_",names_vector,value=TRUE)),c(grep("^sh_mig_us_",names_vector,value=TRUE)),
                  c(grep("^sh_mig_ab_",names_vector,value=TRUE)),c(grep("^sh_age_more5",names_vector,value=TRUE)),
                  c(grep("^sh_labforce_",names_vector,value=TRUE)),c(grep("^sh_unemp_",names_vector,value=TRUE)),
                  c(grep("^sh_wrkwage_",names_vector,value=TRUE)),c(grep("^statefip_1940",names_vector,value=TRUE))
                  )
      Y <- f_order_reg(Y,Order,rn)
      assign(paste0("coef_a",j,"_m1_dt",dt,i),Y)
      #assign(list[[t]],paste0("coef_a",j,"_m1_dt",dt,i))
      list[[t]] <- eval(as.name(paste0("coef_a",j,"_m1_dt",dt,i)))
      list_names[[t]] <- paste0("coef_a",j,"_m1_dt",dt,i)
      
      if (i=="") {
        setcolorder(Y,
                    c("rn",
                      c(grep("^model_1_",names(Y),value=TRUE)),c(grep("^model_2_",names(Y),value=TRUE)),c(grep("^model_11_",names(Y),value=TRUE)),
                      c(grep("^model_3_",names(Y),value=TRUE)),c(grep("^model_21_",names(Y),value=TRUE)),c(grep("^model_4_",names(Y),value=TRUE)),
                      c(grep("^model_31_",names(Y),value=TRUE)),c(grep("^model_5_",names(Y),value=TRUE)),c(grep("^model_41_",names(Y),value=TRUE)),
                      c(grep("^model_42_",names(Y),value=TRUE)),c(grep("^model_17_",names(Y),value=TRUE)),c(grep("^model_50_regional",names(Y),value=TRUE)),
                      c(grep("^model_19_",names(Y),value=TRUE)),c(grep("^model_61_",names(Y),value=TRUE)),c(grep("^model_50_fe",names(Y),value=TRUE))
                    )
        )
      } else if (i=="_stateFE") {
        setcolorder(Y,
                    c("rn",
                      c(grep("^model_9_",names(Y),value=TRUE)),c(grep("^model_2_",names(Y),value=TRUE)),c(grep("^model_10_",names(Y),value=TRUE)),
                      c(grep("^model_12_fe",names(Y),value=TRUE)),c(grep("^model_11_",names(Y),value=TRUE)),c(grep("^model_22_",names(Y),value=TRUE)),
                      c(grep("^model_12_regional",names(Y),value=TRUE)),c(grep("^model_32_",names(Y),value=TRUE)),c(grep("^model_13_regional",names(Y),value=TRUE)),
                      c(grep("^model_42_",names(Y),value=TRUE)),c(grep("^model_18_",names(Y),value=TRUE)),c(grep("^model_13_fe",names(Y),value=TRUE)),
                      c(grep("^model_26_",names(Y),value=TRUE)),c(grep("^model_15_",names(Y),value=TRUE)),c(grep("^model_37",names(Y),value=TRUE)),
                      c(grep("^model_46",names(Y),value=TRUE))
                    )
        )
      }
      assign(paste0("coef_a",j,"_m1_dt",dt,i,"_ordered"),Y)
      #assign(list[[t+1]],paste0("coef_a",j,"_m1_dt",dt,i,"_ordered"))
      list[[t+1]] <- eval(as.name(paste0("coef_a",j,"_m1_dt",dt,i,"_ordered")))
      list_names[[t+1]] <- paste0("coef_a",j,"_m1_dt",dt,i,"_ordered")
      rm(Y)
      t <- t+2
    }
  }
  # Exporting to Excel
  wrapper_Excel(
    list,
    list_names,
    paste0(main_directory,"R - Processing data/output/Tables/a_X_all_1940_ctynhg_1910_combined_reg",i,".xlsx")
  )
  rm(list = ls(pattern="^coef_")) 
  rm(list,list_names)
}

# Database where workers in new sectors are excluded
## 1. LHS are constructed including all workers
for (i in c("","_stateFE")) {
  list_names <- list <- vector(mode="list"); t <- 1
  for (j in c(1,2)) {
    for (dt in c(2,3)) {
      Y <- Reduce(
          function(x, y, ...) merge(x, y, by="rn", all = TRUE, allow.cartesian = TRUE, ...),
          list(
            eval(as.name(paste0("regional_reg_no_new_sec_1940_ctynhg_1910_b",j,"_X_all_mt1_dt",dt,i))),
            eval(as.name(paste0("fe_reg_no_new_sec_1940_ctynhg_1910_b",j,"_X_all_m1_dt",dt,"X1",i))),
            eval(as.name(paste0("fe_reg_no_new_sec_1940_ctynhg_1910_b",j,"_X_all_m1_dt",dt,"X2",i))),
            eval(as.name(paste0("fe_reg_no_new_sec_1940_ctynhg_1910_b",j,"_X_all_m1_dt",dt,"X5",i)))
            )
        )
      
      # Create vectors with TRUTH values if a given variable is not NA
      Y <- 
        f_reg_results_VAR_exist(Y,rn,
                                c("statefip_194010","sh_lit_1930","sh_age_16_49_1930","sh_age_16_49_1940","sh_ind1950_main_2_1930","sh_occ1950_main_100_1930","sh_labforce_1930","sh_labforce_1940"),
                                c("State FE","Regional V.","Base V. 1930","Base V. 1940","Industry V.","Occupation V.","Laborforce V. 1930","Laborforce V. 1940")  
                                )
      
      # Ordering regression variables
      names_vector <- 
         unique( 
           Y$rn
           )
      Order <- list(
                  c(grep("^new_sec_all_1930",names_vector,value=TRUE)),c(grep("^new_sec_main_1930",names_vector,value=TRUE)),
                  c(grep("^new_sec_serv_1930",names_vector,value=TRUE)),c(grep("^H_",names_vector,value=TRUE)),
                  c(grep("perwt_1930",names_vector,value=TRUE)),c(grep("^sh_lit",names_vector,value=TRUE)),
                  c(grep("State FE",names_vector,value=TRUE)),c(grep("Regional V.",names_vector,value=TRUE)),
                  c(grep("Occupation V.",names_vector,value=TRUE)),c(grep("Industry V.",names_vector,value=TRUE)),
                  c(grep("Base V. 1930",names_vector,value=TRUE)),c(grep("Base V. 1940",names_vector,value=TRUE)),
                  c(grep("Laborforce V. 1930",names_vector,value=TRUE)),c(grep("Laborforce V. 1940",names_vector,value=TRUE)),
                  c("adj.r2"),c("nobs"),c(grep("^sh_occ1950_main",names_vector,value=TRUE)),
                  c(grep("^sh_ind1950_main",names_vector,value=TRUE)),c(grep("^sh_age_16_49",names_vector,value=TRUE)),
                  c(grep("^sh_educ_",names_vector,value=TRUE)),c(grep("^sh_mig_us_",names_vector,value=TRUE)),
                  c(grep("^sh_mig_ab_",names_vector,value=TRUE)),c(grep("^sh_age_more5",names_vector,value=TRUE)),
                  c(grep("^sh_labforce_",names_vector,value=TRUE)),c(grep("^sh_unemp_",names_vector,value=TRUE)),
                  c(grep("^sh_wrkwage_",names_vector,value=TRUE)),c(grep("^statefip_1940",names_vector,value=TRUE))
                  )
      Y <- f_order_reg(Y,Order,rn)
      assign(paste0("coef_b",j,"_m1_dt",dt,i),Y)
      list[[t]] <- eval(as.name(paste0("coef_b",j,"_m1_dt",dt,i)))
      list_names[[t]] <- paste0("coef_b",j,"_m1_dt",dt,i)
      
      Y <- copy(Y)
      if (i=="") {
        setcolorder(Y,
                    c("rn",
                      c(grep("^model_1_",names(Y),value=TRUE)),c(grep("^model_2_",names(Y),value=TRUE)),c(grep("^model_11_",names(Y),value=TRUE)),
                      c(grep("^model_3_",names(Y),value=TRUE)),c(grep("^model_21_",names(Y),value=TRUE)),c(grep("^model_4_",names(Y),value=TRUE)),
                      c(grep("^model_31_",names(Y),value=TRUE)),c(grep("^model_5_",names(Y),value=TRUE)),c(grep("^model_41_",names(Y),value=TRUE)),
                      c(grep("^model_42_",names(Y),value=TRUE)),c(grep("^model_17_",names(Y),value=TRUE)),c(grep("^model_50_regional",names(Y),value=TRUE)),
                      c(grep("^model_19_",names(Y),value=TRUE)),c(grep("^model_61_",names(Y),value=TRUE)),c(grep("^model_50_fe",names(Y),value=TRUE))
                    )
        )
      } else if (i=="_stateFE") {
        setcolorder(Y,
                    c("rn",
                      c(grep("^model_9_",names(Y),value=TRUE)),c(grep("^model_2_",names(Y),value=TRUE)),c(grep("^model_10_",names(Y),value=TRUE)),
                      c(grep("^model_12_fe",names(Y),value=TRUE)),c(grep("^model_11_",names(Y),value=TRUE)),c(grep("^model_22_",names(Y),value=TRUE)),
                      c(grep("^model_12_regional",names(Y),value=TRUE)),c(grep("^model_32_",names(Y),value=TRUE)),c(grep("^model_13_regional",names(Y),value=TRUE)),
                      c(grep("^model_42_",names(Y),value=TRUE)),c(grep("^model_18_",names(Y),value=TRUE)),c(grep("^model_13_fe",names(Y),value=TRUE)),
                      c(grep("^model_26_",names(Y),value=TRUE)),c(grep("^model_15_",names(Y),value=TRUE)),c(grep("^model_37",names(Y),value=TRUE)),
                      c(grep("^model_46",names(Y),value=TRUE))
                    )
        )
      }
      assign(paste0("coef_b",j,"_m1_dt",dt,i,"_ordered"),Y)
      list[[t+1]] <- eval(as.name(paste0("coef_b",j,"_m1_dt",dt,i,"_ordered")))
      list_names[[t+1]] <- paste0("coef_b",j,"_m1_dt",dt,i,"_ordered")
      rm(Y)
      t <- t+2
    }
  }
  # Exporting to Excel
  wrapper_Excel(
    list,
    list_names,
    paste0(main_directory,"R - Processing data/output/Tables/b_X_all_1940_ctynhg_1910_combined_reg",i,".xlsx")
  )
  rm(list = ls(pattern="^coef_"))
  rm(list,list_names)
}

## 2. ind and occ are constructed excluding workers in new sectors
for (i in c("","_stateFE")) {
  list_names <- list <- vector(mode="list"); t <- 1
  for (j in c(1,2)) {
    for (dt in c(2,3)) {
      Y <- Reduce(
          function(x, y, ...) merge(x, y, by="rn", all = TRUE, allow.cartesian = TRUE, ...),
          list(
            eval(as.name(paste0("regional_reg_no_new_sec_1940_ctynhg_1910_b",j,"_X_no_nsec_1_mt1_dt",dt,i))),
            eval(as.name(paste0("fe_reg_no_new_sec_1940_ctynhg_1910_b",j,"_X_nsec2_m1_dt",dt,"X1",i))),
            eval(as.name(paste0("fe_reg_no_new_sec_1940_ctynhg_1910_b",j,"_X_nsec2_m1_dt",dt,"X2",i))),
            eval(as.name(paste0("fe_reg_no_new_sec_1940_ctynhg_1910_b",j,"_X_nsec2_m1_dt",dt,"X5",i)))
            )
        )
      
      # Create vectors with TRUTH values if a given variable is not NA
      Y <- 
        f_reg_results_VAR_exist(Y,rn,
                                c("statefip_194010","sh_lit_1930","sh_age_16_49_1930","sh_age_16_49_1940","sh_ind1950_main_2_1930","sh_occ1950_main_100_1930","sh_labforce_1930","sh_labforce_1940"),
                                c("State FE","Regional V.","Base V. 1930","Base V. 1940","Industry V.","Occupation V.","Laborforce V. 1930","Laborforce V. 1940")  
                                )
      
      # Ordering regression variables
      names_vector <- 
         unique( 
           Y$rn
           )
      Order <- list(
                  c(grep("^new_sec_all_1930",names_vector,value=TRUE)),c(grep("^new_sec_main_1930",names_vector,value=TRUE)),
                  c(grep("^new_sec_serv_1930",names_vector,value=TRUE)),c(grep("^H_",names_vector,value=TRUE)),
                  c(grep("perwt_1930",names_vector,value=TRUE)),c(grep("^sh_lit",names_vector,value=TRUE)),
                  c(grep("State FE",names_vector,value=TRUE)),c(grep("Regional V.",names_vector,value=TRUE)),
                  c(grep("Occupation V.",names_vector,value=TRUE)),c(grep("Industry V.",names_vector,value=TRUE)),
                  c(grep("Base V. 1930",names_vector,value=TRUE)),c(grep("Base V. 1940",names_vector,value=TRUE)),
                  c(grep("Laborforce V. 1930",names_vector,value=TRUE)),c(grep("Laborforce V. 1940",names_vector,value=TRUE)),
                  c("adj.r2"),c("nobs"),c(grep("^sh_occ1950_main",names_vector,value=TRUE)),
                  c(grep("^sh_ind1950_main",names_vector,value=TRUE)),c(grep("^sh_age_16_49",names_vector,value=TRUE)),
                  c(grep("^sh_educ_",names_vector,value=TRUE)),c(grep("^sh_mig_us_",names_vector,value=TRUE)),
                  c(grep("^sh_mig_ab_",names_vector,value=TRUE)),c(grep("^sh_age_more5",names_vector,value=TRUE)),
                  c(grep("^sh_labforce_",names_vector,value=TRUE)),c(grep("^sh_unemp_",names_vector,value=TRUE)),
                  c(grep("^sh_wrkwage_",names_vector,value=TRUE)),c(grep("^statefip_1940",names_vector,value=TRUE))
                  )
      Y <- f_order_reg(Y,Order,rn)
      assign(paste0("coef_b",j,"_m1_dt",dt,i),Y)
      list[[t]] <- eval(as.name(paste0("coef_b",j,"_m1_dt",dt,i)))
      list_names[[t]] <- paste0("coef_b",j,"_m1_dt",dt,i)
      
      Y <- copy(Y)
      if (i=="") {
        setcolorder(Y,
                    c("rn",
                      c(grep("^model_1_",names(Y),value=TRUE)),c(grep("^model_2_",names(Y),value=TRUE)),c(grep("^model_11_",names(Y),value=TRUE)),
                      c(grep("^model_3_",names(Y),value=TRUE)),c(grep("^model_21_",names(Y),value=TRUE)),c(grep("^model_4_",names(Y),value=TRUE)),
                      c(grep("^model_31_",names(Y),value=TRUE)),c(grep("^model_5_",names(Y),value=TRUE)),c(grep("^model_41_",names(Y),value=TRUE)),
                      c(grep("^model_42_",names(Y),value=TRUE)),c(grep("^model_17_",names(Y),value=TRUE)),c(grep("^model_50_regional",names(Y),value=TRUE)),
                      c(grep("^model_19_",names(Y),value=TRUE)),c(grep("^model_61_",names(Y),value=TRUE)),c(grep("^model_50_fe",names(Y),value=TRUE))
                    )
        )
      } else if (i=="_stateFE") {
        setcolorder(Y,
                    c("rn",
                      c(grep("^model_9_",names(Y),value=TRUE)),c(grep("^model_2_",names(Y),value=TRUE)),c(grep("^model_10_",names(Y),value=TRUE)),
                      c(grep("^model_12_fe",names(Y),value=TRUE)),c(grep("^model_11_",names(Y),value=TRUE)),c(grep("^model_22_",names(Y),value=TRUE)),
                      c(grep("^model_12_regional",names(Y),value=TRUE)),c(grep("^model_32_",names(Y),value=TRUE)),c(grep("^model_13_regional",names(Y),value=TRUE)),
                      c(grep("^model_42_",names(Y),value=TRUE)),c(grep("^model_18_",names(Y),value=TRUE)),c(grep("^model_13_fe",names(Y),value=TRUE)),
                      c(grep("^model_26_",names(Y),value=TRUE)),c(grep("^model_15_",names(Y),value=TRUE)),c(grep("^model_37",names(Y),value=TRUE)),
                      c(grep("^model_46",names(Y),value=TRUE))
                    )
        )
      }
      assign(paste0("coef_b",j,"_m1_dt",dt,i,"_ordered"),Y)
      list[[t+1]] <- eval(as.name(paste0("coef_b",j,"_m1_dt",dt,i,"_ordered")))
      list_names[[t+1]] <- paste0("coef_b",j,"_m1_dt",dt,i,"_ordered")
      rm(Y)
      t <- t+2
    }
  }
  # Exporting to Excel
  wrapper_Excel(
    list,
    list_names,
    paste0(main_directory,"R - Processing data/output/Tables/b_X_nsec_1_1940_ctynhg_1910_combined_reg",i,".xlsx")
  )
  rm(list = ls(pattern="^coef_"))
  rm(list,list_names)
}

## 3. ind and occ + regional vars are constructed excluding workers in new sectors
for (i in c("","_stateFE")) {
  list_names <- list <- vector(mode="list"); t <- 1
  for (j in c(1,2)) {
    for (dt in c(2,3)) {
      Y <- Reduce(
          function(x, y, ...) merge(x, y, by="rn", all = TRUE, allow.cartesian = TRUE, ...),
          list(
            eval(as.name(paste0("regional_reg_no_new_sec_1940_ctynhg_1910_b",j,"_X_no_nsec_2_mt1_dt",dt,i))),
            eval(as.name(paste0("fe_reg_no_new_sec_1940_ctynhg_1910_b",j,"_X_nsec3_m1_dt",dt,"X1",i))),
            eval(as.name(paste0("fe_reg_no_new_sec_1940_ctynhg_1910_b",j,"_X_nsec3_m1_dt",dt,"X2",i))),
            eval(as.name(paste0("fe_reg_no_new_sec_1940_ctynhg_1910_b",j,"_X_nsec3_m1_dt",dt,"X5",i)))
            )
        )
      
      # Create vectors with TRUTH values if a given variable is not NA
      Y <- 
        f_reg_results_VAR_exist(Y,rn,
                                c("statefip_194010","sh_lit_1930","sh_age_16_49_1930","sh_age_16_49_1940","sh_ind1950_main_2_1930","sh_occ1950_main_100_1930","sh_labforce_1930","sh_labforce_1940"),
                                c("State FE","Regional V.","Base V. 1930","Base V. 1940","Industry V.","Occupation V.","Laborforce V. 1930","Laborforce V. 1940")  
                                )
      
      # Ordering regression variables
      names_vector <- 
         unique( 
           Y$rn
           )
      Order <- list(
                  c(grep("^new_sec_all_1930",names_vector,value=TRUE)),c(grep("^new_sec_main_1930",names_vector,value=TRUE)),
                  c(grep("^new_sec_serv_1930",names_vector,value=TRUE)),c(grep("^H_",names_vector,value=TRUE)),
                  c(grep("perwt_1930",names_vector,value=TRUE)),c(grep("^sh_lit",names_vector,value=TRUE)),
                  c(grep("State FE",names_vector,value=TRUE)),c(grep("Regional V.",names_vector,value=TRUE)),
                  c(grep("Occupation V.",names_vector,value=TRUE)),c(grep("Industry V.",names_vector,value=TRUE)),
                  c(grep("Base V. 1930",names_vector,value=TRUE)),c(grep("Base V. 1940",names_vector,value=TRUE)),
                  c(grep("Laborforce V. 1930",names_vector,value=TRUE)),c(grep("Laborforce V. 1940",names_vector,value=TRUE)),
                  c("adj.r2"),c("nobs"),c(grep("^sh_occ1950_main",names_vector,value=TRUE)),
                  c(grep("^sh_ind1950_main",names_vector,value=TRUE)),c(grep("^sh_age_16_49",names_vector,value=TRUE)),
                  c(grep("^sh_educ_",names_vector,value=TRUE)),c(grep("^sh_mig_us_",names_vector,value=TRUE)),
                  c(grep("^sh_mig_ab_",names_vector,value=TRUE)),c(grep("^sh_age_more5",names_vector,value=TRUE)),
                  c(grep("^sh_labforce_",names_vector,value=TRUE)),c(grep("^sh_unemp_",names_vector,value=TRUE)),
                  c(grep("^sh_wrkwage_",names_vector,value=TRUE)),c(grep("^statefip_1940",names_vector,value=TRUE))
                  )
      Y <- f_order_reg(Y,Order,rn)
      assign(paste0("coef_b",j,"_m1_dt",dt,i),Y)
      list[[t]] <- eval(as.name(paste0("coef_b",j,"_m1_dt",dt,i)))
      list_names[[t]] <- paste0("coef_b",j,"_m1_dt",dt,i)
      
      Y <- copy(Y)
      if (i=="") {
        setcolorder(Y,
                    c("rn",
                      c(grep("^model_1_",names(Y),value=TRUE)),c(grep("^model_2_",names(Y),value=TRUE)),c(grep("^model_11_",names(Y),value=TRUE)),
                      c(grep("^model_3_",names(Y),value=TRUE)),c(grep("^model_21_",names(Y),value=TRUE)),c(grep("^model_4_",names(Y),value=TRUE)),
                      c(grep("^model_31_",names(Y),value=TRUE)),c(grep("^model_5_",names(Y),value=TRUE)),c(grep("^model_41_",names(Y),value=TRUE)),
                      c(grep("^model_42_",names(Y),value=TRUE)),c(grep("^model_17_",names(Y),value=TRUE)),c(grep("^model_50_regional",names(Y),value=TRUE)),
                      c(grep("^model_19_",names(Y),value=TRUE)),c(grep("^model_61_",names(Y),value=TRUE)),c(grep("^model_50_fe",names(Y),value=TRUE))
                    )
        )
      } else if (i=="_stateFE") {
        setcolorder(Y,
                    c("rn",
                      c(grep("^model_9_",names(Y),value=TRUE)),c(grep("^model_2_",names(Y),value=TRUE)),c(grep("^model_10_",names(Y),value=TRUE)),
                      c(grep("^model_12_fe",names(Y),value=TRUE)),c(grep("^model_11_",names(Y),value=TRUE)),c(grep("^model_22_",names(Y),value=TRUE)),
                      c(grep("^model_12_regional",names(Y),value=TRUE)),c(grep("^model_32_",names(Y),value=TRUE)),c(grep("^model_13_regional",names(Y),value=TRUE)),
                      c(grep("^model_42_",names(Y),value=TRUE)),c(grep("^model_18_",names(Y),value=TRUE)),c(grep("^model_13_fe",names(Y),value=TRUE)),
                      c(grep("^model_26_",names(Y),value=TRUE)),c(grep("^model_15_",names(Y),value=TRUE)),c(grep("^model_37",names(Y),value=TRUE)),
                      c(grep("^model_46",names(Y),value=TRUE))
                    )
        )
      }
      assign(paste0("coef_b",j,"_m1_dt",dt,i,"_ordered"),Y)
      list[[t+1]] <- eval(as.name(paste0("coef_b",j,"_m1_dt",dt,i,"_ordered")))
      list_names[[t+1]] <- paste0("coef_b",j,"_m1_dt",dt,i,"_ordered")
      rm(Y)
      t <- t+2
    }
  }
  # Exporting to Excel
  wrapper_Excel(
    list,
    list_names,
    paste0(main_directory,"R - Processing data/output/Tables/b_X_nsec_2_1940_ctynhg_1910_combined_reg",i,".xlsx")
  )
  rm(list = ls(pattern="^coef_"))
  rm(list,list_names)
}
```


# Part 10. Panel
The period regression that we have been running is $\nu_{ct} = \beta NewSec_{c,t-1} + \gamma X_{c,t-1} + u_{ct}$. In this section we will use a panel data approach to correct for time invariant indivudal effects and time effects. For that we need to construct a dataset with the information at $t$ and $t-1$. 
## Loading packages and erasing the workspace (make sure to have loaded f_load_pk)
```{r}
rm(list = setdiff(ls(),c(lsf.str(),"main_directory") ))
f_load_pk()
```

## 1. Regressions following Lin (2011) - At the countynhg_1910 level - Using as endogenous variable the Fixed Effects from the First Stage regressions

1940 Information:
1. FE:
- New Sectors variables

- Covariates

2. Regional:
- New Sectors variables

- Covariates

### 1.1. Construct regional level database
#### 1.1.1 Adding regional level variables
```{r}
# Information used for 1940 Regressions ----
## 1940
census_sample_1940_countynhg_1910 <-read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1940_agg_countynhg_1910.fst"),as.data.table=TRUE)
census_sample_1940_countynhg_1910 <- census_sample_1940_countynhg_1910[,`:=`(sh_age_less16 = sh_age_main_0+sh_age_main_1,sh_age_16_49 = sh_age_main_2+sh_age_main_3+sh_age_main_4+sh_age_main_5,sh_age_more50 = sh_age_main_6+sh_age_main_7)][,`:=`(new_sec_all=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466 +sh_new_sector_ind1950_556+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816 + sh_new_sector_ind1950_856,
                              new_sec_main=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466+ sh_new_sector_ind1950_856,
                              new_sec_serv=sh_new_sector_ind1950_556+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816)]
cols <- grep("^(?!.*sh_new_)(?!.*sh_age_main)",names(census_sample_1940_countynhg_1910),value=TRUE,perl=TRUE)
census_sample_1940_countynhg_1910 <- census_sample_1940_countynhg_1910[,cols,with=FALSE]
cols <- names(census_sample_1940_countynhg_1910[,!c("countynhg_1910")])
setnames(census_sample_1940_countynhg_1910,cols,paste0(cols,"_t"))

temp <- read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1940_agg_countynhg_1910_no_new_sec_all.fst"),as.data.table=TRUE)
cols <- grep("^sh_m_|^sh_f_|^statefip",names(temp),value=TRUE)
temp <- temp[,!cols,with=FALSE][,`:=`(sh_age_less16 = sh_age_main_0+sh_age_main_1,sh_age_16_49 = sh_age_main_2+sh_age_main_3+sh_age_main_4+sh_age_main_5,sh_age_more50 = sh_age_main_6+sh_age_main_7)]
cols <- grep("^(?!.*sh_new_)(?!.*sh_age_main)",names(temp),value=TRUE,perl=TRUE)
temp <- temp[,cols,with=FALSE]

cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_t_no_new_sec_all"))

census_sample_1940_countynhg_1910 <- merge(census_sample_1940_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)
temp <- read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1940_agg_countynhg_1910_no_new_sec_main.fst"),as.data.table=TRUE)
cols <- grep("^sh_m_|^sh_f_|^statefip",names(temp),value=TRUE)
temp <- temp[,!cols,with=FALSE][,`:=`(sh_age_less16 = sh_age_main_0+sh_age_main_1,sh_age_16_49 = sh_age_main_2+sh_age_main_3+sh_age_main_4+sh_age_main_5,sh_age_more50 = sh_age_main_6+sh_age_main_7)]
cols <- grep("^(?!.*sh_new_)(?!.*sh_age_main)",names(temp),value=TRUE,perl=TRUE)
temp <- temp[,cols,with=FALSE]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_t_no_new_sec_main"))
census_sample_1940_countynhg_1910 <- merge(census_sample_1940_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)

# 1930 
temp <-read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1930_agg_countynhg_1910.fst"),as.data.table=TRUE)
cols <- grep("^sh_m_|^sh_f_|^statefip|^sh_base|^sh_red",names(temp),value=TRUE)
temp <- temp[,!cols,with=FALSE][,`:=`(sh_age_less16 = sh_age_main_0+sh_age_main_1,sh_age_16_49 = sh_age_main_2+sh_age_main_3+sh_age_main_4+sh_age_main_5,sh_age_more50 = sh_age_main_6+sh_age_main_7)][,`:=`(new_sec_all=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466 +sh_new_sector_ind1950_556+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816 + sh_new_sector_ind1950_856,
                              new_sec_main=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466+ sh_new_sector_ind1950_856,
                              new_sec_serv=sh_new_sector_ind1950_556+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816)]
cols <- grep("^(?!.*sh_new_sector)(?!.*sh_age_main)",names(temp),value=TRUE,perl=TRUE)
temp <- temp[,cols,with=FALSE]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_lt"))

census_sample_1940_countynhg_1910 <- merge(census_sample_1940_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)

temp <-read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1930_agg_countynhg_1910_no_new_sec_all.fst"),as.data.table=TRUE)
cols <- grep("^sh_m_|^sh_f_|^statefip|^sh_base|^sh_red",names(temp),value=TRUE)
temp <- temp[,!cols,with=FALSE][,`:=`(sh_age_less16 = sh_age_main_0+sh_age_main_1,sh_age_16_49 = sh_age_main_2+sh_age_main_3+sh_age_main_4+sh_age_main_5,sh_age_more50 = sh_age_main_6+sh_age_main_7)]
cols <- grep("^(?!.*sh_age_main)",names(temp),value=TRUE,perl=TRUE)
temp <- temp[,cols,with=FALSE]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_lt_no_new_sec_all"))

census_sample_1940_countynhg_1910 <- merge(census_sample_1940_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)

temp <-read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1930_agg_countynhg_1910_no_new_sec_main.fst"),as.data.table=TRUE)
cols <- grep("^sh_m_|^sh_f_|^statefip|^sh_base|^sh_red",names(temp),value=TRUE)
temp <- temp[,!cols,with=FALSE][,`:=`(sh_age_less16 = sh_age_main_0+sh_age_main_1,sh_age_16_49 = sh_age_main_2+sh_age_main_3+sh_age_main_4+sh_age_main_5,sh_age_more50 = sh_age_main_6+sh_age_main_7)]
cols <- grep("^(?!.*sh_age_main)",names(temp),value=TRUE,perl=TRUE)
temp <- temp[,cols,with=FALSE]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_lt_no_new_sec_main"))

census_sample_1940_countynhg_1910 <- merge(census_sample_1940_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)


# Information used for 1930 Regressions ----
## 1930
census_sample_1930_countynhg_1910 <-read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1930_agg_countynhg_1910.fst"),as.data.table=TRUE)
# We won't use the new occupation share variables, since we will use as explanatory variables the county FE from the First Stage Regression
cols <- grep("^sh_base|^sh_red",names(census_sample_1930_countynhg_1910),value=TRUE)
census_sample_1930_countynhg_1910 <- census_sample_1930_countynhg_1910[,!cols,with=FALSE][,`:=`(sh_age_less16 = sh_age_main_0+sh_age_main_1,sh_age_16_49 = sh_age_main_2+sh_age_main_3+sh_age_main_4+sh_age_main_5,sh_age_more50 = sh_age_main_6+sh_age_main_7)][,`:=`(new_sec_all=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466 +sh_new_sector_ind1950_556+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816 + sh_new_sector_ind1950_856,
                              new_sec_main=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466+ sh_new_sector_ind1950_856,
                              new_sec_serv=sh_new_sector_ind1950_556+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816)]
# Dropping the share of age main groups (we will work only with three groups) and the share of new sectors for individual sectors (we will only work with new sectors, further divided between main and service sectors)
cols <- grep("^(?!.*sh_new_sector)(?!.*sh_age_main)",names(census_sample_1930_countynhg_1910),value=TRUE,perl=TRUE)
census_sample_1930_countynhg_1910 <- census_sample_1930_countynhg_1910[,cols,with=FALSE]
cols <- names(census_sample_1930_countynhg_1910[,!c("countynhg_1910")])
setnames(census_sample_1930_countynhg_1910,cols,paste0(cols,"_t"))

temp <-read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1930_agg_countynhg_1910_no_new_sec_all.fst"),as.data.table=TRUE)
cols <- grep("^statefip|^sh_base|^sh_red",names(temp),value=TRUE)
temp <- temp[,!cols,with=FALSE][,`:=`(sh_age_less16 = sh_age_main_0+sh_age_main_1,sh_age_16_49 = sh_age_main_2+sh_age_main_3+sh_age_main_4+sh_age_main_5,sh_age_more50 = sh_age_main_6+sh_age_main_7)]
cols <- grep("^(?!.*sh_age_main)",names(temp),value=TRUE,perl=TRUE)
temp <- temp[,cols,with=FALSE]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_t_no_new_sec_all"))

census_sample_1930_countynhg_1910 <- merge(census_sample_1930_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)

temp <-read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1930_agg_countynhg_1910_no_new_sec_main.fst"),as.data.table=TRUE)
cols <- grep("^statefip|^sh_base|^sh_red",names(temp),value=TRUE)
temp <- temp[,!cols,with=FALSE][,`:=`(sh_age_less16 = sh_age_main_0+sh_age_main_1,sh_age_16_49 = sh_age_main_2+sh_age_main_3+sh_age_main_4+sh_age_main_5,sh_age_more50 = sh_age_main_6+sh_age_main_7)]
cols <- grep("^(?!.*sh_age_main)",names(temp),value=TRUE,perl=TRUE)
temp <- temp[,cols,with=FALSE]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_t_no_new_sec_main"))

census_sample_1930_countynhg_1910 <- merge(census_sample_1930_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)

## 1920
temp <-read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1920_agg_countynhg_1910.fst"),as.data.table=TRUE)
cols <- grep("^statefip",names(temp),value=TRUE)
temp <- temp[,!cols,with=FALSE][,`:=`(sh_age_less16 = sh_age_main_0+sh_age_main_1,sh_age_16_49 = sh_age_main_2+sh_age_main_3+sh_age_main_4+sh_age_main_5,sh_age_more50 = sh_age_main_6+sh_age_main_7)][,`:=`(new_sec_all=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466 +sh_new_sector_ind1950_556+sh_new_sector_ind1950_606+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816,
                              new_sec_main=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466,
                              new_sec_serv=sh_new_sector_ind1950_556+sh_new_sector_ind1950_606+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816)]
cols <- grep("^(?!.*sh_new_sector)(?!.*sh_age_main)",names(temp),value=TRUE,perl=TRUE)
temp <- temp[,cols,with=FALSE]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_lt"))

census_sample_1930_countynhg_1910 <- merge(census_sample_1930_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)

temp <- read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1920_agg_countynhg_1910_no_new_sec_all.fst"),as.data.table=TRUE)
cols <- grep("^statefip|^sh_base|^sh_red",names(temp),value=TRUE)
temp <- temp[,!cols,with=FALSE][,`:=`(sh_age_less16 = sh_age_main_0+sh_age_main_1,sh_age_16_49 = sh_age_main_2+sh_age_main_3+sh_age_main_4+sh_age_main_5,sh_age_more50 = sh_age_main_6+sh_age_main_7)]
cols <- grep("^(?!.*sh_age_main)",names(temp),value=TRUE,perl=TRUE)
temp <- temp[,cols,with=FALSE]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_lt_no_new_sec_all"))

census_sample_1930_countynhg_1910 <- merge(census_sample_1930_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)

temp <- read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1920_agg_countynhg_1910_no_new_sec_main.fst"),as.data.table=TRUE)
cols <- grep("^statefip|^sh_base|^sh_red",names(temp),value=TRUE)
temp <- temp[,!cols,with=FALSE][,`:=`(sh_age_less16 = sh_age_main_0+sh_age_main_1,sh_age_16_49 = sh_age_main_2+sh_age_main_3+sh_age_main_4+sh_age_main_5,sh_age_more50 = sh_age_main_6+sh_age_main_7)]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_lt_no_new_sec_main"))

census_sample_1930_countynhg_1910 <- merge(census_sample_1930_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)

```

#### 1.1.2. Creating joint dataset
- Dropping some variables and observations
  - I will drop variables that are only present in both datasets
  - I will drop counties that are not present in both years
```{r}
# Vector with the columns that are not in a given ser ----
Diff_1930 <- setdiff(names(census_sample_1930_countynhg_1910),names(census_sample_1940_countynhg_1910))
Diff_1940 <- setdiff(names(census_sample_1940_countynhg_1910),names(census_sample_1930_countynhg_1910))

#***TO-DO!!! 1930 
# - Why is "sh_labforce_emp_lt" not in 1930?? (---> 1930 has sh_labforce)
# - Education not in 1930?? Variable doesn't exist (---> Construct an education variable following santiago Perez's JMP)
#***TO-DO!!! 1940
# - Why sh_lit (---> 1. Compute it for 1940)
# - Why sh_[f or m]_[us or ab]_[t or lt] not? (---> Compute it using IPUMS data

# Vector of columns that are not in the other set (this helps us help us figure out why a variable is not present ina given year)
#Diff_1930 <-names(census_sample_1930_countynhg_1910)[names(census_sample_1930_countynhg_1910) %in%  Diff]
#Diff_1940 <- names(census_sample_1940_countynhg_1910)[names(census_sample_1940_countynhg_1910) %in%  Diff]

# Dropping columns, creating year and joining years ----
Pooled_sample_1930_1940_countynhg_1910 <- 
  rbind(
    census_sample_1930_countynhg_1910[,!Diff_1930,with=FALSE][,year:=as.factor(1930)][,year_1940:=0],
    census_sample_1940_countynhg_1910[,!Diff_1940,with=FALSE][,year:=as.factor(1940)][,year_1940:=1],
    fill=TRUE
  )[,count:=.N,by="countynhg_1910"][count==2][,count:=NULL]

# By countynhg create a variable with the min of the population -> will be used to drop observations
Pooled_sample_1930_1940_countynhg_1910 <- Pooled_sample_1930_1940_countynhg_1910[,min_pop:=min(perwt_t),by="countynhg_1910"]
```
*** **NOTE: We drop columns that are not in both sets. Some of these is simply because the variable didn't exist for that year, while others is because we forgot to compute it.** 

#### 1.1.3. Adding the region fixed effects
In this section I create two files (fe_1930, fe_1940) that contain the different FE, standard errors and weight.

For both 1930 and 1940 we used the following individual control variables to construct the FE (refer to the .Rmd files "bootstrap_fixed_effects_model...")
  - Base individual
  - Base individual + extra_individual                                            ".base.extra.no_new_sec.fst"
  - Base individual + extra_individual + other_individual                         ".base.extra.other.no_new_sec.fst"
  - Base individual + extra_individual + other_individual + educ                  ".base.extra.other.educ.no_new_sec.fst"
  - Base individual + extra_individual + other_individual + educ + ind1950        ".base.extra.other.educ.ind1950.no_new_sec.fst"
  - Base individual + extra_individual + other_individual + ind1950               ".base.extra.other.ind1950.no_new_sec.fst"
  
For 1940 I only computed the fixed effects for method 1 and datasets 2 and 3.
*** For now I only looked at the FE that exclude workers in new sectors

*** TO-DO: Construct also the bootstrap estimates for the case when we use all the workers (without excluding new sector workers)  
*** TO-DO/Note: the fst file "coef_final_1940_method1_dt3.btrap.perwtge_10000.base.extra.other.educ,ind1950.no_new_sec.fst", had some sort of issue. The file couldn't be opened and therefore the merge was giving issues. To **TEMPORARILLY** solve this I used the coef_bootstrapped... file and created the variables of interest.
***                         -----> The file should be created again
    
*** TO-DO: In the bootstrap file I need to redo "base.extra.other.educ.ind1950" (and as a sanity check also "base.extra.other.ind1950"). For now I simply associate "...other.ind1950" to  "...other.educ.ind1950"
```{r}
# 1930 ----
fe_1930 <- census_sample_1930_countynhg_1910[,c("countynhg_1910")]
for (pop in c(10000)) {
  for (workers in c("no_new_sec","all")) {
    for(cov in c("base","base.extra","base.extra.other","base.extra.other.educ","base.extra.other.educ.ind1950","base.extra.other.ind1950")) {
      temp <- read_fst(paste0(main_directory,"R - Processing data/output/Rdata/coef_final_1930_method_sh_red_tit.btrap.perwtge_",pop,".",cov,".",workers,".fst"),as.data.table=TRUE,columns = c("rn","coef.b","se.b"))
      fe_1930 <- merge(fe_1930[,countynhg_1910:=as.factor(countynhg_1910)],temp[,c("rn","coef.b","se.b")],by.x="countynhg_1910",by.y="rn",all.x=TRUE,all.y=FALSE)
      fe_1930[,weights:=1/(se.b^2)] 
      
      setnames(
        fe_1930,
        c("coef.b","se.b","weights"),
        c(
          paste0("fe.method_","sh_red_tit",".perwtge_",pop,".",cov,".",workers),
          paste0("se.method_","sh_red_tit",".perwtge_",pop,".",cov,".",workers),
          paste0("weights.method_","sh_red_tit",".perwtge_",pop,".",cov,".",workers)
        )
      )
      rm(temp)
    }
  }
}

# 1940 ----
fe_1940 <- census_sample_1940_countynhg_1910[,c("countynhg_1910")]
for (pop in c(10000)) {
  for (method in c(1)) {
    for (dataset in c(2,3)) {
      for (workers in c("no_new_sec","all")) {
        for(cov in c("base","base.extra","base.extra.other","base.extra.other.educ","base.extra.other.educ.ind1950","base.extra.other.ind1950")) {
          temp <- read_fst(paste0(main_directory,"R - Processing data/output/Rdata/coef_final_1940_method",method,"_dt",dataset,".btrap.perwtge_",pop,".",cov,".",workers,".fst"),as.data.table=TRUE,columns = c("rn","coef.b","se.b"))
          fe_1940 <- merge(fe_1940[,countynhg_1910:=as.factor(countynhg_1910)],temp[,c("rn","coef.b","se.b")],by.x="countynhg_1910",by.y="rn",all.x=TRUE,all.y=FALSE)
          fe_1940[,weights:=1/(se.b^2)] 
          
          setnames(
            fe_1940,
            c("coef.b","se.b","weights"),
            c(
              paste0("fe.method",method,"_dt",dataset,".perwtge_",pop,".",cov,".",workers),
              paste0("se.method",method,"_dt",dataset,".perwtge_",pop,".",cov,".",workers),
              paste0("weights.method",method,"_dt",dataset,".perwtge_",pop,".",cov,".",workers)
            )
          )
          rm(temp)
        }
      }
    }
  }
}

# Adding year
fe_1930 <- fe_1930[,year:=as.factor(1930)]
fe_1940 <- fe_1940[,year:=as.factor(1940)]

```


### 1.2 Creating variables for regressions and regression formulas

*** NEXT Steps:
- Create variables for regressions (Follow point 8)
- Create regressions (follow point 8)

```{r}
# Converting statefip_t and countynhg_1910 to a factor variable ----
#* NOTE: This way of performing the same operations on multiple DT works because the data.tables that appear in the list( ), even though internally are different that the original DTs, they are link. This would also work if we create a list and perform the operation on the list
invisible(
lapply(
  list(
    census_sample_1930_countynhg_1910,
    census_sample_1940_countynhg_1910,
    Pooled_sample_1930_1940_countynhg_1910), 
  function(x) x[,statefip_t:=as.factor(statefip_t)][,countynhg_1910:=as.factor(countynhg_1910)]
  )
)

# Creating state x year FE ----
Pooled_sample_1930_1940_countynhg_1910 <- Pooled_sample_1930_1940_countynhg_1910[,state_x_year:=paste0(statefip_t,"_",year)]
Pooled_sample_1930_1940_countynhg_1910 <- dummy_cols(Pooled_sample_1930_1940_countynhg_1910, select_columns = "state_x_year",remove_first_dummy = TRUE)
state_year <- paste0(" + ",paste0(grep("^state_x_year_",names(Pooled_sample_1930_1940_countynhg_1910),value=TRUE),collapse=" + "))
#*** One of the ways to include dummies for categorical variables is by introducing the variable as a factor. There are two problems with this: (1) some regression algorithms don't exclude the one of the categories which creates multicollinearity problem, and (2) we can't specify which category we will leave out

# Creating census division x year FE ----
Pooled_sample_1930_1940_countynhg_1910 <- Pooled_sample_1930_1940_countynhg_1910[,census_x_year:=paste0(division_t,"_",year)]
Pooled_sample_1930_1940_countynhg_1910 <- dummy_cols(Pooled_sample_1930_1940_countynhg_1910, select_columns = "census_x_year",remove_first_dummy = TRUE)
census_year <- paste0(" + ",paste0(grep("^census_x_year_[^1]",names(Pooled_sample_1930_1940_countynhg_1910),value=TRUE),collapse=" + "))

"^marst_[^1]"

# Reorder some variables ----
invisible(
lapply(
  list(
    census_sample_1930_countynhg_1910,
    census_sample_1940_countynhg_1910
    ),
  function(x) setcolorder(x,c("countynhg_1910","statefip_t","new_sec_all_lt","new_sec_main_lt","new_sec_serv_lt"))
  )
)
setcolorder(Pooled_sample_1930_1940_countynhg_1910,c("countynhg_1910","year","statefip_t","state_x_year","new_sec_all_lt","new_sec_main_lt","new_sec_serv_lt"))


# Regional ----
j <- 1; regional_1_lt <- indsh_var_lt <- occsh_var_lt <- base_1_lt <- base_2_lt <- base_3_lt <- base_4_lt <- regional_1_t <- indsh_var_t <- occsh_var_t <- base_1_t <- base_2_t <- base_3_t <- base_4_t  <- vector(mode = "list")

for (i in c("","_no_new_sec_all","_no_new_sec_main")) {
  regional_1_lt[[j]] <- paste0(paste0(paste0(c("sh_lit_lt","H_lt"),i),collapse=" + ")," + log(perwt_lt",i,")" )
  indsh_var_lt[[j]] <- paste0(paste0(grep("^sh_ind1950_main_[^1]_lt$",names(census_sample_1940_countynhg_1910),value=TRUE),i),collapse=" + ")
  occsh_var_lt[[j]] <- paste0(paste0(grep("^sh_occ1950_main_[^0].+_lt$",names(census_sample_1940_countynhg_1910),value=TRUE),i),collapse=" + ")
  base_1_lt[[j]] <- paste0( paste0(c("sh_age_16_49_lt","sh_age_more50_lt","sh_male_lt","sh_race_2_lt","sh_race_3_lt","sh_urban_lt"),i),collapse=" + ")
  base_2_lt[[j]] <- paste0( paste0(c("sh_mig_us_lt","sh_mig_ab_lt"),i),collapse=" + ")
  ## For 1920 we don't have unemployment information, so I don't use it here (sh_unemp_lt refers to 1920 when year is 1930). This doesn't apply to the way the FE were constructed, since we used contemporary unemployment.
  base_3_lt[[j]] <- paste0( paste0(c("sh_labforce_lt","sh_wrkwage_lt"),i),collapse=" + ")
  base_4_lt[[j]] <- paste0( paste0(c("sh_marst_2_lt","sh_marst_3_lt"),collapse=" + "),i)
  regional_1_t[[j]] <- paste0(paste0(paste0(c("sh_educ_main_1_t","sh_educ_main_2_t","H_t$"),i),collapse=" + ")," + log(perwt_t",i,")" )
  indsh_var_t[[j]] <- paste0(paste0(grep("^sh_ind1950_main_[^1]_t$",names(census_sample_1940_countynhg_1910),value=TRUE),i),collapse=" + ")
  occsh_var_t[[j]] <- paste0(paste0(grep("^sh_occ1950_main_[^0].+_t$",names(census_sample_1940_countynhg_1910),value=TRUE),i),collapse=" + ")
  base_1_t[[j]] <- paste0( paste0(c("sh_age_16_49_t","sh_age_more50_t","sh_male_t","sh_race_2_t","sh_race_3_t","sh_urban_t"),collapse=" + "),i)
  base_2_t[[j]] <- paste0( paste0(c("sh_mig_us_t","sh_mig_ab_t"),i),collapse=" + ")
  base_3_t[[j]] <- paste0( paste0(c("sh_labforce_t","sh_unemp_t","sh_wrkwage_t"),i),collapse=" + ")
  base_4_t[[j]] <- paste0( paste0(c("sh_marst_2_t","sh_marst_3_t"),i),collapse=" + ")
  j <- j+1
}

```

### 1.3. Panel Regressions
1. sh_lit + log(perwt) + sh_new sectors (3 different cases)
2. sh_lit + log(perwt) + sh_new sectors (3 different cases) + sh_ind1950_main
3. sh_lit + log(perwt) + sh_new sectors (3 different cases) + sh_ind1950_main + sh_occ1950_main

Where base:   - (1) sh_age (three different groups), sh_male, sh_race, sh_urban, sh_mig_us, sh_mig_ab,   (maybe) sh_farm
              - (2) sh_labforce, sh_unenemp, sh_wrkwage
              - (3) sh_m_mig_us, sh_m_mig_ab, sh_f_mig_us, sh_f_mig_ab, sh_marst
Fixed effects:- statefip    
            
"Regional":   - (1) sh_lit, H, log(perwt)
              - (2) sh_occ1950_main, sh_ind1950_main

New Sector:   - new_sec_all, new_sec_main, new_sec_serv

New Work:     - sh_red_tit, sh_base_tit

It is not very clear what year should we use for the different variables. For the new sector variables the year should be 1920 and probably also for the regional variables. For the base variables I'm not entirely sure.
Regarding the variables excluding workers in new sectors, for sure we should do that for the New Work variables. We could also try to do that for the regional variables.

#### 1.3.1 Main Regressions
#### 1.3.1.1 Creating the different formulas for the regressions
Following Lin (2011) I will only consider initial city characteristics are regressors. That means that I won't regress share of new occupations in 1940 on base variables in 1940. The objective of the exercise is to understand the impact of the share of new sectors on the creation of new tasks in other sectors.

***Note: If I include county FEs, can I include also state ones? Lin does it, why is this not a problem?

- Regressions by: method (for now only one), dataset (2 and 3), individual covariates, with all workers are excluding workers in new sectors, with and without state FE ??, with main and services sectors separated

- All workers (lists a):
  - All the regional variables include all the workers (_X_all)
- Excluding workers in new sectors (lists b):   
  - 1. All regional variables include all workers (_X_all)
  - 2. Only the industry and occupation exclude workers (_X_nsec2)
  - 3. Industry, occupation and regional exclude workers (_X_nsec3)
  - 4. All variables exclude regional (_X_nsec4)
  
Lists containing the covariates. 
```{r}
a <- vector(mode = "list")
i_cFE <- 1
for (county_FE in c(""," + countynhg_1910"," + countynhg_1910 + year")) {
  a[[i_cFE]] <- vector(mode = "list")
  i_sFE <- 1
  for (state_FE in c(""," + statefip_t"," + state_x_year")) {
    a[[i_cFE]][[i_sFE]] <- vector(mode = "list")
    for (nsec in c(1,2,3,4)) {
      a[[i_cFE]][[i_sFE]][[nsec]] <- vector(mode = "list")
      if (nsec==1) { i1 <- i2 <- i3 <- 1   # All covariates use all workers
      } else if (nsec==2) { i1 <- i2 <- 1; i3 <- 2   # Industry and occupation variables computed excluding new sector workers
      } else if (nsec==3) { i1 <-  1; i3 <- i2 <- 2  # + Regional variables also computed excluding new sectors
      } else if (nsec==4) { i1 <- i2 <- i3 <- 2      # + Base variables also computed excluding new sectors
      }
       vector <- 
        as.data.table(expand.grid(
          c(
            paste0(""),
            paste0(" + ",regional_1_lt[[i2]]),
            paste0(" + ",regional_1_lt[[i2]]," + ",indsh_var_lt[[i3]]),
            paste0(" + ",regional_1_lt[[i2]]," + ",occsh_var_lt[[i3]]),
            paste0(" + ",regional_1_lt[[i2]]," + ",indsh_var_lt[[i3]]," + ",occsh_var_lt[[i3]]),
            paste0(" + ",indsh_var_lt[[i3]]),
            paste0(" + ",occsh_var_lt[[i3]]),
            paste0(" + ",indsh_var_lt[[i3]]," + ",occsh_var_lt[[i3]])
          ),
          c(
            paste0(""),
            paste0(" + ",base_1_lt[[i1]]," + ",base_3_lt[[i1]]),
            paste0(" + ",base_1_lt[[i1]]," + ",base_3_lt[[i1]]," + ",base_2_lt[[i1]]," + ",base_4_lt[[i1]])
          )
        ))[,p:=paste0(Var1,Var2)]$p
       
       a[[i_cFE]][[i_sFE]][[nsec]] <- paste0(county_FE,state_FE,vector)
    }
    i_sFE <- i_sFE + 1
  }
  i_cFE <- i_cFE + 1
}
```
*** **NOTE:** There is a problem when we introduce state_year or census_year fixed effects. These variables are meant to capture time varying shocks common to counties located in the same state or census division. For a reason that I don't understand yet we obtain a problem with the matrix (".. coefficients  not defined because the design matrix is rank deficient"). This happens either if I include all the combinations of dummies, if I exclude 1 or if i exclude 1 per year

*** **NOTE:** This vector was initially created to be used with a formua like "lm_robust". Since I chose the function "felm", I'm not using the county and state FE part.

#### 1.3.1.2 Running the Regressions and saving files
```{r}
for (workers in c("no_new_sec","all")) {
  for (method in c(1)) {
    for (dt in c(2,3)) {
      for (cov in c("base","base.extra","base.extra.other","base.extra.other.educ","base.extra.other.educ.ind1950","base.extra.other.ind1950")) {
        # 1. Change the name of the FE. We need to do this because year 1930 has just one new share variable while 1940 has many
        pop <- 10000
        setnames(fe_1930,
                 c(paste0(c("fe.","se.","weights."),paste0("method_sh_red_tit",".perwtge_",pop,".",cov,".",workers))),
                 c("fe","se","wt")
        )
        setnames(fe_1940,
                 c(paste0(c("fe.","se.","weights."),paste0("method",method,"_dt",dt,".perwtge_",pop,".",cov,".",workers))),
                 c("fe","se","wt")
        )
        
        # 2. Combine covariates with LHS variable
        Temp <- merge(
          Pooled_sample_1930_1940_countynhg_1910,
          rbind(fe_1930[,c("countynhg_1910","year","fe","se","wt")],fe_1940[,c("countynhg_1910","year","fe","se","wt")],fill=TRUE)
          ,by=c("countynhg_1910","year"),all.x=TRUE,all.y=FALSE)
        ## Only work with counties for which we have two observations
        Temp <- Temp[min_pop > 10000 & !is.na(fe) & !is.na(wt)][,count:=.N,by="countynhg_1910"][count==2][,count:=NULL]
        
        # 3. Creating vector that will contain all the coefficients  
        coef <- vector(mode="list"); coef_main_serv <- vector(mode="list"); j <- 1
        
        for (nsec in c(1,2,3,4)) {
          # 4. Formulas to be used (NOTE: I will only focus on one group of regressions)
          formula <- lapply(paste0("fe ~ new_sec_all_lt ", paste0(a[[1]][[1]][[nsec]])),as.formula)
          formula_main_serv <- lapply(paste0("fe ~ new_sec_main_lt + new_sec_serv_lt ", paste0(a[[1]][[1]][[nsec]])),as.formula)
         
          # 5. Regressions
          coef[[j]] <- f_regressions(arg_formula=formula,arg_data=Temp,arg_weights=wt,method="felm",arg_clusters=countynhg_1910)[,`:=`(Ind_FE="NO",Time_FE="NO")]
          coef[[j+4]] <- f_regressions(arg_formula=formula,arg_data=Temp,arg_weights=wt,method="felm",arg_clusters=countynhg_1910,arg_fe="countynhg_1910")[,`:=`(Ind_FE="YES",Time_FE="NO")]
          coef[[j+2*4]] <- f_regressions(arg_formula=formula,arg_data=Temp,arg_weights=wt,method="felm",arg_clusters=countynhg_1910,arg_fe="countynhg_1910 + year")[,`:=`(Ind_FE="YES",Time_FE="YES")]
          
          coef_main_serv[[j]] <- f_regressions(arg_formula=formula_main_serv,arg_data=Temp,arg_weights=wt,method="felm",arg_clusters=countynhg_1910)[,`:=`(Ind_FE="NO",Time_FE="NO")]
          coef_main_serv[[j+4]] <- f_regressions(arg_formula=formula_main_serv,arg_data=Temp,arg_weights=wt,method="felm",arg_clusters=countynhg_1910,arg_fe="countynhg_1910")[,`:=`(Ind_FE="YES",Time_FE="NO")]
          coef_main_serv[[j+2*4]] <- f_regressions(arg_formula=formula_main_serv,arg_data=Temp,arg_weights=wt,method="felm",arg_clusters=countynhg_1910,arg_fe="countynhg_1910 + year")[,`:=`(Ind_FE="YES",Time_FE="YES")]
          j <- j+1
        }
        
        # *************** TABLES WITH ALL THE REGRESSIONS ***************
        # 6. Simplifying the coef vectors
        ## List of unique variable names
        names_vector <- unique(
                  unlist(
                    lapply(append(coef,coef_main_serv),function(x) unique(x$rn))
                  )
                )
        ##Order
        Order <- list(
            c(grep("^new_sec_all",names_vector,value=TRUE)),
            c(grep("^new_sec_main",names_vector,value=TRUE)),
            c(grep("^new_sec_serv",names_vector,value=TRUE)),
            c(grep("^H_",names_vector,value=TRUE)),
            c(grep("perwt",names_vector,value=TRUE)),
            c(grep("^sh_lit",names_vector,value=TRUE)),
            c(grep("^Ind_FE",names_vector,value=TRUE)),
            c(grep("^Time_FE",names_vector,value=TRUE)),
            c("nobs"),c("r2"),c("adj.r2"),c("fstat_value"),c("fstat_proj_value"),
            c(grep("^sh_occ1950_main",names_vector,value=TRUE)),
            c(grep("^statefip_",names_vector,value=TRUE)),
            c(grep("^sh_ind1950_main",names_vector,value=TRUE)),
            c(grep("^sh_age_16_49",names_vector,value=TRUE)),
            c(grep("^sh_age_more5",names_vector,value=TRUE)),
            c(grep("^sh_male",names_vector,value=TRUE)),
            c(grep("^sh_race",names_vector,value=TRUE)),
            c(grep("^sh_labforce_",names_vector,value=TRUE)),
            c(grep("^sh_unemp_",names_vector,value=TRUE)),
            c(grep("^sh_urban_",names_vector,value=TRUE)),
            c(grep("^sh_wrkwage_",names_vector,value=TRUE)),
            c(grep("^sh_mig_us_",names_vector,value=TRUE)),
            c(grep("^sh_mig_ab_",names_vector,value=TRUE))
            )
        
        ## Simplified vectors
        coef <-lapply(coef,function(x) x[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector])
        coef <- lapply(coef,f_order_reg,Order=Order,order_var=rn)
        
        coef_main_serv <-lapply(coef_main_serv,function(x) x[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector])
        coef_main_serv <- lapply(coef_main_serv,f_order_reg,Order=Order,order_var=rn)
        
        # *************** TABLES WITH A SET OF THE REGRESSIONS AND COMBINING SHEETS ***************
        # Creating a Sheet with a set of important regressions - For coef and coef_main_serv
        i2<-1
        for (DT in list(coef[c(2,6,10)],coef[c(1,5,9)],coef[c(3,7,11)],coef[c(4,8,12)],coef_main_serv[c(2,6,10)],coef_main_serv[c(1,5,9)],coef_main_serv[c(3,7,11)],coef_main_serv[c(4,8,12)])) {
          DT <- lapply(DT,function(x) x[,c("rn","variable",paste0("model_",c(1,2,10,11,12,13,21)))])
          setnames(DT[[2]],c(paste0("model_",c(1,2,10,11,12,13,21))),c(paste0("model_",paste0(c(1,2,10,11,12,13,21),"_Ind"))))
          setnames(DT[[3]],c(paste0("model_",c(1,2,10,11,12,13,21))),c(paste0("model_",paste0(c(1,2,10,11,12,13,21),"_IndXTime"))))
          DT <- Reduce(
            function(x, y, ...) merge(x, y,by=c("rn","variable"), all = TRUE, ...),
            DT,
              )
          DT <- f_order_reg(DT,Order=Order,order_var=rn)
          # Column order
          cols <- c("rn","variable",paste0("model_",1,c("","_Ind","_IndXTime")))
          for (i3 in c(2,10,11,12,13,21)) {
            cols <- c(cols,paste0("model_",i3,c("","_Ind","_IndXTime")))
          }
          setcolorder(DT,cols)
          assign(paste0("DT_",i2),
                 DT
                 )
          rm(DT)
          i2<-i2+1
        }
        
        # 7. Exporting vectors
        sheet_name <- as.list(
                c(
                  "Summary_Reg_nsec2",
                  "Summary_Reg_nsec1",
                  "Summary_Reg_nsec3",
                  "Summary_Reg_nsec4",
                  paste0("No_Fe_nsec_",c(1,2,3,4)),
                  paste0("Ind_Fe_nsec_",c(1,2,3,4)),
                  paste0("IndXTime_Fe_nsec_",c(1,2,3,4)))
              )
        coef <- Reduce(
                      function(x, y) append(x, y),
                      list( list(DT_1),list(DT_2),list(DT_3),list(DT_4),
                            coef
                          )
                      )
        coef_main_serv <- Reduce(
                                function(x, y) append(x, y),
                                list( list(DT_5),list(DT_6),list(DT_7),list(DT_8),
                                      coef_main_serv
                                    )
                                )  
      
        wrapper_Excel(
          coef,
          sheet_name,
          paste0(main_directory,"R - Processing data/output/Tables/Panel/","fe_panel_reg_1930_1940_",workers,"_method",method,"_dt",dt
                   ,".",cov,".weighted.xlsx")
        )
        wrapper_Excel(
          coef_main_serv,
          sheet_name,
          paste0(main_directory,"R - Processing data/output/Tables/Panel/","fe_panel_reg_1930_1940_main_serv_",workers,"_method",method,"_dt",dt
                   ,".",cov,".weighted.xlsx")
        )
        
        # 8. Assigning and saving in fst mode
        assign(
            paste0("fe_panel_reg_1930_1940_",workers,"_method",method,"_dt",dt
                   ,".",cov,".weighted"),
            coef
          )
        assign(
            paste0("fe_panel_reg_1930_1940_main_serv_",workers,"_method",method,"_dt",dt
                   ,".",cov,".weighted"),
            coef_main_serv
          )
        
        saveRDS(coef,
                  paste0(main_directory,"R - Processing data/output/Rdata/","fe_panel_reg_1930_1940_",workers,"_method",method,"_dt",dt
                   ,".",cov,".weighted.RData")
                  )
        saveRDS(coef_main_serv,
                  paste0(main_directory,"R - Processing data/output/Rdata/","fe_panel_reg_1930_1940_main_serv_",workers,"_method",method,"_dt",dt
                   ,".",cov,".weighted.RData")
                  )
        
        rm(Temp,names_vector,sheet_name,Order,coef,coef_main_serv)
        rm(list=ls(pattern="^DT_"))
        
        # 9. Change the names in fe_1930,fe_1940
        setnames(
          fe_1930,
          c("fe","se","wt"),
          c(paste0(c("fe.","se.","weights."),paste0("method_sh_red_tit",".perwtge_",pop,".",cov,".",workers)))
        )
        setnames(
          fe_1940,
          c("fe","se","wt"),
          c(paste0(c("fe.","se.","weights."),paste0("method",method,"_dt",dt,".perwtge_",pop,".",cov,".",workers)))
        )  
      }
    }
  }
}
  

```

### 1.4. 1930 Regressions
1. sh_lit + log(perwt) + sh_new sectors (3 different cases)
2. sh_lit + log(perwt) + sh_new sectors (3 different cases) + sh_ind1950_main
3. sh_lit + log(perwt) + sh_new sectors (3 different cases) + sh_ind1950_main + sh_occ1950_main

Where base:   - (1) sh_age (three different groups), sh_male, sh_race, sh_urban, sh_mig_us, sh_mig_ab,   (maybe) sh_farm
              - (2) sh_labforce, sh_unenemp, sh_wrkwage
              - (3) sh_m_mig_us, sh_m_mig_ab, sh_f_mig_us, sh_f_mig_ab, sh_marst
Fixed effects:- statefip    
            
"Regional":   - (1) sh_lit, H, log(perwt)
              - (2) sh_occ1950_main, sh_ind1950_main

New Sector:   - new_sec_all, new_sec_main, new_sec_serv

New Work:     - sh_red_tit, sh_base_tit

It is not very clear what year should we use for the different variables. For the new sector variables the year should be 1920 and probably also for the regional variables. For the base variables I'm not entirely sure.
Regarding the variables excluding workers in new sectors, for sure we should do that for the New Work variables. We could also try to do that for the regional variables.

#### 1.4.1 Main Regressions
#### 1.4.1.1 Creating the different formulas for the regressions
We will use the same regressions list as in the panel data.

#### 1.4.1.2 Reducing the set of counties to work with the same counties as in the panel data
```{r}
census_sample_1930_countynhg_1910_homogeneous_panel <- 
  merge(
    census_sample_1930_countynhg_1910,
    Pooled_sample_1930_1940_countynhg_1910[,c("year","countynhg_1910","min_pop")][min_pop > 10000][,count:=.N,by="countynhg_1910"][count==2 & year=="1930"][,`:=`(count=NULL,year=NULL)],
    by="countynhg_1910",all=FALSE
    )

```

#### 1.4.1.3 Running the Regressions and saving files
```{r}
for (workers in c("no_new_sec","all")) {
  for (cov in c("base","base.extra","base.extra.other","base.extra.other.educ","base.extra.other.educ.ind1950","base.extra.other.ind1950")) {
    # 1. Change the name of the FE. We need to do this because year 1930 has just one new share variable while 1940 has many
    pop <- 10000
    setnames(fe_1930,
             c(paste0(c("fe.","se.","weights."),paste0("method_sh_red_tit",".perwtge_",pop,".",cov,".",workers))),
             c("fe","se","wt")
    )
    
    # 2. Combine covariates with LHS variable
    Temp <- merge(
      census_sample_1930_countynhg_1910_homogeneous_panel,
      fe_1930[,c("countynhg_1910","fe","se","wt")],
      by=c("countynhg_1910"),all.x=TRUE,all.y=FALSE)
    ## Only work with counties for which we have fe and wt
    Temp <- Temp[!is.na(fe) & !is.na(wt)]
    
    # 3. Creating vector that will contain all the coefficients  
    coef <- vector(mode="list"); coef_main_serv <- vector(mode="list"); j <- 1
    
    for (nsec in c(1,2,3,4)) {
      # 4. Formulas to be used (NOTE: I will only focus on one group of regressions)
      formula <- lapply(paste0("fe ~ new_sec_all_lt ", paste0(a[[1]][[1]][[nsec]])),as.formula)
      formula_main_serv <- lapply(paste0("fe ~ new_sec_main_lt + new_sec_serv_lt ", paste0(a[[1]][[1]][[nsec]])),as.formula)
      
      # 5. Regressions
      coef[[j]] <- f_regressions(arg_formula=formula,arg_data=Temp,arg_weights=wt,method="lm_robust")[,`:=`(State_FE="NO",cluster_state="NO")]
      coef[[j+4]] <- f_regressions(arg_formula=formula,arg_data=Temp,arg_weights=wt,method="felm",arg_fe="statefip_t")[,`:=`(State_FE="YES",cluster_state="NO")]
      coef[[j+2*4]] <- f_regressions(arg_formula=formula,arg_data=Temp,arg_weights=wt,method="felm",arg_fe="statefip_t",arg_clusters=statefip_t)[,`:=`(State_FE="YES",cluster_state="YES")]
      
      
      coef_main_serv[[j]] <- f_regressions(arg_formula=formula_main_serv,arg_data=Temp,arg_weights=wt,method="lm_robust")[,`:=`(State_FE="NO",cluster_state="NO")]
      coef_main_serv[[j+4]] <- f_regressions(arg_formula=formula_main_serv,arg_data=Temp,arg_weights=wt,method="felm",arg_fe="statefip_t")[,`:=`(State_FE="YES",cluster_state="NO")]
      coef_main_serv[[j+2*4]] <- f_regressions(arg_formula=formula_main_serv,arg_data=Temp,arg_weights=wt,method="felm",arg_fe="statefip_t",arg_clusters=statefip_t)[,`:=`(State_FE="YES",cluster_state="YES")]
      j <- j+1
    }
    
    # *************** TABLES WITH ALL THE REGRESSIONS ***************
    # 6. Simplifying the coef vectors
    ## List of unique variable names
    names_vector <- unique(
      unlist(
        lapply(append(coef,coef_main_serv),function(x) unique(x$rn))
      )
    )
    ##Order
    Order <- list(
      c(grep("^new_sec_all",names_vector,value=TRUE)),
      c(grep("^new_sec_main",names_vector,value=TRUE)),
      c(grep("^new_sec_serv",names_vector,value=TRUE)),
      c(grep("^H_",names_vector,value=TRUE)),
      c(grep("perwt",names_vector,value=TRUE)),
      c(grep("^sh_lit",names_vector,value=TRUE)),
      c(grep("^State_FE",names_vector,value=TRUE)),
      c(grep("^cluster_state",names_vector,value=TRUE)),
      c("nobs"),c("r2"),c("adj.r2"),c("fstat_value"),c("fstat_proj_value"),
      c(grep("^sh_occ1950_main",names_vector,value=TRUE)),
      c(grep("^statefip_",names_vector,value=TRUE)),
      c(grep("^sh_ind1950_main",names_vector,value=TRUE)),
      c(grep("^sh_age_16_49",names_vector,value=TRUE)),
      c(grep("^sh_age_more5",names_vector,value=TRUE)),
      c(grep("^sh_male",names_vector,value=TRUE)),
      c(grep("^sh_race",names_vector,value=TRUE)),
      c(grep("^sh_labforce_",names_vector,value=TRUE)),
      c(grep("^sh_unemp_",names_vector,value=TRUE)),
      c(grep("^sh_urban_",names_vector,value=TRUE)),
      c(grep("^sh_wrkwage_",names_vector,value=TRUE)),
      c(grep("^sh_mig_us_",names_vector,value=TRUE)),
      c(grep("^sh_mig_ab_",names_vector,value=TRUE))
    )
    
    ## Simplified vectors
    coef <-lapply(coef,function(x) x[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector])
    coef <- lapply(coef,f_order_reg,Order=Order,order_var=rn)
    
    coef_main_serv <-lapply(coef_main_serv,function(x) x[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector])
    coef_main_serv <- lapply(coef_main_serv,f_order_reg,Order=Order,order_var=rn)
    
    # *************** TABLES WITH A SET OF THE REGRESSIONS AND COMBINING SHEETS ***************
    # Creating a Sheet with a set of important regressions - For coef and coef_main_serv
    i2<-1
    for (DT in list(coef[c(2,6,10)],coef[c(1,5,9)],coef[c(3,7,11)],coef[c(4,8,12)],coef_main_serv[c(2,6,10)],coef_main_serv[c(1,5,9)],coef_main_serv[c(3,7,11)],coef_main_serv[c(4,8,12)])) {
      DT <- lapply(DT,function(x) x[,c("rn","variable",paste0("model_",c(1,2,10,11,12,13,21)))])
      setnames(DT[[2]],c(paste0("model_",c(1,2,10,11,12,13,21))),c(paste0("model_",paste0(c(1,2,10,11,12,13,21),"_StateFE"))))
      setnames(DT[[3]],c(paste0("model_",c(1,2,10,11,12,13,21))),c(paste0("model_",paste0(c(1,2,10,11,12,13,21),"_StateFE_clustered"))))
      DT <- Reduce(
        function(x, y, ...) merge(x, y,by=c("rn","variable"), all = TRUE, ...),
        DT,
      )
      DT <- f_order_reg(DT,Order=Order,order_var=rn)
      # Column order
      cols <- c("rn","variable",paste0("model_",1,c("","_StateFE","_StateFE_clustered")))
      for (i3 in c(2,10,11,12,13,21)) {
        cols <- c(cols,paste0("model_",i3,c("","_StateFE","_StateFE_clustered")))
      }
      setcolorder(DT,cols)
      assign(paste0("DT_",i2),
             DT
      )
      rm(DT)
      i2<-i2+1
    }
    
    # 7. Exporting vectors
    sheet_name <- as.list(
      c(
        "Summary_Reg_nsec2",
        "Summary_Reg_nsec1",
        "Summary_Reg_nsec3",
        "Summary_Reg_nsec4",
        paste0("No_Fe_nsec_",c(1,2,3,4)),
        paste0("StateFE_nsec_",c(1,2,3,4)),
        paste0("StateFE_clustered_",c(1,2,3,4)))
    )
    coef <- Reduce(
      function(x, y) append(x, y),
      list( list(DT_1),list(DT_2),list(DT_3),list(DT_4),
            coef
      )
    )
    coef_main_serv <- Reduce(
      function(x, y) append(x, y),
      list( list(DT_5),list(DT_6),list(DT_7),list(DT_8),
            coef_main_serv
      )
    )  
    
    wrapper_Excel(
      coef,
      sheet_name,
      paste0(main_directory,"R - Processing data/output/Tables/1930/","fe_reg_1930_",workers,".",cov,".weighted.xlsx")
    )
    wrapper_Excel(
      coef_main_serv,
      sheet_name,
      paste0(main_directory,"R - Processing data/output/Tables/1930/","fe_reg_1930_main_serv_",workers,".",cov,".weighted.xlsx")
    )
    
    # 8. Assigning and saving in fst mode
    assign(
      paste0("fe_reg_1930_",workers,".",cov,".weighted"),
      coef
    )
    assign(
      paste0("fe_reg_1930_main_serv_",workers,".",cov,".weighted"),
      coef_main_serv
    )
    
    saveRDS(coef,
            paste0(main_directory,"R - Processing data/output/Rdata/","fe_reg_1930_",workers,".",cov,".weighted.RData")
    )
    saveRDS(coef_main_serv,
            paste0(main_directory,"R - Processing data/output/Rdata/","fe_reg_1930_main_serv_",workers,".",cov,".weighted.RData")
    )
    
    rm(Temp,names_vector,sheet_name,Order,coef,coef_main_serv)
    rm(list=ls(pattern="^DT_"))
    
    # 9. Change the names in fe_1930,fe_1940
    setnames(
      fe_1930,
      c("fe","se","wt"),
      c(paste0(c("fe.","se.","weights."),paste0("method_sh_red_tit",".perwtge_",pop,".",cov,".",workers)))
    )
  }
}
  

```

### 1.5. 1940 Regressions
1. sh_lit + log(perwt) + sh_new sectors (3 different cases)
2. sh_lit + log(perwt) + sh_new sectors (3 different cases) + sh_ind1950_main
3. sh_lit + log(perwt) + sh_new sectors (3 different cases) + sh_ind1950_main + sh_occ1950_main

Where base:   - (1) sh_age (three different groups), sh_male, sh_race, sh_urban, sh_mig_us, sh_mig_ab,   (maybe) sh_farm
              - (2) sh_labforce, sh_unenemp, sh_wrkwage
              - (3) sh_m_mig_us, sh_m_mig_ab, sh_f_mig_us, sh_f_mig_ab, sh_marst
Fixed effects:- statefip    
            
"Regional":   - (1) sh_lit, H, log(perwt)
              - (2) sh_occ1950_main, sh_ind1950_main

New Sector:   - new_sec_all, new_sec_main, new_sec_serv

New Work:     - sh_red_tit, sh_base_tit

It is not very clear what year should we use for the different variables. For the new sector variables the year should be 1920 and probably also for the regional variables. For the base variables I'm not entirely sure.
Regarding the variables excluding workers in new sectors, for sure we should do that for the New Work variables. We could also try to do that for the regional variables.

#### 1.5.1 Main Regressions
#### 1.5.1.1 Creating the different formulas for the regressions
We will use the same regressions list as in the panel data.

#### 1.5.1.2 Reducing the set of counties to work with the same counties as in the panel data
```{r}
census_sample_1940_countynhg_1910_homogeneous_panel <- 
  merge(
    census_sample_1940_countynhg_1910,
    Pooled_sample_1930_1940_countynhg_1910[,c("year","countynhg_1910","min_pop")][min_pop > 10000][,count:=.N,by="countynhg_1910"][count==2 & year=="1940"][,`:=`(count=NULL,year=NULL)],
    by="countynhg_1910",all=FALSE
    )
```

#### 1.5.1.3 Running the Regressions and saving files
```{r}
for (workers in c("no_new_sec","all")) {
  for (method in c(1)) {
    for (dt in c(2,3)) {
      for (cov in c("base","base.extra","base.extra.other","base.extra.other.educ","base.extra.other.educ.ind1950","base.extra.other.ind1950")) {
        # 1. Change the name of the FE. We need to do this because year 1930 has just one new share variable while 1940 has many
        pop <- 10000
        setnames(fe_1940,
                 c(paste0(c("fe.","se.","weights."),paste0("method",method,"_dt",dt,".perwtge_",pop,".",cov,".",workers))),
                 c("fe","se","wt")
        )
        
        # 2. Combine covariates with LHS variable
        Temp <- merge(
          census_sample_1940_countynhg_1910_homogeneous_panel,
          fe_1940[,c("countynhg_1910","fe","se","wt")],
          by=c("countynhg_1910"),all.x=TRUE,all.y=FALSE)
        ## Only work with counties for which we have fe and wt
        Temp <- Temp[!is.na(fe) & !is.na(wt)]
        
        # 3. Creating vector that will contain all the coefficients  
        coef <- vector(mode="list"); coef_main_serv <- vector(mode="list"); j <- 1
        
        for (nsec in c(1,2,3,4)) {
          # 4. Formulas to be used (NOTE: I will only focus on one group of regressions)
          formula <- lapply(paste0("fe ~ new_sec_all_lt ", paste0(a[[1]][[1]][[nsec]])),as.formula)
          formula_main_serv <- lapply(paste0("fe ~ new_sec_main_lt + new_sec_serv_lt ", paste0(a[[1]][[1]][[nsec]])),as.formula)
         
          # 5. Regressions
          coef[[j]] <- f_regressions(arg_formula=formula,arg_data=Temp,arg_weights=wt,method="lm_robust")[,`:=`(State_FE="NO",cluster_state="NO")]
          coef[[j+4]] <- f_regressions(arg_formula=formula,arg_data=Temp,arg_weights=wt,method="felm",arg_fe="statefip_t")[,`:=`(State_FE="YES",cluster_state="NO")]
          coef[[j+2*4]] <- f_regressions(arg_formula=formula,arg_data=Temp,arg_weights=wt,method="felm",arg_fe="statefip_t",arg_clusters=statefip_t)[,`:=`(State_FE="YES",cluster_state="YES")]
          
          
          coef_main_serv[[j]] <- f_regressions(arg_formula=formula_main_serv,arg_data=Temp,arg_weights=wt,method="lm_robust")[,`:=`(State_FE="NO",cluster_state="NO")]
          coef_main_serv[[j+4]] <- f_regressions(arg_formula=formula_main_serv,arg_data=Temp,arg_weights=wt,method="felm",arg_fe="statefip_t")[,`:=`(State_FE="YES",cluster_state="NO")]
          coef_main_serv[[j+2*4]] <- f_regressions(arg_formula=formula_main_serv,arg_data=Temp,arg_weights=wt,method="felm",arg_fe="statefip_t",arg_clusters=statefip_t)[,`:=`(State_FE="YES",cluster_state="YES")]
          j <- j+1
        }
        
        # *************** TABLES WITH ALL THE REGRESSIONS ***************
        # 6. Simplifying the coef vectors
        ## List of unique variable names
        names_vector <- unique(
                  unlist(
                    lapply(append(coef,coef_main_serv),function(x) unique(x$rn))
                  )
                )
        ##Order
        Order <- list(
            c(grep("^new_sec_all",names_vector,value=TRUE)),
            c(grep("^new_sec_main",names_vector,value=TRUE)),
            c(grep("^new_sec_serv",names_vector,value=TRUE)),
            c(grep("^H_",names_vector,value=TRUE)),
            c(grep("perwt",names_vector,value=TRUE)),
            c(grep("^sh_lit",names_vector,value=TRUE)),
            c(grep("^State_FE",names_vector,value=TRUE)),
            c(grep("^cluster_state",names_vector,value=TRUE)),
            c("nobs"),c("r2"),c("adj.r2"),c("fstat_value"),c("fstat_proj_value"),
            c(grep("^sh_occ1950_main",names_vector,value=TRUE)),
            c(grep("^statefip_",names_vector,value=TRUE)),
            c(grep("^sh_ind1950_main",names_vector,value=TRUE)),
            c(grep("^sh_age_16_49",names_vector,value=TRUE)),
            c(grep("^sh_age_more5",names_vector,value=TRUE)),
            c(grep("^sh_male",names_vector,value=TRUE)),
            c(grep("^sh_race",names_vector,value=TRUE)),
            c(grep("^sh_labforce_",names_vector,value=TRUE)),
            c(grep("^sh_unemp_",names_vector,value=TRUE)),
            c(grep("^sh_urban_",names_vector,value=TRUE)),
            c(grep("^sh_wrkwage_",names_vector,value=TRUE)),
            c(grep("^sh_mig_us_",names_vector,value=TRUE)),
            c(grep("^sh_mig_ab_",names_vector,value=TRUE))
            )
        
        ## Simplified vectors
        coef <-lapply(coef,function(x) x[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector])
        coef <- lapply(coef,f_order_reg,Order=Order,order_var=rn)
        
        coef_main_serv <-lapply(coef_main_serv,function(x) x[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector])
        coef_main_serv <- lapply(coef_main_serv,f_order_reg,Order=Order,order_var=rn)
        
        # *************** TABLES WITH A SET OF THE REGRESSIONS AND COMBINING SHEETS ***************
        # Creating a Sheet with a set of important regressions - For coef and coef_main_serv
        i2<-1
        for (DT in list(coef[c(2,6,10)],coef[c(1,5,9)],coef[c(3,7,11)],coef[c(4,8,12)],coef_main_serv[c(2,6,10)],coef_main_serv[c(1,5,9)],coef_main_serv[c(3,7,11)],coef_main_serv[c(4,8,12)])) {
          DT <- lapply(DT,function(x) x[,c("rn","variable",paste0("model_",c(1,2,10,11,12,13,21)))])
          setnames(DT[[2]],c(paste0("model_",c(1,2,10,11,12,13,21))),c(paste0("model_",paste0(c(1,2,10,11,12,13,21),"_StateFE"))))
          setnames(DT[[3]],c(paste0("model_",c(1,2,10,11,12,13,21))),c(paste0("model_",paste0(c(1,2,10,11,12,13,21),"_StateFE_clustered"))))
          DT <- Reduce(
            function(x, y, ...) merge(x, y,by=c("rn","variable"), all = TRUE, ...),
            DT,
              )
          DT <- f_order_reg(DT,Order=Order,order_var=rn)
          # Column order
          cols <- c("rn","variable",paste0("model_",1,c("","_StateFE","_StateFE_clustered")))
          for (i3 in c(2,10,11,12,13,21)) {
            cols <- c(cols,paste0("model_",i3,c("","_StateFE","_StateFE_clustered")))
          }
          setcolorder(DT,cols)
          assign(paste0("DT_",i2),
                 DT
                 )
          rm(DT)
          i2<-i2+1
        }
        
        # 7. Exporting vectors
        sheet_name <- as.list(
                c(
                  "Summary_Reg_nsec2",
                  "Summary_Reg_nsec1",
                  "Summary_Reg_nsec3",
                  "Summary_Reg_nsec4",
                  paste0("No_FE_nsec_",c(1,2,3,4)),
                  paste0("StateFE_nsec_",c(1,2,3,4)),
                  paste0("StateFE_clustered_nsec_",c(1,2,3,4)))
              )
        coef <- Reduce(
                      function(x, y) append(x, y),
                      list( list(DT_1),list(DT_2),list(DT_3),list(DT_4),
                            coef
                          )
                      )
        coef_main_serv <- Reduce(
                                function(x, y) append(x, y),
                                list( list(DT_5),list(DT_6),list(DT_7),list(DT_8),
                                      coef_main_serv
                                    )
                                )  
      
        wrapper_Excel(
          coef,
          sheet_name,
          paste0(main_directory,"R - Processing data/output/Tables/1940/","fe_reg_1940_",workers,"_method",method,"_dt",dt
                   ,".",cov,".weighted.xlsx")
        )
        wrapper_Excel(
          coef_main_serv,
          sheet_name,
          paste0(main_directory,"R - Processing data/output/Tables/1940/","fe_reg_1940_main_serv_",workers,"_method",method,"_dt",dt
                   ,".",cov,".weighted.xlsx")
        )
        
        # 8. Assigning and saving in fst mode
        assign(
            paste0("fe_reg_1940_",workers,"_method",method,"_dt",dt
                   ,".",cov,".weighted"),
            coef
          )
        assign(
            paste0("fe_reg_1940_main_serv_",workers,"_method",method,"_dt",dt
                   ,".",cov,".weighted"),
            coef_main_serv
          )
        
        saveRDS(coef,
                  paste0(main_directory,"R - Processing data/output/Rdata/","fe_reg_1940_",workers,"_method",method,"_dt",dt
                   ,".",cov,".weighted.RData")
                  )
        saveRDS(coef_main_serv,
                  paste0(main_directory,"R - Processing data/output/Rdata/","fe_reg_1940_main_serv_",workers,"_method",method,"_dt",dt
                   ,".",cov,".weighted.RData")
                  )
        
        rm(Temp,names_vector,sheet_name,Order,coef,coef_main_serv)
        rm(list=ls(pattern="^DT_"))
        
        # 9. Change the names in fe_1940
        setnames(
          fe_1940,
          c("fe","se","wt"),
          c(paste0(c("fe.","se.","weights."),paste0("method",method,"_dt",dt,".perwtge_",pop,".",cov,".",workers)))
        )  
      }
    }
  }
}
  

```

```{r}
pop <- 10000
method <- 1
dt <- 3
cov <- "base"
workers <- "no_new_sec"
        setnames(fe_1940,
                 c(paste0(c("fe.","se.","weights."),paste0("method",method,"_dt",dt,".perwtge_",pop,".",cov,".",workers))),
                 c("fe","se","wt")
        )
        
        # 2. Combine covariates with LHS variable
        Temp <- merge(
          census_sample_1940_countynhg_1910_homogeneous_panel,
          fe_1940[,c("countynhg_1910","fe","se","wt")],
          by=c("countynhg_1910"),all.x=TRUE,all.y=FALSE)
        ## Only work with counties for which we have fe and wt
        Temp <- Temp[!is.na(fe) & !is.na(wt)]
        
        # 3. Creating vector that will contain all the coefficients  
        coef <- vector(mode="list"); coef_main_serv <- vector(mode="list"); j <- 1
        
          # 4. Formulas to be used (NOTE: I will only focus on one group of regressions)
          formula <- list(as.formula("fe ~ new_sec_all_lt + H_lt_no_new_sec_all + 
    log(perwt_lt_no_new_sec_all)"),
                          as.formula("fe ~ new_sec_all_lt + H_lt_no_new_sec_all + 
    log(perwt_lt_no_new_sec_all) + sh_age_16_49_lt_no_new_sec_all + sh_age_more50_lt_no_new_sec_all + 
    sh_male_lt_no_new_sec_all + sh_race_2_lt_no_new_sec_all + 
    sh_race_3_lt_no_new_sec_all + sh_urban_lt_no_new_sec_all + 
    sh_labforce_lt_no_new_sec_all + sh_wrkwage_lt_no_new_sec_all"),
                          as.formula("fe ~ new_sec_all_lt + H_lt_no_new_sec_all + 
    log(perwt_lt_no_new_sec_all) + sh_ind1950_main_2_lt_no_new_sec_all + 
    sh_ind1950_main_3_lt_no_new_sec_all + sh_ind1950_main_4_lt_no_new_sec_all + 
    sh_ind1950_main_5_lt_no_new_sec_all + sh_ind1950_main_6_lt_no_new_sec_all + 
    sh_ind1950_main_7_lt_no_new_sec_all + sh_occ1950_main_100_lt_no_new_sec_all + 
    sh_occ1950_main_200_lt_no_new_sec_all + sh_occ1950_main_300_lt_no_new_sec_all + 
    sh_occ1950_main_400_lt_no_new_sec_all + sh_occ1950_main_500_lt_no_new_sec_all + 
    sh_occ1950_main_600_lt_no_new_sec_all + sh_occ1950_main_700_lt_no_new_sec_all + 
    sh_occ1950_main_730_lt_no_new_sec_all + sh_occ1950_main_800_lt_no_new_sec_all + 
    sh_occ1950_main_900_lt_no_new_sec_all + sh_age_16_49_lt_no_new_sec_all + 
    sh_age_more50_lt_no_new_sec_all + sh_male_lt_no_new_sec_all + 
    sh_race_2_lt_no_new_sec_all + sh_race_3_lt_no_new_sec_all + 
    sh_urban_lt_no_new_sec_all + sh_labforce_lt_no_new_sec_all + 
    sh_wrkwage_lt_no_new_sec_all + sh_mig_us_lt_no_new_sec_all + 
    sh_mig_ab_lt_no_new_sec_all + sh_marst_2_lt + sh_marst_3_lt_no_new_sec_all"))
            
          formula_main_serv <- 
                    list(
                          as.formula("fe ~ new_sec_main_lt + new_sec_serv_lt + H_lt_no_new_sec_all + 
    log(perwt_lt_no_new_sec_all)"),
                          as.formula("fe ~ new_sec_main_lt +new_sec_serv_lt + H_lt_no_new_sec_all + 
    log(perwt_lt_no_new_sec_all) + sh_age_16_49_lt_no_new_sec_all + sh_age_more50_lt_no_new_sec_all + 
    sh_male_lt_no_new_sec_all + sh_race_2_lt_no_new_sec_all + 
    sh_race_3_lt_no_new_sec_all + sh_urban_lt_no_new_sec_all + 
    sh_labforce_lt_no_new_sec_all + sh_wrkwage_lt_no_new_sec_all"),
                          as.formula("fe ~ new_sec_main_lt + new_sec_serv_lt + H_lt_no_new_sec_all + 
    log(perwt_lt_no_new_sec_all) + sh_ind1950_main_2_lt_no_new_sec_all + 
    sh_ind1950_main_3_lt_no_new_sec_all + sh_ind1950_main_4_lt_no_new_sec_all + 
    sh_ind1950_main_5_lt_no_new_sec_all + sh_ind1950_main_6_lt_no_new_sec_all + 
    sh_ind1950_main_7_lt_no_new_sec_all + sh_occ1950_main_100_lt_no_new_sec_all + 
    sh_occ1950_main_200_lt_no_new_sec_all + sh_occ1950_main_300_lt_no_new_sec_all + 
    sh_occ1950_main_400_lt_no_new_sec_all + sh_occ1950_main_500_lt_no_new_sec_all + 
    sh_occ1950_main_600_lt_no_new_sec_all + sh_occ1950_main_700_lt_no_new_sec_all + 
    sh_occ1950_main_730_lt_no_new_sec_all + sh_occ1950_main_800_lt_no_new_sec_all + 
    sh_occ1950_main_900_lt_no_new_sec_all + sh_age_16_49_lt_no_new_sec_all + 
    sh_age_more50_lt_no_new_sec_all + sh_male_lt_no_new_sec_all + 
    sh_race_2_lt_no_new_sec_all + sh_race_3_lt_no_new_sec_all + 
    sh_urban_lt_no_new_sec_all + sh_labforce_lt_no_new_sec_all + 
    sh_wrkwage_lt_no_new_sec_all + sh_mig_us_lt_no_new_sec_all + 
    sh_mig_ab_lt_no_new_sec_all + sh_marst_2_lt + sh_marst_3_lt_no_new_sec_all"))
         
          # 5. Regressions
          coef[[1]] <- f_regressions(arg_formula=formula,arg_data=Temp,arg_weights=wt,method="lm_robust")[,`:=`(State_FE="NO",cluster_state="NO")]
          coef[[2]] <- f_regressions(arg_formula=formula,arg_data=Temp,arg_weights=wt,method="felm",arg_fe="statefip_t")[,`:=`(State_FE="YES",cluster_state="NO")]
          coef[[3]] <- f_regressions(arg_formula=formula,arg_data=Temp,arg_weights=wt,method="felm",arg_fe="statefip_t",arg_clusters=statefip_t)[,`:=`(State_FE="YES",cluster_state="YES")]
          
          coef_main_serv[[1]] <- f_regressions(arg_formula=formula_main_serv,arg_data=Temp,arg_weights=wt,method="lm_robust")[,`:=`(State_FE="NO",cluster_state="NO")]
          coef_main_serv[[2]] <- f_regressions(arg_formula=formula_main_serv,arg_data=Temp,arg_weights=wt,method="felm",arg_fe="statefip_t")[,`:=`(State_FE="YES",cluster_state="NO")]
          coef_main_serv[[3]] <- f_regressions(arg_formula=formula_main_serv,arg_data=Temp,arg_weights=wt,method="felm",arg_fe="statefip_t",arg_clusters=statefip_t)[,`:=`(State_FE="YES",cluster_state="YES")]
          
          names_vector <- unique(
                  unlist(
                    lapply(append(coef,coef_main_serv),function(x) unique(x$rn))
                  )
                )
        ##Order
        Order <- list(
            c(grep("^new_sec_all",names_vector,value=TRUE)),
            c(grep("^new_sec_main",names_vector,value=TRUE)),
            c(grep("^new_sec_serv",names_vector,value=TRUE)),
            c(grep("^H_",names_vector,value=TRUE)),
            c(grep("perwt",names_vector,value=TRUE)),
            c(grep("^sh_lit",names_vector,value=TRUE)),
            c(grep("^State_FE",names_vector,value=TRUE)),
            c(grep("^cluster_state",names_vector,value=TRUE)),
            c("nobs"),c("r2"),c("adj.r2"),c("fstat_value"),c("fstat_proj_value"),
            c(grep("^sh_occ1950_main",names_vector,value=TRUE)),
            c(grep("^statefip_",names_vector,value=TRUE)),
            c(grep("^sh_ind1950_main",names_vector,value=TRUE)),
            c(grep("^sh_age_16_49",names_vector,value=TRUE)),
            c(grep("^sh_age_more5",names_vector,value=TRUE)),
            c(grep("^sh_male",names_vector,value=TRUE)),
            c(grep("^sh_race",names_vector,value=TRUE)),
            c(grep("^sh_labforce_",names_vector,value=TRUE)),
            c(grep("^sh_unemp_",names_vector,value=TRUE)),
            c(grep("^sh_urban_",names_vector,value=TRUE)),
            c(grep("^sh_wrkwage_",names_vector,value=TRUE)),
            c(grep("^sh_mig_us_",names_vector,value=TRUE)),
            c(grep("^sh_mig_ab_",names_vector,value=TRUE))
            )
        
        ## Simplified vectors
        coef <-lapply(coef,function(x) x[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector])
        coef <- lapply(coef,f_order_reg,Order=Order,order_var=rn)
        
        coef_main_serv <-lapply(coef_main_serv,function(x) x[(variable=="coef_star" | variable =="std_par" | variable=="zother") & rn %in% names_vector])
        coef_main_serv <- lapply(coef_main_serv,f_order_reg,Order=Order,order_var=rn)
        
        i2<-1
        for (DT in list(coef,coef_main_serv)) {
          setnames(DT[[2]],c(paste0("model_",c(1,2,3))),c(paste0("model_",paste0(c(1,2,3),"_StateFE"))))
          setnames(DT[[3]],c(paste0("model_",c(1,2,3))),c(paste0("model_",paste0(c(1,2,3),"_StateFE_clustered"))))
          DT <- Reduce(
            function(x, y, ...) merge(x, y,by=c("rn","variable"), all = TRUE, ...),
            DT,
              )
          DT <- f_order_reg(DT,Order=Order,order_var=rn)
          # Column order
          cols <- c("rn","variable",paste0("model_",1,c("","_StateFE","_StateFE_clustered")))
          for (i3 in c(2,3)) {
            cols <- c(cols,paste0("model_",i3,c("","_StateFE","_StateFE_clustered")))
          }
          setcolorder(DT,cols)
          assign(paste0("DT_",i2),
                 DT
                 )
          rm(DT)
          i2<-i2+1
        }
        
        coef <- Reduce(
                      function(x, y) append(x, y),
                      list( list(DT_1),
                            coef
                          )
                      )
        coef_main_serv <- Reduce(
                                function(x, y) append(x, y),
                                list( list(DT_2),
                                      coef_main_serv
                                    )
                                )  
      
          
    setnames(
          fe_1940,
          c("fe","se","wt"),
          c(paste0(c("fe.","se.","weights."),paste0("method",method,"_dt",dt,".perwtge_",pop,".",cov,".",workers)))
        )

        
```


# Part 11. Correlations between different regional variables
## Loading packages and erasing the workspace (make sure to have loaded f_load_pk)
```{r}
rm(list = setdiff(ls(),c(lsf.str(),"main_directory") ))
f_load_pk()
```

## 1. Correlations at the countynhg_1910 level
### 1.1. Construct regional level database
```{r}
# 1930
correlations_data_1880_to_1930_countynhg_1910 <-read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1930_agg_countynhg_1910.fst"),as.data.table=TRUE)
correlations_data_1880_to_1930_countynhg_1910 <- correlations_data_1880_to_1930_countynhg_1910[,`:=`(new_sec_all=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466 +sh_new_sector_ind1950_556+sh_new_sector_ind1950_606+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816 + sh_new_sector_ind1950_856,
                              new_sec_main=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466+ sh_new_sector_ind1950_856,
                              new_sec_serv=sh_new_sector_ind1950_556+sh_new_sector_ind1950_606+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816)]
cols <- names(correlations_data_1880_to_1930_countynhg_1910[,!c("countynhg_1910")])
setnames(correlations_data_1880_to_1930_countynhg_1910,cols,paste0(cols,"_1930"))

# 1920
temp <- read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1920_agg_countynhg_1910.fst"),as.data.table=TRUE)
temp <- temp[,`:=`(new_sec_all=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466 +sh_new_sector_ind1950_556+sh_new_sector_ind1950_606+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816,
                              new_sec_main=sh_new_sector_ind1950_376+sh_new_sector_ind1950_377+sh_new_sector_ind1950_466,
                              new_sec_serv=sh_new_sector_ind1950_556+sh_new_sector_ind1950_606+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816)]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_1920"))

correlations_data_1880_to_1930_countynhg_1910 <- merge(correlations_data_1880_to_1930_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)

#1910
temp <- read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1910_agg_countynhg_1910.fst"),as.data.table=TRUE)
temp <- temp[,`:=`(new_sec_all=sh_new_sector_ind1950_376+sh_new_sector_ind1950_466 +sh_new_sector_ind1950_556+sh_new_sector_ind1950_606+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816,
                              new_sec_main=sh_new_sector_ind1950_376+sh_new_sector_ind1950_466,
                              new_sec_serv=sh_new_sector_ind1950_556+sh_new_sector_ind1950_606+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668+sh_new_sector_ind1950_816)]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_1910"))

correlations_data_1880_to_1930_countynhg_1910 <- merge(correlations_data_1880_to_1930_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)

#1900
temp <- read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1900_agg_countynhg_1910.fst"),as.data.table=TRUE)
temp <- temp[,`:=`(new_sec_all=sh_new_sector_ind1950_376+sh_new_sector_ind1950_466 +sh_new_sector_ind1950_556+sh_new_sector_ind1950_606+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668,
                              new_sec_main=sh_new_sector_ind1950_376+sh_new_sector_ind1950_466,
                              new_sec_serv=sh_new_sector_ind1950_556+sh_new_sector_ind1950_606+sh_new_sector_ind1950_667+sh_new_sector_ind1950_668)]
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_1900"))

correlations_data_1880_to_1930_countynhg_1910 <- merge(correlations_data_1880_to_1930_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)

#1880
temp <- read_fst(paste0(main_directory,"R - Processing data/output/Rdata/census_sample_1880_agg_countynhg_1910.fst"),as.data.table=TRUE)
cols <- names(temp[,!c("countynhg_1910")])
setnames(temp,cols,paste0(cols,"_1880"))

correlations_data_1880_to_1930_countynhg_1910 <- merge(correlations_data_1880_to_1930_countynhg_1910,temp,by="countynhg_1910",all=FALSE)
rm(temp)

```


### 1.2. Share of new sectors
- Between 1920 and 1930, 1910 and 1920, 1910 and 1930
- All new sectors, Main new sectors, service sectors, each individual sector
- Simple regressions

output:
- Correlation graphs (gather in one graph the three first: All new sectors, Main new sectors, service sectors. Don't plug correlations where in both years the share is 0)
- Regressions
#### 1.2.1. Correlations 
```{r}
# 1920 - 1930
x <- paste0(c("new_sec_all","new_sec_main","new_sec_serv"),"_1920")
y <- paste0(c("new_sec_all","new_sec_main","new_sec_serv"),"_1930")
lab_x <- paste0(c("Share of New Sector - All","Share of New Sector - Main","Share of New Sector - Service")," (1920)")
lab_y <- paste0(c("Share of New Sector - All","Share of New Sector - Main","Share of New Sector - Service")," (1930)")

p <- vector(mode = "list", length = length(x))
for (i in 1:length(p)) {
  p[[i]] <- ggplot(correlations_data_1880_to_1930_countynhg_1910, aes_string(y= y[i], x= x[i])) + geom_point(size=0.2) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="",x= lab_x[i], y = lab_y[i]) + geom_abline(intercept = 0, slope = 1,color="red") + theme_tufte() + theme(axis.line=element_line(color="black"), legend.position = "top")
}

ggarrange(p[[1]],p[[2]],p[[3]],labels=c("All New Sectors","Main New Sectors","Service New Sectors"),
          ncol=2,nrow=2)
ggsave(paste0(main_directory,"R - Processing data/output/Graphs/countynhg_1910/corr_sh_new_sectors_1920_x_1930.jpeg"),plot=last_plot())

# 1910 - 1920
x <- paste0(c("new_sec_all","new_sec_main","new_sec_serv"),"_1910")
y <- paste0(c("new_sec_all","new_sec_main","new_sec_serv"),"_1920")
lab_x <- paste0(c("Share of New Sector - All","Share of New Sector - Main","Share of New Sector - Service")," (1910)")
lab_y <- paste0(c("Share of New Sector - All","Share of New Sector - Main","Share of New Sector - Service")," (1920)")

p <- vector(mode = "list", length = length(x))
for (i in 1:length(p)) {
  p[[i]] <- ggplot(correlations_data_1880_to_1930_countynhg_1910, aes_string(y= y[i], x= x[i])) + geom_point(size=0.2) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="",x= lab_x[i], y = lab_y[i]) + geom_abline(intercept = 0, slope = 1,color="red") + theme_tufte() + theme(axis.line=element_line(color="black"), legend.position = "top")
}

ggarrange(p[[1]],p[[2]],p[[3]],labels=c("All New Sectors","Main New Sectors","Service New Sectors"),
          ncol=2,nrow=2)
ggsave(paste0(main_directory,"R - Processing data/output/Graphs/countynhg_1910/corr_sh_new_sectors_1910_x_1920.jpeg"),plot=last_plot())

# 1910 - 1930
x <- paste0(c("new_sec_all","new_sec_main","new_sec_serv"),"_1910")
y <- paste0(c("new_sec_all","new_sec_main","new_sec_serv"),"_1930")
lab_x <- paste0(c("Share of New Sector - All","Share of New Sector - Main","Share of New Sector - Service")," (1910)")
lab_y <- paste0(c("Share of New Sector - All","Share of New Sector - Main","Share of New Sector - Service")," (1930)")

p <- vector(mode = "list", length = length(x))
for (i in 1:length(p)) {
  p[[i]] <- ggplot(correlations_data_1880_to_1930_countynhg_1910, aes_string(y= y[i], x= x[i])) + geom_point(size=0.2) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="",x= lab_x[i], y = lab_y[i]) + geom_abline(intercept = 0, slope = 1,color="red") + theme_tufte() + theme(axis.line=element_line(color="black"), legend.position = "top")
}

ggarrange(p[[1]],p[[2]],p[[3]],labels=c("All New Sectors","Main New Sectors","Service New Sectors"),
          ncol=2,nrow=2)
ggsave(paste0(main_directory,"R - Processing data/output/Graphs/countynhg_1910/corr_sh_new_sectors_1910_x_1930.jpeg"),plot=last_plot())

```
#### 1.2.2 Regressions
```{r}
a <- vector(mode = "list")

a[[1]] <- as.formula("new_sec_all_1930 ~ new_sec_all_1920")
a[[2]] <- as.formula("new_sec_main_1930 ~ new_sec_main_1920")
a[[3]] <- as.formula("new_sec_serv_1930 ~ new_sec_serv_1920")
a[[4]] <- as.formula("new_sec_all_1920 ~ new_sec_all_1910")
a[[5]] <- as.formula("new_sec_main_1920 ~ new_sec_main_1910")
a[[6]] <- as.formula("new_sec_serv_1920 ~ new_sec_serv_1910")
a[[7]] <- as.formula("new_sec_all_1930 ~ new_sec_all_1910")
a[[8]] <- as.formula("new_sec_main_1930 ~ new_sec_main_1910")
a[[9]] <- as.formula("new_sec_serv_1930 ~ new_sec_serv_1910")
j<-10
for (i in c(376,377,466,556,606,667,668,816)) {
  a[[j]] <- as.formula(paste0("sh_new_sector_ind1950_",i,"_1930 ~ sh_new_sector_ind1950_",i,"_1920"))
  j <- j + 1
  if (i != 377) {
    a[[j]] <- as.formula(paste0("sh_new_sector_ind1950_",i,"_1930 ~ sh_new_sector_ind1950_",i,"_1910"))
    a[[j+1]] <- as.formula(paste0("sh_new_sector_ind1950_",i,"_1920 ~ sh_new_sector_ind1950_",i,"_1910"))
    j <- j+2
  }
}

for (i in 1:length(a)) {
  T <- summary(lm(a[[i]],data=correlations_data_1880_to_1930_countynhg_1910))
  print(a[[i]])
  print(T)
}

coef.all <- f_regressions(arg_formula=a[c(1:3,10,13,14,17,20,23,26,29)],arg_data=correlations_data_1880_to_1930_countynhg_1910,method="lm")[(variable=="coef_star" | variable =="std_par" | variable=="zother")]


```

### 1.3. Share of main industries
#### 1.3.1. Correlations 
```{r}
for (var_y in c(1930,1920,1910)) {
  for (var_x in c(1880,1900,1910,1920)) {
    if (var_x < var_y) {
      x <- paste0("sh_ind1950_main_",c(1:7),"_",var_x)
      y <- paste0("sh_ind1950_main_",c(1:7),"_",var_y)
      lab_x <- paste0("Share of Main Industry ",c(1:7)," (",var_x,")")
      lab_y <- paste0("Share of Main Industry ",c(1:7)," (",var_y,")")
      
      p <- vector(mode = "list", length = length(x))
      for (i in 1:length(p)) {
        p[[i]] <- ggplot(correlations_data_1880_to_1930_countynhg_1910, aes_string(y= y[i], x= x[i])) + geom_point(size=0.2) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="",x= lab_x[i], y = lab_y[i]) + geom_abline(intercept = 0, slope = 1,color="red") + theme_tufte() + theme(axis.line=element_line(color="black"), legend.position = "top")
      }
      
      ggarrange(p[[1]],p[[2]],p[[3]],p[[4]],labels=c("Agriculture","Mining and Construction","Manufacturing","Trans., Comm., other Util."),
                ncol=2,nrow=2)
      ggsave(paste0(main_directory,"R - Processing data/output/Graphs/countynhg_1910/corr_sh_main_ind1950_",var_x,"_x_",var_y,"_1.jpeg"),plot=last_plot())
      ggarrange(p[[5]],p[[6]],p[[7]],labels=c("Trade","Services","Public Administration"),
                ncol=2,nrow=2)
      ggsave(paste0(main_directory,"R - Processing data/output/Graphs/countynhg_1910/corr_sh_main_ind1950_",var_x,"_x_",var_y,"_2.jpeg"),plot=last_plot())
    }
  }
}
```

### 1.3. Share of main occupations
#### 1.3.1. Correlations 
```{r}
for (var_y in c(1930,1920,1910)) {
  for (var_x in c(1880,1900,1910,1920)) {
    if (var_x < var_y) {
      x <- paste0("sh_occ1950_main_",c(0,100,200,300,400,500,600,700,730,800,900),"_",var_x)
      y <- paste0("sh_occ1950_main_",c(0,100,200,300,400,500,600,700,730,800,900),"_",var_y)
      lab_x <- paste0("Share of Main Occupation ",c(0,100,200,300,400,500,600,700,730,800,900)," (",var_x,")")
      lab_y <- paste0("Share of Main Occupation ",c(0,100,200,300,400,500,600,700,730,800,900)," (",var_y,")")
      
      p <- vector(mode = "list", length = length(x))
      for (i in 1:length(p)) {
        p[[i]] <- ggplot(correlations_data_1880_to_1930_countynhg_1910, aes_string(y= y[i], x= x[i])) + geom_point(size=0.2) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + labs(title="",x= lab_x[i], y = lab_y[i]) + geom_abline(intercept = 0, slope = 1,color="red") + theme_tufte() + theme(axis.line=element_line(color="black"), legend.position = "top")
      }
      
      ggarrange(p[[1]],p[[2]],p[[3]],p[[4]],labels=c("Professional, Technical","Farmers","Managers, Officials, and Proprietors","Clerical and Kindred"),ncol=2,nrow=2)
      ggsave(paste0(main_directory,"R - Processing data/output/Graphs/countynhg_1910/corr_sh_main_occ1950_",var_x,"_x_",var_y,"_1.jpeg"),plot=last_plot())
      ggarrange(p[[5]],p[[6]],p[[7]],p[[8]],labels=c("Sales workers","Craftsmen","Operatives","Service Workers (private household)"),
                ncol=2,nrow=2)
      ggsave(paste0(main_directory,"R - Processing data/output/Graphs/countynhg_1910/corr_sh_main_occ1950_",var_x,"_x_",var_y,"_2.jpeg"),plot=last_plot())
      ggarrange(p[[9]],p[[10]],p[[11]],labels=c("Service Workers (not household)","Farm laborers","Laborers"),
                ncol=2,nrow=2)
      ggsave(paste0(main_directory,"R - Processing data/output/Graphs/countynhg_1910/corr_sh_main_occ1950_",var_x,"_x_",var_y,"_3.jpeg"),plot=last_plot())
    }
  }
}
```

# Part 12. Analysing the relationship between industries and new work
## Loading packages and erasing the workspace (make sure to have loaded f_load_pk)
```{r}
rm(list = setdiff(ls(),c(lsf.str(),"main_directory") ))
f_load_pk()
p_load(kableExtra)
```

Problem: In the individual level regressions of share of new work, the main industry variables have a very high explanatory power in 1930, but not in 1940. In addition, we have that the regression model for 1930 explains between 10 and 16% (using the R2) of the variability of the independent variable, while for 1940 this value fluctuates between 2 and 4.5%. This is not necessarily a problem, but it is important to understand what is happening.

Plan:
- Descriptive exercise:
  - For each year compute the share of new work by 3 digit industry and then by main industry
    - Simple bar graph for 3 digit and one digit sector
  
  - Look at the variability of the share of new work variable for both years. Is the variability very low in 1940?
    - Number of different occupations, compute standard deviation, min and max values
    - Variability across space and industries
    
  - General information about new work
    - Number of possible people in new work.
    - Male workers vs female workers in new work.
    - Age profile of workers in new work.
    - Education variables
    
- Analyzing results from First Stage Regressions
  - Summary of main results (r2, fstat, industry variables and their significance)
  - Corerlation of city fixed effects in different exercises
  - F-stat for city fixed effects.

## 1. Descriptive exercise
- Information aggregated at the industry-occupation level

### 1.0. Creating main database
```{r}
# Industry names
ind1950.codes <- as.data.table(read_excel(here(paste0("input/1930 - Cleaned.xlsx")), sheet = "ind1950",guess_max=10000) )

# Occupation names
occ1930.codes <- as.data.table( read_excel(here(paste0("input/1930 - Cleaned.xlsx")), sheet = "1930 main groups",guess_max=10000) )[,c("occind","occind1930","occind1930_name")]
occ1940.codes <- as.data.table( read_excel(here(paste0("input/1940 - Cleaned.xlsx")), sheet = "occ1940",guess_max=10000) )[,`:=`(occ1940_IPUMS=as.numeric(occ1940_IPUMS),occ1940=tolower(occ1940))][,c("occ1940","name_occ1940")][,.SD[1],by="occ1940"]

# Import main databases ----
census_sample_1930_main <- 
  read_fst(here(paste0("output/Rdata/census_sample_1930_individual_data_x_countynhg_1910.fst")),as.data.table=TRUE)[occ1950_main!=979 & ind1950_main!=0][,c("countynhg_1910","perwt_ID","perwt_1930","sh_red_tit","occind","statefip","urban","male","lit","race","wwages","mig_us","mig_ab","age_main","ind1950","ind1950_main")][!is.na(lit)][order(countynhg_1910,occind)]

census_sample_1940_main <-
  read_fst(here(paste0("output/Rdata/census_sample_1940_individual_data_x_countynhg_1910.fst")),as.data.table=TRUE)[occ1950_main!=979 & ind1950_main!=0][,c("countynhg_1910","perwt_1940","perwt_ID","sh_new_all_dataset1","sh_new_all_dataset2","sh_new_all_dataset3","sh_new_method1_dataset1","sh_new_method1_dataset2","sh_new_method1_dataset3","sh_new_method2_dataset1","sh_new_method2_dataset2","sh_new_method2_dataset3","occ1940","statefip","urban","male","educ_main","race","wwages","mig_us","mig_ab","age_main","occ1940","ind1950","ind1950_main")]

# Simplify ----
census_sample_1930_main <-
  census_sample_1930_main[,.(perwt=sum(perwt_ID),sh_red_tit=mean(sh_red_tit)),by=c("occind","countynhg_1910","lit","statefip","urban","male","race","wwages","mig_us","mig_ab","age_main","ind1950","ind1950_main")]

census_sample_1940_main <-
  census_sample_1940_main[,.(perwt=sum(perwt_ID),sh_new_method1_dataset1=weighted.mean(sh_new_method1_dataset1,w=perwt_ID),sh_new_method1_dataset2=weighted.mean(sh_new_method1_dataset2,w=perwt_ID),sh_new_method1_dataset3=weighted.mean(sh_new_method1_dataset3,w=perwt_ID),sh_new_method2_dataset1=weighted.mean(sh_new_method2_dataset1,w=perwt_ID),sh_new_method2_dataset2=weighted.mean(sh_new_method2_dataset2,w=perwt_ID),sh_new_method2_dataset3=weighted.mean(sh_new_method2_dataset3,w=perwt_ID)),by=c("occ1940","countynhg_1910","educ_main","statefip","urban","male","race","wwages","mig_us","mig_ab","age_main","ind1950","ind1950_main")]

```

## 1.1 Share of new work by industry
### 1.1.1. 1930
```{r}
census_sample_1930_industry_study <- 
  merge(
    census_sample_1930_main[,.(perwt=sum(perwt),sh_red_tit=weighted.mean(sh_red_tit,w=perwt)),by=c("ind1950","ind1950_main")][,n_new_work:=perwt*sh_red_tit],
    ind1950.codes[,c("ind1950","ind1950_name")],
    by="ind1950",all.x=TRUE,all.y=FALSE
  )

# ind1950 ----
## Mean and Standard Deviation
cat(gsub(pattern = "\n", replacement = "  \n", 
         x = paste0(
           "Grouping by ind1950\n\n",
           "The mean of the New work variable was: ",
           format(round(mean(census_sample_1930_industry_study$sh_red_tit),4),nsmall=2),
           "\nand the standard deviation: ",
           format(round(sd(census_sample_1930_industry_study$sh_red_tit),4),nsmall=2),
           "\n\n"
         )
))

## Some graphs
ggplot(census_sample_1930_industry_study, aes(x=sh_red_tit)) +
        geom_histogram(color="black",bins=40,fill="white") +
        labs(title="Industry Histogram for the Share of New Work",x="Share of New Work", y = "Number of industries")  + 
        theme_tufte() + theme(legend.position = "none")

ggplot(census_sample_1930_industry_study, aes(x=n_new_work)) +
        geom_histogram(color="black",bins=40,fill="white") +
        labs(title="",x="Industry Histogram for the Number of New Workers", y = "Number of industries")  + 
        theme_tufte() + theme(legend.position = "none")

ggplot(census_sample_1930_industry_study[n_new_work<=300000], aes(x=n_new_work)) +
        geom_histogram(color="black",bins=40,fill="white") +
        labs(title="",x="Industry Histogram for the Share of New Work (sectors with less than 300.000 workers)", y = "Number of industries")  + 
        theme_tufte() + theme(legend.position = "none")

## Table
knitr::kable(census_sample_1930_industry_study[order(-sh_red_tit,-perwt),c("ind1950_name","sh_red_tit","perwt","n_new_work")][1:15])
knitr::kable(census_sample_1930_industry_study[order(-sh_red_tit,-perwt),c("ind1950_name","sh_red_tit","perwt","n_new_work")][16:30])

# ind1950_main ----
census_sample_1930_industry_study_all <- 
  merge(
    census_sample_1930_industry_study[,.(perwt=sum(perwt),sh_red_tit=weighted.mean(sh_red_tit,w=perwt)),by=c("ind1950_main")][,n_new_work:=perwt*sh_red_tit],
    data.table(ind1950_main=c(1:7),ind1950_main_name=c("Agriculture","Mining and Construction","Manufacturing","Transportation, Communication, and Other Utilities","Trade","Services","Public Administration")),
    by="ind1950_main",all.x=TRUE,all.y=FALSE
  )
census_sample_1930_industry_study_no_new_sec <- 
  merge(
    census_sample_1930_industry_study[!(ind1950 %in% c(376,377,466,556,606,667,668,816,856))  ,.(perwt=sum(perwt),sh_red_tit=weighted.mean(sh_red_tit,w=perwt)),by=c("ind1950_main")][,n_new_work:=perwt*sh_red_tit],
    data.table(ind1950_main=c(1:7),ind1950_main_name=c("Agriculture","Mining and Construction","Manufacturing","Transportation, Communication, and Other Utilities","Trade","Services","Public Administration")),
    by="ind1950_main",all.x=TRUE,all.y=FALSE
  )

## Mean and Standard Deviation
cat(gsub(pattern = "\n", replacement = "  \n", 
         x = paste0(
           "Grouping by ind1950_main\n",
           "The mean of the New work variable (including all workers) was: ",
           format(round(mean(census_sample_1930_industry_study_all$sh_red_tit),4),nsmall=2),
           "\nand the standard deviation: ",
           format(round(sd(census_sample_1930_industry_study_all$sh_red_tit),4),nsmall=2),
           "\n\n"
         )
))
cat(gsub(pattern = "\n", replacement = "  \n", 
         x = paste0(
           "Grouping by ind1950_main\n\n",
           "The mean of the New work variable (excluding new sectors workers) was: ",
           format(round(mean(census_sample_1930_industry_study_no_new_sec$sh_red_tit),4),nsmall=2),
           "\nand the standard deviation: ",
           format(round(sd(census_sample_1930_industry_study_no_new_sec$sh_red_tit),4),nsmall=2)
         )
))

## Some graphs
# ggplot(census_sample_1930_industry_study, aes(x=sh_red_tit)) +
#         geom_histogram(color="black",fill="white") +
#         labs(title="",x="Share of New Work", y = "Number of industries")  + 
#         theme_tufte() + theme(legend.position = "none")
# 
# ggplot(census_sample_1930_industry_study, aes(x=sh_red_tit)) +
#         geom_histogram(color="black",fill="white") +
#         labs(title="",x="Share of New Work", y = "Number of industries")  + 
#         theme_tufte() + theme(legend.position = "none")


## Table
knitr::kable(census_sample_1930_industry_study_all[order(-sh_red_tit,-perwt),c("ind1950_main_name","sh_red_tit","perwt","n_new_work")],caption="All workers")
knitr::kable(census_sample_1930_industry_study_no_new_sec[order(-sh_red_tit,-perwt),c("ind1950_main_name","sh_red_tit","perwt","n_new_work")],caption="Excluding New sectors")

```

### 1.1.1. 1940
```{r 1940}
census_sample_1940_industry_study <- 
  merge(
    census_sample_1940_main[,.(perwt=sum(perwt),sh_new_method1_dataset1=weighted.mean(sh_new_method1_dataset1,w=perwt),sh_new_method1_dataset2=weighted.mean(sh_new_method1_dataset2,w=perwt),sh_new_method1_dataset3=weighted.mean(sh_new_method1_dataset3,w=perwt),sh_new_method2_dataset1=weighted.mean(sh_new_method2_dataset1,w=perwt),sh_new_method2_dataset2=weighted.mean(sh_new_method2_dataset2,w=perwt),sh_new_method2_dataset3=weighted.mean(sh_new_method2_dataset3,w=perwt)),by=c("ind1950","ind1950_main")],
    ind1950.codes[,c("ind1950","ind1950_name")],
    by="ind1950",all.x=TRUE,all.y=FALSE
  )



for (method in c(1)) {
  for (dt in c(2,3)) {
    setnames(census_sample_1940_industry_study,c(paste0("sh_new_method",method,"_dataset",dt)),c("new_work"))
    
    # ind1950 ----
    ## Mean and Standard Deviation
    cat(gsub(pattern = "\n", replacement = "  \n", 
             x = paste0(
               "Grouping by ind1950 - Method ",method,", Dataset ",dt,"\n\n",
               "The mean for New work variable was: ",
               format(round(mean(census_sample_1940_industry_study$new_work),4),nsmall=2),
               "\nand the standard deviation: ",
               format(round(sd(census_sample_1940_industry_study$new_work),4),nsmall=2),
               "\n\n"
             )
    ))
    
    census_sample_1940_industry_study <- census_sample_1940_industry_study[,n_new_work:=perwt*new_work]
    
    ## Some graphs
    print(ggplot(census_sample_1940_industry_study, aes(x=new_work)) +
            geom_histogram(color="black",bins=40,fill="white") +
            labs(title=paste0("Industry Histogram for the Share of New Work ","(Method ",method,", Dataset ",dt,")"),x="Share of New Work", y = "Number of industries")  + 
            theme_tufte() + theme(legend.position = "none"))
    
    print(ggplot(census_sample_1940_industry_study, aes(x=n_new_work)) +
            geom_histogram(color="black",bins=40,fill="white") +
            labs(title="",x=paste0("Industry Histogram for the Number of New Workers ","(Method ",method,", Dataset ",dt,")"), y = "Number of industries")  + 
            theme_tufte() + theme(legend.position = "none"))
    
    print(ggplot(census_sample_1940_industry_study[n_new_work<=300000], aes(x=n_new_work)) +
            geom_histogram(color="black",bins=40,fill="white") +
            labs(title="",x=paste0("Industry Histogram for the Number of New Workers - Less than 300.000 ","(Method ",method,", Dataset ",dt,")"), y = "Number of industries")  + 
            theme_tufte() + theme(legend.position = "none"))
    
    ## Table
    print(knitr::kable(census_sample_1940_industry_study[order(-new_work,-perwt),c("ind1950_name","new_work","perwt","n_new_work")][1:15]))
    print(knitr::kable(census_sample_1940_industry_study[order(-new_work,-perwt),c("ind1950_name","new_work","perwt","n_new_work")][16:30]))

    # ind1950_main ----
    census_sample_1940_industry_study_all <- 
      merge(
        census_sample_1940_industry_study[,.(perwt=sum(perwt),new_work=weighted.mean(new_work,w=perwt)),by=c("ind1950_main")][,n_new_work:=perwt*new_work],
        data.table(ind1950_main=c(1:7),ind1950_main_name=c("Agriculture","Mining and Construction","Manufacturing","Transportation, Communication, and Other Utilities","Trade","Services","Public Administration")),
        by="ind1950_main",all.x=TRUE,all.y=FALSE
      )
    census_sample_1940_industry_study_no_new_sec <- 
      merge(
        census_sample_1940_industry_study[!(ind1950 %in% c(376,377,466,556,606,667,668,816,856))  ,.(perwt=sum(perwt),new_work=weighted.mean(new_work,w=perwt)),by=c("ind1950_main")][,n_new_work:=perwt*new_work],
        data.table(ind1950_main=c(1:7),ind1950_main_name=c("Agriculture","Mining and Construction","Manufacturing","Transportation, Communication, and Other Utilities","Trade","Services","Public Administration")),
        by="ind1950_main",all.x=TRUE,all.y=FALSE
      )
    
    ## Mean and Standard Deviation
    cat(gsub(pattern = "\n", replacement = "  \n", 
             x = paste0(
               "Grouping by ind1950 - Method ",method,", Dataset ",dt,"\n\n",
               "The mean of the New work variable (with all workers) was: ",
               format(round(mean(census_sample_1940_industry_study_all$new_work),4),nsmall=2),
               "\nand the standard deviation: ",
               format(round(sd(census_sample_1940_industry_study_all$new_work),4),nsmall=2),
               "\n\n"
             )
    ))
    cat(gsub(pattern = "\n", replacement = "  \n", 
             x = paste0(
               "Grouping by ind1950 - Method ",method,", Dataset ",dt,"\n\n",
               "The mean of the New work variable (excluding new sector workers) was: ",
               format(round(mean(census_sample_1940_industry_study_all$new_work),4),nsmall=2),
               "\nand the standard deviation: ",
               format(round(sd(census_sample_1940_industry_study_no_new_sec$new_work),4),nsmall=2),
               "\n\n"
             )
    ))
    
    ## Some graphs
    print(ggplot(census_sample_1940_industry_study, aes(x=new_work)) +
            geom_histogram(color="black",fill="white") +
            labs(title="",x=paste0("Share of New Work (all workers) - Method ",method,", Dt ",dt), y = "Number of industries")  + 
            theme_tufte() + theme(legend.position = "none"))
    
    print(ggplot(census_sample_1940_industry_study, aes(x=new_work)) +
            geom_histogram(color="black",fill="white") +
            labs(title="",x=paste0("Share of New Work (no new sector workers) - Method ",method,", Dt ",dt), y = "Number of industries")  + 
            theme_tufte() + theme(legend.position = "none"))
    
    
    ## Table
    print(knitr::kable(census_sample_1940_industry_study_all[order(-new_work,-perwt),c("ind1950_main_name","new_work","perwt","n_new_work")],caption=paste0("All Workers - Method ",method,", Dataset ",dt)))
    print(knitr::kable(census_sample_1940_industry_study_no_new_sec[order(-new_work,-perwt),c("ind1950_main_name","new_work","perwt","n_new_work")],caption=paste0("No New Sectors - Method ",method,", Dataset ",dt)))
    
    setnames(census_sample_1940_industry_study,c("new_work"),c(paste0("sh_new_method",method,"_dataset",dt)))
    
  }
}



```

We observe that the mean and variability are much larger in 1930 than in 1940. 
```{r echo=FALSE, results = 'asis'}

data.table(Year_Dataset=c("1930","1940 Method1 Dt 2","1940 Method1 Dt3"),mean=c(0.2077,0.0734,0.0648),Std_Deviation=c(0.1008,0.0194,0.028)) %>%
  kbl(caption = "New Work in 1930 and 1940") %>%
  kable_classic(full_width = F, html_font = "Cambria")

```
When we look at the main sectors for 1940 we also observe an important variability within the different new work variables. For the Dataset 2 the share of new work goes from 0.059 to 0.114, while for the dataset 3 it goes from 0.055 to 0.07. The reason for this is related with the different ways both datasets were constructed. This low variability is a reason for the low explanatory power of the industry fixed effects in the first stage regressions. The explanation for the low variability in itself is not clear yet.

*** TO-DO: *** Change section 1.1. using the table and graphs from section 1.3.

## 1.2 Share of new work by occupation
### 1.2.1 1930
```{r 1930}
census_sample_1930_occ_study_all <- 
  merge(
    census_sample_1930_main[,occind_subind:=format(round(sh_red_tit,4),nsmall=2)][,.(perwt=sum(perwt),sh_red_tit=weighted.mean(sh_red_tit,w=perwt)),by=c("occind","occind_subind")][,n_new_work:=perwt*sh_red_tit],
    occ1930.codes[,c("occind","occind1930_name")],
    by="occind",all.x=TRUE,all.y=FALSE
    
  )
census_sample_1930_occ_study_no_new_sec <- 
  merge(
    census_sample_1930_main[!(ind1950 %in% c(376,377,466,556,606,667,668,816,856))][,occind_subind:=format(round(sh_red_tit,4),nsmall=2)][,.(perwt=sum(perwt),sh_red_tit=weighted.mean(sh_red_tit,w=perwt)),by=c("occind","occind_subind")][,n_new_work:=perwt*sh_red_tit],
    occ1930.codes[,c("occind","occind1930_name")],
    by="occind",all.x=TRUE,all.y=FALSE
    
  )

## Mean and Standard Deviation
Tab_1930 <- data.table(
  Variable=c("Number of People","Number of Occupations","Mean of New Work","St. Dev. New Work","Percentile 0","Percentile 25","Percentile 50","Percentile 75","Percentile 100"),
  'All Workers'=c(
                  nrow(census_sample_1930_main),
                  length(unique(census_sample_1930_main$occind)),
                  format(round(mean(census_sample_1930_main$sh_red_tit),4),nsmall=2),
                  format(round(sd(census_sample_1930_main$sh_red_tit),4),nsmall=2),
                  format(round(unname(quantile(census_sample_1930_main$sh_red_tit)),4),nsmall=2)
  ),
  'No New Sectors' = c(
                  nrow(census_sample_1930_main[!(ind1950 %in% c(376,377,466,556,606,667,668,816,856))]),
                  length(unique(census_sample_1930_main[!(ind1950 %in% c(376,377,466,556,606,667,668,816,856))]$occind)),
                  format(round(mean(census_sample_1930_main[!(ind1950 %in% c(376,377,466,556,606,667,668,816,856))]$sh_red_tit),4),nsmall=2),
                  format(round(sd(census_sample_1930_main[!(ind1950 %in% c(376,377,466,556,606,667,668,816,856))]$sh_red_tit),4),nsmall=2),
                  format(round(unname(quantile(census_sample_1930_main[!(ind1950 %in% c(376,377,466,556,606,667,668,816,856))]$sh_red_tit)),4),nsmall=2)
  ),
  'All Workers - Gruped by occ'=c(
                  NA,
                  length(unique(census_sample_1930_occ_study_all$occind)),
                  format(round(mean(census_sample_1930_occ_study_all$sh_red_tit),4),nsmall=2),
                  format(round(sd(census_sample_1930_occ_study_all$sh_red_tit),4),nsmall=2),
                  format(round(unname(quantile(census_sample_1930_occ_study_all$sh_red_tit)),4),nsmall=2)
  ),
  'No New Sectors - Grouped by occ' = c(
                  NA,
                  length(unique(census_sample_1930_occ_study_no_new_sec$occind)),
                  format(round(mean(census_sample_1930_occ_study_no_new_sec$sh_red_tit),4),nsmall=2),
                  format(round(sd(census_sample_1930_occ_study_no_new_sec$sh_red_tit),4),nsmall=2),
                  format(round(unname(quantile(census_sample_1930_occ_study_no_new_sec$sh_red_tit)),4),nsmall=2)
  )
)

# Note: If all occupations are in all sectors we won't see any difference in the variables
Tab_1930 <- f_order_reg(Tab_1930,as.list(c("Number of People","Number of Occupations","Mean of New Work","St. Dev. New Work","Percentile 0","Percentile 25","Percentile 50","Percentile 75","Percentile 100")),Variable)
Tab_1930 %>%
  kbl(caption = "Different statistics related to New Work in 1930") %>%
  kable_classic(full_width = F, html_font = "Cambria")


# Histogram for new work variable (occupations)
## Common Axis
x_min <- -0.05 +min(
             min(census_sample_1930_occ_study_all$sh_red_tit),
             min(census_sample_1930_occ_study_no_new_sec$sh_red_tit)
           )
x_max <- max(
             max(census_sample_1930_occ_study_all$sh_red_tit),
             max(census_sample_1930_occ_study_no_new_sec$sh_red_tit)
           )
## Graph
ggarrange(
  ggplot(census_sample_1930_occ_study_all, aes(x=sh_red_tit)) +
        geom_histogram(color="black",bins=40,  aes(y = stat(width*density)),  fill="white") +
        geom_vline(data=census_sample_1930_occ_study_all[,.(sh_red_tit=mean(sh_red_tit))],aes(xintercept=sh_red_tit),
           linetype="dashed") + 
        scale_y_continuous(labels = percent_format()) +
        scale_x_continuous(limits=c(x_min, x_max)) +
        labs(title="",x="", y = "Share of people")  + 
        theme_tufte() + 
        theme(legend.position = "none",axis.title.x=element_blank(),axis.text.x=element_blank())   ,     # Last two elements delete text and title
  
  ggplot(census_sample_1930_occ_study_no_new_sec, aes(x=sh_red_tit)) +
        geom_histogram(color="black",bins=40,  aes(y = stat(width*density)),  fill="white") +
        geom_vline(data=census_sample_1930_occ_study_no_new_sec[,.(sh_red_tit=mean(sh_red_tit))],aes(xintercept=sh_red_tit),
           linetype="dashed") +
        scale_y_continuous(labels = percent_format()) +
        scale_x_continuous(limits=c(x_min, x_max)) +
        labs(title="",x="Share of New Work", y = "Share of people")  + 
        theme_tufte() + theme(legend.position = "none"),
  ncol = 1, nrow = 2,
  labels=c("All workers (occupations)","Excluding New Sectors (occupations)")
    )


# Histogram for new work variable (looking at people)
## Common Axis ( We substract -0.05 because otherwise values around the min are not displayed)
x_min <- -0.05 +min(
             min(census_sample_1930_main$sh_red_tit),
             min(census_sample_1930_main[!(ind1950 %in% c(376,377,466,556,606,667,668,816,856))]$sh_red_tit)
           )
x_max <- max(
             max(census_sample_1930_main$sh_red_tit),
             max(census_sample_1930_main[!(ind1950 %in% c(376,377,466,556,606,667,668,816,856))]$sh_red_tit)
           )

## Graph
ggarrange(
  ggplot(census_sample_1930_main, aes(x=sh_red_tit)) +
        geom_histogram(color="black",bins=40,  aes(y = stat(width*density)),  fill="white") +
        geom_vline(data=census_sample_1930_main[,.(sh_red_tit=mean(sh_red_tit))],aes(xintercept=sh_red_tit),
           linetype="dashed") + 
        scale_y_continuous(labels = percent_format()) +
        scale_x_continuous(limits=c(x_min, x_max)) +
        labs(title="",x="", y = "Share of people")  + 
        theme_tufte() + 
        theme(legend.position = "none",axis.title.x=element_blank(),
        axis.text.x=element_blank())   ,     # Last two elements delete text and title
  ggplot(census_sample_1930_main[!(ind1950 %in% c(376,377,466,556,606,667,668,816,856))], aes(x=sh_red_tit)) +
        geom_histogram(color="black",bins=40,  aes(y = stat(width*density)),  fill="white") +
        geom_vline(data=census_sample_1930_main[!(ind1950 %in% c(376,377,466,556,606,667,668,816,856))][,.(sh_red_tit=mean(sh_red_tit))],aes(xintercept=sh_red_tit),
           linetype="dashed") +
        scale_y_continuous(labels = percent_format()) +
        scale_x_continuous(limits=c(x_min, x_max)) +
        labs(title="",x="Share of New Work", y = "Share of people")  + 
        theme_tufte() + theme(legend.position = "none"),
  ncol = 1, nrow = 2,
  labels=c("All workers (people)","Excluding New Sectors (people)"),
  align = "v"
    )


## Table
census_sample_1930_occ_study_all[order(-sh_red_tit,-perwt),c("occind1930_name","occind","sh_red_tit","perwt","n_new_work")][1:15] %>%
  kbl(caption = "Occupations and their associated New Work Share in 1930 (1 to 15)") %>%
  kable_classic(full_width = F, html_font = "Cambria")

census_sample_1930_occ_study_all[order(-sh_red_tit,-perwt),c("occind1930_name","occind","sh_red_tit","perwt","n_new_work")][16:30] %>%
  kbl(caption = "Occupations and their associated New Work Share in 1930 (16 to 30)") %>%
  kable_classic(full_width = F, html_font = "Cambria")


```

One of the things that we observe is many more individual sectors with a very high share of new work. Is this due to the problems cleaning the data?

### 1.2.1 1940
```{r 1940}
Tab_1940 <- data.table(
  Variable=c("Number of People","Number of Occupations","Mean of New Work","St. Dev. New Work","Percentile 0","Percentile 25","Percentile 50","Percentile 75","Percentile 100"))

g_all_occ <- vector(mode = "list")
g_all_people <- vector(mode = "list")
g_no_new_sec_occ <- vector(mode = "list")
g_no_new_sec_people <- vector(mode = "list")


i <- 1
for (method in c(1)) {
  for (dt in c(2,3)) {
    setnames(census_sample_1940_main,c(paste0("sh_new_method",method,"_dataset",dt)),c("new_work"))
    
    census_sample_1940_occ_study_all <- 
    merge(
      census_sample_1940_main[,c("perwt","occ1940","new_work")][,occ1940_subind:=as.character(format(round(new_work,4),nsmall=2))][,.(perwt=sum(perwt),new_work=weighted.mean(new_work,w=perwt)),by=c("occ1940","occ1940_subind")][,n_new_work:=perwt*new_work],
      occ1940.codes[,c("occ1940","name_occ1940")],
      by="occ1940",all.x=TRUE,all.y=FALSE
    )
    census_sample_1940_occ_study_no_new_sec <- 
    merge(
      census_sample_1940_main[!(ind1950 %in% c(376,377,466,556,606,667,668,816,856))][,c("perwt","occ1940","new_work")][,occ1940_subind:=as.character(format(round(new_work,4),nsmall=2))][,.(perwt=sum(perwt),new_work=weighted.mean(new_work,w=perwt)),by=c("occ1940","occ1940_subind")][,n_new_work:=perwt*new_work],
      occ1940.codes[,c("occ1940","name_occ1940")],
      by="occ1940",all.x=TRUE,all.y=FALSE
    )
    
    # Adding to table
    Tab_1940 <- merge(
      Tab_1940,
      data.table(
        Variable=c("Number of People","Number of Occupations","Mean of New Work","St. Dev. New Work","Percentile 0","Percentile 25","Percentile 50","Percentile 75","Percentile 100"),
        V1=c(
          nrow(census_sample_1940_main),
          length(unique(census_sample_1940_main$new_work)),
          format(round(mean(census_sample_1940_main$new_work),4),nsmall=2),
          format(round(sd(census_sample_1940_main$new_work),4),nsmall=2),
          format(round(unname(quantile(census_sample_1940_main$new_work)),4),nsmall=2)
        ),
        V2 = c(
          nrow(census_sample_1940_main[!(ind1950 %in% c(376,377,466,556,606,667,668,816,856))]),
          length(unique(census_sample_1940_main[!(ind1950 %in% c(376,377,466,556,606,667,668,816,856))]$new_work)),
          format(round(mean(census_sample_1940_main[!(ind1950 %in% c(376,377,466,556,606,667,668,816,856))]$new_work),4),nsmall=2),
          format(round(sd(census_sample_1940_main[!(ind1950 %in% c(376,377,466,556,606,667,668,816,856))]$new_work),4),nsmall=2),
          format(round(unname(quantile(census_sample_1940_main[!(ind1950 %in% c(376,377,466,556,606,667,668,816,856))]$new_work)),4),nsmall=2)
        )
      ),by="Variable"
    )
    setnames(Tab_1940,c("V1","V2"),c(paste0("All_method",method,"_dt",dt),paste0("No_new_sec_method",method,"_dt",dt)))
    
    # Graphs
    ## Occupations
    g_all_occ[[i]] <- 
      ggplot(copy(census_sample_1940_occ_study_all[,c("new_work")]), aes(x=new_work)) +
      geom_histogram(color="black",bins=40,  aes(y = stat(width*density)),  fill="white") +
      geom_vline(data=census_sample_1940_occ_study_all[,.(new_work=mean(new_work))],aes(xintercept=new_work),
                 linetype="dashed") + 
      scale_y_continuous(labels = percent_format()) +
      labs(title="",x="", y = "Share of occ1940")  + 
      theme_tufte()
    
    g_no_new_sec_occ[[i]] <- 
      ggplot(copy(census_sample_1940_occ_study_no_new_sec[,c("new_work")]), aes(x=new_work)) +
      geom_histogram(color="black",bins=40,  aes(y = stat(width*density)),  fill="white") +
      geom_vline(data=census_sample_1940_occ_study_no_new_sec[,.(new_work=mean(new_work))],aes(xintercept=new_work),
                 linetype="dashed") + 
      scale_y_continuous(labels = percent_format()) +
      labs(title="",x="", y = "Share of occ1940")  + 
      theme_tufte()
    
    ## People
    g_all_people[[i]] <- 
      ggplot(copy(census_sample_1940_main[,c("new_work")]), aes(x=new_work)) +
      geom_histogram(color="black",bins=40,  aes(y = stat(width*density)),  fill="white") +
      geom_vline(data=census_sample_1940_main[,.(new_work=mean(new_work))],aes(xintercept=new_work),
                 linetype="dashed") + 
      scale_y_continuous(labels = percent_format()) +
      labs(title="",x="", y = "Share of people")  + 
      theme_tufte()
    
    g_no_new_sec_people[[i]] <- 
      ggplot(copy(census_sample_1940_main[!(ind1950 %in% c(376,377,466,556,606,667,668,816,856))][,c("new_work")]), aes(x=new_work)) +
      geom_histogram(color="black",bins=40,  aes(y = stat(width*density)),  fill="white") +
      geom_vline(data=census_sample_1940_main[!(ind1950 %in% c(376,377,466,556,606,667,668,816,856))][,.(new_work=mean(new_work))],aes(xintercept=new_work),
                 linetype="dashed") + 
      scale_y_continuous(labels = percent_format()) +
      labs(title="",x="", y = "Share of people")  + 
      theme_tufte()
    
    
    setnames(census_sample_1940_main,c("new_work"),c(paste0("sh_new_method",method,"_dataset",dt)))
    i <- i + 1
  }
}

# Table ----
Tab_1940 <- f_order_reg(Tab_1940,as.list(c("Number of People","Number of Occupations","Mean of New Work","St. Dev. New Work","Percentile 0","Percentile 25","Percentile 50","Percentile 75","Percentile 100")),Variable)
Tab_1940 %>%
  kbl(caption = "Different statistics related to New Work in 1940") %>%
  kable_classic(full_width = F, html_font = "Cambria")

# Histograms ----
# Histogram for new work variable (looking at people)
## All
### Common Axis ( We substract -0.05 because otherwise values around the min are not displayed)
x_min <- -0.05 +min(
             min(g_all_people[[1]][[1]]$new_work),
             min(g_all_people[[2]][[1]]$new_work)
           )
x_max <- max(
             max(g_all_people[[1]][[1]]$new_work),
             max(g_all_people[[2]][[1]]$new_work)
           )

### Graph
ggarrange(
  g_all_people[[1]] + 
  scale_x_continuous(limits=c(x_min, x_max)) +
  theme(legend.position = "none",axis.title.x=element_blank(),axis.text.x=element_blank()) ,     # Last two elements delete text and title
  
  g_all_people[[2]] + 
  scale_x_continuous(limits=c(x_min, x_max)),
  
  ncol = 1, nrow = 2,
  labels=c("All workers (people) - Method 1 Dt 2","All workers (people) - Method 1 Dt3"),
  align = "v"
    )

## No New Sectors
### Common Axis ( We substract -0.05 because otherwise values around the min are not displayed)
x_min <- -0.05 +min(
             min(g_no_new_sec_people[[1]][[1]]$new_work),
             min(g_no_new_sec_people[[2]][[1]]$new_work)
           )
x_max <- max(
             max(g_no_new_sec_people[[1]][[1]]$new_work),
             max(g_no_new_sec_people[[2]][[1]]$new_work)
           )

### Graph
ggarrange(
  g_no_new_sec_people[[1]] + 
  scale_x_continuous(limits=c(x_min, x_max)) +
  theme(legend.position = "none",axis.title.x=element_blank(),axis.text.x=element_blank()) ,     # Last two elements delete text and title
  
  g_no_new_sec_people[[2]] + 
  scale_x_continuous(limits=c(x_min, x_max)),
  
  ncol = 1, nrow = 2,
  labels=c("No New Sectors (people) - Method 1 Dt 2","No New Sectors (people) - Method 1 Dt3"),
  align = "v"
    )

# Histogram for new work variable (looking at occ)
## All
x_min <- -0.05 +min(
             min(g_all_occ[[1]][[1]]$new_work),
             min(g_all_occ[[2]][[1]]$new_work)
           )
x_max <- max(
             max(g_all_occ[[1]][[1]]$new_work),
             max(g_all_occ[[2]][[1]]$new_work)
           )

### Graph
ggarrange(
  g_all_occ[[1]] + 
  scale_x_continuous(limits=c(x_min, x_max)) +
  theme(legend.position = "none",axis.title.x=element_blank(),axis.text.x=element_blank()) ,     # Last two elements delete text and title
  
  g_all_occ[[2]] + 
  scale_x_continuous(limits=c(x_min, x_max)),
  
  ncol = 1, nrow = 2,
  labels=c("All workers (occupations) - Method 1 Dt 2","All workers (occupations) - Method 1 Dt3"),
  align = "v"
    )

## No New Sectors
### Common Axis ( We substract -0.05 because otherwise values around the min are not displayed)
x_min <- -0.05 +min(
             min(g_no_new_sec_occ[[1]][[1]]$new_work),
             min(g_no_new_sec_occ[[2]][[1]]$new_work)
           )
x_max <- max(
             max(g_no_new_sec_occ[[1]][[1]]$new_work),
             max(g_no_new_sec_occ[[2]][[1]]$new_work)
           )

### Graph
ggarrange(
  g_no_new_sec_occ[[1]] + 
  scale_x_continuous(limits=c(x_min, x_max)) +
  theme(legend.position = "none",axis.title.x=element_blank(),axis.text.x=element_blank()) ,     # Last two elements delete text and title
  
  g_no_new_sec_occ[[2]] + 
  scale_x_continuous(limits=c(x_min, x_max)),
  
  ncol = 1, nrow = 2,
  labels=c("No New Sec workers (occupations) - Method 1 Dt 2","No New Sec (occupations) - Method 1 Dt3"),
  align = "v"
    )

    
```

The two summary tables presented before show a stark difference between years 1930 and 1940. While the inter-quantile deviation for year 1930 is around 21%, it is only 9% in 1940. In a similar way as what we observed in the previous section, the variability of the New Work variable is higher (although only slightly) in Dataset 2 than Dataset 3. Also note that we have more than twice the number of occupations in Dataset 2 compared to Dataset 3. This is just because of the way we grouped occupations in both cases.


## 1.3 Share of new work by different variables
### 1.3.1. 1930
```{r 1930}

for (var in c("race","age_main","urban","mig_ab","lit","ind1950_main")) {
  # Changing name, reducing sample, creating categories
  setnames(census_sample_1930_main,c(var),c("var"))

  A <- census_sample_1930_main[,c("perwt","sh_red_tit","var","occind")]
  a <- sort(unique(census_sample_1930_main$var))
  
  Tab <-
        data.table(
          Variable=c("Number of People","Number of Occupations","Mean of New Work","St. Dev. New Work","Percentile 0","Percentile 25","Percentile 50","Percentile 75","Percentile 100"))
  
  for (i in a) {
    Temp <- A[var==i]
    Tab <- merge(
        Tab,
        data.table(
          Variable=c("Number of People","Number of Occupations","Mean of New Work","St. Dev. New Work","Percentile 0","Percentile 25","Percentile 50","Percentile 75","Percentile 100"),
          V1=c(
            nrow(Temp),
            length(unique(Temp$occind)),
            format(round(mean(Temp$sh_red_tit),4),nsmall=2),
            format(round(sd(Temp$sh_red_tit),4),nsmall=2),
            format(round(unname(quantile(Temp$sh_red_tit)),4),nsmall=2)
          )
        )
    )
    setnames(Tab,c("V1"),c(paste0(var,"_",i)))
    rm(Temp)
  }
  assign(
    paste0("Table_",var,"_1930"),
    f_order_reg(Tab,as.list(c("Number of People","Number of Occupations","Mean of New Work","St. Dev. New Work","Percentile 0","Percentile 25","Percentile 50","Percentile 75","Percentile 100")),Variable)
  )
  
  setnames(census_sample_1930_main,c("var"),c(var))
}


```

### 1.3.1. 1940
```{r 1940}

for (new_work in c("sh_new_method1_dataset2","sh_new_method1_dataset3")) {
  setnames(census_sample_1940_main,c(new_work),c("new_work"))
  
   for (var in c("race","age_main","urban","mig_ab","educ_main","ind1950_main")) {
    # Changing name, reducing sample, creating categories
    setnames(census_sample_1940_main,c(var),c("var"))
  
    A <- census_sample_1940_main[,c("perwt","new_work","var")]
    a <- sort(unique(census_sample_1940_main$var))
    
    Tab <-
          data.table(
            Variable=c("Number of People","Number of Occupations","Mean of New Work","St. Dev. New Work","Percentile 0","Percentile 25","Percentile 50","Percentile 75","Percentile 100"))
    
    for (i in a) {
      Temp <- A[var==i]
      Tab <- merge(
          Tab,
          data.table(
            Variable=c("Number of People","Number of Occupations","Mean of New Work","St. Dev. New Work","Percentile 0","Percentile 25","Percentile 50","Percentile 75","Percentile 100"),
            V1=c(
              nrow(Temp),
              length(unique(Temp$new_work)),
              format(round(mean(Temp$new_work),4),nsmall=2),
              format(round(sd(Temp$new_work),4),nsmall=2),
              format(round(unname(quantile(Temp$new_work)),4),nsmall=2)
            )
          )
      )
      setnames(Tab,c("V1"),c(paste0(var,"_",i)))
      rm(Temp)
    }
    assign(
      paste0("Table_",var,"_",new_work,"_1940"),
      f_order_reg(Tab,as.list(c("Number of People","Number of Occupations","Mean of New Work","St. Dev. New Work","Percentile 0","Percentile 25","Percentile 50","Percentile 75","Percentile 100")),Variable)
    )
    
    setnames(census_sample_1940_main,c("var"),c(var))
   }
  setnames(census_sample_1940_main,c("new_work"),c(new_work))
  rm(A)
}

```

### 1.3.3. Printing all the tables
```{r}
for (dt in sort(ls(pattern = "^Table_"))) {
  temp <- eval(as.name(dt))
  print(temp %>%
    kbl(caption = paste0("Different statistics related to New Work - ",dt)) %>%
    kable_classic(full_width = F, html_font = "Cambria")  )
}


```


## 2. Analyzing results from first stage regressions

- Summary of main results (r2, fstat, industry variables and their significance)
- Correlation of city fixed effects in different exercises
- F-stat for city fixed effects.

### 2.1. Loading main datasets
```{r}
# 1930
FS_reg_1930_all <- read_fst(here(paste0("output/RData/First_Stage_Summary_Reg_1930_all.fst")),as.data.table = TRUE)
FS_reg_1930_no_new_sec <- read_fst(here(paste0("output/RData/First_Stage_Summary_Reg_1930_no_new_sec.fst")),as.data.table = TRUE)

# 1940
FS_reg_1940_all <- readRDS(here(paste0("output/Rdata/First_Stage_Summary_Reg_1940_all.rds")))
FS_reg_1940_no_new_sec <- readRDS(here(paste0("output/Rdata/First_Stage_Summary_Reg_1940_no_new_sec.rds")))
```


### 2.2. Tables
```{r}
# Table
Temp <- FS_reg_1930_no_new_sec[,c("rn","variable","model_4","model_7")][rn %in% c("ind1950_main_2","ind1950_main_3","ind1950_main_4","ind1950_main_5","ind1950_main_6","ind1950_main_7","r2","F_fe","pF_fe")]
setnames(Temp,c(3,4),c("1930","I1930"))
Temp1 <- FS_reg_1940_no_new_sec$sh_new_method1_dataset2[,c("rn","variable","model_8","model_7")][rn %in% c("ind1950_main_2","ind1950_main_3","ind1950_main_4","ind1950_main_5","ind1950_main_6","ind1950_main_7","r2","F_fe","pF_fe")]
setnames(Temp1,c(3,4),c("m1_dt2_1940","Im1_dt2_1940"))
Temp2 <- FS_reg_1940_no_new_sec$sh_new_method1_dataset2[,c("rn","variable","model_8","model_7")][rn %in% c("ind1950_main_2","ind1950_main_3","ind1950_main_4","ind1950_main_5","ind1950_main_6","ind1950_main_7","r2","F_fe","pF_fe")]
setnames(Temp2,c(3,4),c("m1_dt3_1940","Im1_dt3_1940"))

Y <- Reduce(
          function(x, y, ...) merge(x, y, by=c("rn","variable"), all = TRUE),
          list(
            Temp,
            Temp1,
            Temp2
          )
        )

Y <- f_order_reg(Y[,!c("variable")],as.list(c("ind1950_main_2","ind1950_main_3","ind1950_main_4","ind1950_main_5","ind1950_main_6","ind1950_main_7","r2","F_fe","pF_fe")),order_var=rn)

Y %>%
  kbl(caption = "Comparing regressions (with and without industry fixed effects)") %>%
  kable_classic(full_width = F, html_font = "Cambria")

```

### 2.3. Correlations between FEs
-Correlate city fixed effects for models 4 and 7 (1930) and 8 and 7 (1940)

```{r}
# Keep only city fixed effects
Graph_1930_no_new_sec <- FS_reg_1930_no_new_sec[,c("rn","model_4","model_7")][rn %in% grep("^[0-9]+",rn,value=TRUE)][,c("model_4","model_7"):=lapply(.SD,function(x) as.numeric(x)),.SDcols=c("model_4","model_7")]

Graph_1940_method1_dataset2_no_new_sec <- FS_reg_1940_no_new_sec$sh_new_method1_dataset2[,c("rn","model_4","model_7")][rn %in% grep("^[0-9]+",rn,value=TRUE)][,c("model_4","model_7"):=lapply(.SD,function(x) as.numeric(x)),.SDcols=c("model_4","model_7")]

Graph_1940_method1_dataset3_no_new_sec <- FS_reg_1940_no_new_sec$sh_new_method1_dataset3[,c("rn","model_4","model_7")][rn %in% grep("^[0-9]+",rn,value=TRUE)][,c("model_4","model_7"):=lapply(.SD,function(x) as.numeric(x)),.SDcols=c("model_4","model_7")]


ggplot(Graph_1930_no_new_sec, aes(y=model_7, x=model_4)) + 
  geom_point(size=0.1) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + 
  geom_abline(intercept = 0, slope = 1) +
  labs(title="Correlation between County FE with and without industry FE - 1930",x="County FE without Industry FE", y = "County FE with Industry FE") + theme_tufte() 

ggplot(Graph_1940_method1_dataset2_no_new_sec, aes(y=model_7, x=model_4)) + 
  geom_point(size=0.1) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + 
  geom_abline(intercept = 0, slope = 1) +
  labs(title="Correlation between County FE with and without industry FE - 1940 M1 Dt2",x="County FE without Industry FE", y = "County FE with Industry FE") + theme_tufte() 

ggplot(Graph_1940_method1_dataset3_no_new_sec, aes(y=model_7, x=model_4)) + 
  geom_point(size=0.1) + geom_rangeframe()  +  stat_smooth(method="lm", se=TRUE) + 
  geom_abline(intercept = 0, slope = 1) +
  labs(title="Correlation between County FE with and without industry FE - 1940 M1 Dt3",x="County FE without Industry FE", y = "County FE with Industry FE") + theme_tufte() 

```

As was to be expected, the correlation line for the county FE with and without industry FE lies below the 45 degree line for 1930 and around it for 1940. In the first case we observe that introducing industry FE reduces the value of most county FE, while in the second case not 
much changes.



















































